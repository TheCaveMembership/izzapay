<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Authenticate, IZZA CREATURES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <script src="https://sdk.minepi.com/pi-sdk.js" defer></script>
  <style>
    body{background:#000;color:#e8f1ff;font-family:Inter,Arial,Helvetica,sans-serif;margin:0;text-align:center}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    .topbar{display:flex;align-items:center;justify-content:center;padding:12px 0;position:sticky;top:0;z-index:50;background:rgba(0,0,0,.9);border-bottom:1px solid #1d2540}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 18px;border-radius:14px;font-weight:700;border:1px solid transparent;cursor:pointer}
    .btn.purple{background:linear-gradient(180deg,#7a44ff,#b784ff);color:#fff}
    .btn.ghost{background:transparent;color:#cfe0ff;border-color:#2a3550}
    .err{color:#ff9aa2;white-space:pre-wrap}

    /* Added to match creatures page layout for wordmark and egg row */
    .izzaword-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;margin:8px 0 12px}
    .izzaword-wrap svg{max-width:100%;height:auto;display:block;margin:0 auto}
    .eggs-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .eggs-row img{width:64px;height:64px;object-fit:contain}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn ghost" href="/">BACK HOME</a>
    </div>

    <!-- Replaced H1 with the IZZA CREATURES wordmark SVG -->
    <div class="izzaword-wrap" aria-label="IZZA CREATURES">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 240" width="1400" height="240"
           shape-rendering="geometricPrecision" text-rendering="optimizeLegibility" aria-hidden="true">
        <defs>
          <linearGradient id="eggGw" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%"   stop-color="#ffcf4d"/>
            <stop offset="55%"  stop-color="#b784ff"/>
            <stop offset="100%" stop-color="#48d4ff"/>
          </linearGradient>
        </defs>
        <g fill="url(#eggGw)" stroke="#ffffff" stroke-opacity=".10" stroke-width="8" paint-order="stroke fill markers">
          <text x="50%" y="170" text-anchor="middle"
                font-family="Montserrat, Arial Black, Impact, system-ui, sans-serif"
                font-size="160" font-weight="900" letter-spacing="8">IZZA CREATURES</text>
        </g>
      </svg>

      <!-- Replaced IZZA token image with the same egg row used on the creatures page -->
      <div class="eggs-row">
        <img alt="Egg gold speckle"    src="/nftsvg/EGGDEMO.svg?skin=LEG-gold-speckle&nobg=1&nc=1">
        <img alt="Egg violet stripe"   src="/nftsvg/EGGDEMO.svg?skin=EP-violet-stripe&nobg=1&nc=2">
        <img alt="Egg turquoise swirl" src="/nftsvg/EGGDEMO.svg?skin=RARE-turquoise-swirl&nobg=1&nc=3">
        <img alt="Egg rose mosaic"     src="/nftsvg/EGGDEMO.svg?skin=UN-rose-mosaic&nobg=1&nc=4">
        <img alt="Egg lime metallic"   src="/nftsvg/EGGDEMO.svg?skin=COM-lime-metallic&nobg=1&nc=5">
      </div>
    </div>

    <p>Authenticate to enter <strong>IZZA Creatures</strong>.</p>

    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
      <button id="piCreaturesAuthBtn" class="btn purple">Authenticate with Pi</button>
      <a class="btn ghost" href="/">Cancel</a>
    </div>

    <p id="msg" style="margin-top:10px;color:#9fb0d6"></p>
    <div id="err" class="err"></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // Read the global PI_SANDBOX injected by app.context_processor
    const sandbox = {{ 'true' if PI_SANDBOX else 'false' }};
    const btn = document.getElementById('piCreaturesAuthBtn');
    const msg = document.getElementById('msg');
    const err = document.getElementById('err');

    function setMsg(t){ if(msg) msg.textContent = t || ''; }
    function setErr(t){ if(err) err.textContent = t || ''; }

    function initPi(){
      if (!window.Pi || !Pi.init) return false;
      try { Pi.init({ version: "2.0", sandbox: sandbox }); return true; }
      catch(e){ console.error("Pi.init failed", e); setErr("Pi.init failed: " + (e?.message || e)); return false; }
    }

    // Try once now
    initPi();

    btn?.addEventListener('click', async function(){
      setErr('');
      try{ fetch('/_log', {method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({t:Date.now(),evt:'creatures.auth.click'})}); }catch(_){}

      // Cover the race where SDK finished loading after DOMContentLoaded
      if (!window.Pi || !Pi.authenticate) {
        if (!initPi()) {
          setMsg("Open this page inside Pi Browser so the Pi SDK can run.");
          return;
        }
      }

      setMsg("Requesting authorizationâ€¦");
      try{
        const auth = await Pi.authenticate(['username'], function onIncompletePaymentFound(){});
        try{ localStorage.setItem('piAuthUser', JSON.stringify(auth.user||null)); }catch{}
        try{ localStorage.setItem('piAccessToken', auth.accessToken || ''); }catch{}

        // Same server flow as token page
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/auth/exchange';

        const payload = document.createElement('input');
        payload.type='hidden'; payload.name='payload';
        payload.value = JSON.stringify({ accessToken: auth.accessToken, user: auth.user });
        form.appendChild(payload);

        const next = document.createElement('input');
        next.type='hidden'; next.name='next';
        next.value = '/creatures';
        form.appendChild(next);

        document.body.appendChild(form);
        form.submit();
      }catch(e){
        console.error(e);
        setMsg("Authorization failed, please try again.");
        setErr(e?.message || String(e));
      }
    });
  });
  </script>
</body>
</html>
