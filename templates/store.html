<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ m.business_name }} — Store</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0b0f17; --card:#0f1728; --line:#1f2a44; --txt:#e8f0ff; --muted:#bcd0ff; --brand:#6e9fff;
      --btn-txt:#0b0f17;
    }
    /* colorways used across the app */
    .cw-blue  { --brand:#6e9fff; }
    .cw-mint  { --brand:#5ad49e; }
    .cw-purple{ --brand:#a88cff; }
    .cw-amber { --brand:#ffb86b; }

    /* optional light variant */
    .light { --bg:#f6f7fb; --card:#ffffff; --line:#e6e8f0; --txt:#0b0f17; --muted:#4b587c; --btn-txt:#ffffff; }

    body{font-family:{{ m.font_family or 'Arial,Helvetica,sans-serif' }}; background:var(--bg); color:var(--txt); margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;gap:12px;padding:8px 0;flex-wrap:wrap}
    .top .grow{flex:1}
    .logo{height:40px;border-radius:8px;border:1px solid var(--line);background:#0001}
    .banner{width:100%;max-height:180px;object-fit:cover;border-radius:12px;border:1px solid var(--line);display:block}
    .muted{color:var(--muted)}
    input, .btn, .pill{border-radius:10px}
    input{width:100%;background:transparent;border:1px solid var(--line);padding:10px;color:var(--txt)}
    .btn{background:var(--brand);color:var(--btn-txt);border:0;padding:10px 12px;font-weight:800;text-decoration:none;display:inline-block;cursor:pointer}
    .pill{border:1px solid var(--line);padding:8px 10px;text-decoration:none;color:var(--txt)}
    .grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;flex:1 1 calc(50% - 12px);min-width:260px;box-sizing:border-box}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .price{font-weight:800}
    .header{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
    .desc{margin-top:6px;color:var(--muted);font-size:.95rem}

    /* --- Product image frame (for SOLD OUT overlay) --- */
    .itimg{
      width:100%;
      height:180px;
      border:1px solid var(--line);
      border-radius:10px;
      overflow:hidden;
      background:#0001;
      position:relative; /* allow overlay positioning */
    }
    .itimg img,
    .itimg svg,
    .itimg object{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
    }
    /* Greyscale/dim when sold out */
    .is-soldout .itimg img,
    .is-soldout .itimg svg,
    .is-soldout .itimg object{
      filter:grayscale(100%) brightness(.6);
    }
    /* Red “Sold Out” ribbon */
    .itimg .soldout-banner{
      position:absolute;
      top:50%;
      left:50%;
      transform: translate(-50%, -50%) rotate(-18deg);
      background: rgba(220,0,0,.9);
      color:#fff;
      padding:6px 14px;
      font-weight:900;
      font-size:18px;
      border-radius:6px;
      pointer-events:none;
      text-transform:uppercase;
      letter-spacing:1px;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    /* Disable look/feel for disabled links */
    .pill[aria-disabled="true"]{
      opacity:.55;
      pointer-events:none;
      cursor:not-allowed;
    }

    @media (max-width:540px){
      .card{min-width:calc(50% - 12px)}
    }
  </style>
</head>
{% set cw = m.colorway if m and m.colorway else 'cw-blue' %}
<body class="{{ cw }} {% if m.theme_mode=='light' %}light{% endif %}">
<div class="wrap">

  {% if m.banner_url %}
    <img class="banner" src="/uimg?src={{ m.banner_url | urlencode }}" alt="">
  {% endif %}

  <div class="top">
    {% if m.logo_url %}
      <img class="logo" src="/uimg?src={{ m.logo_url | urlencode }}" alt="">
    {% endif %}
    <div class="grow">
      <div class="header">
        <div>
          <div style="font-weight:800;font-size:1.15rem">{{ m.business_name }}</div>
          {% if m.description %}<div class="muted" style="margin-top:3px">{{ m.description }}</div>{% endif %}
        </div>

        <!-- Only Explore button left -->
        <div class="row">
          <a class="pill" href="/explore{% if request.args.get('t') %}?t={{ request.args.get('t') }}{% endif %}">Explore stores</a>
        </div>
      </div>
    </div>
  </div>

  <form method="get" class="row" action="/store/{{ m.slug }}" style="gap:8px;margin-top:8px">
    <input name="q" value="{{ q or '' }}" placeholder="Search products…">
    <input type="hidden" name="cid" value="{{ cid }}">
    {% if request.args.get('t') %}<input type="hidden" name="t" value="{{ request.args.get('t') }}">{% endif %}
    <button class="btn" type="submit">Search</button>
  </form>

  <div class="grid">
    {% for it in items %}
      {% set sold_out = (it.stock_qty <= 0 and not it.allow_backorder) %}
      {% set svg = (it.svg_code or '') | trim %}
      {% set img = (it.image_url or '') | trim %}
      <div class="card {% if sold_out %}is-soldout{% endif %}">
        <div class="itimg">
          {% if svg %}
            {{ svg | safe }}
          {% elif img and (img|lower).endswith('.svg') %}
            <!-- if only an external .svg URL exists, still avoid rasterizing -->
            <object type="image/svg+xml" data="{{ img }}"></object>
          {% elif img %}
            <img src="/uimg?src={{ img | urlencode }}" alt="">
          {% else %}
            <div style="width:100%;height:100%;background:#cbd5e1"></div>
          {% endif %}
          {% if sold_out %}
            <div class="soldout-banner">Sold Out</div>
          {% endif %}
        </div>

        <div style="margin-top:8px;font-weight:800">{{ it.title }}</div>
        {% if it.description %}
          <div class="desc">{{ it.description }}</div>
        {% endif %}

        <div class="row" style="justify-content:space-between;margin-top:8px">
          <div class="price">{{ '%.7f'|format(it.pi_price) }} Pi</div>
          <div class="row">
            {% if sold_out %}
              <!-- Disabled when sold out -->
              <a class="pill" aria-disabled="true" tabindex="-1">Buy now</a>
            {% else %}
              <!-- BUY NOW goes straight to single-item checkout -->
              <a class="pill" href="/checkout/{{ it.link_id }}{% if request.args.get('t') %}?t={{ request.args.get('t') }}{% endif %}">Buy now</a>
            {% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div class="muted">No items yet.</div>
    {% endfor %}
  </div>
</div>
</body>
</html>
