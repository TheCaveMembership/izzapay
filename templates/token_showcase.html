<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IZZA Token ‚Äî Testnet Showcase</title>
  <meta name="description" content="IZZA (test) ‚Äî token showcase for IZZA PAY / IZZA Game" />

  <style>
    :root{
      --bg:#050308;
      --panel:#0b0b10;
      --muted:#9aa0b1;
      --accent1:#7a44ff;   /* violet line */
      --accent2:#b784ff;
      --gold-hex:#ffcd60;  /* gold for volume/area */
      --glass: rgba(255,255,255,0.04);
      --card-radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;

      /* glow palettes */
      --gold: 255,205,96;
      --violet1: 183,132,255;
      --violet2: 122,68,255;
    }

    html,body{
      height:100%;
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      max-width:100%;
      overflow-x:hidden;
      overscroll-behavior-x:none;
    }
    .wrap{max-width:1000px;margin:0 auto;padding:18px 16px 28px}
    @media (min-width:420px){ .wrap{padding:22px 18px 36px} }
    @media (min-width:820px){ .wrap{padding:28px 24px 42px} }

    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}

    .logo{
      height:clamp(56px, 12vw, 80px);
      width:auto;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer; user-select:none;
    }
    .logo img{height:100%; width:auto; object-fit:contain; background:transparent;}
    @media (max-width:768px){ .logo{ transform: translateX(91px); } }
    h1{margin:0;font-size:clamp(20px,4.8vw,28px);letter-spacing:.2px}
    p.lead{color:var(--muted);margin:4px 0 0;font-size:clamp(13px,3.4vw,14px)}
    .spacer{flex:1 1 auto}

    .top-cta{width:100%;text-align:center;margin-top:8px}
    .cta{
      display:inline-flex;align-items:center;gap:10px;
      padding:12px 16px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg,rgba(122,68,255,.25),rgba(183,132,255,.12));
      box-shadow:0 0 18px rgba(122,68,255,.28), 0 0 60px rgba(183,132,255,.18) inset;
      color:#fff;text-decoration:none;font-weight:800;letter-spacing:.3px;cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .cta:hover{transform:translateY(-1px);box-shadow:0 0 26px rgba(122,68,255,.40), 0 0 80px rgba(183,132,255,.28) inset}
    .cta:active{transform:translateY(0)}
    .cta img{width:20px;height:20px}

    .hero{position:relative;margin-top:16px;display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:880px){ .hero{grid-template-columns:minmax(0,1fr) 370px; gap:16px} }

    .panel{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--card-radius);
      padding:14px;
      box-shadow:0 4px 30px rgba(0,0,0,.35);
    }
    @media (min-width:540px){ .panel{padding:16px} }
    @media (min-width:980px){ .panel{padding:18px} }

    .token-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    /* Coin + GOLD glow beneath it (no box) ‚Äî your original */
    .token-img{
      width:112px; height:112px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      position:relative; isolation:isolate; touch-action:pan-y;
      transform-style: preserve-3d;
    }
    .token-img img{ width:100%; height:100%; object-fit:contain; border-radius:14px; backface-visibility:hidden; position:relative; z-index:1; }
    .token-img::before{
      content:""; position:absolute;
      top:  calc(50% + var(--pulse-offset-y, -16px));
      left: calc(50% + var(--pulse-offset-x, -36px));
      width: var(--pulse-size, 140px);
      height: var(--pulse-size, 140px);
      transform: translate(-50%, -50%); border-radius:50%;
      background: radial-gradient(50% 50% at 50% 50%,
                  rgba(255,210,90,.35) 0%,
                  rgba(255,185,30,.18) 45%,
                  rgba(255,185,30,0) 70%);
      box-shadow: 0 0 30px 6px rgba(255,196,56,.40), 0 0 60px 20px rgba(255,180,0,.22) inset;
      animation: pulse 2.2s ease-in-out infinite; z-index: -1; pointer-events:none;
    }
    @keyframes coinspin { to { transform: rotateY(720deg); } }
    .spin-anim { animation: coinspin 1.1s ease-in-out; transform-origin: center; }

    .bg-weave{position:absolute; inset:-4px; z-index:-1; border-radius:20px;
      background:
        radial-gradient(600px 220px at 10% -10%, rgba(122,68,255,.18), transparent 60%),
        radial-gradient(500px 200px at 110% 10%, rgba(183,132,255,.22), transparent 58%),
        radial-gradient(800px 260px at 50% 120%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      overflow:hidden;
    }
    .bg-weave::after{
      content:""; position:absolute; inset:0;
      background:repeating-linear-gradient(110deg,
        rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px,
        rgba(255,255,255,0) 1px, rgba(255,255,255,0) 8px);
      mix-blend-mode:overlay; animation:drift 12s linear infinite; opacity:.35;
    }
    @keyframes drift{0%{transform:translate3d(-30px,0,0)}100%{transform:translate3d(30px,0,0)}}

    .meta h2{margin:0 0 4px 0;font-size:clamp(18px,4.6vw,22px)}
    .small{color:var(--muted);font-size:clamp(12px,3.2vw,13px)}
    .mono{font-family:var(--mono)}
    .wrapaddr{word-break:break-all; overflow-wrap:anywhere}

    .side-badge{
      display:flex;flex-direction:column;align-items:center;gap:8px;
      padding:0;border:none;background:none;margin-left:auto;margin-right:20px;margin-top:18px;text-align:center;position:relative;top:8px;
    }
    .mark-wrap{
      width:84px;height:84px;border-radius:18px;display:flex;align-items:center;justify-content:center;
      background: radial-gradient(60% 60% at 50% 40%, rgba(var(--violet1),.42), rgba(var(--violet1),.20));
      box-shadow: 0 0 22px rgba(var(--violet1),.45), 0 0 70px rgba(var(--violet2),.32);
      animation:pulse 2.2s ease-in-out infinite;cursor:pointer;border:none;
    }
    .mark-wrap img{width:50px;height:50px;display:block}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.07)}}
    .side-badge .arcade{font-weight:900;letter-spacing:.8px;text-transform:uppercase;font-size:14px;line-height:1.15;text-shadow:0 0 12px rgba(var(--violet1),.35)}
    .side-badge .hint{color:var(--muted);font-size:11px;line-height:1.1}

    .two{margin-top:12px;display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:480px){ .two{grid-template-columns:1fr} }
    .stat{background:var(--glass);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
    .stat .label{color:var(--muted);font-size:12px}
    .stat strong{display:block;margin-top:4px;font-size:clamp(16px,4.8vw,18px)}

    .card-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .small-muted{color:var(--muted);font-size:13px}

    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:480px){ .grid{grid-template-columns:1fr} }
    .mini{display:flex;gap:10px;align-items:center}
    .mini .ico{
      width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.04);font-size:18px;line-height:1;
    }
    .mini .ico.purple{
      background:linear-gradient(180deg,var(--accent1),var(--accent2));
      box-shadow:0 0 10px rgba(183,132,255,.25);
    }
    .mini img{width:26px;height:26px;object-fit:contain}

    hr.sep{margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)}
    .lower{margin-top:14px;display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:880px){ .lower{grid-template-columns:minmax(0,1fr) 370px} }

    .btnrow{display:flex;gap:8px;flex-wrap:wrap}
    .linkbtn{display:inline-block;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);color:#cfe0ff;text-decoration:none;font-weight:600}

    details.activity{margin-top:12px}
    details.activity > summary{
      list-style:none; cursor:pointer; padding:10px 12px; border-radius:10px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); font-weight:600;
    }
    details.activity[open] > summary{background:rgba(255,255,255,.06)}
    .ops{margin-top:10px}
    .op{margin-bottom:10px}
    .op .t{display:block;font-weight:700}
    .op .m{color:var(--muted);font-size:12px;margin-top:4px}

    footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}

    /* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:999;backdrop-filter:saturate(140%) blur(2px)}
.modal{position:fixed;inset:0;display:none;z-index:1000;align-items:center;justify-content:center;padding:24px}
.modal[open], .modal-backdrop[open]{display:flex}
.modal-card{
  width:min(980px,96vw);max-height:86vh;overflow:auto;border-radius:18px;
  background:linear-gradient(180deg, rgba(10,8,18,.9), rgba(6,5,12,.96));
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 40px 120px rgba(0,0,0,.55), 0 0 80px rgba(122,68,255,.35) inset;
  animation:pop .18s ease-out;
}

/* --- Claim modal overflow fix (mobile-safe) --- */
.modal-body{ overflow-x: hidden; }                   /* never push modal sideways */

/* Keep modals comfortably centered on phones */
@media (max-width: 480px){
  .modal{ align-items: flex-start; }                /* avoid being forced too low */
  .modal-card{ margin-top: max(10px, env(safe-area-inset-top)); }
}

/* ===== Legend pills row: normal, vote, NFT ===== */
#claimLegend,
.claim-modes{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:8px 0 14px;
  flex-wrap:nowrap;
}
.claim-pill{
  flex:1 1 0;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line, #26283a);
  background:rgba(255,255,255,0.04);
  font-weight:600;
  letter-spacing:.2px;
  user-select:none;
  white-space:nowrap;
  min-width:0;
}
.claim-pill.is-active{
  border-color:rgba(255,205,96,.65);
  box-shadow:0 0 0 1px rgba(255,255,255,.06) inset;
}

/* === CLEAN CLAIM UI (simple blocks) === */
#claimTbl { width:100%; border-collapse:separate; border-spacing:0 10px; }
#claimTbl td { padding:10px 12px; }

/* headers and rows */
#claimTbl tr.group-head > td {
  border-top-left-radius:12px;
  border-top-right-radius:12px;
  font-weight:800;
  letter-spacing:.2px;
  padding:12px;
}
#claimTbl tr.group-row:last-child > td {
  border-bottom-left-radius:12px;
  border-bottom-right-radius:12px;
}

/* color schemes ‚Äî match the actual row classes */
#claimTbl tr.group-head.is-regular > td,
#claimTbl tr.group-row.is-regular > td {
  background:rgba(122,68,255,.10);
  border:1px solid rgba(122,68,255,.35);
}
#claimTbl tr.group-head.is-vote > td,
#claimTbl tr.group-row.is-vote   > td {
  background:rgba(255,205,96,.12);
  border:1px solid rgba(255,205,96,.45);
}
/* NFT group styling (turquoise/cyan) */
#claimTbl tr.group-head.is-nft > td,
#claimTbl tr.group-row.is-nft   > td {
  background: rgba(72,212,255,.12);
  border: 1px solid rgba(72,212,255,.45);
}

/* generic pill look */
#claimTbl .pill{
  display:inline-block; padding:2px 8px; border-radius:12px;
  font-size:12px; font-weight:800; text-transform:uppercase;
}
#claimTbl .pill-regular{ background:#7a44ff22; border:1px solid #7a44ff66; }
#claimTbl .pill-vote   { background:#ffcd6022; border:1px solid #ffcd6080; color:#2a1b00; }
/* NFT chip */
#claimLegend .pill-nft,
#claimTbl .pill-nft{
  background:#48d4ff22;
  border:1px solid #48d4ff80;
  color:#001a22;
  display:inline-block; padding:2px 8px; border-radius:12px;
  font-size:12px; font-weight:800; text-transform:uppercase;
}

/* numbers and hints */
#claimTbl .num{
  font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
  font-variant-numeric:tabular-nums;
  text-align:right;
}
#claimTbl .lockhint{ font-size:12px; opacity:.8; display:block; }

/* checkbox alignment for selectable rows */
#claimTbl .chk{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; margin-right:8px;
}
#claimTbl input[type="checkbox"]{ width:18px; height:18px; }

/* locked state actually used by the rows */
#claimTbl tr.locked{ opacity:.55; }
#claimTbl tr.locked input[type="checkbox"]{ pointer-events:none; }
    /* quick one-shot flash for the create-wallet button */
@keyframes izza-flash {
  0% { box-shadow: 0 0 0 rgba(183,132,255,0); transform: translateY(0); }
  30% { box-shadow: 0 0 22px rgba(183,132,255,.55), 0 0 60px rgba(122,68,255,.35); transform: translateY(-1px); }
  100% { box-shadow: 0 0 0 rgba(183,132,255,0); transform: translateY(0); }
}
.flash-once {
  animation: izza-flash 1s ease-out 1;
}
    @keyframes pop{from{transform:translateY(10px) scale(.98);opacity:.6}to{transform:none;opacity:1}}
    .modal-header{
      position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:12px;justify-content:space-between;
      padding:14px 16px;background:rgba(8,6,14,.85);border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px)
    }
    .modal-title{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.4px;text-transform:uppercase}
    .modal-title img{width:26px;height:26px}
    .close-btn{appearance:none;border:none;cursor:pointer;border-radius:10px;padding:8px 10px;font-weight:800;color:#fff;background:rgba(255,255,255,.06)}
    .modal-body{padding:16px}

    /* ===== RESTORE YOUR ORIGINAL ROADMAP STYLES (no overrides that change sizes) ===== */
    .pill{display:inline-block;padding:8px 10px;border-radius:999px;background:linear-gradient(180deg,var(--accent1),var(--accent2));font-size:12px;font-weight:800;letter-spacing:.3px;box-shadow:0 0 16px rgba(183,132,255,.35)}
    .road-grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:860px){.road-grid{grid-template-columns:1.2fr .8fr}}
    .blox{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .blox h4{margin:0 0 8px 0;font-size:16px;letter-spacing:.2px}
    .blox p{margin:6px 0;color:#cfe0ff}
    .list{margin:8px 0 0 0;padding:0 0 0 18px;color:#cfe0ff}
    .list li{margin:6px 0}
    .grid-2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .statline{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
    .mini-mark{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--accent1),var(--accent2));box-shadow:0 0 10px rgba(183,132,255,.25)}
    .img-row{display:flex;gap:10px;flex-wrap:wrap}
    .img-row img{width:100px;height:100px;border-radius:12px;object-fit:cover;background:transparent}

    /* make the IZZA Token card the same width as one grid column and center it */
    .center-span{
      grid-column: 1 / -1;
      justify-self: center;
      width: 100%;
      max-width: calc((100% - 10px) / 2);
    }

    /* Reusable roadmap glow chip ‚Äî tune per instance with CSS vars */
    .glow{
      --sz: 92px;
      --img: 54px;
      --offset-x: 0px;
      --offset-y: 0px;
      position:relative; width:var(--sz); height:var(--sz);
      border-radius:50%; margin:16px auto 0;
      display:flex; align-items:center; justify-content:center;
      transform: translate(var(--offset-x), var(--offset-y));
    }
    .glow::before{
      content:""; position:absolute; inset:calc(-0.18 * var(--sz));
      border-radius:inherit; pointer-events:none;
      animation:pulse 2.2s ease-in-out infinite;
      background: radial-gradient(circle at 50% 50%, var(--g1) 0%, var(--g2) 45%, transparent 72%);
      box-shadow: 0 0 calc(0.36 * var(--sz)) var(--s1), 0 0 calc(1.0 * var(--sz)) var(--s2);
    }
    .glow img{ width:var(--img); height:var(--img); border-radius:12px; position:relative; z-index:1; }

    .glow.violet{ --g1: rgba(var(--violet1),.40); --g2: rgba(var(--violet1),.10); --s1: rgba(var(--violet1),.45); --s2: rgba(var(--violet2),.30); }
    .glow.gold  { --g1: rgba(var(--gold),.42);   --g2: rgba(var(--gold),.12);   --s1: rgba(var(--gold),.45);   --s2: rgba(var(--gold),.32); }

    /* stack for roadmap chips */
    .glow-stack{ margin-top:12px; display:flex; flex-direction:column; align-items:center; gap:18px; }

    /* order book/price chart chrome */
    .ob-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .seg{display:inline-flex;border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden}
    .seg button{background:transparent;border:0;color:#cfe0ff;font-weight:700;padding:6px 10px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:rgba(122,68,255,.33)}
    .chart-wrap{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px;
      height:220px; /* fixed so Chart.js lays out consistently, gold volume shows clean */
    }
    #izzaChart{ display:block; width:100%; height:100% }

    /* mini help */
    .help{color:#cfe0ff;font-size:12px;opacity:.9}

    /* simple form */
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field input,.field select{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#fff;padding:10px;border-radius:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row2{grid-template-columns:1fr} }
    .tabbar{display:flex;gap:8px;margin-bottom:8px}
    .tabbar button{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:8px 10px;border-radius:10px;color:#fff;font-weight:800;cursor:pointer}
    .tabbar button[aria-pressed="true"]{background:rgba(122,68,255,.33)}

    /* Mobile-first claim blocks */
    .claim-block{
      border-radius:14px;
      padding:12px;
      margin:10px 6px;
      box-shadow: 0 0 0 1px var(--line) inset;
    }
    .claim-block.regular{ background: rgba(122,68,255,0.08); }
    .claim-block.vote{    background: rgba(255,205,96,0.10); }
    .cb-head{ display:flex; align-items:center; gap:10px; }
    .cb-head .meta{ color:var(--muted); font-size:12px; margin-left:auto; }
    .cb-head .pick{ display:flex; align-items:center; gap:6px; font-size:14px; }
    .cb-body{ margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .cb-body .line{ display:flex; justify-content:space-between; align-items:center; }
    .cb-body .line.sub{ font-size:13px; opacity:.9; }
    @media (min-width:760px){ .claim-block{ margin:10px 0; } }
    /* === CLAIM MODAL: surgical fixes === */

/* 1) remove the column labels row */
#claimTbl thead { display:none !important; }

/* 2) keep rows inside the card, no right-edge creep */
#claimTbl{ width:100%; table-layout:fixed; }          /* predictable cell widths */
#claimTbl td{ padding:10px 12px; overflow:hidden; text-overflow:ellipsis; }
#claimTbl .num{ white-space:nowrap; }                 /* numbers don‚Äôt wrap weirdly */
.modal-body{ overflow-x:hidden; }                     /* belt-and-suspenders */

/* 3) make the legend's VOTE pill gold (override generic .pill) */
#claimLegend .pill-vote,
#claimTbl .pill-vote{
  background: rgba(255,205,96,.18) !important;
  border: 1px solid rgba(255,205,96,.65) !important;
  color: #2a1b00 !important;
}
    /* 1) Hide the "Stake ‚Ä¢ unlock 2025-.." label in each contract header */
#claimTbl tr.group-head strong{ display:none !important; }

/* 2) Make the VOTE pill text white (legend + rows) */
#claimLegend .pill-vote,
#claimTbl .pill-vote{
  background: rgba(255,205,96,.18) !important;
  border: 1px solid rgba(255,205,96,.65) !important;
  color: #fff !important;
  text-shadow: 0 1px 2px rgba(0,0,0,.45);
}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="logo" href="{{ APP_BASE_URL or '/' }}" title="Back"
         onclick="try{history.back();}catch(_){/*fallback*/}">
        <img src="/static/izzapay-word.svg" alt="IZZA PAY">
      </a>

      <div class="top-cta" style="grid-column:1 / -1; width:100%; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
        <button id="roadmapBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="roadmapModal">
          <img src="/static/izzapay-mark.svg" alt="" aria-hidden="true">
          View Mainnet Roadmap
        </button>

        <button id="walletBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="myWalletModal">
          üíº IZZA Wallet
        </button>
      </div>

      <div>
        <h1>IZZA ‚Äî Test Token Showcase</h1>
        <p class="lead">Issuer, distributor, balances and activity on Pi Testnet.</p>
      </div>
      <div class="spacer"></div>
    </header>

    <section class="hero">
      <!-- LEFT: main token summary -->
      <div class="panel" style="position:relative;overflow:hidden">
        <div class="bg-weave" aria-hidden="true"></div>

        <div class="token-row">
          <div class="token-img" id="coinWrap" style="--pulse-size: 80px; --pulse-offset-x: -42px; --pulse-offset-y: -36px;">
            <img id="coinImg" src="{{ url_for('serve_assets', filename='izza.png') }}" alt="IZZA token">
          </div>

          <div class="side-badge">
            <button id="badgeOpen" class="mark-wrap" type="button" title="Open Mainnet Roadmap">
              <img src="/static/izzapay-mark.svg" alt="IZZA mark">
            </button>
            <div class="arcade">Spin the coin</div>
            <div class="hint">(to refresh data)</div>
          </div>

          <div class="meta">
            <h2>IZZA <span style="opacity:.65">({{ ASSET_CODE }})</span></h2>
          </div>
        </div>

        <div class="two" style="margin-top:12px">
          <div class="stat">
            <div class="label">Distributor balance (IZZA)</div>
            <strong id="dist-balance">‚Äî</strong>
          </div>
          <div class="stat">
            <div class="label">Holders / trustlines</div>
            <strong id="trust-count">‚Äî</strong>
          </div>
        </div>

        <div class="top-cta" style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
  <button id="orderbookBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="orderbookModal">üìä Live Order Book</button>
  <button id="orderBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="placeOrderModal">üßæ Place Testnet Order</button>
</div>

<div class="top-cta" style="margin-top:8px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
  <button id="stakeQuickBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="stakeModal">üì• Stake</button>
  <button id="claimQuickBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="claimModal">üí∞ Claim</button>
  <button id="voteQuickBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="voteModal">üó≥Ô∏è Vote (Stake)</button>
</div>

<!-- Craft in IZZA City -->
<div class="top-cta" style="margin-top:8px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
  <a id="craftLink" class="cta" href="/izza-game/auth?dest=city" aria-label="Open IZZA City to Craft">üß™ Craft in IZZA City</a>
</div>
<p class="help" style="text-align:center; margin-top:6px">
  Step 1, sign in to IZZA City, Step 2, click Craft inside the game, Step 3, your crafted item is saved to your game inventory and mirrored to your IZZA Pay merchant dashboard, where you can mint it to a testnet NFT.
</p>

      <!-- RIGHT: quick details + QR + activity dropdown -->
      <aside class="panel">
        <div class="card-title">
          <strong>Quick details</strong>
          <span class="small-muted">Pi Testnet</span>
        </div>

        <div class="grid">
          <div class="mini">
            <div class="ico"><img src="{{ url_for('serve_assets', filename='izza.png') }}" alt=""></div>
            <div>
              <div class="small-muted">Asset</div>
              <strong>{{ ASSET_CODE }}</strong>
            </div>
          </div>

          <div class="mini">
            <div class="ico purple"><img src="{{ url_for('serve_assets', filename='izza.png') }}" alt=""></div>
            <div>
              <div class="small-muted">Issuer</div>
              <div id="issuer-compact" class="mono" style="font-size:12px"></div>
            </div>
          </div>

          <div class="mini">
            <div class="ico">üß¨</div>
            <div>
              <div class="small-muted">Origin</div>
              <div class="mono" style="font-size:12px">izzapay.onrender.com</div>
            </div>
          </div>

          <div class="mini">
            <div class="ico purple">üß©</div>
            <div>
              <div class="small-muted">Network</div>
              <div class="mono" style="font-size:12px">Pi Testnet</div>
            </div>
          </div>
        </div>

        <hr class="sep">

        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div>
            <div class="small-muted">Distributor</div>
            <div id="d-short" class="mono" style="font-size:12px"></div>
          </div>
          <div style="text-align:right">
            <div class="small-muted" style="margin-bottom:6px">Scan to add</div>
            <img id="qrimg" src="" alt="QR" width="120" height="120" style="border-radius:12px">
            <div class="small-muted" style="margin-top:6px;font-size:12px;max-width:220px">
              When this feature becomes available through Pi Network, you‚Äôll be able to add this token using this QR code.
            </div>
          </div>
        </div>

        <details class="activity">
          <summary>Recent activity</summary>
          <div class="ops" id="recentOps">Loading‚Ä¶</div>
        </details>
      </aside>
    </section>

    <section class="lower">
      <div class="panel" id="linksPanel">
        <h3 style="margin:0 0 8px 0">Raw data and quick links</h3>
        <p class="small-muted" style="margin:4px 0 10px">Open Pi Testnet Horizon endpoints directly.</p>
        <div class="btnrow">
          <a class="linkbtn" id="link-account" href="#" target="_blank" rel="noopener">Distributor account</a>
          <a class="linkbtn" id="link-payments" href="#" target="_blank" rel="noopener">Payments</a>
          <a class="linkbtn" id="link-ops" href="#" target="_blank" rel="noopener">Operations</a>
          <a class="linkbtn" id="link-assets" href="#" target="_blank" rel="noopener">Asset lookup</a>
        </div>
      </div>

      <div class="panel" id="deepSection">
        <h3 style="margin:0 0 8px 0">Developer notes</h3>
        <div class="small-muted" style="margin-bottom:10px">
          Issuer and distributor details and last operations from Pi Testnet. This page is a showcase and diagnostic view for the token.
        </div>

        <div>
          <div class="small-muted">Deep Link</div>
          <pre style="margin-top:8px;white-space:pre-wrap;word-break:break-all;font-family:var(--mono);background:transparent;border:1px dashed rgba(255,255,255,.08);padding:10px;border-radius:10px" id="deepPre"></pre>
        </div>
      </div>
    </section>

    <footer>IZZA PAY ‚Äî Testnet showcase ¬∑ Built for demo and diagnostics</footer>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop" id="modalBackdrop" hidden></div>

  <!-- ROADMAP MODAL -->
  <div class="modal" id="roadmapModal" role="dialog" aria-modal="true" aria-labelledby="roadmapTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="">
          <span id="roadmapTitle">MAINNET ROADMAP</span>
        </div>
        <button class="close-btn" type="button" id="closeModalBtn">Close</button>
      </div>
      <div class="modal-body">
        <span class="pill">Total Supply Target: 33.33 Billion (Mainnet)</span>
        <div class="road-grid" style="margin-top:12px">
          <div class="blox">
            <h4>Why a Token at All?</h4>
            <p>IZZA Coins power gameplay.<br><strong>IZZA Token</strong> powers the ecosystem.</p>
            <ul class="list">
              <li><strong>Governance</strong>: Vote on new mini-games, IZZA City expansions, creator marketplace rules.</li>
              <li><strong>Staking</strong>: Stake tokens to earn boosted Crafting Credits and seasonal IZZA Coin boosts.</li>
              <li><strong>Access</strong>: Token-gated drops, rare blueprints, early creator tools.</li>
              <li><strong>Biz Utility</strong>: Merchant fee discounts and premium IZZA Pay tiers for holders.</li>
              <li><strong>Dev Listing</strong>: Arcade listings prioritized via stake and quality score.</li>
            </ul>
            <div class="img-row" style="margin-top:10px">
              <img src="{{ url_for('serve_assets', filename='izza.png') }}" alt="IZZA coin">
              <img src="/static/izzapay-mark.svg" alt="IZZA mark">
            </div>
          </div>

          <div class="blox">
            <h4>Economy Layering</h4>
            <div class="grid-2">
              <div class="statline">
                <div class="mini-mark" style="font-size:18px;line-height:1">üëæ</div>
                <div><strong>IZZA Coins</strong><div class="small" style="color:var(--muted)">Soft in-game currency</div></div>
              </div>
              <div class="statline">
                <div class="mini-mark">üíé</div>
                <div><strong>Crafting Credits</strong><div class="small" style="color:var(--muted)">Premium consumable via Pi</div></div>
              </div>
              <div class="statline center-span">
                <div class="mini-mark"><img src="{{ url_for('serve_assets', filename='izza.png') }}" style="width:18px;height:18px" alt=""></div>
                <div style="text-align:center;width:100%">
                  <strong>IZZA Token</strong>
                  <div class="small" style="color:var(--muted)">Scarce, stake and govern</div>
                </div>
              </div>
            </div>
            <p style="margin-top:10px">Peg reference stays for in-game economics (2,000 Coins ‚âà 1 Pi). Token remains <em>non-inflationary</em> with utility via staking and access.</p>
          </div>
        </div>

        <div class="blox" style="margin-top:12px">
          <h4>Distribution Plan (Illustrative)</h4>
          <div class="grid-2">
            <ul class="list">
              <li><strong>40%</strong> Growth: public sale and staking rewards</li>
              <li><strong>25%</strong> Ecosystem: new games, marketplace, tools</li>
              <li><strong>20%</strong> Team: 12-month cliff, 36-month vest</li>
              <li><strong>10%</strong> Partners: merchants, collabs</li>
              <li><strong>5%</strong> Community: airdrops for early testers</li>
            </ul>
            <div>
              <p style="margin:4px 0 0 0;color:#cfe0ff">Vesting and emissions published on-chain. Staking yields are dynamic and balanced vs. arcade earnings to avoid inflation shocks.</p>
              <div class="glow-stack" style="margin-top:14px;">
                <div class="glow violet" style="--sz:45px;--img:48px;--offset-x:0;--offset-y:-4px;">
                  <img src="/static/izzapay-mark.svg" alt="">
                </div>
                <div class="glow gold" style="--sz:40px;--img:66px;--offset-x:0;--offset-y:6px;">
                  <img src="{{ url_for('serve_assets', filename='izza.png') }}" alt="IZZA coin">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="blox" style="margin-top:12px">
          <h4>Launch Roadmap</h4>
          <ul class="list">
            <li><strong>Phase 1 ‚Äî Testnet Live</strong>: Issuer and distributor diagnostics, faucet and trustlines, IZZA City and Arcade earn loop validated.</li>
            <li><strong>Phase 2 ‚Äî Staking Beta</strong>: Token staking ‚Üí soft boosts to Crafting Credit earnings, seasonal badges, holder quests.</li>
            <li><strong>Phase 3 ‚Äî Governance v1</strong>: On-chain votes for new Arcade titles, blueprint rarity schedules, and marketplace fees.</li>
            <li><strong>Phase 4 ‚Äî Merchant Utility</strong>: IZZA Pay fee rebates for holders, business dashboards with token-gated promos.</li>
            <li><strong>Phase 5 ‚Äî Mainnet Mint (33.33B)</strong>: Final supply and vesting on chain, liquidity bootstrapping, cross-ecosystem creator drops.</li>
          </ul>
        </div>

        <div class="blox" style="margin-top:12px">
          <h4>Value Loop</h4>
          <p>Players earn Coins ‚Üí buy Crafting Credits via Pi ‚Üí craft and trade ‚Üí creators and merchants thrive. <strong>IZZA Token</strong> captures upside by governing, staking, and unlocking the best parts of the ecosystem.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- MY WALLET MODAL -->
<div class="modal" id="myWalletModal" role="dialog" aria-modal="true" aria-labelledby="myWalletTitle" hidden>
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <img src="/static/izzapay-mark.svg" alt="">
        <span id="myWalletTitle">My IZZA Wallet</span>
      </div>
      <button class="close-btn" type="button" id="closeMyWalletBtn">Close</button>
    </div>
    <div class="modal-body">
      <div class="blox">
        <div class="small-muted">Signed in as</div>
        <div><strong id="mwUser">‚Äî</strong></div>
      </div>
      <div class="blox" style="margin-top:10px">
        <div class="small-muted">Active Wallet (public key)</div>
        <div class="mono" id="mwPub" style="word-break:break-all">‚Äî</div>
      </div>
      <div class="grid" style="gap:12px;margin-top:10px">
        <div class="blox">
          <h4>Balances</h4>
          <div class="small-muted">Pi</div><div class="mono" id="mwPi">‚Äî</div>
          <div class="small-muted" style="margin-top:8px">IZZA</div><div class="mono" id="mwIzza">‚Äî</div>
        </div>
        <div class="blox">
          <h4>Actions</h4>

          <!-- row with Reveal + My IZZA NFTs -->
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="revealOnceBtn" class="cta">Reveal Secret (once)</button>
            <button id="openMyNftsBtn" class="cta">My IZZA NFTs</button>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button id="openStakeBtn" class="cta">üì• Stake IZZA</button>
            <button id="openClaimBtn" class="cta">üí∞ Claim Rewards</button>
          </div>
          <div class="help" style="margin-top:8px">
            <strong>Non-custodial wallet</strong>, secret never sent to server.
            <br><em>Reveal once per session only.</em>
          </div>
          <pre id="secretOnce" style="display:none;margin-top:10px;padding:10px;border:1px dashed rgba(255,255,255,.12);border-radius:10px"></pre>
          <div class="blox" style="margin-top:10px">
            <h4>Import Secret (existing wallet)</h4>
            <div class="field"><label>Public Key (G‚Ä¶)</label><input id="impPub" type="text" placeholder="G..." autocomplete="off"></div>
            <div class="field"><label>Secret Key (S‚Ä¶)</label><input id="impSec" type="password" placeholder="S..." autocomplete="off"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <button id="importSecretBtn" class="cta">Save Secret Locally</button>
              <label style="display:flex;gap:8px;align-items:center"><input id="impUseForOrders" type="checkbox" checked><span>Set as Active for Orders</span></label>
            </div>
            <div id="impMsg" class="help" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- MY IZZA NFTs MODAL -->
<div class="modal" id="myNftsModal" role="dialog" aria-modal="true" aria-labelledby="myNftsTitle" hidden>
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <img src="/static/izzapay-mark.svg" alt="">
        <span id="myNftsTitle">My IZZA NFTs</span>
      </div>
      <button class="close-btn" type="button" id="closeMyNftsBtn">Close</button>
    </div>

    <div class="modal-body">
      <div class="blox">
        <div class="small-muted">Wallet</div>
        <div class="mono wrapaddr" id="nftPubEcho">‚Äî</div>
      </div>

      <div class="blox" style="margin-top:10px">
        <h4 style="margin:0 0 8px 0">Owned / Pending NFTs</h4>
        <div id="nftList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px"></div>
        <div id="nftMsg" class="help" style="margin-top:8px"></div>
      </div>

      <div class="top-cta" style="margin-top:10px">
        <a id="nftCraftCta" class="cta" href="/izza-game/auth?dest=city">üß™ Craft more in IZZA City</a>
      </div>
    </div>
  </div>
</div>
  <!-- ORDER BOOK MODAL -->
  <div class="modal" id="orderbookModal" role="dialog" aria-modal="true" aria-labelledby="orderbookTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="">
          <span id="orderbookTitle">IZZA / Pi ‚Äî Order Book</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <a id="addTrustBtn" class="close-btn" style="text-decoration:none" href="#deepSection">Add Trustline (SEP-7)</a>
          <button class="close-btn" id="closeOrderbookBtn">Close</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="ob-toolbar" style="margin-bottom:10px">
          <div class="seg" role="tablist">
            <button class="rangeBtn" data-range="1D" aria-pressed="true">1D</button>
            <button class="rangeBtn" data-range="1W">1W</button>
            <button class="rangeBtn" data-range="1M">1M</button>
            <button class="rangeBtn" data-range="1Y">1Y</button>
            <button class="rangeBtn" data-range="ALL">ALL</button>
          </div>
          <span class="help">Purple = Price (Pi/IZZA), Gold = Volume</span>
        </div>

        <div class="chart-wrap"><canvas id="izzaChart"></canvas></div>

        <div class="row" style="margin:12px 0">
          <div class="pill">Best Ask: <span id="obBestAsk">‚Äì</span> Pi</div>
          <div class="pill">Best Bid: <span id="obBestBid">‚Äì</span> Pi</div>
          <div class="pill">Spread: <span id="obSpread">‚Äì</span></div>
          <div class="pill">Total Asks: <span id="obSumAsks">‚Äì</span> IZZA</div>
          <div class="pill">Updated: <span id="obUpdated">‚Äì</span></div>
        </div>

        <div class="grid" style="gap:12px">
          <div class="blox">
            <h4>Sell Orders (Asks)</h4>
            <table id="asksTbl"><thead><tr><th>Price (Pi)</th><th>Amount (IZZA)</th><th>Total (Pi)</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="blox">
            <h4>Buy Orders (Bids)</h4>
            <table id="bidsTbl"><thead><tr><th>Price (Pi)</th><th>Amount (IZZA)</th><th>Total (Pi)</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="small-muted" style="margin-top:10px">
          Data source: Pi Testnet Horizon. Auto-refreshes every 10s. <a id="rawOrderbookLink" target="_blank">Raw JSON</a>
        </div>
      </div>
    </div>
  </div>

  <!-- STAKE MODAL -->
  <div class="modal" id="stakeModal" role="dialog" aria-modal="true" aria-labelledby="stakeTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title"><img src="/static/izzapay-mark.svg" alt=""><span id="stakeTitle">Stake IZZA</span></div>
        <button class="close-btn" id="closeStakeBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="blox"><div class="small-muted">Public Key</div><input id="stakePub" class="mono"></div>
        <div class="row2" style="margin-top:10px">
          <div class="field">
            <label>Amount (IZZA)</label>
            <input id="stakeAmt" type="number" step="0.0000001" inputmode="decimal" placeholder="e.g. 1000">
          </div>
          <div class="field">
            <label>Lock Days</label>
            <input id="stakeDays" type="number" min="1" max="180" value="30">
            <small id="stakeDaysMsg" class="small-muted">Max 180 days.</small>
          </div>
        </div>
        <div id="stakePreviewBox" style="margin-top:10px;display:none">
          <div class="grid" style="gap:10px">
            <div><div class="small-muted">APR</div><strong id="stakeAPR">‚Äî</strong></div>
            <div><div class="small-muted">Reward</div><strong id="stakeReward">‚Äî</strong></div>
            <div><div class="small-muted">Unlock</div><strong id="stakeUnlock">‚Äî</strong></div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="stakePreviewBtn" class="cta">Preview</button>
          <button id="stakeStartBtn" class="cta" disabled>Start Stake</button>
        </div>
        <div id="stakeMsg" class="help" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- CLAIM MODAL -->
  <div class="modal" id="claimModal" role="dialog" aria-modal="true" aria-labelledby="claimTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title"><img src="/static/izzapay-mark.svg" alt=""><span id="claimTitle">Claim Rewards and Principal</span></div>
        <button class="close-btn" id="closeClaimBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="blox"><div class="small-muted">Public Key</div><input id="claimPub" class="mono" readonly aria-readonly="true"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="claimRefreshBtn" class="cta">Refresh</button>
          <button id="claimSelectedBtn" class="cta" disabled>Claim Selected</button>
        </div>
        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Claimable Balances</div>

          <div id="claimLegend" style="display:flex;align-items:center;gap:12px;margin:6px 0 8px">
  <span class="pill pill-regular" aria-hidden="true">normal</span>
  <small class="small-muted">= regular stake</small>
  <span class="pill pill-vote" aria-hidden="true">vote</span>
  <small class="small-muted">= vote stake</small>
  <span class="pill pill-nft" aria-hidden="true">nft</span>
  <small class="small-muted">= purchased NFTs</small>
</div>

          <table id="claimTbl">
            <thead>
              <tr><th>Pick</th><th>Kind</th><th>Amount and Share</th><th>Unlock</th></tr>
            </thead>
              <tbody id="claimBody"></tbody>
          </table>
        </div>
        <div id="claimMsg" class="help" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- VOTE MODAL -->
  <div class="modal" id="voteModal" role="dialog" aria-modal="true" aria-labelledby="voteTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title"><img src="/static/izzapay-mark.svg" alt=""><span id="voteTitle">Vote for Next Arcade Game</span></div>
        <button class="close-btn" id="closeVoteBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="blox" style="margin-bottom:10px">
          <div class="small-muted">How it works</div>
          <div class="help">
            Each staked token = <strong>1 vote</strong> toward the game you pick.
            The winning game is built, and <strong>100% of its Pi Ad Network revenue</strong> is distributed to accounts that staked votes on that game, pro-rata to their staked amount and lock duration.
          </div>
        </div>

        <div class="row2" style="margin-top:6px">
          <div class="field">
            <label>Public Key</label>
            <input id="votePub" class="mono" placeholder="G‚Ä¶">
          </div>
          <div class="field">
            <label>Lock Days</label>
            <input id="voteDays" type="number" min="1" max="180" value="30">
            <small class="small-muted">Max 180 days.</small>
          </div>
        </div>

        <div class="field">
          <label>Choose Arcade Proposal</label>
          <select id="voteGame"></select>
        </div>

        <div class="field">
          <label>Amount to Stake (IZZA)</label>
          <input id="voteAmt" type="number" step="0.0000001" inputmode="decimal" placeholder="e.g. 1000">
        </div>

        <div id="votePreviewBox" style="display:none; margin-top:8px">
          <div class="grid" style="gap:10px">
            <div><div class="small-muted">Est. APR Boost</div><strong id="voteAPR">‚Äî</strong></div>
            <div><div class="small-muted">Your Votes</div><strong id="voteVotes">‚Äî</strong></div>
            <div><div class="small-muted">Unlock</div><strong id="voteUnlock">‚Äî</strong></div>
          </div>
          <div class="help" style="margin-top:6px">
            Distribution happens to stakers of the <em>winning</em> game. If your pick doesn‚Äôt win, you can restake in the next round after unlock.
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="votePreviewBtn" class="cta">Preview</button>
          <button id="voteStartBtn" class="cta" disabled>Stake Votes</button>
        </div>
        <div id="voteMsg" class="help" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- PLACE ORDER MODAL -->
  <div class="modal" id="placeOrderModal" role="dialog" aria-modal="true" aria-labelledby="placeOrderTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="">
          <span id="placeOrderTitle">Place Testnet Order</span>
        </div>
        <button class="close-btn" type="button" id="closePlaceOrderBtn">Close</button>
      </div>
      <div class="modal-body">
        <div id="walletCreateRow" class="row" style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
          <button id="createWalletBtn" type="button" class="cta">‚úö Create Test Wallet</button>
          <div id="walletStatus" class="help" aria-live="polite"></div>
        </div>

        <div id="newWalletBox" class="blox" style="display:none;margin-bottom:10px">
          <h4 style="margin:0 0 6px 0">Your IZZA Test Wallet</h4>
          <div class="small-muted">Public Key</div>
          <div id="newPub" class="mono" style="word-break:break-all;margin:4px 0 8px"></div>

          <div class="grid" style="gap:12px">
            <div>
              <div class="small-muted" style="margin-bottom:6px">Scan to Fund (Testnet)</div>
              <canvas id="newWalletQR" width="120" height="120" style="border-radius:12px;background:#fff"></canvas>
            </div>
            <div class="help" style="align-self:center">
              <strong>We‚Äôll auto-fund your new wallet with 2.0 Test-Pi.</strong><br>
              Watch the status above. If funding fails, use ‚ÄúCheck Funding‚Äù to retry later.
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="checkFundingBtn" type="button" class="cta">Check Funding</button>
            <button id="addTrustlineBtn" type="button" class="cta" disabled>‚ûï Add IZZA Trustline</button>
          </div>
        </div>

        <div class="help" style="margin-bottom:8px">
          <strong>Note:</strong> Pi Wallet does not yet support direct order placement.
          This demo will work in other wallets that support <strong>SEP-7</strong> transactions.
        </div>

        <div class="tabbar" role="tablist" aria-label="Side">
          <button class="sideBtn" data-side="BUY" aria-pressed="true">BUY IZZA</button>
          <button class="sideBtn" data-side="SELL">SELL IZZA</button>
        </div>

        <div class="tabbar" role="tablist" aria-label="Type">
          <button class="typeBtn" data-type="LIMIT" aria-pressed="true">Limit</button>
          <button class="typeBtn" data-type="MARKET">Market</button>
        </div>

        <div id="orderHelp" class="help" style="margin:8px 0 10px" aria-live="polite">
          Limit: you set the price. Market: we auto-use the best available price ¬± slippage.
        </div>
        <div id="slipRow" class="row2" style="display:none">
          <div class="field">
            <label>Slippage (%)</label>
            <input id="slippagePct" type="number" step="0.1" min="0" max="50" value="3" inputmode="decimal">
          </div>
          <div class="field" style="align-self:end">
            <label class="small-muted" style="display:block;margin-bottom:6px">Consent</label>
            <label style="display:flex;gap:8px;align-items:flex-start">
              <input id="agreeSlippage" type="checkbox">
              <span>I accept execution up to <span id="slipEcho">3</span>% away from the best price.</span>
            </label>
          </div>
        </div>
        <div id="autoPriceNote" class="help" style="display:none;margin:-4px 0 8px">
          Estimated execution price: <strong id="autoPricePreview">‚Äî</strong> Pi per IZZA.
        </div>

        <form id="orderForm">
          <div class="field">
            <label>Public Key (your account)</label>
            <input id="acctPub" type="text" placeholder="G... (testnet account)" required>
          </div>

          <div class="field" id="secRow" style="display:none">
            <label>Secret Key (S‚Ä¶) <span class="small-muted">(used only to sign this order, never sent to server)</span></label>
            <input id="acctSec" type="password" placeholder="S..." inputmode="latin" autocomplete="off">
            <label style="margin-top:6px;display:flex;gap:8px;align-items:center">
              <input id="rememberSec" type="checkbox">
              <span>Save locally for next time (on this device)</span>
            </label>
          </div>

          <div class="row2">
            <div class="field">
              <label>Price (Pi per IZZA)</label>
              <input id="price" type="number" step="0.0000001" inputmode="decimal" placeholder="e.g. 0.005" required>
            </div>
            <div class="field">
              <label>Amount (IZZA)</label>
              <input id="amount" type="number" step="0.0000001" inputmode="decimal" placeholder="e.g. 2000" required>
            </div>
          </div>

          <div class="field">
            <button id="buildSep7" type="submit" class="cta" style="width:max-content">Open in SEP-7 Wallet</button>
          </div>

          <div class="help" id="orderMsg" aria-live="polite"></div>
        </form>

        <div style="margin-top:14px;border-top:1px solid rgba(255,255,255,.08);padding-top:12px">
          <button id="cancelOrdersBtn" type="button" class="cta" style="background:linear-gradient(180deg,#ff5c5c,#d63a3a)">
            ‚ùå Cancel My Current Orders
          </button>
          <div id="cancelMsg" class="help" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>
<!-- Pi Platform SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js" defer></script>
  <!-- libs (from CDN) -->
  <!-- better: Chart first, then adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.5.1/stellar-sdk.min.js" integrity="sha512-+uYc8WQvG8c+0pT1+QqJp5gR1+N1iFj3F1p7Xw8eNsQqA+8k0vP9a6NqEgbjG7e0oZ2FQg3e3sH4q1P5gFKM0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
(() => {
  // =================== Config from Jinja / server ===================
const ASSET_CODE  = "{{ ASSET_CODE }}";
const ISSUER      = "{{ ISSUER }}";
const DISTRIBUTOR = "{{ DISTRIBUTOR }}";
const API_BASE = ("{{ API_BASE }}".startsWith("http")
  ? "{{ API_BASE }}"
  : "https://api.testnet.minepi.com");
const DEEP_LINK   = "{{ DEEP_LINK }}";
// ---- compact issuer/distributor labels ----
function short(g){
  return (g && g.length > 14) ? `${g.slice(0,6)}‚Ä¶${g.slice(-6)}` : (g || '‚Äî');
}
const issEl = document.getElementById('issuer-compact');
if (issEl){
  issEl.textContent = short(ISSUER);
  issEl.title = ISSUER;
}
const distEl = document.getElementById('d-short');
if (distEl){
  distEl.textContent = short(DISTRIBUTOR);
  distEl.title = DISTRIBUTOR;
}
// =================== Pi Auth + Active Wallet (one per user) ===================
let USER = null;                // { uid, username }
let ACTIVE_PUB = null;          // active wallet public key from server
const VAULT_KEY = 'izza_wallets'; // same key

function __readVault(){
  try { return JSON.parse(localStorage.getItem(VAULT_KEY) || '{}'); }
  catch { return {}; }
}

// Store secret per user + pub; keep one-time-reveal flag
function saveLocalSecret(pub, secret, username){
  const u = username || (USER && USER.username) || '_anon';
  const all = __readVault();

  // Migrate legacy { [pub]:{blob} } ‚Üí { __namespaced:true, [u]:{[pub]:{...}} }
  if (!all.__namespaced && all && Object.keys(all).some(k => k.startsWith('G') && all[k]?.blob)) {
    const migrated = { [u]: {}, __namespaced: true };
    for (const k of Object.keys(all)) {
      if (k.startsWith('G') && all[k]?.blob) {
        migrated[u][k] = { ...all[k], viewedOnce:false, createdAt: Date.now() };
      }
    }
    localStorage.setItem(VAULT_KEY, JSON.stringify(migrated));
    return saveLocalSecret(pub, secret, username);
  }

  all.__namespaced = true;
  all[u] = all[u] || {};
  all[u][pub] = { blob: btoa(secret), viewedOnce:false, createdAt: Date.now() };
  localStorage.setItem(VAULT_KEY, JSON.stringify(all));
}

function getLocalSecret(pub, username){
  const u = username || (USER && USER.username) || '_anon';
  const all = __readVault();
  if (all?.__namespaced) return all?.[u]?.[pub]?.blob ? atob(all[u][pub].blob) : null;
  return all?.[pub]?.blob ? atob(all[pub].blob) : null; // legacy
}
// === Import Secret flow (for existing wallets) ===
const impPub  = document.getElementById('impPub');
const impSec  = document.getElementById('impSec');
const impMsg  = document.getElementById('impMsg');
const importBtn = document.getElementById('importSecretBtn');
const impUseForOrders = document.getElementById('impUseForOrders');

if (importBtn) {
  importBtn.addEventListener('click', async () => {
    const pub = (impPub.value || '').trim();
    const sec = (impSec.value || '').trim();
    if (!pub.startsWith('G') || !sec.startsWith('S')) {
      impMsg.textContent = '‚ùå Invalid keys. Public key must start with G and secret with S.';
      return;
    }

    try {
      saveLocalSecret(pub, sec, USER?.username);
      impMsg.textContent = '‚úÖ Secret stored locally. You can now sign transactions.';

      // Optional: set as active wallet
      if (impUseForOrders.checked) {
        ACTIVE_PUB = pub;
        try { await linkActiveWallet(pub); } catch (_) {}
        const acct = document.getElementById('acctPub');
        if (acct) acct.value = pub;
        setOrderReady(true, true);
      }

      impPub.value = '';
      impSec.value = '';
    } catch (err) {
      impMsg.textContent = '‚ùå Could not save secret: ' + String(err);
    }
  });
}
function markSecretViewedOnce(pub, username){
  const u = username || (USER && USER.username) || '_anon';
  const all = __readVault();
  if (all?.__namespaced && all?.[u]?.[pub]) {
    all[u][pub].viewedOnce = true;
    localStorage.setItem(VAULT_KEY, JSON.stringify(all));
  }
}

function hasViewedOnce(pub, username){
  const u = username || (USER && USER.username) || '_anon';
  const all = __readVault();
  return !!(all?.__namespaced && all?.[u]?.[pub]?.viewedOnce);
}

// =================== Tiny logger (+ global error taps) ===================
function log(evt, extra){
  try{
    const payload = { t:new Date().toISOString(), evt, extra:extra||null,
                      ua:(navigator&&navigator.userAgent)||'unknown',
                      href:(location&&location.href)||'' };
    console.log('[IZZA]', payload);
    fetch('/_client-log', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    }).catch(()=>{});
  }catch(_){}
}
window.addEventListener('error', e=>log('window.error',{msg:String(e.message||e),stack:e.error&&e.error.stack||null}));
window.addEventListener('unhandledrejection', e=>log('unhandledrejection',{reason:String(e.reason||'unknown')}));

// =================== Safe script loader (for WebViews/iOS) ===================
function loadScriptOnce(id, src){
  return new Promise((resolve,reject)=>{
    if (document.getElementById(id)) return resolve(true);
    const s = document.createElement('script');
    s.id = id; s.src = src; s.async = true; s.crossOrigin = 'anonymous';
    s.onload = ()=>resolve(true);
    s.onerror = ()=>reject(new Error('load-failed:'+src));
    document.head.appendChild(s);
  });
}
async function ensureStellar(){
  if (window.StellarSdk) return true;
  log('stellar.ensure.start');
  const sources = [
    '/static/stellar-sdk.min.js', // self-hosted first
    'https://cdn.jsdelivr.net/npm/stellar-sdk@10.5.1/dist/stellar-sdk.min.js',
    'https://unpkg.com/stellar-sdk@10.5.1/dist/stellar-sdk.min.js'
  ];
  for (let i=0;i<sources.length;i++){
    try{
      await loadScriptOnce('stellar-sdk-'+i, sources[i]);
      if (window.StellarSdk){ log('stellar.ensure.ok',{i,src:sources[i]}); return true; }
    }catch(e){ log('stellar.ensure.fail.try',{i,err:String(e)}); }
  }
  log('stellar.ensure.fail.all'); return false;
}
async function ensureChart(){
  if (!window.Chart){
    log('chart.ensure.chart.start');
    const urls = [
      '/static/chart.umd.min.js',
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
      'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'
    ];
    for (let i=0;i<urls.length && !window.Chart;i++){
      try{ await loadScriptOnce('chartjs-'+i, urls[i]); }catch(e){ log('chart.ensure.chart.fail.try',{i,err:String(e)}); }
    }
    if (!window.Chart){ log('chart.ensure.chart.fail.all'); return false; }
    log('chart.ensure.chart.ok');
  }
  if (!Chart._adapters || !Chart._adapters._date){
    log('chart.ensure.adapter.start');
    const urls = [
      '/static/chartjs-adapter-date-fns.min.js',
      'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3',
      'https://unpkg.com/chartjs-adapter-date-fns@3'
    ];
    for (let i=0;i<urls.length && (!Chart._adapters || !Chart._adapters._date); i++){
      try{ await loadScriptOnce('chartjs-adapter-'+i, urls[i]); }catch(e){ log('chart.ensure.adapter.fail.try',{i,err:String(e)}); }
    }
    if (!Chart._adapters || !Chart._adapters._date){ log('chart.ensure.adapter.fail.all'); return false; }
    log('chart.ensure.adapter.ok');
  }
  return true;
}
// ---- Boot hydration: get USER + ACTIVE_PUB before any UI gates ----
async function hydrateUserAndWallet() {
  // 1) Try server session
  try {
    const me = await fetch('/api/auth/me', { credentials:'include', cache:'no-store' })
      .then(r => r.ok ? r.json() : null).catch(()=>null);
    if (me?.uid) USER = { uid: me.uid, username: me.username };
    if (USER) window.USER = USER;   // ensure global visibility after session hydrate
  } catch (_) {}

  // 2) If no USER, silently Pi-auth (Pi Browser usually returns instantly)
  if (!USER) {
    try { await piSignIn(); } catch (_) { /* user canceled, read only */ }
  }

  // 3) Ask server for the mapped active wallet
  await fetchActiveWallet();

  // 4) If server has nothing, fall back to local
  if (!ACTIVE_PUB) {
    try {
      const local = JSON.parse(localStorage.getItem('izza_test_wallet') || 'null');
      if (local?.pub) {
        ACTIVE_PUB = local.pub;
        try { await linkActiveWallet(ACTIVE_PUB); } catch (_) {}
      }
    } catch (_) {}
  }

  // 5) Pre-fill UI bits and enable actions if we can sign locally
  try {
    const acct = document.getElementById('acctPub');
    if (ACTIVE_PUB && acct && !acct.value) acct.value = ACTIVE_PUB;
    const hasLocal = ACTIVE_PUB && !!getLocalSecret(ACTIVE_PUB);
    setOrderReady(!!ACTIVE_PUB, hasLocal || (ACTIVE_PUB && getLocalSecret(ACTIVE_PUB)));
  } catch (_) {}
}
let __hydrated = false;
(async () => {
  await hydrateUserAndWallet();
  __hydrated = true;
})();
// run hydration before gates that might show "create wallet"

// =================== Pi v2 loader + init (robust, iOS-safe) ===================
let __PI_INIT_DONE = false;

async function ensurePiReady({ sandbox=false } = {}){
  // load helper
  const load = (id, src) => new Promise((res, rej)=>{
    if (document.getElementById(id)) return res(true);
    const s = document.createElement('script');
    s.id=id; s.src=src; s.defer=true;
    s.onload=()=>res(true);
    s.onerror=()=>rej(new Error('load-failed:'+src));
    document.head.appendChild(s);
  });

  // 1) Ensure script is present
  if (!window.Pi){
    const candidates = [
      'https://sdk.minepi.com/pi-sdk.js',
      '/static/pi-sdk.js' // optional fallback
    ];
    for (let i=0; i<candidates.length && !window.Pi; i++){
      try { await load('pi-sdk-'+i, candidates[i]); } catch(_) {}
    }
    const t0 = Date.now();
    while (!window.Pi && Date.now()-t0 < 1500){
      await new Promise(r=>setTimeout(r, 50));
    }
    if (!window.Pi) return false;
  }

  // 2) Init exactly once
  if (!__PI_INIT_DONE){
    try { Pi.init({ version: '2.0', sandbox: !!sandbox }); }
    catch(_) { /* may throw outside Pi Browser; safe to ignore */ }
    __PI_INIT_DONE = true;
  }

  // 3) Wait briefly for methods to attach
  const t1 = Date.now();
  while (Date.now()-t1 < 1500){
    if (typeof Pi.authenticate === 'function') return true;
    await new Promise(r=>setTimeout(r, 50));
  }
  return typeof Pi.authenticate === 'function';
}

// =================== Sign-in using Pi SDK (after ensurePiReady) ===================
async function piSignIn(){
  const ok = await ensurePiReady({ sandbox: false });
  if (!ok) {
    const isPiBrowser = /PiBrowser/i.test(navigator.userAgent || '');
    if (!isPiBrowser) location.href = '/authenticate?dest=wallet';
    throw new Error('pi-sdk-unavailable');
  }
  try{
    const scopes = ['username'];
    const onIncompletePaymentFound = function(_){};
    const auth = await window.Pi.authenticate(scopes, onIncompletePaymentFound);

    // FIXED verify payload (drop-in)
    const resp = await fetch('/api/auth/pi/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',     // << add this
      body: JSON.stringify({
        accessToken: auth.accessToken,
        user: { id: auth.user.uid, uid: auth.user.uid, username: auth.user.username }
      })
    });
    if (!resp.ok) {
      const errText = await resp.text().catch(() => '');
      throw new Error(`verify_failed:${resp.status}${errText ? ' ' + errText : ''}`);
    }

    USER = { uid: auth.user.uid, username: auth.user.username };
    if (USER) window.USER = USER;  // make USER visible to other helpers and UI
    return USER;
  }catch(e){
    log('pi.auth.fail', { err:String(e) });
    throw e;
  }
}
// =================== Fetch/link active wallet ===================
async function fetchActiveWallet(){
  try{
    // Prefer authenticated username; fall back to URL ?u
    const u = (USER && USER.username) || (new URLSearchParams(location.search).get('u')) || '';
    const url = '/api/wallet/active' + (u ? `?u=${encodeURIComponent(u)}` : '');
    const r = await fetch(url, {
      cache: 'no-store',
      credentials: 'include'
    });
    if (!r.ok) return null;
    const j = await r.json();
    ACTIVE_PUB = j && j.pub ? j.pub : null;
    return ACTIVE_PUB;
  }catch{ return null; }
}
async function ensureUserAndWalletGate(){
  // if hydration hasn't finished yet, wait once
  if (!__hydrated) {
    try { await hydrateUserAndWallet(); } catch(_) {}
  }

  // may already be set by hydrate; asking server again is fine (cheap)
  const pub = await fetchActiveWallet();
  if (pub) return; // we have a wallet ‚Äî do NOT open the create flow

  // still nothing: only then nudge user to create
  openModal(placeOrderModal, closePlaceOrderBtn);

  const acct = document.getElementById('acctPub');
  if (acct && !acct.value) acct.value = '';

  // flash create button
  const createBtn = document.getElementById('createWalletBtn');
  if (createBtn){
    createBtn.classList.remove('flash-once');
    void createBtn.offsetWidth;
    createBtn.classList.add('flash-once');
    setTimeout(()=>{ try{ createBtn.focus(); }catch(_){ } }, 150);
  }

  try { await refreshAccountGate(acct?.value); } catch(_){}
}

async function linkActiveWallet(pub){
  const u = (USER && USER.username) || (new URLSearchParams(location.search).get('u')) || '';
  const r = await fetch('/api/wallet/link' + (u ? `?u=${encodeURIComponent(u)}` : ''), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ pub })
  });
  const j = await r.json().catch(()=>null);
  if (!r.ok) throw new Error('link-failed:' + (j?.error || r.status));
  ACTIVE_PUB = pub;
  return j;
}

// =================== Static DOM wiring ===================
const walletBtn = document.getElementById('walletBtn');

async function bootstrapAuthUI(){
  try{
    const pub = await fetchActiveWallet(); // already includes credentials
    if (pub){
      ACTIVE_PUB = pub;
      const acct = document.getElementById('acctPub');
      if (acct) acct.value = pub;
      const hasLocal = !!getLocalSecret(pub);
      setOrderReady(true, hasLocal);
    }
  }catch(_){}
}

// DOM refs used by fetchSummary()
const distBalanceEl = document.getElementById('dist-balance');
const trustCountEl  = document.getElementById('trust-count');
const recentOpsEl   = document.getElementById('recentOps');
// =================== Summary fetch ===================
async function fetchSummary(){
  try{
    // Build the /assets lookup URL (1 record only)
    const assetUrl =
      `${API_BASE}/assets` +
      `?asset_code=${encodeURIComponent(ASSET_CODE)}` +
      `&asset_issuer=${encodeURIComponent(ISSUER)}` +
      `&limit=1`;

    // Distributor account, asset summary, recent ops
    const [acctRes, assetsRes, opsRes] = await Promise.all([
      fetch(`${API_BASE}/accounts/${DISTRIBUTOR}`, { cache:'no-store' }),
      fetch(assetUrl,                             { cache:'no-store' }),
      fetch(`${API_BASE}/accounts/${DISTRIBUTOR}/operations?limit=6&order=desc`, { cache:'no-store' })
    ]);

    const acctJson   = acctRes.ok   ? await acctRes.json()   : null;
    const assetsJson = assetsRes.ok ? await assetsRes.json() : null;
    const opsJson    = opsRes.ok    ? await opsRes.json()    : null;

    // Distributor IZZA balance
    let izzaBal = '0';
    if (acctJson && Array.isArray(acctJson.balances)) {
      const line = acctJson.balances.find(
        b => b.asset_type !== 'native' && b.asset_code === ASSET_CODE && b.asset_issuer === ISSUER
      );
      izzaBal = line ? String(line.balance) : '0';
    }
    distBalanceEl.textContent = izzaBal;

    // Holders / trustlines (from /assets)
    const rec = assetsJson?._embedded?.records?.[0];
    const count =
      rec?.num_accounts ??
      ((rec?.accounts?.authorized ?? 0) +
       (rec?.accounts?.authorized_to_maintain_liabilities ?? 0) +
       (rec?.accounts?.unauthorized ?? 0));

    trustCountEl.textContent = (count ?? 0).toLocaleString();

    // Recent ops
    let opsHtml = '';
    const recs = opsJson && opsJson._embedded ? opsJson._embedded.records : [];
    if (recs && recs.length){
      recs.forEach(op=>{
        const t = op.type || 'operation';
        const when = op.created_at ? new Date(op.created_at).toLocaleString() : '';
        const msg = (op.asset_code ? op.asset_code : (op.asset || 'native')) + (op.to ? ` ‚Üí ${op.to.slice(0,8)}‚Ä¶` : '');
        opsHtml += `<div class="op"><span class="t">${t}</span><div class="m">${msg}</div><div class="m">${when}</div></div>`;
      });
    } else {
      opsHtml = '<div class="m">No recent activity.</div>';
    }
    recentOpsEl.innerHTML = opsHtml;

    // (Nice to have) wire the ‚ÄúRaw data & quick links‚Äù anchors
    try{
      document.getElementById('link-account').href   = `${API_BASE}/accounts/${DISTRIBUTOR}`;
      document.getElementById('link-payments').href  = `${API_BASE}/accounts/${DISTRIBUTOR}/payments?limit=20&order=desc`;
      document.getElementById('link-ops').href       = `${API_BASE}/accounts/${DISTRIBUTOR}/operations?limit=20&order=desc`;
      document.getElementById('link-assets').href    = assetUrl;
    }catch(_){ /* non-fatal */ }

  } catch(e){
    distBalanceEl.textContent = '‚Äî';
    trustCountEl.textContent  = '‚Äî';
    recentOpsEl.textContent   = 'Error loading recent activity';
    log('summary.fail',{err:String(e)});
  }
}
fetchSummary();
bootstrapAuthUI();

// --- Deep link + QR render ---
(function renderDeepAndQR(){
  const deepPre = document.getElementById('deepPre');
  if (deepPre && DEEP_LINK) deepPre.textContent = DEEP_LINK;

  const qr = document.getElementById('qrimg');
  if (!qr) return;

  // Prefer deep link; fall back to "<ASSET_CODE>:<ISSUER>"
  const payload = encodeURIComponent(DEEP_LINK || `${ASSET_CODE}:${ISSUER}`);

  // Simple hosted QR (tiny, works anywhere); graceful fallback to a canvas scribble
  qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${payload}`;
  qr.alt = 'QR';
  qr.onerror = () => {
    try {
      const c = document.createElement('canvas');
      c.width = 120; c.height = 120;
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,120,120);
      ctx.fillStyle = '#000'; ctx.font = '10px monospace';
      (decodeURIComponent(payload).match(/.{1,16}/g)||[]).slice(0,7)
        .forEach((ln,i)=>ctx.fillText(ln,6,16+i*16));
      qr.src = c.toDataURL();
    } catch(_) {}
  };
})();

// =================== Modal wiring (only one open at a time) ===================
const roadmapBtn    = document.getElementById('roadmapBtn');
const badgeOpen     = document.getElementById('badgeOpen');
const modal         = document.getElementById('roadmapModal');
const orderbookBtn  = document.getElementById('orderbookBtn');
const orderbookModal= document.getElementById('orderbookModal');
const closeOrderbookBtn = document.getElementById('closeOrderbookBtn');
const placeOrderModal   = document.getElementById('placeOrderModal');
const myWalletModal     = document.getElementById('myWalletModal');
const closeMyWalletBtn  = document.getElementById('closeMyWalletBtn');
const orderBtn          = document.getElementById('orderBtn');
const closePlaceOrderBtn= document.getElementById('closePlaceOrderBtn');
const backdrop      = document.getElementById('modalBackdrop');

const closeModalBtn = document.getElementById('closeModalBtn');
let lastFocus = null;

// My Wallet modal (Actions)
const revealOnceBtn = document.getElementById('revealOnceBtn');
const secretOnce    = document.getElementById('secretOnce');
  // NFTs modal
const openMyNftsBtn  = document.getElementById('openMyNftsBtn');
const myNftsModal    = document.getElementById('myNftsModal');
const closeMyNftsBtn = document.getElementById('closeMyNftsBtn');
const nftPubEcho     = document.getElementById('nftPubEcho');
const nftListEl      = document.getElementById('nftList');
const nftMsg         = document.getElementById('nftMsg');

// ======== STAKING CONSTANTS / REFS ========
const stakeModal    = document.getElementById('stakeModal');
const claimModal    = document.getElementById('claimModal');
const closeStakeBtn = document.getElementById('closeStakeBtn');
const closeClaimBtn = document.getElementById('closeClaimBtn');
const openStakeBtn  = document.getElementById('openStakeBtn');   // optional internal button
const openClaimBtn  = document.getElementById('openClaimBtn');   // optional internal button
const stakeQuickBtn = document.getElementById('stakeQuickBtn');  // your top-cta buttons
const claimQuickBtn = document.getElementById('claimQuickBtn');

const stakePub     = document.getElementById('stakePub');
const stakeAmt     = document.getElementById('stakeAmt');
const stakeDays    = document.getElementById('stakeDays');
const stakePreview = document.getElementById('stakePreviewBtn');
const stakeStart   = document.getElementById('stakeStartBtn');
const stakeMsg     = document.getElementById('stakeMsg');
// Cap days at [1..180] and show a hint if we clamp
const stakeDaysMsg = document.getElementById('stakeDaysMsg');

function clampStakeDays(v){
  const n = parseInt(v || 0, 10);
  const d = Math.max(1, Math.min(180, n));
  if (stakeDaysMsg){
    if (n !== d){
      stakeDaysMsg.textContent = 'Capped at 180 days.';
      stakeDaysMsg.style.color = '#ffcd60';
    } else {
      stakeDaysMsg.textContent = 'Max 180 days.';
      stakeDaysMsg.style.color = '';
    }
  }
  return d;
}

stakeDays?.addEventListener('input', ()=>{
  stakeDays.value = clampStakeDays(stakeDays.value);
});

const stakePreviewBox = document.getElementById('stakePreviewBox');
const stakeAPR     = document.getElementById('stakeAPR');
const stakeReward  = document.getElementById('stakeReward');
const stakeUnlock  = document.getElementById('stakeUnlock');

const claimPub       = document.getElementById('claimPub');
const claimRefresh   = document.getElementById('claimRefreshBtn');
const claimSelected  = document.getElementById('claimSelectedBtn');
const claimTblBody   = document.querySelector('#claimTbl tbody');
const claimMsg       = document.getElementById('claimMsg');

function fmtNum(n, dp=7){ const x=Number(n); return isFinite(x)?x.toLocaleString(undefined,{minimumFractionDigits:dp,maximumFractionDigits:dp}):'‚Äî'; }
function toUTC(ts){ try{ return new Date(ts*1000).toISOString().replace('T',' ').replace('Z',' UTC'); }catch{ return '‚Äî'; } }

// ======== OPEN/CLOSE ========
openStakeBtn?.addEventListener('click', ()=>{
  stakePub.value = (ACTIVE_PUB || document.getElementById('acctPub')?.value || '');
  stakeMsg.textContent = '';
  stakePreviewBox.style.display = 'none';
  stakeStart.disabled = true;
  log('ui.stake.open', { pub: stakePub.value ? 'G‚Ä¶' : 'empty' });
  openModal(stakeModal, closeStakeBtn);
});
openClaimBtn?.addEventListener('click', ()=>{
  claimPub.value = (ACTIVE_PUB || document.getElementById('acctPub')?.value || '');
  claimMsg.textContent = '';
  claimTblBody.innerHTML = '';
  claimSelected.disabled = true;
  log('ui.claim.open', { pub: claimPub.value ? 'G‚Ä¶' : 'empty' });
  openModal(claimModal, closeClaimBtn);
  listClaimables();
});
// optional quick buttons near top
stakeQuickBtn?.addEventListener('click', ()=> openStakeBtn?.click());
claimQuickBtn?.addEventListener('click', ()=> openClaimBtn?.click());

closeStakeBtn?.addEventListener('click', ()=> { log('ui.stake.close'); closeModal(stakeModal); });
closeClaimBtn?.addEventListener('click', ()=> { log('ui.claim.close'); closeModal(claimModal); });

// ======== PREVIEW ========
stakePreview?.addEventListener('click', async ()=>{
  const pub = (stakePub.value||'').trim();
  const amt = Number(stakeAmt.value||'0');
  const days = clampStakeDays(stakeDays.value);
  if (!pub.startsWith('G')){ stakeMsg.textContent='Enter a valid G‚Ä¶ public key.'; return; }
  if (!(amt>0) || !(days>0)){ stakeMsg.textContent='Enter a positive amount and lock length.'; return; }

  stakeMsg.textContent = 'Calculating‚Ä¶';
  try{
    const r = await fetch('/api/stake/preview', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ amount: String(amt), lock_days: days })
    });
    const j = await r.json();
    if (!r.ok || !j?.ok) throw new Error(j?.error || 'preview failed');
    stakeAPR.textContent    = `${Number(j.apr).toFixed(2)}%`;
    stakeReward.textContent = `${fmtNum(j.reward,7)} IZZA`;
    stakeUnlock.textContent = toUTC(j.unlock_unix);
    stakePreviewBox.style.display = '';
    stakeStart.disabled = false;
    stakeMsg.textContent = '';
    log('stake.preview.ok', { amt, days, apr: j.apr, reward: j.reward });
  }catch(e){
    stakeMsg.textContent = '‚ùå ' + String(e);
    log('stake.preview.fail', { err: String(e) });
  }
});

// ======== START STAKE (build XDR, then local sign or SEP-7) ========
stakeStart?.addEventListener('click', async ()=>{
  const pub = (stakePub.value||'').trim();
  const amt = Number(stakeAmt.value||'0');
  const days = clampStakeDays(stakeDays.value);
  if (!pub.startsWith('G') || !(amt>0) || !(days>0)){ return; }

  stakeMsg.textContent = 'Preparing staking transaction‚Ä¶';
  try{
    const r = await fetch('/api/stake/build', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ pub, amount: String(amt), lock_days: days })
    });
    const j = await r.json();
    if (!r.ok || !j?.ok) throw new Error(j?.error || 'build failed');

    const xdr = j.xdr;
    const pass = j.network_passphrase || 'Pi Testnet';

    // If we have the local secret for this pub, sign+submit directly
    const localSec = getLocalSecret(pub, USER?.username);
    if (localSec){
      const ok = await ensureStellar();
      if (!ok || !window.StellarSdk){ stakeMsg.textContent = '‚ùå Stellar SDK missing.'; return; }
      const SDK = window.StellarSdk;
      const tx  = SDK.TransactionBuilder.fromXDR(xdr, pass);
      tx.sign(SDK.Keypair.fromSecret(localSec));
      const server = getServer();
      try{
        const resp = await server.submitTransaction(tx);
        if (resp?.hash){
          stakeMsg.innerHTML = `‚úÖ Staked. Tx: <code>${resp.hash}</code>`;
          log('stake.submit.ok', { hash: resp.hash });
        } else {
          stakeMsg.textContent = 'Submitted; awaiting confirmation.';
          log('stake.submit.queued');
        }
      }catch(e){
        const rc = e?.response?.data?.extras?.result_codes;
        stakeMsg.textContent = `‚ùå submit failed: ${rc ? JSON.stringify(rc) : String(e)}`;
        log('stake.submit.fail', { err: String(e), rc });
      }
    } else {
      // Fallback to SEP-7 (external wallet signs alongside distributor)
      const uri = `web+stellar:tx?xdr=${encodeURIComponent(xdr)}&network_passphrase=${encodeURIComponent(pass)}`;
      window.location.href = uri;
      stakeMsg.innerHTML = `Opening your wallet to sign‚Ä¶ If nothing happens, copy this URI:<br><code style="word-break:break-all">${uri}</code>`;
      log('stake.sep7.opened');
    }
  }catch(e){
    stakeMsg.textContent = '‚ùå ' + String(e);
    log('stake.build.fail', { err: String(e) });
  }
});

// --- Vote modal refs
const voteModal    = document.getElementById('voteModal');
const closeVoteBtn = document.getElementById('closeVoteBtn');
const voteQuickBtn = document.getElementById('voteQuickBtn');

const votePub   = document.getElementById('votePub');
const voteDays  = document.getElementById('voteDays'); // hidden/removed visually
const voteGame  = document.getElementById('voteGame');
const voteAmt   = document.getElementById('voteAmt');
// üî• Hide "Lock Days" visually in the Vote modal ‚Äî everything else stays intact
document.getElementById('voteDays')?.closest('.row, .field')?.remove();

const votePreviewBtn  = document.getElementById('votePreviewBtn');
const voteStartBtn    = document.getElementById('voteStartBtn');
const voteMsg         = document.getElementById('voteMsg');
const votePreviewBox  = document.getElementById('votePreviewBox');
const voteAPR         = document.getElementById('voteAPR');
const voteVotes       = document.getElementById('voteVotes');
const voteUnlock      = document.getElementById('voteUnlock');

// Open/close
voteQuickBtn?.addEventListener('click', async ()=>{
  votePub.value = (ACTIVE_PUB || document.getElementById('acctPub')?.value || '');
  voteMsg.textContent = '';
  votePreviewBox.style.display = 'none';
  voteStartBtn.disabled = true;
  await loadVoteProposals();
  openModal(voteModal, closeVoteBtn);
  log('ui.vote.open');
});
closeVoteBtn?.addEventListener('click', ()=> { log('ui.vote.close'); closeModal(voteModal); });

// Fetch proposals (title + id/slug) from your API
async function loadVoteProposals(){
  try{
    const r = await fetch('/api/arcade/proposals', { cache:'no-store' });
    const j = await r.json();
    const items = Array.isArray(j?.proposals) ? j.proposals : [];
    voteGame.innerHTML = items.length
      ? items.map(p=>`<option value="${p.id || p.slug}">${p.title}</option>`).join('')
      : `<option disabled selected>No active proposals</option>`;
    log('vote.proposals.ok', { count: items.length });
  }catch(e){
    voteGame.innerHTML = `<option disabled selected>Couldn‚Äôt load proposals</option>`;
    log('vote.proposals.fail', { err: String(e) });
  }
}

// Safe label swap
(() => {
  const lbl = document.querySelector('#voteAPR')
              ?.closest('.row')
              ?.querySelector('.label');
  if (lbl) lbl.textContent = 'Your share if this game wins';
})();

async function getVoteRules(){
  const r = await fetch('/api/vote/rules', { cache:'no-store' });
  const j = await r.json();
  // Expect shape: { round_end_unix: <number seconds>, pool_before?, ad_pool_pct? }
  // If your backend returns ISO, normalize here:
  if (!j.round_end_unix && j.round_end_iso){
    j.round_end_unix = Math.floor(new Date(j.round_end_iso).getTime() / 1000);
  }
  return j;
}

  // Preview (vote) ‚Äî 404-safe + Safari-safe time handling
votePreviewBtn?.addEventListener('click', async ()=>{
  const pub  = (votePub.value||'').trim();
  const raw  = String(voteAmt.value||'0').trim();
  const amt  = Number(raw.replace(/[^0-9.]/g,''));
  const proposal = voteGame.value;
  if (!pub.startsWith('G')){ voteMsg.textContent='Enter a valid G‚Ä¶ public key.'; return; }
  if (!(amt>0)){ voteMsg.textContent='Enter a positive amount.'; return; }
  if (!proposal){ voteMsg.textContent='Pick a proposal.'; return; }

  voteMsg.textContent = 'Calculating‚Ä¶';
  try{
    // Try server preview first
    let j = null, ok = false;
    try{
      const r = await fetch('/api/vote/preview', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ proposal, amount: String(Math.floor(amt*1e7)/1e7) })
      });
      ok = r.ok;
      if (ok) j = await r.json();
      if (r.status === 404) ok = false; // allow fallback
    }catch(_){ ok = false; }

    // Fallback to rules if preview route is missing on this deploy
    if (!ok){
      const rules = await getVoteRules();           // <= helper below
      j = j || {};
      j.ok = true;
      j.round_end_unix = Number(rules.round_end_unix);    // seconds
      j.pool_before    = Number(rules.pool_before || 0);  // optional
      j.ad_pool_pct    = Number(rules.ad_pool_pct || 0);  // optional
      j.your_share_pct_if_wins = 0; // we can‚Äôt know without server math; keep UI consistent
    }

    // Normalize timestamps (seconds ‚Üí ms) for iOS/Safari
    const endSec = Number(j.round_end_unix || 0);
    const endMs  = endSec * 1000;
    const endIso = isFinite(endMs) && endMs > 0
      ? new Date(endMs).toISOString().replace('T',' ').replace('Z',' UTC')
      : '‚Äî';

    // Render
    const pct = Number(j.your_share_pct_if_wins);
    voteAPR.textContent    = isFinite(pct) ? `${pct.toFixed(2)}%` : '‚Äî';
    voteVotes.textContent  = amt.toLocaleString(undefined,{maximumFractionDigits:7});
    voteUnlock.textContent = endIso;

    const helper = document.getElementById('voteShareHelp');
    if (helper){
      const pool = Number(j.pool_before);
      const adP  = Number(j.ad_pool_pct);
      helper.textContent =
        `Assumes current pool ${isFinite(pool)?pool.toLocaleString():'‚Äî'} votes. ` +
        `${isFinite(adP)?adP.toFixed(0):'‚Äî'}% of ad revenue goes to voters of the winning game.`;
    }

    votePreviewBox.style.display = '';
    voteStartBtn.disabled = false;
    voteMsg.textContent = '';
    log('vote.preview.ok', { proposal, amt, fallback: !ok });
  }catch(e){
    voteMsg.textContent = '‚ùå ' + String(e);
    log('vote.preview.fail', { err: String(e) });
  }
});

// Start vote-stake (build + sign/submit same as regular)
voteStartBtn?.addEventListener('click', async ()=>{
  const pub  = (votePub.value||'').trim();
  const amt  = Number(String(voteAmt.value||'0').replace(/[^0-9.]/g,''));
  const proposal = voteGame.value;
  if (!pub.startsWith('G') || !(amt>0) || !proposal){ return; }

  voteMsg.textContent = 'Preparing vote-stake transaction‚Ä¶';
  try{
    const r = await fetch('/api/vote/stake', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ pub, amount: String(Math.floor(amt*1e7)/1e7), proposal })
    });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok || !j?.ok) throw new Error(j?.error || j?.message || `HTTP ${r.status}`);

    const xdr  = j.xdr;
    const pass = j.network_passphrase || 'Pi Testnet';

    // Prefer wallet signing unless we KNOW we have a matching local secret
    const localSec = getLocalSecret(pub, USER?.username);
    if (localSec) {
      const ok = await ensureStellar();
      if (!ok || !window.StellarSdk){ voteMsg.textContent='‚ùå Stellar SDK missing.'; return; }
      const SDK = window.StellarSdk;
      const tx  = SDK.TransactionBuilder.fromXDR(xdr, pass);
      tx.sign(SDK.Keypair.fromSecret(localSec));
      const server = getServer();
      try{
        const resp = await server.submitTransaction(tx);
        voteMsg.innerHTML = resp?.hash ? `‚úÖ Votes staked. Tx: <code>${resp.hash}</code>` : 'Submitted.';
        log('vote.submit.ok', { hash: resp?.hash || null });
      }catch(e){
        const rc = e?.response?.data?.extras?.result_codes;
        voteMsg.textContent = `‚ùå submit failed: ${JSON.stringify(rc) || String(e)}`;
        log('vote.submit.fail', { err: String(e), rc });
      }
    } else {
      const uri = `web+stellar:tx?xdr=${encodeURIComponent(xdr)}&network_passphrase=${encodeURIComponent(pass)}`;
      window.location.href = uri;
      voteMsg.innerHTML = `Opening wallet to sign‚Ä¶<br><small>If nothing opens, copy this into your wallet:</small><br><code style="word-break:break-all">${uri}</code>`;
      log('vote.sep7.opened');
    }
  }catch(e){
    voteMsg.textContent = '‚ùå ' + String(e);
    log('vote.build.fail', { err: String(e) });
  }
});

// ======== LIST CLAIMABLES (grouped: one toggle, principal+reward in one box) ========
async function listClaimables(){
  const pub = (claimPub.value||'').trim();
  if (!pub.startsWith('G')){ claimMsg.textContent='Enter a valid G‚Ä¶ public key.'; return; }
  claimMsg.textContent = 'Loading‚Ä¶';
  claimTblBody.innerHTML = '';

  try{
    const uname = (window.USER && USER.username) ? USER.username : (new URLSearchParams(location.search).get('u') || '');
    const r = await fetch(
      `/api/stake/claimables?pub=${encodeURIComponent(pub)}${uname ? `&u=${encodeURIComponent(uname)}` : ''}`,
      { cache:'no-store' }
    );
    const j = await r.json();
    if (!r.ok || !j?.ok) throw new Error(j?.error || 'fetch failed');

    const rows = Array.isArray(j.claimables) ? j.claimables : (j.records||[]);
    if (!rows.length){
      claimTblBody.innerHTML = `<tr><td colspan="4" class="help" style="padding:8px">No claimable balances.</td></tr>`;
      claimSelected.disabled = true;
      claimMsg.textContent = '';
      log('claimables.none');
      return;
    }

    // NEW: split staking vs NFTs
    const stakeRows = [];
    const nftRows   = [];
    for (const row of rows){
      const k = String(row.kind||'').toLowerCase();
      if (k === 'nft') nftRows.push(row); else stakeRows.push(row);
    }

    // ================= STAKING (unchanged: normal + vote) =================
    const groups = {};
    for (const r of stakeRows){
      const unlockTs = Number(r.unlock_ts || r.unlock_unix || 0);
      const kindStr  = (r.kind || r.bucket || r.pool || '').toString().toLowerCase().includes('vote') ? 'vote' : 'regular';

      const gid =
        r.contract_id || r.stake_id || r.group_id || r.parent_id || r.batch_id ||
        [
          unlockTs || 0,
          kindStr,
          (r.tx || r.tx_hash || r.source || r.created_at || r.id || '').toString().slice(-12)
        ].join('|');

      (groups[gid] ||= []).push({ ...r, __unlockTs: unlockTs, __kind: kindStr });
    }

    const ordered = Object.entries(groups).sort((a,b)=>{
      const au = a[1][0].__unlockTs || Number.MAX_SAFE_INTEGER;
      const bu = b[1][0].__unlockTs || Number.MAX_SAFE_INTEGER;
      return au - bu;
    });

    const PROPOSAL_NAMES = { rooftop_rumble: 'Rooftop Rumble', pizza_panic: 'Pizza Panic' };
    const prettyProposal = id => PROPOSAL_NAMES[id] || id || 'Vote';

    for (const [, recs] of ordered){
      const any       = recs[0];
      const unlockTs  = any.__unlockTs || 0;
      const unlockStr = unlockTs ? new Date(unlockTs*1000).toISOString().slice(0,10) : '‚Äî';
      const kind      = any.__kind === 'vote' ? 'vote' : 'regular';
      const pillClass = kind === 'vote' ? 'pill-vote' : 'pill-regular';
      const unlocked  = unlockTs ? (Date.now() >= unlockTs*1000) : true;

      const ids = [];
      let principal = 0, reward = 0;
      for (const r of recs){
        if (Array.isArray(r.ids) && r.ids.length){
          ids.push(...r.ids.map(x => String(x).trim()));
        } else {
          const id =
            r.id ||
            r.claimable_balance_id ||
            r.balance_id ||
            r.cb_id ||
            (r.balance && r.balance.id) ||
            null;
          if (id) ids.push(String(id).trim());
        }
        const role = (r.role || r.kind || '').toString().toLowerCase();
        if (role.includes('reward')) reward += Number(r.amount||0);
        else                         principal += Number(r.amount||0);
      }

      const trHead = document.createElement('tr');
      trHead.className = `group-head is-${kind}` + (unlocked ? '' : ' locked');

      const voteLabel = (kind === 'vote' && any?.proposal)
        ? `VOTE ‚Ä¢ ${prettyProposal(any.proposal)}`
        : (kind === 'vote' ? 'VOTE' : 'NORMAL');

      const csv = ids.map(x => x.trim()).filter(Boolean).join(',');

      trHead.innerHTML = `
        <td colspan="4">
          <label class="group-toggle" style="display:flex;align-items:center;gap:10px;white-space:nowrap;">
            <input
              type="checkbox"
              class="cbPick"
              value="${csv}"
              data-balance-ids="${csv}"
              ${unlocked ? '' : 'disabled'}>
            <span class="pill ${pillClass}">${voteLabel}</span>
            <strong>Stake ‚Ä¢ unlock ${unlockStr}</strong>
          </label>
        </td>`;
      claimTblBody.appendChild(trHead);

      const trBlock = document.createElement('tr');
      trBlock.className = `group-row is-${kind}` + (unlocked ? '' : ' locked');

      const estPct = (kind === 'vote') ? Number(any?.vote_est_share_pct) : null;
      const rewardHTML = (kind === 'vote')
        ? `<div class="line" style="display:flex;justify-content:space-between;align-items:center;white-space:nowrap;">
             <span class="pill pill-vote" aria-hidden="true">EST. SHARE</span>
             <span class="num">${isFinite(estPct) ? estPct.toFixed(2) : '0.00'}%</span>
           </div>`
        : (reward > 0
           ? `<div class="line" style="display:flex;justify-content:space-between;align-items:center;">
                <span class="pill pill-reward" aria-hidden="true">REWARD</span>
                <span class="num">${fmtNum(reward)}</span>
              </div>`
           : '');

      trBlock.innerHTML = `
        <td colspan="4">
          <div class="block" style="display:flex;flex-direction:column;gap:8px;">
            <div class="line" style="display:flex;justify-content:space-between;align-items:center;white-space:nowrap;">
              <span class="pill ${pillClass}" aria-hidden="true">PRINCIPAL</span>
              <span class="num">${fmtNum(principal)}</span>
            </div>
            ${rewardHTML}
            ${unlocked ? '' : `<span class="lockhint">Locked until ${unlockStr}</span>`}
          </div>
        </td>`;
      claimTblBody.appendChild(trBlock);
    }

    // ================= NFTs (turquoise block WITH checkboxes) =================
    // We allow multiple NFT groups (by issuer). Each checkbox carries issuer + assets payload.
    for (const r of nftRows){
      const issuer = String(r.issuer || r.issuer_g || '').trim();
      const assets = Array.isArray(r.assets) ? r.assets.map(a => String(a).trim()).filter(Boolean) : [];
      const codes  = assets.join(', ');
      if (!issuer || !assets.length) continue;

      const trHead = document.createElement('tr');
      trHead.className = `group-head is-nft`;
      trHead.innerHTML = `
        <td colspan="4">
          <label class="group-toggle" style="display:flex;align-items:center;gap:10px;white-space:nowrap;">
            <input
              type="checkbox"
              class="cbPickNft"
              data-issuer="${issuer}"
              data-assets="${assets.join(',')}"
            >
            <span class="pill pill-nft">NFT</span>
            <strong>Purchased NFTs ‚Ä¢ ready to deliver</strong>
          </label>
        </td>`;
      claimTblBody.appendChild(trHead);

      const trBody = document.createElement('tr');
      trBody.className = `group-row is-nft`;
      trBody.innerHTML = `
        <td colspan="4">
          <div class="block" style="display:flex;flex-direction:column;gap:8px;">
            <div class="line" style="display:flex;justify-content:space-between;align-items:center;white-space:nowrap;">
              <span>Assets</span>
              <span class="num" style="text-align:right">${codes || '‚Äî'}</span>
            </div>
            <span class="lockhint">Checked NFTs will be issued to your wallet.</span>
          </div>
        </td>`;
      claimTblBody.appendChild(trBody);
    }

    // enable batch-claim button only if something selectable exists
    const anyConcrete = !!document.querySelector('.cbPick, .cbPickNft');
    claimSelected.disabled = !anyConcrete;
    claimMsg.textContent = '';
    log('claimables.rendered');
  }catch(e){
    claimMsg.textContent = '‚ùå ' + String(e);
    log('claimables.fail', { err: String(e) });
  }
}

claimRefresh?.addEventListener('click', ()=>{
  log('claimables.refresh.click');
  listClaimables();
});

// ======== CLAIM SELECTED (batch) ‚Äî stake claimables + NFT claims ========
claimSelected?.addEventListener('click', async ()=>{
  const pub = (claimPub.value||'').trim();
  if (!pub.startsWith('G')) { claimMsg.textContent = 'Enter a valid G‚Ä¶ public key.'; return; }

  // Expand group selections like "id1,id2" into individual ids (staking)
  const rawPicks = Array.from(document.querySelectorAll('.cbPick:checked'))
    .map(x => (x.dataset.balanceIds || x.value || '').trim());

  const picks = rawPicks.flatMap(v => v.split(',')).map(s => s.trim()).filter(Boolean);

  // Collect NFT selections
  const nftPicks = Array.from(document.querySelectorAll('.cbPickNft:checked')).map(el => ({
    issuer: (el.dataset.issuer || '').trim(),
    assets: (el.dataset.assets || '').split(',').map(a => a.trim()).filter(Boolean)
  })).filter(x => x.issuer && x.assets.length);

  if (!picks.length && !nftPicks.length){
    claimMsg.textContent='Pick at least one balance or NFT.';
    log('claim.none');
    return;
  }

  // --- Part A: staking claimables via /api/stake/claim (normalize ids first)
  const HEX64 = /^[0-9a-fA-F]{64}$/;
  const HEX72 = /^[0-9a-fA-F]{72}$/;       // some sources prepend 8-hex discriminant
  function normalizeBalanceId(id){
    const s = String(id||'').replace(/^0x/i,'').trim();
    if (HEX64.test(s)) return s.toLowerCase();           // already 64
    if (HEX72.test(s)) return s.slice(8).toLowerCase();  // drop first 8 hex ‚Üí 64
    return null;
  }
  const normalized = Array.from(new Set(picks.map(normalizeBalanceId).filter(Boolean)));

  // Build a status log
  const ops = [];
  if (normalized.length) ops.push(`claimables:${normalized.length}`);
  if (nftPicks.length)   ops.push(`nft_groups:${nftPicks.length}`);
  claimMsg.textContent = `Building claim (${ops.join(' + ')})‚Ä¶`;
  log('claim.build.start', { n_ids: normalized.length, n_nft: nftPicks.length });

  try{
    // 1) Submit staking claim if any
    if (normalized.length){
      const r = await fetch('/api/stake/claim', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ pub, ids: normalized })
      });
      let j = {};
      try { j = await r.json(); } catch {}
      if (!r.ok || !j?.ok){
        const msg = j?.error || j?.message || `HTTP ${r.status}`;
        claimMsg.textContent = `‚ùå Claimables error: ${msg}`;
        log('claim.build.fail', { msg, status: r.status });
        return;
      }

      const xdr  = j.xdr;
      const pass = j.network_passphrase || 'Pi Testnet';

      // Prefer local-sign if we have the secret
      const localSec = getLocalSecret(pub, USER?.username);
      if (localSec){
        const ok = await ensureStellar();
        if (!ok || !window.StellarSdk){ claimMsg.textContent='‚ùå Stellar SDK missing.'; return; }
        const SDK = window.StellarSdk;
        const tx  = SDK.TransactionBuilder.fromXDR(xdr, pass);
        tx.sign(SDK.Keypair.fromSecret(localSec));
        const server = getServer();
        try{
          const resp = await server.submitTransaction(tx);
          if (!resp?.hash) throw new Error('submit queued/no hash');
          log('claim.submit.ok', { hash: resp.hash });
        }catch(e){
          const rc = e?.response?.data?.extras?.result_codes;
          claimMsg.textContent = `‚ùå submit failed: ${rc ? JSON.stringify(rc) : String(e)}`;
          log('claim.submit.fail', { err: String(e), rc });
          return;
        }
      }else{
        // Fallback: open in wallet (SEP-7) to sign the staking claimables
        const uri = `web+stellar:tx?xdr=${encodeURIComponent(xdr)}&network_passphrase=${encodeURIComponent(pass)}`;
        try{
          window.location.assign(uri);
          claimMsg.innerHTML = `Opening your wallet to sign claimables‚Ä¶<br><small>If nothing happens, tap the link:</small> <a href="${uri}" style="word-break:break-all">Open in wallet</a>`;
          log('claim.sep7.opened');
          return; // stop here; user will come back and hit Refresh
        }catch{
          claimMsg.innerHTML =
            `Couldn‚Äôt open a wallet from this browser.<br><small>Copy this into your wallet:</small><br>` +
            `<code id="claimDeepLink" style="word-break:break-all">${uri}</code><br>` +
            `<button id="copyDeepLinkBtn" class="btn sm">Copy link</button>`;
          document.getElementById('copyDeepLinkBtn')?.addEventListener('click', async ()=>{
            try{ await navigator.clipboard.writeText(uri); claimMsg.innerHTML += '<br>‚úÖ Copied.'; }
            catch{ claimMsg.innerHTML += '<br>Copy failed ‚Äî long-press to select.'; }
          });
          log('claim.sep7.copy_shown');
          return;
        }
      }
    }

    // 2) Issue any selected NFTs to the same wallet
if (nftPicks.length){
  // Best effort: ensure SDK is around before any work begins
  try { await ensureStellar(); } catch(_){}

  for (const pick of nftPicks){
    let SDK = window.StellarSdk;

    // ---------- 1) Load balances to see which NFT trustlines are missing ----------
    let balances = [], acctJson = null;
    try{
      if (SDK && SDK.Server){
        const server  = getServer();
        const account = await server.loadAccount(pub);
        balances = account?.balances || [];
      } else {
        const HZ = (window.HORIZON_URL || 'https://api.testnet.minepi.com');
        const r  = await fetch(`${HZ}/accounts/${encodeURIComponent(pub)}`);
        acctJson = await r.json();
        if (!r.ok || !acctJson?.account_id) throw new Error('Could not load account via Horizon');
        balances = acctJson.balances || [];
      }
    }catch(e){
      claimMsg.textContent = '‚ùå Could not load account: ' + String(e?.message || e);
      log('nft.trust.account_load_fail', { err: String(e) });
      return;
    }

    const needed = (pick.assets || [])
      .map(code => ({ code, issuer: pick.issuer }))
      .filter(a => !hasTrustFor(balances, a.code, a.issuer));

    // ---------- 2) Add any missing trustlines (pre-claim) ----------
    if (needed.length){
      const localSec = getLocalSecret(pub, USER?.username);

      // Always prefer direct signing if we have a local secret.
      if (localSec){
        try{
          // Ensure SDK; if it isn't available, try to load it once.
          const ok = await ensureStellar();
          SDK = window.StellarSdk;

          if (!(ok && SDK)){
            // true fallback only when we cannot load SDK at all
            const uri = await buildChangeTrustMultiSEP7(pub, needed);
            if (uri){
              log('nft.trust.sep7.open.nosdk', { n: needed.length });
              claimMsg.innerHTML = 'Opening your wallet to add NFT trustlines‚Ä¶<br><small>If nothing happens, tap:</small> <a href="'+uri+'" style="word-break:break-all">Open in wallet</a>';
              window.location.assign(uri);
              return;
            }
            throw new Error('Stellar SDK unavailable and no SEP-7 URI could be built');
          }

          // Direct sign via SDK (no SDK.Account fallback paths)
          const server  = getServer();
          const account = await server.loadAccount(pub);

          let fee = (await server.fetchBaseFee()).toString();
          let txb = new SDK.TransactionBuilder(account, { fee, networkPassphrase: NETWORK_PASSPHRASE });
          for (const a of needed){
            txb = txb.addOperation(SDK.Operation.changeTrust({ asset: new SDK.Asset(a.code, a.issuer) }));
          }
          const tx = txb.setTimeout(180).build();
          tx.sign(SDK.Keypair.fromSecret(localSec));

          const resp = await server.submitTransaction(tx);
          if (!resp?.hash) throw new Error('submit queued/no hash');
          log('nft.trust.submit', { via: 'sdk', hash: resp.hash, n: needed.length });

          // Wait for Horizon to expose the new balances to avoid races
          const okWait = await waitForTrust(pub, needed, { maxMs: 20000, stepMs: 700 });
          if (!okWait){
            log('nft.trust.wait.timeout', { n: needed.length });
            claimMsg.textContent = '‚è≥ Added NFT trustlines. Please press Claim again in a few seconds.';
            return;
          }
          log('nft.trust.direct.ok', { n: needed.length });

        }catch(e){
          // Do NOT silently switch to SEP-7 here; we prefer local signing.
          log('nft.trust.direct.fail', { err: String(e) });
          claimMsg.textContent = '‚ùå Trustline setup failed (direct): ' + String(e?.message || e);
          return;
        }
      } else {
        // No local secret ‚Üí SEP-7 is appropriate.
        try{
          const uri = await buildChangeTrustMultiSEP7(pub, needed);
          if (!uri) throw new Error('Could not build SEP-7 for trustlines');
          log('nft.trust.sep7.open', { n: needed.length });
          claimMsg.innerHTML = 'Opening your wallet to add NFT trustlines‚Ä¶<br>' +
            '<small>If nothing happens, tap this link:</small> ' +
            '<a href="'+uri+'" style="word-break:break-all">Open in wallet</a>' +
            '<br><small>After approval, return and press <b>Claim</b> again.</small>';
          window.location.assign(uri);
          return;
        }catch(e){
          claimMsg.textContent = '‚ùå Could not open wallet for trustlines: ' + String(e?.message || e);
          log('nft.trust.sep7.fail', { err: String(e) });
          return;
        }
      }
    }

    // ---------- 3) Perform the NFT claim (single canonical schema) ----------
    const u = (USER?.username || '');
    const claimUrl = u ? `/api/nft/claim?u=${encodeURIComponent(u)}` : '/api/nft/claim';

    const bodyShape = {
      buyer_pub: pub,
      to_pub: pub,
      assets: pick.assets,     // e.g. ["NFTTVPPP1"]
      issuer: pick.issuer,     // e.g. "GDDFUCFI..."
      as_claimable: true
    };

    const tryClaim = async () => {
      const r = await fetch(claimUrl, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(bodyShape)
      });
      const text = await r.text().catch(()=> '');
      let j = {};
      try { j = JSON.parse(text); } catch { j = { error: text }; }
      return { r, j, raw: text };
    };

    let { r: r2, j: j2, raw: raw1 } = await tryClaim();

    // ---------- 4) If backend says buyer_missing_trustline, add it via direct signing (not SEP-7) and retry once ----------
    if ((!r2.ok || !j2?.ok) && /buyer_missing_trustline/i.test(raw1||'')){
      const m = (raw1||'').match(/buyer_missing_trustline:([A-Z0-9]{1,12})/i);
      const missingCodes = m ? [m[1]] : pick.assets.slice(0);
      const missAssets = missingCodes.map(code => ({ code, issuer: pick.issuer }));

      const localSec = getLocalSecret(pub, USER?.username);
      if (localSec){
        try{
          const ok = await ensureStellar();
          SDK = window.StellarSdk;
          if (!(ok && SDK)) throw new Error('Stellar SDK unavailable to fix missing trustline');

          const server  = getServer();
          const account = await server.loadAccount(pub);
          let fee = (await server.fetchBaseFee()).toString();

          let txb = new SDK.TransactionBuilder(account, { fee, networkPassphrase: NETWORK_PASSPHRASE });
          for (const a of missAssets){
            txb = txb.addOperation(SDK.Operation.changeTrust({ asset: new SDK.Asset(a.code, a.issuer) }));
          }
          const tx = txb.setTimeout(180).build();
          tx.sign(SDK.Keypair.fromSecret(localSec));
          await server.submitTransaction(tx);

          await waitForTrust(pub, missAssets, { maxMs: 20000, stepMs: 700 });

          // retry once
          ({ r: r2, j: j2 } = await tryClaim());
        }catch(e){
          log('nft.trust.fix_after_claim.fail', { err: String(e) });
          claimMsg.textContent = '‚ùå Could not add missing NFT trustline (direct): ' + String(e?.message || e);
          return;
        }
      } else {
        // No local secret ‚Üí inform user to open wallet; we do not auto-switch for local-secret flows.
        try{
          const uri = await buildChangeTrustMultiSEP7(pub, missAssets);
          if (uri){
            log('nft.trust.sep7.open.afterFail', { n: missAssets.length });
            claimMsg.innerHTML = 'We need to add an NFT trustline before claiming. Opening your wallet‚Ä¶<br>' +
              '<small>If nothing happens, tap:</small> ' +
              '<a href="'+uri+'" style="word-break:break-all">Open in wallet</a>';
            window.location.assign(uri);
            return;
          }
          throw new Error('Could not build SEP-7 URI for missing trustline');
        }catch(e){
          claimMsg.textContent = '‚ùå Missing trustline and no wallet link: ' + String(e?.message || e);
          return;
        }
      }
    }

    if (!r2.ok || !j2?.ok){
      const msg = j2?.error || j2?.message || `HTTP ${r2.status}`;
      claimMsg.textContent = `‚ùå NFT claim error: ${msg}`;
      log('nft.claim.fail', { issuer: pick.issuer, assets: pick.assets, msg });
      return;
    }

    log('nft.claim.ok', { issuer: pick.issuer, n: pick.assets.length });
  }
}

claimMsg.textContent = '‚úÖ Claimed. Refreshing‚Ä¶';
await listClaimables();
}catch(e){
  claimMsg.textContent = '‚ùå ' + String(e);
  log('claim.exception', { err: String(e) });
}
});
// =================== Modal helpers ===================
function openModal(el, focusEl){
  lastFocus = document.activeElement;
  [modal, orderbookModal, placeOrderModal, myWalletModal].forEach(m=>{
    m.hidden = true;
    m.removeAttribute('open');
  });
  el.hidden = false;
  backdrop.hidden = false;
  el.setAttribute('open','');
  backdrop.setAttribute('open','');
  document.body.style.overflow = 'hidden';
  (focusEl || el.querySelector('.close-btn'))?.focus?.();
  log('modal.open', { id: el?.id || 'unknown' });
}

function closeModal(el){
  el.removeAttribute('open');
  backdrop.removeAttribute('open');
  el.hidden = true;
  backdrop.hidden = true;
  document.body.style.overflow = '';
  lastFocus?.focus?.();
  log('modal.close', { id: el?.id || 'unknown' });
}

// Open roadmap
roadmapBtn?.addEventListener('click', ()=>openModal(modal, closeModalBtn));
badgeOpen?.addEventListener('click',  ()=>openModal(modal, closeModalBtn));

// Close buttons
closeModalBtn?.addEventListener('click',     ()=>closeModal(modal));
closeMyWalletBtn?.addEventListener('click',  ()=>closeModal(myWalletModal));
closeOrderbookBtn?.addEventListener('click', ()=>{ stopObRefresh(); closeModal(orderbookModal); });
closePlaceOrderBtn?.addEventListener('click',()=> closeModal(placeOrderModal));

// =======================
// MY NFT MODAL HANDLERS
// =======================
openMyNftsBtn?.addEventListener('click', async ()=>{
  // ensure user + active wallet
  if (!ACTIVE_PUB) { await fetchActiveWallet(); }
  nftPubEcho.textContent = ACTIVE_PUB || document.getElementById('acctPub')?.value || '‚Äî';
  await loadMyNfts();
  openModal(myNftsModal, closeMyNftsBtn);
  log('ui.nfts.open', { pub: nftPubEcho.textContent.slice(0,6) + '‚Ä¶' });
});

closeMyNftsBtn?.addEventListener('click', ()=>{
  log('ui.nfts.close');
  closeModal(myNftsModal);
});

// Backdrop click closes whichever is open
backdrop?.addEventListener('click', ()=>{
  if (!orderbookModal.hidden){ stopObRefresh(); }
  [modal, orderbookModal, placeOrderModal, myWalletModal, stakeModal, claimModal, voteModal].forEach(m=>{
    if (!m.hidden) closeModal(m);
  });
});

// Reveal Secret (one-time local reveal)
revealOnceBtn?.addEventListener('click', ()=>{
  if (!ACTIVE_PUB) return;
  if (hasViewedOnce(ACTIVE_PUB, USER?.username)) {
    secretOnce.style.display = 'block';
    secretOnce.textContent = 'Secret was already revealed once on this device.';
    log('secret.reveal.blocked');
    return;
  }
  const sec = getLocalSecret(ACTIVE_PUB, USER?.username);
  secretOnce.style.display = 'block';
  secretOnce.textContent = sec ? sec : 'No secret stored locally for this wallet.';
  if (sec) markSecretViewedOnce(ACTIVE_PUB, USER?.username);
  log('secret.reveal.once', { ok: !!sec });
});

// Wallet button ‚Äî ensure user auth first so mwUser is filled
walletBtn?.addEventListener('click', async ()=>{
  if (!USER) {
    try { await piSignIn(); } catch(_) { /* ignore if user cancels */ }
  }

  if (!ACTIVE_PUB){
    await fetchActiveWallet();
    if (!ACTIVE_PUB && NEW_WALLET) ACTIVE_PUB = NEW_WALLET.pub;
  }

  await refreshMyWalletModal();
  openModal(myWalletModal, closeMyWalletBtn);
});

// =================== Order book endpoints ===================
const ORDERBOOK_URL = `${API_BASE}/order_book`
  + `?selling_asset_type=credit_alphanum4`
  + `&selling_asset_code=${encodeURIComponent(ASSET_CODE)}`
  + `&selling_asset_issuer=${encodeURIComponent(ISSUER)}`
  + `&buying_asset_type=native`;

const TRADES_URL = `${API_BASE}/trades`
  + `?base_asset_type=credit_alphanum4`
  + `&base_asset_code=${encodeURIComponent(ASSET_CODE)}`
  + `&base_asset_issuer=${encodeURIComponent(ISSUER)}`
  + `&counter_asset_type=native`
  + `&order=desc&limit=200`;

document.getElementById('rawOrderbookLink')?.setAttribute('href', ORDERBOOK_URL);

// =================== Order book table UI ===================
const obBestAsk = document.getElementById('obBestAsk');
const obBestBid = document.getElementById('obBestBid');
const obSpread  = document.getElementById('obSpread');
const obSumAsks = document.getElementById('obSumAsks');
const obUpdated = document.getElementById('obUpdated');

function num(x, dp=7){ const n = Number(x); return isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:dp, maximumFractionDigits:dp}) : '‚Äì'; }
function sum(arr, key){ return arr.reduce((a,b)=>a + Number(b[key]||0), 0); }

async function loadOrderbook(){
  try{
    const res  = await fetch(ORDERBOOK_URL, {cache:'no-store'});
    const data = await res.json();

    const asks = (data.asks || []).map(r => ({ price: Number(r.price), amount: Number(r.amount) }));
    const bids = (data.bids || []).map(r => ({ price: Number(r.price), amount: Number(r.amount) }));

    const bestAsk = asks.length ? Math.min(...asks.map(a=>a.price)) : null;
    const bestBid = bids.length ? Math.max(...bids.map(b=>b.price)) : null;
    const spread  = (bestAsk!=null && bestBid!=null) ? bestAsk - bestBid : null;

    obBestAsk.textContent = bestAsk!=null ? num(bestAsk,4) : '‚Äì';
    obBestBid.textContent = bestBid!=null ? num(bestBid,4) : '‚Äì';
    obSpread.textContent  = spread!=null  ? num(spread,4)  : '‚Äì';
    obSumAsks.textContent = asks.length ? num(sum(asks,'amount'),2) : '0';
    obUpdated.textContent = new Date().toLocaleTimeString();

    const asksBody = document.querySelector('#asksTbl tbody');
    const bidsBody = document.querySelector('#bidsTbl tbody');
    asksBody.innerHTML = ''; bidsBody.innerHTML = '';

    asks.sort((a,b)=>a.price-b.price).slice(0,50).forEach(a=>{
      const total = a.price * a.amount;
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td style="text-align:left;padding:8px">${num(a.price,4)}</td>`+
        `<td style="text-align:right;padding:8px">${num(a.amount,2)}</td>`+
        `<td style="text-align:right;padding:8px">${num(total,4)}</td>`;
      asksBody.appendChild(tr);
    });

    bids.sort((a,b)=>b.price-a.price).slice(0,50).forEach(b=>{
      const total = b.price * b.amount;
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td style="text-align:left;padding:8px">${num(b.price,4)}</td>`+
        `<td style="text-align:right;padding:8px">${num(b.amount,2)}</td>`+
        `<td style="text-align:right;padding:8px">${num(total,4)}</td>`;
      bidsBody.appendChild(tr);
    });
    log('orderbook.ok', { asks: asks.length, bids: bids.length });
  }catch(err){
    log('orderbook.fail',{err:String(err)});
  }
}

// =================== Chart (ensure libs, draw after visible) ===================
let izzaChart = null;
let allPoints = [];
let obTimer = null;

const chartCanvas = document.getElementById('izzaChart');
const ro = new ResizeObserver(()=>{ try{ izzaChart && izzaChart.resize(); }catch(_){ } });
if (chartCanvas && chartCanvas.parentElement) ro.observe(chartCanvas.parentElement);

function startObRefresh(){
  if(obTimer) clearInterval(obTimer);
  obTimer = setInterval(()=>{ if(!orderbookModal.hidden){ loadOrderbook(); loadTradesAndDraw(); } }, 10000);
}
function stopObRefresh(){ if(obTimer) clearInterval(obTimer); obTimer=null; }

const rangeBtns = Array.from(document.querySelectorAll('.rangeBtn'));
let activeRange = '1D';
rangeBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    rangeBtns.forEach(x=>x.setAttribute('aria-pressed','false'));
    b.setAttribute('aria-pressed','true');
    activeRange = b.dataset.range;
    drawChart();
    log('chart.range', { range: activeRange });
  });
});

function msAgo(n){ return Date.now() - n; }
function filteredByRange(){
  if(!allPoints.length) return [];
  let cutoff = 0;
  switch(activeRange){
    case '1D':  cutoff = msAgo(24*3600*1000); break;
    case '1W':  cutoff = msAgo(7*24*3600*1000); break;
    case '1M':  cutoff = msAgo(30*24*3600*1000); break;
    case '1Y':  cutoff = msAgo(365*24*3600*1000); break;
    case 'ALL': default: return allPoints;
  }
  return allPoints.filter(p => p.t.getTime() >= cutoff);
}

async function loadTradesAndDraw(){
  const ok = await ensureChart();
  if(!ok){
    document.querySelector('.chart-wrap')?.insertAdjacentHTML('beforeend',
      `<div class="help" style="margin-top:6px;color:#ffb3b3">Chart libraries couldn‚Äôt load.</div>`);
    log('chart.ensure.fail');
    return;
  }
  try{
    const res = await fetch(TRADES_URL, {cache:'no-store'});
    const data = await res.json();
    const recs = (data._embedded && data._embedded.records) ? data._embedded.records : [];
    allPoints = recs.map(r=>{
      const izza = Number(r.base_amount);
      const pi   = Number(r.counter_amount);
      const fallback = (r.price && r.price.n && r.price.d) ? (r.price.n/r.price.d) : NaN;
      const price = (izza > 0) ? (pi / izza) : Number(fallback);
      return { t: new Date(r.ledger_close_time || r.created_at), price, vol: izza };
    }).reverse();
    requestAnimationFrame(drawChart);
    log('chart.trades.ok', { n: allPoints.length });
  }catch(e){
    document.querySelector('.chart-wrap')?.insertAdjacentHTML(
      'beforeend',
      `<div class="help" style="margin-top:6px;color:#ffb3b3">Couldn‚Äôt load trades: ${String(e)}</div>`
    );
    log('chart.trades.fail',{err:String(e)});
  }
}

function drawChart(){
  if (!window.Chart){ return; }
  const canvas = document.getElementById('izzaChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const pts = filteredByRange();
  const labels = pts.map(p=>p.t);
  const prices = pts.map(p=>p.price);
  const vols   = pts.map(p=>p.vol);

  if(izzaChart){ try{ izzaChart.destroy(); }catch(_){} }

  izzaChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { type: 'line', label: 'Price (Pi/IZZA)', data: prices, yAxisID: 'y',
          tension: 0.3, borderColor: '#7a44ff', backgroundColor: 'rgba(122,68,255,0.25)',
          pointRadius: 0, borderWidth: 2 },
        { type: 'bar', label: 'Volume (IZZA)', data: vols, yAxisID: 'y1',
          backgroundColor: '#ffcd60', borderWidth: 0 }
      ]
    },
    options: {
      animation: false, maintainAspectRatio: false,
      scales: {
        x: { type: 'time', time: { unit: pickTimeUnit() },
             grid:{ color:'rgba(255,255,255,0.06)' }, ticks:{ color:'#cfe0ff' } },
        y: { position: 'left', grid:{ color:'rgba(255,255,255,0.06)' }, ticks:{ color:'#cfe0ff' } },
        y1:{ position: 'right', grid:{ display:false }, ticks:{ color:'#ffcd60' } }
      },
      plugins: { legend:{ labels:{ color:'#cfe0ff' } },
        tooltip:{ mode:'index', intersect:false, callbacks:{
          label:(ctx)=> ctx.dataset.yAxisID==='y'
            ? ` Price: ${Number(ctx.parsed.y).toFixed(6)} Pi`
            : ` Volume: ${Number(ctx.parsed.y).toLocaleString()} IZZA`
        }}}
    }
  });
}

function pickTimeUnit(){
  switch(activeRange){
    case '1D': return 'hour';
    case '1W': return 'day';
    case '1M': return 'day';
    case '1Y': return 'month';
    default:   return 'day';
  }
}

// Open Orderbook
orderbookBtn?.addEventListener('click', async ()=>{
  openModal(orderbookModal, closeOrderbookBtn);
  await ensureChart();
  loadOrderbook();
  loadTradesAndDraw();
  startObRefresh();
  requestAnimationFrame(()=>{ try{ izzaChart && izzaChart.resize(); }catch(_){} });
});

// =================== Orders / Wallet (with Stellar ensure) ===================
const sideBtns  = Array.from(document.querySelectorAll('.sideBtn'));
const typeBtns  = Array.from(document.querySelectorAll('.typeBtn'));
let side  = 'BUY';
let otype = 'LIMIT';

sideBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    sideBtns.forEach(x=>x.setAttribute('aria-pressed','false'));
    b.setAttribute('aria-pressed','true');
    side = b.dataset.side;
  });
});

const orderHelp   = document.getElementById('orderHelp');
const slipRow     = document.getElementById('slipRow');
const slippagePct = document.getElementById('slippagePct');
const agreeSlip   = document.getElementById('agreeSlippage');
const slipEcho    = document.getElementById('slipEcho');
const autoNote    = document.getElementById('autoPriceNote');
const autoPreview = document.getElementById('autoPricePreview');
slippagePct?.addEventListener('input', ()=>{ slipEcho.textContent = slippagePct.value || '0'; });

const orderForm = document.getElementById('orderForm');
const acctPub   = document.getElementById('acctPub');
const priceEl   = document.getElementById('price');
const amtEl     = document.getElementById('amount');
const orderMsg  = document.getElementById('orderMsg');

typeBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    typeBtns.forEach(x=>x.setAttribute('aria-pressed','false'));
    b.setAttribute('aria-pressed','true');
    otype = b.dataset.type;

    const isMarket = (otype === 'MARKET');
    priceEl.disabled    = isMarket;
    priceEl.required    = !isMarket;
    priceEl.placeholder = isMarket ? 'auto (best price ¬± slippage)' : 'e.g. 0.005';

    slipRow.style.display  = isMarket ? '' : 'none';
    autoNote.style.display = isMarket ? '' : 'none';
    if (!isMarket) agreeSlip.checked = false;

    orderHelp.textContent = isMarket
      ? 'Market: we auto-use the best available price with your slippage cap. Any remainder may rest as an offer.'
      : 'Limit: you set the price, it fills if it crosses the book, otherwise rests until matched.';
  });
});

const buildBtn = document.getElementById('buildSep7');
function setOrderReady(ready, direct=false){
  const pub = document.getElementById('acctPub')?.value || ACTIVE_PUB;
  const localSec = pub && getLocalSecret(pub);
  const isIzzaWallet = pub && pub.startsWith('G') && localSec;

  buildBtn.disabled = !ready;
  if (!ready) buildBtn.textContent = 'Waiting for funding, trustline‚Ä¶';
  else if (isIzzaWallet) buildBtn.textContent = 'Submit Order';
  else buildBtn.textContent = direct ? 'Submit Order' : 'Open in Wallet (SEP-7)';
}
setOrderReady(false);

// Horizon + network
const NETWORK_PASSPHRASE = 'Pi Testnet';
const SEP7_PREFIX = `web+stellar:tx?`;

function getServer(){
  const SDK = window.StellarSdk;
  const ServerCtor = SDK?.Server || SDK?.Horizon?.Server;
  if (!ServerCtor) throw new Error('Stellar SDK loaded, but Server class is unavailable');
  return new ServerCtor(String(API_BASE).replace(/\/+$/,''));
}

function explainHorizonError(e){
  try{
    const d   = e?.response?.data || e?.data || null;
    const ex  = d?.extras || null;
    const txc = ex?.result_codes?.transaction || null;
    const opc = Array.isArray(ex?.result_codes?.operations)
      ? ex.result_codes.operations[0]
      : null;

    const friendly = {
      op_underfunded:       'Not enough Pi to cover price√óamount plus fees/reserves.',
      op_low_reserve:       'Account would drop below the minimum reserve.',
      op_no_trust:          'Missing trustline for the asset on this side.',
      op_buy_no_trust:      'Missing trustline for the asset you are buying.',
      op_sell_no_trust:     'Missing trustline for the asset you are selling.',
      op_line_full:         'Trustline limit or balance can‚Äôt accept this much.',
      tx_bad_auth:          'Bad signature or wrong network passphrase.',
      tx_insufficient_balance: 'Insufficient balance to pay the fee.'
    };

    const title = d?.title || 'Bad request';
    const detail = d?.detail || title;
    const msg = friendly[opc] || friendly[txc] || detail;
    return { msg, txc, opc, raw: d };
  }catch{
    return { msg: String(e) };
  }
}

async function getAutoPrice(side, slippage = 0.03){
  try{
    const res = await fetch(
      `${API_BASE}/order_book?selling_asset_type=credit_alphanum4`+
      `&selling_asset_code=${encodeURIComponent(ASSET_CODE)}`+
      `&selling_asset_issuer=${encodeURIComponent(ISSUER)}`+
      `&buying_asset_type=native`,
      { cache:'no-store' }
    );
    const ob = await res.json();
    const asks = (ob.asks||[]).map(r=>Number(r.price));
    const bids = (ob.bids||[]).map(r=>Number(r.price));
    const bestAsk = asks.length ? Math.min(...asks) : null;
    const bestBid = bids.length ? Math.max(...bids) : null;
    if(side === 'BUY'  && bestAsk!=null) return bestAsk * (1 + slippage);
    if(side === 'SELL' && bestBid!=null) return bestBid * (1 - slippage);
    return null;
  }catch(_){ return null; }
}

// ==== Account state helpers ====
async function loadAccount(pub){
  try{ const r = await fetch(`${API_BASE}/accounts/${pub}`, {cache:'no-store'}); return r.ok ? r.json() : null; }
  catch(_){ return null; }
}
function hasIzzaTrust(balances){
  if (!Array.isArray(balances)) return false;
  return balances.some(b => b.asset_code === ASSET_CODE && b.asset_issuer === ISSUER);
}
async function getAccountState(pub){
  const json = await loadAccount(pub);
  if (!json) return { funded:false, hasTrust:false };
  return { funded:true, hasTrust: hasIzzaTrust(json.balances||[]) };
}

// --- short, self-contained funding watcher ---
let __izzaFundingPoll = null;
function startFundingWatcher(pub){
  if (__izzaFundingPoll) clearInterval(__izzaFundingPoll);
  const stopAt = Date.now() + 20000;
  __izzaFundingPoll = setInterval(async ()=>{
    try{
      const { funded, hasTrust } = await getAccountState(pub);
      if (funded){
        statusEl.textContent = hasTrust
          ? 'Trustline present. You can place orders.'
          : 'Account funded. Add the IZZA trustline.';
        addTrustlineBtn.disabled = !!hasTrust;
        const direct = (ACTIVE_PUB === pub && !!getLocalSecret(pub)) || isLocalWallet(pub);
        setOrderReady(!!hasTrust, direct);
        if (hasTrust){ clearInterval(__izzaFundingPoll); __izzaFundingPoll = null; }
      }
      if (Date.now() > stopAt){ clearInterval(__izzaFundingPoll); __izzaFundingPoll = null; }
    }catch(_){
      if (Date.now() > stopAt){ clearInterval(__izzaFundingPoll); __izzaFundingPoll = null; }
    }
  }, 2500);
}

// --- Fill "My Wallet" modal ---
async function refreshMyWalletModal(){
  document.getElementById('mwUser').textContent = USER?.username || '‚Äî';
  document.getElementById('mwPub').textContent  = ACTIVE_PUB || '‚Äî';
  document.getElementById('secretOnce').style.display = 'none';

  if (!ACTIVE_PUB) return;
  try{
    const j = await loadAccount(ACTIVE_PUB);
    const piBal   = (j?.balances||[]).find(b=>b.asset_type==='native')?.balance || '0';
    const izzaBal = (j?.balances||[]).find(b=>b.asset_code===ASSET_CODE && b.asset_issuer===ISSUER)?.balance || '0';
    document.getElementById('mwPi').textContent   = piBal;
    document.getElementById('mwIzza').textContent = izzaBal;
  }catch(_){}
}

// ==== UI gate & trustline flow ====
const statusEl        = document.getElementById('walletStatus');
const checkFundingBtn = document.getElementById('checkFundingBtn');
const addTrustlineBtn = document.getElementById('addTrustlineBtn');

// extra refs
const acctPubInput    = document.getElementById('acctPub');
const autoFundHelp    = document.getElementById('autoFundHelp') || document.querySelector('#newWalletBox .help');

// Secret-row visibility wiring
const secRow = document.getElementById('secRow');
const acctSec = document.getElementById('acctSec');
const rememberSec = document.getElementById('rememberSec');

function updateSecretRowVisibility(pub){
  const hasLocal = pub && !!getLocalSecret(pub, USER?.username);
  if (secRow) secRow.style.display = (pub && !hasLocal) ? '' : 'none';
}

let NEW_WALLET = null; // { pub, sec } only when generated here
function isLocalWallet(pub){ return NEW_WALLET && NEW_WALLET.pub === pub; }

async function refreshAccountGate(pubMaybe){
  const pub = (pubMaybe || acctPubInput.value || '').trim();
  if (!pub){ addTrustlineBtn.disabled = true; setOrderReady(false); return; }

  statusEl.textContent = 'Checking account on Pi Testnet‚Ä¶';
  const { funded, hasTrust } = await getAccountState(pub);

  if (funded && autoFundHelp) autoFundHelp.style.display = 'none';
  updateSecretRowVisibility(pub);

  if (!funded){
    statusEl.textContent = 'Account is not funded yet. Fund with Test-Pi first.';
    addTrustlineBtn.disabled = true;
    setOrderReady(false);
    return;
  }

  if (hasTrust){
    statusEl.textContent = 'Trustline present. You can place orders.';
    addTrustlineBtn.disabled = true;
    const isDirect = (ACTIVE_PUB && pub === ACTIVE_PUB && !!getLocalSecret(pub)) || isLocalWallet(pub);
    setOrderReady(true, isDirect);
  } else {
    statusEl.textContent = 'Account funded. Add the IZZA trustline.';
    addTrustlineBtn.disabled = false;
    setOrderReady(false);
  }

  addTrustlineBtn.onclick = async ()=>{
    const target = (acctPubInput.value||'').trim();
    if (!target) return;
    if (isLocalWallet(target)) {
      await addTrustlineDirect();
    } else {
      const uri = await buildChangeTrustSEP7(target);
      if (uri){
        window.location.href = uri;
        orderMsg.innerHTML = `We opened your wallet to add the trustline. If nothing happens, copy this URI into a SEP-7 wallet:<br><code style="word-break:break-all">${uri}</code>`;
      } else {
        orderMsg.innerHTML = `<span style="color:#ffb3b3">Couldn‚Äôt prepare trustline request for this account.</span>`;
      }
    }
  };
}

checkFundingBtn?.addEventListener('click', ()=> refreshAccountGate());
acctPubInput?.addEventListener('input', () => {
  const pub = (acctPubInput.value || '').trim();
  const direct = !!pub && ((pub === ACTIVE_PUB && !!getLocalSecret(pub)) || isLocalWallet(pub));
  buildBtn.textContent = direct ? 'Submit Order' : 'Open in Wallet (SEP-7)';
});

// ==== Order submit handler ====
orderForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const pub = (acctPub.value||'').trim();
  const amount = Number(amtEl.value);
  if(!pub || !isFinite(amount) || amount<=0){
    orderMsg.textContent = 'Please provide a valid account and amount.'; return;
  }

  const { funded, hasTrust } = await getAccountState(pub);
  if (!funded){ orderMsg.textContent = 'Account not funded yet.'; return; }
  if (!hasTrust){ orderMsg.textContent = 'Add the IZZA trustline first.'; return; }

  const stellarOK = await ensureStellar();
  if (!stellarOK || !window.StellarSdk){
    orderMsg.innerHTML = `<span style="color:#ffb3b3">Couldn‚Äôt load Stellar SDK in this WebView.</span>`;
    return;
  }

  let price = Number(priceEl.value);
  if(otype === 'LIMIT'){
    if(!isFinite(price) || price<=0){
      orderMsg.textContent = 'Please provide a valid limit price.'; return;
    }
  } else {
    const slip = Math.max(0, Math.min(50, Number(slippagePct.value||0))) / 100;
    if (!agreeSlip.checked){
      orderMsg.textContent = 'Please accept the slippage consent to place a market order.'; return;
    }
    orderMsg.textContent = 'Finding best price‚Ä¶';
    const auto = await getAutoPrice(side, slip);
    price = (auto && isFinite(auto)) ? auto :  (side === 'BUY' ?  1e9 : 1e-9);
    autoPreview.textContent = (auto && isFinite(auto)) ? Number(auto).toFixed(7) : '‚Äî';
  }

  const localSec = (ACTIVE_PUB && pub === ACTIVE_PUB) ? getLocalSecret(pub) : null;
  orderMsg.textContent = (localSec || isLocalWallet(pub)) ? 'Submitting order‚Ä¶' : 'Preparing wallet request‚Ä¶';

  try{
    const SDK    = window.StellarSdk;
    const server = getServer();
    const acct   = await server.loadAccount(pub);
    const izza   = new SDK.Asset(ASSET_CODE, ISSUER);
    const native = SDK.Asset.native();

    const op = (side === 'SELL')
      ? SDK.Operation.manageSellOffer({ selling: izza, buying: native, amount: amount.toString(), price: price.toString() })
      : SDK.Operation.manageBuyOffer({  buying: izza, selling: native, buyAmount: amount.toString(), price: price.toString() });

    const tx = new SDK.TransactionBuilder(
      acct,
      { fee: (await server.fetchBaseFee()).toString(), networkPassphrase: NETWORK_PASSPHRASE }
    ).addOperation(op).setTimeout(180).build();

    if (localSec || isLocalWallet(pub)) {
      const sec = localSec || NEW_WALLET.sec;
      const key = SDK.Keypair.fromSecret(sec);
      tx.sign(key);
      const res = await server.submitTransaction(tx);
      if (res && res.hash) {
        orderMsg.innerHTML = `‚úÖ Order submitted. Tx hash: <code>${res.hash}</code>`;
        log('order.submit.ok', { hash: res.hash });
      } else {
        orderMsg.textContent = 'Order submitted, awaiting confirmation.';
        log('order.submit.queued');
      }
    } else {
      const xdr = tx.toXDR();
      const uri = `${SEP7_PREFIX}xdr=${encodeURIComponent(xdr)}&network_passphrase=${encodeURIComponent(NETWORK_PASSPHRASE)}`;
      window.location.href = uri;
      orderMsg.innerHTML = `Opening your wallet‚Ä¶ If nothing happens, copy this URI into a SEP-7 wallet:<br><code style="word-break:break-all">${uri}</code>`;
      log('order.sep7.opened');
    }
  } catch(err){
    const info = explainHorizonError(err);
    log('order.tx.fail', { err:String(err), txc:info.txc, opc:info.opc });
    const codeLine = [info.opc, info.txc].filter(Boolean).join(' ‚Ä¢ ');
    orderMsg.innerHTML =
      `‚ùå ${info.msg}` +
      (codeLine ? `<br><span class="small-muted">${codeLine}</span>` : '');
  }
});

// === Cancel ALL my open IZZA orders ===
const cancelBtn = document.getElementById('cancelOrdersBtn');
const cancelMsg = document.getElementById('cancelMsg');

cancelBtn?.addEventListener('click', async ()=>{
  cancelBtn.disabled = true;
  cancelMsg.textContent = 'Checking for open orders‚Ä¶';

  const pub = ACTIVE_PUB || (document.getElementById('acctPub')?.value||'').trim();
  if (!pub){ cancelMsg.textContent = 'No active wallet.'; cancelBtn.disabled = false; return; }

  const sec = getLocalSecret(pub, USER?.username) || (NEW_WALLET?.pub === pub ? NEW_WALLET.sec : null);
  if (!sec){ cancelMsg.textContent = 'Secret missing. Import or create wallet first.'; cancelBtn.disabled = false; return; }

  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk){ cancelMsg.textContent = 'Stellar SDK missing.'; cancelBtn.disabled = false; return; }

  try{
    const res = await fetch(`${API_BASE}/accounts/${pub}/offers?limit=200&order=asc`, { cache:'no-store' });
    const json = res.ok ? await res.json() : null;
    const offers = json?._embedded?.records ?? [];
    if (!offers.length){ cancelMsg.textContent = 'No active orders to cancel.'; cancelBtn.disabled = false; return; }

    const SDK = window.StellarSdk;
    const server = getServer();
    const acct = await server.loadAccount(pub);

    const txb = new SDK.TransactionBuilder(acct, {
      fee: (await server.fetchBaseFee()).toString(),
      networkPassphrase: NETWORK_PASSPHRASE
    });

    let n = 0;
    for (const offer of offers){
      const sellsIzza = offer.selling?.asset_code === ASSET_CODE && offer.selling?.asset_issuer === ISSUER;
      const buysIzza  = offer.buying?.asset_code  === ASSET_CODE && offer.buying?.asset_issuer  === ISSUER;
      if (!(sellsIzza || buysIzza)) continue;

      const izza   = new SDK.Asset(ASSET_CODE, ISSUER);
      const native = SDK.Asset.native();

      if (sellsIzza){
        txb.addOperation(SDK.Operation.manageSellOffer({
          selling: izza, buying: native, amount: '0', price: '1', offerId: offer.id
        }));
      } else {
        txb.addOperation(SDK.Operation.manageBuyOffer({
          buying: izza, selling: native, buyAmount: '0', price: '1', offerId: offer.id
        }));
      }
      n++;
    }

    if (!n){ cancelMsg.textContent = 'No IZZA orders to cancel.'; cancelBtn.disabled = false; return; }

    const tx = txb.setTimeout(180).build();
    tx.sign(SDK.Keypair.fromSecret(sec));

    const resp = await server.submitTransaction(tx);
    cancelMsg.textContent = `‚úÖ Cancelled ${n} open order(s). Tx: ${resp.hash}`;
    log('orders.cancel.ok', { n, hash: resp.hash });
  } catch(e){
    const info = explainHorizonError(e);
    cancelMsg.textContent = `‚ùå ${info.msg}`;
    log('orders.cancel.fail', { err: String(e) });
  } finally {
    cancelBtn.disabled = false;
  }
});

// =================== Create Test Wallet ===================
const createBtn    = document.getElementById('createWalletBtn');
const box          = document.getElementById('newWalletBox');
const newPubEl     = document.getElementById('newPub');
const newQRCanvas  = document.getElementById('newWalletQR');

function drawQR(canvas, text){
  try{
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#000';
    ctx.font = '10px monospace';
    const lines = text.match(/.{1,16}/g) || [text];
    lines.slice(0,7).forEach((ln,i)=>ctx.fillText(ln, 6, 16 + i*16));
  }catch(e){ log('wallet.qr.fail',{err:String(e)}); }
}

createBtn?.addEventListener('click', async ()=>{
  // continue with existing logic
  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk){
    statusEl.innerHTML = `<span style="color:#ffb3b3">Couldn‚Äôt load Stellar SDK. Try a modern browser, or host /static/stellar-sdk.min.js.</span>`;
    return;
  }
  if (!window.crypto || !window.crypto.getRandomValues){
    statusEl.innerHTML = `<span style="color:#ffb3b3">This browser/WebView lacks secure randomness. Can‚Äôt generate keys here.</span>`;
    return;
  }

  try{
    const kp = StellarSdk.Keypair.random();
    NEW_WALLET = { pub: kp.publicKey(), sec: kp.secret() };
    try { saveLocalSecret(NEW_WALLET.pub, NEW_WALLET.sec, USER?.username); } catch(_) {}

    const secretBox = document.getElementById('secretOnce');
    if (secretBox) {
      secretBox.style.display = 'block';
      secretBox.textContent =
        `YOUR SECRET (copy & store safely):\n${NEW_WALLET.sec}\n\n` +
        `This is a non-custodial wallet. We never send your secret to our server. ` +
        `You will need this secret on new devices or if your browser storage is cleared.`;
    }
    try { markSecretViewedOnce(NEW_WALLET.pub, USER?.username); } catch(_){}

    try { await linkActiveWallet(NEW_WALLET.pub); } catch(_) {}
    ACTIVE_PUB = NEW_WALLET.pub;
    try { saveLocalSecret(NEW_WALLET.pub, NEW_WALLET.sec); } catch(_){}
    await refreshMyWalletModal();

    if (acctPub) acctPub.value = NEW_WALLET.pub;
    newPubEl.textContent = NEW_WALLET.pub;
    drawQR(newQRCanvas, NEW_WALLET.pub);
    box.style.display = 'block';
    statusEl.textContent = 'Wallet created. Funding 2.0 Test-Pi‚Ä¶';
    try{ localStorage.setItem('izza_test_wallet', JSON.stringify(NEW_WALLET)); }catch(_){}

    // Ask your server faucet to create+fund with 2 Test-Pi
    let funded = false;
    try{
      const res  = await fetch('/faucet', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ dest: NEW_WALLET.pub })
      });
      const json = await res.json();
      funded = !!(res.ok && json && (json.ok || json.already));
      if (!funded) statusEl.innerHTML = `<span style="color:#ffb3b3">Faucet failed: ${json && json.err ? json.err : 'unknown'}</span>`;
      log('wallet.faucet.done', { ok: funded });
    }catch(e){
      statusEl.innerHTML = `<span style="color:#ffb3b3">Faucet error: ${String(e)}</span>`;
      log('wallet.faucet.fail', { err: String(e) });
    }

    if (funded){
      statusEl.textContent = 'Funded with 2.0 Test-Pi. You can now add the IZZA trustline.';
      if (autoFundHelp) autoFundHelp.style.display = 'none';

      addTrustlineBtn.disabled = false;
      setOrderReady(false);

      await refreshAccountGate(NEW_WALLET.pub);
      startFundingWatcher(NEW_WALLET.pub);
    }else{
      statusEl.textContent = 'Created but not funded. You can retry later with ‚ÄúCheck Funding‚Äù.';
    }
  }catch(e){
    statusEl.innerHTML = `<span style="color:#ffb3b3">Couldn‚Äôt create wallet: ${String(e)}</span>`;
    log('wallet.create.fail',{err:String(e)});
  }
});

// ==== Add trustline (direct for local wallet) ====
async function addTrustlineDirect(){
  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk){ statusEl.textContent = 'Stellar SDK missing.'; return; }
  if(!NEW_WALLET){ statusEl.textContent = 'No wallet in memory.'; return; }

  addTrustlineBtn.disabled = true;
  statusEl.textContent = 'Adding IZZA trustline‚Ä¶';
  try{
    const SDK    = window.StellarSdk;
    const server = getServer();
    const user   = SDK.Keypair.fromSecret(NEW_WALLET.sec);
    const acct   = await server.loadAccount(user.publicKey());
    const izza   = new SDK.Asset(ASSET_CODE, ISSUER);

    const tx = new SDK.TransactionBuilder(acct, {
      fee: (await server.fetchBaseFee()).toString(),
      networkPassphrase: NETWORK_PASSPHRASE
    })
    .addOperation(SDK.Operation.changeTrust({ asset: izza }))
    .setTimeout(180)
    .build();

    tx.sign(user);
    const res = await server.submitTransaction(tx);
    const okRes = !!res && (res.successful || res.result_xdr);
    statusEl.textContent = okRes ? 'Trustline added. You can place orders now.' : 'Trustline failed.';
    addTrustlineBtn.disabled = okRes ? true : false;
    if (okRes){
      setOrderReady(true, true);
      checkFundingBtn && (checkFundingBtn.style.display = 'none');
      log('trustline.add.ok');
    } else {
      log('trustline.add.fail', { res });
    }
  }catch(e){
    statusEl.innerHTML = `<span style="color:#ffb3b3">Trustline failed: ${String(e)}</span>`;
    addTrustlineBtn.disabled = false;
    log('wallet.trustline.fail',{err:String(e)});
  }
}

// ==== Build changeTrust SEP-7 for external wallets ====
async function buildChangeTrustSEP7(pub){
  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk) { statusEl.textContent = 'Stellar SDK missing.'; return null; }
  try{
    const SDK    = window.StellarSdk;
    const server = getServer();
    const acct   = await server.loadAccount(pub);
    const izza   = new SDK.Asset(ASSET_CODE, ISSUER);

    const tx = new SDK.TransactionBuilder(acct, {
      fee: (await server.fetchBaseFee()).toString(),
      networkPassphrase: NETWORK_PASSPHRASE
    })
    .addOperation(SDK.Operation.changeTrust({ asset: izza }))
    .setTimeout(180)
    .build();

    const xdr = tx.toXDR();
    log('trust.sep7.built');
    return `${SEP7_PREFIX}xdr=${encodeURIComponent(xdr)}&network_passphrase=${encodeURIComponent(NETWORK_PASSPHRASE)}`;
  }catch(e){
    log('trust.sep7.fail',{err:String(e)});
    return null;
  }
}
// ===== NFT trust helpers, place right after buildChangeTrustSEP7(pub) =====

// check if a wallet already trusts an asset
function hasTrustFor(balances, code, issuer){
  return Array.isArray(balances)
    && balances.some(b => b.asset_code === code && b.asset_issuer === issuer);
}

// build a single SEP-7 link that includes multiple changeTrust ops, one per NFT
async function buildChangeTrustMultiSEP7(pub, assets /* [{code,issuer}] */){
  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk) return null;

  const SDK    = window.StellarSdk;
  const server = getServer();
  const acct   = await server.loadAccount(pub);

  let txb = new SDK.TransactionBuilder(acct, {
    fee: (await server.fetchBaseFee()).toString(),
    networkPassphrase: NETWORK_PASSPHRASE
  });

  for (const a of assets){
    txb = txb.addOperation(SDK.Operation.changeTrust({
      asset: new SDK.Asset(a.code, a.issuer)
    }));
  }

  const tx  = txb.setTimeout(180).build();
  const xdr = tx.toXDR();
  return `${SEP7_PREFIX}xdr=${encodeURIComponent(xdr)}&network_passphrase=${encodeURIComponent(NETWORK_PASSPHRASE)}`;
}

// direct signer for multiple NFT trustlines at once if we have the secret locally
async function addTrustlinesDirect(pub, secret, assets /* [{code,issuer}] */){
  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk) throw new Error('Stellar SDK missing');

  const SDK    = window.StellarSdk;
  const server = getServer();
  const acct   = await server.loadAccount(pub);

  let txb = new SDK.TransactionBuilder(acct, {
    fee: (await server.fetchBaseFee()).toString(),
    networkPassphrase: NETWORK_PASSPHRASE
  });

  for (const a of assets){
    txb = txb.addOperation(SDK.Operation.changeTrust({
      asset: new SDK.Asset(a.code, a.issuer)
    }));
  }

  const tx = txb.setTimeout(180).build();
  tx.sign(SDK.Keypair.fromSecret(secret));
  return server.submitTransaction(tx);
}
 
// helper: wait until all needed assets appear on the account (Horizon consistency)
async function waitForTrust(pub, assets, { maxMs = 6000, stepMs = 400 } = {}){
  const SDK = window.StellarSdk;
  const server = getServer();
  const start = Date.now();
  while (Date.now() - start < maxMs){
    const acct = await server.loadAccount(pub);
    const balances = acct?.balances || [];
    const missing = assets.filter(a =>
      !balances.some(b => b.asset_code === a.code && b.asset_issuer === a.issuer)
    );
    if (!missing.length) return true;
    await new Promise(r => setTimeout(r, stepMs));
  }
  return false;
}
// Initial gate & UI
setTimeout(()=>{ if (ACTIVE_PUB) refreshAccountGate(ACTIVE_PUB); }, 0);

// =================== Open the Place Order modal ===================
orderBtn?.addEventListener('click', async ()=>{
  if (!USER){
    try { await piSignIn(); } catch(_) { /* user canceled, continue read-only */ }
  }
  await bootstrapAuthUI();
  openModal(placeOrderModal, closePlaceOrderBtn);
  refreshAccountGate(acctPub.value);
});

// =================== Coin spin to refresh ===================
const wrap = document.getElementById('coinWrap');
let startX=0, startT=0;
function start(e){ const p = e.touches ? e.touches[0] : e; startX=p.clientX; startT=performance.now(); }
function end(e){
  const p = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
  const dx = (p.clientX - startX);
  const dt = Math.max(1, performance.now() - startT);
  const speed = Math.abs(dx) / dt;
  if (speed > 0.4) {
    wrap.classList.remove('spin-anim'); void wrap.offsetWidth; wrap.classList.add('spin-anim');
    setTimeout(fetchSummary, 1100);
    log('coin.spin.refresh');
  }
}
wrap?.addEventListener('pointerdown', start, {passive:true});
wrap?.addEventListener('pointerup',   end,   {passive:true});
wrap?.addEventListener('touchstart',  start, {passive:true});
wrap?.addEventListener('touchend',    end,   {passive:true});

// =================== Focus trap in modals ===================
function trapFocus(container){
  container.addEventListener('keydown', (e)=>{
    if(e.key !== 'Tab') return;
    const f = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(!f.length) return;
    const first = f[0], last = f[f.length - 1];
    if(e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
    else if(!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
  });
}
[modal, orderbookModal, placeOrderModal, myWalletModal, stakeModal, claimModal, voteModal].forEach(m=> m && trapFocus(m));

// end of file
})();
</script>
</body>
</html>
