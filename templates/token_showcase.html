<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IZZA Token — Testnet Showcase</title>
  <meta name="description" content="IZZA (test) — token showcase for IZZA PAY / IZZA Game" />

  <style>
    :root{
      --bg:#050308;
      --panel:#0b0b10;
      --muted:#9aa0b1;
      --accent1:#7a44ff;   /* violet line */
      --accent2:#b784ff;
      --gold-hex:#ffcd60;  /* gold for volume/area */
      --glass: rgba(255,255,255,0.04);
      --card-radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;

      /* glow palettes */
      --gold: 255,205,96;
      --violet1: 183,132,255;
      --violet2: 122,68,255;
    }

    html,body{
      height:100%;
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      max-width:100%;
      overflow-x:hidden;
      overscroll-behavior-x:none;
    }
    .wrap{max-width:1000px;margin:0 auto;padding:18px 16px 28px}
    @media (min-width:420px){ .wrap{padding:22px 18px 36px} }
    @media (min-width:820px){ .wrap{padding:28px 24px 42px} }

    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}

    .logo{
      height:clamp(56px, 12vw, 80px);
      width:auto;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer; user-select:none;
    }
    .logo img{height:100%; width:auto; object-fit:contain; background:transparent;}
    @media (max-width:768px){ .logo{ transform: translateX(91px); } }
    h1{margin:0;font-size:clamp(20px,4.8vw,28px);letter-spacing:.2px}
    p.lead{color:var(--muted);margin:4px 0 0;font-size:clamp(13px,3.4vw,14px)}
    .spacer{flex:1 1 auto}

    .top-cta{width:100%;text-align:center;margin-top:8px}
    .cta{
      display:inline-flex;align-items:center;gap:10px;
      padding:12px 16px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg,rgba(122,68,255,.25),rgba(183,132,255,.12));
      box-shadow:0 0 18px rgba(122,68,255,.28), 0 0 60px rgba(183,132,255,.18) inset;
      color:#fff;text-decoration:none;font-weight:800;letter-spacing:.3px;cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .cta:hover{transform:translateY(-1px);box-shadow:0 0 26px rgba(122,68,255,.40), 0 0 80px rgba(183,132,255,.28) inset}
    .cta:active{transform:translateY(0)}
    .cta img{width:20px;height:20px}

    .hero{position:relative;margin-top:16px;display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:880px){ .hero{grid-template-columns:minmax(0,1fr) 370px; gap:16px} }

    .panel{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--card-radius);
      padding:14px;
      box-shadow:0 4px 30px rgba(0,0,0,.35);
    }
    @media (min-width:540px){ .panel{padding:16px} }
    @media (min-width:980px){ .panel{padding:18px} }

    .token-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    /* Coin + GOLD glow beneath it (no box) — your original */
    .token-img{
      width:112px; height:112px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      position:relative; isolation:isolate; touch-action:pan-y;
      transform-style: preserve-3d;
    }
    .token-img img{ width:100%; height:100%; object-fit:contain; border-radius:14px; backface-visibility:hidden; position:relative; z-index:1; }
    .token-img::before{
      content:""; position:absolute;
      top:  calc(50% + var(--pulse-offset-y, -16px));
      left: calc(50% + var(--pulse-offset-x, -36px));
      width: var(--pulse-size, 140px);
      height: var(--pulse-size, 140px);
      transform: translate(-50%, -50%); border-radius:50%;
      background: radial-gradient(50% 50% at 50% 50%,
                  rgba(255,210,90,.35) 0%,
                  rgba(255,185,30,.18) 45%,
                  rgba(255,185,30,0) 70%);
      box-shadow: 0 0 30px 6px rgba(255,196,56,.40), 0 0 60px 20px rgba(255,180,0,.22) inset;
      animation: pulse 2.2s ease-in-out infinite; z-index: -1; pointer-events:none;
    }
    @keyframes coinspin { to { transform: rotateY(720deg); } }
    .spin-anim { animation: coinspin 1.1s ease-in-out; transform-origin: center; }

    .bg-weave{position:absolute; inset:-4px; z-index:-1; border-radius:20px;
      background:
        radial-gradient(600px 220px at 10% -10%, rgba(122,68,255,.18), transparent 60%),
        radial-gradient(500px 200px at 110% 10%, rgba(183,132,255,.22), transparent 58%),
        radial-gradient(800px 260px at 50% 120%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      overflow:hidden;
    }
    .bg-weave::after{
      content:""; position:absolute; inset:0;
      background:repeating-linear-gradient(110deg,
        rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px,
        rgba(255,255,255,0) 1px, rgba(255,255,255,0) 8px);
      mix-blend-mode:overlay; animation:drift 12s linear infinite; opacity:.35;
    }
    @keyframes drift{0%{transform:translate3d(-30px,0,0)}100%{transform:translate3d(30px,0,0)}}

    .meta h2{margin:0 0 4px 0;font-size:clamp(18px,4.6vw,22px)}
    .small{color:var(--muted);font-size:clamp(12px,3.2vw,13px)}
    .mono{font-family:var(--mono)}
    .wrapaddr{word-break:break-all; overflow-wrap:anywhere}

    .side-badge{
      display:flex;flex-direction:column;align-items:center;gap:8px;
      padding:0;border:none;background:none;margin-left:auto;margin-right:20px;margin-top:18px;text-align:center;position:relative;top:8px;
    }
    .mark-wrap{
      width:84px;height:84px;border-radius:18px;display:flex;align-items:center;justify-content:center;
      background: radial-gradient(60% 60% at 50% 40%, rgba(var(--violet1),.42), rgba(var(--violet1),.20));
      box-shadow: 0 0 22px rgba(var(--violet1),.45), 0 0 70px rgba(var(--violet2),.32);
      animation:pulse 2.2s ease-in-out infinite;cursor:pointer;border:none;
    }
    .mark-wrap img{width:50px;height:50px;display:block}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.07)}}
    .side-badge .arcade{font-weight:900;letter-spacing:.8px;text-transform:uppercase;font-size:14px;line-height:1.15;text-shadow:0 0 12px rgba(var(--violet1),.35)}
    .side-badge .hint{color:var(--muted);font-size:11px;line-height:1.1}

    .two{margin-top:12px;display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:480px){ .two{grid-template-columns:1fr} }
    .stat{background:var(--glass);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
    .stat .label{color:var(--muted);font-size:12px}
    .stat strong{display:block;margin-top:4px;font-size:clamp(16px,4.8vw,18px)}

    .card-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .small-muted{color:var(--muted);font-size:13px}

    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:480px){ .grid{grid-template-columns:1fr} }
    .mini{display:flex;gap:10px;align-items:center}
    .mini .ico{
      width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.04);font-size:18px;line-height:1;
    }
    .mini .ico.purple{
      background:linear-gradient(180deg,var(--accent1),var(--accent2));
      box-shadow:0 0 10px rgba(183,132,255,.25);
    }
    .mini img{width:26px;height:26px;object-fit:contain}

    hr.sep{margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)}
    .lower{margin-top:14px;display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:880px){ .lower{grid-template-columns:minmax(0,1fr) 370px} }

    .btnrow{display:flex;gap:8px;flex-wrap:wrap}
    .linkbtn{display:inline-block;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);color:#cfe0ff;text-decoration:none;font-weight:600}

    details.activity{margin-top:12px}
    details.activity > summary{
      list-style:none; cursor:pointer; padding:10px 12px; border-radius:10px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); font-weight:600;
    }
    details.activity[open] > summary{background:rgba(255,255,255,.06)}
    .ops{margin-top:10px}
    .op{margin-bottom:10px}
    .op .t{display:block;font-weight:700}
    .op .m{color:var(--muted);font-size:12px;margin-top:4px}

    footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:999;backdrop-filter:saturate(140%) blur(2px)}
    .modal{position:fixed;inset:0;display:none;z-index:1000;align-items:center;justify-content:center;padding:24px}
    .modal[open], .modal-backdrop[open]{display:flex}
    .modal-card{
      width:min(980px,96vw);max-height:86vh;overflow:auto;border-radius:18px;
      background:linear-gradient(180deg, rgba(10,8,18,.9), rgba(6,5,12,.96));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 40px 120px rgba(0,0,0,.55), 0 0 80px rgba(122,68,255,.35) inset;
      animation:pop .18s ease-out;
    }
    @keyframes pop{from{transform:translateY(10px) scale(.98);opacity:.6}to{transform:none;opacity:1}}
    .modal-header{
      position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:12px;justify-content:space-between;
      padding:14px 16px;background:rgba(8,6,14,.85);border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px)
    }
    .modal-title{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.4px;text-transform:uppercase}
    .modal-title img{width:26px;height:26px}
    .close-btn{appearance:none;border:none;cursor:pointer;border-radius:10px;padding:8px 10px;font-weight:800;color:#fff;background:rgba(255,255,255,.06)}
    .modal-body{padding:16px}

    /* ===== RESTORE YOUR ORIGINAL ROADMAP STYLES (no overrides that change sizes) ===== */
    .pill{display:inline-block;padding:8px 10px;border-radius:999px;background:linear-gradient(180deg,var(--accent1),var(--accent2));font-size:12px;font-weight:800;letter-spacing:.3px;box-shadow:0 0 16px rgba(183,132,255,.35)}
    .road-grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:860px){.road-grid{grid-template-columns:1.2fr .8fr}}
    .blox{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .blox h4{margin:0 0 8px 0;font-size:16px;letter-spacing:.2px}
    .blox p{margin:6px 0;color:#cfe0ff}
    .list{margin:8px 0 0 0;padding:0 0 0 18px;color:#cfe0ff}
    .list li{margin:6px 0}
    .grid-2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .statline{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
    .mini-mark{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--accent1),var(--accent2));box-shadow:0 0 10px rgba(183,132,255,.25)}
    .img-row{display:flex;gap:10px;flex-wrap:wrap}
    .img-row img{width:100px;height:100px;border-radius:12px;object-fit:cover;background:transparent}

    /* make the IZZA Token card the same width as one grid column and center it */
    .center-span{
      grid-column: 1 / -1;          /* span both columns so we can center it */
      justify-self: center;          /* center within the full row */
      width: 100%;
      max-width: calc((100% - 10px) / 2); /* EXACT width of a single column (grid gap is 10px) */
    }

    /* Reusable roadmap glow chip — tune per instance with CSS vars */
    .glow{
      --sz: 92px;
      --img: 54px;
      --offset-x: 0px;
      --offset-y: 0px;
      position:relative; width:var(--sz); height:var(--sz);
      border-radius:50%; margin:16px auto 0;
      display:flex; align-items:center; justify-content:center;
      transform: translate(var(--offset-x), var(--offset-y));
    }
    .glow::before{
      content:""; position:absolute; inset:calc(-0.18 * var(--sz));
      border-radius:inherit; pointer-events:none;
      animation:pulse 2.2s ease-in-out infinite;
      background: radial-gradient(circle at 50% 50%, var(--g1) 0%, var(--g2) 45%, transparent 72%);
      box-shadow: 0 0 calc(0.36 * var(--sz)) var(--s1), 0 0 calc(1.0 * var(--sz)) var(--s2);
    }
    .glow img{ width:var(--img); height:var(--img); border-radius:12px; position:relative; z-index:1; }

    .glow.violet{ --g1: rgba(var(--violet1),.40); --g2: rgba(var(--violet1),.10); --s1: rgba(var(--violet1),.45); --s2: rgba(var(--violet2),.30); }
    .glow.gold  { --g1: rgba(var(--gold),.42);   --g2: rgba(var(--gold),.12);   --s1: rgba(var(--gold),.45);   --s2: rgba(var(--gold),.32); }

    /* stack for roadmap chips */
    .glow-stack{ margin-top:12px; display:flex; flex-direction:column; align-items:center; gap:18px; }

    /* order book/price chart chrome */
    .ob-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .seg{display:inline-flex;border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden}
    .seg button{background:transparent;border:0;color:#cfe0ff;font-weight:700;padding:6px 10px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:rgba(122,68,255,.33)}
    .chart-wrap{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:10px;

  /* NEW: fixed height so Chart.js can lay out correctly in the modal */
  height:220px;
}
/* NEW: let canvas fill the box */
#izzaChart{ display:block; width:100%; height:100% }

    /* mini help */
    .help{color:#cfe0ff;font-size:12px;opacity:.9}

    /* center-span for roadmap card (already above, kept here for clarity) */
    /* (no extra overrides that alter sizes/positioning) */

    /* simple form */
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field input,.field select{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#fff;padding:10px;border-radius:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row2{grid-template-columns:1fr} }
    .tabbar{display:flex;gap:8px;margin-bottom:8px}
    .tabbar button{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:8px 10px;border-radius:10px;color:#fff;font-weight:800;cursor:pointer}
    .tabbar button[aria-pressed="true"]{background:rgba(122,68,255,.33)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="logo" href="{{ APP_BASE_URL or '/' }}" title="Back"
         onclick="try{history.back();}catch(_){/*fallback*/}">
        <img src="/static/izzapay-word.svg" alt="IZZA PAY">
      </a>

      <div class="top-cta" style="grid-column:1 / -1; width:100%">
        <button id="roadmapBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="roadmapModal">
          <img src="/static/izzapay-mark.svg" alt="" aria-hidden="true">
          View Mainnet Roadmap
        </button>
      </div>

      <div>
        <h1>IZZA — Test Token Showcase</h1>
        <p class="lead">Issuer, distributor, balances and activity on Pi Testnet.</p>
      </div>
      <div class="spacer"></div>
    </header>

    <section class="hero">
      <!-- LEFT: main token summary -->
      <div class="panel" style="position:relative;overflow:hidden">
        <div class="bg-weave" aria-hidden="true"></div>

        <div class="token-row">
          <!-- Main coin image with SMALLER glow -->
          <div class="token-img" id="coinWrap" style="--pulse-size: 80px; --pulse-offset-x: -42px; --pulse-offset-y: -36px;">
            <img id="coinImg" src="{{ url_for('serve_assets', filename='izza.png') }}" alt="IZZA token">
          </div>

        <!-- Pulsing mark opens the roadmap modal -->
          <div class="side-badge">
            <button id="badgeOpen" class="mark-wrap" type="button" title="Open Mainnet Roadmap">
              <img src="/static/izzapay-mark.svg" alt="IZZA mark">
            </button>
            <div class="arcade">Spin the coin</div>
            <div class="hint">(to refresh data)</div>
          </div>

          <div class="meta">
            <h2>IZZA <span style="opacity:.65">({{ ASSET_CODE }})</span></h2>
            <div class="small">Issuer: <span id="issuer" class="mono wrapaddr"></span></div>
            <div class="small" style="margin-top:2px">Distributor: <span id="distributor" class="mono wrapaddr"></span></div>
          </div>
        </div>

        <div class="two" style="margin-top:12px">
          <div class="stat">
            <div class="label">Distributor balance (IZZA)</div>
            <strong id="dist-balance">—</strong>
          </div>
          <div class="stat">
            <div class="label">Holders / trustlines</div>
            <strong id="trust-count">—</strong>
          </div>
        </div>

        <!-- Order book + order UI launchers -->
        <div class="top-cta" style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
          <button id="orderbookBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="orderbookModal">📊 Live Order Book</button>
          <button id="orderBtn" class="cta" type="button" aria-haspopup="dialog" aria-controls="placeOrderModal">🧾 Place Testnet Order</button>
        </div>
      </div> <!-- end left panel -->

      <!-- RIGHT: quick details + QR + activity dropdown -->
      <aside class="panel">
        <div class="card-title">
          <strong>Quick details</strong>
          <span class="small-muted">Pi Testnet</span>
        </div>

        <div class="grid">
          <div class="mini">
            <div class="ico"><img src="{{ url_for('serve_assets', filename='izza.png') }}" alt=""></div>
            <div>
              <div class="small-muted">Asset</div>
              <strong>{{ ASSET_CODE }}</strong>
            </div>
          </div>

          <div class="mini">
            <div class="ico purple"><img src="{{ url_for('serve_assets', filename='izza.png') }}" alt=""></div>
            <div>
              <div class="small-muted">Issuer</div>
              <div id="issuer-compact" class="mono" style="font-size:12px"></div>
            </div>
          </div>

          <div class="mini">
            <div class="ico">🧬</div>
            <div>
              <div class="small-muted">Origin</div>
              <div class="mono" style="font-size:12px">izzapay.onrender.com</div>
            </div>
          </div>

          <div class="mini">
            <div class="ico purple">🧩</div>
            <div>
              <div class="small-muted">Network</div>
              <div class="mono" style="font-size:12px">Pi Testnet</div>
            </div>
          </div>
        </div>

        <hr class="sep">

        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div>
            <div class="small-muted">Distributor</div>
            <div id="d-short" class="mono" style="font-size:12px"></div>
          </div>
          <div style="text-align:right">
            <div class="small-muted" style="margin-bottom:6px">Scan to add</div>
            <img id="qrimg" src="" alt="QR" width="120" height="120" style="border-radius:12px">
            <div class="small-muted" style="margin-top:6px;font-size:12px;max-width:220px">
              When this feature becomes available through Pi Network, you’ll be able to add this token using this QR code.
            </div>
          </div>
        </div>

        <details class="activity">
          <summary>Recent activity</summary>
          <div class="ops" id="recentOps">Loading…</div>
        </details>
      </aside>
    </section>

    <section class="lower">
      <div class="panel" id="linksPanel">
        <h3 style="margin:0 0 8px 0">Raw data & quick links</h3>
        <p class="small-muted" style="margin:4px 0 10px">Open Pi Testnet Horizon endpoints directly.</p>
        <div class="btnrow">
          <a class="linkbtn" id="link-account" href="#" target="_blank" rel="noopener">Distributor account</a>
          <a class="linkbtn" id="link-payments" href="#" target="_blank" rel="noopener">Payments</a>
          <a class="linkbtn" id="link-ops" href="#" target="_blank" rel="noopener">Operations</a>
          <a class="linkbtn" id="link-assets" href="#" target="_blank" rel="noopener">Asset lookup</a>
        </div>
      </div>

      <div class="panel" id="deepSection">
        <h3 style="margin:0 0 8px 0">Developer notes</h3>
        <div class="small-muted" style="margin-bottom:10px">
          Issuer / distributor details and last operations from Pi Testnet. This page is a showcase and diagnostic view for the token.
        </div>

        <div>
          <div class="small-muted">Deep Link</div>
          <pre style="margin-top:8px;white-space:pre-wrap;word-break:break-all;font-family:var(--mono);background:transparent;border:1px dashed rgba(255,255,255,.08);padding:10px;border-radius:10px" id="deepPre"></pre>
        </div>
      </div>
    </section>

    <footer>IZZA PAY — Testnet showcase · Built for demo & diagnostics</footer>
  </div>

  <!-- Modal Backdrop + Roadmap Modal -->
  <div class="modal-backdrop" id="modalBackdrop" hidden></div>
  <div class="modal" id="roadmapModal" role="dialog" aria-modal="true" aria-labelledby="roadmapTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="">
          <span id="roadmapTitle">MAINNET ROADMAP</span>
        </div>
        <button class="close-btn" type="button" id="closeModalBtn">Close</button>
      </div>
      <div class="modal-body">
        <span class="pill">Total Supply Target: 33.33 Billion (Mainnet)</span>

        <div class="road-grid" style="margin-top:12px">
          <div class="blox">
            <h4>Why a Token at All?</h4>
            <p>IZZA Coins power gameplay.<br><strong>IZZA Token</strong> powers the ecosystem.</p>
            <ul class="list">
              <li><strong>Governance</strong>: Vote on new mini-games, IZZA City expansions, creator marketplace rules.</li>
              <li><strong>Staking</strong>: Stake tokens to earn boosted Crafting Credits / seasonal IZZA Coin boosts.</li>
              <li><strong>Access</strong>: Token-gated drops, rare blueprints, early creator tools.</li>
              <li><strong>Biz Utility</strong>: Merchant fee discounts and premium IZZA Pay tiers for holders.</li>
              <li><strong>Dev Listing</strong>: Arcade listings prioritized via stake + quality score.</li>
            </ul>

            <div class="img-row" style="margin-top:10px">
              <img src="{{ url_for('serve_assets', filename='izza.png') }}" alt="IZZA coin">
              <img src="/static/izzapay-mark.svg" alt="IZZA mark">
            </div>
          </div>

          <div class="blox">
            <h4>Economy Layering</h4>
            <div class="grid-2">
              <div class="statline">
                <div class="mini-mark" aria-hidden="true" style="font-size:18px;line-height:1">👾</div>
                <div><strong>IZZA Coins</strong><div class="small" style="color:var(--muted)">Soft in-game currency</div></div>
              </div>
              <div class="statline">
                <div class="mini-mark">💎</div>
                <div><strong>Crafting Credits</strong><div class="small" style="color:var(--muted)">Premium consumable via Pi</div></div>
              </div>
              <div class="statline center-span">
                <div class="mini-mark"><img src="{{ url_for('serve_assets', filename='izza.png') }}" alt="" style="width:18px;height:18px"></div>
                <div style="text-align:center;width:100%">
                  <strong>IZZA Token</strong>
                  <div class="small" style="color:var(--muted)">Scarce, stake + govern</div>
                </div>
              </div>
            </div>
            <p style="margin-top:10px">Peg reference stays for in-game economics (2,000 Coins ≈ 1 Pi). Token remains <em>non-inflationary</em> with utility via staking + access.</p>
          </div>
        </div>

        <div class="blox" style="margin-top:12px">
          <h4>Distribution Plan (Illustrative)</h4>
          <div class="grid-2">
            <ul class="list">
              <li><strong>40%</strong> Growth: public sale + staking rewards</li>
              <li><strong>25%</strong> Ecosystem: new games, marketplace, tools</li>
              <li><strong>20%</strong> Team: 12-month cliff, 36-month vest</li>
              <li><strong>10%</strong> Partners: merchants, collabs</li>
              <li><strong>5%</strong> Community: airdrops for early testers</li>
            </ul>
            <div>
              <p style="margin:4px 0 0 0;color:#cfe0ff">
                Vesting &amp; emissions published on-chain. Staking yields are dynamic and balanced vs. arcade earnings to avoid inflation shocks.
              </p>

              <!-- Smaller, tidy glow chips (unchanged sizes/positioning) -->
              <div class="glow-stack" style="margin-top:14px;">
                <div class="glow violet" style="--sz: 45px; --img: 48px; --offset-x: 0px; --offset-y: -4px;">
                  <img src="/static/izzapay-mark.svg" alt="">
                </div>
                <div class="glow gold" style="--sz: 40px; --img: 66px; --offset-x: 0px; --offset-y: 6px;">
                  <img src="{{ url_for('serve_assets', filename='izza.png') }}" alt="IZZA coin">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="blox" style="margin-top:12px">
          <h4>Launch Roadmap</h4>
          <ul class="list">
            <li><strong>Phase 1 — Testnet Live</strong>: Issuer/distributor diagnostics, faucet &amp; trustlines, IZZA City + Arcade earn loop validated.</li>
            <li><strong>Phase 2 — Staking Beta</strong>: Token staking → soft boosts to Crafting Credit earnings, seasonal badges, holder quests.</li>
            <li><strong>Phase 3 — Governance v1</strong>: On-chain votes for new Arcade titles, blueprint rarity schedules, and marketplace fees.</li>
            <li><strong>Phase 4 — Merchant Utility</strong>: IZZA Pay fee rebates for holders, business dashboards with token-gated promos.</li>
            <li><strong>Phase 5 — Mainnet Mint (33.33B)</strong>: Final supply + vesting on chain, liquidity bootstrapping, cross-ecosystem creator drops.</li>
          </ul>
        </div>

        <div class="blox" style="margin-top:12px">
          <h4>Value Loop</h4>
          <p>Players earn Coins → buy Crafting Credits (via Pi) → craft &amp; trade → creators/merchants thrive. <strong>IZZA Token</strong> captures upside by governing, staking, and unlocking the best parts of the ecosystem.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ORDER BOOK MODAL (reuses backdrop) -->
  <div class="modal" id="orderbookModal" role="dialog" aria-modal="true" aria-labelledby="orderbookTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="">
          <span id="orderbookTitle">IZZA / Pi — Order Book</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <a id="addTrustBtn" class="close-btn" style="text-decoration:none" href="#deepSection">Add Trustline (SEP-7)</a>
          <button class="close-btn" type="button" id="closeOrderbookBtn">Close</button>
        </div>
      </div>
      <div class="modal-body">
        <!-- Chart toolbar -->
        <div class="ob-toolbar" style="margin-bottom:10px">
          <div class="seg" role="tablist" aria-label="Chart range">
            <button class="rangeBtn" data-range="1D" aria-pressed="true">1D</button>
            <button class="rangeBtn" data-range="1W">1W</button>
            <button class="rangeBtn" data-range="1M">1M</button>
            <button class="rangeBtn" data-range="1Y">1Y</button>
            <button class="rangeBtn" data-range="ALL">ALL</button>
          </div>
          <span class="help">Purple = Price (Pi/IZZA), Gold = Volume</span>
        </div>

        <div class="chart-wrap">
          <canvas id="izzaChart"></canvas>
        </div>

        <div class="row" style="margin:12px 0">
          <div class="pill">Best Ask: <span id="obBestAsk">–</span> Pi</div>
          <div class="pill">Best Bid: <span id="obBestBid">–</span> Pi</div>
          <div class="pill">Spread: <span id="obSpread">–</span></div>
          <div class="pill">Total Asks: <span id="obSumAsks">–</span> IZZA</div>
          <div class="pill">Updated: <span id="obUpdated">–</span></div>
        </div>

        <div class="grid" style="gap:12px">
          <div class="blox">
            <h4 style="margin:0 0 8px 0">Sell Orders (Asks) — price in Pi</h4>
            <table id="asksTbl" style="width:100%;border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Price (Pi)</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Amount (IZZA)</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Total (Pi)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="blox">
            <h4 style="margin:0 0 8px 0">Buy Orders (Bids) — price in Pi</h4>
            <table id="bidsTbl" style="width:100%;border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Price (Pi)</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Amount (IZZA)</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">Total (Pi)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="small-muted" style="margin-top:10px">
          Data source: Pi Testnet Horizon. Auto-refreshes every 10s. <a id="rawOrderbookLink" target="_blank" rel="noopener" style="color:#8ab4ff">Raw JSON</a>
        </div>
      </div>
    </div>
  </div>

  <!-- PLACE ORDER MODAL -->
  <div class="modal" id="placeOrderModal" role="dialog" aria-modal="true" aria-labelledby="placeOrderTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="">
          <span id="placeOrderTitle">Place Testnet Order</span>
        </div>
        <button class="close-btn" type="button" id="closePlaceOrderBtn">Close</button>
      </div>
      <div class="modal-body">
        <div id="walletCreateRow" class="row" style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
  <button id="createWalletBtn" type="button" class="cta">✚ Create Test Wallet</button>
  <div id="walletStatus" class="help" aria-live="polite"></div>
</div>

<!-- Shows after creation -->
<div id="newWalletBox" class="blox" style="display:none;margin-bottom:10px">
  <h4 style="margin:0 0 6px 0">Your IZZA Test Wallet</h4>
  <div class="small-muted">Public Key</div>
  <div id="newPub" class="mono" style="word-break:break-all;margin:4px 0 8px"></div>

  <div class="grid" style="gap:12px">
    <div>
      <div class="small-muted" style="margin-bottom:6px">Scan to Fund (Testnet)</div>
      <canvas id="newWalletQR" width="120" height="120" style="border-radius:12px;background:#fff"></canvas>
    </div>
    <div class="help" style="align-self:center">
      <strong>Next step:</strong> Open your <em>Pi Testnet</em> wallet and send
      <strong>~2.0 test&nbsp;Pi</strong> to the public key above.
      This activates the wallet (CreateAccount) and gives room to add the IZZA trustline.
      We never fund or custody your wallet.
    </div>
  </div>

  <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
    <button id="checkFundingBtn" type="button" class="cta">Check Funding</button>
    <button id="addTrustlineBtn" type="button" class="cta" disabled>➕ Add IZZA Trustline</button>
  </div>
</div>
        <div class="help" style="margin-bottom:8px">
          <strong>Note:</strong> Pi Wallet does not yet support direct order placement.
          This demo will work in other wallets that support <strong>SEP-7</strong> transactions.
        </div>

        <div class="tabbar" role="tablist" aria-label="Side">
          <button class="sideBtn" data-side="BUY" aria-pressed="true">BUY IZZA</button>
          <button class="sideBtn" data-side="SELL">SELL IZZA</button>
        </div>

        <div class="tabbar" role="tablist" aria-label="Type">
          <button class="typeBtn" data-type="LIMIT" aria-pressed="true">Limit</button>
          <button class="typeBtn" data-type="MARKET">Market</button>
        </div>

        <!-- Inline explainers + slippage UI (Market only) -->
        <div id="orderHelp" class="help" style="margin:8px 0 10px" aria-live="polite">
          Limit: you set the price. Market: we auto-use the best available price ± slippage.
        </div>
        <div id="slipRow" class="row2" style="display:none">
          <div class="field">
            <label>Slippage (%)</label>
            <input id="slippagePct" type="number" step="0.1" min="0" max="50" value="3" inputmode="decimal">
          </div>
          <div class="field" style="align-self:end">
            <label class="small-muted" style="display:block;margin-bottom:6px">Consent</label>
            <label style="display:flex;gap:8px;align-items:flex-start">
              <input id="agreeSlippage" type="checkbox">
              <span>I accept execution up to <span id="slipEcho">3</span>% away from the best price.</span>
            </label>
          </div>
        </div>
        <div id="autoPriceNote" class="help" style="display:none;margin:-4px 0 8px">
          Estimated execution price: <strong id="autoPricePreview">—</strong> Pi / IZZA (will update on submit).
        </div>

        <form id="orderForm">
          <div class="field">
            <label>Public Key (your account)</label>
            <input id="acctPub" type="text" placeholder="G... (testnet account)" required>
          </div>

          <div class="row2">
            <div class="field">
              <label>Price (Pi / IZZA)</label>
              <input id="price" type="number" step="0.0000001" inputmode="decimal" placeholder="e.g. 0.005" required>
            </div>
            <div class="field">
              <label>Amount (IZZA)</label>
              <input id="amount" type="number" step="0.0000001" inputmode="decimal" placeholder="e.g. 2000" required>
            </div>
          </div>

          <div class="field">
            <button id="buildSep7" type="submit" class="cta" style="width:max-content">Open in SEP-7 Wallet</button>
          </div>

          <div class="help" id="orderMsg" aria-live="polite"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- libs (from CDN) -->
  <!-- better: Chart first, then adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.5.1/stellar-sdk.min.js" integrity="sha512-+uYc8WQvG8c+0pT1+QqJp5gR1+N1iFj3F1p7Xw8eNsQqA+8k0vP9a6NqEgbjG7e0oZ2FQg3e3sH4q1P5gFKM0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
(() => {
  // =================== Config from Jinja / server ===================
  const ASSET_CODE  = "{{ ASSET_CODE }}";
  const ISSUER      = "{{ ISSUER }}";
  const DISTRIBUTOR = "{{ DISTRIBUTOR }}";
  const API_BASE    = "{{ API_BASE }}";
  const DEEP_LINK   = "{{ DEEP_LINK }}";

  // =================== Tiny logger (+ global error taps) ===================
  function log(evt, extra){
    try{
      const payload = { t:new Date().toISOString(), evt, extra:extra||null,
                        ua:(navigator&&navigator.userAgent)||'unknown',
                        href:(location&&location.href)||'' };
      console.log('[IZZA]', payload);
      fetch('/_client-log', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).catch(()=>{});
    }catch(_){}
  }
  window.addEventListener('error', e=>log('window.error',{msg:String(e.message||e),stack:e.error&&e.error.stack||null}));
  window.addEventListener('unhandledrejection', e=>log('unhandledrejection',{reason:String(e.reason||'unknown')}));

  // =================== Safe script loader (for WebViews/iOS) ===================
  function loadScriptOnce(id, src){
    return new Promise((resolve,reject)=>{
      if (document.getElementById(id)) return resolve(true);
      const s = document.createElement('script');
      s.id = id; s.src = src; s.async = true; s.crossOrigin = 'anonymous';
      s.onload = ()=>resolve(true);
      s.onerror = ()=>reject(new Error('load-failed:'+src));
      document.head.appendChild(s);
    });
  }
  async function ensureStellar(){
  if (window.StellarSdk) return true;
  log('stellar.ensure.start');
  const sources = [
    '/static/stellar-sdk.min.js', // NEW: self-hosted first
    'https://cdn.jsdelivr.net/npm/stellar-sdk@10.5.1/dist/stellar-sdk.min.js',
    'https://unpkg.com/stellar-sdk@10.5.1/dist/stellar-sdk.min.js'
  ];
  for (let i=0;i<sources.length;i++){
    try{
      await loadScriptOnce('stellar-sdk-'+i, sources[i]);
      if (window.StellarSdk){ log('stellar.ensure.ok',{i,src:sources[i]}); return true; }
    }catch(e){ log('stellar.ensure.fail.try',{i,err:String(e)}); }
  }
  log('stellar.ensure.fail.all'); return false;
}

async function ensureChart(){
  // Chart.js
  if (!window.Chart){
    log('chart.ensure.chart.start');
    const urls = [
      '/static/chart.umd.min.js', // NEW: self-hosted first
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
      'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'
    ];
    for (let i=0;i<urls.length && !window.Chart;i++){
      try{ await loadScriptOnce('chartjs-'+i, urls[i]); }catch(e){ log('chart.ensure.chart.fail.try',{i,err:String(e)}); }
    }
    if (!window.Chart){ log('chart.ensure.chart.fail.all'); return false; }
    log('chart.ensure.chart.ok');
  }
  // time adapter
  if (!Chart._adapters || !Chart._adapters._date){
    log('chart.ensure.adapter.start');
    const urls = [
      '/static/chartjs-adapter-date-fns.min.js', // NEW: self-hosted first
      'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3',
      'https://unpkg.com/chartjs-adapter-date-fns@3'
    ];
    for (let i=0;i<urls.length && (!Chart._adapters || !Chart._adapters._date); i++){
      try{ await loadScriptOnce('chartjs-adapter-'+i, urls[i]); }catch(e){ log('chart.ensure.adapter.fail.try',{i,err:String(e)}); }
    }
    if (!Chart._adapters || !Chart._adapters._date){ log('chart.ensure.adapter.fail.all'); return false; }
    log('chart.ensure.adapter.ok');
  }
  return true;
}

  // =================== Static DOM wiring ===================
  const issuerEl       = document.getElementById('issuer');
  const distributorEl  = document.getElementById('distributor');
  const distBalanceEl  = document.getElementById('dist-balance');
  const trustCountEl   = document.getElementById('trust-count');
  const issuerCompact  = document.getElementById('issuer-compact');
  const dshort         = document.getElementById('d-short');
  const qrimg          = document.getElementById('qrimg');
  const deepPre        = document.getElementById('deepPre');
  const recentOpsEl    = document.getElementById('recentOps');

  issuerEl.textContent = ISSUER;
  distributorEl.textContent = DISTRIBUTOR;
  issuerCompact.textContent = ISSUER.slice(0,6) + '…' + ISSUER.slice(-6);
  dshort.textContent = DISTRIBUTOR.slice(0,8) + '…' + DISTRIBUTOR.slice(-6);
  deepPre.textContent = DEEP_LINK;

  const accountUrl = `${API_BASE}/accounts/${DISTRIBUTOR}`;
  document.getElementById('link-account').href  = accountUrl;
  document.getElementById('link-payments').href = `${accountUrl}/payments`;
  document.getElementById('link-ops').href      = `${accountUrl}/operations`;
  document.getElementById('link-assets').href   = `${API_BASE}/assets?asset_code=${encodeURIComponent(ASSET_CODE)}&asset_issuer=${encodeURIComponent(ISSUER)}`;

  const qrData = encodeURIComponent(DEEP_LINK);
  qrimg.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${qrData}`;

  // =================== Summary fetch ===================
  async function fetchSummary(){
    try{
      const [acctRes, holdersRes, opsRes] = await Promise.all([
        fetch(`${API_BASE}/accounts/${DISTRIBUTOR}`),
        fetch(`${API_BASE}/accounts?asset=${encodeURIComponent(ASSET_CODE)}:${encodeURIComponent(ISSUER)}`),
        fetch(`${API_BASE}/accounts/${DISTRIBUTOR}/operations?limit=6&order=desc`)
      ]);
      const acctJson = acctRes.ok ? await acctRes.json() : null;
      const holders  = holdersRes.ok ? await holdersRes.json() : null;
      const opsJson  = opsRes.ok ? await opsRes.json() : null;

      let izzaBal = '0';
      if (acctJson && Array.isArray(acctJson.balances)) {
        const line = acctJson.balances.find(b => b.asset_type !== 'native' && b.asset_code === ASSET_CODE && b.asset_issuer === ISSUER);
        izzaBal = line ? String(line.balance) : '0';
      }
      distBalanceEl.textContent = izzaBal;

      const count = (holders && holders._embedded && holders._embedded.records) ? holders._embedded.records.length : 0;
      trustCountEl.textContent = count;

      let opsHtml = '';
      const recs = opsJson && opsJson._embedded ? opsJson._embedded.records : [];
      if (recs && recs.length){
        recs.forEach(op=>{
          const t = op.type || 'operation';
          const when = op.created_at ? new Date(op.created_at).toLocaleString() : '';
          const msg = (op.asset_code ? op.asset_code : (op.asset || 'native')) + (op.to ? ` → ${op.to.slice(0,8)}…` : '');
          opsHtml += `<div class="op"><span class="t">${t}</span><div class="m">${msg}</div><div class="m">${when}</div></div>`;
        });
      } else { opsHtml = '<div class="m">No recent activity.</div>'; }
      recentOpsEl.innerHTML = opsHtml;
    } catch(e){
      distBalanceEl.textContent = '—';
      trustCountEl.textContent  = '—';
      recentOpsEl.textContent   = 'Error loading recent activity';
      log('summary.fail',{err:String(e)});
    }
  }
  fetchSummary();

  // =================== Modal wiring (only one open at a time) ===================
  const roadmapBtn    = document.getElementById('roadmapBtn');
  const badgeOpen     = document.getElementById('badgeOpen');
  const modal         = document.getElementById('roadmapModal');
  const orderbookBtn  = document.getElementById('orderbookBtn');
  const orderbookModal= document.getElementById('orderbookModal');
  const closeOrderbookBtn = document.getElementById('closeOrderbookBtn');
  const placeOrderModal   = document.getElementById('placeOrderModal');
  const orderBtn          = document.getElementById('orderBtn');
  const closePlaceOrderBtn= document.getElementById('closePlaceOrderBtn');
  const backdrop      = document.getElementById('modalBackdrop');
  const closeModalBtn = document.getElementById('closeModalBtn');
  let lastFocus = null;

  function openModal(el, focusEl){
    lastFocus = document.activeElement;
    [modal, orderbookModal, placeOrderModal].forEach(m=>{ m.hidden = true; m.removeAttribute('open'); });
    el.hidden = false; backdrop.hidden = false;
    el.setAttribute('open',''); backdrop.setAttribute('open','');
    document.body.style.overflow = 'hidden';
    (focusEl || el.querySelector('.close-btn'))?.focus?.();
  }
  function closeModal(el){
    el.removeAttribute('open'); backdrop.removeAttribute('open');
    el.hidden = true; backdrop.hidden = true;
    document.body.style.overflow = '';
    lastFocus?.focus?.();
  }
  roadmapBtn.addEventListener('click', ()=>openModal(modal, closeModalBtn));
  badgeOpen.addEventListener('click', ()=>openModal(modal, closeModalBtn));
  closeModalBtn.addEventListener('click', ()=>closeModal(modal));

  backdrop.addEventListener('click', ()=>{
    if (!orderbookModal.hidden){ stopObRefresh(); }
    [modal, orderbookModal, placeOrderModal].forEach(m=>{ if(!m.hidden) closeModal(m); });
  });

  // =================== Order book endpoints ===================
  const ORDERBOOK_URL = `${API_BASE}/order_book`
    + `?selling_asset_type=credit_alphanum4`
    + `&selling_asset_code=${encodeURIComponent(ASSET_CODE)}`
    + `&selling_asset_issuer=${encodeURIComponent(ISSUER)}`
    + `&buying_asset_type=native`;

  const TRADES_URL = `${API_BASE}/trades`
    + `?base_asset_type=credit_alphanum4`
    + `&base_asset_code=${encodeURIComponent(ASSET_CODE)}`
    + `&base_asset_issuer=${encodeURIComponent(ISSUER)}`
    + `&counter_asset_type=native`
    + `&order=desc&limit=200`;

  document.getElementById('rawOrderbookLink').href = ORDERBOOK_URL;

  // =================== Order book table UI ===================
  const obBestAsk = document.getElementById('obBestAsk');
  const obBestBid = document.getElementById('obBestBid');
  const obSpread  = document.getElementById('obSpread');
  const obSumAsks = document.getElementById('obSumAsks');
  const obUpdated = document.getElementById('obUpdated');

  function num(x, dp=7){ const n = Number(x); return isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:dp, maximumFractionDigits:dp}) : '–'; }
  function sum(arr, key){ return arr.reduce((a,b)=>a + Number(b[key]||0), 0); }

  async function loadOrderbook(){
    try{
      const res  = await fetch(ORDERBOOK_URL, {cache:'no-store'});
      const data = await res.json();

      const asks = (data.asks || []).map(r => ({ price: Number(r.price), amount: Number(r.amount) }));
      const bids = (data.bids || []).map(r => ({ price: Number(r.price), amount: Number(r.amount) }));

      const bestAsk = asks.length ? Math.min(...asks.map(a=>a.price)) : null;
      const bestBid = bids.length ? Math.max(...bids.map(b=>b.price)) : null;
      const spread  = (bestAsk!=null && bestBid!=null) ? bestAsk - bestBid : null;

      obBestAsk.textContent = bestAsk!=null ? num(bestAsk,4) : '–';
      obBestBid.textContent = bestBid!=null ? num(bestBid,4) : '–';
      obSpread.textContent  = spread!=null  ? num(spread,4)  : '–';
      obSumAsks.textContent = asks.length ? num(sum(asks,'amount'),2) : '0';
      obUpdated.textContent = new Date().toLocaleTimeString();

      const asksBody = document.querySelector('#asksTbl tbody');
      const bidsBody = document.querySelector('#bidsTbl tbody');
      asksBody.innerHTML = ''; bidsBody.innerHTML = '';

      asks.sort((a,b)=>a.price-b.price).slice(0,50).forEach(a=>{
        const total = a.price * a.amount;
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td style="text-align:left;padding:8px">${num(a.price,4)}</td>`+
          `<td style="text-align:right;padding:8px">${num(a.amount,2)}</td>`+
          `<td style="text-align:right;padding:8px">${num(total,4)}</td>`;
        asksBody.appendChild(tr);
      });

      bids.sort((a,b)=>b.price-a.price).slice(0,50).forEach(b=>{
        const total = b.price * b.amount;
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td style="text-align:left;padding:8px">${num(b.price,4)}</td>`+
          `<td style="text-align:right;padding:8px">${num(b.amount,2)}</td>`+
          `<td style="text-align:right;padding:8px">${num(total,4)}</td>`;
        bidsBody.appendChild(tr);
      });
    }catch(err){
      log('ob.fail',{err:String(err)});
    }
  }

  // =================== Chart (ensure libs, draw after visible) ===================
  let izzaChart = null;
  let allPoints = [];
  let obTimer = null;
  // NEW: keep the chart sized to its container
const chartCanvas = document.getElementById('izzaChart');
const ro = new ResizeObserver(()=>{ try{ izzaChart && izzaChart.resize(); }catch(_){ } });
if (chartCanvas && chartCanvas.parentElement) ro.observe(chartCanvas.parentElement);
  function startObRefresh(){
    if(obTimer) clearInterval(obTimer);
    obTimer = setInterval(()=>{ if(!orderbookModal.hidden){ loadOrderbook(); loadTradesAndDraw(); } }, 10000);
  }
  function stopObRefresh(){ if(obTimer) clearInterval(obTimer); obTimer=null; }

  const rangeBtns = Array.from(document.querySelectorAll('.rangeBtn'));
  let activeRange = '1D';
  rangeBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      rangeBtns.forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      activeRange = b.dataset.range;
      drawChart();
    });
  });

  function msAgo(n){ return Date.now() - n; }
  function filteredByRange(){
    if(!allPoints.length) return [];
    let cutoff = 0;
    switch(activeRange){
      case '1D':  cutoff = msAgo(24*3600*1000); break;
      case '1W':  cutoff = msAgo(7*24*3600*1000); break;
      case '1M':  cutoff = msAgo(30*24*3600*1000); break;
      case '1Y':  cutoff = msAgo(365*24*3600*1000); break;
      case 'ALL': default: return allPoints;
    }
    return allPoints.filter(p => p.t.getTime() >= cutoff);
  }

  async function loadTradesAndDraw(){
    const ok = await ensureChart();
    if(!ok){
      document.querySelector('.chart-wrap')?.insertAdjacentHTML('beforeend',
        `<div class="help" style="margin-top:6px;color:#ffb3b3">Chart libraries couldn’t load.</div>`);
      return;
    }
    try{
      const res = await fetch(TRADES_URL, {cache:'no-store'});
      const data = await res.json();
      const recs = (data._embedded && data._embedded.records) ? data._embedded.records : [];
      allPoints = recs.map(r=>{
        const izza = Number(r.base_amount);
        const pi   = Number(r.counter_amount);
        const fallback = (r.price && r.price.n && r.price.d) ? (r.price.n/r.price.d) : NaN;
        const price = (izza > 0) ? (pi / izza) : Number(fallback);
        return { t: new Date(r.ledger_close_time || r.created_at), price, vol: izza };
      }).reverse();
      requestAnimationFrame(drawChart); // ensures canvas has layout in modal
    }catch(e){
      document.querySelector('.chart-wrap')?.insertAdjacentHTML(
        'beforeend',
        `<div class="help" style="margin-top:6px;color:#ffb3b3">Couldn’t load trades: ${String(e)}</div>`
      );
      log('chart.trades.fail',{err:String(e)});
    }
  }

  function drawChart(){
    if (!window.Chart){ return; }
    const canvas = document.getElementById('izzaChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const pts = filteredByRange();
    const labels = pts.map(p=>p.t);
    const prices = pts.map(p=>p.price);
    const vols   = pts.map(p=>p.vol);

    if(izzaChart){ try{ izzaChart.destroy(); }catch(_){} }

    izzaChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { type: 'line', label: 'Price (Pi/IZZA)', data: prices, yAxisID: 'y',
            tension: 0.3, borderColor: '#7a44ff', backgroundColor: 'rgba(122,68,255,0.25)',
            pointRadius: 0, borderWidth: 2 },
          { type: 'bar', label: 'Volume (IZZA)', data: vols, yAxisID: 'y1',
            backgroundColor: '#ffcd60', borderWidth: 0 }
        ]
      },
      options: {
        animation: false, maintainAspectRatio: false,
        scales: {
          x: { type: 'time', time: { unit: pickTimeUnit() },
               grid:{ color:'rgba(255,255,255,0.06)' }, ticks:{ color:'#cfe0ff' } },
          y: { position: 'left', grid:{ color:'rgba(255,255,255,0.06)' }, ticks:{ color:'#cfe0ff' } },
          y1:{ position: 'right', grid:{ display:false }, ticks:{ color:'#ffcd60' } }
        },
        plugins: { legend:{ labels:{ color:'#cfe0ff' } },
          tooltip:{ mode:'index', intersect:false, callbacks:{
            label:(ctx)=> ctx.dataset.yAxisID==='y'
              ? ` Price: ${Number(ctx.parsed.y).toFixed(6)} Pi`
              : ` Volume: ${Number(ctx.parsed.y).toLocaleString()} IZZA`
          }}}
      }
    });
  }
  function pickTimeUnit(){
    switch(activeRange){
      case '1D': return 'hour';
      case '1W': return 'day';
      case '1M': return 'day';
      case '1Y': return 'month';
      default:   return 'day';
    }
  }

  // Open Orderbook (ensure chart libs first)
  orderbookBtn.addEventListener('click', async ()=>{
  openModal(orderbookModal, closeOrderbookBtn);
  await ensureChart();
  loadOrderbook();
  loadTradesAndDraw();
  startObRefresh();

  // Ensure Chart.js measures after the modal is visible
  requestAnimationFrame(()=>{ try{ izzaChart && izzaChart.resize(); }catch(_){} });
});
  closeOrderbookBtn.addEventListener('click', ()=>{ stopObRefresh(); closeModal(orderbookModal); });
  closePlaceOrderBtn.addEventListener('click', ()=>{ closeModal(placeOrderModal); });

  // =================== Orders / Wallet (with Stellar ensure) ===================
  const sideBtns  = Array.from(document.querySelectorAll('.sideBtn'));
  const typeBtns  = Array.from(document.querySelectorAll('.typeBtn'));
  let side = 'BUY';  // BUY => receive IZZA, spend Pi
  let otype = 'LIMIT';

  sideBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      sideBtns.forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      side = b.dataset.side;
    });
  });

  const orderHelp   = document.getElementById('orderHelp');
  const slipRow     = document.getElementById('slipRow');
  const slippagePct = document.getElementById('slippagePct');
  const agreeSlip   = document.getElementById('agreeSlippage');
  const slipEcho    = document.getElementById('slipEcho');
  const autoNote    = document.getElementById('autoPriceNote');
  const autoPreview = document.getElementById('autoPricePreview');
  slippagePct.addEventListener('input', ()=>{ slipEcho.textContent = slippagePct.value || '0'; });

  const orderForm = document.getElementById('orderForm');
  const acctPub   = document.getElementById('acctPub');
  const priceEl   = document.getElementById('price');
  const amtEl     = document.getElementById('amount');
  const orderMsg  = document.getElementById('orderMsg');

  typeBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      typeBtns.forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      otype = b.dataset.type;

      const isMarket = (otype === 'MARKET');
      priceEl.disabled    = isMarket;
      priceEl.required    = !isMarket;
      priceEl.placeholder = isMarket ? 'auto (best price ± slippage)' : 'e.g. 0.005';

      slipRow.style.display = isMarket ? '' : 'none';
      autoNote.style.display= isMarket ? '' : 'none';
      if (!isMarket) { agreeSlip.checked = false; }

      orderHelp.textContent = isMarket
        ? 'Market: we auto-use the best available price with your slippage cap. Any remainder may rest as an offer.'
        : 'Limit: you set the price; it fills if it crosses the book, otherwise rests until matched.';
    });
  });

  const buildBtn = document.getElementById('buildSep7');
  function setOrderReady(ready){
    buildBtn.disabled = !ready;
    buildBtn.textContent = ready
      ? 'Open in SEP-7 Wallet'
      : 'Waiting for funding & trustline…';
  }
  setOrderReady(false);

  const SEP7_PREFIX = `web+stellar:tx?`;
  const NETWORK_PASSPHRASE = 'Pi Testnet';

  async function getAutoPrice(side, slippage = 0.03){
    try{
      const res = await fetch(
        `${API_BASE}/order_book?selling_asset_type=credit_alphanum4`+
        `&selling_asset_code=${encodeURIComponent(ASSET_CODE)}`+
        `&selling_asset_issuer=${encodeURIComponent(ISSUER)}`+
        `&buying_asset_type=native`,
        { cache:'no-store' }
      );
      const ob = await res.json();
      const asks = (ob.asks||[]).map(r=>Number(r.price));
      const bids = (ob.bids||[]).map(r=>Number(r.price));
      const bestAsk = asks.length ? Math.min(...asks) : null;
      const bestBid = bids.length ? Math.max(...bids) : null;

      if(side === 'BUY' && bestAsk!=null)  return bestAsk * (1 + slippage);
      if(side === 'SELL' && bestBid!=null) return bestBid * (1 - slippage);
      return null;
    }catch(_){ return null; }
  }

  orderForm.addEventListener('submit', async (e)=>{
    e.preventDefault();

    if (buildBtn.disabled) {
      orderMsg.textContent = 'Fund wallet & add the IZZA trustline first.';
      return;
    }

    // Ensure Stellar SDK before building any tx
    const stellarOK = await ensureStellar();
    if (!stellarOK || !window.StellarSdk){
      orderMsg.innerHTML = `<span style="color:#ffb3b3">Couldn’t load Stellar SDK in this WebView. Try opening in Safari/Chrome.</span>`;
      return;
    }

    try{
      const pub = acctPub.value.trim();
      const amount = Number(amtEl.value);
      if(!pub || !isFinite(amount) || amount<=0){
        orderMsg.textContent = 'Please provide a valid account and amount.'; return;
      }

      let price = Number(priceEl.value);
      if(otype === 'LIMIT'){
        if(!isFinite(price) || price<=0){
          orderMsg.textContent = 'Please provide a valid limit price.'; return;
        }
      } else {
        const slip = Math.max(0, Math.min(50, Number(slippagePct.value||0))) / 100;
        if (!agreeSlip.checked){
          orderMsg.textContent = 'Please accept the slippage consent to place a market order.'; return;
        }
        orderMsg.textContent = 'Finding best price…';
        const auto = await getAutoPrice(side, slip);
        price = (auto && isFinite(auto)) ? auto :  (side === 'BUY' ?  1e9 : 1e-9);
        autoPreview.textContent = (auto && isFinite(auto)) ? Number(auto).toFixed(7) : '—';
      }

      orderMsg.textContent = 'Building unsigned transaction…';

      const server = new StellarSdk.Server(API_BASE);
      const acct   = await server.loadAccount(pub);

      const izza  = new StellarSdk.Asset(ASSET_CODE, ISSUER);
      const native= StellarSdk.Asset.native();

      let op;
      if(side === 'SELL'){
        op = StellarSdk.Operation.manageSellOffer({
          selling: izza, buying: native, amount: amount.toString(), price: price.toString()
        });
      }else{
        op = StellarSdk.Operation.manageBuyOffer({
          buying: izza, selling: native, buyAmount: amount.toString(), price: price.toString()
        });
      }

      const tx = new StellarSdk.TransactionBuilder(
        acct,
        { fee: (await server.fetchBaseFee()).toString(), networkPassphrase: NETWORK_PASSPHRASE }
      ).addOperation(op).setTimeout(180).build();

      const xdr = tx.toXDR();
      const uri = `${SEP7_PREFIX}xdr=${encodeURIComponent(xdr)}&network_passphrase=${encodeURIComponent(NETWORK_PASSPHRASE)}`;

      orderMsg.innerHTML = `Opening your wallet… If nothing happens, copy this URI into a wallet that supports <strong>SEP-7</strong>:<br><code style="word-break:break-all">${uri}</code>`;
      window.location.href = uri;

    }catch(err){
      log('order.tx.fail',{err:String(err)});
      orderMsg.textContent = 'Could not build the transaction (check account on testnet, CORS, or network). You can still copy the URI above when available.';
    }
  });

  // =================== Create Test Wallet (await Stellar) ===================
const createBtn       = document.getElementById('createWalletBtn');
const statusEl        = document.getElementById('walletStatus');
const box             = document.getElementById('newWalletBox');
const newPubEl        = document.getElementById('newPub');
const newQRCanvas     = document.getElementById('newWalletQR');
const checkFundingBtn = document.getElementById('checkFundingBtn');
const addTrustlineBtn = document.getElementById('addTrustlineBtn');
const acctPubInput    = document.getElementById('acctPub');

let NEW_WALLET = null;

function drawQR(canvas, text){
  try{
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#000';
    ctx.font = '10px monospace';
    const lines = text.match(/.{1,16}/g) || [text];
    lines.slice(0,7).forEach((ln,i)=>ctx.fillText(ln, 6, 16 + i*16));
  }catch(e){ log('wallet.qr.fail',{err:String(e)}); }
}
async function isFunded(pub){
  try{ const res = await fetch(`${API_BASE}/accounts/${pub}`, {cache:'no-store'}); return res.ok; }
  catch(_){ return false; }
}

createBtn.addEventListener('click', async ()=>{
  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk){
    statusEl.innerHTML = `<span style="color:#ffb3b3">Couldn’t load Stellar SDK (blocked by CSP/CDN/SRI). Try a modern browser, or host /static/stellar-sdk.min.js.</span>`;
    return;
  }
  if (!window.crypto || !window.crypto.getRandomValues){
    statusEl.innerHTML = `<span style="color:#ffb3b3">This browser/WebView lacks secure randomness (WebCrypto). Can’t generate keys here.</span>`;
    return;
  }

  try{
    const kp = StellarSdk.Keypair.random();
    NEW_WALLET = { pub: kp.publicKey(), sec: kp.secret() };
    acctPubInput.value = NEW_WALLET.pub;
    newPubEl.textContent = NEW_WALLET.pub;
    drawQR(newQRCanvas, NEW_WALLET.pub);
    box.style.display = 'block';
    statusEl.textContent = 'Wallet created locally. Fund ~2.0 test Pi, then “Check Funding”.';
    try{ localStorage.setItem('izza_test_wallet', JSON.stringify(NEW_WALLET)); }catch(_){}
  }catch(e){
    statusEl.innerHTML = `<span style="color:#ffb3b3">Couldn’t create wallet: ${String(e)}</span>`;
  }
});

checkFundingBtn.addEventListener('click', async ()=>{
  try{
    if(!NEW_WALLET){
      try{ NEW_WALLET = JSON.parse(localStorage.getItem('izza_test_wallet')||'null'); }catch(_){}
    }
    if(!NEW_WALLET){ statusEl.textContent = 'Create a test wallet first.'; return; }

    statusEl.textContent = 'Checking funding…';
    const funded = await isFunded(NEW_WALLET.pub);
    if(!funded){
      statusEl.textContent = 'Still unfunded. Send ~2.0 test Pi from your Pi Testnet wallet, then press “Check Funding”.';
      return;
    }
    statusEl.textContent = 'Funded! You can now add the IZZA trustline.';
    addTrustlineBtn.disabled = false;
  }catch(e){
    statusEl.innerHTML = `<span style="color:#ffb3b3">Funding check failed: ${String(e)}</span>`;
  }
});

addTrustlineBtn.addEventListener('click', async ()=>{
  const ok = await ensureStellar();
  if (!ok || !window.StellarSdk){ statusEl.textContent = 'Stellar SDK missing.'; return; }
  if(!NEW_WALLET){ statusEl.textContent = 'No wallet in memory.'; return; }
  addTrustlineBtn.disabled = true;
  statusEl.textContent = 'Adding IZZA trustline…';
  try{
    const server = new StellarSdk.Server(API_BASE);
    const user   = StellarSdk.Keypair.fromSecret(NEW_WALLET.sec);
    const acct   = await server.loadAccount(user.publicKey());
    const izza   = new StellarSdk.Asset(ASSET_CODE, ISSUER);
    const tx = new StellarSdk.TransactionBuilder(acct, {
      fee: (await server.fetchBaseFee()).toString(),
      networkPassphrase: 'Pi Testnet'
    }).addOperation(StellarSdk.Operation.changeTrust({ asset: izza }))
      .setTimeout(180).build();
    tx.sign(user);
    const res = await server.submitTransaction(tx);
    const okRes = !!res && (res.successful || res.result_xdr);
    statusEl.textContent = okRes ? 'Trustline added. You can place orders now.' : 'Trustline failed.';
    addTrustlineBtn.disabled = !okRes;
    if (okRes) setOrderReady(true);
  }catch(e){
    statusEl.innerHTML = `<span style="color:#ffb3b3">Trustline failed: ${String(e)}</span>`;
    addTrustlineBtn.disabled = false;
    log('wallet.trustline.fail',{err:String(e)});
  }
});

// =================== Open the Place Order modal ===================
orderBtn.addEventListener('click', ()=>openModal(placeOrderModal, closePlaceOrderBtn));

// =================== Coin spin to refresh ===================
const wrap = document.getElementById('coinWrap');
let startX=0, startT=0;
function start(e){ const p = e.touches ? e.touches[0] : e; startX=p.clientX; startT=performance.now(); }
function end(e){
  const p = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
  const dx = (p.clientX - startX);
  const dt = Math.max(1, performance.now() - startT);
  const speed = Math.abs(dx) / dt;
  if (speed > 0.4) {
    wrap.classList.remove('spin-anim'); void wrap.offsetWidth; wrap.classList.add('spin-anim');
    setTimeout(fetchSummary, 1100);
  }
}
wrap.addEventListener('pointerdown', start, {passive:true});
wrap.addEventListener('pointerup',   end,   {passive:true});
wrap.addEventListener('touchstart',  start, {passive:true});
wrap.addEventListener('touchend',    end,   {passive:true});

// =================== Focus trap in modals ===================
function trapFocus(container){
  container.addEventListener('keydown', (e)=>{
    if(e.key !== 'Tab') return;
    const f = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(!f.length) return;
    const first = f[0], last = f[f.length - 1];
    if(e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
    else if(!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
  });
}
[modal, orderbookModal, placeOrderModal].forEach(trapFocus);
})(); 
</script>
</body>
</html>
