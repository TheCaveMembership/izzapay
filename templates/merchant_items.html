<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% if setup_mode %}Create your IZZA PAY Store{% else %}Merchant Items{% endif %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    html,body{max-width:100%;overflow-x:hidden}
    body{font-family:Arial,Helvetica,sans-serif;margin:0}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    @media (min-width:640px){.wrap{padding:24px}}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;padding:8px 0;position:sticky;top:0;z-index:10;background:rgba(11,15,23,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand-mark{width:48px;height:48px;object-fit:contain}
    .brand-word{height:36px;filter:brightness(1.06) contrast(1.02)}
    @media (max-width:380px){.brand-mark{width:40px;height:40px}.brand-word{height:30px}}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions a{white-space:nowrap}
    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:900px){.grid{grid-template-columns:380px 1fr;align-items:start}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .h1{font-size:24px;font-weight:800;margin:2px 0 10px}
    .h2{font-size:18px;font-weight:800;margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .stack{display:flex;flex-direction:column;gap:6px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field-inline{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:600px){.field-inline{grid-template-columns:1fr 1fr}}
    .ip-input,.ip-select,.ip-textarea{width:100%}
    .pickers{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:700px){.pickers{grid-template-columns:1fr 1fr}}
    .picker .thumb{width:100%;height:120px;border:1px solid var(--line);border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .picker .thumb img{width:100%;height:100%;object-fit:cover}
    .itimg{width:80px;height:80px;border:1px solid var(--line);border-radius:10px;background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .itimg img{width:100%;height:100%;object-fit:cover}
    .itimg svg{width:100%;height:100%;display:block}
    .itimg.is-svg { background: transparent; }
    .table-wrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:780px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:600}
    .theme-swatches{display:flex;gap:10px;flex-wrap:wrap}
    .swatch{width:120px;padding:8px;border:1px solid var(--line);border-radius:10px;cursor:pointer;display:flex;flex-direction:column;gap:6px;align-items:center;background:var(--card)}
    .swatch .preview{width:100%;height:60px;border-radius:8px;border:1px solid var(--line)}
    .swatch small{color:var(--muted)}
    .swatch.selected{outline:2px solid var(--accent)}
    .link-chip{display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;padding:8px;border:1px solid var(--line);border-radius:10px;background:var(--card)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .tiny{font-size:.9rem;padding:8px 10px}
    .edit-row{background:rgba(255,255,255,.02)}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .actions-col{min-width:180px}
    .danger{background:#7a2c2c;color:#fff}
    .hint,.note{font-size:12px;color:var(--muted)}
    .warn{color:#ffb86b}
    .success{color:#5ad49e}

    /* Minimal modal + wallet styles (compact) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
    .modal[hidden]{display:none}
    .modal-card{background:var(--card);border:1px solid var(--line);border-radius:14px;max-width:560px;width:94%;padding:14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal-title{display:flex;align-items:center;gap:8px;font-weight:800}
    .close-btn{border:1px solid var(--line);border-radius:10px;background:var(--panel);padding:8px 10px;color:#fff;cursor:pointer}
    .small-muted{font-size:12px;color:var(--muted)}
    .blox{display:flex;flex-direction:column;gap:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:8px;font-size:11px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:11px}
    .inline-hint{font-size:12px;color:var(--muted);margin-top:4px}
  </style>
</head>
{% set cw = colorway or (m.colorway if m) or 'cw-blue' %}
<body class="{{ cw }} theme-a">
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <img src="/static/izzapay-mark.svg" class="brand-mark" alt="IZZA mark">
        <img src="/static/izzapay-word.svg" class="brand-word" alt="IZZA PAY">
      </div>
      <div class="actions">
        <a class="ip-btn ghost" href="/explore">View Stores</a>
        {% if not setup_mode and m %}
          <a class="ip-btn ghost" href="/merchant/{{ m.slug }}/orders{% if t %}?t={{ t }}{% endif %}">View My Sales</a>
        {% endif %}
        {% if username and ADMIN_PI_USERNAME and (username|lower == ADMIN_PI_USERNAME|lower) %}
          <a class="ip-btn ghost" href="/admin{{ t and ('?t=' ~ t) or '' }}">Admin</a>
        {% endif %}
        <!-- Quick wallet access -->
        <button class="ip-btn" type="button" id="openWalletBtn" title="My IZZA Wallet">Wallet</button>
      </div>
    </div>

    {% if setup_mode %}
      <!-- setup form unchanged ... -->
      <div class="h1">Create your IZZA PAY Store</div>
      {% if username %}
        <p class="muted" style="margin-top:-6px">Signed in as <strong>@{{ username }}</strong></p>
      {% endif %}
      {% if error %}
        <div class="card" style="border-color:#7a2c2c;background:rgba(122,44,44,.15);margin-bottom:10px"><div>{{ error }}</div></div>
      {% endif %}

      <form class="grid" method="post" action="/merchant/setup">
        <input type="hidden" name="t" value="{{ t or '' }}">
        <input type="hidden" name="colorway" id="colorway" value="{{ cw }}">

        <div class="card stack">
          <div class="field"><label class="ip-label">Store name</label><input class="ip-input" name="business_name" placeholder="Your store name" required></div>
          <div class="field">
            <label class="ip-label">Store slug <span class="muted">(optional)</span></label>
            <input class="ip-input" id="slugInput" name="slug" placeholder="your-handle" inputmode="latin" autocapitalize="none" spellcheck="false" pattern="[a-z0-9-]+" maxlength="40">
            <small class="muted">Your storefront URL will be <code>/store/&lt;slug&gt;</code>.</small>
          </div>
          <div class="field"><label class="ip-label">Order notifications email</label><input class="ip-input" name="reply_to_email" type="email" placeholder="you@example.com" required></div>
          <div class="field">
            <label class="ip-label">Pi wallet public key</label>
            <input class="ip-input" name="pi_wallet_address" placeholder="G… (56 characters)" maxlength="56" required>
            <small class="muted">Must start with <strong>G</strong> and be exactly 56 characters.</small>
          </div>
          <div class="field"><label class="ip-label">Pi handle (optional)</label><input class="ip-input" name="pi_handle" placeholder="@your-pi-handle"></div>
          <div class="field"><label class="ip-label">Theme mode</label><select class="ip-select" name="theme_mode"><option value="dark" selected>Dark</option><option value="light">Light</option></select></div>

          <div class="field">
            <label class="ip-label">Logo</label>
            <div class="picker card">
              <div class="thumb" id="logoThumb"><span class="muted">Preview</span></div>
              <div class="row"><input type="file" id="logoFile" accept="image/*" style="flex:1"/><button class="ip-btn" type="button" id="logoUploadBtn">Upload</button></div>
              <div class="field" style="margin-top:6px"><input class="ip-input" id="logoUrl" name="logo_url" placeholder="https://… (or paste a logo URL)"></div>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end;margin-top:4px"><button class="ip-btn" type="submit">Save &amp; Continue</button></div>
        </div>

        <div class="card stack">
          <div class="muted" style="font-weight:600">Look &amp; Feel</div>
          <div class="theme-swatches" data-colorpicker>
            {% for c in ['cw-blue','cw-mint','cw-purple','cw-amber'] %}
              <div class="swatch {% if cw==c %}selected{% endif %}" data-cw="{{ c }}">
                <div class="preview theme-preview {{ c }} theme-a"><div class="blk"></div><div class="blk"></div><div class="blk"></div></div>
                <small>{{ c.split('-')[1] | capitalize }}</small>
              </div>
            {% endfor %}
          </div>
          <p class="muted" style="margin-top:8px">Tap a color to preview instantly. We’ll save this choice with your store.</p>
        </div>
      </form>

    {% else %}

      <div class="h1">{{ m.business_name }}</div>

      {% set can_edit_slug = slug_edit_allowed if slug_edit_allowed is defined else False %}
      {% set next_edit = slug_next_edit_at if slug_next_edit_at is defined else None %}

      <div class="card" style="margin-bottom:12px">
        <div class="h2">Store Settings</div>
        <form class="stack" method="post" action="/merchant/{{ m.slug }}/update{% if t %}?t={{ t }}{% endif %}">
          <input type="hidden" name="t" value="{{ t or '' }}">
          <input type="hidden" name="colorway" id="edit-colorway" value="{{ cw }}">
          <div class="field-inline">
            <div class="field"><label class="ip-label">Store name</label><input class="ip-input" name="business_name" value="{{ m.business_name or '' }}" required></div>
            <div class="field"><label class="ip-label">Order notifications email</label><input class="ip-input" name="reply_to_email" type="email" value="{{ m.reply_to_email or '' }}" required></div>
          </div>
          <div class="field-inline">
            <div class="field"><label class="ip-label">Pi wallet public key</label><input class="ip-input" name="pi_wallet_address" value="{{ m.pi_wallet_address or '' }}" maxlength="56" required></div>
            <div class="field"><label class="ip-label">Pi handle</label><input class="ip-input" name="pi_handle" value="{{ m.pi_handle or '' }}"></div>
          </div>
          <div class="field">
            <label class="ip-label">Store slug <span class="muted">(short URL name)</span></label>
            <div class="row" style="align-items:flex-start">
              <input class="ip-input" id="editSlugInput" name="slug" value="{{ m.slug }}" inputmode="latin" autocapitalize="none" spellcheck="false" pattern="[a-z0-9-]+" maxlength="40" {% if not can_edit_slug %}disabled{% endif %}>
              <button class="ip-btn ghost" type="button" id="enableSlugBtn" data-allowed="{{ '1' if can_edit_slug else '0' }}">{% if can_edit_slug %}Edit slug{% else %}Locked{% endif %}</button>
            </div>
            <small id="slugEditHint" class="hint">
              {% if can_edit_slug %}You can only edit your slug every 15 days. Choose carefully.{% else %}
                You can only edit your slug every 15 days.{% if next_edit %} Next edit available: <strong>{{ next_edit }}</strong>.{% endif %}
              {% endif %} Allowed characters: a–z, 0–9, hyphen. No spaces.
            </small>
          </div>

          <!-- NEW: Edit Logo picker (upload + preview) -->
          <div class="field">
            <label class="ip-label">Logo</label>
            <div class="picker card">
              <div class="thumb" id="editLogoThumb"><span class="muted">Preview</span></div>
              <div class="row"><input type="file" id="editLogoFile" accept="image/*" style="flex:1"/><button class="ip-btn" type="button" id="editLogoUploadBtn">Upload</button></div>
              <div class="field" style="margin-top:6px"><input class="ip-input" id="editLogoUrl" name="logo_url" value="{{ m.logo_url or '' }}" placeholder="https://… (or paste a logo URL)"></div>
            </div>
          </div>

          <div class="field-inline">
            <div class="field">
              <label class="ip-label">Theme mode</label>
              <select class="ip-select" name="theme_mode">
                <option value="dark" {% if m.theme_mode=='dark' %}selected{% endif %}>Dark</option>
                <option value="light" {% if m.theme_mode=='light' %}selected{% endif %}>Light</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>
          <div class="muted" style="font-weight:600">Colorway</div>
          <div class="theme-swatches" id="edit-swatches" data-colorpicker>
            {% for c in ['cw-blue','cw-mint','cw-purple','cw-amber'] %}
              <div class="swatch {% if cw==c %}selected{% endif %}" data-cw="{{ c }}">
                <div class="preview theme-preview {{ c }} theme-a"><div class="blk"></div><div class="blk"></div><div class="blk"></div></div>
                <small>{{ c.split('-')[1] | capitalize }}</small>
              </div>
            {% endfor %}
          </div>

          <div class="row" style="justify-content:flex-end;margin-top:4px"><button class="ip-btn" type="submit">Save Changes</button></div>
        </form>
      </div>

      <!-- Create Product -->
      <div class="card" id="create-product">
        <div class="h2">Create Product</div>
        <form class="stack" method="post" action="/merchant/{{ m.slug }}/items/new{% if t %}?t={{ t }}{% endif %}">
          <input type="hidden" name="t" value="{{ t or '' }}">
          <!-- keep crafted SVG for inventory usage -->
          <input type="hidden" id="svgCode" name="svg_code" value="">
          <input type="hidden" name="crafted_part" id="crafted_part">
          <input type="hidden" name="meta_type" id="meta_type" value="">
          <input type="hidden" name="craft_ic_cost" id="craft_ic_cost" value="">
          <input type="hidden" name="craft_dyn_mode" id="craft_dyn_mode" value="fixed_ic">
          <input type="hidden" name="craft_dyn_ic"   id="craft_dyn_ic"   value="">

          <!-- NEW: hidden fields to persist NFT mint data -->
          <input type="hidden" name="nft_enabled" id="nft_enabled" value="">
          <input type="hidden" name="nft_kind" id="nft_kind" value="">
          <input type="hidden" name="nft_size" id="nft_size" value="">
          <input type="hidden" name="nft_prefix" id="nft_prefix" value="">
          <input type="hidden" name="nft_tag" id="nft_tag" value="">
          <input type="hidden" name="nft_assets_json" id="nft_assets_json" value="">

          <div class="field-inline">
            <div class="field"><label class="ip-label">Title</label><input class="ip-input" name="title" required></div>
            <div class="field"><label class="ip-label">SKU</label><input class="ip-input" name="sku"></div>
          </div>

          <div class="field">
            <label class="ip-label">Attach Crafting Land item (optional)</label>
            <div class="row" style="gap:8px;align-items:center">
              <select class="ip-select" id="craftedSelect"><option value="">— Select a crafted item —</option></select>
              <button type="button" class="ip-btn ghost tiny" id="refreshCrafted">Refresh</button>
            </div>
            <input type="hidden" name="crafted_item_id" id="crafted_item_id">
            <input type="hidden" name="fulfillment_kind" id="fulfillment_kind" value="">
            <input type="hidden" name="category" id="category" value="">
            <small class="note">When attached, this product is marked as an in-game item.</small>
          </div>

          <div class="field">
            <label class="ip-label">Image</label>
            <div class="row" style="gap:8px;align-items:center">
              <div class="itimg" id="itThumb"><span class="muted" style="font-size:12px">Preview</span></div>
              <input type="file" id="itFile" accept="image/*"/>
              <button type="button" class="ip-btn" id="itUploadBtn">Upload</button>
            </div>
            <input class="ip-input" id="itUrl" name="image_url" placeholder="https://… (or paste an image URL)">
          </div>

          <div class="field">
            <label class="ip-label">Item Description</label>
            <textarea class="ip-textarea" name="description" rows="4" placeholder="Describe the item, condition, size, shipping notes, etc."></textarea>
            <small class="note">Shown on your product page.</small>
          </div>

          <div class="field-inline">
            <div class="field"><label class="ip-label">Price (Pi)</label><input class="ip-input" name="pi_price" inputmode="decimal" placeholder="0.1" required></div>
            <div class="field"><label class="ip-label">Stock Qty</label><input class="ip-input" name="stock_qty" inputmode="numeric" placeholder="10"></div>
          </div>

          <!-- Voucher info (unchanged) -->
          <div class="field" id="voucherInfo" style="display:none">
            <div class="note" id="voucherExplainer">
              Buyers will get a <strong>single-use crafting voucher</strong> equal to your product’s Pi price, converted to IC.
              They’ll redeem it to mint this item, then return to copy the SVG shown on their voucher page.
            </div>
            <div class="note" id="voucherCalc" style="margin-top:6px"></div>
            <div class="note" id="mintCostNote" style="margin-top:6px"></div>
          </div>

          <label class="ip-label" style="display:flex;gap:6px;align-items:center"><input type="checkbox" name="allow_backorder" value="1"> Allow backorder</label>

          <!-- NEW: NFT mint block -->
          <div class="card" id="nftBlock" style="margin-top:10px">
            <div class="h2" style="font-size:16px;margin-bottom:8px;display:flex;align-items:center;gap:8px">
              Mint as IZZA NFT • <span class="mono">Pi Testnet</span> <span class="pill" id="nftStatusPill" hidden>—</span>
            </div>
            <label class="ip-label" style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <input type="checkbox" id="nftEnableToggle"> Enable NFT minting for this crafted item
            </label>
            <div id="nftForm" style="display:none">
              <div class="field-inline">
                <div class="field">
                  <label class="ip-label">Mint Kind</label>
                  <select class="ip-select" id="nftKind">
                    <option value="single" selected>Single</option>
                    <option value="collection">Collection</option>
                  </select>
                </div>
                <div class="field">
                  <label class="ip-label">Collection Size</label>
                  <input class="ip-input" id="nftSize" inputmode="numeric" value="10" disabled>
                </div>
              </div>
              <div class="field-inline">
                <div class="field">
                  <label class="ip-label">Prefix <span class="muted">(asset code)</span></label>
                  <input class="ip-input" id="nftPrefix" placeholder="NFT" value="NFT">
                </div>
                <div class="field">
                  <label class="ip-label">Collection Tag <span class="muted">(optional)</span></label>
                  <input class="ip-input" id="nftTag" placeholder="GOLD01">
                </div>
              </div>

              <div class="row" style="align-items:center;justify-content:space-between">
                <div>
                  <button class="ip-btn tiny" type="button" id="nftQuoteBtn">Get Quote</button>
                  <span class="inline-hint" id="nftQuoteHint"></span>
                </div>
                <div>
                  <button class="ip-btn tiny" type="button" id="nftMintBtn" disabled>Mint Now</button>
                </div>
              </div>
              <div class="inline-hint" style="margin-top:6px">
                Uses your local IZZA wallet S-key to pay the mint fee in IZZA and issue the NFT(s) to the distributor.
              </div>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end"><button class="ip-btn" type="submit" id="addItemBtn">Add Item</button></div>
        </form>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="h2">Products</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Image</th><th>Title</th><th>Price (Pi)</th><th>Stock</th><th>Buy Now Link</th><th class="actions-col">Actions</th></tr></thead>
            <tbody>
            {% for it in items %}
              <tr>
                <td>
  {# inside your existing image <td> ... #}
{% set svg = (it.svg_code or '') | trim %}
{% set img_raw = (it.image_url or '') | trim %}
{% set already_proxied = img_raw.startswith('/uimg?src=') %}
{% set is_local = img_raw.startswith('/media/') %}
{% set is_http = img_raw.startswith('http://') or img_raw.startswith('https://') %}

<div class="itimg {% if svg %}is-svg{% endif %}" data-no-i18n="1">
  {% if svg %}
    {{ svg | safe }}
  {% elif img_raw %}
    <img
      src="{% if already_proxied %}{{ img_raw }}
           {% elif is_local %}{{ img_raw }}
           {% elif is_http %}/uimg?src={{ img_raw | urlencode }}
           {% else %}{{ img_raw }}{% endif %}"
      alt=""
      loading="lazy"
      referrerpolicy="no-referrer"
      onerror="this.replaceWith((()=>{const s=document.createElement('span');s.className='muted';s.style.fontSize='12px';s.textContent='—';return s;})())">
  {% else %}
    <span class="muted" style="font-size:12px">—</span>
  {% endif %}
</div>
</td>
                <td>
                  {{ it.title }}
                  {% if it.fulfillment_kind == 'crafting' %}
                    <span class="mono" style="font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:6px;margin-left:6px;">Game</span>
                  {% endif %}
                  {% if it.nft_assets_json %}
                    <span class="mono" style="font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:6px;margin-left:6px;">IZZA NFT • Pi Testnet</span>
                  {% endif %}
                </td>
                <td>{{ '%.7f'|format(it.pi_price) }}</td>
                <td>{{ it.stock_qty }}</td>
                <td>
                  <div class="row" style="align-items:center;gap:8px">
                    <div class="link-chip"><span class="mono" id="lnk-{{ it.link_id }}">{{ APP_BASE_URL }}/checkout/{{ it.link_id }}</span></div>
                    <div class="btn-row"><a class="ip-btn tiny" target="_blank" href="/checkout/{{ it.link_id }}">Open</a><button class="ip-btn ghost tiny" type="button" data-copy="#lnk-{{ it.link_id }}">Copy</button></div>
                  </div>
                </td>
                <td class="actions-col">
                  <div class="btn-row" style="flex-direction:column;align-items:stretch">
                    <button class="ip-btn tiny" type="button" data-edit-toggle="{{ it.id }}">Edit</button>
                    <form method="post" action="/merchant/{{ m.slug }}/items/delete{% if t %}?t={{ t }}{% endif %}" onsubmit="return confirm('Delete this product? This cannot be undone.');">
                      <input type="hidden" name="item_id" value="{{ it.id }}"><input type="hidden" name="t" value="{{ t or '' }}">
                      <button class="ip-btn tiny danger" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              <tr class="edit-row" id="edit-row-{{ it.id }}" style="display:none">
                <td colspan="6">
                  <form class="stack" method="post" action="/merchant/{{ m.slug }}/items/update{% if t %}?t={{ t }}{% endif %}">
                    <input type="hidden" name="t" value="{{ t or '' }}"><input type="hidden" name="item_id" value="{{ it.id }}">
                    <div class="field-inline">
                      <div class="field"><label class="ip-label">Title</label><input class="ip-input" name="title" value="{{ it.title }}"></div>
                      <div class="field"><label class="ip-label">SKU</label><input class="ip-input" name="sku" value="{{ it.sku }}"></div>
                    </div>
                    <div class="field-inline">
                      <div class="field"><label class="ip-label">Price (Pi)</label><input class="ip-input" name="pi_price" inputmode="decimal" value="{{ '%.7f'|format(it.pi_price) }}"></div>
                      <div class="field"><label class="ip-label">Stock Qty</label><input class="ip-input" name="stock_qty" inputmode="numeric" value="{{ it.stock_qty }}"></div>
                    </div>
                    <div class="field"><label class="ip-label">Image URL</label><input class="ip-input" name="image_url" value="{{ it.image_url or '' }}"></div>
                    <div class="field"><label class="ip-label">Item Description</label><textarea class="ip-textarea" name="description" rows="4" placeholder="Describe the item…">{{ it.description or '' }}</textarea><small class="note">Shown on your product page.</small></div>

                    <div class="card" style="padding:12px;margin:6px 0">
                      <div class="h2" style="font-size:16px;margin:0 0 8px">Crafting Checkout</div>
                      <label class="ip-label" style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                        <input type="checkbox" name="craft_dyn_enabled" value="1" {% if it.craft_dyn_enabled %}checked{% endif %}> Enable dynamic Pi price when opened with a Crafting draft link
                      </label>
                      <small class="note" style="display:block;margin:-2px 0 10px">If buyer arrives with <code>?draftId=123</code>, checkout uses the draft’s quote.</small>
                      <div class="field-inline">
                        <div class="field">
                          <label class="ip-label">Mode</label>
                          <select class="ip-select craft-mode" name="craft_dyn_mode" data-for="{{ it.id }}">
                            <option value="auto_quote" {% if it.craft_dyn_mode=='auto_quote' %}selected{% endif %}>Auto (quoted IC → Pi)</option>
                            <option value="fixed_ic" {% if it.craft_dyn_mode=='fixed_ic' %}selected{% endif %}>Fixed voucher value (IC)</option>
                          </select>
                          <small class="note">“Auto” uses the draft’s features; “Fixed” always uses the value below.</small>
                        </div>
                        <div class="field">
                          <label class="ip-label">Fixed voucher value (IC)</label>
                          <input class="ip-input craft-fixed-ic" name="craft_dyn_ic" inputmode="numeric" value="{{ it.craft_dyn_ic or 500 }}" data-for="{{ it.id }}">
                          <small class="note">Only used when Mode = Fixed.</small>
                        </div>
                      </div>
                      <div class="field-inline">
                        <div class="field"><label class="ip-label">Floor price (Pi, optional)</label><input class="ip-input" name="craft_dyn_floor_pi" inputmode="decimal" value="{{ '%.7f'|format(it.craft_dyn_floor_pi) if it.craft_dyn_floor_pi is defined else '' }}"></div>
                        <div class="field"><label class="ip-label">Notes (admin only)</label><input class="ip-input" name="craft_dyn_notes" value="{{ it.craft_dyn_notes or '' }}"></div>
                      </div>
                    </div>

                    <div class="field">
                      <label class="ip-label">Crafting Land item</label>
                      <div class="row" style="gap:8px;align-items:center">
                        <select class="ip-select craftedEditSelect" data-item-id="{{ it.id }}"><option value="">— None —</option></select>
                      </div>
                      <input type="hidden" name="crafted_item_id" id="crafted_item_id_{{ it.id }}" value="{{ it.crafted_item_id or '' }}">
                      <input type="hidden" name="fulfillment_kind" id="fulfillment_kind_{{ it.id }}" value="{{ it.fulfillment_kind or '' }}">
                      <input type="hidden" name="category" id="category_{{ it.id }}" value="{{ it.category or '' }}">
                      <input type="hidden" name="crafted_part" id="crafted_part_{{ it.id }}" value="{{ it.crafted_part or '' }}">
                      <input type="hidden" name="meta_type" id="meta_type_{{ it.id }}" value="{{ it.meta_type or '' }}">
                      <small class="note">Leave empty to treat as a normal (physical) item.</small>
                    </div>

                    <div class="row" style="justify-content:flex-end">
                      <button class="ip-btn ghost tiny" type="button" data-edit-toggle="{{ it.id }}">Cancel</button>
                      <button class="ip-btn tiny" type="submit">Save</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" id="danger-zone" style="margin:12px 0 0 0">
        <div class="h2">Danger Zone</div>
        <p class="muted" style="margin-top:-2px">Deleting your store will permanently remove <strong>all store information and items</strong>. This cannot be undone.</p>
        <ul class="muted" style="margin:6px 0 12px;padding-left:18px">
          <li>Make sure you’ve <strong>processed delivery for any purchased physical items</strong>.</li>
          <li>Confirm any open sales are completed or refunded as needed.</li>
        </ul>
        <form class="stack" id="deleteStoreForm" method="post" action="/merchant/{{ m.slug }}/delete{% if t %}?t={{ t }}{% endif %}">
          <input type="hidden" name="t" value="{{ t or '' }}"><input type="hidden" name="redirect" value="/signin?fresh=1">
          <label class="ip-label" style="display:flex;gap:8px;align-items:flex-start"><input type="checkbox" name="acknowledge" value="1" required> <span>I understand this action is permanent and I have cleaned current sales and processed delivery of any purchased physical items.</span></label>
          <div class="row" style="justify-content:flex-end;margin-top:4px"><button class="ip-btn danger" type="submit">Delete Store</button></div>
        </form>
      </div>

    {% endif %}
  </div>

  <!-- =============== Minimal IZZA Wallet modal (reuses token showcase vault model) =============== -->
  <div class="modal" id="myWalletModal" role="dialog" aria-modal="true" aria-labelledby="myWalletTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="" style="width:22px;height:22px">
          <span id="myWalletTitle">My IZZA Wallet</span>
        </div>
        <button class="close-btn" type="button" id="closeMyWalletBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="blox">
          <div class="small-muted">Signed in as</div>
          <div><strong id="mwUser">—</strong></div>
        </div>
        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Active Wallet (public key)</div>
          <div class="mono" id="mwPub">—</div>
          <div class="inline-hint">This is the wallet used to buy, stake, and mint IZZA NFTs.</div>
        </div>
        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Local S-key status</div>
          <div id="mwSStatus">—</div>
          <div class="row" style="margin-top:6px">
            <input class="ip-input" id="mwSInput" placeholder="S... (private key)" autocomplete="off" spellcheck="false" autocapitalize="none" style="min-width:260px">
            <button class="ip-btn tiny" type="button" id="mwSaveBtn">Save S-key</button>
            <button class="ip-btn ghost tiny" type="button" id="mwForgetBtn">Forget</button>
          </div>
          <div class="inline-hint">Your S-key is stored locally on this device only.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
(function(){
  // ---------- tiny utils ----------
  const $ = s => document.querySelector(s);
  const $all = s => Array.from(document.querySelectorAll(s));
  const ABS = u => { try{ if(!u) return ''; if(/^https?:\/\//i.test(u)) return u; if(u.startsWith('/')) return location.origin.replace(/\/$/,'')+u; return new URL(u, location.origin).href; }catch{ return u; } };
  const proxy = u => { const v=(u||'').trim(); if(!v) return ''; if(v.startsWith('/uimg?src=')||v.startsWith('data:')||v.startsWith('blob:')||v.startsWith('/')) return v; try{const x=new URL(v,location.origin); if(/^https?:/.test(x.protocol)) return '/uimg?src='+encodeURIComponent(x.href);}catch{} return v; };
  const copyFrom = sel => { const el=$(sel); if(!el) return; const t=el.textContent.trim(); if(!navigator.clipboard){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); try{document.execCommand('copy')}catch{} document.body.removeChild(ta); return; } navigator.clipboard.writeText(t); };

  // ---------- username ----------
  const SRV_USER = {{ (username or '') | tojson }};
  function normU(u){ return (u||'').toString().trim().replace(/^@+/, '').toLowerCase(); }
  function currentUser(){
    const q = new URLSearchParams(location.search).get('u');
    if(q) return normU(q);
    if(SRV_USER) return normU(SRV_USER);
    try{ const raw=localStorage.getItem('piAuthUser'); if(raw){ const j=JSON.parse(raw); if(j && j.username) return normU(j.username); } }catch{}
    try{ const u=localStorage.getItem('izzaUserU'); if(u) return normU(u); }catch{}
    return '';
  }
  const USERNAME = currentUser();
  try{ if(USERNAME) localStorage.setItem('izzaUserU', USERNAME); }catch{}

  // ---------- uploads (unchanged) ----------
  const token = ()=> (document.querySelector('input[name="t"]')?.value || new URLSearchParams(location.search).get('t') || '');
  async function uploadTo(path, file){
    const fd=new FormData(); fd.append('file', file);
    const t=token(); const url = path + (t ? (path.includes('?')?'&':'?') + 't='+encodeURIComponent(t) : '');
    const headers={}; if(t) headers['Authorization']='Bearer '+t;
    const r=await fetch(url,{method:'POST',body:fd,headers,credentials:'include'});
    if(!r.ok) throw new Error('upload failed');
    const j=await r.json(); if(!j.ok||!j.url) throw new Error('bad response');
    return j.url;
  }
  function setThumb(id, url){
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    const img=new Image(); img.src=url; img.loading='lazy'; img.referrerPolicy='no-referrer';
    img.onerror=()=>{ el.innerHTML='<span class="muted" style="font-size:12px">—</span>'; };
    el.appendChild(img);
  }

  // ---------- colorways + slugs (unchanged) ----------
  function wireColorways(){
    $all('[data-colorpicker]').forEach(wrap=>{
      wrap.querySelectorAll('.swatch').forEach(sw=>{
        sw.addEventListener('click',()=>{
          document.body.classList.remove('cw-blue','cw-mint','cw-purple','cw-amber');
          wrap.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected'));
          const cw=sw.getAttribute('data-cw'); if(!cw) return;
          document.body.classList.add(cw); sw.classList.add('selected');
          const hidden = $('#colorway') || $('#edit-colorway'); if(hidden) hidden.value=cw;
        });
      });
    });
  }
  function normSlug(v){ return (v||'').toLowerCase().trim().replace(/[\s_]+/g,'-').replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-+|-+$/g,''); }
  (function wireSlugs(){
    const setupEl = $('#slugInput'); if(setupEl){ setupEl.addEventListener('input',()=>{ const n=normSlug(setupEl.value); if(setupEl.value!==n) setupEl.value=n; }); setupEl.closest('form')?.addEventListener('submit',()=>{ setupEl.value=normSlug(setupEl.value); }); }
    const editEl = $('#editSlugInput'); if(editEl){ editEl.addEventListener('input',()=>{ const n=normSlug(editEl.value); if(editEl.value!==n) editEl.value=n; }); editEl.closest('form')?.addEventListener('submit',()=>{ editEl.value=normSlug(editEl.value); }); }
    const btn=$('#enableSlugBtn'), hint=$('#slugEditHint'); if(btn && editEl && hint){ const allowed = btn.getAttribute('data-allowed')==='1'; btn.addEventListener('click',()=>{ if(!allowed){ hint.classList.add('warn'); return; } if(editEl.disabled){ editEl.disabled=false; editEl.focus(); btn.textContent='Slug unlocked'; hint.classList.add('warn'); } }); }
  })();

  // ---------- SVG helpers (unchanged) ----------
  function svgNormalize(s, px=512){
    let x=(s||'').trim(); if(!x) return '';
    if(!/^\s*<svg[\s>]/i.test(x)) return ''; // not an svg
    if(!/xmlns=/i.test(x)) x=x.replace('<svg','<svg xmlns="http://www.w3.org/2000/svg"');
    if(!/viewBox=/i.test(x)){
      const w=(x.match(/width="([\d.]+)"/i)||[])[1];
      const h=(x.match(/height="([\d.]+)"/i)||[])[1];
      if(w && h) x=x.replace('<svg','<svg viewBox="0 0 '+Number(w)+' '+Number(h)+'"');
      else x=x.replace('<svg','<svg viewBox="0 0 512 512"');
    }
    if(/width="/i.test(x)) x=x.replace(/width="[^"]*"/i, 'width="'+px+'"'); else x=x.replace('<svg','<svg width="'+px+'"');
    if(/height="/i.test(x)) x=x.replace(/height="[^"]*"/i, 'height="'+px+'"'); else x=x.replace('<svg','<svg height="'+px+'"');
    if(!/preserveAspectRatio=/i.test(x)) x=x.replace('<svg','<svg preserveAspectRatio="xMidYMid slice"');
    return x;
  }
  function injectSvg(container, svgString, px=80){
    const el = (typeof container==='string') ? $(container) : container;
    const s = svgNormalize(svgString, px);
    if(!el || !s) return false;
    el.innerHTML = s;
    el.style.background='transparent';
    return true;
  }
  async function injectSvgFromUrl(container, url, px=80){
    try{
      const r = await fetch(url, {credentials:'omit', cache:'force-cache'});
      if(!r.ok) throw new Error('fetch_fail');
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('svg')) throw new Error('not_svg');
      const svg = await r.text();
      return injectSvg(container, svg, px);
    }catch{ return false; }
  }

  // ---------- copy buttons ----------
  document.addEventListener('click',(e)=>{
    const t=e.target;
    if(t && t.matches('[data-copy]')){
      copyFrom(t.getAttribute('data-copy'));
      t.textContent='Copied';
      setTimeout(()=>t.textContent='Copy', 1200);
    }
  });

  // ---------- logo + item image uploads (unchanged) ----------
  (function(){
    async function handleFileChange(fileEl, btnEl, inpEl, thumbId){
      const f = fileEl?.files?.[0];
      if(!f) return;
      setThumb(thumbId, URL.createObjectURL(f));
      if(btnEl) { btnEl.disabled=true; btnEl.textContent='Uploading…'; }
      try{
        const url = await uploadTo('/upload', f);
        if(inpEl){ inpEl.value = ABS(url); }
        setThumb(thumbId, proxy(url));
      }catch{
        alert('Upload failed. You can paste a URL instead.');
      }finally{
        if(btnEl){ btnEl.disabled=false; btnEl.textContent='Upload'; }
      }
    }
    function bind(fileSel, btnSel, inputSel, thumbId){
      const file=$(fileSel), btn=$(btnSel), inp=$(inputSel);
      if(!file||!inp) return;
      file.addEventListener('change',()=>handleFileChange(file, btn, inp, thumbId));
      if(btn){ btn.addEventListener('click', async ()=>{ if(!file.files?.[0]){ inp.focus(); return; } await handleFileChange(file, btn, inp, thumbId); }); }
      inp.addEventListener('input',()=>{ const v=proxy(inp.value); if(v) setThumb(thumbId, v); });
      if(inp.value){ const v=proxy(inp.value); if(v) setThumb(thumbId, v); }
    }
    bind('#logoFile', '#logoUploadBtn', '#logoUrl', 'logoThumb');
    bind('#editLogoFile', '#editLogoUploadBtn', '#editLogoUrl', 'editLogoThumb');
  })();
  (function(){
    const file=$('#itFile'), btn=$('#itUploadBtn'), inp=$('#itUrl'), thumbId='itThumb';
    if(!file||!btn||!inp) return;
    file.addEventListener('change',async ()=>{
      const f=file.files?.[0];
      if(f){
        btn.disabled=true; btn.textContent='Uploading…';
        try{
          const url=await uploadTo('/upload', f);
          inp.value=ABS(url);
          setThumb(thumbId, proxy(url));
        }catch{ alert('Upload failed. You can paste an image URL instead.'); }
        finally{ btn.disabled=false; btn.textContent='Upload'; }
      }
    });
    btn.addEventListener('click', async ()=>{
      if(!file.files?.[0]){ inp.focus(); return; }
      btn.disabled=true; btn.textContent='Uploading…';
      try{ const url=await uploadTo('/upload', file.files[0]); inp.value=ABS(url); setThumb(thumbId, proxy(url)); }
      catch{ alert('Upload failed. You can paste an image URL instead.'); }
      finally{ btn.disabled=false; btn.textContent='Upload'; }
    });
    inp.addEventListener('input',()=>{ const v=proxy(inp.value); if(v) setThumb(thumbId, v); });
  })();

  // ---------- Create Product guard (unchanged) ----------
  (function(){
    const form = document.querySelector('#create-product form'); if(!form) return;
    form.addEventListener('submit', async (e)=>{
      const title=form.querySelector('input[name="title"]');
      const priceEl=form.querySelector('input[name="pi_price"]');
      const price=Number((priceEl?.value||'').trim());
      if(!title?.value.trim()){ e.preventDefault(); alert('Please add a product title.'); title?.focus(); return false; }
      if(!price || isNaN(price) || price<=0){ e.preventDefault(); alert('Enter a valid Pi price (e.g., 0.1)'); priceEl?.focus(); return false; }
    });
  })();

  // ---------- inline editor toggles (unchanged) ----------
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-edit-toggle]'); if(!btn) return;
    const id=btn.getAttribute('data-edit-toggle'); const row=document.getElementById('edit-row-'+id); if(!row) return;
    row.style.display = (row.style.display==='none'||!row.style.display) ? 'table-row' : 'none';
  });

  // ---------- delete store submit enhancement (unchanged) ----------
  (function(){
    const form=$('#deleteStoreForm'); if(!form) return;
    form.addEventListener('submit', async (e)=>{
      if(!confirm('Are you sure you want to delete this store? This cannot be undone.')){ e.preventDefault(); return false; }
      e.preventDefault();
      const fd=new FormData(form);
      try{
        const r=await fetch(form.action,{method:'POST',body:fd,credentials:'include'});
        if(r.ok){
          let dest='/signin?fresh=1'; try{ const j=await r.clone().json(); if(j&&j.redirect) dest=j.redirect; }catch{}
          if(!dest) dest=fd.get('redirect')||'/signin?fresh=1';
          location.replace(dest);
        }else{ form.submit(); }
      }catch{ form.submit(); }
    },{passive:false});
  })();

  // ---------- Crafting Land linker (unchanged core, plus voucher preview) ----------
  (function(){
    const GAME_BASE='https://izzagame.onrender.com';
    const IC_PER_PI = 2000;

    const who=()=> USERNAME;

    async function fetchState(user){
      if(!user) return null;
      const r=await fetch(`${GAME_BASE}/api/state/${encodeURIComponent(user)}?prefer=lastGood`,{credentials:'omit'});
      if(!r.ok) throw new Error('state_fetch_failed'); return r.json();
    }

    async function fetchCraftedDetails(craftedId){
      if(!craftedId) return null;
      const r = await fetch(`/api/crafted/${encodeURIComponent(craftedId)}`, { credentials: 'include' });
      if(!r.ok) return null;
      const j = await r.json().catch(()=>null);
      return j && j.ok ? j : null;
    }

    function normalizeCategory(rawType, rawCategory){
      const t = String(rawType || '').toLowerCase();
      let c = String(rawCategory || '').toLowerCase();
      if (!c) c = t;
      if (c === 'armor') c = 'armour';
      return c || 'armour';
    }
    function normalizePart(raw){
      const alias = {head:'helmet',helmet:'helmet',body:'vest',torso:'vest',chest:'vest',vest:'vest',arm:'arms',arms:'arms',leg:'legs',legs:'legs',hand:'hands',hands:'hands',weapon:'hands',gun:'gun',melee:'melee',blade:'melee',sword:'melee'};
      const p = String(raw || '').toLowerCase();
      return alias[p] || (['helmet','vest','arms','legs','hands','gun','melee'].includes(p) ? p : '');
    }
    function itemsFromState(j){
      const inv=(j&&j.inventory)||(j&&j.player&&j.player.inventory)||{};
      const out=[];
      Object.entries(inv).forEach(([key,val])=>{
        if(!val||typeof val!=='object') return;
        const count=Number(val.count||0), equippable=!!val.equippable;
        const isGameItem = equippable || ['armor','armour','weapon','tool','trinket','digital_collectible'].includes(String(val.type||'').toLowerCase());
        if(!isGameItem && count<=0) return;
        const category = normalizeCategory(val.type, val.category || val.cat);
        const part     = normalizePart(val.part || val.slot || val.subslot);
        out.push({ id:key, title:val.name||key, img:val.image||val.image_url||'', sku:val.sku||'', svg:val.iconSvg||val.overlaySvg||(val.icon&&(val.icon.svg||val.icon))||'', category, part });
      });
      return out;
    }
    function ipfsToHttp(u){ if(!u) return ''; if(/^ipfs:\/\//i.test(u)){ const cid=u.replace(/^ipfs:\/\//i,'').replace(/^ipfs\//,''); return 'https://ipfs.io/ipfs/'+cid; } return u; }

    let CRAFT_ITEMS={};

    function fillSelect(sel, items, currentId, isEdit){
      if(!sel) return;
      sel.innerHTML='';
      const opt0=document.createElement('option');
      opt0.value=''; opt0.textContent='— ' + (isEdit?'None':'Select a crafted item') + ' —';
      sel.appendChild(opt0);
      items.forEach(it=>{
        const o=document.createElement('option');
        o.value=String(it.id);
        o.textContent=it.title||it.id;
        if(currentId && String(currentId)===String(it.id)) o.selected=true;
        sel.appendChild(o);
      });
      CRAFT_ITEMS=Object.fromEntries(items.map(it=>[String(it.id), it]));
    }

    function markAsCrafting(hidId, fkId, catId, partId, metaTypeId, craftedId){
      const hid=document.getElementById(hidId);
      const fk =document.getElementById(fkId);
      const cat=document.getElementById(catId);
      const prt=document.getElementById(partId);
      const mt =document.getElementById(metaTypeId);

      const has=!!craftedId;
      if(hid) hid.value = has ? craftedId : '';
      if(fk)  fk.value  = has ? 'crafting' : '';

      const item = has ? (CRAFT_ITEMS[craftedId]||{}) : null;
      if(cat) cat.value = has ? (item.category || 'armour') : '';
      if(prt) prt.value = has ? (item.part || '') : '';
      if(mt)  mt.value  = has ? 'crafted_item' : '';
    }

    // --- Create form wiring
    (function(){
      const sel=$('#craftedSelect'); if(!sel) return;
      const hid='crafted_item_id';
      const fk='fulfillment_kind';
      const cat='category';
      const partId='crafted_part';
      const metaTypeId='meta_type';

      const imgIn=$('#itUrl');
      const svgHidden=$('#svgCode');
      const titleEl=$('#create-product form input[name="title"]');
      const skuEl=$('#create-product form input[name="sku"]');

      // Voucher info UI
      const priceInput = $('#create-product input[name="pi_price"]');
      const craftedIdInput = $('#crafted_item_id');
      const infoWrap = $('#voucherInfo');
      const voucherCalc = $('#voucherCalc');
      const mintCostNote = $('#mintCostNote');

      function fmt(n){ try{ return Number(n).toLocaleString(); }catch{ return String(n); } }

      function updateVoucherPreview(){
        const hasCraft = !!(craftedIdInput?.value || '').trim();
        const pi = parseFloat((priceInput?.value || '').trim());
        if(!infoWrap) return;
        if(!hasCraft){
          infoWrap.style.display='none';
          voucherCalc.textContent='';
          mintCostNote.textContent='';
          return;
        }
        infoWrap.style.display='';
        if(pi && !isNaN(pi) && pi>0){
          const ic = Math.round(pi * 2000);
          voucherCalc.textContent = `Buyers will receive a single-use voucher worth approximately ${fmt(ic)} IC (based on 2000 IC per 1 π).`;
        }else{
          voucherCalc.textContent = '';
        }
        const icCost = parseInt(($('#craft_ic_cost')?.value || '').trim() || '0', 10);
        mintCostNote.textContent = icCost>0 ? `Average mint cost for this item: ~ ${fmt(icCost)} IC.` : '';
      }

      function setFromSvg(svg, id){
        svgHidden.value = svg || '';
        if(svg){
          injectSvg('#itThumb', svg, 80);
          (async()=>{
            try{
              const blob=new Blob([svgNormalize(svg,512)],{type:'image/svg+xml'});
              const file=new File([blob], `${id||'crafted'}.svg`, {type:'image/svg+xml'});
              const url=await uploadTo('/upload', file);
              if(imgIn) imgIn.value=ABS(url);
            }catch{}
          })();
        }
      }

      async function onChange(){
        const id = sel.value || '';
        markAsCrafting(hid,fk,cat,partId,metaTypeId,id);
        if(!id){ updateVoucherPreview(); return; }

        const it = CRAFT_ITEMS[id] || {};
        if(titleEl) titleEl.value = it.title || titleEl.value;
        if(skuEl)   skuEl.value   = it.sku || '';

        const det = await fetchCraftedDetails(id);
        const meta = (det && det.meta) || {};
        const priceIC = Number(meta.price_ic || 0);

        const icEl  = document.getElementById('craft_ic_cost');
        const modeEl= document.getElementById('craft_dyn_mode');
        const icDyn = document.getElementById('craft_dyn_ic');
        if(icEl)  icEl.value   = priceIC > 0 ? String(priceIC) : '';
        if(modeEl) modeEl.value= 'fixed_ic';
        if(icDyn) icDyn.value  = priceIC > 0 ? String(priceIC) : '';

        const svgFromServer = det && det.svg || '';
        if(svgFromServer){
          setFromSvg(svgFromServer, id);
        }else if(it.svg){
          setFromSvg(it.svg, id);
        }else if(it.img){
          const u=ABS(ipfsToHttp(it.img)).trim();
          if(/\.svg(\?|$)/i.test(u)){
            await injectSvgFromUrl('#itThumb', u, 80);
            svgHidden.value = await (async()=>{ try{ const r=await fetch(u); return await r.text(); }catch{return ''} })();
          }else{
            if(imgIn) imgIn.value=u;
            setThumb('itThumb', proxy(u));
            svgHidden.value='';
          }
        }

        updateVoucherPreview();
      }

      sel.addEventListener('change', onChange);
      priceInput?.addEventListener('input', updateVoucherPreview);

      const btn=$('#refreshCrafted');
      if(btn){
        btn.addEventListener('click', async ()=>{
          btn.disabled=true; btn.textContent='Refreshing…';
          try{
            const user=who();
            const state=await fetchState(user);
            fillSelect(sel, itemsFromState(state), document.getElementById(hid)?.value, false);
          }finally{
            btn.disabled=false; btn.textContent='Refresh';
          }
        });
      }

      (async()=>{ try{
        const user=who();
        const state=await fetchState(user);
        fillSelect(sel, itemsFromState(state), document.getElementById(hid)?.value, false);
        updateVoucherPreview();
      }catch{} })();
    })();

    // --- Edit rows wiring (unchanged) ---
    (function wireEdit(){
      $all('.craftedEditSelect').forEach(sel=>{
        const row=sel.closest('tr');
        const id=sel.getAttribute('data-item-id');

        const hidId='crafted_item_id_'+id;
        const fkId='fulfillment_kind_'+id;
        const catId='category_'+id;
        const partId='crafted_part_'+id;
        const metaTypeId='meta_type_'+id;

        const cur=document.getElementById(hidId)?.value || '';

        sel.addEventListener('change', ()=>{
          const v=sel.value||'';
          markAsCrafting(hidId,fkId,catId,partId,metaTypeId,v);
          if(!v) return;
          const it=CRAFT_ITEMS[v]||{};
          const tEl=row.querySelector('input[name="title"]');
          const iEl=row.querySelector('input[name="image_url"]');
          if(tEl) tEl.value = it.title || tEl.value;
          if(iEl && it.img) iEl.value = ABS(ipfsToHttp(it.img)).trim();
        });

        (async()=>{ try{
          const user=USERNAME;
          const state=await fetchState(user);
          const items=itemsFromState(state);
          fillSelect(sel, items, cur, true);
        }catch{} })();
      });
    })();
  })();

  // ---------- Enhance list thumbs (unchanged) ----------
  (async function enhanceListThumbs(){
    const boxes = $all('.itimg');
    await Promise.all(boxes.map(async box=>{
      const img = box.querySelector('img');
      if(!img) return;
      let u;
      try{ const p = new URL(img.src, location.href); u = p.searchParams.get('src') || img.src; }catch{ u = img.src; }
      const real = decodeURIComponent(u||'');
      if(/\.svg(\?|$)/i.test(real)){
        const ok = await (async()=>{
          try{
            const r=await fetch(real, {credentials:'omit', cache:'force-cache'});
            if(!r.ok) return false;
            const svg=await r.text();
            return injectSvg(box, svg, 80);
          }catch{ return false; }
        })();
        if(!ok){ /* leave <img> */ }
      }
    }));
  })();

  // ================== IZZA Wallet — same local-vault model as token showcase ==================
  // Vault layout: localStorage['izza_test_wallet'] = JSON string { pub, sec? }
  function __readVault(){
    try{ const s=localStorage.getItem('izza_test_wallet'); if(!s) return null; const j=JSON.parse(s); if(!j||typeof j!=='object') return null; return j; }catch{ return null; }
  }
  function __writeVault(j){
    try{ localStorage.setItem('izza_test_wallet', JSON.stringify(j||{})); }catch{}
  }
  function __forgetSecret(pub){
    try{
      const v=__readVault()||{};
      if(v && v.pub===pub){ delete v.sec; __writeVault(v); }
    }catch{}
  }
  function getLocalSecret(pub){
    try{ const v=__readVault(); if(!v) return ''; if(pub && v.pub!==pub) return ''; return v.sec||''; }catch{ return ''; }
  }
  async function fetchActiveWallet(u){
    const qs = u ? ('?u='+encodeURIComponent(u)) : '';
    const r = await fetch('/api/wallet/active'+qs, {credentials:'include'});
    if(!r.ok) return null;
    return r.json().catch(()=>null);
  }
  async function linkActiveWallet(u, sec){
    const qs = u ? ('?u='+encodeURIComponent(u)) : '';
    const r = await fetch('/api/wallet/link'+qs, {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ sec }), credentials:'include'});
    if(!r.ok) return null;
    return r.json().catch(()=>null);
  }
  function isLocalWallet(pub){
    const v=__readVault(); return !!(v && v.pub===pub && v.sec && v.sec.startsWith('S'));
  }

  async function ensureUserAndWalletGate(){
    const u = USERNAME;
    if(!u){ alert('Please sign in with Pi first.'); return null; }
    const active = await fetchActiveWallet(u);
    const pub = active && active.pub || '';
    if(!pub){ alert('Open your IZZA wallet and set an active wallet first.'); return null; }
    if(!isLocalWallet(pub)){
      // open modal to let them paste the S key
      openMyWallet();
      alert('Open your IZZA wallet and save your S key locally first.');
      return null;
    }
    return { user:u, pub, sec:getLocalSecret(pub) };
  }

  // Minimal wallet modal wiring
  function openMyWallet(){ $('#myWalletModal')?.removeAttribute('hidden'); refreshMyWalletModal(); }
  function closeMyWallet(){ $('#myWalletModal')?.setAttribute('hidden',''); }
  async function refreshMyWalletModal(){
    const u = USERNAME;
    $('#mwUser').textContent = u ? '@'+u : '—';
    const active = await fetchActiveWallet(u);
    const pub = active && active.pub || '';
    $('#mwPub').textContent = pub || '—';
    const has = pub && isLocalWallet(pub);
    $('#mwSStatus').innerHTML = has ? '<span class="success">Saved locally</span>' : '<span class="warn">Not saved</span>';
  }
  $('#openWalletBtn')?.addEventListener('click', openMyWallet);
  $('#closeMyWalletBtn')?.addEventListener('click', closeMyWallet);

  // >>>>>>>>>>>>>>>>>>>> MINIMAL, TARGETED CHANGES START <<<<<<<<<<<<<<<<<<<<
  $('#mwSaveBtn')?.addEventListener('click', async ()=>{
    const u=USERNAME;
    const active = await fetchActiveWallet(u);
    const pub = active && active.pub || '';
    if(!pub){ alert('No active wallet found. Open the IZZA wallet from the token page to set one, or import here.'); return; }

    // normalize secret: strip whitespace, uppercase, strict base32 check
    const raw = ($('#mwSInput')?.value||'');
    const sec = raw.toUpperCase().replace(/[\s\r\n\t]+/g,'').trim();
    if(!/^S[2-7A-Z]{55}$/.test(sec)){ alert('Enter a valid S key'); return; }

    const v=__readVault()||{};
    v.pub = pub; v.sec = sec; __writeVault(v);
    // also link to server vault for signing endpoints that require it
    await linkActiveWallet(USERNAME, sec);
    $('#mwSInput').value='';
    refreshMyWalletModal();
    alert('S key saved locally for this wallet.');
  });
  // >>>>>>>>>>>>>>>>>>>> MINIMAL, TARGETED CHANGES END <<<<<<<<<<<<<<<<<<<<<<

  $('#mwForgetBtn')?.addEventListener('click', async ()=>{
    const active = await fetchActiveWallet(USERNAME);
    const pub = active && active.pub || '';
    if(pub) __forgetSecret(pub);
    refreshMyWalletModal();
  });

  // ================== NFT mint UI wiring (new) ==================
  (function(){
    const enable = $('#nftEnableToggle');
    const formWrap = $('#nftForm');
    const kindSel = $('#nftKind');
    const sizeInp = $('#nftSize');
    const prefix  = $('#nftPrefix');
    const tagInp  = $('#nftTag');
    const quoteBtn= $('#nftQuoteBtn');
    const mintBtn = $('#nftMintBtn');
    const hint    = $('#nftQuoteHint');
    const statusPill = $('#nftStatusPill');

    function setEnabled(on){
      formWrap.style.display = on ? '' : 'none';
      $('#nft_enabled').value = on ? '1' : '';
      if(!on){
        hint.textContent=''; mintBtn.disabled=true; statusPill.hidden=true;
        $('#nft_assets_json').value='';
      }
    }
    setEnabled(false);

    enable?.addEventListener('change', ()=>{
      const crafted = ($('#crafted_item_id')?.value||'').trim();
      if(!crafted && enable.checked){
        alert('Attach a crafted item first to mint as NFT.');
        enable.checked=false; return;
      }
      setEnabled(enable.checked);
    });

    kindSel?.addEventListener('change', ()=>{
      if(kindSel.value==='collection'){ sizeInp.disabled=false; }
      else { sizeInp.disabled=true; sizeInp.value='1'; }
    });

    quoteBtn?.addEventListener('click', async ()=>{
      try{
        quoteBtn.disabled=true; hint.textContent='Getting quote…';
        const body = {
          kind: kindSel.value==='collection' ? 'collection' : 'single',
          size: kindSel.value==='collection' ? Math.max(1, parseInt(sizeInp.value||'1',10)) : 1
        };
        const r = await fetch('/api/nft/quote', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body)});
        const j = await r.json();
        if(!j.ok) throw new Error('bad quote');
        hint.textContent = `Fee: ${j.total} IZZA (${j.size} × ${j.per_unit} IZZA)`;
        mintBtn.disabled=false;
        // stash visible choices into hidden inputs so server can persist with the item
        $('#nft_kind').value   = body.kind;
        $('#nft_size').value   = String(body.size);
        $('#nft_prefix').value = (prefix.value||'NFT').trim();
        $('#nft_tag').value    = (tagInp.value||'').trim();
      }catch(e){
        hint.textContent='Failed to quote.';
        mintBtn.disabled=true;
      }finally{
        quoteBtn.disabled=false;
      }
    });

    mintBtn?.addEventListener('click', async ()=>{
      try{
        mintBtn.disabled=true; hint.textContent='Minting…';
        const gate = await ensureUserAndWalletGate();
        if(!gate){ hint.textContent='Open your IZZA wallet and save your S key locally first.'; mintBtn.disabled=false; return; }

        const body = {
          creator_pub: gate.pub,
          creator_sec: gate.sec,
          kind: $('#nft_kind').value || 'single',
          size: parseInt($('#nft_size').value||'1',10) || 1,
          prefix: ($('#nft_prefix').value||'NFT').trim(),
          collection_tag: ($('#nft_tag').value||'').trim()
        };

        const r = await fetch('/api/nft/mint', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body)});
        const j = await r.json();
        if(!j.ok || !j.assets){ throw new Error(j.error || 'mint_failed'); }
        $('#nft_assets_json').value = JSON.stringify(j.assets);
        statusPill.hidden=false;
        statusPill.textContent = `Minted ${j.assets.length}`;
        hint.textContent = `Minted ${j.assets.length}. Fee paid: ${j.total_fee} IZZA`;
        alert(`Minted ${j.assets.length} NFT asset${j.assets.length>1?'s':''}. You can now add the product; the listing will carry these codes.`);
      }catch(e){
        console.error(e);
        alert('Mint failed: ' + (e && e.message || e));
        hint.textContent='Mint failed.';
      }finally{
        mintBtn.disabled=false;
      }
    });
  })();

  // ---------- mount ----------
  wireColorways();

})();
</script>
</body>
</html>
