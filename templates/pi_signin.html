<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sign in with Pi ‚Äî IZZA PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    /* Page-specific tweaks */
    html,body{max-width:100%;overflow-x:hidden;}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}

    .wrap{max-width:980px;margin:0 auto;padding:16px}
    @media (min-width:640px){ .wrap{padding:24px} }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
      padding:8px 0; position:sticky; top:0; z-index:10;
      background:rgba(11,15,23,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--line);
    }

    /* Brand strip */
    .brand{display:flex;align-items:center}
    .brand-word{height:36px;filter:brightness(1.06) contrast(1.02)}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions a{white-space:nowrap}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
    h1{margin:0 0 8px;font-size:28px;line-height:1.15}
    p{color:var(--muted);margin:6px 0}
    .muted{color:var(--muted)}
    .hero-actions{display:flex;gap:10px;flex-wrap:wrap}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">
        <img src="/static/izzapay-word.svg" class="brand-word" alt="IZZA PAY wordmark">
      </div>
      <div class="actions">
        <a class="ip-btn ghost" href="/explore">Browse Stores</a>
        <a class="ip-btn ghost" href="/privacy">Privacy</a>
      </div>
    </div>

    <!-- Sign-in card -->
    <div class="card" style="margin-top:12px">
      <h1>Sign in with Pi</h1>
      <p>Create your merchant store, add products, and accept Pi in minutes.</p>

      <div class="pillrow">
        <span class="ip-pill">1% app fee</span>
        <span class="ip-pill">99% to merchant</span>
        <span class="ip-pill">Pi SDK v2</span>
      </div>

      <div class="hero-actions">
        <button id="piSignInBtn" class="ip-btn">Authorize with Pi</button>
        <a class="ip-btn ghost" href="/orders">View My Purchases</a>
        <a class="ip-btn ghost" href="/explore">See Stores</a>
        <!-- NEW: Play IZZA GAME -->
        <a class="ip-btn" href="/izza-game/auth" aria-label="Play IZZA GAME">üéÆ Play IZZA GAME</a>
      </div>

      <!-- New note -->
      <p class="muted" style="margin-top:6px;font-size:13px">
        * Sales can be viewed through your merchant dashboard. Authorize with Pi above!
      </p>
      <p class="muted" style="margin-top:6px;font-size:13px">
        üéÆ You can jump into IZZA GAME any time. If you are not signed in, you will be asked to authorize with Pi first.
      </p>

      <p id="msg" class="muted"></p>
      <div id="err" style="color:#ff9aa2;white-space:pre-wrap"></div>
    </div>

    <!-- How it works -->
    <div class="card" style="margin-top:14px">
      <ol style="margin:0;padding-left:18px">
        <li style="margin:8px 0">
          <strong>Authorize with Pi.</strong>
          <span class="muted">You‚Äôll stay inside the Pi Browser.</span>
        </li>
        <li style="margin:8px 0">
          <strong>Create your store &amp; add products.</strong>
          <span class="muted">Upload images, set prices, and pick a theme and fonts.</span>
        </li>
        <li style="margin:8px 0">
          <strong>Share your store link.</strong>
          <span class="muted">Customers sign in with Pi and pay instantly.</span>
        </li>
      </ol>
    </div>
  </div>

  <script>
  (function(){
    const btn = document.getElementById('piSignInBtn');
    const msg = document.getElementById('msg');
    const err = document.getElementById('err');
    const postUrl = "/auth/exchange";
    const sandbox = {{ 'true' if sandbox else 'false' }};

    function setMsg(t){ if(msg){ msg.textContent = t || ''; } }
    function setErr(t){ if(err){ err.textContent = t || ''; } }

    function initPi(){
      if (!window.Pi || !Pi.init) return false;
      try { Pi.init({ version: "2.0", sandbox: sandbox }); return true; }
      catch(e){ console.error("Pi.init failed", e); setErr("Pi.init failed: " + (e?.message || e)); return false; }
    }
    if (!initPi()) setMsg("Open in Pi Browser or refresh. (Pi SDK not ready)");

    btn?.addEventListener('click', function(){
      setErr('');
      if (!window.Pi || !Pi.authenticate) { setMsg("Pi SDK not available. Open in Pi Browser or refresh."); return; }
      setMsg("Requesting authorization‚Ä¶");
      const scopes = ['payments','username'];
      function onIncompletePaymentFound(payment){ }
      Pi.authenticate(scopes, onIncompletePaymentFound)
        .then(function(auth){
          const form = document.createElement('form');
          form.method = 'POST'; form.action = postUrl;
          const inp = document.createElement('input');
          inp.type='hidden'; inp.name='payload';
          inp.value = JSON.stringify({ accessToken: auth.accessToken, user: auth.user });
          form.appendChild(inp); document.body.appendChild(form); form.submit();
        })
        .catch(function(e){
          console.error(e);
          setMsg("Authorization failed. Please try again.");
          setErr(e?.message || String(e));
        });
    });
  })();
  </script>

  <!-- ADDITIVE: Language selector chip (persists to localStorage.izzaLang and reloads) -->
  <script>
  (function(){
    var KEY='izzaLang';
    var LABEL='Language: ';
    var choices=[
      ['af','Afrikaans'],['ar','ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'],['bn','‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ'],['bg','–ë—ä–ª–≥–∞—Ä—Å–∫–∏'],['ca','Catal√†'],
      ['cs','ƒåe≈°tina'],['da','Dansk'],['de','Deutsch'],['el','ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨'],['en','English'],
      ['es','Espa√±ol'],['et','Eesti'],['fa','ŸÅÿßÿ±ÿ≥€å'],['fi','Suomi'],['fil','Filipino'],
      ['fr','Fran√ßais'],['gu','‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä'],['he','◊¢◊ë◊®◊ô◊™'],['hi','‡§π‡§ø‡§®‡•ç‡§¶‡•Ä'],['hr','Hrvatski'],
      ['hu','Magyar'],['id','Indonesia'],['it','Italiano'],['ja','Êó•Êú¨Ë™û'],['kn','‡≤ï‡≤®‡≥ç‡≤®‡≤°'],
      ['ko','ÌïúÍµ≠Ïñ¥'],['lt','Lietuvi≈≥'],['lv','Latvie≈°u'],['ms','Melayu'],['nl','Nederlands'],
      ['no','Norsk'],['pl','Polski'],['pt','Portugu√™s'],['ro','Rom√¢nƒÉ'],['ru','–†—É—Å—Å–∫–∏–π'],
      ['sk','Slovenƒçina'],['sl','Sloven≈°ƒçina'],['sv','Svenska'],['ta','‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'],['te','‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å'],
      ['th','‡πÑ‡∏ó‡∏¢'],['tr','T√ºrk√ße'],['uk','–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'],['ur','ÿßÿ±ÿØŸà'],['vi','Ti·∫øng Vi·ªát'],
      ['zh','‰∏≠Êñá']
    ];
    function getLang(){ try{ return localStorage.getItem(KEY)||'en'; }catch(_){ return 'en'; } }
    function setLang(v){
      try{
        localStorage.setItem(KEY,v);
        try{ window.dispatchEvent(new CustomEvent('izza-lang-changed',{detail:{lang:v}})); }catch(_){}
        location.reload();
      }catch(_){}
    }
    var wrap=document.createElement('div');
    Object.assign(wrap.style,{position:'fixed',right:'10px',bottom:'10px',zIndex:'9999',background:'#121827',border:'1px solid #2a3550',borderRadius:'10px',padding:'6px 8px',font:'12px/1.2 system-ui,Arial,sans-serif',color:'#cfe0ff',boxShadow:'0 6px 18px rgba(0,0,0,.35)'});
    var sel=document.createElement('select'); sel.id='hsLang';
    choices.forEach(function(c){ var o=document.createElement('option'); o.value=c[0]; o.textContent=c[1]; sel.appendChild(o); });
    var lab=document.createElement('span'); lab.textContent=LABEL; wrap.appendChild(lab); wrap.appendChild(sel); document.body.appendChild(wrap);
    sel.value=getLang(); sel.addEventListener('change',function(){ setLang(this.value); });
  })();
  </script>

  <!-- ADDITIVE: Translation stub + auto-translate bootstrap -->
  <script>
  window.TRANSLATE_TEXT = async (text, from, to) => {
    try {
      const r = await fetch('/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, from, to })
      });
      const j = await r.json();
      return (j && j.ok && typeof j.text === 'string') ? j.text : text;
    } catch {
      return text;
    }
  };
</script>
  <script>
  (function(){
    const LANG_KEY='izzaLang';
    const to=(localStorage.getItem(LANG_KEY)||'en').slice(0,5);
    const from=(document.documentElement.getAttribute('lang')||'en').slice(0,5);
    if(typeof window.TRANSLATE_TEXT!=='function'){ window.TRANSLATE_TEXT=async t=>t; }
    const SKIP=new Set(['SCRIPT','STYLE','NOSCRIPT','CODE','PRE','TEXTAREA','INPUT','SELECT','OPTION']);
    function collect(root){
      const nodes=[]; const w=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,{acceptNode(n){
        const p=n.parentElement; if(!p||SKIP.has(p.tagName)) return NodeFilter.FILTER_REJECT;
        const s=n.nodeValue; if(!s||!s.trim()) return NodeFilter.FILTER_REJECT;
        if(p.closest('[data-no-i18n="1"]')) return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }});
      let n; while((n=w.nextNode())) nodes.push(n); return nodes;
    }
    async function translate(nodes){
      for(const n of nodes){
        try{
          const p=n.parentElement, orig=(p?.dataset?.i18nOriginal)||n.nodeValue;
          const out=(to===from)?orig:await window.TRANSLATE_TEXT(orig,from,to);
          if(p&&p.dataset) p.dataset.i18nOriginal=orig;
          if(typeof out==='string'&&out&&out!==n.nodeValue) n.nodeValue=out;
        }catch{}
      }
    }
    async function run(){ await translate(collect(document.body)); }
    const mo=new MutationObserver(muts=>{
      const batch=[]; for(const m of muts){
        if(m.type==='childList'){ m.addedNodes&&m.addedNodes.forEach(nd=>{ if(nd.nodeType===1) batch.push(...collect(nd)); else if(nd.nodeType===3) batch.push(nd); }); }
        else if(m.type==='characterData'&&m.target&&m.target.nodeType===3) batch.push(m.target);
      }
      if(batch.length) translate(batch);
    });
    function arm(){ try{ mo.observe(document.body,{childList:true,characterData:true,subtree:true}); }catch{} }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',()=>{ run(); arm(); },{once:true}); } else { run(); arm(); }
  })();
  </script>
</body>
</html>
