<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add IZZA Trustline</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
             background:#000; color:#fff; text-align:center; padding:10% 16px; }
      a.btn { display:inline-block; padding:12px 22px; border-radius:10px;
              color:#111; text-decoration:none; font-weight:700;
              background:linear-gradient(90deg,#ffd166,#ffe29a); }
      .ghost { display:inline-block; padding:10px 16px; border:1px solid #ffd166;
               border-radius:10px; color:#ffd166; text-decoration:none; font-weight:600;
               margin-top:8px; }
      pre { text-align:left; background:#0b0b0f; padding:10px; border-radius:8px;
            color:#ccc; max-width:680px; margin:16px auto 0; white-space:pre-wrap; }
    </style>
  </head>
  <body>
    <h1>IZZA Token Trustline</h1>
    <p>Open in <b>Pi Browser</b>, then tap a button below.</p>

    <p>
      <a id="btn-direct" class="btn" href="#">Open with Pi Wallet</a>
    </p>
    <p>
      <a id="btn-https" class="ghost" href="/trust/open" target="_top">Try HTTPS Redirect</a>
    </p>
    <p>
      <a id="btn-copy" class="ghost" href="#">Copy Deep Link</a>
    </p>

    <pre id="dbg">Log:</pre>

    <script>
      const deepLink = {{ url|tojson }};
      const dbg = document.getElementById('dbg');

      function msg(s){ try{ dbg.textContent += "\n" + s; }catch(e){} }
      function log(kind, extra){
        try {
          fetch('/_log', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(Object.assign({kind}, extra||{}))
          });
        } catch(e){}
      }

      // Boot info
      (function(){
        const ua = navigator.userAgent || '';
        const inTop = (window === window.top);
        msg("UA: " + ua);
        msg("In iframe: " + (!inTop));
        log('trust_client_boot', {ua, inIframe: !inTop});
      })();

      // Buttons
      document.getElementById('btn-direct').addEventListener('click', function(e){
        e.preventDefault();
        log('trust_click', {button:'direct', step:'top.href'});
        msg("Direct: navigating top to web+stellar...");
        try { (window.top || window).location.href = deepLink; } catch(e) {}

        // Chain a couple of fallbacks (still near same gesture on many UAs)
        setTimeout(()=>{ try{ log('trust_click',{button:'direct',step:'replace'}); location.replace(deepLink); }catch(e){} }, 50);
        setTimeout(()=>{ try{ log('trust_click',{button:'direct',step:'open_self'}); window.open(deepLink,'_self'); }catch(e){} }, 100);
      });

      document.getElementById('btn-https').addEventListener('click', function(){
        log('trust_click', {button:'https_redirect'});
        // No preventDefault → real navigation to /trust/open (302 → web+stellar)
      });

      document.getElementById('btn-copy').addEventListener('click', async function(e){
        e.preventDefault();
        try {
          await navigator.clipboard.writeText(deepLink);
          msg("Copied. Paste into the Pi Browser address bar and tap Go.");
          log('trust_click', {button:'copy', copied:true});
        } catch(e) {
          msg("Copy failed. Long-press a button and choose Copy Link.");
          log('trust_click', {button:'copy', copied:false});
        }
      });

      // Optional gentle auto attempt (ignored by iOS without gesture, but harmless)
      setTimeout(() => {
        log('trust_auto_nav', {via:'setTimeout'});
        try { window.location.href = deepLink; } catch(e){}
      }, 1200);
    </script>
  </body>
</html>
