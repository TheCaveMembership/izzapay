<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add IZZA Trustline</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
             background:#000; color:#fff; text-align:center; padding:10% 16px; }
      a.btn { display:inline-block; padding:12px 22px; border-radius:10px;
              color:#111; text-decoration:none; font-weight:700;
              background:linear-gradient(90deg,#7a44ff,#b784ff);
              box-shadow:0 0 15px rgba(183,132,255,.4); }
      .ghost { display:inline-block; padding:10px 16px; border:1px solid #b784ff;
               border-radius:10px; color:#b784ff; text-decoration:none; font-weight:600; margin-top:8px; }
      pre { text-align:left; background:#0b0b0f; padding:10px; border-radius:8px;
            color:#ccc; max-width:680px; margin:16px auto 0; white-space:pre-wrap; }
    </style>
  </head>
  <body data-no-global-i18n="1">
    <h1>IZZA Token Trustline</h1>
    <p>Open in <b>Pi Browser</b>, then tap a button below.</p>

    <!-- IMPORTANT: give iOS a plain top-level anchor to the custom scheme -->
    <p><a id="btn-direct" class="btn" href="{{ url }}" target="_top">Open with Pi Wallet</a></p>
    <p><a id="btn-https" class="ghost" href="/trust/open" target="_top">Try HTTPS Redirect</a></p>
    <p><a id="btn-copy" class="ghost" href="#">Copy Deep Link</a></p>

    <pre id="dbg">Log:</pre>

    <script>
      const deepLink = {{ url|tojson }};
      const dbg = document.getElementById('dbg');
      function msg(s){ try{ dbg.textContent += "\n" + s; }catch(e){} }
      function log(kind, extra){
        try {
          fetch('/_log', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(Object.assign({kind}, extra||{}))
          });
        } catch(e){}
      }

      // Boot info
      (function(){
        const ua = navigator.userAgent || '';
        const inTop = (window === window.top);
        msg("UA: " + ua);
        msg("In iframe: " + (!inTop));
        log('trust_client_boot', {ua, inIframe: !inTop});
      })();

      // Also wire the main button for JS-driven attempts (keeps prior fallbacks)
      document.getElementById('btn-direct').addEventListener('click', function(e){
        // Don't preventDefault: we want the native navigation too.
        log('trust_click', {button:'direct', step:'top.href'});
        msg("Direct: navigating top to web+stellar...");
        try { (window.top || window).location.href = deepLink; } catch(e) {}
        setTimeout(()=>{ try{ log('trust_click',{button:'direct',step:'replace'}); location.replace(deepLink); }catch(e){} }, 50);
        setTimeout(()=>{ try{ log('trust_click',{button:'direct',step:'open_self'}); window.open(deepLink,'_self'); }catch(e){} }, 100);
      });

      document.getElementById('btn-https').addEventListener('click', function(){
        log('trust_click', {button:'https_redirect'});
      });

      document.getElementById('btn-copy').addEventListener('click', async function(e){
        e.preventDefault();
        try {
          await navigator.clipboard.writeText(deepLink);
          msg("Copied. Paste into the Pi Browser address bar and tap Go.");
          log('trust_click', {button:'copy', copied:true});
        } catch(e) {
          msg("Copy failed. Long-press a button and choose Copy Link.");
          log('trust_click', {button:'copy', copied:false});
        }
      });

      // Gentle auto-attempt (harmless if blocked)
      setTimeout(() => {
        log('trust_auto_nav', {via:'setTimeout'});
        try { window.location.href = deepLink; } catch(e){}
      }, 1200);
    </script>
  </body>
</html>
