<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Checkout — {{ i.title if i else 'Cart' }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0b0f17; --card:#0f1728; --line:#1f2a44; --txt:#e8f0ff; --muted:#bcd0ff; --brand:#6e9fff;
    }
    .cw-blue   { --brand:#6e9fff; }
    .cw-mint   { --brand:#5ad49e; }
    .cw-purple { --brand:#a88cff; }
    .cw-amber  { --brand:#ffb86b; }
    .light { --bg:#f6f7fb; --card:#ffffff; --line:#e6e8f0; --txt:#0b0f17; --muted:#4b587c; }

    body{
      font-family: {{ (m.font_family if m is defined and m and m.font_family else (i.font_family if i and i.font_family else 'Arial,Helvetica,sans-serif')) }};
      background:var(--bg); color:var(--txt); margin:0
    }
    .wrap{max-width:620px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
    .col{flex:1;min-width:220px}
    .muted{color:var(--muted)}
    .label{display:block;color:var(--muted);font-size:.9rem;margin:6px 0 4px}
    input{width:100%;background:#0b1222;border:1px solid var(--line);border-radius:10px;color:#fff;padding:10px}
    .btn{background:var(--brand);color:#0b0f17;border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-block}
    .light input{ background:#ffffff; }

    /* Order summary dropdown */
    details.order-summary{border:1px solid var(--line);border-radius:10px;padding:10px;background:rgba(255,255,255,.02)}
    details.order-summary > summary{
      cursor:pointer; list-style:none; display:flex; align-items:center; justify-content:space-between;
      gap:10px; font-weight:800; user-select:none;
    }
    details.order-summary > summary::-webkit-details-marker{display:none}
    .chev{transition:transform .2s ease}
    details[open] .chev{transform:rotate(180deg)}
    .summary-list{margin:10px 0 0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px}
    .summary-item{display:flex; align-items:center; gap:10px}
    .thumb{width:40px; height:40px; border-radius:8px; border:1px solid var(--line); overflow:hidden; background:#0001; flex:0 0 40px}
    .thumb img, .thumb svg, .thumb object{width:100%; height:100%; display:block; object-fit:cover}
    .title{font-weight:700}
    .qty{color:var(--muted); font-size:.9rem}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
{% set cw = (i.colorway if i and i.colorway else (m.colorway if m is defined and m and m.colorway else 'cw-blue')) %}
{% set is_light = (i.theme_mode=='light') if i and (i.theme_mode is defined) else ((m.theme_mode=='light') if (m is defined and m and (m.theme_mode is defined)) else False) %}
<body class="{{ cw }} {% if is_light %}light{% endif %}">
<div class="wrap">
  {% if sold_out %}
    <div class="card">
      <h2>Sold out</h2>
      <p class="muted">This item is not available.</p>
    </div>
  {% else %}
    <div class="card">
      <div class="row" style="align-items:center">
        {% if i and i.logo_url %}
          <img src="/uimg?src={{ i.logo_url | urlencode }}" alt="" style="height:36px;border-radius:6px;border:1px solid var(--line)">
        {% endif %}
        <div>
          <div style="font-weight:800">{{ (i.business_name if i else (m.business_name if m is defined and m else '')) or 'Store' }}</div>
          <div class="muted">{{ i.title if i else 'Cart total' }}</div>
        </div>
      </div>

      {# ===== ORDER SUMMARY (dropdown) ===== #}
      {% set item_count = (qty if not cart_mode else (
           (rows|sum(attribute='qty') if (rows is defined) else 1)
         )) %}
      <details class="order-summary" style="margin-top:12px">
        <summary>
          <span>Order summary • {{ item_count }} {{ 'item' if item_count==1 else 'items' }}</span>
          <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </summary>

        <ul class="summary-list">
          {% if cart_mode and (rows is defined) and rows %}
            {% for r in rows %}
              {% set r_svg = (r.svg_code or '') | trim %}
              {% set r_img = (r.image_url or '') | trim %}
              <li class="summary-item">
                <div class="thumb">
                  {% if r_svg %}
                    {{ r_svg | safe }}
                  {% elif r_img and (r_img|lower).endswith('.svg') %}
                    <object type="image/svg+xml" data="{{ r_img }}"></object>
                  {% elif r_img %}
                    <img src="/uimg?src={{ r_img | urlencode }}" alt="">
                  {% endif %}
                </div>
                <div style="flex:1">
                  <div class="title">{{ r.title }}</div>
                  <div class="qty">{{ '%.7f'|format(r.pi_price) }} Pi × {{ r.qty }}</div>
                </div>
              </li>
            {% endfor %}
          {% else %}
            {% set i_svg = (i.svg_code or '') | trim %}
            {% set i_img = (i.image_url or '') | trim %}
            <li class="summary-item">
              <div class="thumb">
                {% if i_svg %}
                  {{ i_svg | safe }}
                {% elif i_img and (i_img|lower).endswith('.svg') %}
                  <object type="image/svg+xml" data="{{ i_img }}"></object>
                {% elif i_img %}
                  <img src="/uimg?src={{ i_img | urlencode }}" alt="">
                {% endif %}
              </div>
              <div style="flex:1">
                <div class="title">{{ i.title if i else 'Item' }}</div>
                <div class="qty">{{ '%.7f'|format(expected_pi / (qty or 1)) }} Pi × {{ qty }}</div>
              </div>
            </li>
          {% endif %}
        </ul>
      </details>

      <div style="margin-top:12px">
        <div>Quantity: <strong>{{ qty }}</strong></div>
        <div>Total: <strong>{{ '%.7f'|format(expected_pi) }} Pi</strong></div>
      </div>
    </div>

    <!-- Buyer & Shipping details -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label class="label" for="buyer_email">Email (for receipt/tracking)</label>
          <input id="buyer_email" type="email" placeholder="you@example.com" autocomplete="email" required>
        </div>
        <div class="col">
          <label class="label" for="buyer_name">Full name</label>
          <input id="buyer_name" placeholder="Your name" autocomplete="name">
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:2">
          <label class="label" for="ship_address">Address</label>
          <input id="ship_address" placeholder="Street" autocomplete="address-line1">
        </div>
        <div class="col">
          <label class="label" for="ship_address2">Apartment / Unit</label>
          <input id="ship_address2" placeholder="Apt, Unit, Suite" autocomplete="address-line2">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label class="label" for="ship_city">City</label>
          <input id="ship_city" placeholder="City" autocomplete="address-level2">
        </div>
        <div class="col">
          <label class="label" for="ship_state">State/Region</label>
          <input id="ship_state" placeholder="State/Region" autocomplete="address-level1">
        </div>
        <div class="col">
          <label class="label" for="ship_postal">Postal</label>
          <input id="ship_postal" placeholder="Postal code" autocomplete="postal-code">
        </div>
        <div class="col">
          <label class="label" for="ship_country">Country</label>
          <input id="ship_country" placeholder="Country" autocomplete="country-name">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label class="label" for="buyer_phone">Phone (optional)</label>
          <input id="buyer_phone" placeholder="Phone" autocomplete="tel">
        </div>
      </div>

      <p class="muted" style="margin-top:8px">If shipping isn’t needed, you can leave the address fields blank.</p>
    </div>

    <div class="card">
      <button id="payBtn" class="btn">Pay with Pi</button>
      <p id="msg" class="muted" style="margin-top:10px;"></p>
    </div>
  {% endif %}
</div>

<script>
(function(){
  const sessionId   = "{{ session_id|e }}";
  const amount      = {{ expected_pi if expected_pi else 0 }};
  const cartMode    = {{ 'true' if cart_mode else 'false' }};
  const sandbox     = {{ 'true' if PI_SANDBOX else 'false' }};
  const appId       = "{{ PI_APP_ID or '' }}";
  const storeName   = "{{ (i.business_name if i else (m.business_name if m is defined and m else 'IZZA PAY')) | e }}";
  const redirectSlug= "{{ slug if slug else '' }}";

  const btn = document.getElementById('payBtn');
  const msg = document.getElementById('msg');

  const emailEl = document.getElementById('buyer_email');
  const nameEl  = document.getElementById('buyer_name');
  const phoneEl = document.getElementById('buyer_phone');

  const addrEl  = document.getElementById('ship_address');
  const addr2El = document.getElementById('ship_address2');
  const cityEl  = document.getElementById('ship_city');
  const stateEl = document.getElementById('ship_state');
  const postEl  = document.getElementById('ship_postal');
  const ctryEl  = document.getElementById('ship_country');

  function setMsg(t){ if(msg) msg.textContent = t || ''; }

  function initPi(){
    try{
      if (!window.Pi || !Pi.init) return false;
      if (appId) { Pi.init({ version: "2.0", sandbox: sandbox, appId: appId }); }
      else       { Pi.init({ version: "2.0", sandbox: sandbox }); }
      return true;
    }catch(e){ return false; }
  }

  /* === EXACT ADD: run completion for a previously stuck payment before starting a new one === */
  function onIncompletePaymentFound(payment){
    try{
      var pid  = payment && (payment.identifier || payment.paymentId || payment.id);
      var txid = payment && payment.transaction && (payment.transaction.txid || payment.transaction.txID || payment.transaction.hash) || "";
      if(!pid) return;

      fetch('/api/pi/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paymentId: pid,
          session_id: sessionId,
          txid: txid,
          buyer: {
            email: (emailEl?.value || '').trim(),
            name:  (nameEl?.value  || '').trim(),
            phone: (phoneEl?.value || '').trim()
          },
          shipping: {
            address:      (addrEl?.value  || '').trim(),
            address2:     (addr2El?.value || '').trim(),
            city:         (cityEl?.value  || '').trim(),
            state:        (stateEl?.value || '').trim(),
            postal_code:  (postEl?.value  || '').trim(),
            country:      (ctryEl?.value  || '').trim(),
            name:         (nameEl?.value  || '').trim(),
            email:        (emailEl?.value || '').trim(),
            phone:        (phoneEl?.value || '').trim()
          }
        })
      })
      .then(function(r){ return r.ok ? r.json() : null; })
      .then(function(res){
        if(res && (res.redirect_url || res.buyer_status_url)){
          window.location.href = (res.redirect_url || res.buyer_status_url);
        }
      })
      .catch(function(){});
    }catch(_){}
  }

  function ensureAuth(){
    const scopes = ['payments','username'];
    return Pi.authenticate(scopes, onIncompletePaymentFound);
  }

  function buyerPayload(){
    return {
      email: (emailEl?.value || '').trim(),
      name:  (nameEl?.value || '').trim(),
      phone: (phoneEl?.value || '').trim()
    };
  }

  function shippingPayload(){
    return {
      address:      (addrEl?.value || '').trim(),
      address2:     (addr2El?.value || '').trim(),
      city:         (cityEl?.value || '').trim(),
      state:        (stateEl?.value || '').trim(),
      postal_code:  (postEl?.value || '').trim(),
      country:      (ctryEl?.value || '').trim(),
      name:         (nameEl?.value || '').trim(),
      email:        (emailEl?.value || '').trim(),
      phone:        (phoneEl?.value || '').trim()
    };
  }

  initPi();

  btn?.addEventListener('click', function(){
    const emailVal = (emailEl?.value || '').trim();
    if (!emailVal){
      setMsg('Please enter your email before continuing.');
      emailEl?.focus();
      return;
    }

    if (!window.Pi || !Pi.createPayment){
      setMsg("Open this page in the Pi Browser.");
      return;
    }

    setMsg('Opening Pi payment…');

    ensureAuth().then(() => {
      const memo = (storeName ? (storeName + ' — ') : '') +
                   (cartMode ? 'Cart' : 'Order') + ' ' + sessionId.slice(0, 8);

      const paymentData = {
        amount: amount,
        memo: memo,
        metadata: { session_id: sessionId }
      };

      Pi.createPayment(paymentData, {
        onReadyForServerApproval: function(paymentId){
          fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, session_id: sessionId })
          });
        },
        onReadyForServerCompletion: function(paymentId, txid){
          fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paymentId, session_id: sessionId, txid,
              buyer: buyerPayload(),
              shipping: shippingPayload()
            })
          })
          .then(r => r.json())
          .then(res => {
            const fallback = redirectSlug ? `/store/${redirectSlug}?success=1` : '/success';
            const target = (res && (res.redirect_url || res.buyer_status_url)) || fallback;
            window.location.href = target;
          })
          .catch(() => {
            const fallback = redirectSlug ? `/store/${redirectSlug}?success=1` : '/success';
            window.location.href = fallback;
          });
        },
        onCancel: function(){ setMsg("Payment canceled."); },
        onError:  function(){ setMsg("Please try again."); }
      });
    }).catch(() => {
      setMsg("Please try again.");
    });
  });
})();
</script>
</body>
</html>
