<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IZZA CREATURES, Mint, Hatch, Battle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --bg:#000; --txt:#e8f1ff; --muted:#9fb0d6; --line:#1d2540;
      --piPurple1:#7a44ff; --piPurple2:#b784ff; --gold1:#ffcf4d; --gold2:#ffb23a;
      --panel:#0b0f1f; --card:#0e1422;
    }
    html,body{background:#000;color:var(--txt);font-family:Inter,Arial,sans-serif;margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    .topbar{display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--line);
            position:sticky;top:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);z-index:50}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 18px;border-radius:14px;font-weight:700;letter-spacing:.2px;
         border:1px solid #2a3550;color:#cfe0ff;background:var(--panel);cursor:pointer;text-decoration:none}
    .btn.purple{background:linear-gradient(180deg,var(--piPurple1),var(--piPurple2));color:#fff;border-color:transparent}
    .btn.gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1400;border-color:transparent}
    h1{font-size:clamp(26px,8.5vw,56px);margin:16px 0 6px;text-align:center}
    p{color:var(--muted);text-align:center}
    .row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0 18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}

    .box{border:1px solid #2a3550;border-radius:16px;background:var(--panel);padding:14px}
    .col{flex:1 1 320px;max-width:520px}
    .box h3{margin:4px 0 10px}

    /* SIMPLE EGG PREVIEW */
    .slot{position:relative;overflow:hidden;border-radius:16px;border:1px solid #2a3550;background:var(--card);
          height:clamp(110px,22vw,160px);display:flex;align-items:center;justify-content:center}
    #eggPreview{display:block;width:120px;height:120px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .hint{font-size:12px;color:#9fb0d6;margin-top:6px;text-align:center}

    #liveSvg{ width:220px; height:220px; object-fit:contain;border-radius:12px;border:1px solid #223056;background:#0e1422 }

    /* Wallet modal on TOP of everything */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal[hidden]{display:none}
    .modal-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:560px;width:94%;padding:14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal-title{display:flex;align-items:center;gap:8px;font-weight:800}
    .close-btn{border:1px solid var(--line);border-radius:10px;background:#0b0f1f;padding:8px 10px;color:#fff;cursor:pointer}
    .small-muted{font-size:12px;color:#9fb0d6}
    .blox{display:flex;flex-direction:column;gap:6px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .success{color:#5ad49e}
    .warn{color:#ffb86b}

    /* Thumb grid */
    .thumb{display:inline-flex;flex-direction:column;align-items:center;gap:6px;margin:6px;padding:8px;border:1px solid #223056;border-radius:12px;background:#0e1422}
    .thumb img{width:88px;height:88px;object-fit:contain}
    .thumb .cap{font-size:12px;color:#9fb0d6}

    /* Minimal styling for tiny action buttons used by friends/notifications */
    .mp-small{font:600 12px/1 Inter,Arial,sans-serif;padding:6px 8px;border-radius:10px;border:1px solid #2a3550;background:#162134;color:#cfe0ff;cursor:pointer}
    .mp-small.ghost{background:#0f1522}
    .mp-small.outline{background:#0f1522;border:1px solid #3a4a78}
    .friend{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid #223056;border-radius:10px;background:#0e1422}
    .friend .meta{font-size:12px;opacity:.85}
    .friend .meta.active{color:#86f2c3}
    .friend .meta.offline{color:#9fb0d6}
    .searchbar{display:flex;gap:8px}
    .searchbar input{flex:1;min-width:140px;padding:8px 10px;border-radius:10px;border:1px solid #2a3550;background:#0f1522;color:#e8f1ff}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="/">BACK HOME</a>
      <button class="btn purple upper" id="openWallet">IZZA WALLET</button>
      <button class="btn" id="btnMyCreatures">MY CREATURES</button>
    </div>

    <h1>IZZA CREATURES</h1>
    <p>Pay 5 IZZA to mint an IZZA CREATURE EGG, watch it hatch live, then grow and battle.</p>

    <div class="grid">
      <div class="col box">
        <h3>Mint Egg</h3>
        <div class="slot"><img id="eggPreview" alt="egg"></div>
        <div class="row"><button class="btn purple" id="mintBtn">MINT EGG, 5 IZZA</button></div>
        <div class="hint">Egg ‚Äúspins‚Äù through a few looks and lands on yours</div>
        <div id="mintMsg" class="hint"></div>
      </div>

      <div class="col box">
        <h3>My Latest Creature</h3>
        <div id="liveWrap"><img id="liveSvg" alt="creature"></div>
        <div class="row">
          <button class="btn" id="feedBtn">FEED</button>
          <a class="btn" id="openHabitat" target="_blank" rel="noopener">OPEN HABITAT</a>
        </div>
        <div id="liveHint" class="hint"></div>
      </div>
    </div>

    <div class="box" id="myCreaturesBox" style="display:none;margin-top:14px">
      <h3>My Creatures</h3>
      <div id="myCreaturesList" class="row" style="justify-content:flex-start;flex-wrap:wrap"></div>
    </div>
  </div>

  <!-- Wallet modal -->
  <div class="modal" id="myWalletModal" role="dialog" aria-modal="true" aria-labelledby="myWalletTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="" style="width:22px;height:22px">
          <span id="myWalletTitle">My IZZA Wallet</span>
        </div>
        <button class="close-btn" type="button" id="closeMyWalletBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="blox">
          <div class="small-muted">Signed in as</div>
          <div><strong id="mwUser">‚Äî</strong></div>
        </div>
        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Active Wallet, public key</div>
          <div class="mono" id="mwPub">‚Äî</div>
          <div class="small-muted">Need to set or switch your active wallet? Open the full wallet once below, then return here to save your S-key locally.</div>
        </div>

        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Balances (Testnet)</div>
          <div>Test Pi: <strong id="balPi">‚Äî</strong></div>
          <div>IZZA: <strong id="balIzza">‚Äî</strong></div>
        </div>

        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Local S-key status</div>
          <div id="mwSStatus">‚Äî</div>
          <div class="row" style="margin-top:6px">
            <input class="btn" style="flex:1;min-width:240px;text-align:left" id="mwSInput" placeholder="S... private key" autocomplete="off" spellcheck="false" autocapitalize="none">
            <button class="btn purple" type="button" id="mwSaveBtn">Save S-key</button>
            <button class="btn" type="button" id="mwForgetBtn">Forget</button>
          </div>
          <div class="small-muted">Your S-key is stored locally on this device only.</div>
        </div>

        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <a class="btn gold" href="/token/auth?next=/token/izza">Open Full Wallet</a>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- Pi init ----------
  const sandbox = {{ 'true' if PI_SANDBOX else 'false' }};
  try{ if(window.Pi && Pi.init){ Pi.init({version:'2.0', sandbox:sandbox}); } }catch(e){}

  // ---------- DOM ----------
  const mintBtn = document.getElementById('mintBtn');
  const mintMsg = document.getElementById('mintMsg');
  const liveSvg = document.getElementById('liveSvg');
  const liveHint = document.getElementById('liveHint');
  const openHabitat = document.getElementById('openHabitat');
  const eggPreview = document.getElementById('eggPreview');

  // Curated preview seeds to ensure variety
  const previewSkins = [
    "LEG-sapphire-stripe",
    "EP-ember-metallic",
    "RARE-violet-swirl",
    "UN-mint-mosaic",
    "COM-gold-speckle",
    "RARE-rose-stripe",
    "EP-obsidian-metallic",
    "COM-turquoise-speckle"
  ];

  function loadEggSkin(seed){
    eggPreview.src = `/nftsvg/EGGDEMO.svg?skin=${encodeURIComponent(seed)}&nobg=1&nc=${Date.now()}`;
  }
  loadEggSkin(previewSkins[0]);

  async function spinEggs(finalSeed){
    for(let i=0;i<9;i++){
      loadEggSkin(previewSkins[i % previewSkins.length]);
      await new Promise(r=>setTimeout(r,120));
    }
    loadEggSkin(finalSeed);
  }

  // ---------- Local wallet helpers ----------
  function __readVault(){ try{ const s=localStorage.getItem('izza_test_wallet'); return s?JSON.parse(s):null; }catch{return null} }
  function __writeVault(j){ try{ localStorage.setItem('izza_test_wallet', JSON.stringify(j||{})); }catch{} }
  function __forgetSecret(pub){ try{ const v=__readVault()||{}; if(v && v.pub===pub){ delete v.sec; __writeVault(v); } }catch{} }
  function getLocalSecret(pub){ try{ const v=__readVault(); if(!v) return ''; if(pub && v.pub!==pub) return ''; return v.sec||''; }catch{return ''} }
  function isLocalWallet(pub){ const v=__readVault(); return !!(v && v.pub===pub && /^S[A-Z0-9]{55}$/.test(v.sec||'')); }

  async function fetchActiveWallet(username){
    const qs = username ? ('?u='+encodeURIComponent(username)) : '';
    const r = await fetch('/api/wallet/active'+qs, {credentials:'include'});
    if(!r.ok) return null;
    return r.json().catch(()=>null);
  }
  async function linkActiveWallet(username, pub, secret){
    const qs = username ? ('?u='+encodeURIComponent(username)) : '';
    const body = { pub: String(pub||'').trim().toUpperCase() };
    if(secret && /^S[A-Z0-9]{55}$/.test(secret)) body.secret = secret.trim();
    const r = await fetch('/api/wallet/link'+qs, { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body), credentials:'include' });
    const j = await r.json().catch(()=>null);
    return { ok:r.ok, status:r.status, json:j };
  }
  async function fetchBalances(username){
    const qs = username ? ('?u='+encodeURIComponent(username)) : '';
    const r = await fetch('/api/wallet/balances'+qs, {credentials:'include'});
    if(!r.ok) return null;
    return r.json().catch(()=>null);
  }

  // ---------- Username canonization ----------
  const SRV_USER = {{ (username or '') | tojson }};
  function stripAt(s){ return (s||'').toString().trim().replace(/^@+/, ''); }
  const USER_CANON = (()=>{
    const fromSrv = stripAt(SRV_USER);
    if(fromSrv) return fromSrv;
    try{
      const raw = localStorage.getItem('piAuthUser');
      if(raw){ const j=JSON.parse(raw); if(j && j.username) return stripAt(j.username); }
    }catch{}
    try{
      const uCanon = localStorage.getItem('izzaUserCanon');
      if(uCanon) return stripAt(uCanon);
      const u = localStorage.getItem('izzaUserU');
      if(u) return stripAt(u);
    }catch{}
    return '';
  })();
  try{
    if(USER_CANON){
      localStorage.setItem('izzaUserCanon', USER_CANON);
      localStorage.setItem('izzaUserU', USER_CANON.toLowerCase());
    }
  }catch{}

  // ---------- Wallet modal wiring ----------
  function openMyWallet(){ document.getElementById('myWalletModal').removeAttribute('hidden'); refreshMyWalletModal(); }
  function closeMyWallet(){ document.getElementById('myWalletModal').setAttribute('hidden',''); }
  document.getElementById('openWallet').addEventListener('click', openMyWallet);
  document.getElementById('closeMyWalletBtn').addEventListener('click', closeMyWallet);

  async function refreshMyWalletModal(){
    document.getElementById('mwUser').textContent = USER_CANON ? '@'+USER_CANON : '‚Äî';
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    document.getElementById('mwPub').textContent = pub || '‚Äî';
    const has = pub && isLocalWallet(pub);
    document.getElementById('mwSStatus').innerHTML = has ? '<span class="success">Saved locally</span>' : '<span class="warn">Not saved</span>';

    try{
      const b = await fetchBalances(USER_CANON);
      document.getElementById('balPi').textContent = b && b.pi || '‚Äî';
      document.getElementById('balIzza').textContent = b && b.izza || '‚Äî';
    }catch{
      document.getElementById('balPi').textContent = '‚Äî';
      document.getElementById('balIzza').textContent = '‚Äî';
    }
  }
  document.getElementById('mwSaveBtn').addEventListener('click', async ()=>{
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(!/^G[A-Z0-9]{55}$/.test(pub)){ alert('Open your IZZA wallet once to set an active wallet, then return.'); return; }
    const secret = (document.getElementById('mwSInput').value||'').trim();
    if(!/^S[A-Z0-9]{55}$/.test(secret)){ alert('Enter a valid S-key'); return; }
    const v = __readVault() || {}; v.pub = pub; v.sec = secret; __writeVault(v);
    const res = await linkActiveWallet(USER_CANON, pub, secret);
    if(!res.ok){ alert('Server link failed: ' + (res.json && res.json.error || res.status)); }
    document.getElementById('mwSInput').value = '';
    refreshMyWalletModal();
    alert('S-key saved locally and linked.');
  });
  document.getElementById('mwForgetBtn').addEventListener('click', async ()=>{
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(pub) __forgetSecret(pub);
    refreshMyWalletModal();
  });

  // ---------- Gate for mint / feed ----------
  async function ensureUserAndWalletGate(){
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(!USER_CANON){ alert('Sign in with Pi first.'); return null; }
    if(!pub){ alert('Open your IZZA wallet once to set an active wallet, then return.'); return null; }
    if(!isLocalWallet(pub)){
      openMyWallet();
      alert('Save your S-key locally first.');
      return null;
    }
    return { user:USER_CANON, pub, sec:getLocalSecret(pub) };
  }

  // ---------- Live preview ----------
  let lastCode = null, lastIssuer = null;
  async function refreshLive(){
    if(!lastCode){ liveHint.textContent='Mint an egg to see it here'; return; }
    try{
      const meta = `/nftmeta/${lastCode}.json?nc=${Date.now()}`;
      const j = await fetch(meta).then(r=>r.json());
      liveSvg.src = (j.image || '') + '&pulse=' + Date.now();
      openHabitat.href = j.external_url || '#';
      // Updated hint for real lifecycle
      liveHint.textContent = 'Feed once per day. Miss 3 days = death. Revive by feeding 3 days in a row.';
    }catch(e){}
  }
  setInterval(refreshLive, 3000);

  // Load latest & balances on enter
  (async ()=>{
    try{
      const j = await fetch('/api/creatures/latest', {credentials:'include'}).then(r=>r.json());
      if(j && j.latest && j.latest.code){
        lastCode = j.latest.code;
        lastIssuer = j.latest.issuer;
        await refreshLive();
      }
    }catch(e){}
    try{ await refreshMyWalletModal(); }catch{}
  })();

  // ---------- Mint flow (with auto-claim) ----------
  mintBtn.addEventListener('click', async ()=>{
    mintMsg.textContent = 'Your creature is being fabricated by the hands of IZZA gods';
    const gate = await ensureUserAndWalletGate();
    if(!gate){ return; }

    const finalSkin = previewSkins[Math.floor(Math.random()*previewSkins.length)];
    await spinEggs(finalSkin);

    try{
      const res = await fetch('/api/creatures/mint', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ buyer_pub:gate.pub, buyer_sec:gate.sec, skin: finalSkin })
      }).then(r=>r.json());
      if(!(res && res.ok)) throw new Error(res && res.error || 'mint_failed');

      lastCode = res.asset.code; lastIssuer = res.asset.issuer;

      const ac = await fetch('/api/creatures/auto-claim', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code:lastCode, owner_pub:gate.pub })
      }).then(r=>r.json()).catch(()=>null);

      if(ac && ac.ok && ac.delivered){
        mintMsg.innerHTML = `Egg minted and <span class="success">delivered</span> to your IZZA wallet: <strong>${lastCode}</strong>`;
      }else if(ac && ac.ok){
        mintMsg.innerHTML = `Egg minted: <strong>${lastCode}</strong>. A claim was created ‚Äî open the wallet to accept.`;
      }else{
        mintMsg.innerHTML = `Egg minted: <strong>${lastCode}</strong>. Open your wallet to deliver it.`;
      }

      await refreshLive();
      await refreshMyWalletModal();
    }catch(e){
      console.error(e);
      mintMsg.textContent = 'Mint failed, please try again';
    }
  });

  // ---------- Feed ----------
  document.getElementById('feedBtn').addEventListener('click', async ()=>{
    if(!lastCode){ mintMsg.textContent='Mint or select a creature first'; return; }
    const gate = await ensureUserAndWalletGate(); if(!gate){ return; }
    await fetch('/api/creatures/feed', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code:lastCode, owner_pub:gate.pub })
    });
    refreshLive();
  });

  // ---------- My Creatures ----------
  const myBox  = document.getElementById('myCreaturesBox');
  const myList = document.getElementById('myCreaturesList');
  document.getElementById('btnMyCreatures').addEventListener('click', async ()=>{
    myList.innerHTML = '';
    const qs = USER_CANON ? ('?u='+encodeURIComponent(USER_CANON)) : '';
    const j = await fetch('/api/creatures/mine'+qs, {credentials:'include'}).then(r=>r.json()).catch(()=>({items:[]}));
    (j.items||[]).forEach(it=>{
      const wrap = document.createElement('div');
      wrap.className = 'thumb';
      const img = document.createElement('img');
      img.alt = it.code;
      img.src = `/nftsvg/${it.code}.svg?nc=${Date.now()}`;
      const a = document.createElement('a');
      a.href = `/creature/${it.code}`;
      a.className = 'btn';
      a.textContent = 'OPEN';
      const cap = document.createElement('div');
      cap.className = 'cap';
      cap.textContent = it.code + (it.stage ? ` ‚Äî ${it.stage}` : '');
      wrap.appendChild(img);
      wrap.appendChild(cap);
      wrap.appendChild(a);
      myList.appendChild(wrap);
    });
    myBox.style.display = 'block';
    window.scrollTo({top: myBox.offsetTop - 12, behavior:'smooth'});
  });

})();
</script>

<!-- ========= Global Friends + Notifications overlay (city-style, battles removed) ========= -->
<script>
(function(){
  // Config matches your MP client
  const CFG = {
    base: (window.__MP_BASE__ || '/izza-game/api/mp'),
    ws:   (window.__MP_WS__   || '/izza-game/api/mp/ws'),
    searchDebounceMs: 250,
  };
  const TOK = (window.__IZZA_T__ || '').toString();
  const withTok = (p) => TOK ? p + (p.includes('?') ? '&' : '?') + 't=' + encodeURIComponent(TOK) : p;

  // helpers
  async function jget(p){
    const r = await fetch(withTok(CFG.base+p), {credentials:'include'});
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    return r.json();
  }
  async function jpost(p,b){
    const r = await fetch(withTok(CFG.base+p),{
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(b||{})
    });
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    return r.json();
  }
  const debounced=(fn,ms)=>{ let t=null,a=null; return (...args)=>{a=args; clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}};

  // state
  let me=null, friends=[], ws=null, wsReady=false;
  let ui = { bell:null, badge:null, dd:null, friendsBtn:null, friendsPop:null, friendsBody:null,
             searchInput:null, searchBtn:null, searchStatus:null };
  let notifications = { unread:0, items:[] };

  // presence normalization, same rules
  const ACTIVE_WINDOW_MS = 30_000;
  const ACTIVE_WORLDS    = new Set(['1','2','3','4']);
  function normalizeActive(v,lastSeen,world){
    if (world != null && !ACTIVE_WORLDS.has(String(world))) return false;
    if (v===true || v===1){
      if (typeof lastSeen==='number' && isFinite(lastSeen)){
        return (Date.now()-lastSeen) <= ACTIVE_WINDOW_MS;
      }
      return true;
    }
    if (typeof lastSeen==='number' && isFinite(lastSeen)){
      return (Date.now()-lastSeen) <= ACTIVE_WINDOW_MS;
    }
    return false;
  }

  const isFriend = (name)=> !!friends.find(f=> (f.username||'').toLowerCase() === (name||'').toLowerCase());

  async function loadMe(){ me = await jget('/me').catch(()=>null); return me; }
  async function loadFriends(){
    const res = await jget('/friends/list').catch(()=>({friends:[]}));
    friends = (res.friends||[]).map(f => ({
      ...f,
      active: normalizeActive(f.active ?? f.status ?? f.online, f.lastSeen ?? f.last_seen, f.world ?? f.w)
    }));
    renderFriends();
  }

  async function searchPlayers(q){
    const res = await jget('/players/search?q='+encodeURIComponent(q||'')).catch(()=>({users:[]}));
    return (res.users||[]).map(u => ({
      username:u.username,
      active: normalizeActive(u.active ?? u.status ?? u.online, u.lastSeen ?? u.last_seen, u.world ?? u.w)
    }));
  }

  // ---------- UI (bell + dropdown) ----------
  function ensureBell(){
    if(ui.bell && ui.badge && ui.dd) return;

    const bell = document.createElement('button');
    bell.id = 'mpNotifBell';
    bell.title = 'Notifications';
    bell.textContent = 'üîî';
    Object.assign(bell.style, {
      position:'fixed', right:'14px', top:'56px', zIndex:1011,
      width:'28px', height:'28px', borderRadius:'16px',
      background:'#162134', color:'#cfe0ff',
      border:'1px solid #2a3550', display:'flex', alignItems:'center', justifyContent:'center',
      boxShadow:'0 2px 8px rgba(0,0,0,.25)'
    });
    bell.addEventListener('click', toggleNotifDropdown);
    document.body.appendChild(bell);

    const badge = document.createElement('span');
    badge.id='mpNotifBadge';
    Object.assign(badge.style, {
      position:'fixed', right:'6px', top:'48px', zIndex:1012,
      minWidth:'14px', height:'14px', borderRadius:'7px',
      background:'#e11d48', color:'#fff', fontSize:'10px',
      display:'none', alignItems:'center', justifyContent:'center',
      padding:'0 4px', lineHeight:'14px'
    });
    document.body.appendChild(badge);

    const dd = document.createElement('div');
    dd.id='mpNotifDropdown';
    Object.assign(dd.style, {
      position:'fixed', right:'10px', top:'90px', zIndex:1012,
      background:'#0f1522', color:'#e8eef7',
      border:'1px solid #2a3550', borderRadius:'12px',
      minWidth:'280px', maxWidth:'92vw', maxHeight:'300px', overflow:'auto',
      display:'none', boxShadow:'0 10px 24px rgba(0,0,0,.45)'
    });
    document.body.appendChild(dd);

    ui.bell=bell; ui.badge=badge; ui.dd=dd;
  }
  function setUnread(n){
    notifications.unread = Math.max(0, n|0);
    ensureBell();
    if(notifications.unread>0){
      ui.badge.style.display='flex';
      ui.badge.textContent = String(notifications.unread);
      ui.bell.style.background = '#2b1720';
      ui.bell.style.borderColor = '#7d223a';
      ui.bell.style.color = '#ffd7df';
    }else{
      ui.badge.style.display='none';
      ui.bell.style.background = '#162134';
      ui.bell.style.borderColor = '#2a3550';
      ui.bell.style.color = '#cfe0ff';
    }
  }
  function addNotification(n){
    notifications.items.unshift(n);
    setUnread(notifications.unread+1);
    if(ui.dd && ui.dd.style.display!=='none'){ renderNotifDropdown(); markAllNotificationsRead(); }
  }
  function removeNotification(id){
    notifications.items = notifications.items.filter(x=>x.id!==id);
    renderNotifDropdown();
  }
  function markAllNotificationsRead(){ setUnread(0); }
  function toggleNotifDropdown(){
    ensureBell();
    const vis = (ui.dd.style.display!=='none');
    ui.dd.style.display = vis ? 'none' : 'block';
    if(!vis){ renderNotifDropdown(); markAllNotificationsRead(); }
  }
  function renderNotifDropdown(){
    const host = ui.dd; if(!host) return;
    host.innerHTML = '';
    const header = document.createElement('div');
    header.textContent='Notifications';
    header.style.cssText='padding:10px 12px;font-weight:700;border-bottom:1px solid #24324e';
    host.appendChild(header);

    if(!notifications.items.length){
      const empty=document.createElement('div');
      empty.style.cssText='padding:10px;opacity:.8;';
      empty.textContent='No notifications';
      host.appendChild(empty);
      return;
    }

    notifications.items.forEach(n=>{
      const row = document.createElement('div');
      row.style.cssText='display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid #18233a;';
      const label=document.createElement('div');
      label.style.cssText='font-size:13px;line-height:1.3;';

      if(n.type==='friend'){
        label.textContent = `${n.from} sent you a friend request`;
        const actions=document.createElement('div'); actions.style.cssText='display:flex;gap:6px;';
        const accept=document.createElement('button'); accept.className='mp-small'; accept.textContent='Accept';
        accept.addEventListener('click', async ()=>{
          try{
            await jpost('/friends/accept', { requestId:n.id, from:n.from, username:n.from });
            await loadFriends();
            removeNotification(n.id);
          }catch(e){}
        });
        const decline=document.createElement('button'); decline.className='mp-small ghost'; decline.textContent='Decline';
        decline.addEventListener('click', async ()=>{
          try{ await jpost('/friends/decline', { requestId:n.id, from:n.from, username:n.from }); }catch(e){}
          removeNotification(n.id);
        });
        actions.appendChild(accept); actions.appendChild(decline);
        row.appendChild(label); row.appendChild(actions);
      }else if(n.type==='battle'){
        label.textContent = `${n.from} invited you${n.mode?(' ('+n.mode+')'):''}`;
        const actions=document.createElement('div'); actions.style.cssText='display:flex;gap:6px;';
        const accept=document.createElement('button'); accept.className='mp-small'; accept.textContent='Accept';
        accept.addEventListener('click', async ()=>{
          try{ await jpost('/lobby/accept', { inviteId:n.id, from:n.from }); }catch(e){}
          removeNotification(n.id);
        });
        const decline=document.createElement('button'); decline.className='mp-small ghost'; decline.textContent='Decline';
        decline.addEventListener('click', async ()=>{
          try{ await jpost('/lobby/decline', { inviteId:n.id, from:n.from }); }catch(e){}
          removeNotification(n.id);
        });
        actions.appendChild(accept); actions.appendChild(decline);
        row.appendChild(label); row.appendChild(actions);
      }else if(n.type==='creature'){
        // future creature battle invites
        label.textContent = `${n.from} challenged you to a Creature battle`;
        const actions=document.createElement('div'); actions.style.cssText='display:flex;gap:6px;';
        const accept=document.createElement('button'); accept.className='mp-small'; accept.textContent='Accept';
        accept.addEventListener('click', async ()=>{
          // wire this when the creatures battle endpoint is ready
          // await jpost('/creatures/battle/accept', { inviteId:n.id, from:n.from });
          removeNotification(n.id);
        });
        const decline=document.createElement('button'); decline.className='mp-small ghost'; decline.textContent='Decline';
        decline.addEventListener('click', async ()=>{
          // await jpost('/creatures/battle/decline', { inviteId:n.id, from:n.from });
          removeNotification(n.id);
        });
        actions.appendChild(accept); actions.appendChild(decline);
        row.appendChild(label); row.appendChild(actions);
      }else{
        label.textContent='Notification';
        row.appendChild(label);
      }

      host.appendChild(row);
    });
  }

  // ---------- Friends button + popup (with Search All Players) ----------
  function ensureFriendsBtn(){
    if(ui.friendsBtn) return;
    const btn = document.createElement('button');
    btn.id='mpFriendsToggleGlobal';
    btn.title='Friends';
    btn.textContent='Friends';
    Object.assign(btn.style, {
      position:'fixed', right:'14px', top:'96px', zIndex:1011,
      height:'34px', padding:'0 12px', borderRadius:'18px',
      background:'#162134', color:'#cfe0ff',
      border:'1px solid #2a3550', display:'flex', alignItems:'center', justifyContent:'center',
      boxShadow:'0 2px 8px rgba(0,0,0,.25)'
    });
    btn.addEventListener('click', toggleFriendsPopup);
    document.body.appendChild(btn);
    ui.friendsBtn = btn;
  }

  function ensureFriendsPopup(){
    if(ui.friendsPop) return;
    const pop = document.createElement('div');
    pop.id='mpFriendsPopup';
    Object.assign(pop.style, {
      position:'fixed', right:'14px', top:'140px', zIndex:1012,
      background:'#0f1522', border:'1px solid #2a3550', borderRadius:'12px',
      width:'340px', maxWidth:'92vw', maxHeight:'60vh', overflow:'auto', display:'none',
      boxShadow:'0 10px 28px rgba(0,0,0,.35)', padding:'10px'
    });

    // header
    const head=document.createElement('div');
    head.style.cssText='display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;';
    const ttl=document.createElement('div'); ttl.textContent='Friends'; ttl.style.cssText='font-weight:800';
    const x=document.createElement('button'); x.className='mp-small ghost'; x.textContent='Close'; x.addEventListener('click', ()=> pop.style.display='none');
    head.appendChild(ttl); head.appendChild(x); pop.appendChild(head);

    // search bar
    const sb=document.createElement('div'); sb.className='searchbar';
    const input=document.createElement('input'); input.placeholder='Search All Players';
    const sbtn=document.createElement('button'); sbtn.className='mp-small'; sbtn.textContent='Search';
    const status=document.createElement('div'); status.style.cssText='font-size:12px;color:#9fb0d6;margin:6px 2px;';
    sb.appendChild(input); sb.appendChild(sbtn); pop.appendChild(sb); pop.appendChild(status);

    // results / friends list body
    const body = document.createElement('div'); body.id='mpFriendsListBody'; body.style.cssText='display:flex;flex-direction:column;gap:6px;';
    pop.appendChild(body);

    document.body.appendChild(pop);
    ui.friendsPop=pop; ui.friendsBody=body; ui.searchInput=input; ui.searchBtn=sbtn; ui.searchStatus=status;

    const runSearch = async (immediate=false)=>{
      const q = (ui.searchInput.value||'').trim();
      if(!q){ ui.searchStatus.textContent=''; renderFriends(); return; }
      if(!immediate && q.length<2){ ui.searchStatus.textContent='Type at least 2 characters'; return; }
      ui.searchStatus.textContent='Searching‚Ä¶';
      try{
        const list = await searchPlayers(q);
        paintList(list);
        ui.searchStatus.textContent = list.length ? `Found ${list.length} result${list.length===1?'':'s'}` : 'No players found';
      }catch(e){ ui.searchStatus.textContent='Search failed'; }
    };
    const deb = debounced(()=>runSearch(false), CFG.searchDebounceMs);
    input.addEventListener('input', deb);
    input.addEventListener('keydown', (e)=>{ if((e.key||'').toLowerCase()==='enter'){ e.preventDefault(); runSearch(true);} });
    sbtn.addEventListener('click', ()=> runSearch(true));
  }

  function toggleFriendsPopup(){
    ensureFriendsPopup();
    const vis = (ui.friendsPop.style.display!=='none');
    ui.friendsPop.style.display = vis ? 'none' : 'block';
    if(!vis){ renderFriends(); }
  }

  function makeRow(u){
    const row=document.createElement('div'); row.className='friend';
    const alreadyFriend = isFriend(u.username);
    const activeLabel   = u.active ? 'Active' : 'Offline';
    row.innerHTML = `
      <div>
        <div>${u.username}</div>
        <div class="meta ${u.active?'active':'offline'}">${activeLabel}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        ${alreadyFriend ? '' : `<button class="mp-small ghost" data-add="${u.username}">Add Friend</button>`}
        <button class="mp-small" data-invite="${u.username}">Invite</button>
      </div>
    `;
    row.querySelector('[data-add]')?.addEventListener('click', async ()=>{
      try{
        await jpost('/friends/request',{ toUsername:u.username, username:u.username });
        const b=row.querySelector('[data-add]'); if(b){ b.disabled=true; b.textContent='Requested'; }
      }catch(e){}
    });
    row.querySelector('[data-invite]')?.addEventListener('click', async ()=>{
      try{
        // General invite (city). For creatures, we‚Äôll add a dedicated endpoint later.
        await jpost('/lobby/invite',{ toUsername:u.username, mode:'creature' });
      }catch(e){}
    });
    return row;
  }

  function paintList(list){
    if(!ui.friendsBody) return;
    ui.friendsBody.innerHTML='';
    (list||[]).forEach(u=> ui.friendsBody.appendChild(makeRow(u)));
    if(!list || !list.length){
      const none=document.createElement('div'); none.className='friend';
      none.innerHTML=`<div><div>No results</div><div class="meta">Try another name</div></div>`;
      ui.friendsBody.appendChild(none);
    }
  }

  function renderFriends(){
    if(!ui.friendsBody) return;
    ui.searchStatus && (ui.searchStatus.textContent='');
    paintList(friends);
  }

  // ---------- WS + notifications poll ----------
  function connectWS(){
    try{
      const proto = location.protocol==='https:'?'wss:':'ws:'; const url = proto+'//'+location.host+CFG.ws;
      ws=new WebSocket(url);
    }catch(e){ return; }
    ws.addEventListener('open', ()=>{ wsReady=true; });
    ws.addEventListener('close', ()=>{ wsReady=false; ws=null; setTimeout(connectWS,1500); });
    ws.addEventListener('message',(evt)=>{
      let msg=null; try{ msg=JSON.parse(evt.data);}catch{}
      if(!msg) return;

      if (msg.type === 'presence'){
        const f = friends.find(x=>x.username=== (msg.user || msg.username));
        if (f){
          f.active = normalizeActive(msg.active ?? msg.status ?? msg.online, msg.lastSeen ?? msg.last_seen, msg.world ?? msg.w);
          if(ui.friendsPop && ui.friendsPop.style.display!=='none') renderFriends();
        }
      } else if (msg.type === 'friend.request'){
        addNotification({ id: msg.id || ('fr_'+Date.now()), type:'friend', from: msg.from });
      } else if (msg.type === 'invite'){
        addNotification({ id: msg.id || ('inv_'+Date.now()), type:'battle', from: msg.from, mode: msg.mode });
      } else if (msg.type === 'creature.invite'){
        // future: creatures battle invites
        addNotification({ id: msg.id || ('cinv_'+Date.now()), type:'creature', from: msg.from });
      }
    });
  }

  async function pullNotifications(){
    try{
      const n = await jget('/notifications');

      // friend requests
      const reqs = (n && (n.friendRequests || n.requests)) || [];
      if(Array.isArray(reqs)){
        reqs.forEach(fr=>{
          const id = fr.id || fr.requestId || ('fr_'+(fr.from||'')+'_'+Date.now());
          if(!notifications.items.find(x=>x.id===id)){
            addNotification({ id, type:'friend', from: fr.from || fr.username || 'player' });
          }
        });
      }
      // generic invites
      if(n && Array.isArray(n.invites)){
        n.invites.forEach(inv=>{
          const id = inv.id || ('inv_'+(inv.from||'')+'_'+Date.now());
          if(!notifications.items.find(x=>x.id===id)){
            addNotification({ id, type:(inv.mode==='creature'?'creature':'battle'), from:inv.from, mode:inv.mode });
          }
        });
      }
    }catch{}
  }

  // ---------- boot ----------
  async function start(){
    ensureBell(); ensureFriendsBtn(); ensureFriendsPopup();
    try{ await loadMe(); }catch{}
    try{ await loadFriends(); }catch{}
    connectWS();
    pullNotifications();
    setInterval(pullNotifications, 5000);
  }

  if(document.readyState==='complete' || document.readyState==='interactive') start();
  else addEventListener('DOMContentLoaded', start, {once:true});
})();
</script>
</body>
</html>
