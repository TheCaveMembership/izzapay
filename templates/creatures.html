<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IZZA CREATURES, Mint, Hatch, Battle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --bg:#000; --txt:#e8f1ff; --muted:#9fb0d6; --line:#1d2540;
      --piPurple1:#7a44ff; --piPurple2:#b784ff; --gold1:#ffcf4d; --gold2:#ffb23a;
      --panel:#0b0f1f; --card:#0e1422;
    }
    html,body{background:#000;color:var(--txt);font-family:Inter,Arial,sans-serif;margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    .topbar{display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--line);
            position:sticky;top:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);z-index:10}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 18px;border-radius:14px;font-weight:700;letter-spacing:.2px;
         border:1px solid #2a3550;color:#cfe0ff;background:var(--panel);cursor:pointer;text-decoration:none}
    .btn.purple{background:linear-gradient(180deg,var(--piPurple1),var(--piPurple2));color:#fff;border-color:transparent}
    .btn.gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1400;border-color:transparent}
    h1{font-size:clamp(26px,8.5vw,56px);margin:16px 0 6px;text-align:center}
    p{color:var(--muted);text-align:center}
    .row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0 18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}

    .box{border:1px solid #2a3550;border-radius:16px;background:var(--panel);padding:14px}
    .col{flex:1 1 320px;max-width:520px}
    .box h3{margin:4px 0 10px}

    .slot{position:relative;overflow:hidden;border-radius:16px;border:1px solid #2a3550;background:var(--card);height:140px}
    .slot::before,
    .slot::after{
      content:"";position:absolute;inset:0;pointer-events:none;
      background:linear-gradient(90deg, rgba(0,0,0,.7), transparent 18%, transparent 82%, rgba(0,0,0,.7));z-index:2
    }
    .slot .track{display:flex;gap:12px;transition:transform 1.2s cubic-bezier(.18,.9,.22,1);padding:12px}
    .slot .egg{width:140px;height:140px;display:flex;align-items:center;justify-content:center;background:#0e1422;border-radius:14px;border:1px solid #223056;box-shadow:0 2px 8px rgba(0,0,0,.25)}
    .egg img{width:75%;height:75%;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.35))}
    .hint{font-size:12px;color:#9fb0d6;margin-top:6px;text-align:center}

    #liveSvg{width:100%;aspect-ratio:16/12;object-fit:contain;border-radius:12px;border:1px solid #223056;background:#0e1422}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
    .modal[hidden]{display:none}
    .modal-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:720px;width:94%;padding:14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal-title{display:flex;align-items:center;gap:8px;font-weight:800}
    .close-btn{border:1px solid var(--line);border-radius:10px;background:#0b0f1f;padding:8px 10px;color:#fff;cursor:pointer}
    .small-muted{font-size:12px;color:var(--muted")}
    .blox{display:flex;flex-direction:column;gap:6px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .success{color:#5ad49e}
    .warn{color:#ffb86b}

    /* list grid */
    #listGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px}
    .cell{border:1px solid #223056;border-radius:12px;background:#0e1422;padding:8px;text-align:center}
    .cell img{width:100%;aspect-ratio:1;object-fit:contain}
    .cell small{display:block;color:#9fb0d6;margin-top:4px}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="/">BACK HOME</a>
      <button class="btn purple upper" id="openWallet">IZZA WALLET</button>
      <button class="btn gold upper" id="openList">MY CREATURES</button>
    </div>

    <h1>IZZA CREATURES</h1>
    <p>Pay 5 IZZA to mint an IZZA CREATURE EGG, watch it hatch live as the SVG evolves, then grow and battle.</p>

    <div class="grid">
      <div class="col box">
        <h3>Mint Egg</h3>
        <div class="slot"><div class="track" id="track"></div></div>
        <div class="row"><button class="btn purple" id="mintBtn">MINT EGG, 5 IZZA</button></div>
        <div class="hint">The carousel spins like a slot, and stops on your egg</div>
        <div id="mintMsg" class="hint"></div>
      </div>

      <div class="col box">
        <h3>My Latest Creature</h3>
        <img id="liveSvg" alt="creature">
        <div class="row">
          <button class="btn" id="feedBtn">FEED</button>
          <a class="btn" id="openHabitat" target="_blank" rel="noopener">OPEN HABITAT</a>
        </div>
        <div id="liveHint" class="hint">Mint an egg to see it here</div>
      </div>
    </div>
  </div>

  <!-- Wallet modal -->
  <div class="modal" id="myWalletModal" role="dialog" aria-modal="true" aria-labelledby="myWalletTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="" style="width:22px;height:22px">
          <span id="myWalletTitle">My IZZA Wallet</span>
        </div>
        <button class="close-btn" type="button" id="closeMyWalletBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="blox">
          <div class="small-muted">Signed in as</div>
          <div><strong id="mwUser">—</strong></div>
        </div>
        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Active Wallet, public key</div>
          <div class="mono" id="mwPub">—</div>
          <div class="small-muted">Save your S key locally on this device to mint and auto claim.</div>
        </div>
        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Local S key status</div>
          <div id="mwSStatus">—</div>
        </div>
        <div class="row" style="margin-top:6px;justify-content:flex-end">
          <a class="btn gold" href="/token/auth?next=/token/izza">Open Full Wallet</a>
        </div>
      </div>
    </div>
  </div>

  <!-- My creatures list modal -->
  <div class="modal" id="listModal" role="dialog" aria-modal="true" aria-labelledby="listTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="" style="width:22px;height:22px">
          <span id="listTitle">My IZZA Creatures</span>
        </div>
        <button class="close-btn" type="button" id="closeListBtn">Close</button>
      </div>
      <div class="modal-body">
        <div id="listGrid"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- Pi init ----------
  const sandbox = {{ 'true' if PI_SANDBOX else 'false' }};
  try{ if(window.Pi && Pi.init){ Pi.init({version:'2.0', sandbox:sandbox}); } }catch(e){}

  // ---------- DOM ----------
  const track = document.getElementById('track');
  const mintBtn = document.getElementById('mintBtn');
  const mintMsg = document.getElementById('mintMsg');
  const liveSvg = document.getElementById('liveSvg');
  const liveHint = document.getElementById('liveHint');
  const openHabitat = document.getElementById('openHabitat');

  // ---------- Carousel previews, now backed by a real route ----------
  const previews = Array.from({length:18}).map((_,i)=>`/nftsvg/EGGDEMO.svg?skin=${i}`);
  function cell(imgSrc){
    const d=document.createElement('div'); d.className='egg';
    const img=new Image(); img.loading='lazy'; img.decoding='async'; img.src = imgSrc;
    d.appendChild(img); return d;
  }
  function fillTrack(){
    track.innerHTML='';
    const pad = 4;
    for(let p=0;p<pad;p++) track.appendChild(cell(previews[p % previews.length]));
    previews.forEach(src=> track.appendChild(cell(src)));
    for(let p=0;p<pad;p++) track.appendChild(cell(previews[(p+5) % previews.length]));
  }
  fillTrack();
  function slotCellWidth(){
    const first = track.querySelector('.egg');
    if(!first) return 152;
    const r = first.getBoundingClientRect();
    return r.width + 12;
  }
  // simple ease, start slow, speed up, final brake
  async function spinAndStop(){
    const n = track.children.length;
    const w = slotCellWidth();
    const minIdx = 4, maxIdx = n - 5;
    const idx = Math.floor(minIdx + Math.random()*(maxIdx - minIdx));
    // warm up
    track.style.transition = 'transform .9s cubic-bezier(.45,.05,.55,.95)';
    track.style.transform = `translateX(-${(idx-2)*w}px)`;
    await new Promise(r=>setTimeout(r, 900));
    // speed
    track.style.transition = 'transform .5s linear';
    track.style.transform = `translateX(-${(idx+3)*w}px)`;
    await new Promise(r=>setTimeout(r, 500));
    // brake to final
    track.style.transition = 'transform 1.2s cubic-bezier(.18,.9,.22,1)';
    track.style.transform = `translateX(-${idx*w}px)`;
    return new Promise(res=>setTimeout(()=>res(idx), 1200));
  }

  // ---------- local vault ----------
  function __readVault(){ try{ const s=localStorage.getItem('izza_test_wallet'); return s?JSON.parse(s):null; }catch{return null} }
  function getLocalSecret(pub){ try{ const v=__readVault(); if(!v) return ''; if(pub && v.pub!==pub) return ''; return v.sec||''; }catch{return ''} }
  function isLocalWallet(pub){ const v=__readVault(); return !!(v && v.pub===pub && /^S[A-Z0-9]{55}$/.test(v.sec||'')); }

  async function fetchActiveWallet(username){
    const qs = username ? ('?u='+encodeURIComponent(username)) : '';
    const r = await fetch('/api/wallet/active'+qs, {credentials:'include'});
    if(!r.ok) return null;
    return r.json().catch(()=>null);
  }

  // ---------- username ----------
  const SRV_USER = {{ (username or '') | tojson }};
  function stripAt(s){ return (s||'').toString().trim().replace(/^@+/, ''); }
  const USER_CANON = (()=>{ const s = stripAt(SRV_USER); return s || ''; })();

  // ---------- wallet modal ----------
  function openMyWallet(){ document.getElementById('myWalletModal').removeAttribute('hidden'); refreshMyWalletModal(); }
  function closeMyWallet(){ document.getElementById('myWalletModal').setAttribute('hidden',''); }
  document.getElementById('openWallet').addEventListener('click', openMyWallet);
  document.getElementById('closeMyWalletBtn').addEventListener('click', closeMyWallet);

  async function refreshMyWalletModal(){
    document.getElementById('mwUser').textContent = USER_CANON ? '@'+USER_CANON : '—';
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    document.getElementById('mwPub').textContent = pub || '—';
    const has = pub && isLocalWallet(pub);
    document.getElementById('mwSStatus').innerHTML = has ? '<span class="success">Saved locally</span>' : '<span class="warn">Not saved</span>';
  }

  // ---------- list modal ----------
  function openList(){ document.getElementById('listModal').removeAttribute('hidden'); refreshList(); }
  function closeList(){ document.getElementById('listModal').setAttribute('hidden',''); }
  document.getElementById('openList').addEventListener('click', openList);
  document.getElementById('closeListBtn').addEventListener('click', closeList);

  async function refreshList(){
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    const grid = document.getElementById('listGrid');
    grid.innerHTML = '';
    if(!pub){ grid.textContent = 'Open wallet first.'; return; }
    const j = await fetch('/api/creatures/list?pub='+encodeURIComponent(pub)).then(r=>r.json()).catch(()=>null);
    if(!(j && j.ok)){ grid.textContent = 'No data.'; return; }
    if(!j.items.length){ grid.textContent = 'You do not own any creatures yet.'; return; }
    for(const it of j.items){
      const url = `/nftmeta/${it.code}.json`;
      try{
        const meta = await fetch(url).then(r=>r.json());
        const cell = document.createElement('div'); cell.className='cell';
        const img = new Image(); img.src = (meta.image || '') + '&pulse=' + Date.now();
        const a = document.createElement('a'); a.href = meta.external_url || '#'; a.target='_blank'; a.rel='noopener';
        a.appendChild(img); cell.appendChild(a);
        const sm = document.createElement('small'); sm.textContent = it.code;
        cell.appendChild(sm);
        grid.appendChild(cell);
      }catch{}
    }
  }

  // ---------- load latest on entry ----------
  let lastCode = null, lastIssuer = null;
  async function loadLatest(){
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(!pub){ liveHint.textContent='Open your wallet once, then save S key locally.'; return; }
    try{
      const j = await fetch('/api/creatures/latest?pub='+encodeURIComponent(pub)).then(r=>r.json());
      if(j && j.ok && j.asset){
        lastCode = j.asset.code; lastIssuer = j.asset.issuer;
        const meta = await fetch(`/nftmeta/${lastCode}.json?nc=${Date.now()}`).then(r=>r.json());
        liveSvg.src = (meta.image || '') + '&pulse=' + Date.now();
        openHabitat.href = meta.external_url || '#';
        liveHint.textContent = 'SVG refreshes automatically';
      }else{
        liveHint.textContent = 'Mint an egg to see it here';
      }
    }catch{ liveHint.textContent = 'Mint an egg to see it here'; }
  }

  // ---------- live refresher ----------
  function refreshLiveTick(){
    if(!lastCode) return;
    liveSvg.src = `/nftmeta/${lastCode}.json?nc=${Date.now()}`;  // this triggers fetch in onload below
  }
  setInterval(async ()=>{
    if(!lastCode) return;
    try{
      const meta = await fetch(`/nftmeta/${lastCode}.json?nc=${Date.now()}`).then(r=>r.json());
      liveSvg.src = (meta.image || '') + '&pulse=' + Date.now();
    }catch{}
  }, 3000);

  // ---------- mint flow with auto claim ----------
  async function ensureGate(){
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(!USER_CANON){ alert('Sign in with Pi first'); return null; }
    if(!pub){ alert('Open your IZZA wallet once to set active wallet, then return'); return null; }
    if(!isLocalWallet(pub)){ openMyWallet(); alert('Save your S key locally first'); return null; }
    return { pub, sec: getLocalSecret(pub) };
  }

  mintBtn.addEventListener('click', async ()=>{
    mintMsg.textContent = '';
    const gate = await ensureGate(); if(!gate) return;
    await spinAndStop();
    try{
      const q = await fetch('/api/creatures/quote', {method:'POST'}).then(r=>r.json());
      if(!(q && q.ok)) throw new Error('quote_failed');
      const res = await fetch('/api/creatures/mint', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ buyer_pub:gate.pub, buyer_sec:gate.sec })
      }).then(r=>r.json());
      if(!(res && res.ok)) throw new Error(res && res.error || 'mint_failed');

      // auto claim into wallet
      const ac = await fetch('/api/creatures/auto-claim', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code:res.asset.code, owner_pub:gate.pub, owner_sec:gate.sec })
      }).then(r=>r.json());

      lastCode = res.asset.code; lastIssuer = res.asset.issuer;

      // update UI
      const meta = await fetch(`/nftmeta/${lastCode}.json?nc=${Date.now()}`).then(r=>r.json());
      liveSvg.src = (meta.image || '') + '&pulse=' + Date.now();
      openHabitat.href = meta.external_url || '#';
      liveHint.textContent = 'Delivered to your IZZA wallet, visible in your NFTs';
      mintMsg.textContent = `Egg minted and delivered to your IZZA wallet: ${lastCode}`;
      refreshList();
    }catch(e){
      console.error(e);
      mintMsg.textContent = 'Mint failed, please try again';
    }
  });

  // ---------- feed ----------
  document.getElementById('feedBtn').addEventListener('click', async ()=>{
    if(!lastCode){ mintMsg.textContent='Mint or select a creature first'; return; }
    const gate = await ensureGate(); if(!gate) return;
    await fetch('/api/creatures/feed', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code:lastCode, owner_pub:gate.pub })
    });
  });

  // ---------- entry ----------
  document.getElementById('openHabitat').href = '#';
  document.getElementById('openWallet').addEventListener('click', refreshMyWalletModal);

  (async ()=>{ try{ await refreshMyWalletModal(); await loadLatest(); }catch{} })();
})();
</script>
</body>
</html>
