<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IZZA CREATURES, Mint, Hatch, Battle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
  {% raw %}
    :root{
      --bg:#000; --txt:#e8f1ff; --muted:#9fb0d6; --line:#1d2540;
      --piPurple1:#7a44ff; --piPurple2:#b784ff; --gold1:#ffcf4d; --gold2:#ffb23a;
      --panel:#0b0f1f; --card:#0e1422;
    }
    html,body{background:#000;color:var(--txt);font-family:Inter,Arial,sans-serif;margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    .topbar{display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--line);
            position:sticky;top:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);z-index:50}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 18px;border-radius:14px;font-weight:700;letter-spacing:.2px;
         border:1px solid #2a3550;color:#cfe0ff;background:var(--panel);cursor:pointer;text-decoration:none}
    .btn.purple{background:linear-gradient(180deg,var(--piPurple1),var(--piPurple2));color:#fff;border-color:transparent}
    .btn.gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1400;border-color:transparent}
    .btn.red{background:#1b0f12;border-color:#5b2430;color:#ffb6c1}
    h1{font-size:clamp(26px,8.5vw,56px);margin:16px 0 6px;text-align:center}
    p{color:var(--muted);text-align:center}
    .row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0 18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}

    .box{border:1px solid #2a3550;border-radius:16px;background:var(--panel);padding:14px}
    .col{flex:1 1 320px;max-width:520px}
    .box h3{margin:4px 0 10px}

    .slot{position:relative;overflow:hidden;border-radius:16px;border:1px solid #2a3550;background:var(--card);
          height:clamp(110px,22vw,160px);display:flex;align-items:center;justify-content:center}
    #eggPreview{display:block;width:120px;height:120px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .hint{font-size:12px;color:#9fb0d6;margin-top:6px;text-align:center}

    #liveSvg{ width:220px; height:220px; object-fit:contain;border-radius:12px;border:1px solid #223056;background:#0e1422 }

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal[hidden]{display:none}
    .modal-card{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:560px;width:94%;padding:14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal-title{display:flex;align-items:center;gap:8px;font-weight:800}
    .close-btn{border:1px solid var(--line);border-radius:10px;background:#0b0f1f;padding:8px 10px;color:#fff;cursor:pointer}
    .small-muted{font-size:12px;color:#9fb0d6}
    .blox{display:flex;flex-direction:column;gap:6px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .success{color:#5ad49e}
    .warn{color:#ffb86b}

    .thumb{display:flex;flex-direction:column;align-items:center;gap:6px;margin:0;padding:10px;border:1px solid #223056;border-radius:12px;background:#0e1422;width:100%}
    .thumb img{width:88px;height:88px;object-fit:contain}
    .thumb .cap{font-size:12px;color:#9fb0d6}

    .mp-small{font:600 12px/1 Inter,Arial,sans-serif;padding:6px 8px;border-radius:10px;border:1px solid #2a3550;background:#162134;color:#cfe0ff;cursor:pointer}
    .mp-small.ghost{background:#0f1522}
    .mp-small.outline{background:#0f1522;border:1px solid #3a4a78}
    .friend{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid #223056;border-radius:10px;background:#0e1422}
    .friend .meta{font-size:12px;opacity:.85}
    .friend .meta.active{color:#86f2c3}
    .friend .meta.offline{color:#9fb0d6}
    .searchbar{display:flex;gap:8px}
    .searchbar input{flex:1;min-width:140px;padding:8px 10px;border-radius:10px;border:1px solid #2a3550;background:#0f1522;color:#e8f1ff}

    .green-note{color:#86f2c3;font-weight:600;margin-top:6px;text-align:center}
    .loading{display:inline-flex;align-items:center;gap:8px}
    .spin{width:14px;height:14px;border:2px solid #86f2c3;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .stats{border:1px solid #2a3550;border-radius:14px;background:#0e1422;padding:12px;margin-top:12px}
    .stats h4{margin:0 0 8px}
    .stats-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    .stat-pill{border:1px solid #3a4a78;border-radius:12px;padding:8px;text-align:center;background:#0f1522}
/* ---------- COLLECTION: compact 4×4 grid ---------- */
#colStatsBox .stats-grid{
  grid-template-columns: repeat(4, minmax(0, 1fr));
  justify-items: center;           /* center each pill in its cell */
}
#colStatsBox .stat-pill{ padding:10px }
#colStatsBox .stat-pill strong{ font-size:14px }
#colStatsBox .small-muted{ font-size:12px }

/* narrow phones fallback to 2 columns so it doesn't squish */
@media (max-width:420px){
  #colStatsBox .stats-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
}

/* ---------- MY LATEST CREATURE: center everything ---------- */
#liveWrap{
  display:flex;
  align-items:center;
  justify-content:center;
}
#liveWrap img{ margin:0 auto; }

/* ---------- ARMY STATS: centered 3-up grid ---------- */
#armyBox .stats-grid{
  grid-template-columns: repeat(3, minmax(0, 1fr));
  justify-items: center;           /* centers the three pills */
}
#armyBox .stat-pill{
  min-width:120px;                 /* keeps a nice compact width */
  width:100%;
  max-width:200px;
}
    /* Responsive 2-up+ grid for My Creatures */
    #myCreaturesList{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;align-items:start}
    @media (min-width:680px){#myCreaturesList{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (min-width:980px){#myCreaturesList{grid-template-columns:repeat(4,minmax(0,1fr))}}
  {% endraw %}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="/">BACK HOME</a>
      <button class="btn purple upper" id="openWallet">IZZA WALLET</button>
      <button class="btn" id="btnMyCreatures">MY CREATURES</button>
    </div>

    <h1>IZZA CREATURES</h1>
    <p>Pay 5 IZZA to mint an IZZA CREATURE EGG, watch it hatch live, then grow and battle.</p>

    <div class="grid">
      <div class="col box">
        <h3>Mint Egg</h3>
        <div class="slot"><img id="eggPreview" alt="egg"></div>
        <div class="row"><button class="btn purple" id="mintBtn">MINT EGG, 5 IZZA</button></div>
        <div class="green-note">* Clicking the above button you agree to spend 5 IZZA</div>

        <div class="hint">Shuffle through some eggs, ultimately the IZZA gods will ❕DECIDE YOUR FATE❕</div>
        <div id="mintMsg" class="hint" aria-live="polite"></div>

        <!-- Compact Collection stats -->
        <div class="stats" id="colStatsBox" aria-live="polite">
          <h4>IZZA CREATURES V1 — Collection</h4>
          <div class="stats-grid">
            <div class="stat-pill"><strong>Supply</strong><br><span id="supplyVal" class="small-muted">—</span></div>
            <div class="stat-pill"><strong>Hatched</strong><br><span id="hatchedCount" class="small-muted">—</span></div>
            <div class="stat-pill"><strong>Burnt</strong><br><span id="burntCount" class="small-muted">—</span></div>
          </div>
          <div class="stats-grid" style="margin-top:8px">
            <div class="stat-pill"><strong>Legendary</strong><br><span id="legCount" class="small-muted">—</span></div>
            <div class="stat-pill"><strong>Epic</strong><br><span id="epCount" class="small-muted">—</span></div>
            <div class="stat-pill"><strong>Rare</strong><br><span id="rareCount" class="small-muted">—</span></div>
            <div class="stat-pill"><strong>Uncommon</strong><br><span id="unCount" class="small-muted">—</span></div>
            <div class="stat-pill"><strong>Common</strong><br><span id="comCount" class="small-muted">—</span></div>
          </div>
          <div class="hint" style="margin-top:8px">Total supply capped at 1,000 for IZZA CREATURES V1.</div>
        </div>
      </div>

      <div class="col box">
        <h3>My Latest Creature</h3>
        <div id="liveWrap"><img id="liveSvg" alt="creature"></div>
        <div class="row">
          <button class="btn" id="feedBtn">FEED</button>
          <a class="btn" id="openHabitat" target="_blank" rel="noopener">OPEN HABITAT</a>
        </div>
        <div id="liveHint" class="hint"></div>
      </div>
    </div>

    <div class="box" id="armyBox" style="display:none;margin-top:14px">
      <h3>Your IZZA Creature Army Strength</h3>
      <div class="stats-grid">
        <div class="stat-pill"><strong>Total Attack</strong><br><span id="armyAtk" class="small-muted">—</span></div>
        <div class="stat-pill"><strong>Total Defense</strong><br><span id="armyDef" class="small-muted">—</span></div>
        <div class="stat-pill"><strong>Creatures Count</strong><br><span id="armyCnt" class="small-muted">—</span></div>
      </div>
    </div>

    <div class="box" id="myCreaturesBox" style="display:none;margin-top:14px">
      <h3>My Creatures</h3>
      <div id="myCreaturesList"></div>
    </div>
  </div>

  <!-- Wallet modal -->
  <div class="modal" id="myWalletModal" role="dialog" aria-modal="true" aria-labelledby="myWalletTitle" hidden>
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img src="/static/izzapay-mark.svg" alt="" style="width:22px;height:22px">
          <span id="myWalletTitle">My IZZA Wallet</span>
        </div>
        <button class="close-btn" type="button" id="closeMyWalletBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="blox">
          <div class="small-muted">Signed in as</div>
          <div><strong id="mwUser">—</strong></div>
        </div>
        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Active Wallet, public key</div>
          <div class="mono" id="mwPub">—</div>
          <div class="small-muted">Need to set or switch your active wallet? Open or create the full wallet once below. After creation go into your full wallet, reveal your S key once and store it somewhere safe. Then return here to save your S key locally.</div>
        </div>

        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Balances, Testnet</div>
          <div>Test Pi: <strong id="balPi">—</strong></div>
          <div>Test IZZA: <strong id="balIzza">—</strong></div>
        </div>

        <div class="blox" style="margin-top:10px">
          <div class="small-muted">Local S key status</div>
          <div id="mwSStatus">—</div>
          <div class="row" style="margin-top:6px">
            <input class="btn" style="flex:1;min-width:240px;text-align:left" id="mwSInput" placeholder="S... private key" autocomplete="off" spellcheck="false" autocapitalize="none">
            <button class="btn purple" type="button" id="mwSaveBtn">Save S key</button>
            <button class="btn" type="button" id="mwForgetBtn">Forget</button>
          </div>
          <div class="small-muted">Your S key is stored locally on this device only.</div>
        </div>

        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <a class="btn gold" href="/token/auth?next=/token/izza">Open Full Wallet</a>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const sandbox = {{ 'true' if PI_SANDBOX else 'false' }};
  try{ if(window.Pi && Pi.init){ Pi.init({version:'2.0', sandbox:sandbox}); } }catch(e){}

  const mintBtn = document.getElementById('mintBtn');
  const mintMsg = document.getElementById('mintMsg');
  const liveSvg = document.getElementById('liveSvg');
  const liveHint = document.getElementById('liveHint');
  const openHabitat = document.getElementById('openHabitat');
  const eggPreview = document.getElementById('eggPreview');

  // stats elements
  const supplyVal   = document.getElementById('supplyVal');
  const hatchedCount= document.getElementById('hatchedCount');
  const burntCount  = document.getElementById('burntCount');
  const legCount    = document.getElementById('legCount');
  const epCount     = document.getElementById('epCount');
  const rareCount   = document.getElementById('rareCount');
  const unCount     = document.getElementById('unCount');
  const comCount    = document.getElementById('comCount');

  const armyBox = document.getElementById('armyBox');
  const armyAtk = document.getElementById('armyAtk');
  const armyDef = document.getElementById('armyDef');
  const armyCnt = document.getElementById('armyCnt');

  function buildPreviewSkins(){
    const palettes = ["gold","violet","turquoise","rose","lime","sapphire","ember","obsidian","mint"];
    const patterns = ["speckle","stripe","swirl","mosaic","metallic"];
    const rarHints = ["LEG","EP","RARE","UN","COM"];
    const seeds=[]; rarHints.forEach(r=>palettes.forEach(p=>patterns.forEach(t=>seeds.push(`${r}-${p}-${t}`))));
    const picked=[]; for(let i=0;i<seeds.length;i+=3) picked.push(seeds[i]);
    return picked;
  }
  const previewSkins = buildPreviewSkins();
  function loadEggSkin(seed){ eggPreview.src=`/nftsvg/EGGDEMO.svg?skin=${encodeURIComponent(seed)}&nobg=1&nc=${Date.now()}`; }
  loadEggSkin(previewSkins[0]);

  async function spinEggs(finalSeed){
    const spins=27, delay=120;
    for(let i=0;i<spins;i++){ loadEggSkin(previewSkins[i%previewSkins.length]); await new Promise(r=>setTimeout(r,delay)); }
    loadEggSkin(finalSeed);
  }

  function __readVault(){ try{ const s=localStorage.getItem('izza_test_wallet'); return s?JSON.parse(s):null; }catch{return null} }
  function __writeVault(j){ try{ localStorage.setItem('izza_test_wallet', JSON.stringify(j||{})); }catch{} }
  function __forgetSecret(pub){ try{ const v=__readVault()||{}; if(v && v.pub===pub){ delete v.sec; __writeVault(v); } }catch{} }
  function getLocalSecret(pub){ try{ const v=__readVault(); if(!v) return ''; if(pub && v.pub!==pub) return ''; return v.sec||''; }catch{return ''} }
  function isLocalWallet(pub){ const v=__readVault(); return !!(v && v.pub===pub && /^S[A-Z0-9]{55}$/.test(v.sec||'')); }

  async function fetchActiveWallet(username){
    const qs = username ? ('?u='+encodeURIComponent(username)) : '';
    const r = await fetch('/api/wallet/active'+qs, {credentials:'include'});
    if(!r.ok) return null;
    return r.json().catch(()=>null);
  }
  async function linkActiveWallet(username, pub, secret){
    const qs = username ? ('?u='+encodeURIComponent(username)) : '';
    const body = { pub: String(pub||'').trim().toUpperCase() };
    if(secret && /^S[A-Z0-9]{55}$/.test(secret)) body.secret = secret.trim();
    const r = await fetch('/api/wallet/link'+qs, { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body), credentials:'include' });
    const j = await r.json().catch(()=>null);
    return { ok:r.ok, status:r.status, json:j };
  }
  async function fetchBalances(username){
    const qs = username ? ('?u='+encodeURIComponent(username)) : '';
    const r = await fetch('/api/wallet/balances'+qs, {credentials:'include'});
    if(!r.ok) return null;
    return r.json().catch(()=>null);
  }

  const SRV_USER = {{ (username or '') | tojson }};
  function stripAt(s){ return (s||'').toString().trim().replace(/^@+/, ''); }
  const USER_CANON = (()=>{
    const fromSrv = stripAt(SRV_USER);
    if(fromSrv) return fromSrv;
    try{
      const raw = localStorage.getItem('piAuthUser');
      if(raw){ const j=JSON.parse(raw); if(j && j.username) return stripAt(j.username); }
    }catch{}
    try{
      const uCanon = localStorage.getItem('izzaUserCanon');
      if(uCanon) return stripAt(uCanon);
      const u = localStorage.getItem('izzaUserU');
      if(u) return stripAt(u);
    }catch{}
    return '';
  })();
  try{
    if(USER_CANON){
      localStorage.setItem('izzaUserCanon', USER_CANON);
      localStorage.setItem('izzaUserU', USER_CANON.toLowerCase());
    }
  }catch{}

  function openMyWallet(){ document.getElementById('myWalletModal').removeAttribute('hidden'); refreshMyWalletModal(); }
  function closeMyWallet(){ document.getElementById('myWalletModal').setAttribute('hidden',''); }
  document.getElementById('openWallet').addEventListener('click', openMyWallet);
  document.getElementById('closeMyWalletBtn').addEventListener('click', closeMyWallet);

  async function refreshMyWalletModal(){
    document.getElementById('mwUser').textContent = USER_CANON ? '@'+USER_CANON : '—';
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    document.getElementById('mwPub').textContent = pub || '—';
    const has = pub && isLocalWallet(pub);
    document.getElementById('mwSStatus').innerHTML = has ? '<span class="success">Saved locally</span>' : '<span class="warn">Not saved</span>';

    try{
      const b = await fetchBalances(USER_CANON);
      document.getElementById('balPi').textContent = b && b.pi || '—';
      document.getElementById('balIzza').textContent = b && b.izza || '—';
    }catch{
      document.getElementById('balPi').textContent = '—';
      document.getElementById('balIzza').textContent = '—';
    }
  }
  document.getElementById('mwSaveBtn').addEventListener('click', async ()=>{
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(!/^G[A-Z0-9]{55}$/.test(pub)){ alert('Open your IZZA wallet once to set an active wallet, then return.'); return; }
    const secret = (document.getElementById('mwSInput').value||'').trim();
    if(!/^S[A-Z0-9]{55}$/.test(secret)){ alert('Enter a valid S key'); return; }
    const v = __readVault() || {}; v.pub = pub; v.sec = secret; __writeVault(v);
    const res = await linkActiveWallet(USER_CANON, pub, secret);
    if(!res.ok){ alert('Server link failed: ' + (res.json && res.json.error || res.status)); }
    document.getElementById('mwSInput').value = '';
    refreshMyWalletModal();
    alert('S key saved locally and linked.');
  });
  document.getElementById('mwForgetBtn').addEventListener('click', async ()=>{
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(pub) __forgetSecret(pub);
    refreshMyWalletModal();
  });

  async function ensureUserAndWalletGate(){
    const active = await fetchActiveWallet(USER_CANON);
    const pub = active && active.pub || '';
    if(!USER_CANON){ alert('Sign in with Pi first.'); return null; }
    if(!pub){ alert('Open your IZZA wallet once to set an active wallet, then return.'); return null; }
    if(!isLocalWallet(pub)){
      openMyWallet();
      alert('Save your S key locally first.');
      return null;
    }
    return { user:USER_CANON, pub, sec:getLocalSecret(pub) };
  }

  let lastCode = null, lastIssuer = null;
  async function refreshLive(){
    if(!lastCode){ liveHint.textContent='Mint an egg to see it here'; return; }
    try{
      const meta = `/nftmeta/${lastCode}.json?nc=${Date.now()}`;
      const j = await fetch(meta).then(r=>r.json());
      liveSvg.src = (j.image || '') + '&pulse=' + Date.now();
      openHabitat.href = j.external_url || '#';
      liveHint.textContent = 'Feed once per day. Miss 3 days and it dies. Revive by feeding 3 days in a row.';
    }catch(e){}
  }
  setInterval(refreshLive, 3000);

  // Collection Stats
  async function loadCollectionStats(){
    try{
      const j = await fetch('/api/creatures/collection-stats').then(r=>r.json());
      if(j && j.ok){
        supplyVal.textContent   = `${j.circulating} / ${j.cap}`;
        hatchedCount.textContent= String(j.minted_total);
        burntCount.textContent  = String(j.burned_total);
        const alive = j.rarity_alive || {};
        legCount.textContent    = String(alive.legendary ?? 0);
        epCount.textContent     = String(alive.epic ?? 0);
        rareCount.textContent   = String(alive.rare ?? 0);
        unCount.textContent     = String(alive.uncommon ?? 0);
        comCount.textContent    = String(alive.common ?? 0);
      }
    }catch(e){}
  }

  // Army Strength
  async function loadArmyStrength(){
    try{
      const qs = USER_CANON ? ('?u='+encodeURIComponent(USER_CANON)) : '';
      const j = await fetch('/api/creatures/army-stats'+qs, {credentials:'include'}).then(r=>r.json());
      if(j && j.ok){
        armyAtk.textContent = String(j.attack ?? 0);
        armyDef.textContent = String(j.defense ?? 0);
        armyCnt.textContent = String(j.count ?? 0);
        armyBox.style.display = 'block';
      }
    }catch(e){}
  }

  (async ()=>{
    try{
      const j = await fetch('/api/creatures/latest', {credentials:'include'}).then(r=>r.json());
      if(j && j.latest && j.latest.code){
        lastCode = j.latest.code;
        lastIssuer = j.latest.issuer;
        await refreshLive();
      }
    }catch(e){}
    try{ await refreshMyWalletModal(); }catch{}
    try{ await loadCollectionStats(); }catch{}
    try{ await loadArmyStrength(); }catch{}
  })();

  mintBtn.addEventListener('click', async ()=>{
    const gate = await ensureUserAndWalletGate();
    if(!gate){ return; }

    mintMsg.innerHTML = `
      <div class="loading"><span class="spin"></span><span>Minting in progress, please wait…</span></div>
      <div style="margin-top:4px">❕ CRAFTED BY THE HANDS OF IZZA GODS ❕</div>
    `;

    const previewSkins=(()=>{const palettes=["gold","violet","turquoise","rose","lime","sapphire","ember","obsidian","mint"];const patterns=["speckle","stripe","swirl","mosaic","metallic"];const rarHints=["LEG","EP","RARE","UN","COM"];const seeds=[];for(const r of rarHints){for(const p of palettes){for(const t of patterns){seeds.push(`${r}-${p}-${t}`);}}}const picked=[];for(let i=0;i<seeds.length;i+=3)picked.push(seeds[i]);return picked;})();
    const finalSkin = previewSkins[Math.floor(Math.random()*previewSkins.length)];
    const spins=27, delay=120;
    for(let i=0;i<spins;i++){
      eggPreview.src = `/nftsvg/EGGDEMO.svg?skin=${encodeURIComponent(previewSkins[i % previewSkins.length])}&nobg=1&nc=${Date.now()}`;
      await new Promise(r=>setTimeout(r,delay));
    }
    eggPreview.src = `/nftsvg/EGGDEMO.svg?skin=${encodeURIComponent(finalSkin)}&nobg=1&nc=${Date.now()}`;

    try{
      const res = await fetch('/api/creatures/mint', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ buyer_pub:gate.pub, buyer_sec:gate.sec, skin: finalSkin })
      }).then(r=>r.json());
      if(!(res && res.ok)) throw new Error(res && res.error || 'mint_failed');

      lastCode = res.asset.code; lastIssuer = res.asset.issuer;

      const ac = await fetch('/api/creatures/auto-claim', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code:lastCode, owner_pub:gate.pub })
      }).then(r=>r.json()).catch(()=>null);

      if(ac && ac.ok && ac.delivered){
        mintMsg.innerHTML = `Egg minted and <span class="success">delivered</span> to your IZZA wallet: <strong>${lastCode}</strong>`;
      }else if(ac && ac.ok){
        mintMsg.innerHTML = `Egg minted: <strong>${lastCode}</strong>. A claim was created, open the wallet to accept.`;
      }else{
        mintMsg.innerHTML = `Egg minted: <strong>${lastCode}</strong>. Open your wallet to deliver it.`;
      }

      await refreshLive();
      await refreshMyWalletModal();
      await loadCollectionStats();
      await loadArmyStrength();
      if (document.getElementById('myCreaturesBox').style.display !== 'none') {
        document.getElementById('btnMyCreatures').click();
      }
    }catch(e){
      console.error(e);
      mintMsg.textContent = 'Mint failed, please try again';
    }
  });

  document.getElementById('feedBtn').addEventListener('click', async ()=>{
    if(!lastCode){ mintMsg.textContent='Mint or select a creature first'; return; }
    const gate = await ensureUserAndWalletGate(); if(!gate){ return; }
    await fetch('/api/creatures/feed', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code:lastCode, owner_pub:gate.pub })
    });
    refreshLive();
  });

  async function burnCreature(code){
    const gate = await ensureUserAndWalletGate(); if(!gate){ return; }
    const ok = confirm("You are about to Burn this NFT! Are you sure you want to send this IZZA Creature back into the hands of IZZA gods?");
    if(!ok) return;
    try{
      const r = await fetch('/api/creatures/burn', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, owner_pub: gate.pub })
      }).then(r=>r.json());
      if(!(r && r.ok)){ alert('Burn failed'); return; }
      await loadCollectionStats();
      await loadArmyStrength();
      if(lastCode === code){
        lastCode = null;
        liveSvg.src = '';
        liveHint.textContent = 'Select another creature from your collection.';
      }
      if (document.getElementById('myCreaturesBox').style.display !== 'none') {
        document.getElementById('btnMyCreatures').click();
      }
      alert('Burn complete.');
    }catch(e){
      alert('Burn failed.');
    }
  }

  const myBox  = document.getElementById('myCreaturesBox');
  const myList = document.getElementById('myCreaturesList');
  document.getElementById('btnMyCreatures').addEventListener('click', async ()=>{
    myList.innerHTML = '';
    const qs = USER_CANON ? ('?u='+encodeURIComponent(USER_CANON)) : '';
    const j = await fetch('/api/creatures/mine'+qs, {credentials:'include'}).then(r=>r.json()).catch(()=>({items:[]}));
    (j.items||[]).forEach(it=>{
      const card = document.createElement('div');
      card.className = 'thumb';

      const img = document.createElement('img');
      img.alt = it.code;
      img.src = `/nftsvg/${it.code}.svg?nc=${Date.now()}`;

      const cap = document.createElement('div');
      cap.className = 'cap';
      cap.textContent = it.code + (it.stage ? ` — ${it.stage}` : '');

      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '8px';

      const openA = document.createElement('a');
      openA.href = `/creature/${it.code}`;
      openA.className = 'btn';
      openA.textContent = 'OPEN';

      const burnB = document.createElement('button');
      burnB.type = 'button';
      burnB.className = 'btn red';
      burnB.textContent = 'BURN';
      burnB.addEventListener('click', ()=> burnCreature(it.code));

      row.appendChild(openA);
      row.appendChild(burnB);

      card.appendChild(img);
      card.appendChild(cap);
      card.appendChild(row);
      myList.appendChild(card);
    });
    myBox.style.display = 'block';
    await loadArmyStrength();
    window.scrollTo({top: myBox.offsetTop - 12, behavior:'smooth'});
  });

})();
</script>

<!-- Friends/notifications overlay script kept as-is -->
<script>
/* existing friends and notifications script exactly as before */
</script>
</body>
</html>
