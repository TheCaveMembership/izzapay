<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sales — {{ m['business_name'] }}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f6f7fb;color:#0b0f17}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}

    .card{background:#fff;border:1px solid #e6e8f0;border-radius:12px;padding:16px;margin-bottom:16px}
    h2{margin:0 0 8px}
    .muted{color:#4b587c}

    .notice{padding:10px 12px;border-radius:10px;border:1px solid #e6e8f0;background:#f1f7ff;margin-bottom:10px}
    .notice.warn{background:#fff7ea}
    .notice.err{background:#fff1f1;border-color:#ffd0d0}
    .foot{font-size:12px;color:#4b587c;margin-top:6px}

    table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;text-align:left;vertical-align:top}
    th{background:#fafbff;color:#333}

    /* Two-rows-per-order layout */
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .rowbox{
      border:1px solid #e6e8f0;border-radius:10px;padding:10px;background:#fff
    }
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px}
    .k{color:#4b587c;font-size:12px}
    .v{font-size:14px;word-break:break-word}

    form.inline{display:flex;gap:6px;flex-wrap:wrap}
    input,select,button{padding:6px;border-radius:6px;border:1px solid #ccd}
    button{background:#1f6fff;color:#fff;border:none;cursor:pointer}
    button:hover{background:#155de0}

    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .stat{border:1px solid #e6e8f0;border-radius:10px;padding:10px;background:#fff}
    .stat .k{font-size:12px;color:#4b587c;letter-spacing:.2px}
    .stat .v{font-size:16px;font-weight:700;margin-top:2px}

    @media (max-width:800px){
      .stats{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:640px){
      .split{grid-template-columns:1fr}
      .kv{grid-template-columns:110px 1fr}
      th,td{font-size:13px}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h2>Sales — {{ m['business_name'] }}</h2>

    {% if payout_sent %}
      <div class="notice"><strong>Payout request sent.</strong> You’ll receive your Pi within 24 hours.</div>
    {% endif %}

    {% if payout_throttled %}
      <div class="notice warn">
        <strong>Heads up:</strong> You requested a payout recently. Please wait
        {% if throttle_minutes and throttle_minutes >= 60 %}
          ~{{ (throttle_minutes // 60)|int }} hour{% if (throttle_minutes // 60)|int != 1 %}s{% endif %}
        {% else %}
          ~{{ throttle_minutes or 60 }} minute{% if (throttle_minutes or 60) != 1 %}s{% endif %}
        {% endif %}
        before requesting another payout.
      </div>
    {% endif %}

    {% if payout_error %}
      <div class="notice err">
        <strong>Something went wrong.</strong> Please try again, or contact support if this continues.
      </div>
    {% endif %}

    <div class="notice">
      <strong>Heads up from IZZA PAY:</strong> Payouts are processed <u>weekly</u>.
      If you’d like to receive your funds sooner, you can request a payout to be completed
      within the next 24 hours.
      <form method="POST" action="/merchant/{{ m['slug'] }}/payout" style="display:inline" class="payoutForm">
        {% if t %}<input type="hidden" name="t" value="{{ t }}">{% endif %}
        <button type="submit" class="payoutBtn">Request payout within 24 hours</button>
      </form>
      <div class="foot">We’ll deduct the standard 1% app fee; Pi network fees may also apply.</div>
    </div>

    {% if stats %}
      <div class="stats" style="margin-top:8px">
        <div class="stat">
          <div class="k">Gross (30d)</div>
          <div class="v">{{ '%.7f'|format(stats.gross_30 or 0) }} π</div>
        </div>
        <div class="stat">
          <div class="k">Pi Fee (30d)</div>
          <div class="v">{{ '%.7f'|format(stats.fee_30 or 0) }} π</div>
        </div>
        <div class="stat">
          <div class="k">App Fee 1% (30d)</div>
          <div class="v">{{ '%.7f'|format(stats.app_fee_30 or 0) }} π</div>
        </div>
        <div class="stat">
          <div class="k">Net to Merchant (30d)</div>
          <div class="v">{{ '%.7f'|format(stats.net_30 or 0) }} π</div>
        </div>
        <div class="stat">
          <div class="k">Wallet on File</div>
          <div class="v" style="font-size:12px;word-break:break-all">{{ m['pi_wallet_address'] or '—' }}</div>
        </div>
      </div>

      <!-- Classic payout button retained, also uses confirmation -->
      <form method="POST" action="/merchant/{{ m['slug'] }}/payout" style="margin-top:10px" class="payoutForm">
        {% if t %}<input type="hidden" name="t" value="{{ t }}">{% endif %}
        <button type="submit" class="payoutBtn">Request Payout</button>
        <span class="foot" style="margin-left:8px">Payout may take up to 24 hours.</span>
      </form>
      <div class="foot notice warn" style="margin-top:8px">
        Note: when the payout is deposited into your Pi wallet, the Pi network may charge a separate transaction fee.
      </div>
    {% endif %}
  </div>

  <div class="card">
    {% if orders and orders|length > 0 %}
      {% for o in orders %}
        <div class="split" style="margin-bottom:12px">
          <div class="rowbox">
            <div class="kv">
              <div class="k">ID</div><div class="v">#{{ o['id'] }}</div>
              <div class="k">Item</div><div class="v">{{ o['item_title'] }}</div>
              <div class="k">Qty</div><div class="v">{{ o['qty'] }}</div>
              <div class="k">Buyer</div><div class="v">{{ o['buyer_email'] or '—' }}</div>
            </div>
          </div>
          <div class="rowbox">
            <div class="kv">
              <div class="k">Status</div><div class="v">{{ o['status'] }}</div>
              <div class="k">Pi (G/F/N)</div>
              <div class="v">
                {{ '%.7f'|format(o['pi_amount'] or 0) }} /
                {{ '%.7f'|format(o['pi_fee'] or 0) }} /
                {{ '%.7f'|format(o['pi_merchant_net'] or 0) }}
              </div>
              <div class="k">Payout</div><div class="v">{{ o['payout_status'] or 'pending' }}</div>
              <div class="k">Tracking</div>
              <div class="v">
                {% if o['tracking_number'] %}
                  {{ o['tracking_carrier'] }} {{ o['tracking_number'] }}
                  {% if o['tracking_url'] %}<br><a href="{{ o['tracking_url'] }}">track</a>{% endif %}
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="rowbox" style="margin-bottom:16px">
          <form class="inline" method="post" action="/merchant/{{ m['slug'] }}/orders/update">
            {% if t %}<input type="hidden" name="t" value="{{ t }}">{% endif %}
            <input type="hidden" name="order_id" value="{{ o['id'] }}">
            <select name="status">
              <option value="">—</option>
              {% for st in ["paid","processing","shipped","delivered","cancelled","refunded"] %}
                <option value="{{ st }}">{{ st }}</option>
              {% endfor %}
            </select>
            <input name="tracking_carrier" placeholder="Carrier">
            <input name="tracking_number" placeholder="Number">
            <input name="tracking_url" placeholder="URL">
            <button>Save</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">No sales yet.</p>
    {% endif %}

    <p class="foot" style="margin-top:10px">
      <a href="/merchant/{{ m['slug'] }}/items{% if t %}?t={{ t }}{% endif %}">Back to Items</a>
    </p>
  </div>

</div>

<script>
  // Attach a confirmation popup to ALL payout buttons on the page
  (function(){
    const forms = document.querySelectorAll('.payoutForm');
    if (!forms) return;

    // Pull current stats from server-rendered context (safe defaults if missing)
    const gross = {{ (stats.gross_30 or 0)|float }};
    const fee   = {{ (stats.fee_30   or 0)|float }};
    const appF  = {{ (stats.app_fee_30 or 0)|float }};
    const net   = {{ (stats.net_30   or 0)|float }};
    const store = {{ (m['business_name']|tojson) if m['business_name'] else '""' }};
    const wallet = {{ (m['pi_wallet_address']|tojson) if m['pi_wallet_address'] else '""' }};

    const fmt = (n) => (typeof n === 'number' ? n.toFixed(7) : n);

    const msg =
`You're about to request a payout for:
Store: ${store || '—'}
Wallet: ${wallet || '—'}

Last 30 days (approx):
• Gross: ${fmt(gross)} π
• Pi Fee: ${fmt(fee)} π
• App Fee (1%): ${fmt(appF)} π
———————————————
Net to pay: ${fmt(net)} π

We will email IZZA PAY (info@izzapay.shop) your store & wallet details.
Proceed?`;

    forms.forEach(f => {
      f.addEventListener('submit', function(ev){
        const ok = confirm(msg);
        if (!ok) ev.preventDefault();
      });
    });
  })();
</script>
</body>
</html>
