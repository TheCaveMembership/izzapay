<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>IZZA GAME — Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{ --ui:rgba(255,255,255,.9); --bg0:#0b0f17; --card:#141a23; --line:#263042; }
    html,body{height:100%; margin:0; background:#0b0f17; color:#e8eef7; font-family:Arial,Helvetica,sans-serif}
    /* prevent long-press selection/cursor on iOS */
    *{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    canvas{ touch-action:none; }

    .wrap{max-width:1100px;margin:0 auto;padding:8px}
    .hud{
      position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between;
      background:rgba(10,12,18,.75); backdrop-filter:blur(8px); padding:8px 10px; border-bottom:1px solid var(--line)
    }
    .hud .left{display:flex;gap:12px;align-items:center}
    .hud .pill{background:#1b2433; border:1px solid var(--line); padding:6px 10px; border-radius:10px; font-size:13px}
    .hud .stars{display:flex; gap:4px}
    .star{width:16px; height:16px; border:1px solid #445; border-radius:3px; background:#111}
    .star.on{background:#ffd23f; border-color:#c59b00}

    #gameCard{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:10px; margin-top:10px; position:relative}
    #game{display:block; width:100%; height:auto; border-radius:12px; background:#000}
    #prompt {
      position:absolute; transform:translate(-50%,-120%); padding:4px 8px; font-size:12px;
      background:#0b0f17; border:1px solid #263042; border-radius:8px; display:none; pointer-events:none
    }

    /* Mini-map card */
    .mini{
      position:fixed; right:12px; bottom:118px; z-index:6;
      background:rgba(10,12,18,.75); border:1px solid var(--line); border-radius:14px; padding:8px
    }
    #minimap{ width:240px; height:auto; display:block; border-radius:10px; background:#0b0f17 }

    .controls{ position:fixed; right:12px; bottom:14px; z-index:6; display:flex; gap:8px; align-items:center }
    .btn{ background:#162134; color:#cfe0ff; border:1px solid #2a3550; border-radius:10px; padding:10px 12px;
      font-size:14px; }

    .stick { position:fixed; left:12px; bottom:12px; width:120px; height:120px; z-index:6; touch-action:none }
    .stick .base{ position:absolute; inset:0; border-radius:60px; background:rgba(255,255,255,.07); border:1px solid #2a3550 }
    .stick .nub{ position:absolute; left:40px; top:40px; width:40px; height:40px; border-radius:20px; background:#1f2a3f; border:1px solid #2a3550 }
    @media (min-width:820px){ .stick{ display:none; } }

    /* Simple modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:20; }
    .modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); }
    .modal .card{ position:relative; background:#121827; border:1px solid #2a3550; border-radius:14px; padding:16px; width:min(520px,92vw); color:#e8eef7 }
    .modal .card h3{ margin:0 0 8px }
    .modal .row{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .ghost{ background:transparent; color:#cfe0ff; border:1px solid #394769; border-radius:10px; padding:8px 10px }
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="hud">
      <div class="left">
        <div class="pill">IZZA GAME</div>
        <div class="pill">Player: {{ user.username }}</div>
      </div>
      <div class="stars" id="stars">
        <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
      </div>
    </div>

    <div id="gameCard">
      <canvas id="game" width="960" height="540" aria-label="IZZA City"></canvas>
      <div id="prompt">Press B to enter</div>
    </div>
  </div>

  <!-- Mini-map -->
  <div class="mini" id="miniWrap" title="Tap to open world map">
    <canvas id="minimap" width="260" height="170"></canvas>
  </div>

  <!-- Virtual joystick + quick buttons for mobile -->
  <div class="stick" id="stick">
    <div class="base"></div>
    <div class="nub" id="nub"></div>
  </div>
  <div class="controls">
    <button class="btn" id="btnA">A</button>
    <button class="btn" id="btnB">B</button>
  </div>

  <!-- World Map overlay -->
  <div class="modal" id="mapModal">
    <div class="backdrop"></div>
    <div class="card">
      <h3>IZZA City — World Map</h3>
      <canvas id="bigmap" width="700" height="520" style="width:100%;height:auto;border-radius:10px;background:#0b0f17"></canvas>
      <div class="row"><button class="ghost" id="closeMap">Close</button></div>
      <div style="margin-top:8px; font-size:12px; opacity:.85">
        <span style="display:inline-block;width:12px;height:12px;background:#1c293e;border:1px solid #31415d;margin-right:6px;border-radius:3px"></span>Unlocked
        <span style="display:inline-block;width:12px;height:12px;background:rgba(163,176,197,.25);border:1px solid #485771;margin-right:6px;border-radius:3px;margin-left:12px"></span>Preview (semi-transparent)
        <span style="display:inline-block;width:12px;height:12px;background:#1b1f2a;border:1px solid #2a3140;margin-right:6px;border-radius:3px;margin-left:12px"></span>Locked
      </div>
    </div>
  </div>

  <!-- Enter building modal -->
  <div class="modal" id="enterModal">
    <div class="backdrop"></div>
    <div class="card">
      <h3>Welcome to The Hub</h3>
      <p>Talk to the NPC inside to get your first mission and start earning!</p>
      <div class="row"><button class="ghost" id="closeEnter">Close</button></div>
    </div>
  </div>

  <script>
  (function(){
    const profile = {{ profile|tojson|safe }};
    const BODY   = profile.sprite_skin || "default";
    const HAIR   = profile.hair || "short";
    const OUTFIT = profile.outfit || "street";

    // ---------- Canvas & constants ----------
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');
    const TILE = 32;
    const SCALE = 3;           // slightly more zoomed out than 4
    const DRAW  = TILE * SCALE;

    // ---------- World + unlocked region ----------
    const W = 90, H = 60;
    const unlocked = { x0: 18, y0: 18, x1: 72, y1: 42 }; // playable rectangle (inclusive)
    function inUnlocked(gx,gy){ return gx>=unlocked.x0 && gx<=unlocked.x1 && gy>=unlocked.y0 && gy<=unlocked.y1; }

    // Building: 10×6 tiles
    const bW=10, bH=6;
    const bX = Math.floor((unlocked.x0 + unlocked.x1)/2) - Math.floor(bW/2);
    const bY = unlocked.y0 + 4;

    // Sidewalk & road rows relative to building
    const sidewalkY = bY + bH;       // directly under the building
    const roadY     = sidewalkY + 1; // below sidewalk

    // Door centered on sidewalk under building
    const door = { gx: bX + Math.floor(bW/2), gy: sidewalkY, inRange:false };

    // --------- Asset loader ----------
    function loadImg(src){ return new Promise((res, rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
    const assetRoot = "/static/game/sprites";
    const assets = {
      body:   `${assetRoot}/body/${BODY}.png`,
      hair:   `${assetRoot}/hair/${HAIR}.png`,
      outfit: `${assetRoot}/outfit/${OUTFIT}.png`,
    };

    // --------- Player (spawn on sidewalk at door) ----------
    const player = {
      x: door.gx * TILE + 2,
      y: door.gy * TILE + 2,
      vx: 0, vy: 0,
      speed: 2.0 * (TILE/16),
      wanted: 0
    };

    // --------- Input ----------
    const keys = {};
    function handleB(){
      if(doorInRange()){ openEnter(); }
      else { setWanted(0); }
    }
    window.addEventListener('keydown', e=>{
      const k = e.key.toLowerCase();
      keys[k] = true;
      if(k==='b') handleB();
    });
    window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

    document.getElementById('btnA').addEventListener('click', ()=> setWanted(player.wanted+1));
    document.getElementById('btnB').addEventListener('click', handleB);

    // Joystick
    const stick = document.getElementById('stick');
    const nub   = document.getElementById('nub');
    let dragging=false, baseRect=null, vec={x:0,y:0};
    const setNub=(dx,dy)=>{ const r=40, m=Math.hypot(dx,dy)||1, c=Math.min(m,r), ux=dx/m, uy=dy/m;
      nub.style.left=(40+ux*c)+'px'; nub.style.top=(40+uy*c)+'px'; vec.x=(c/r)*ux; vec.y=(c/r)*uy; };
    const resetNub=()=>{ nub.style.left='40px'; nub.style.top='40px'; vec.x=0; vec.y=0; };
    const startDrag=()=>{ dragging=true; baseRect=stick.getBoundingClientRect(); };
    const moveDrag=(e)=>{ if(!dragging) return; const t=e.touches?e.touches[0]:e;
      const cx=baseRect.left+baseRect.width/2, cy=baseRect.top+baseRect.height/2; setNub(t.clientX-cx,t.clientY-cy); };
    const endDrag=()=>{ dragging=false; resetNub(); };
    stick.addEventListener('touchstart',startDrag,{passive:true});
    stick.addEventListener('touchmove', moveDrag, {passive:true});
    stick.addEventListener('touchend',  endDrag,  {passive:true});
    stick.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove',moveDrag);
    window.addEventListener('mouseup',  endDrag);

    // --------- Wanted HUD ----------
    function setWanted(n){
      player.wanted = Math.max(0, Math.min(5, n|0));
      document.querySelectorAll('#stars .star').forEach((s,i)=> s.className='star' + (i<player.wanted?' on':'') );
    }

    // --------- Camera ----------
    const camera={x:0,y:0};
    function centerCamera(){
      camera.x = player.x - cvs.width/2;
      camera.y = player.y - cvs.height/2;
      const maxX = (unlocked.x1+1)*TILE - cvs.width;
      const maxY = (unlocked.y1+1)*TILE - cvs.height;
      camera.x = Math.max(unlocked.x0*TILE, Math.min(camera.x, maxX));
      camera.y = Math.max(unlocked.y0*TILE, Math.min(camera.y, maxY));
    }

    // --------- Collisions ----------
    function isBuilding(gx,gy){ return gx>=bX && gx<bX+bW && gy>=bY && gy<bY+bH; }
    function isSolid(gx,gy){
      if(!inUnlocked(gx,gy)) return true;
      if(isBuilding(gx,gy))  return true;
      return false;
    }
    function tryMove(nx,ny){
      // check X axis
      const cornersX = [
        {x:nx, y:player.y}, {x:nx+TILE-1, y:player.y},
        {x:nx, y:player.y+TILE-1}, {x:nx+TILE-1, y:player.y+TILE-1}
      ];
      if(!cornersX.some(c=>isSolid(Math.floor(c.x/TILE), Math.floor(c.y/TILE)))) player.x = nx;

      // check Y axis
      const cornersY = [
        {x:player.x, y:ny}, {x:player.x+TILE-1, y:ny},
        {x:player.x, y:ny+TILE-1}, {x:player.x+TILE-1, y:ny+TILE-1}
      ];
      if(!cornersY.some(c=>isSolid(Math.floor(c.x/TILE), Math.floor(c.y/TILE)))) player.y = ny;
    }

    // --------- Door UX ----------
    const promptEl = document.getElementById('prompt');
    function doorInRange(){
      const px = Math.floor(player.x / TILE);
      const py = Math.floor(player.y / TILE);
      return (Math.abs(px-door.gx)+Math.abs(py-door.gy))<=1;
    }
    function openEnter(){ document.getElementById('enterModal').style.display='flex'; }
    document.getElementById('closeEnter').addEventListener('click', ()=> document.getElementById('enterModal').style.display='none');
    document.getElementById('enterModal').addEventListener('click', (e)=>{ if(e.target.classList.contains('backdrop')) e.currentTarget.style.display='none'; });

    // --------- Map (mini + big) ----------
    const mini = document.getElementById('minimap');
    const mctx = mini.getContext('2d');
    const mapModal = document.getElementById('mapModal');
    const bigmap   = document.getElementById('bigmap');
    const bctx     = bigmap.getContext('2d');

    function drawMini(){
      const sx = mini.width / W, sy = mini.height / H;
      // locked background
      mctx.fillStyle = '#1b1f2a'; mctx.fillRect(0,0,mini.width,mini.height);
      // preview
      mctx.fillStyle = 'rgba(163,176,197,.25)'; mctx.fillRect(0,0,mini.width,mini.height);
      // unlocked
      mctx.fillStyle = '#1c293e';
      mctx.fillRect(unlocked.x0*sx, unlocked.y0*sy, (unlocked.x1-unlocked.x0+1)*sx, (unlocked.y1-unlocked.y0+1)*sy);
      // building
      mctx.fillStyle = '#7a3a3a'; mctx.fillRect(bX*sx, bY*sy, bW*sx, bH*sy);
      // roads
      mctx.fillStyle = '#788292';
      mctx.fillRect(unlocked.x0*sx, roadY*sy, (unlocked.x1-unlocked.x0+1)*sx, 1.2*sy);
      mctx.fillRect((door.gx)*sx, unlocked.y0*sy, 1.2*sx, (unlocked.y1-unlocked.y0+1)*sy);
      // player
      mctx.fillStyle = '#35f1ff'; mctx.fillRect((player.x/TILE)*sx-1, (player.y/TILE)*sy-1, 2, 2);
    }
    function drawBig(){
      const sx = bigmap.width / W, sy = bigmap.height / H;
      bctx.fillStyle = '#1b1f2a'; bctx.fillRect(0,0,bigmap.width,bigmap.height);
      bctx.fillStyle = 'rgba(163,176,197,.25)'; bctx.fillRect(0,0,bigmap.width,bigmap.height);
      bctx.fillStyle = '#1c293e';
      bctx.fillRect(unlocked.x0*sx, unlocked.y0*sy, (unlocked.x1-unlocked.x0+1)*sx, (unlocked.y1-unlocked.y0+1)*sy);
      bctx.fillStyle = '#7a3a3a'; bctx.fillRect(bX*sx, bY*sy, bW*sx, bH*sy);
      bctx.fillStyle = '#788292';
      bctx.fillRect(unlocked.x0*sx, roadY*sy, (unlocked.x1-unlocked.x0+1)*sx, 1.5*sy);
      bctx.fillRect((door.gx)*sx, unlocked.y0*sy, 1.5*sx, (unlocked.y1-unlocked.y0+1)*sy);
      bctx.fillStyle = '#35f1ff'; bctx.fillRect((player.x/TILE)*sx-1.5,(player.y/TILE)*sy-1.5,3,3);
    }
    function openMap(){ drawBig(); mapModal.style.display='flex'; }
    function closeMap(){ mapModal.style.display='none'; }
    document.getElementById('miniWrap').addEventListener('click', openMap);
    document.getElementById('closeMap').addEventListener('click', closeMap);
    mapModal.addEventListener('click', (e)=>{ if(e.target.classList.contains('backdrop')) closeMap(); });

    // --------- Drawing ----------
    function drawTile(gx,gy,screenX,screenY){
      const S = DRAW;

      // Outside unlocked → black & solid
      if(!inUnlocked(gx,gy)){ ctx.fillStyle='#000'; ctx.fillRect(screenX,screenY,S,S); return; }

      // Base: grass
      ctx.fillStyle = '#09371c';
      ctx.fillRect(screenX,screenY,S,S);

      // Building area
      if(gx>=bX && gx<bX+bW && gy>=bY && gy<bY+bH){
        ctx.fillStyle = '#4a2d2d'; ctx.fillRect(screenX,screenY,S,S);
        ctx.fillStyle = 'rgba(0,0,0,.15)'; ctx.fillRect(screenX,screenY,S,6);
      }

      // Sidewalk
      if(gy===sidewalkY){
        ctx.fillStyle = '#6a727b'; ctx.fillRect(screenX,screenY,S,S);
        ctx.strokeStyle = 'rgba(0,0,0,.25)'; ctx.strokeRect(screenX,screenY,S,S);
      }

      // Road with dashed center
      if(gy===roadY){
        ctx.fillStyle = '#2a2a2a'; ctx.fillRect(screenX,screenY,S,S);
        ctx.fillStyle = '#ffd23f';
        ctx.fillRect(screenX + S*0.10, screenY + S*0.48, S*0.18, S*0.04);
      }

      // Door (on sidewalk)
      if(gx===door.gx && gy===door.gy){
        const near = doorInRange();
        ctx.fillStyle = near ? '#39cc69' : '#49a4ff';
        const w = Math.floor(S*0.30), h = Math.floor(S*0.70);
        ctx.fillRect(screenX + (S-w)/2, screenY + (S-h), w, h);
        if(near){
          // place prompt above the door
          promptEl.style.left = (screenX + S/2) + 'px';
          promptEl.style.top  = (screenY - 8) + 'px';
          promptEl.style.display = 'block';
        }
      }
    }

    function drawPlayer(images){
      const S = DRAW, sx = Math.floor(player.x - camera.x), sy = Math.floor(player.y - camera.y);
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(images.body,   0,0,TILE,TILE, sx, sy, S, S);
      ctx.drawImage(images.outfit, 0,0,TILE,TILE, sx, sy, S, S);
      ctx.drawImage(images.hair,   0,0,TILE,TILE, sx, sy, S, S);
    }

    // --------- Update loop ----------
    function update(dt){
      promptEl.style.display='none'; // hidden unless door marks it visible this frame

      let dx=0, dy=0;
      if(keys['arrowup']||keys['w']) dy-=1;
      if(keys['arrowdown']||keys['s']) dy+=1;
      if(keys['arrowleft']||keys['a']) dx-=1;
      if(keys['arrowright']||keys['d']) dx+=1;
      dx+=vec.x; dy+=vec.y;

      const mag=Math.hypot(dx,dy);
      const vx = mag? (dx/mag)*player.speed : 0;
      const vy = mag? (dy/mag)*player.speed : 0;

      tryMove(player.x + vx*dt, player.y + vy*dt);
      centerCamera();
    }

    function render(images){
      ctx.fillStyle='#000'; ctx.fillRect(0,0,cvs.width,cvs.height);

      const S = DRAW;
      const tilesX = Math.ceil(cvs.width / S) + 2;
      const tilesY = Math.ceil(cvs.height / S) + 2;
      const startX = Math.max(0, Math.floor(camera.x / TILE));
      const startY = Math.max(0, Math.floor(camera.y / TILE));

      for(let y=0;y<tilesY;y++){
        for(let x=0;x<tilesX;x++){
          const gx = startX + x, gy = startY + y;
          if(gx>=0 && gx<W && gy>=0 && gy<H){
            const screenX = (gx*TILE - camera.x) * (S/TILE);
            const screenY = (gy*TILE - camera.y) * (S/TILE);
            drawTile(gx,gy,screenX,screenY);
          }
        }
      }
      drawPlayer(images);

      // mini-map repaint
      drawMini();
    }

    // --------- Main ---------
    Promise.all([loadImg(assets.body), loadImg(assets.outfit), loadImg(assets.hair)]).then(([body,outfit,hair])=>{
      const imgs = { body, outfit, hair };
      let last = performance.now();
      function loop(now){
        const dt = Math.min(32, now-last); last=now;
        update(dt/16.6667);
        render(imgs);
        requestAnimationFrame(loop);
      }
      centerCamera();
      requestAnimationFrame(loop);
    }).catch(err=>console.error("Sprite load failed", err));

  })();
  </script>
</body>
</html>
