<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>IZZA GAME — Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{ --ui:rgba(255,255,255,.9); --bg0:#0b0f17; --card:#141a23; --line:#263042; }
    html,body{height:100%; margin:0; background:#0b0f17; color:#e8eef7; font-family:Arial,Helvetica,sans-serif}
    *{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    canvas{ touch-action:none; }
    .wrap{max-width:1100px;margin:0 auto;padding:8px}
    .hud{ position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between;
      background:rgba(10,12,18,.75); backdrop-filter:blur(8px); padding:8px 10px; border-bottom:1px solid var(--line) }
    .hud .left{display:flex;gap:12px;align-items:center}
    .hud .pill{background:#1b2433; border:1px solid var(--line); padding:6px 10px; border-radius:10px; font-size:13px}
    .hud .stars{display:flex; gap:6px; margin-left:16px;}
    .star{ width:18px; height:18px; background:#161a22; border:1px solid #2a3550; border-radius:4px;
      -webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.5l2.77 5.61 6.19.9-4.48 4.36 1.06 6.18L12 16.9 6.46 19.55l1.06-6.18L3.04 9.01l6.19-.9L12 2.5z"/></svg>') center/contain no-repeat;
      mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.5l2.77 5.61 6.19.9-4.48 4.36 1.06 6.18L12 16.9 6.46 19.55l1.06-6.18L3.04 9.01l6.19-.9L12 2.5z"/></svg>') center/contain no-repeat; border:none; }
    .star.on{ background:#ffd23f; }
    #gameCard{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:10px; margin-top:10px; position:relative}
    #game{display:block; width:100%; height:auto; border-radius:12px; background:#000}
    #prompt { position:absolute; transform:translate(-50%,-120%); padding:4px 8px; font-size:12px; background:#0b0f17; border:1px solid #263042; border-radius:8px; display:none; pointer-events:none; z-index:2 }
    .mini{ position:fixed; right:12px; bottom:118px; z-index:6; background:rgba(10,12,18,.75); border:1px solid var(--line); border-radius:14px; padding:8px; display:none }
    #minimap{ width:240px; height:auto; display:block; border-radius:10px; background:#0b0f17 }
    .controls{ position:fixed; right:12px; bottom:14px; z-index:6; display:flex; gap:8px; align-items:center }
    .btn{ background:#162134; color:#cfe0ff; border:1px solid #2a3550; border-radius:10px; padding:10px 12px; font-size:14px; }
    .stick { position:fixed; left:12px; bottom:12px; width:120px; height:120px; z-index:6; touch-action:none }
    .stick .base{ position:absolute; inset:0; border-radius:60px; background:rgba(255,255,255,.07); border:1px solid #2a3550 }
    .stick .nub{ position:absolute; left:40px; top:40px; width:40px; height:40px; border-radius:20px; background:#1f2a3f; border:1px solid #2a3550 }
    @media (min-width:820px){ .stick{ display:none; } }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:20; }
    .modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); }
    .modal .card{ position:relative; background:#121827; border:1px solid #2a3550; border-radius:14px; padding:16px; width:min(520px,92vw); color:#e8eef7; pointer-events:auto }
    .modal .card h3{ margin:0 0 8px }
    .modal .row{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .ghost{ background:transparent; color:#cfe0ff; border:1px solid #394769; border-radius:10px; padding:8px 10px }
    .shop-list{ display:flex; flex-direction:column; gap:8px; }
    .shop-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; background:#0f1522; border:1px solid #2a3550; border-radius:10px; }
    .shop-item .meta .name{ font-weight:600 }
    .shop-item .meta .sub{ opacity:.8; font-size:12px }
    .shop-item .buy{ background:#1f2a3f; color:#cfe0ff; border:1px solid #2a3550; border-radius:8px; padding:6px 10px }
    .shop-note{ opacity:.8; font-size:12px; margin-top:6px }
    #invPanel{ max-width:1100px; margin:8px auto 0; display:none; }

    /* Auth Debug styles */
    #authDock{ position:fixed; top:66px; left:10px; z-index:9999; }
    #authDock .chip{ background:#1a2340; color:#cfe0ff; border:1px solid #2a3550; border-radius:14px; padding:6px 10px; font-size:12px; }
    #authPanel{ display:none; background:rgba(12,18,30,.92); border:1px solid #2a3550; border-radius:10px; padding:8px 10px; font-size:12px; color:#9fd4ff; max-width:88vw; line-height:1.35; backdrop-filter:blur(4px); }
    #authPanel .row{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap }
    #authPanel button{ background:#162134; color:#cfe0ff; border:1px solid #2a3550; border-radius:8px; padding:6px 8px; font-size:12px; }
    #authPanel .close{ margin-left:auto }
  </style>

  <!-- Pi SDK (for in-lobby re-auth if needed) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="hud">
      <div class="left">
        <div class="pill">IZZA GAME</div>
        <div class="pill">Player: {{ user.username }}</div>
        <div class="pill" id="coinPill">Coins: 0 IC</div>
      </div>
      <div class="stars" id="stars">
        <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
      </div>
    </div>

    <div id="gameCard">
      <canvas id="game" width="960" height="540" aria-label="IZZA City"></canvas>
      <div id="prompt">Press B to enter</div>
    </div>

    <div id="invPanel"></div>
  </div>

  <div class="mini" id="miniWrap" title="Tap to open world map">
    <canvas id="minimap" width="260" height="170"></canvas>
  </div>

  <div class="stick" id="stick">
    <div class="base"></div>
    <div class="nub" id="nub"></div>
  </div>
  <div class="controls">
    <button class="btn" id="btnA" type="button">A</button>
    <button class="btn" id="btnB" type="button">B</button>
    <button class="btn" id="btnI" type="button" title="Inventory">I</button>
    <button class="btn" id="btnMap" type="button" title="Toggle Minimap">Map</button>
  </div>

  <div class="modal" id="mapModal">
    <div class="backdrop"></div>
    <div class="card">
      <h3>IZZA City — World Map</h3>
      <canvas id="bigmap" width="700" height="520" style="width:100%;height:auto;border-radius:10px;background:#0b0f17"></canvas>
      <div class="row"><button class="ghost" id="closeMap">Close</button></div>
      <div style="margin-top:8px; font-size:12px; opacity:.85">
        <span style="display:inline-block;width:12px;height:12px;background:#1c293e;border:1px solid #31415d;margin-right:6px;border-radius:3px"></span>Unlocked
        <span style="display:inline-block;width:12px;height:12px;background:rgba(163,176,197,.25);border:1px solid #485771;margin-right:6px;border-radius:3px;margin-left:12px"></span>Preview
        <span style="display:inline-block;width:12px;height:12px;background:#000;border:1px solid #2a3140;margin-right:6px;border-radius:3px;margin-left:12px"></span>Locked
      </div>
    </div>
  </div>

  <div class="modal" id="enterModal">
    <div class="backdrop"></div>
    <div class="card">
      <h3>IZZA HQ</h3>
      <p>Welcome! Tutorial:</p>
      <ol style="margin:0 0 8px 18px; padding:0">
        <li>Press <strong>A</strong> to hit the pedestrian (3 hits to knock down, then 1 to finish).</li>
        <li>Oh no! Then eliminate the cop within <strong>30 seconds</strong> or more will arrive.</li>
      </ol>
      <div class="row">
        <button class="ghost" id="startTutorial">Start Tutorial</button>
        <button class="ghost" id="closeEnter">Close</button>
      </div>
    </div>
  </div>

  <div class="modal" id="shopModal">
    <div class="backdrop"></div>
    <div class="card">
      <h3>Shop — Cashier</h3>
      <div class="shop-list" id="shopList"></div>
      <div class="shop-note" id="shopNote"></div>
      <div class="row"><button class="ghost" id="closeShop">Close</button></div>
    </div>
  </div>

  <!-- Pass profile + the short-lived auth token to JS -->
  <script>window.__IZZA_PROFILE__ = {{ profile|tojson|safe }};</script>
  <script>window.__IZZA_T__ = {{ t|tojson|safe }};</script>
  <script>window.__PI_SANDBOX__ = {{ (sandbox|tojson) if sandbox is defined else 'false' }};</script>

  <!-- Multiplayer base paths for game_app (mounted at /izza-game) -->
  <script>
    window.__MP_BASE__ = '/izza-game/api/mp';
    window.__MP_WS__   = '/izza-game/api/mp/ws';
  </script>

  <!-- LOAD ORDER: core FIRST, then plugins -->
  <script src="/static/game/js/izza_core_v3.js?v=12"></script>
  <script src="/static/game/js/plugins/v4_hearts.js?v=1"></script>
  <script src="/static/game/js/plugins/v5_loot.js?v=6"></script>
  <script src="/static/game/js/plugins/v6_ui_exclusive.js?v=1"></script>
  <script src="/static/game/js/plugins/v7_mission2_delivery.js"></script>
  <script src="/static/game/js/plugins/v8_mission3_car_theft.js?v=8.0"></script>
  <script src="/static/game/js/plugins/v1_map_expander.js"></script>
  <script src="/static/game/js/plugins/v1_store_items_plugin.js"></script>
  <script src="/static/game/js/plugins/v1_boat_plugin.js"></script>
  <script src="/static/game/js/plugins/v1_free_drive_plugin.js"></script>
  <script src="/static/game/js/plugins/guns.js?v=1.4"></script>

  <!-- >>> ONLY CHANGE: point persistence to your Node service <<< -->
  <script>window.IZZA_PERSIST_BASE = 'https://izzagame.onrender.com';</script>
  <script src="/static/game/js/izza-persist.js"></script>

  <!-- Multiplayer -->
  <script defer src="/static/game/js/plugins/v9_multiplayer_building.js"></script>
  <script defer src="/static/game/js/plugins/v1_multiplayer_client.js"></script>
  <script src="/static/game/js/plugins/remote_players_api.js"></script>
  <script src="/static/game/js/plugins/v1_pvp_duel.js"></script>

  <!-- ===== Collapsible Auth Debug (non-blocking) ===== -->
  <div id="authDock">
    <button id="authChip" class="chip" type="button">Auth ✓</button>
    <div id="authPanel">
      <div id="authStatus">Auth: checking…</div>
      <div id="authToken" style="margin-top:6px;word-break:break-all">t: </div>
      <div class="row">
        <button id="btnCopy" type="button">Copy token</button>
        <button id="btnEcho" type="button">Open echo</button>
        <button id="btnRefresh" type="button">Refresh</button>
        <button id="btnClose" type="button" class="close">×</button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      var t = (window.__IZZA_T__ || '').toString();
      var chip = document.getElementById('authChip');
      var panel = document.getElementById('authPanel');
      var status = document.getElementById('authStatus');
      var tok = document.getElementById('authToken');
      tok.textContent = 't: ' + (t || '(none)');

      function openPanel(){ panel.style.display='block'; }
      function closePanel(){ panel.style.display='none'; }
      chip.addEventListener('click', openPanel, {passive:true});
      document.getElementById('btnClose').addEventListener('click', closePanel, {passive:true});

      document.getElementById('btnCopy').onclick = async function(){
        try{ await navigator.clipboard.writeText(t||''); status.textContent='Auth: token copied'; }
        catch(e){ status.textContent='Auth: copy failed — prompt shown'; prompt('Copy token:', t||''); }
      };
      document.getElementById('btnEcho').onclick = function(){
        var url = (location.origin + '/izza-game/api/mp/echo' + (t?('?t='+encodeURIComponent(t)):''));
        location.href = url; // same-tab for Pi Browser
      };
      document.getElementById('btnRefresh').onclick = runEcho;

      async function runEcho(){
        if(!t){ status.textContent='Auth: no token'; return; }
        status.textContent='Auth: checking…';
        try{
          const r = await fetch('/izza-game/api/mp/echo?t='+encodeURIComponent(t), {credentials:'include'});
          const j = await r.json();
          if(j && (j.authed===true || j.session_user_id || (j.who&&j.who.username))){
            status.textContent='Auth: authed ✅' + (j.who&&j.who.username?(' ('+j.who.username+')'):'');
          }else{
            status.textContent='Auth: not authed ❌';
          }
        }catch(e){ status.textContent='Auth: echo error'; }
      }
      runEcho(); // one check on load
      // stays collapsed by default; won’t cover B/joystick/etc.
    })();
  </script>
  <!-- ===== /Collapsible Auth Debug ===== -->
</body>
</html>
