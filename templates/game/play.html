<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IZZA GAME — Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <script>
  // point to your mounted app, not just origin
  window.IZZA_PERSIST_BASE = '/izza-game';
</script>
<script src="/static/izza-persist.js"></script>
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{ --ui:rgba(255,255,255,.9); --bg0:#0b0f17; --card:#141a23; --line:#263042; }
    html,body{height:100%; margin:0; background:#0b0f17; color:#e8eef7; font-family:Arial,Helvetica,sans-serif}
    *{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    canvas{ touch-action:none; }
    .wrap{max-width:1100px;margin:0 auto;padding:8px}
    .hud{ position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between;
      background:rgba(10,12,18,.75); backdrop-filter:blur(8px); padding:8px 10px; border-bottom:1px solid var(--line) }
    .hud .left{display:flex;gap:12px;align-items:center}
    .hud .pill{background:#1b2433; border:1px solid var(--line); padding:6px 10px; border-radius:10px; font-size:13px}
    .hud .stars{display:flex; gap:6px; margin-left:16px;}
    .star{ width:18px; height:18px; background:#161a22; border:1px solid #2a3550; border-radius:4px;
      -webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.5l2.77 5.61 6.19.9-4.48 4.36 1.06 6.18L12 16.9 6.46 19.55l1.06-6.18L3.04 9.01l6.19-.9L12 2.5z"/></svg>') center/contain no-repeat;
      mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2.5l2.77 5.61 6.19.9-4.48 4.36 1.06 6.18L12 16.9 6.46 19.55l1.06-6.18L3.04 9.01l6.19-.9L12 2.5z"/></svg>') center/contain no-repeat; border:none; }
    .star.on{ background:#ffd23f; }
    #gameCard{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:10px; margin-top:10px; position:relative}
    #game{display:block; width:100%; height:auto; border-radius:12px; background:#000}
    #prompt { position:absolute; transform:translate(-50%,-120%); padding:4px 8px; font-size:12px; background:#0b0f17; border:1px solid #263042; border-radius:8px; display:none; pointer-events:none; z-index:2 }
    .mini{ position:fixed; right:12px; bottom:118px; z-index:6; background:rgba(10,12,18,.75); border:1px solid var(--line); border-radius:14px; padding:8px; display:none }
    #minimap{ width:240px; height:auto; display:block; border-radius:10px; background:#0b0f17 }
    .controls{ position:fixed; right:12px; bottom:14px; z-index:6; display:flex; gap:8px; align-items:center }
    .btn{ background:#162134; color:#cfe0ff; border:1px solid #2a3550; border-radius:10px; padding:10px 12px; font-size:14px; }
    .stick { position:fixed; left:12px; bottom:12px; width:120px; height:120px; z-index:6; touch-action:none }
    .stick .base{ position:absolute; inset:0; border-radius:60px; background:rgba(255,255,255,.07); border:1px solid #2a3550 }
    .stick .nub{ position:absolute; left:40px; top:40px; width:40px; height:40px; border-radius:20px; background:#1f2a3f; border:1px solid #2a3550 }
    @media (min-width:820px){ .stick{ display:none; } }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:20; }
    .modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); }
    .modal .card{ position:relative; background:#121827; border:1px solid #2a3550; border-radius:14px; padding:16px; width:min(520px,92vw); color:#e8eef7; pointer-events:auto }
    .modal .card h3{ margin:0 0 8px }
    .modal .row{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .ghost{ background:transparent; color:#cfe0ff; border:1px solid #394769; border-radius:10px; padding:8px 10px }
    .shop-list{ display:flex; flex-direction:column; gap:8px; }
    .shop-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; background:#0f1522; border:1px solid #2a3550; border-radius:10px; }
    .shop-item .meta .name{ font-weight:600 }
    .shop-item .meta .sub{ opacity:.8; font-size:12px }
    .shop-item .buy{ background:#1f2a3f; color:#cfe0ff; border:1px solid #2a3550; border-radius:8px; padding:6px 10px }
    .shop-note{ opacity:.8; font-size:12px; margin-top:6px }
    #invPanel{ max-width:1100px; margin:8px auto 0; display:none; }

    /* Auth Debug styles */
    #authDock{ position:fixed; top:66px; left:10px; z-index:9999; }
    #authDock .chip{ background:#1a2340; color:#cfe0ff; border:1px solid #2a3550; border-radius:14px; padding:6px 10px; font-size:12px; }
    #authPanel{ display:none; background:rgba(12,18,30,.92); border:1px solid #2a3550; border-radius:10px; padding:8px 10px; font-size:12px; color:#9fd4ff; max-width:88vw; line-height:1.35; backdrop-filter:blur(4px); }
    #authPanel .row{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap }
    #authPanel button{ background:#162134; color:#cfe0ff; border:1px solid #2a3550; border-radius:8px; padding:6px 8px; font-size:12px; }
    #authPanel .close{ margin-left:auto }
  </style>
<style>
  /* Floating launcher (hides while crafting is open) */
  #btnCraft{
    position:fixed;
    right:12px;
    bottom:160px;
    z-index:9001;
    background:#162134;
    color:#cfe0ff;
    border:1px solid #2a3550;
    border-radius:10px;
    padding:10px 12px;
    font-size:14px;
  }
  body.crafting-open #btnCraft{ display:none !important; }

  /* Crafting modal container: taller + never side-scrolls */
  #craftingModal .card{
    width: min(1200px, 96vw);
    height: min(92vh, 820px);      /* more room so Setup reaches the bottom */
    padding: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    overscroll-behavior: contain;   /* stop background scroll chaining */
  }

  /* Root & tabs area sizing so inner panes scroll, not the card */
  #craftingRoot{
    flex: 1;
    display:flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
  }
  #craftTabs{
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* Create Item layout: two columns on wide; stacked on phones */
  .cl-body{
    display:grid;
    grid-template-columns: minmax(320px,1.2fr) 1fr;
    gap:12px;
    height:100%;
    padding:14px;
    overflow:hidden;                /* kill any horizontal scroll */
  }

  .cl-pane{
    background:#0f1522;
    border:1px solid #2a3550;
    border-radius:12px;
    padding:12px;
    min-width:0;
    overflow-x:hidden;
    box-sizing:border-box;          /* important to prevent side scroll */
  }

  .cl-form{
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    /* keep last controls above iOS home bar / keyboard */
    padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 110px);
  }

  .cl-preview{
    overflow-y:auto;
    overflow-x:hidden;              /* never side-scroll */
  }
/* --- Visuals pane quality-of-life --- */
.cl-preview{
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
}

/* Keep the Preview/Craft buttons always reachable */
.cl-actions{
  position: sticky;
  bottom: 0;
  padding-top: 10px;
  background: linear-gradient(to top, rgba(15,21,34,.98), rgba(15,21,34,.8) 40%, rgba(15,21,34,0));
  backdrop-filter: blur(2px);
}

/* The preview box won't grow taller than half the screen; it can scroll internally if needed */
#svgPreview{
  min-height: 220px;
  max-height: 50vh;
  overflow: auto;
}
  /* Sub-tabs shown on phones to flip between panes */
  .cl-subtabs{ display:none; }
  @media (max-width: 680px){
    .cl-body{ grid-template-columns: 1fr; }

    .cl-subtabs{
      display:flex;
      gap:8px;
      padding:8px 14px;
      border-bottom:1px solid #2a3550;
      background:#0f1624;
    }
    .cl-subtabs button{
      border:1px solid #2a3550;
      background:#0f1522;
      color:#cfe0ff;
      border-radius:10px;
      padding:8px 12px;
    }
    .cl-subtabs button.on{ background:#1f2a3f; }

    /* show only one pane at a time on phones */
    .cl-body.setup  .cl-preview{ display:none; }
    .cl-body.visuals .cl-form{   display:none; }
  }

  /* small form niceties */
  .cl-form .row,
  .cl-form .field{ margin-bottom:10px; }
  .cl-form input[type="text"]{ width:100%; }
  .cl-form .feature-list{ display:grid; grid-template-columns:1fr; row-gap:8px; }
  @media (min-width:560px){
    .cl-form .feature-list{ grid-template-columns: repeat(2, 1fr); }
  }

  /* generic fallbacks (safe if classnames change later) */
  #craftingRoot > * { min-width:0; }
  #craftingRoot .pane,
  #craftingRoot .panel,
  #craftingRoot .col {
    min-width:0;
    overflow-y:auto;
    overflow-x:hidden;
  }
</style>
  <style>
  /* Raise all modals above any floating UI (bells, friends, full, auth dock, etc.) */
  .modal{ z-index:10050; }
  #craftingModal{ z-index:10060; } /* highest of the bunch */
  #craftingModal .backdrop{ z-index:0; }
  #craftingModal .card{ z-index:1; }

  /* While Crafting is open, disable clicks to the game UI and dim it a bit */
  body.crafting-open .wrap,
  body.crafting-open .mini,
  body.crafting-open .controls,
  body.crafting-open .stick,
  body.crafting-open #authDock,
  body.crafting-open #btnCraft {
    pointer-events:none !important;
    filter:saturate(.6) opacity(.7);
  }

  /* Ensure the crafting modal still receives interactions */
  body.crafting-open #craftingModal,
  body.crafting-open #craftingModal * {
    pointer-events:auto !important;
    filter:none;
  }

  /* Optional: stop background scroll on iOS while modal is up */
  body.crafting-open { overscroll-behavior:none; touch-action:none; }
</style>
  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="hud">
      <div class="left">
        <div class="pill">IZZA GAME</div>
        <div class="pill">Player: {{ user.username }}</div>
        <div class="pill" id="coinPill">Wallet: 0 IC</div>
      </div>
      <div class="stars" id="stars">
        <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
      </div>
    </div>

    <div id="gameCard">
      <canvas id="game" width="960" height="540" aria-label="IZZA City"></canvas>
      <div id="prompt">Press B to enter</div>
    </div>

    <div id="invPanel"></div>
  </div>

  <div class="mini" id="miniWrap" title="Tap to open world map">
    <canvas id="minimap" width="260" height="170"></canvas>
  </div>

  <div class="stick" id="stick">
    <div class="base"></div>
    <div class="nub" id="nub"></div>
  </div>
  <div class="controls">
    <button class="btn" id="btnA" type="button">A</button>
    <button class="btn" id="btnB" type="button">B</button>
    <button class="btn" id="btnI" type="button" title="Inventory">I</button>
    <button class="btn" id="btnMap" type="button" title="Toggle Minimap">Map</button>
  </div>

  <div class="modal" id="mapModal">…</div>

  <!-- HQ / Enter modal (colorful, engaging, closes cleanly) -->
  <div class="modal" id="enterModal">
    <div class="backdrop"></div>
    <div class="card" style="padding:0;border:0;overflow:hidden">
      <div style="position:relative;background:linear-gradient(135deg,#4f46e5,#8b5cf6 45%,#22c55e 85%);padding:16px 16px 12px">
        <div style="position:absolute;inset:-40px -40px auto auto;opacity:.12;filter:blur(24px);background:radial-gradient(circle at 70% 30%,#ffd23f,transparent 40%),radial-gradient(circle at 20% 70%,#22d3ee,transparent 45%)"></div>
        <h3 style="position:relative;margin:0 0 6px 0;font-size:18px;letter-spacing:.3px;color:#0b0f17;background:#ffd23f;display:inline-block;padding:4px 8px;border-radius:8px;box-shadow:0 2px 0 rgba(0,0,0,.25)">IZZA HQ — Welcome!</h3>
        <div style="position:relative;opacity:.95;line-height:1.45">
          <!-- UPDATED: split headline into two lines, centered BATTLEGROUND with emojis -->
          <div style="font-weight:700;font-size:16px">A real marketplace × online multiplayer</div>
          <div style="font-weight:900;font-size:16px;text-align:center;letter-spacing:.8px;margin-top:2px">⚔️ BATTLEGROUND ⚔️</div>
          <div style="margin-top:6px">
            Trade, fight, and flex. IZZA is growing into a creator economy where <b>players build maps</b>,
            design <b>shop items</b>, and sell them for <b>real Pi coins</b>. Rack up wins, stash loot in your bank, and unleash chaos downtown.
          </div>
        </div>
      </div>

      <div style="padding:14px 16px;background:#0f1624;border-top:1px solid #2a3550">
        <ul style="margin:0 0 10px 18px;line-height:1.5">
          <li><b>Controls:</b> Joystick (mobile) / WASD or Arrows to move. <b>A</b> to attack, <b>B</b> to interact, <b>Map</b> to toggle maps.</li>
          <li><b>Death penalty:</b> you <u>drop all non-banked items</u> and lose <b>⅔ of wallet coins</b>. Everything in your <b>IZZA Bank</b> is safe.</li>
          <li><b>Missions:</b> complete them to score huge rewards and unlock special shop gear for online battles.</li>
        </ul>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="ghost" id="closeEnter" type="button" style="border-color:#8b5cf6;color:#cfe0ff">Let’s Go</button>
        </div>
      </div>
    </div>
  </div>
  <script>
  (function(){
    const modal = document.getElementById('enterModal');
    if (!modal) return;

    function closeEnter(){
      modal.style.display = 'none';
      try { window.IZZA && IZZA.emit && IZZA.emit('enter-closed'); } catch {}
    }
    const backdrop = modal.querySelector('.backdrop');
    backdrop && backdrop.addEventListener('click', closeEnter, { passive:true });

    document.addEventListener('click', function(ev){
      const btn = ev.target && ev.target.closest('#closeEnter');
      if (!btn) return;
      if (modal.style.display === 'none') return;
      ev.stopPropagation(); ev.preventDefault();
      closeEnter();
    }, true);

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && modal.style.display !== 'none') closeEnter();
    }, { passive:true });
  })();
  </script>

  <!-- UPDATED: full shop modal markup -->
<div class="modal" id="shopModal">
  <div class="backdrop"></div>
  <div class="card">
    <h3>Shop</h3>
    <div id="shopList" class="shop-list"></div>
    <div class="shop-note">Tap an item to purchase.</div>
    <div class="row"><button class="ghost" id="shopClose" type="button">Close</button></div>
  </div>
</div>
<script>
(function(){
  const modal = document.getElementById('shopModal');
  if (!modal) return;

  function closeShop(){
    modal.style.display = 'none';
    try { window.IZZA && IZZA.emit && IZZA.emit('shop-closed'); } catch {}
  }

  const backdrop = modal.querySelector('.backdrop');
  backdrop && backdrop.addEventListener('click', closeShop, { passive:true });

  document.addEventListener('click', function(ev){
    const btn = ev.target && ev.target.closest('#shopClose');
    if (!btn) return;
    if (modal.style.display === 'none') return;
    ev.stopPropagation();
    ev.preventDefault();
    closeShop();
  }, true);

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && modal.style.display !== 'none') closeShop();
  }, { passive:true });
})();
</script>

  <!-- Trade Centre confirm -->
<div class="modal" id="tradeModal" style="display:none">
  <div class="backdrop"></div>
  <div class="card" style="border-color:#13b5a3">
    <h3 style="margin-bottom:6px;color:#0fead4">Trade Centre</h3>
    <div class="shop-note" style="opacity:.95">
      Visit the <b>Trade Centre</b>? This is a <b>safe-zone</b>: no attacks, no cops!
      Meet players, open trades, swap items & IZZA Coins.
    </div>
    <div class="row">
      <button class="ghost" id="tradeNo">Not now</button>
      <button class="ghost" id="tradeYes" style="border-color:#13b5a3">Enter</button>
    </div>
  </div>
</div>
<script>
(function(){
  const modal = document.getElementById('tradeModal');
  if(!modal) return;
  function close(){ modal.style.display='none'; }
  modal.querySelector('.backdrop').addEventListener('click', close, {passive:true});
  document.getElementById('tradeNo').addEventListener('click', close, {passive:true});
  document.getElementById('tradeYes').addEventListener('click', function(ev){
    ev.preventDefault();
    try{ localStorage.setItem('izzaTradeCentre','1'); }catch(_){}
    close();
    // Light reload so safe-zone hooks engage cleanly (no other state touched)
    location.reload();
  }, {passive:false});
})();
</script>
<!-- NEW: Crafting Land modal -->
<div class="modal" id="craftingModal" style="display:none">
  <div class="backdrop"></div>
  <div class="card">
    <div style="padding:12px 14px; border-bottom:1px solid #2a3550; display:flex; align-items:center; gap:8px; background:#0f1624">
      <div style="font-weight:700">🛠️ Crafting Land</div>
      <div style="margin-left:auto; display:flex; gap:8px">
        <button class="ghost" id="craftClose">Close</button>
      </div>
    </div>
    <div id="craftingRoot" data-no-i18n="1">
      <!-- Crafting UI mounts here -->
      <div style="margin:auto; opacity:.8; padding:16px; text-align:center">
        <div style="font-size:16px; margin-bottom:6px">Loading Crafting Land…</div>
        <div style="font-size:12px">Please wait</div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const modal = document.getElementById('craftingModal');
  if(!modal) return;

  function openCraft(){
    document.body.classList.add('crafting-open');
    modal.style.display='flex';
    // lazy-load UI only once
    if (!window.CraftingUI && !document.getElementById('crafting-ui-script')) {
      const s = document.createElement('script');
      s.id = 'crafting-ui-script';
      s.src = '/static/game/js/plugins/crafting/crafting_ui.js';
      s.onload = function(){ try { window.CraftingUI && CraftingUI.mount('#craftingRoot'); } catch(e){} };
      document.head.appendChild(s);
    } else {
      try { window.CraftingUI && CraftingUI.mount('#craftingRoot'); } catch(e){}
    }
  }
  function closeCraft(){
    modal.style.display='none';
    document.body.classList.remove('crafting-open');
    try { window.CraftingUI && CraftingUI.unmount && CraftingUI.unmount('#craftingRoot'); } catch {}
    try { window.IZZA && IZZA.emit && IZZA.emit('crafting-closed'); } catch {}
  }

  // public entrypoint for the game bus
  window.__openCraftingLand = openCraft;

  // close wiring
  const backdrop = modal.querySelector('.backdrop');
  backdrop && backdrop.addEventListener('click', closeCraft, {passive:true});
  document.getElementById('craftClose').addEventListener('click', closeCraft, {passive:true});
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && modal.style.display !== 'none') closeCraft();
  }, { passive:true });
})();
</script>
  <!-- Profile + token -->
  <script>window.__IZZA_PROFILE__ = {{ profile|tojson|safe }};</script>
  <script>window.__IZZA_T__ = {{ t|tojson|safe }};</script>
  <script>window.__PI_SANDBOX__ = {{ (sandbox|tojson) if sandbox is defined else 'false' }};</script>

  <!-- Prefill & keep Coins pill in sync with on-hand wallet -->
  <script>
  (function(){
    function refreshPill(){
      try{
        var el = document.getElementById('coinPill');
        if(!el) return;
        var v = parseInt(localStorage.getItem('izzaCoins') || '0', 10) || 0;
        el.textContent = 'Coins: ' + v + ' IC';
      }catch(_){}
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', refreshPill, { once:true });
    } else {
      refreshPill();
    }
    window.addEventListener('izza-coins-changed', refreshPill);
    window.addEventListener('storage', function(e){
      if (e && e.key === 'izzaCoins') refreshPill();
    });
  })();
  </script>

  <!-- Multiplayer base paths -->
  <script>
    window.__MP_BASE__ = '/izza-game/api/mp';
    window.__MP_WS__   = '/izza-game/api/mp/ws';
  </script>

  <!-- ===== LOAD ORDER ===== -->
  <script src="/static/game/js/izza_core_v3.js?v=12"></script>
  <script src="/static/game/js/plugins/v_chasing.js"></script>
  <script src="/static/game/js/plugins/izza-userkey-and-migration.plugin.js"></script>
  <script src="/static/game/js/plugins/izza-ls-wrapper.plugin.js"></script>
  

  <script src="/static/game/js/plugins/v4_hearts.js?v=1"></script>
  <script src="/static/game/js/plugins/v5_loot.js?v=6"></script>
  <script src="/static/game/js/plugins/v6_ui_exclusive.js?v=1"></script>
  <script src="/static/game/js/plugins/v7_mission2_delivery.js"></script>
  <script src="/static/game/js/plugins/v8_mission3_car_theft.js?v=8.0"></script>
  <script>
(function(){
  function bootExpander(){
    try {
      const m3 = localStorage.getItem('izzaMission3');
      const tier = localStorage.getItem('izzaMapTier');
      if (m3 === 'done' || tier === '2') {
        // dynamically load your expander if not already loaded
        if (!window.__IZZA_EXP_VER__) {
          const s = document.createElement('script');
          s.src = '/static/game/js/plugins/v2_map_expander.js?v=1';
          s.onload = ()=>console.log('[IZZA] Expander booted because mission3 done');
          document.head.appendChild(s);
        }
      }
    } catch(e){ console.warn('expander boot failed', e); }
  }

  // run once core is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bootExpander);
  } else {
    bootExpander();
  }
})();
</script>
  <script src="/static/game/js/plugins/v1_map_expander.js"></script>
  <script src="/static/game/js/plugins/plugin.tier2_border_gates_plus.compat.js?v=1"></script>
  <script src="/static/game/js/plugins/fence_hq_shop.plugin.js"></script>
  <script src="/static/game/js/plugins/day_night_lighting.plugin.js"></script>
<script src="/static/game/js/plugins/seasonal_decals.plugin.js"></script>
  <script src="/static/game/js/plugins/crafting/crafting_ui.js"></script>

  <!-- Hydrate plugins run AFTER map expander -->
  <script src="/static/game/js/plugins/izza-hydrate-core-save.plugin.js"></script>
  <script src="/static/game/js/plugins/izza-hydrate-bank-and-inventory.plugin.js" defer></script>

  <!-- Store + extras -->
  <script src="/static/game/js/plugins/v0_ui_icon_fallbacks.js"></script>
<script src="/static/game/js/plugins/v1_store_items_plugin.js"></script>
  <script src="/static/game/js/plugins/armour_packs_plugin.js?v=1"></script>
  
  

<!-- Mission first: publishes window._izzaIslandLand on ready + update-pre -->
<script src="/static/game/js/plugins/mission4_armoury.js?v=2.1"></script>
  <script src="/static/game/js/plugins/mission5_halloween.plugin.js"></script>
  <script src="/static/game/js/plugins/mission6_neon_treasure.js"></script>

<!-- Boat second: reads _izzaIslandLand during its update-pre -->
<script src="/static/game/js/plugins/v1_boat_plugin.js?v=1.18"></script>
  <script src="/static/game/js/plugins/safety_island_and_rescue.plugin.js?v=1"></script>

<script src="/static/game/js/plugins/v1_free_drive_plugin.js"></script>
  <script src="/static/game/js/plugins/guns.js?v=1.4"></script>

  <script>
  (function(){
    const btn = document.getElementById('btnSave');
    if(!btn) return;

    let busy = false, t = null;

    function setBusy(v){
      busy = v;
      btn.disabled = v;
      btn.style.opacity = v ? .6 : 1;
    }

    async function doSave(){
      if(busy) return;
      setBusy(true);
      const orig = btn.textContent;
      btn.textContent = 'Saving…';
      try{
        const r = await (window.IZZA_PERSIST && IZZA_PERSIST.save());
        if(r && r.ok){
          btn.textContent = '✅ Saved!';
        }else{
          btn.textContent = 'Retry Save';
        }
      }catch(e){
        btn.textContent = 'Error — Retry';
        console.warn('[save] failed', e);
      }finally{
        clearTimeout(t);
        t = setTimeout(()=>{ btn.textContent = orig; setBusy(false); }, 1500);
      }
    }

    btn.addEventListener('click', doSave, {passive:true});
  })();
  </script>

  <!-- Multiplayer -->
  <script defer src="/static/game/js/plugins/v9_multiplayer_building.js"></script>
  <script defer src="/static/game/js/plugins/v1_multiplayer_client.js"></script>
  <script src="/static/game/js/plugins/remote_players_api.js"></script>
  <script src="/static/game/js/plugins/v1_pvp_duel.js"></script>
  <script src="/static/game/js/plugins/v1_trade_centre.plugin.js"></script>
  <script src="/static/game/js/plugins/izza-orientation-landscape.plugin.js?v=3"></script>

    <!-- NEW: Area Chat & translation hook (added, nothing else changed) -->
  <script src="/static/game/js/plugins/v1_area_chat.plugin.js"></script>
  <script>
  window.TRANSLATE_TEXT = async (text, from, to) => {
    try {
      const r = await fetch('/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, from, to })
      });
      const j = r.json ? await r.json() : null;
      return (j && j.ok && typeof j.text === 'string') ? j.text : text;
    } catch {
      return text;
    }
  };
  </script>

  <!-- NEW: Worlds selector (rooms + counts + 1v1 invite) -->
  <script defer src="/static/game/js/plugins/worlds_selector.plugin.js?v=2"></script>
  <script>
  (function(){
    const LANG_KEY='izzaLang';
    const from=(document.documentElement.getAttribute('lang')||'en').slice(0,5);
    const saved=localStorage.getItem(LANG_KEY);
    const to = (saved ? saved : from).slice(0,5);
    const ENABLED = !!saved && to !== from;

    if(typeof window.TRANSLATE_TEXT!=='function'){ window.TRANSLATE_TEXT=async t=>t; }
    const SKIP=new Set(['SCRIPT','STYLE','NOSCRIPT','CODE','PRE','TEXTAREA','INPUT','SELECT','OPTION']);

    function collect(root){
      const nodes=[];
      const w=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,{acceptNode(n){
        const p=n.parentElement; if(!p||SKIP.has(p.tagName)) return NodeFilter.FILTER_REJECT;
        const s=n.nodeValue; if(!s||!s.trim()) return NodeFilter.FILTER_REJECT;
        if(p.closest('[data-no-i18n="1"]')) return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }});
      let n; while((n=w.nextNode())) nodes.push(n);
      return nodes;
    }

    async function translate(nodes){
      if(!ENABLED) return;
      for(const n of nodes){
        try{
          const p=n.parentElement, orig=(p?.dataset?.i18nOriginal)||n.nodeValue;
          const out=(to===from)?orig:await window.TRANSLATE_TEXT(orig,from,to);
          if(p&&p.dataset) p.dataset.i18nOriginal=orig;
          if(typeof out==='string'&&out&&out!==n.nodeValue) n.nodeValue=out;
        }catch{}
      }
    }

    async function run(){ if(!ENABLED) return; await translate(collect(document.body)); }

    const mo=new MutationObserver(muts=>{
      if(!ENABLED) return;
      const batch=[];
      for(const m of muts){
        if(m.type==='childList'){
          m.addedNodes&&m.addedNodes.forEach(nd=>{
            if(nd.nodeType===1) batch.push(...collect(nd));
            else if(nd.nodeType===3) batch.push(nd);
          });
        } else if(m.type==='characterData'&&m.target&&m.target.nodeType===3){
          batch.push(m.target);
        }
      }
      if(batch.length) translate(batch);
    });

    function arm(){ if(!ENABLED) return; try{ mo.observe(document.body,{childList:true,characterData:true,subtree:true}); }catch{} }

    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded',()=>{ run(); arm(); },{once:true});
    } else {
      run(); arm();
    }
  })();
  </script>
<!-- NEW: Craft button + open wiring -->
<script>
(function(){
  function mountBtn(){
    if (document.getElementById('btnCraft')) return;
    const btn = document.createElement('button');
    btn.id = 'btnCraft';
    btn.type = 'button';
    btn.textContent = 'Craft';
    btn.title = 'Open Crafting Land';
    btn.addEventListener('click', function(){
      // prefer bus if core is up; fall back to direct open
      try { window.IZZA && IZZA.emit && IZZA.emit('izza-open-crafting'); } catch {}
      if (typeof window.__openCraftingLand === 'function') window.__openCraftingLand();
    }, {passive:true});
    document.body.appendChild(btn);
  }

  // mount ASAP (safe both before/after DOMContentLoaded)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mountBtn, { once:true });
  } else {
    mountBtn();
  }

  // listen on the game bus too
  (window.IZZA = window.IZZA || {});
  if (typeof IZZA.on === 'function') {
    IZZA.on('izza-open-crafting', ()=> {
      if (typeof window.__openCraftingLand === 'function') window.__openCraftingLand();
    });
  } else {
    // if bus attaches later, try once more after ready
    document.addEventListener('izza-core-ready', ()=> {
      if (typeof IZZA.on === 'function') {
        IZZA.on('izza-open-crafting', ()=> {
          if (typeof window.__openCraftingLand === 'function') window.__openCraftingLand();
        });
      }
    }, { once:true });
  }
})();
</script>
  <!-- Auth Debug Dock (unchanged) -->
  <div id="authDock">…</div>
  <script>…</script>
</body>
</html>
