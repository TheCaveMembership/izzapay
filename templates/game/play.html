<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>IZZA GAME — Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{ --ui:rgba(255,255,255,.9); --bg0:#0b0f17; --card:#141a23; --line:#263042; }
    html,body{height:100%; margin:0; background:#0b0f17; color:#e8eef7; font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:8px}
    .hud{
      position:sticky; top:0; z-index:6; display:flex; align-items:center; justify-content:space-between;
      background:rgba(10,12,18,.75); backdrop-filter:blur(8px); padding:8px 10px; border-bottom:1px solid var(--line)
    }
    .hud .left{display:flex;gap:12px;align-items:center}
    .hud .pill{background:#1b2433; border:1px solid var(--line); padding:6px 10px; border-radius:10px; font-size:13px}
    .hud .stars{display:flex; gap:4px}
    .star{width:16px; height:16px; border:1px solid #445; border-radius:3px; background:#111}
    .star.on{background:#ffd23f; border-color:#c59b00}
    #gameCard{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:10px; margin-top:10px}
    canvas{display:block; width:100%; height:auto; border-radius:12px; background:#000}
    .controls{
      position:fixed; right:12px; bottom:14px; z-index:7; display:flex; gap:8px; align-items:center
    }
    .btn{
      background:#162134; color:#cfe0ff; border:1px solid #2a3550; border-radius:10px; padding:10px 12px;
      font-size:14px; user-select:none; -webkit-user-select:none;
    }
    .stick{ position:fixed; left:12px; bottom:12px; width:120px; height:120px; z-index:7; touch-action:none }
    .stick .base{
      position:absolute; left:0; top:0; width:100%; height:100%; border-radius:60px; background:rgba(255,255,255,.07); border:1px solid #2a3550
    }
    .stick .nub{
      position:absolute; left:40px; top:40px; width:40px; height:40px; border-radius:20px; background:#1f2a3f; border:1px solid #2a3550
    }
    @media (min-width:820px){ .stick{ display:none; } }

    /* Simple modal for “enter building” */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10; }
    .modal.on{ display:flex; }
    .modal .scrim{ position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(2px); }
    .modal .sheet{
      position:relative; background:#141a23; border:1px solid var(--line); border-radius:14px; padding:16px; width:min(560px,92vw);
      color:#e8eef7; box-shadow:0 6px 30px rgba(0,0,0,.45);
    }
    .modal .title{font-weight:700; margin:0 0 8px;}
    .modal .row{margin:8px 0;}
    .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .modal .btn{padding:8px 12px}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="hud">
      <div class="left">
        <div class="pill">IZZA GAME</div>
        <div class="pill">Player: {{ user.username }}</div>
      </div>
      <div class="stars" id="stars">
        <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
      </div>
    </div>

    <div id="gameCard">
      <canvas id="game" width="960" height="540" aria-label="IZZA City"></canvas>
    </div>
  </div>

  <!-- Virtual joystick + quick buttons for mobile -->
  <div class="stick" id="stick">
    <div class="base"></div>
    <div class="nub" id="nub"></div>
  </div>
  <div class="controls">
    <button class="btn" id="btnA">A</button>
    <button class="btn" id="btnB">B</button>
  </div>

  <!-- Enter-building modal -->
  <div class="modal" id="enterModal" aria-hidden="true">
    <div class="scrim"></div>
    <div class="sheet">
      <h3 class="title">Welcome to IZZA HQ</h3>
      <p class="row">NPC: “CamMac, we’ve been expecting you. Do the first job, and we’ll unlock more of IZZA City. You’ll get enough Pi to buy your first ride.”</p>
      <div class="actions">
        <button class="btn" id="mClose">Close</button>
        <button class="btn" id="mAccept">Accept Mission</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const profile = {{ profile|tojson|safe }};
    const BODY   = profile.sprite_skin || "default";
    const HAIR   = profile.hair || "short";
    const OUTFIT = profile.outfit || "street";

    // --------- Canvas & Viewport ----------
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');

    // Base tile is still 32×32; render scale slightly zoomed out from before
    const TILE = 32;
    const SCALE = 3.25;              // was 4; shows more world
    const DRAW  = TILE * SCALE;

    // --------- Asset Loader ----------
    function loadImg(src){
      return new Promise((res, rej)=>{
        const i = new Image();
        i.onload = ()=>res(i);
        i.onerror = rej;
        i.src = src;
      });
    }
    const assetRoot = "/static/game/sprites";
    const assets = {
      body:   `${assetRoot}/body/${BODY}.png`,
      hair:   `${assetRoot}/hair/${HAIR}.png`,
      outfit: `${assetRoot}/outfit/${OUTFIT}.png`,
    };

    // --------- World layout ----------
    // Types:
    // 0 = grass (walkable)
    // 1 = road_v (vertical)  — walkable
    // 2 = road_h (horizontal) — walkable
    // 3 = sidewalk            — walkable
    // 4 = building            — solid
    // 5 = door                — walkable + “B” to enter
    const W = 120, H = 90;
    const world = new Array(H).fill(0).map(()=>new Array(W).fill(0));

    // Fill grass
    for (let y=0;y<H;y++) for(let x=0;x<W;x++) world[y][x] = 0;

    // Main roads (clean, oriented)
    const centerX = Math.floor(W/2), centerY = Math.floor(H/2);
    // Vertical boulevard strip: sidewalks + asphalt with yellow dashes
    for (let y=0;y<H;y++){
      world[y][centerX-2] = 3; // sidewalk
      world[y][centerX-1] = 1; // v road
      world[y][centerX]   = 1; // v road
      world[y][centerX+1] = 1; // v road
      world[y][centerX+2] = 3; // sidewalk
    }
    // Horizontal avenue
    for (let x=0;x<W;x++){
      world[centerY-2][x] = 3;
      world[centerY-1][x] = 2;
      world[centerY][x]   = 2;
      world[centerY+1][x] = 2;
      world[centerY+2][x] = 3;
    }

    // Start district (unlocked rectangle) — bigger than before
    const district = { x: centerX-22, y: centerY-16, w: 44, h: 32 };

    // Everything outside the district is “locked” for gameplay (hard black + collision),
    // but we’ll still show fog/preview on the minimap (not handled here).
    function inDistrict(px,py){
      return (px>=district.x && px<district.x+district.w &&
              py>=district.y && py<district.y+district.h);
    }

    // First building block: IZZA HQ near the center, with a front door on the sidewalk
    const bW=8, bH=6;
    const bx = centerX-12, by = centerY-8; // top-left of building
    for (let y=0;y<bH;y++){
      for (let x=0;x<bW;x++){
        world[by+y][bx+x] = 4; // building (solid)
      }
    }
    // Clear a doorway spot on south face and mark as door
    const doorX = bx + Math.floor(bW/2);
    const doorY = by + bH; // just below the south wall
    world[doorY][doorX] = 5;

    // --------- Player ----------
    const player = {
      x: (centerX)*TILE + 2,
      y: (centerY-5)*TILE + 2, // spawn a bit north of the cross
      vx: 0, vy: 0,
      speed: 2.0 * (TILE/16),
      facing: 'down',
      wanted: 0
    };

    // --------- Input ----------
    const keys = {};
    window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()] = true; if(e.key==='b' || e.key==='B'){handleB();} });
    window.addEventListener('keyup',   e=>{ keys[e.key.toLowerCase()] = false; });

    // Mobile joystick
    const stick = document.getElementById('stick');
    const nub   = document.getElementById('nub');
    let dragging = false, baseRect=null, vec = {x:0,y:0};
    function setNub(dx,dy){
      const r = 40, mag = Math.hypot(dx,dy) || 1, clamped = Math.min(mag, r);
      const ux = dx / mag, uy = dy / mag;
      nub.style.left = (40 + ux*clamped) + 'px';
      nub.style.top  = (40 + uy*clamped) + 'px';
      vec.x = (clamped/r)*ux; vec.y = (clamped/r)*uy;
    }
    function resetNub(){ nub.style.left='40px'; nub.style.top='40px'; vec.x=0; vec.y=0; }
    function startDrag(){ dragging = true; baseRect = stick.getBoundingClientRect(); }
    function moveDrag(e){
      if(!dragging) return;
      const t = e.touches ? e.touches[0] : e;
      const cx = baseRect.left + baseRect.width/2;
      const cy = baseRect.top  + baseRect.height/2;
      setNub(t.clientX - cx, t.clientY - cy);
    }
    function endDrag(){ dragging=false; resetNub(); }
    stick.addEventListener('touchstart', startDrag, {passive:true});
    stick.addEventListener('touchmove',  moveDrag,  {passive:true});
    stick.addEventListener('touchend',   endDrag,   {passive:true});
    stick.addEventListener('mousedown',  startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('mouseup',   endDrag);

    // Buttons
    document.getElementById('btnA').addEventListener('click', ()=> setWanted(player.wanted+1));
    document.getElementById('btnB').addEventListener('click', handleB);

    // Wanted HUD
    function setWanted(n){
      player.wanted = Math.max(0, Math.min(5, n|0));
      const stars = document.querySelectorAll('#stars .star');
      stars.forEach((s,i)=> s.className = 'star' + (i<player.wanted?' on':'' ));
    }

    // --------- Camera ----------
    const camera = { x:0, y:0 };
    function centerCamera(){
      camera.x = player.x - cvs.width/2;
      camera.y = player.y - cvs.height/2;
      // clamp to whole world bounds (not district; district edges render black)
      camera.x = Math.max(0, Math.min(camera.x, W*TILE - cvs.width));
      camera.y = Math.max(0, Math.min(camera.y, H*TILE - cvs.height));
    }

    // --------- Collision helpers ----------
    function sampleTile(px,py){
      const gx = Math.floor(px / TILE), gy = Math.floor(py / TILE);
      if (gx<0||gy<0||gx>=W||gy>=H) return {type:4, gx, gy}; // treat outside as solid
      return {type: world[gy][gx], gx, gy};
    }
    function isSolid(type, gx, gy){
      if (!inDistrict(gx,gy)) return true;      // hard wall outside district (black)
      return type === 4;                         // building blocks
    }

    // --------- Drawing ----------
    function drawGrass(x,y,S){
      ctx.fillStyle = '#0b381d';
      ctx.fillRect(x, y, S, S);
      ctx.fillStyle = 'rgba(255,255,255,.03)';  // faint grid
      ctx.fillRect(x, y, S, 1);
      ctx.fillRect(x, y, 1, S);
    }
    function drawSidewalk(x,y,S){
      ctx.fillStyle = '#757d86';
      ctx.fillRect(x, y, S, S);
      ctx.strokeStyle = 'rgba(0,0,0,.25)';
      ctx.strokeRect(x, y, S, S);
    }
    function drawRoadV(x,y,S){
      ctx.fillStyle = '#2b2b2b';
      ctx.fillRect(x, y, S, S);
      // yellow dashed center line (vertical)
      ctx.strokeStyle = '#ffd23f';
      ctx.lineWidth = Math.max(2, S/16);
      ctx.setLineDash([S/6, S/6]);
      ctx.beginPath();
      ctx.moveTo(x + S/2, y);
      ctx.lineTo(x + S/2, y + S);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    function drawRoadH(x,y,S){
      ctx.fillStyle = '#2b2b2b';
      ctx.fillRect(x, y, S, S);
      // yellow dashed center line (horizontal)
      ctx.strokeStyle = '#ffd23f';
      ctx.lineWidth = Math.max(2, S/16);
      ctx.setLineDash([S/6, S/6]);
      ctx.beginPath();
      ctx.moveTo(x, y + S/2);
      ctx.lineTo(x + S, y + S/2);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    function drawBuilding(x,y,S){
      ctx.fillStyle = '#3c2931'; // deep brick
      ctx.fillRect(x, y, S, S);
      ctx.fillStyle = 'rgba(0,0,0,.2)';
      ctx.fillRect(x, y, S, 6);
    }
    function drawDoor(x,y,S){
      // Small doorway plate
      ctx.fillStyle = '#2c394a';
      ctx.fillRect(x, y, S, S);
      ctx.fillStyle = '#9bd1ff';
      ctx.fillRect(x+S*0.35, y+S*0.2, S*0.3, S*0.6);
    }

    function drawPlayer(images){
      const S = DRAW;
      const sx = Math.floor(player.x - camera.x);
      const sy = Math.floor(player.y - camera.y);
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(images.body,   0,0,TILE,TILE, sx, sy, S, S);
      ctx.drawImage(images.outfit, 0,0,TILE,TILE, sx, sy, S, S);
      ctx.drawImage(images.hair,   0,0,TILE,TILE, sx, sy, S, S);
    }

    // --------- Update ----------
    function update(dt){
      // movement vector
      let dx = 0, dy = 0;
      if (keys['arrowup']||keys['w']) dy -= 1;
      if (keys['arrowdown']||keys['s']) dy += 1;
      if (keys['arrowleft']||keys['a']) dx -= 1;
      if (keys['arrowright']||keys['d']) dx += 1;
      dx += vec.x; dy += vec.y;

      const mag = Math.hypot(dx,dy);
      if (mag > 0){
        dx /= mag; dy /= mag;
        player.vx = dx * player.speed;
        player.vy = dy * player.speed;
      } else {
        player.vx = 0; player.vy = 0;
      }

      // Attempted new position
      let nx = player.x + player.vx * dt;
      let ny = player.y + player.vy * dt;

      // Collide X
      let probe = sampleTile(nx + TILE*0.5, player.y + TILE*0.5);
      if (isSolid(probe.type, probe.gx, probe.gy)) nx = player.x;

      // Collide Y
      probe = sampleTile(player.x + TILE*0.5, ny + TILE*0.5);
      if (isSolid(probe.type, probe.gx, probe.gy)) ny = player.y;

      player.x = nx; player.y = ny;
      centerCamera();
    }

    function render(images){
      const S = DRAW;
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,cvs.width,cvs.height);

      // visible tile range
      const tilesX = Math.ceil(cvs.width / S) + 2;
      const tilesY = Math.ceil(cvs.height / S) + 2;
      const startX = Math.max(0, Math.floor(camera.x / TILE));
      const startY = Math.max(0, Math.floor(camera.y / TILE));

      for (let y=0; y<tilesY; y++){
        for (let x=0; x<tilesX; x++){
          const gx = startX + x;
          const gy = startY + y;
          const sx = (gx*TILE - camera.x) * (S/TILE);
          const sy = (gy*TILE - camera.y) * (S/TILE);

          if (gx<0||gy<0||gx>=W||gy>=H){ continue; }

          // If not in district, draw pure black (hard wall effect in gameplay)
          if (!inDistrict(gx,gy)){ continue; }

          const t = world[gy][gx];
          if (t===0) drawGrass(sx,sy,S);
          else if (t===1) drawRoadV(sx,sy,S);
          else if (t===2) drawRoadH(sx,sy,S);
          else if (t===3) drawSidewalk(sx,sy,S);
          else if (t===4) drawBuilding(sx,sy,S);
          else if (t===5) drawDoor(sx,sy,S);
        }
      }

      drawPlayer(images);

      // Optional: subtle highlight when standing on a door
      const foot = sampleTile(player.x + TILE*0.5, player.y + TILE*0.9);
      if (foot.type === 5){
        ctx.strokeStyle = 'rgba(155,209,255,.9)';
        ctx.lineWidth = 2;
        const hx = (foot.gx*TILE - camera.x) * (S/TILE);
        const hy = (foot.gy*TILE - camera.y) * (S/TILE);
        ctx.strokeRect(hx+2, hy+2, S-4, S-4);
      }
    }

    // --------- Interact: B near door ----------
    const modal = document.getElementById('enterModal');
    const mClose = document.getElementById('mClose');
    const mAccept = document.getElementById('mAccept');
    function openModal(){ modal.classList.add('on'); modal.setAttribute('aria-hidden','false'); }
    function closeModal(){ modal.classList.remove('on'); modal.setAttribute('aria-hidden','true'); }
    mClose.addEventListener('click', closeModal);
    mAccept.addEventListener('click', ()=>{
      closeModal();
      // TODO: mark mission-1 accepted; later we’ll unlock a new region.
      setWanted(1);
    });

    function handleB(){
      const foot = sampleTile(player.x + TILE*0.5, player.y + TILE*0.9);
      if (foot.type === 5 && inDistrict(foot.gx, foot.gy)){
        openModal(); // “enter building”
      }
    }

    // --------- Main Loop ---------
    Promise.all([
      loadImg(assets.body),
      loadImg(assets.outfit),
      loadImg(assets.hair),
    ]).then(([body, outfit, hair])=>{
      const imgs = { body, outfit, hair };
      let last = performance.now();
      function loop(now){
        const dt = Math.min(32, now - last);
        last = now;
        update(dt/16.6667);
        render(imgs);
        requestAnimationFrame(loop);
      }
      centerCamera();
      requestAnimationFrame(loop);
    }).catch(err=>{
      console.error("Sprite load failed", err);
    });
  })();
  </script>
</body>
</html>
