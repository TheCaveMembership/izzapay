<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mini Game Arena — IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{ --tile-bg: var(--card); --tile-line: var(--line); --tile-hover: rgba(255,255,255,.04); }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:14px}
    .muted{color:var(--muted)}
    h1{margin:0 0 6px}
    .lead{margin:6px 0 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px}
    .tile{background:var(--tile-bg);border:1px solid var(--tile-line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;transition:background .15s ease, transform .1s ease;}
    .tile:hover{background:var(--tile-hover); transform:translateY(-1px)}
    .tile .thumb{height:130px; border-radius:8px; border:1px solid var(--tile-line); display:flex;align-items:center;justify-content:center;overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.06)); position:relative;}
    .tile h3{margin:0;font-size:18px}
    .tile p{margin:0;font-size:13px;color:var(--muted)}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:11px;background:var(--chip-bg); white-space:nowrap;}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:var(--chip-bg);cursor:pointer;text-decoration:none;color:inherit}
    .btn:hover{filter:brightness(1.08)}
    .earn{font-size:12px;color:var(--muted)}

    /* top bar cleanup */
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px; margin-top:24px;}
    .topbar .left{display:flex;flex-direction:column;align-items:flex-start;gap:4px; position:relative;}
    .brand-word{height:28px;filter:brightness(1.06) contrast(1.02);}

    .wallet{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .wallet .pill strong{font-weight:700}

    /* phone layout: leave room for the fixed avatar; lift right-side info */
    @media (max-width: 640px){
      /* Spacer under the avatar so the logo sits just beneath the feet */
      .topbar .left{ padding-top:96px; }        /* ~avatar height */
      .brand-word{ margin-top:0; }              /* logo starts right after spacer */

      /* Pull the wallet/info up a bit */
      .wallet{flex-direction:column; align-items:flex-end; margin-top:-10px;}
      .wallet .btn{width:auto;}
    }

    /* avatar cursor */
    .avatar-wrap{position:fixed; left:16px; top:16px; width:96px; height:96px; z-index:9999; pointer-events:none; transform:translate3d(0,0,0);}
    canvas#avatarCursor{width:96px;height:96px;image-rendering:pixelated;image-rendering:crisp-edges}
    .avatar-bounce{animation:bob .9s ease-in-out infinite}
    @keyframes bob{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    .draggable{pointer-events:auto; touch-action:none}
    .net{position:absolute;right:12px;top:12px;width:48px;height:48px;border-radius:6px;border:1px solid var(--line);background:rgba(0,0,0,.15)}
    .road{position:absolute;left:0;right:0;bottom:0;height:36px;background:repeating-linear-gradient(90deg, rgba(255,255,255,.18) 0 10px, transparent 10px 20px)}
    .stars{position:absolute;inset:0;background:
      radial-gradient(circle at 20% 30%, rgba(255,255,255,.35) 1px, transparent 1px) 0 0/40px 40px,
      radial-gradient(circle at 70% 60%, rgba(255,255,255,.25) 1.5px, transparent 1.5px) 0 0/60px 60px}

    @media (pointer:fine){ body{ cursor:none; } a, button{ cursor:none; } }
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="left">
          <img src="/static/izzapay-word.svg" class="brand-word" alt="IZZA wordmark">
          <span class="muted">Mini Game Arena</span>
        </div>
        <div class="wallet">
          <span class="pill">IZZA Coins: <strong id="coins">{{ coins|default(0) }}</strong></span>
          <span class="pill">Craft Credits: <strong id="craft">{{ crafting|default(0) }}</strong></span>
          <a class="btn" id="enterCityBtn" href="/izza-game/play">Enter IZZA City</a>
        </div>
      </div>

      <h1>Pick a game</h1>
      <p class="lead muted">Earn IZZA Coins &amp; Item Crafting Credits by playing mini games. Your character is used as the player avatar.</p>

      <div class="grid" id="gameGrid">
        <div class="tile" data-game="basketball">
          <div class="thumb"><div class="net"></div></div>
          <h3>Street Basketball</h3>
          <p>Time your shots, rack up combos, beat the buzzer.</p>
          <div class="row"><span class="pill">Arcade</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/basketball" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <div class="tile" data-game="racing">
          <div class="thumb"><div class="road"></div></div>
          <h3>Street Race</h3>
          <p>Dodge traffic, hit boosts, and set a new record.</p>
          <div class="row"><span class="pill">Racing</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/race" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <div class="tile" data-game="jetman">
          <div class="thumb"><div class="stars"></div></div>
          <h3>Jetman Rooftops</h3>
          <p>Tap to thrust, weave through neon towers, survive.</p>
          <div class="row"><span class="pill">Endless</span><span class="pill">Skill</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/jetman" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <div class="tile" data-game="puzzle">
          <div class="thumb"></div>
          <h3>Puzzle Dash</h3>
          <p>Chain matches before the timer runs out.</p>
          <div class="row"><span class="pill">Brain</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/puzzle" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <div class="tile" data-game="targets">
          <div class="thumb"></div>
          <h3>Target Range</h3>
          <p>Precision taps, streak multipliers, high scores.</p>
          <div class="row"><span class="pill">Skill</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/targets" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <div class="tile" data-game="runner">
          <div class="thumb"></div>
          <h3>Subway Runner</h3>
          <p>Swipe to dodge, collect tokens, go the distance.</p>
          <div class="row"><span class="pill">Endless</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/runner" class="btn enter-btn">Enter to play</a>
          </div>
        </div>
      </div>

      <p class="muted" style="margin-top:10px;font-size:13px">
        Tip: On desktop, move your mouse — your character follows as the cursor. On mobile, drag your character around the screen.
      </p>
    </div>
  </div>

  <div class="avatar-wrap draggable" id="avatarWrap" aria-hidden="true">
    <canvas id="avatarCursor" width="96" height="96"></canvas>
  </div>

  <script>
  (function(){
    // token helpers
    const T   = new URLSearchParams(location.search).get('t') || '';
    const TQ  = T ? `?t=${encodeURIComponent(T)}` : '';
    const withT = (path) => {
      if (!T) return path;
      const hasQ = path.includes('?');
      return `${path}${hasQ ? '&' : '?'}t=${encodeURIComponent(T)}`;
    };

    async function ensureCharacter(){
      try{
        const r = await fetch('/izza-game/api/character'+TQ, { credentials:'include' });
        if(!r.ok) throw new Error('not-auth');
        const j = await r.json();
        if(j && j.hasCharacter) return j;
      }catch(_){}
      const next = encodeURIComponent(withT('/izza-game/minigames'));
      location.replace('/izza-game/create?next='+next);
      throw new Error('redirecting');
    }

    const SPRITES = {
      body:{ default:"/static/game/sprites/body/default.png", street_a:"/static/game/sprites/body/street_a.png", street_b:"/static/game/sprites/body/street_b.png" },
      hair:{ short:"/static/game/sprites/hair/short.png", buzz:"/static/game/sprites/hair/buzz.png", long:"/static/game/sprites/hair/long.png" },
      outfit:{ street:"/static/game/sprites/outfit/street.png", athletic:"/static/game/sprites/outfit/athletic.png", luxury:"/static/game/sprites/outfit/luxury.png" }
    };

    const SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
    const SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#6A402A","#432818"] };
    const FEMALE_DRESS_BASE=["#7AB6FF","#4E84E3","#2F5CB5"];
    const FEMALE_DRESS_TO={ blue:["#7AB6FF","#4E84E3","#2F5CB5"], red:["#FF7A7A","#E24C4C","#B12F2F"], green:["#7DD68A","#4CB56B","#2F7F47"], purple:["#B796FF","#8C6BE0","#6A49B8"], yellow:["#FFE08A","#E7C45A","#B89433"], pink:["#FFA6D6","#E57CB2","#C45C96"], black:["#3A3A3D","#232326","#0E0E10"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], brown:["#A87854","#7C563A","#593D29"], orange:["#FFB46A","#E4873A","#B65E1F"] };
    const HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], blue:["#7AB6FF","#4E84E3","#2F5CB5"], green:["#7DD68A","#4CB56B","#2F7F47"], pink:["#FFA6D6","#E57CB2","#C45C96"] };

    function loadImg(src){ return new Promise(res=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
    const hexToRgb=h=>{ const n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; };
    const dist2=(a,b)=>{const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;};
    const lum=(r,g,b)=>0.2126*r+0.7152*g+0.0722*b;

    function extractThreeToneRamp(img){
      const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true}); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const d=c.getImageData(0,0,w,h).data, samples=[];
      for(let i=0;i<d.length;i+=4){ if(d[i+3]<10) continue; const r=d[i],g=d[i+1],b=d[i+2]; samples.push({r,g,b,L:lum(r,g,b)}); }
      if(samples.length<10) return ["#C8C8C8","#9C9C9C","#6E6E6E"];
      samples.sort((a,b)=>a.L-b.L);
      const pick=q=>{ const idx=Math.max(0,Math.min(samples.length-1,Math.floor(q*(samples.length-1)))); const s=samples[idx];
        return '#'+s.r.toString(16).padStart(2,'0')+s.g.toString(16).padStart(2,'0')+s.b.toString(16).padStart(2,'0'); };
      return [pick(0.2),pick(0.55),pick(0.85)];
    }

    function paletteSwap(img, fromRampHex, toRampHex, tolerance=2000){
      const from=fromRampHex.map(hexToRgb), to=toRampHex.map(hexToRgb);
      const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true}); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const id=c.getImageData(0,0,w,h), d=id.data; let changed=0;
      for(let i=0;i<d.length;i+=4){
        if(d[i+3]===0) continue;
        const p={r:d[i],g:d[i+1],b:d[i+2]}; let best=-1,score=1e9;
        for(let k=0;k<from.length;k++){ const s=dist2(p,from[k]); if(s<score){score=s;best=k;} }
        if(score<=tolerance){ const t=to[best]||to[1]||to[0]; if(d[i]!==t.r||d[i+1]!==t.g||d[i+2]!==t.b) changed++; d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b; }
      }
      c.putImageData(id,0,0);
      return {canvas:oc, changedPixels:changed};
    }

    function overlayTint(img, hex, strength=1.0){
      const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true}); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const id=c.getImageData(0,0,w,h), d=id.data, t=hexToRgb(hex);
      function ov(a,b){a/=255;b/=255;const o=(a<.5)?(2*a*b):(1-2*(1-a)*(1-b));return Math.round(o*255);}
      for(let i=0;i<d.length;i+=4){ if(d[i+3]===0) continue;
        const r=ov(d[i],t.r), g=ov(d[i+1],t.g), b=ov(d[i+2],t.b);
        d[i]=Math.round(d[i]*(1-strength)+r*strength);
        d[i+1]=Math.round(d[i+1]*(1-strength)+g*strength);
        d[i+2]=Math.round(d[i+2]*(1-strength)+b*strength);
      }
      c.putImageData(id,0,0);
      return oc;
    }

    async function buildAvatarCanvas(dstCtx, size, profile){
      const DW=size,DH=size,X=0,Y=0;
      const type=profile.body_type||'male', tone=profile.skin_tone||'light', theme=profile.sprite_skin||'default';
      const outfitKey=profile.outfit||'street', hairKey=profile.hair||'short', hairCol=profile.hair_color||'black';
      const femaleOut=profile.female_outfit_color||'blue';

      let body=null;
      if(type==='female'){
        const femaleWide=`/static/game/sprites/body/${theme}__female_wide.png`;
        const femaleSlim=`/static/game/sprites/body/${theme}__female.png`;
        body = await loadImg(femaleWide) || await loadImg(femaleSlim);
      }
      if(!body){ body = await loadImg(SPRITES.body[theme]||SPRITES.body.default); }

      const hair = await loadImg(SPRITES.hair[hairKey]||SPRITES.hair.short);
      const outfit = (type==='female') ? null : (await loadImg(SPRITES.outfit[outfitKey]||SPRITES.outfit.street));

      let bodyCanvas;
      if(body){
        const targetSkin=SKIN_TO[tone]||SKIN_TO.light;
        const swapped=paletteSwap(body, SKIN_BASE, targetSkin, 4000);
        bodyCanvas=swapped.canvas;
        if(swapped.changedPixels<8){ bodyCanvas=overlayTint(body, targetSkin[1], 0.98); }
      }

      if(type==='female' && bodyCanvas){
        const targetDress=FEMALE_DRESS_TO[femaleOut]||FEMALE_DRESS_TO.blue;
        const reDress=paletteSwap(bodyCanvas, FEMALE_DRESS_BASE, targetDress, 4000);
        bodyCanvas=reDress.canvas;
        if(reDress.changedPixels<6){ bodyCanvas=overlayTint(bodyCanvas, targetDress[1], 0.85); }
      }

      dstCtx.clearRect(0,0,DW,DH);
      if(bodyCanvas) dstCtx.drawImage(bodyCanvas, X, Y, DW, DH);
      if(outfit) dstCtx.drawImage(outfit, X, Y, DW, DH);
      if(hair){
        const detected=extractThreeToneRamp(hair), target=HAIR_TO[hairCol]||HAIR_TO.black;
        const swap=paletteSwap(hair, detected, target, 4000);
        let hairCanvas=swap.canvas;
        if(swap.changedPixels<8){ hairCanvas=overlayTint(hair, target[1], 1.0); }
        const hairY=(type==='female' && hairKey==='buzz') ? (Y-4) : Y;
        dstCtx.drawImage(hairCanvas, X, hairY, DW, DH);
      }
    }

    const avatarWrap=document.getElementById('avatarWrap');
    const avatarCanvas=document.getElementById('avatarCursor');
    const actx=avatarCanvas.getContext('2d'); actx.imageSmoothingEnabled=false;
    const elCoins=document.getElementById('coins'); const elCraft=document.getElementById('craft');
    let isTouch=window.matchMedia('(pointer:coarse)').matches;
    function setAvatarPos(x,y){ avatarWrap.style.transform=`translate3d(${x}px,${y}px,0)`; }

    function animateAvatarTo(el,cb){
      const r=el.getBoundingClientRect();
      const targetX=r.left + r.width/2 - 48 + window.scrollX;
      const targetY=r.top + r.height/2 - 48 + window.scrollY;
      const start=avatarWrap.getBoundingClientRect();
      const sx=start.left + window.scrollX, sy=start.top + window.scrollY;
      const duration=280, t0=performance.now();
      function tick(t){
        const k=Math.min(1,(t-t0)/duration), e=1-Math.pow(1-k,3);
        const x=sx+(targetX-sx)*e, y=sy+(targetY-sy)*e;
        setAvatarPos(x,y);
        if(k<1) requestAnimationFrame(tick);
        else { avatarWrap.classList.add('avatar-bounce'); setTimeout(()=>{ avatarWrap.classList.remove('avatar-bounce'); cb&&cb(); }, 420); }
      }
      requestAnimationFrame(tick);
    }

    function wirePointer(){
      if(!isTouch){
        document.addEventListener('mousemove',(e)=>{ setAvatarPos(e.clientX-48+window.scrollX, e.clientY-48+window.scrollY); },{passive:true});
      }else{
        avatarWrap.style.pointerEvents='auto';
        let startX=0,startY=0,active=false;
        avatarWrap.addEventListener('pointerdown',(e)=>{ active=true; avatarWrap.setPointerCapture(e.pointerId);
          const rect=avatarWrap.getBoundingClientRect(); startX=e.clientX-rect.left; startY=e.clientY-rect.top; });
        avatarWrap.addEventListener('pointermove',(e)=>{ if(!active) return; setAvatarPos(e.clientX-startX+window.scrollX, e.clientY-startY+window.scrollY); });
        const stop=()=>{ active=false; }; avatarWrap.addEventListener('pointerup',stop); avatarWrap.addEventListener('pointercancel',stop);
      }

      // Ensure all game "enter" links carry t
      document.querySelectorAll('.enter-btn').forEach(a=>{
        a.href = withT(a.getAttribute('href') || '#');
        a.addEventListener('click',(ev)=>{ ev.preventDefault(); const href=a.getAttribute('href'); animateAvatarTo(a,()=>{ location.href=href; }); });
      });

      // Also fix the top "Enter IZZA City" button
      const cityBtn = document.getElementById('enterCityBtn');
      if (cityBtn) cityBtn.href = withT(cityBtn.getAttribute('href') || '/izza-game/play');
    }

    (async function boot(){
      try{
        const profile=await ensureCharacter();  // redirects if missing; preserves t
        try{ localStorage.setItem('izzaCharacter', JSON.stringify(profile)); }catch(_){}
        await buildAvatarCanvas(actx,96,profile);

        if(isTouch) setAvatarPos(16,16); else setAvatarPos(window.innerWidth/2-48, window.innerHeight/2-48);

        // fetch wallet with t so session hydrates on first load
        try{
          const r=await fetch('/izza-game/api/wallet'+TQ,{credentials:'include'});
          if(r.ok){ const j=await r.json(); elCoins.textContent=j.coins??'0'; elCraft.textContent=j.crafting??'0'; }
        }catch(_){}

        wirePointer();
      }catch(e){ if(String(e.message)!=='redirecting'){ console.error('Arena init error',e); } }
    })();
  })();
  </script>
</body>
</html>
