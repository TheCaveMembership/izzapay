<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mini Game Arena ‚Äî IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script>window.IZZA_PERSIST_BASE = 'https://izzagame.onrender.com';</script>
  <!-- Ensure username is known before izza-persist.js loads -->
<script>
  (function(){
    try{
      const params = new URLSearchParams(location.search);
      let u = (params.get('u') || '').toString().trim();
      if (!u) u = (localStorage.getItem('izzaUserU') || '').toString().trim();
      if (!u) {
        const raw = localStorage.getItem('piAuthUser');
        if (raw) { try { u = (JSON.parse(raw)||{}).username || ''; } catch(_){} }
      }
      if (u) {
        u = u.replace(/^@+/, '').toLowerCase();
        window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
        window.izzaUserKey = { get: () => u };
        try { localStorage.setItem('izzaUserU', u); } catch(_){}
        try {
          if (!localStorage.getItem('piAuthUser')) {
            localStorage.setItem('piAuthUser', JSON.stringify({ username: u }));
          }
        } catch(_){}
      }
    }catch(_){}
  })();
</script>
<script src="/static/game/js/izza-persist.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{ --tile-bg: var(--card); --tile-line: var(--line); --tile-hover: rgba(255,255,255,.04); }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:14px}
    .muted{color:var(--muted)}
    h1{margin:0 0 6px}
    .lead{margin:6px 0 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px}
    .tile{background:var(--tile-bg);border:1px solid var(--tile-line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;transition:background .15s ease, transform .1s ease;}
    .tile:hover{background:var(--tile-hover); transform:translateY(-1px)}
    .tile .thumb{height:130px; border-radius:8px; border:1px solid var(--tile-line); display:flex;align-items:center;justify-content:center;overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.06)); position:relative;}
    /* ensure added thumbnails fill nicely */
    .tile .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .tile h3{margin:0;font-size:18px}
    .tile p{margin:0;font-size:13px;color:var(--muted)}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:11px;background:var(--chip-bg); white-space:nowrap;}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:var(--chip-bg);cursor:pointer;text-decoration:none;color:inherit; white-space:nowrap;}
    .btn:hover{filter:brightness(1.08)}
    .earn{font-size:12px;color:var(--muted)}

    /* top bar */
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px; margin-top:24px;}
    .topbar .left{display:flex;flex-direction:column;align-items:flex-start;gap:4px; position:relative;}
    .brand-word{height:40px;filter:brightness(1.06) contrast(1.02);}

    .wallet{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .wallet .pill strong{font-weight:700}

    /* phone layout */
    @media (max-width: 640px){
      .topbar .left{ padding-top:96px; }
      .wallet{flex-direction:column; align-items:flex-end; margin-top:-10px;}
    }

    /* avatar cursor */
    .avatar-wrap{position:fixed; left:16px; top:16px; width:96px; height:96px; z-index:9999; pointer-events:none; transform:translate3d(0,0,0);}
    canvas#avatarCursor{width:96px;height:96px;image-rendering:pixelated;image-rendering:crisp-edges}
    .avatar-bounce{animation:bob .9s ease-in-out infinite}
    @keyframes bob{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    .draggable{pointer-events:auto; touch-action:none}
    .net{position:absolute;right:12px;top:12px;width:48px;height:48px;border-radius:6px;border:1px solid(var(--line));background:rgba(0,0,0,.15)}
    .road{position:absolute;left:0;right:0;bottom:0;height:36px;background:repeating-linear-gradient(90deg, rgba(255,255,255,.18) 0 10px, transparent 10px 20px)}
    .stars{position:absolute;inset:0;background:
      radial-gradient(circle at 20% 30%, rgba(255,255,255,.35) 1px, transparent 1px) 0 0/40px 40px,
      radial-gradient(circle at 70% 60%, rgba(255,255,255,.25) 1.5px, transparent 1.5px) 0 0/60px 60px}

    @media (pointer:fine){ body{ cursor:none; } a, button{ cursor:none; } }

    /* FIRST-PAINT gating */
    .val[data-loading="1"]{ opacity:.35 }

    /* Hidden iframe for silent priming */
    #izzaPrimeFrame{ position:fixed; width:0; height:0; opacity:0; pointer-events:none; inset:auto auto 0 0; border:0 }

    /* ===== Leaderboard modal styles (added) ===== */
    .lb-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:9999;align-items:flex-end}
    .lb-modal.show{display:flex}
    .lb-sheet{width:100%;max-width:1100px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:14px 14px 0 0;padding:12px 12px 16px}
    .lb-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .lb-close{line-height:1;padding:6px 10px}
    .lb-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .lb-label{font-size:12px;color:var(--muted)}
    .lb-select{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:var(--chip-bg);color:inherit}
    .lb-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .lb-tab{border:1px solid var(--line);background:var(--chip-bg);padding:6px 10px;border-radius:999px;cursor:pointer}
    .lb-tab.is-active{outline:2px solid rgba(255,255,255,.1)}
    .lb-body{margin-top:8px}
    .lb-table{width:100%;border-collapse:collapse}
    .lb-table th,.lb-table td{padding:8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    .lb-table th{font-size:12px;color:var(--muted);font-weight:600}
    .lb-row-me{background:rgba(255,255,255,.03)}
    .lb-empty{border:1px dashed var(--line);border-radius:8px;padding:12px;text-align:center}
    .lb-extra{margin-top:12px;padding-top:8px;border-top:1px solid var(--line)}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="left">
          <img src="/static/izzapay-word.svg" id="brandWord" class="brand-word" alt="IZZA wordmark">
          <span class="muted">ARCADE</span>
        </div>
        <div class="wallet">
          <span class="pill">IZZA Coins: <strong id="coins" class="val" data-loading="1">{{ coins|default(0) }}</strong></span>
          <span class="pill">Craft Credits: <strong id="craft" class="val" data-loading="1">{{ crafting|default(0) }}</strong></span>
          <a class="btn" id="enterCityBtn" href="/izza-game/play">Enter IZZA City</a>
        </div>
      </div>

      <h1>Pick a game</h1>
      <p class="lead muted">Earn IZZA Coins &amp; Item Crafting Credits by playing mini games. Your character is used as the player avatar.</p>

      <!-- Leaderboard open button (moved to top of list) -->
      <div class="row" style="justify-content:flex-end;margin:8px 0 4px">
        <button id="openLbBtn" class="btn">üèÜ IZZA Leaderboard</button>
      </div>

      <div class="grid" id="gameGrid">
        <!-- 1) Jetman first, renamed -->
        <div class="tile" data-game="jetman">
          <div class="thumb"><img src="/static/game/thumbs/jetman.jpg" alt="IZZA JET-MON"></div>
          <h3>IZZA JET-MON</h3>
          <p>Tap to thrust, weave through neon towers, survive.</p>
          <div class="row"><span class="pill">Endless</span><span class="pill">Skill</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/jetman" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <!-- 2) Basketball second, renamed -->
        <div class="tile" data-game="basketball">
          <div class="thumb"><img src="/static/game/thumbs/basketball.jpg" alt="IZZA BASKETBALL"></div>
          <h3>IZZA BASKETBALL</h3>
          <p>Time your shots, rack up combos, beat the buzzer.</p>
          <div class="row"><span class="pill">Arcade</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/basketball" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <!-- 3) Racing third, renamed -->
        <div class="tile" data-game="racing">
          <div class="thumb"><img src="/static/game/thumbs/racing.jpg" alt="IZZA DRIVER"></div>
          <h3>IZZA DRIVER</h3>
          <p>Dodge traffic, hit boosts, and set a new record.</p>
          <div class="row"><span class="pill">Racing</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/race" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <!-- Remaining games unchanged (now with thumbnails) -->
        <div class="tile" data-game="puzzle">
          <div class="thumb"><img src="/static/game/thumbs/puzzle.jpg" alt="Puzzle Dash"></div>
          <h3>Puzzle Dash</h3>
          <p>Chain matches before the timer runs out.</p>
          <div class="row"><span class="pill">Brain</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/puzzle" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <div class="tile" data-game="targets">
          <div class="thumb"><img src="/static/game/thumbs/targets.jpg" alt="Target Range"></div>
          <h3>Target Range</h3>
          <p>Precision taps, streak multipliers, high scores.</p>
          <div class="row"><span class="pill">Skill</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/targets" class="btn enter-btn">Enter to play</a>
          </div>
        </div>

        <div class="tile" data-game="runner">
          <div class="thumb"><img src="/static/game/thumbs/runner.jpg" alt="Subway Runner"></div>
          <h3>Subway Runner</h3>
          <p>Swipe to dodge, collect tokens, go the distance.</p>
          <div class="row"><span class="pill">Endless</span><span class="pill">Solo</span></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <span class="earn">* Earn Coins + Credits</span>
            <a href="/izza-game/minigames/runner" class="btn enter-btn">Enter to play</a>
          </div>
        </div>
      </div>

      <p class="muted" style="margin-top:10px;font-size:13px">
        Tip: On desktop, move your mouse ‚Äî your character follows as the cursor. On mobile, drag your character around the screen.
      </p>
    </div>
  </div>

  <div class="avatar-wrap draggable" id="avatarWrap" aria-hidden="true">
    <canvas id="avatarCursor" width="96" height="96"></canvas>
  </div>

  <!-- Leaderboard modal (added) -->
  <div id="lbModal" class="lb-modal" aria-hidden="true">
    <div class="lb-sheet" role="dialog" aria-modal="true" aria-label="IZZA Leaderboard">
      <div class="lb-head">
        <h3 style="margin:0">IZZA Leaderboard</h3>
        <button class="btn lb-close" id="lbCloseBtn" type="button">‚úï</button>
      </div>

      <div class="lb-controls">
        <label class="lb-label">Game</label>
        <select id="lbGameSel" class="lb-select">
          <option value="basketball">IZZA BASKETBALL</option>
          <option value="racing">IZZA DRIVER</option>
          <option value="jetman">IZZA JET-MON</option>
          <option value="puzzle">Puzzle Dash</option>
          <option value="targets">Target Range</option>
          <option value="runner">Subway Runner</option>
        </select>

        <div class="lb-tabs" id="lbTabs">
          <button data-period="day" class="lb-tab is-active" type="button">Daily</button>
          <button data-period="month" class="lb-tab" type="button">Monthly</button>
          <button data-period="year" class="lb-tab" type="button">Annual</button>
          <button data-period="alltime" class="lb-tab" type="button">All-Time</button>
        </div>
      </div>

      <div id="lbBody" class="lb-body">
        <!-- table renders here -->
      </div>

      <div class="lb-extra">
  <h4 style="margin:12px 0 6px">IZZA City ‚Äî Longest Police Chase</h4>
  <div id="lbPoliceChase" class="lb-chase">
    <div class="lb-empty muted">No data yet.</div>
  </div>
</div>
    </div>
  </div>

  <script>
  (function(){
    /* --------- token param: save, restore, and attach where needed --------- */
    const T_KEY = 'izzaTokenT';
    let T = new URLSearchParams(location.search).get('t') || '';
    try{
      if (T) {
        localStorage.setItem(T_KEY, T);
      } else {
        const saved = localStorage.getItem(T_KEY) || '';
        if (saved) {
          const url = new URL(location.href);
          url.searchParams.set('t', saved);
          history.replaceState(null, '', url.toString());
          T = saved;
        }
      }
    }catch(_){}

    function withAuth(path){
      const url = new URL(path, location.origin);
      if (T) url.searchParams.set('t', T);
      if (U) url.searchParams.set('u', U);
      return url.pathname + (url.search ? url.search : '');
    }

    // Username param (u): save/restore and publish to Persist hooks
    const U_KEY = 'izzaUserU';
    let U = new URLSearchParams(location.search).get('u') || '';
    try{
      if (U) {
        U = U.replace(/^@+/, '').toLowerCase();
        localStorage.setItem(U_KEY, U);
      } else {
        const savedU = (localStorage.getItem(U_KEY) || '').toString().trim();
        if (savedU) {
          const url = new URL(location.href);
          url.searchParams.set('u', savedU);
          history.replaceState(null, '', url.toString());
          U = savedU;
        }
      }
      if (U) {
        window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: U });
        window.izzaUserKey = { get: () => U };
      }
    }catch(_){}

    /* --- headers helper --- */
    function bearerHeaders(base = {}) {
      const headers = Object.assign({ 'content-type':'application/json' }, base || {});
      try{
        const bearer = localStorage.getItem('izzaBearer') || '';
        if (bearer) headers['authorization'] = 'Bearer ' + bearer;
      }catch(_){}
      return headers;
    }

    /* --- auth/character (server) --- */
    async function fetchCharacterFresh(){
      try{
        const r = await fetch(withAuth('/izza-game/api/character'), {
          credentials:'include',
          headers: bearerHeaders()
        });
        if(r.ok){
          const j = await r.json();
          return j && typeof j === 'object' ? j : null;
        }
      }catch(_){}
      return null;
    }

    async function ensureCharacter(){
      const lsProfile = (()=>{ try{ return JSON.parse(localStorage.getItem('izzaCharacter')||'null'); }catch(_){ return null; } })();
      const isAdminLocal = (()=> {
        try{
          const role = (localStorage.getItem('izzaRole')||'').toLowerCase();
          const user = (localStorage.getItem('izzaUser')||'').toLowerCase();
          return role === 'admin' || user === 'cammac';
        }catch(_){ return false; }
      })();

      const fresh = await fetchCharacterFresh();
      if (fresh && (fresh.hasCharacter || fresh.isAdmin || (fresh.user && fresh.user.isAdmin))) return fresh;

      if (isAdminLocal) {
        const fallback = lsProfile && typeof lsProfile === 'object'
          ? lsProfile
          : { hasCharacter:true, body_type:'male', skin_tone:'light', sprite_skin:'default' };
        return Object.assign({ hasCharacter:true }, fallback, { isAdmin:true });
      }

      // Truly first-time ever: go make a character (not silent)
      const next = encodeURIComponent(withAuth('/izza-game/minigames'));
      location.replace('/izza-game/create?next=' + next);
      throw new Error('redirecting');
    }

    /* --- avatar assets (unchanged) --- */
    const SPRITES = {
      body:{ default:"/static/game/sprites/body/default.png", street_a:"/static/game/sprites/body/street_a.png", street_b:"/static/game/sprites/body/street_b.png" },
      hair:{ short:"/static/game/sprites/hair/short.png", buzz:"/static/game/sprites/hair/buzz.png", long:"/static/game/sprites/hair/long.png" },
      outfit:{ street:"/static/game/sprites/outfit/street.png", athletic:"/static/game/sprites/outfit/athletic.png", luxury:"/static/game/sprites/outfit/luxury.png" }
    };
    const SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
    const SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#432818"] };
    const FEMALE_DRESS_BASE=["#7AB6FF","#4E84E3","#2F5CB5"];
    const FEMALE_DRESS_TO={ blue:["#7AB6FF","#4E84E3","#2F5CB5"], red:["#FF7A7A","#E24C4C","#B12F2F"], green:["#7DD68A","#4CB56B","#2F7F47"], purple:["#B796FF","#8C6BE0","#6A49B8"], yellow:["#FFE08A","#E7C45A","#B89433"], pink:["#FFA6D6","#E57CB2","#C45C96"], black:["#3A3AD3","#232326","#0E0E10"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], brown:["#A87854","#7C563A","#593D29"], orange:["#FFB46A","#E4873A","#B65E1F"] };
    const HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], blue:["#7AB6FF","#4E84E3","#2F5CB5"], green:["#7DD68A","#4CB56B","#2F7F47"], pink:["#FFA6D6","#E57CB2","#C45C96"] };

    function loadImg(src){ return new Promise(res=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
    const hexToRgb=h=>{ const n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; };
    const dist2=(a,b)=>{const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;};
    const lum=(r,g,b)=>0.2126*r+0.7152*g+0.0722*b;

    function extractThreeToneRamp(img){
      const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true}); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const d=c.getImageData(0,0,w,h).data, samples=[];
      for(let i=0;i<d.length;i+=4){ if(d[i+3]<10) continue; const r=d[i],g=d[i+1],b=d[i+2]; samples.push({r,g,b,L:lum(r,g,b)}); }
      if(samples.length<10) return ["#C8C8C8","#9C9C9C","#6E6E6E"];
      samples.sort((a,b)=>a.L-b.L);
      const pick=q=>{ const idx=Math.max(0,Math.min(samples.length-1,Math.floor(q*(samples.length-1)))); const s=samples[idx];
        return '#'+s.r.toString(16).padStart(2,'0')+s.g.toString(16).padStart(2,'0')+s.b.toString(16).padStart(2,'0'); };
      return [pick(0.2),pick(0.55),pick(0.85)];
    }

    function paletteSwap(img, fromRampHex, toRampHex, tolerance=2000){
      const from=fromRampHex.map(hexToRgb), to=toRampHex.map(hexToRgb);
      const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true}); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const id=c.getImageData(0,0,w,h), d=id.data; let changed=0;
      for(let i=0;i<d.length;i+=4){
        if(d[i+3]===0) continue;
        const p={r:d[i],g:d[i+1],b:d[i+2]}; let best=-1,score=1e9;
        for(let k=0;k<from.length;k++){ const s=dist2(p,from[k]); if(s<score){score=s;best=k;} }
        if(score<=tolerance){ const t=to[best]||to[1]||to[0]; if(d[i]!==t.r||d[i+1]!==t.g||d[i+2]!==t.b) changed++; d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b; }
      }
      c.putImageData(id,0,0);
      return {canvas:oc, changedPixels:changed};
    }

    function overlayTint(img, hex, strength=1.0){
      const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true}); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const id=c.getImageData(0,0,w,h), d=id.data, t=hexToRgb(hex);
      function ov(a,b){a/=255;b/=255;const o=(a<.5)?(2*a*b):(1-2*(1-a)*(1-b));return Math.round(o*255);}
      for(let i=0;i<d.length;i+=4){ if(d[i+3]===0) continue;
        const r=ov(d[i],t.r), g=ov(d[i+1],t.g), b=ov(d[i+2],t.b);
        d[i]=Math.round(d[i]*(1-strength)+r*strength);
        d[i+1]=Math.round(d[i+1]*(1-strength)+g*strength);
        d[i+2]=Math.round(d[i+2]*(1-strength)+b*strength);
      }
      c.putImageData(id,0,0);
      return oc;
    }

    async function buildAvatarCanvas(dstCtx, size, profile){
      const DW=size,DH=size,X=0,Y=0;
      const type=profile.body_type||'male', tone=profile.skin_tone||'light', theme=profile.sprite_skin||'default';
      const outfitKey=profile.outfit||'street', hairKey=profile.hair||'short', hairCol=profile.hair_color||'black';
      const femaleOut=profile.female_outfit_color||'blue';

      let body=null;
      if(type==='female'){
        const femaleWide=`/static/game/sprites/body/${theme}__female_wide.png`;
        const femaleSlim=`/static/game/sprites/body/${theme}__female.png`;
        body = await loadImg(femaleWide) || await loadImg(femaleSlim);
      }
      if(!body){ body = await loadImg(SPRITES.body[theme]||SPRITES.body.default); }

      const hair = await loadImg(SPRITES.hair[hairKey]||SPRITES.hair.short);
      const outfit = (type==='female') ? null : (await loadImg(SPRITES.outfit[outfitKey]||SPRITES.outfit.street));

      let bodyCanvas;
      if(body){
        const targetSkin=SKIN_TO[tone]||SKIN_TO.light;
        const swapped=paletteSwap(body, SKIN_BASE, targetSkin, 4000);
        bodyCanvas=swapped.canvas;
        if(swapped.changedPixels<8){ bodyCanvas=overlayTint(body, targetSkin[1], 0.98); }
      }

      if(type==='female' && bodyCanvas){
        const targetDress=FEMALE_DRESS_TO[femaleOut]||FEMALE_DRESS_TO.blue;
        const reDress=paletteSwap(bodyCanvas, FEMALE_DRESS_BASE, targetDress, 4000);
        bodyCanvas=reDress.canvas;
        if(reDress.changedPixels<6){ bodyCanvas=overlayTint(bodyCanvas, targetDress[1], 0.85); }
      }

      dstCtx.clearRect(0,0,DW,DH);
      if(bodyCanvas) dstCtx.drawImage(bodyCanvas, X, Y, DW, DH);
      if(outfit) dstCtx.drawImage(outfit, X, Y, DW, DH);
      if(hair){
        const detected=extractThreeToneRamp(hair), target=HAIR_TO[hairCol]||HAIR_TO.black;
        const swap=paletteSwap(hair, detected, target, 4000);
        let hairCanvas=swap.canvas;
        if(swap.changedPixels<8){ hairCanvas=overlayTint(hairCanvas, target[1], 1.0); }
        const hairY=(type==='female' && hairKey==='buzz') ? (Y-4) : Y;
        dstCtx.drawImage(hairCanvas, X, hairY, DW, DH);
      }
    }

    // Baseline authoring size for the boxes below
const ARENA_BASE_SIZE = 96;

function _arenaScaleBox(box, k){
  return {
    w:  Math.round((box.w  ||0) * k),
    h:  Math.round((box.h  ||0) * k),
    ox: Math.round((box.ox ||0) * k),
    oy: Math.round((box.oy ||0) * k),
    scale: box.scale
  };
}
// ======== EQUIPPED GEAR OVERLAY for 96√ó96 avatar cursor ========

// Read the same inventory City uses
function _arenaInvRead(){
  try{
    const iz = (window.IZZA && IZZA.api && IZZA.api.getInventory && IZZA.api.getInventory()) || null;
    if (iz) return JSON.parse(JSON.stringify(iz));
  }catch(_){}
  try{ return JSON.parse(localStorage.getItem('izzaInventory')||'{}'); }catch(_){ return {}; }
}

// Is item equipped?
function _arenaIsEquipped(entry){
  if(!entry) return false;
  if (entry.equipped === true || entry.equip === true) return true;
  if (typeof entry.equippedCount === 'number' && entry.equippedCount > 0) return true;
  return false;
}

// Find equipped item by slot
function _arenaEquippedIn(slot){
  const inv = _arenaInvRead();
  for (const k in inv){
    const it = inv[k];
    if (!it) continue;
    if ((it.slot||'').toLowerCase() === slot && _arenaIsEquipped(it)){
      // prefer overlaySvg (world art), fall back to iconSvg
      const svg = (it.overlaySvg && String(it.overlaySvg).trim()) || (it.iconSvg && String(it.iconSvg).trim()) || '';
      return { key:k, it, svg };
    }
  }
  return null;
}

// Simple SVG -> <img> cache so overlays pop instantly once decoded
const _arenaSvgImgCache = new Map();
function _arenaSvgToImage(svg){
  if (!svg) return null;
  if (_arenaSvgImgCache.has(svg)) return _arenaSvgImgCache.get(svg);
  const img = new Image();
  img.decoding = 'async';
  img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  _arenaSvgImgCache.set(svg, img);
  return img;
}

// Default overlay box sizes for the cursor canvas (px)
// Match City‚Äôs authoring targets
const ARENA_OVERLAY_BOX = Object.freeze({
  head:  { w: 38, h: 38, ox: 48, oy: 24, scale: 1.00 },
  chest: { w: 40, h: 40, ox: 48, oy: 46, scale: 1.00 },
  arms:  { w: 38, h: 38, ox: 48, oy: 46, scale: 1.00 },
  legs:  { w: 40, h: 40, ox: 48, oy: 64, scale: 1.00 },
  hands: { w: 36, h: 36, ox: 63, oy: 54, scale: 1.00 } // same as City default
});

// Crafted multipliers ‚Äî keep 1:1 like City
const CRAFTED_ARMOUR_SHRINK = 1.00;
const CRAFTED_WEAPON_BOOST  = 1.00;

// (optional safety) clamp per-item overlayScale so bad data can‚Äôt miniaturize items
function _clampScale(x, lo=0.8, hi=1.25){
  x = Number(x);
  return Number.isFinite(x) ? Math.min(hi, Math.max(lo, x)) : 1;
}
// Draw a single overlay image on the 96√ó96 canvas
function _arenaDrawOverlay(ctx, svg, box, perItemScale=1, flipX=false){
  if (!svg) return false;
  const img = _arenaSvgToImage(svg);
  if (!img || !img.complete) return false;

  const w = Math.max(8, box.w|0);
  const h = Math.max(8, box.h|0);

  ctx.save();
  ctx.imageSmoothingEnabled = false;
  ctx.translate(box.ox|0, box.oy|0);
  if (flipX) ctx.scale(-1, 1);
  const s = (box.scale || 1) * perItemScale;
  if (s !== 1) ctx.scale(s, s);
  try { ctx.drawImage(img, -w/2, -h/2, w, h); } catch(_){}
  ctx.restore();
  return true;
}

// Optional: nudge weapon position based on facing (if you store it)
function _arenaWeaponFacingBox(base){
  // You can make this smarter. For now, bias to the right (like facing "right")
  return base;
}

// Main: build avatar + gear in one go (uses your existing base painter)
async function buildAvatarCanvasWithGear(dstCtx, size, profile){
  await buildAvatarCanvas(dstCtx, size, profile);

  const k = (size > 0 ? size / ARENA_BASE_SIZE : 1); // <- scale factor

  const head  = _arenaEquippedIn('head');
  const chest = _arenaEquippedIn('chest');
  const arms  = _arenaEquippedIn('arms');
  const legs  = _arenaEquippedIn('legs');
  const hands = _arenaEquippedIn('hands');

  if (legs){
    const bx = _arenaScaleBox(ARENA_OVERLAY_BOX.legs, k);
    const per = Number.isFinite(legs.it?.overlayScale) ? (+legs.it.overlayScale) : 1;
    const mul = 1;
    _arenaDrawOverlay(dstCtx, legs.svg, bx, per * mul);
  }
  if (chest){
    const bx = _arenaScaleBox(ARENA_OVERLAY_BOX.chest, k);
    const per = Number.isFinite(chest.it?.overlayScale) ? (+chest.it.overlayScale) : 1;
    const mul = 1;
    _arenaDrawOverlay(dstCtx, chest.svg, bx, per * mul);
  }
  if (arms){
    const bx = _arenaScaleBox(ARENA_OVERLAY_BOX.arms, k);
    const per = Number.isFinite(arms.it?.overlayScale) ? (+arms.it.overlayScale) : 1;
    const mul = 1;
    _arenaDrawOverlay(dstCtx, arms.svg, bx, per * mul);
  }
  if (head){
    const bx = _arenaScaleBox(ARENA_OVERLAY_BOX.head, k);
    const per = Number.isFinite(head.it?.overlayScale) ? (+head.it.overlayScale) : 1;
    const mul = 1;
    _arenaDrawOverlay(dstCtx, head.svg, bx, per * mul);
  }
  if (hands){
    const base = _arenaScaleBox(ARENA_OVERLAY_BOX.hands, k);
    const bx   = _arenaWeaponFacingBox(base);
    const per  = Number.isFinite(hands.it?.overlayScale) ? (+hands.it.overlayScale) : 1;
    const mul = 1;
    _arenaDrawOverlay(dstCtx, hands.svg, bx, per * mul, /*flipX=*/false);
  }
}

// Small helper you can call whenever inventory changes to repaint the cursor
async function refreshArenaCursor(){
  try{
    const c = document.getElementById('avatarCursor');
    if (!c) return;
    const ctx = c.getContext('2d', { willReadFrequently:true });
    const profile = JSON.parse(localStorage.getItem('izzaCharacter')||'{}');
    await buildAvatarCanvasWithGear(ctx, c.width, profile);
  }catch(_){}
}
window.addEventListener('izza-inventory-changed', refreshArenaCursor, { passive:true });
// ==============================================================
    /* ====== UI & motion ====== */
    const avatarWrap=document.getElementById('avatarWrap');
    const avatarCanvas=document.getElementById('avatarCursor');
    const actx=avatarCanvas.getContext('2d'); actx.imageSmoothingEnabled=false;
    const elCoins=document.getElementById('coins'); const elCraft=document.getElementById('craft');
    let isTouch=window.matchMedia('(pointer:coarse)').matches;
    function setAvatarPos(x,y){ avatarWrap.style.transform=`translate3d(${x}px,${y}px,0)`; }

    function animateAvatarTo(el,cb){
      const r=el.getBoundingClientRect();
      const targetX=r.left + r.width/2 - 48 + window.scrollX;
      const targetY=r.top + r.height/2 - 48 + window.scrollY;
      const start=avatarWrap.getBoundingClientRect();
      const sx=start.left + window.scrollX, sy=start.top + window.scrollY;
      const duration=280, t0=performance.now();
      function tick(t){
        const k=Math.min(1,(t-t0)/duration), e=1-Math.pow(1-k,3);
        const x=sx+(targetX-sx)*e, y=sy+(targetY-sy)*e;
        setAvatarPos(x,y);
        if(k<1) requestAnimationFrame(tick);
        else { avatarWrap.classList.add('avatar-bounce'); setTimeout(()=>{ avatarWrap.classList.remove('avatar-bounce'); cb&&cb(); }, 420); }
      }
      requestAnimationFrame(tick);
    }

    function wirePointer(){
      if(!isTouch){
        document.addEventListener('mousemove',(e)=>{ setAvatarPos(e.clientX-48+window.scrollX, e.clientY-48+window.scrollY); },{passive:true});
      }else{
        avatarWrap.style.pointerEvents='auto';
        let startX=0,startY=0,active=false;
        avatarWrap.addEventListener('pointerdown',(e)=>{ active=true; avatarWrap.setPointerCapture(e.pointerId);
          const rect=avatarWrap.getBoundingClientRect(); startX=e.clientX-rect.left; startY=e.clientY-rect.top; });
        avatarWrap.addEventListener('pointermove',(e)=>{ if(!active) return; setAvatarPos(e.clientX-startX+window.scrollX, e.clientY-startY+window.scrollY); });
        const stop=()=>{ active=false; }; avatarWrap.addEventListener('pointerup',stop); avatarWrap.addEventListener('pointercancel',stop);
      }

      // Ensure "enter" links carry t & u (and animate)
      document.querySelectorAll('.enter-btn').forEach(a=>{
        a.href = withAuth(a.getAttribute('href') || '#');
        a.addEventListener('click',(ev)=>{
          ev.preventDefault();
          const href = a.getAttribute('href'); // already rewritten with t & u
          animateAvatarTo(a,()=>{ location.href = href; });
        });
      });

      const cityBtn = document.getElementById('enterCityBtn');
      if (cityBtn) {
        // rewrite the href to include both t & u
        cityBtn.href = withAuth(cityBtn.getAttribute('href') || '/izza-game/play');

        cityBtn.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          const href = cityBtn.getAttribute('href'); // already includes t & u

          try {
            await hydrateFromSnapshot();
            try { writeCraftAll(readCraftAny()); } catch(_) {}
            try {
              const h = parseInt(localStorage.getItem('izzaHearts')||'0',10);
              if (!Number.isFinite(h) || h<=0) {
                localStorage.setItem('izzaHearts','5');
                window.dispatchEvent(new Event('izza-hearts-changed'));
              }
            } catch(_) {}
            if (window.IZZA_PERSIST && typeof IZZA_PERSIST.save === 'function') {
              await IZZA_PERSIST.save();
            } else if (typeof window._izzaForceSave === 'function') {
              window._izzaForceSave();
            }
          } catch(_) {}

          setTimeout(()=>{ location.href = href; }, 120);
        }, {passive:false});
      }
    }

    /* ====== Wallet helpers ====== */
    const CRAFT_KEYS = ['izzaCrafting','craftingCredits','izzaCraftCredits'];
    function readCraftAny(){
      for(const k of CRAFT_KEYS){
        const v = parseInt(localStorage.getItem(k)||'0',10);
        if (Number.isFinite(v) && v>0) return v|0;
      }
      return (parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10) || 0)|0;
    }
    function writeCraftAll(v){
      const n = Math.max(0, v|0);
      for(const k of CRAFT_KEYS) localStorage.setItem(k, String(n));
      try{ window.dispatchEvent(new Event('izza-crafting-changed')); }catch(_){}
    }
    (function normalizeCraft(){ writeCraftAll(readCraftAny()); })();

    /* --- Wait for izza-persist to be ready --- */
    function waitForPersistReady({timeout=3000, interval=40} = {}){
      return new Promise((res)=> {
        const t0 = performance.now();
        const check = () => {
          if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function') return res(true);
          if (performance.now() - t0 > timeout) return res(false);
          setTimeout(check, interval);
        };
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', check, {once:true});
        } else {
          check();
        }
      });
    }

    /* ---- Silent priming via City (hidden iframe, once per session) ---- */
    const SESSION_PRIME_KEY = 'izzaArenaPrimedThisSession';

    function primeViaCityIframe({maxWaitMs=10000, pollMs=120} = {}){
      return new Promise((resolve) => {
        let done = false, softTimer = null, hardTimer = null, pollTimer = null, lsTimer = null;
        let f = null;

        const finish = (reason)=>{
          if (done) return;
          done = true;
          cleanup();
          resolve(reason || 'ok');
        };
        const cleanup = ()=>{
          try{ window.removeEventListener('message', onMsg); }catch(_){}
          try{ clearTimeout(softTimer); clearTimeout(hardTimer);}catch(_){}
          try{ clearInterval(pollTimer); clearInterval(lsTimer);}catch(_){}
          try{ f && f.remove(); f = null; }catch(_){}
        };
        const onMsg = (e)=>{
          try{
            if (typeof e.data === 'string' && e.data.indexOf('izza-city-snapshot-ready') !== -1){
              finish('postMessage');
            } else if (e.data && e.data.type === 'izza-city-snapshot-ready'){
              finish('postMessage');
            }
          }catch(_){}
        };
        window.addEventListener('message', onMsg, false);

        const src = withAuth('/izza-game/play?prime=1&silent=1');
        f = document.createElement('iframe');
        f.id = 'izzaPrimeFrame';
        f.src = src;
        f.setAttribute('aria-hidden','true');
        f.style.position='fixed'; f.style.width='0'; f.style.height='0';
        f.style.opacity='0'; f.style.pointerEvents='none'; f.style.border='0';
        document.body.appendChild(f);

        // Kick City to load snapshot ASAP (active trigger + LS deltas)
        f.addEventListener('load', ()=>{
          try{
            const w = f.contentWindow;

            // Ask City politely (supports message-based priming if implemented there)
            try{ w.postMessage({ type:'izza-prime-request' }, '*'); }catch(_){}

            // Poll for IZZA_PERSIST and call load() once available
            let called = false;
            pollTimer = setInterval(async ()=>{
              try{
                if (!called && w && w.IZZA_PERSIST && typeof w.IZZA_PERSIST.load === 'function'){
                  called = true;
                  await w.IZZA_PERSIST.load();
                  finish('iframe-direct-load');
                  return;
                }
                // Also succeed on LS delta
                const coins = Number(localStorage.getItem('izzaCoins')||'0')|0;
                const craft = readCraftAny()|0;
                if (coins>0 || craft>0){ finish('iframe-poll-ls'); }
              }catch(_){}
            }, pollMs);
          }catch(_){}
        }, {once:true});

        // LocalStorage baseline polling (Safari quirk)
        const baseline = { coins: Number(localStorage.getItem('izzaCoins')||'0')|0, craft: readCraftAny()|0 };
        lsTimer = setInterval(()=>{
          const now = { coins: Number(localStorage.getItem('izzaCoins')||'0')|0, craft: readCraftAny()|0 };
          if (now.coins !== baseline.coins || now.craft !== baseline.craft){
            finish('ls-poll');
          }
        }, Math.max(100, pollMs));

        // safety caps
        softTimer = setTimeout(()=>finish('soft-timeout'), 1500);
        hardTimer = setTimeout(()=>finish('hard-timeout'), maxWaitMs);
      });
    }

    /* ---- Load snapshot (persist layer) ---- */
    async function hydrateFromSnapshot(){
      try{
        await waitForPersistReady();
        if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function'){
          await IZZA_PERSIST.load();  // server -> localStorage
        }
      }catch(_){}
      try{ writeCraftAll(readCraftAny()); }catch(_){}
      renderWallet(readLocalWallet());
    }

    function readLocalWallet(){
      const coins = Number.isFinite(Number(localStorage.getItem('izzaCoins')))
        ? Number(localStorage.getItem('izzaCoins')) : 0;
      const craft = readCraftAny();
      return { coins, crafting: craft };
    }

    let LAST_WALLET = readLocalWallet();

    function renderWallet(obj){
      if (!obj) return;
      let coins = Number(obj.coins)||0;
      let crafting = Number(obj.crafting)||0;
      if (coins === 0 && LAST_WALLET.coins > 0) coins = LAST_WALLET.coins;
      if (crafting === 0 && LAST_WALLET.crafting > 0) crafting = LAST_WALLET.crafting;
      if (elCoins) { elCoins.textContent = String(coins); elCoins.removeAttribute('data-loading'); }
      if (elCraft) { elCraft.textContent = String(crafting); elCraft.removeAttribute('data-loading'); }
      LAST_WALLET = { coins, crafting };
    }

    function parseWalletResponse(j){
      if (!j || typeof j !== 'object') return { coins:0, crafting:0 };
      if ('coins' in j || 'crafting' in j || 'credits' in j){
        return { coins: Number(j.coins)||0, crafting: Number(j.crafting ?? j.credits)||0 };
      }
      if (j.wallet)   return parseWalletResponse(j.wallet);
      if (j.balance)  return parseWalletResponse(j.balance);
      return { coins:0, crafting:0 };
    }

    /* ====== Boot ====== */
    (async function boot(){
      try{
        // If this is the FIRST page in this browser session, begin silent prime IMMEDIATELY.
        const shouldPrime = !sessionStorage.getItem(SESSION_PRIME_KEY);
        const primePromise = shouldPrime ? primeViaCityIframe() : Promise.resolve('skip');

        // Auth/character gate (may redirect to /create if truly first-time ever)
        const profilePre = await ensureCharacter();
        try{ localStorage.setItem('izzaCharacter', JSON.stringify(profilePre)); }catch(_){}

        // Wait for the prime if we started it; then hydrate from snapshot
        try{ await primePromise; }catch(_){}
        try{ await hydrateFromSnapshot(); }catch(_){}
        if (shouldPrime){ try{ sessionStorage.setItem(SESSION_PRIME_KEY, '1'); }catch(_){ } }

        // Paint wallet from LS
        renderWallet(readLocalWallet());

        // IMPORTANT: fetch fresh character again AFTER snapshot so we get equipped items/armoury
        const profileFresh = (await fetchCharacterFresh()) || profilePre;
        try{ localStorage.setItem('izzaCharacter', JSON.stringify(profileFresh)); }catch(_){}

        // Draw avatar with equipped state
        await buildAvatarCanvasWithGear(actx, 96, profileFresh);

        // Place avatar nicely
        const logo = document.getElementById('brandWord');
        if (isTouch && logo){
          const r = logo.getBoundingClientRect();
          const y = r.top + window.scrollY - 6 - 96;
          const x = r.left + window.scrollX - 24;
          setAvatarPos(Math.max(8, x), Math.max(8, y));
        } else {
          setAvatarPos(window.innerWidth/2-48, window.innerHeight/2-48);
        }

        // Authoritative wallet -> write LS -> repaint (avoids flicker)
        try{
          const r = await fetch(withAuth('/izza-game/api/wallet'), {
            credentials:'include',
            headers: bearerHeaders()
          });
          if (r.ok){
            let j = {};
            try{ j = await r.json(); }catch(_){}
            const parsed = parseWalletResponse(j);
            try{
              localStorage.setItem('izzaCoins', String(Number(parsed.coins)||0));
              writeCraftAll(Number(parsed.crafting)||0);
              window.dispatchEvent(new Event('izza-coins-changed'));
              window.dispatchEvent(new Event('izza-crafting-changed'));
            }catch(_){}
            renderWallet(parsed);
          }
        }catch(_){}

        // Keep in sync with app-wide changes
        window.addEventListener('izza-wallet-changed', (ev)=>{
          const d = ev && ev.detail ? ev.detail : {};
          const local = readLocalWallet();
          renderWallet({ coins: d.coins ?? local.coins, crafting: d.crafting ?? d.credits ?? local.crafting });
        }, { passive:true });
        window.addEventListener('izza-coins-changed', ()=> renderWallet(readLocalWallet()), { passive:true });
        window.addEventListener('izza-crafting-changed', ()=> renderWallet(readLocalWallet()), { passive:true });

        // Back/visibility: re-hydrate & repaint
        document.addEventListener('visibilitychange', async ()=>{
          if (!document.hidden){
            try{ await hydrateFromSnapshot(); }catch(_){}
            // also refresh equipped look
            const pf = (await fetchCharacterFresh()) || JSON.parse(localStorage.getItem('izzaCharacter')||'{}');
           await buildAvatarCanvasWithGear(actx,96,pf);
            renderWallet(readLocalWallet());
          }
        }, { passive:true });

        // Update if LS changes in another tab/page
        window.addEventListener('storage', (e)=>{
          if (!e) return;
          if (e.key==='izzaCoins' || CRAFT_KEYS.includes(e.key)) {
            renderWallet(readLocalWallet());
          }
        }, { passive:true });

        // iOS BFCache restore
        window.addEventListener('pageshow', ()=> renderWallet(readLocalWallet()), { passive:true });

        wirePointer();
      }catch(e){
        if(String(e.message)!=='redirecting'){
          console.error('Arena init error',e);
        }
      }
    })();

    /* ===== Leaderboard Modal logic (added) ===== */
    (function(){
      const elModal = document.getElementById('lbModal');
      const elOpen  = document.getElementById('openLbBtn');
      const elClose = document.getElementById('lbCloseBtn');
      const elBody  = document.getElementById('lbBody');
      const elTabs  = document.getElementById('lbTabs');
      const elGame  = document.getElementById('lbGameSel');

      if(!elModal||!elOpen||!elClose||!elBody||!elTabs||!elGame) return;

      function open(){
        elModal.classList.add('show');
        loadAndRender(true);
        renderPoliceChase();   // render IZZA City chase leaderboard
      }

      elTabs.addEventListener('click', (e)=>{
        const b = e.target.closest('[data-period]'); if(!b) return;
        period = b.getAttribute('data-period');
        elTabs.querySelectorAll('.lb-tab').forEach(x=>x.classList.toggle('is-active', x===b));
        loadAndRender();
        renderPoliceChase();   // refresh chase block when tabs change
      }, {passive:true});
      // Also refresh when game dropdown changes
elGame.addEventListener('change', ()=>{
  loadAndRender();      // reload leaderboard for the newly selected game
}, {passive:true});

      function close(){ elModal.classList.remove('show'); }
      elOpen.addEventListener('click', open, {passive:true});
      elClose.addEventListener('click', close, {passive:true});
      elModal.addEventListener('click', (e)=>{ if(e.target===elModal) close(); }, {passive:true});
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); }, {passive:true});

      let period = 'day'; // default
      

      /* ---------- Local ledger helpers: makes your own scores show up ---------- */
      function meUsername(){
        return (window.izzaUserKey && window.izzaUserKey.get && window.izzaUserKey.get())
          || (localStorage.getItem('izzaUserU')||'').toLowerCase();
      }
      function nowParts(){
        const d=new Date(); const z=n=>String(n).padStart(2,'0');
        return {
          day: `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`,
          month: `${d.getFullYear()}-${z(d.getMonth()+1)}`,
          year: String(d.getFullYear())
        };
      }
      function saveLocal(gameId, periodKey, stamp, rows){
        const key = periodKey==='alltime'
          ? `lb::${gameId}::alltime`
          : `lb::${gameId}::${periodKey}::${stamp}`;
        try{ localStorage.setItem(key, JSON.stringify(rows||[])); }catch(_){}
      }
      function readLocal(gameId, periodKey){
        if(periodKey==='alltime'){
          try{ return JSON.parse(localStorage.getItem(`lb::${gameId}::alltime`)||'[]'); }catch(_){ return []; }
        }
        const p=nowParts();
        const map={day:p.day,month:p.month,year:p.year};
        const key=`lb::${gameId}::${periodKey}::${map[periodKey]}`;
        try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(_){ return []; }
      }
      function dedupeAndSort(rows){
        const bestByUser = {};
        (rows||[]).forEach(r=>{
          const u=(r&&r.u)||''; const s = (r&&r.s)|0;
          if(!u) return;
          if(!bestByUser[u] || s>bestByUser[u].s) bestByUser[u] = {u, s, ts:r.ts||Date.now()};
        });
        return Object.values(bestByUser).sort((a,b)=>b.s-a.s).slice(0,20);
      }
      function upsertLocalLedger(gameId, score){
        const u = meUsername(); if(!u) return;
        const row = { u, s: (score|0), ts: Date.now() };
        const stamps = nowParts();

        // all-time
        const all = dedupeAndSort([ ...(readLocal(gameId,'alltime')||[]), row ]);
        saveLocal(gameId, 'alltime', '', all);

        // daily / monthly / yearly
        ['day','month','year'].forEach(k=>{
          const prior = readLocal(gameId,k)||[];
          const merged = dedupeAndSort([ ...prior, row ]);
          saveLocal(gameId, k, stamps[k], merged);
        });
      }
      // Try to discover a player's best score saved by older/other pages.
            function harvestLegacyScores(gameId){
        let found = null;
        const num = v => {
          const n = typeof v==='string' ? parseInt(v,10) : (typeof v==='number'?v:NaN);
          return Number.isFinite(n) && n>0 ? n|0 : null;
        };
        // 1) obvious keys
        const tryKeys = [
          `${gameId}HighScore`,`${gameId}:highscore`,`izza:${gameId}:highscore`,
          `izza:${gameId}:best`,`minigame:${gameId}:best`,`score:${gameId}`,
          `best:${gameId}`,`high:${gameId}`,`izza:${gameId}:score`,`izzaScore:${gameId}`,
          `game:${gameId}:best`,`mg:${gameId}:best`
        ];
        for(const k of tryKeys){
          const v = localStorage.getItem(k);
          const n = num(v);
          if(n!==null){ found = Math.max(found||0, n); }
        }
        // 2) scan JSON blobs that might contain {game,score}
        try{
          for(let i=0;i<localStorage.length;i++){
            const k = localStorage.key(i)||'';
            if(!/score|best|high/i.test(k)) continue;
            const raw = localStorage.getItem(k)||'';
            if((raw && raw[0]==='{') || (raw && raw[0]==='[')){
              try{
                const j = JSON.parse(raw);
                const maybe = Array.isArray(j) ? j : [j];
                maybe.forEach(it=>{
                  if(it && (it.game===gameId || it.g===gameId) && (num(it.score??it.s)!=null)){
                    found = Math.max(found||0, num(it.score??it.s));
                  }
                });
              }catch(_){}
            }
          }
        }catch(_){}
        if(found!==null){ upsertLocalLedger(gameId, found); }
      }

      async function fetchServerLeaders(gameId, periodKey){
        try{
          const url = withAuth(`/izza-game/api/leaderboard?game=${encodeURIComponent(gameId)}&period=${encodeURIComponent(periodKey)}&limit=20`);
          const r = await fetch(url, { credentials:'include', headers: bearerHeaders() });
          if(r.ok){
            const j = await r.json();
            if (Array.isArray(j)) return j;
            if (j && Array.isArray(j.rows)) return j.rows;
          }
        }catch(_){}
        return null;
      }

      // Normalize rows { user, score } or { u, s } -> {u,s}
      function normRows(rows){
        return (rows||[]).map(r => ({
          u: (r.u ?? r.user ?? '‚Äî'),
          s: (r.s ?? r.score ?? 0)|0
        }));
      }

      async function renderPoliceChase(){
        const wrap = document.getElementById('lbPoliceChase');
        if (!wrap) return;

        // Always show all-time for police chase (scores are seconds)
        let rows = null;
        try {
          const r = await (window.IZZA_LEADERBOARD && IZZA_LEADERBOARD.top
            ? IZZA_LEADERBOARD.top({ game: 'city_chase', limit: 20, period: 'all' })
            : Promise.resolve({ ok:false }));
          if (r && r.ok && r.data && Array.isArray(r.data.rows)) {
            rows = r.data.rows;
          }
        } catch(_) { /* fall through to null */ }

        if (!rows) {
          // final fallback (same-origin, keeps existing behavior)
          rows = await fetchServerLeaders('city_chase', 'alltime');
        }

        // Normalize: { u|user, s|score } -> {u,s}
        rows = (rows || []).map(r => ({
          u: (r.u ?? r.user ?? '‚Äî'),
          s: (r.s ?? r.score ?? 0) | 0
        })).filter(r => r.s > 0);

        // Sort best-first and cap to top 20
        rows.sort((a,b) => b.s - a.s);
        rows = rows.slice(0, 20);

        if (!rows.length){
          wrap.innerHTML = `<div class="lb-empty muted">No data yet.</div>`;
          return;
        }

        const fmt = s => `${(s|0)}s`;
        const me =
          (window.izzaUserKey && window.izzaUserKey.get && window.izzaUserKey.get())?.toLowerCase() ||
          (localStorage.getItem('izzaUserU')||'').toLowerCase();

        const html = [
          `<table class="lb-table">
             <thead>
               <tr><th style="width:64px">#</th><th>Player</th><th>Time</th></tr>
             </thead>
             <tbody>`
        ];
        rows.forEach((r,i)=>{
          const isMe = me && r.u && String(r.u).toLowerCase() === me;
          html.push(
            `<tr class="${isMe ? 'lb-row-me' : ''}">
               <td>${i+1}</td>
               <td>${r.u || '‚Äî'}</td>
               <td>${fmt(r.s)}</td>
             </tr>`
          );
        });
        html.push(`</tbody></table>`);
        wrap.innerHTML = html.join('');
      }

      function readLocalLeaders(gameId, periodKey){
        return readLocal(gameId, periodKey).slice(0,20);
      }

      async function loadAndRender(seedFromLegacy=false){
        const gameId = elGame.value || 'basketball';
        if(seedFromLegacy){ harvestLegacyScores(gameId); }
        elBody.innerHTML = `<div class="lb-empty">Loading‚Ä¶</div>`;

        let rows = await fetchServerLeaders(gameId, period);
        if((!rows || !rows.length)){
          rows = readLocalLeaders(gameId, period);
        }

        // If still empty, last-ditch: look for a one-off "last score" and seed.
        if((!rows || !rows.length) && seedFromLegacy){
          try{
            const hint = JSON.parse(localStorage.getItem('izza:lastScore')||'null');
            if(hint && (hint.game===gameId || hint.g===gameId) && Number.isFinite(hint.score||hint.s)){
              upsertLocalLedger(gameId, (hint.score||hint.s)|0);
              rows = readLocalLeaders(gameId, period);
            }
          }catch(_){}
        }

        rows = normRows(rows||[]);

        if(!rows || !rows.length){
          elBody.innerHTML = `<div class="lb-empty muted">No scores yet.</div>`;
          return;
        }

        const me = meUsername();
        const html = [
          `<table class="lb-table"><thead><tr><th style="width:64px">#</th><th>Player</th><th>Score</th></tr></thead><tbody>`
        ];
        rows.slice(0,20).forEach((r,i)=>{
          const isMe = me && r.u && String(r.u).toLowerCase()===me;
          html.push(
            `<tr class="${isMe?'lb-row-me':''}">
               <td>${i+1}</td>
               <td>${r.u||'‚Äî'}</td>
               <td>${(r.s|0)}</td>
             </tr>`
          );
        });
        html.push(`</tbody></table>`);
        elBody.innerHTML = html.join('');
      }
    })();
  })();
  </script>
</body>
</html>
