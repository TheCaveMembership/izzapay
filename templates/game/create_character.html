<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Your Character — IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:14px}
    label{display:block;margin:8px 0 4px}
    select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:var(--chip-bg);color:var(--txt)}
    .muted{color:var(--muted)}
    .preview-wrap{display:flex;flex-direction:column;gap:10px}
    .stage{
      width:320px;height:320px;border-radius:12px;border:1px solid var(--line);
      background:
        linear-gradient(0deg, rgba(0,0,0,.08) 1px, transparent 1px) 0 0/20px 20px,
        linear-gradient(90deg, rgba(0,0,0,.08) 1px, transparent 1px) 0 0/20px 20px,
        #10202b;
      display:flex;align-items:center;justify-content:center;margin:0 auto;
    }
    canvas{image-rendering:pixelated;image-rendering:crisp-edges}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:var(--chip-bg)}
    .note{font-size:13px}
    .danger{color:#ff9aa2}
    .btns{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .hide{display:none}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="card">
      <div class="grid">
        <!-- Left: Live Preview -->
        <div class="preview-wrap">
          <h1 style="margin:0 0 6px">Create Your Character</h1>
          <div class="row">
            <span class="pill">8-bit retro • top-down</span>
            <span class="pill">IZZA City starter look</span>
          </div>
          <div class="stage">
            <canvas id="avatar" width="160" height="160" aria-label="Live character preview"></canvas>
          </div>
          <p class="muted note" id="presetLabel"></p>
        </div>

        <!-- Right: Form -->
        <div>
          <form id="charForm" method="post">
            {% if t %}
              <input type="hidden" name="t" value="{{ t }}">
            {% endif %}

            <!-- NEW -->
            <label>Body Type</label>
            <select id="body_type" name="body_type">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="neutral">Prefer not to say</option>
            </select>

            <label>Skin Tone</label>
            <select id="skin_tone" name="skin_tone">
              <option value="light">Light</option>
              <option value="medium">Medium</option>
              <option value="tan">Tan</option>
              <option value="dark">Dark</option>
              <option value="deep">Deep</option>
            </select>

            <!-- EXISTING (text updated only) -->
            <label>Sleeve Color</label>
            <select name="sprite_skin" id="sprite_skin">
              <option value="default">Default</option>
              <option value="street_a">Street A</option>
              <option value="street_b">Street B</option>
            </select>

            <label>Hair Style</label>
            <select name="hair" id="hair">
              <option value="short">Short</option>
              <option value="buzz">Buzz</option>
              <option value="long">Long</option>
            </select>

            <!-- NEW -->
            <label>Hair Color</label>
            <select id="hair_color" name="hair_color">
              <option value="black">Black</option>
              <option value="brown">Brown</option>
              <option value="blonde">Blonde</option>
              <option value="red">Red</option>
              <option value="white">White</option>
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="pink">Pink</option>
            </select>

            <!-- EXISTING (text updated only) -->
            <label>Vest Color</label>
            <select name="outfit" id="outfit">
              <option value="street">Street</option>
              <option value="athletic">Athletic</option>
              <option value="luxury">Luxury</option>
            </select>

            <div class="btns">
              <button class="ip-btn" type="submit">Save and Enter IZZA</button>
              <a class="ip-btn ghost" href="/">Cancel</a>
            </div>

            <p class="muted note" style="margin-top:8px">
              Once saved, your base appearance is <strong>locked</strong>. You can still change style
              and flair later via in-game merch (barbers, outfitters, mods).
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const SPRITES = {
      body: {
        default:  "/static/game/sprites/body/default.png",
        street_a: "/static/game/sprites/body/street_a.png",
        street_b: "/static/game/sprites/body/street_b.png"
      },
      hair: {
        short: "/static/game/sprites/hair/short.png",
        buzz:  "/static/game/sprites/hair/buzz.png",
        long:  "/static/game/sprites/hair/long.png",
        long_f: "/static/game/sprites/hair/long_f.png" // optional female-specific
      },
      outfit: {
        street:   "/static/game/sprites/outfit/street.png",
        athletic: "/static/game/sprites/outfit/athletic.png",
        luxury:   "/static/game/sprites/outfit/luxury.png"
      }
    };

    // Base ramps (used to match pixels in the sprites)
    const SKIN_BASE = ["#F7D7C6", "#E8BEA8", "#D6A48E"];
    const HAIR_BASE = ["#C8C8C8", "#9C9C9C", "#6E6E6E"];

    // Stronger target ramps
    const SKIN_TO = {
      light:  ["#FFE7D6","#F3C6A7","#D8A187"],
      medium: ["#F1BD94","#D79A73","#B67955"],
      tan:    ["#E2A878","#C88756","#9F663C"],
      dark:   ["#B9825B","#9A6644","#714A31"],
      deep:   ["#8B5A3B","#6A402A","#432818"]
    };
    const HAIR_TO = {
      black:  ["#2C2C31","#1C1C20","#0D0D10"],
      brown:  ["#7A5336","#5E3F29","#412B1C"],
      blonde: ["#FBE58F","#E7C65A","#BC9E3D"],
      red:    ["#E65F35","#BE4525","#8F321A"],
      white:  ["#F5F5F5","#E1E1E1","#C6C6C6"],
      blue:   ["#79A5FF","#4A79DE","#2B59B6"],
      green:  ["#7CD67C","#4FB54F","#2F7F31"],
      pink:   ["#FFA0C8","#E475A6","#C35486"]
    };

    // DOM
    const selType = document.getElementById('body_type');
    const selTone = document.getElementById('skin_tone');
    const selSkin = document.getElementById('sprite_skin');
    const selHair = document.getElementById('hair');
    const selHairColor = document.getElementById('hair_color');
    const selOut  = document.getElementById('outfit');
    const cvs     = document.getElementById('avatar');
    const ctx     = cvs.getContext('2d');
    const preset  = document.getElementById('presetLabel');
    const form    = document.getElementById('charForm');
    ctx.imageSmoothingEnabled = false;

    // utils
    function loadImg(src){ return new Promise(res=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
    const hexToRgb = h => { const n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; };
    const dist2 = (a,b)=>{const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;};

    function paletteSwap(img, fromRamp, toRamp, tolerance=1200){
      const w=img.width,h=img.height;
      const oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true});
      c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const id=c.getImageData(0,0,w,h), d=id.data;

      const from=fromRamp.map(hexToRgb), to=toRamp.map(hexToRgb);
      let changed=0;

      for(let i=0;i<d.length;i+=4){
        const a=d[i+3]; if(a===0) continue;
        const p={r:d[i],g:d[i+1],b:d[i+2]};
        let best=-1, bestScore=1e9;
        for(let k=0;k<from.length;k++){ const s=dist2(p,from[k]); if(s<bestScore){best=k;bestScore=s;} }
        if(bestScore<=tolerance){
          const t=to[best]||to[to.length-1];
          if(d[i]!==t.r||d[i+1]!==t.g||d[i+2]!==t.b){ changed++; }
          d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b;
        }
      }
      c.putImageData(id,0,0);
      return {canvas:oc, changedPixels:changed};
    }

    function overlayTint(img, hex, strength=1.0){
      const w=img.width,h=img.height;
      const oc=document.createElement('canvas'); oc.width=w; oc.height=h;
      const c=oc.getContext('2d',{willReadFrequently:true});
      c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
      const id=c.getImageData(0,0,w,h), d=id.data;
      const tc=hexToRgb(hex);
      function overlay(a,b){ a/=255; b/=255; const out=(a<0.5)?(2*a*b):(1-2*(1-a)*(1-b)); return Math.round(255*out); }
      for(let i=0;i<d.length;i+=4){
        if(d[i+3]===0) continue;
        const r=overlay(d[i],tc.r), g=overlay(d[i+1],tc.g), b=overlay(d[i+2],tc.b);
        d[i]=Math.round(d[i]*(1-strength)+r*strength);
        d[i+1]=Math.round(d[i+1]*(1-strength)+g*strength);
        d[i+2]=Math.round(d[i+2]*(1-strength)+b*strength);
      }
      c.putImageData(id,0,0);
      return oc;
    }

    function updateFieldVisibility(){
      const isFemale = selType.value==='female';
      // hide sleeves/vest for female if they don't conceptually apply
      document.querySelector('label[for="sprite_skin"]')?.classList.toggle('hide', isFemale);
      document.getElementById('sprite_skin').classList.toggle('hide', isFemale);
      document.querySelector('label[for="outfit"]')?.classList.toggle('hide', isFemale);
      document.getElementById('outfit').classList.toggle('hide', isFemale);
    }

    async function draw(){
      // bg
      ctx.clearRect(0,0,cvs.width,cvs.height);
      const g = ctx.createRadialGradient(80,80,10,80,80,90);
      g.addColorStop(0,"rgba(255,255,255,.08)"); g.addColorStop(1,"rgba(0,0,0,0)");
      ctx.fillStyle=g; ctx.fillRect(0,0,cvs.width,cvs.height);

      const DW=96,DH=96,X=(cvs.width-DW)/2,Y=(cvs.height-DH)/2;

      const theme=selSkin.value;
      const isFemale = (selType.value==='female');
      let body=null;

      if(isFemale){
        // only try female file when body_type is female
        body = await loadImg(`/static/game/sprites/body/${theme}__female.png`);
        if(!body){
          // fallback to default female if theme-specific missing
          body = await loadImg(`/static/game/sprites/body/default__female.png`);
        }
      }
      if(!body){
        // male/neutral or fallback
        body = await loadImg(SPRITES.body[theme]||SPRITES.body.default);
      }

      let outfit = null;
      if(!isFemale){ // hide vest layer for female
        outfit = await loadImg(SPRITES.outfit[selOut.value]||SPRITES.outfit.street);
      }

      let hairURL=SPRITES.hair[selHair.value]||SPRITES.hair.short;
      if(isFemale && selHair.value==='long') hairURL=SPRITES.hair.long_f||SPRITES.hair.long;
      let hair=await loadImg(hairURL);

      const skinRamp=SKIN_TO[selTone.value]||SKIN_TO.light;
      const hairRamp=HAIR_TO[selHairColor.value]||HAIR_TO.black;

      // body tint (palette swap with overlay fallback)
      if(body){
        let swapped = paletteSwap(body, SKIN_BASE, skinRamp, 1500);
        if(swapped.changedPixels < 12){
          // Female bases may not match SKIN_BASE exactly; ensure tint
          const oc = overlayTint(body, skinRamp[1], 1.0);
          ctx.drawImage(oc, X, Y, DW, DH);
        }else{
          ctx.drawImage(swapped.canvas, X, Y, DW, DH);
        }
      }else{
        ctx.fillStyle="#41d1a7"; ctx.fillRect(X,Y,DW,DH);
      }

      if(outfit){
        ctx.drawImage(outfit, X, Y, DW, DH);
      }else if(!isFemale){
        ctx.fillStyle="#5aa6ff"; ctx.fillRect(X+2,Y+38,DW-4,DH-40);
      }

      if(hair){
        const swap = paletteSwap(hair, HAIR_BASE, hairRamp, 1200);
        let hairCanvas = swap.canvas;
        if(swap.changedPixels < 8){
          hairCanvas = overlayTint(hair, hairRamp[1], 1.0);
        }
        ctx.drawImage(hairCanvas, X, Y, DW, DH);
      }else{
        ctx.fillStyle="#f2d16b"; ctx.fillRect(X+28,Y+6,40,22);
      }

      preset.textContent =
        `Body: ${selType.value} • Skin: ${selTone.value} • Hair: ${selHair.value} (${selHairColor.value})` +
        (isFemale ? '' : ` • Vest: ${selOut.value} • Sleeves: ${selSkin.value}`);
    }

    form.addEventListener('submit', function(ev){
      const ok = confirm("Save character?\n\nBase appearance will be LOCKED.\nYou can still change style via in-game shops.");
      if(!ok){ ev.preventDefault(); }
    });

    // Live preview + field visibility
    [selType, selTone, selSkin, selHair, selHairColor, selOut].forEach(el=>{
      el.addEventListener('change', ()=>{ updateFieldVisibility(); draw(); });
    });

    // Initial paint
    updateFieldVisibility();
    draw();
  })();
  </script>
</body>
</html>
