<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Your Character — IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:14px}
    label{display:block;margin:8px 0 4px}
    select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:var(--chip-bg);color:var(--txt)}
    .muted{color:var(--muted)}
    .preview-wrap{display:flex;flex-direction:column;gap:10px}
    .stage{
      width:320px;height:320px;border-radius:12px;border:1px solid var(--line);
      background:
        linear-gradient(0deg, rgba(0,0,0,.08) 1px, transparent 1px) 0 0/20px 20px,
        linear-gradient(90deg, rgba(0,0,0,.08) 1px, transparent 1px) 0 0/20px 20px,
        #10202b;
      display:flex;align-items:center;justify-content:center;margin:0 auto;
    }
    canvas{image-rendering:pixelated;image-rendering:crisp-edges}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:var(--chip-bg)}
    .note{font-size:13px}
    .danger{color:#ff9aa2}
    .btns{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="card">
      <div class="grid">
        <!-- Left: Live Preview -->
        <div class="preview-wrap">
          <h1 style="margin:0 0 6px">Create Your Character</h1>
          <div class="row">
            <span class="pill">8-bit retro • top-down</span>
            <span class="pill">IZZA City starter look</span>
          </div>
          <div class="stage">
            <canvas id="avatar" width="160" height="160" aria-label="Live character preview"></canvas>
          </div>
          <p class="muted note" id="presetLabel"></p>
        </div>

        <!-- Right: Form -->
        <div>
          <form id="charForm" method="post">
            {% if t %}
              <input type="hidden" name="t" value="{{ t }}">
            {% endif %}

            <!-- NEW: body type & tones (encoded into sprite_skin on submit) -->
            <label>Body Type</label>
            <select id="body_type">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="neutral">Prefer not to say</option>
            </select>

            <label>Skin Tone</label>
            <select id="skin_tone">
              <option value="light">Light</option>
              <option value="medium">Medium</option>
              <option value="tan">Tan</option>
              <option value="dark">Dark</option>
              <option value="deep">Deep</option>
            </select>

            <!-- EXISTING fields (kept) -->
            <label>Sleeve Color</label>
            <select name="sprite_skin" id="sprite_skin">
              <option value="default">Default</option>
              <option value="street_a">Street A</option>
              <option value="street_b">Street B</option>
            </select>

            <label>Hair Style</label>
            <select name="hair" id="hair">
              <option value="short">Short</option>
              <option value="buzz">Buzz</option>
              <option value="long">Long</option>
            </select>

            <!-- NEW: hair color (encoded into hair on submit) -->
            <label>Hair Color</label>
            <select id="hair_color">
              <option value="black">Black</option>
              <option value="brown">Brown</option>
              <option value="blonde">Blonde</option>
              <option value="red">Red</option>
              <option value="white">White</option>
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="pink">Pink</option>
            </select>

            <label>Vest Color</label>
            <select name="outfit" id="outfit">
              <option value="street">Street</option>
              <option value="athletic">Athletic</option>
              <option value="luxury">Luxury</option>
            </select>

            <div class="btns">
              <button class="ip-btn" type="submit">Save and Enter IZZA</button>
              <a class="ip-btn ghost" href="/">Cancel</a>
            </div>

            <p class="muted note" style="margin-top:8px">
              Once saved, your base appearance is <strong>locked</strong>. You can still change style
              and flair later via in-game merch (barbers, outfitters, mods).
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // Base sprite URLs (unchanged)
    const SPRITES = {
      body: {
        default:  "/static/game/sprites/body/default.png",
        street_a: "/static/game/sprites/body/street_a.png",
        street_b: "/static/game/sprites/body/street_b.png"
      },
      hair: {
        short: "/static/game/sprites/hair/short.png",
        buzz:  "/static/game/sprites/hair/buzz.png",
        long:  "/static/game/sprites/hair/long.png"
      },
      outfit: {
        street:   "/static/game/sprites/outfit/street.png",
        athletic: "/static/game/sprites/outfit/athletic.png",
        luxury:   "/static/game/sprites/outfit/luxury.png"
      }
    };

    // Live label map
    const LABELS = {
      sprite_skin: { default:"Default", street_a:"Street A", street_b:"Street B" },
      hair:        { short:"Short", buzz:"Buzz", long:"Long" },
      outfit:      { street:"Street", athletic:"Athletic", luxury:"Luxury" },
      body_type:   { male:"Male", female:"Female", neutral:"Neutral" },
      skin_tone:   { light:"Light", medium:"Medium", tan:"Tan", dark:"Dark", deep:"Deep" },
      hair_color:  { black:"Black", brown:"Brown", blonde:"Blonde", red:"Red", white:"White", blue:"Blue", green:"Green", pink:"Pink" }
    };

    // --------- TINT PALETTES ----------
    // Stronger skin curve (aimed to "intensify quicker")
    const SKIN_TINT = {
      light:  "#f1d2b6",
      medium: "#d9a074",
      tan:    "#b8744f",
      dark:   "#8b4d2e",
      deep:   "#3a2313"   // much deeper now
    };

    // Exact hair colors by name (looks correct on neutral gray hair sprites)
    const HAIR_TINT = {
      black:  "#1b1b1b",
      brown:  "#6a3b16",
      blonde: "#f4e07d",
      red:    "#b33b2e",
      white:  "#f7f7f7",
      blue:   "#5aa6ff",
      green:  "#41d1a7",
      pink:   "#ff8ac2"
    };

    // ---------- DOM ----------
    const selType = document.getElementById('body_type');
    const selTone = document.getElementById('skin_tone');
    const selSkin = document.getElementById('sprite_skin');
    const selHair = document.getElementById('hair');
    const selHairColor = document.getElementById('hair_color');
    const selOut  = document.getElementById('outfit');
    const cvs     = document.getElementById('avatar');
    const ctx     = cvs.getContext('2d');
    const preset  = document.getElementById('presetLabel');
    const form    = document.getElementById('charForm');

    ctx.imageSmoothingEnabled = false;

    // --- utils ---
    function loadImg(src){
      return new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = src;
      });
    }
    function parseHex(c){
      const m = /^#?([0-9a-f]{6})$/i.exec(c)||[]; if(!m[1]) return [255,255,255];
      const n = parseInt(m[1],16);
      return [(n>>16)&255,(n>>8)&255,n&255];
    }
    function fillTint(x,y,w,h,hex,alpha,mode){
      const [r,g,b] = parseHex(hex);
      const prev = ctx.globalCompositeOperation;
      ctx.globalCompositeOperation = mode||'source-atop';
      ctx.fillStyle = `rgba(${r},${g},${b},${alpha==null?1:alpha})`;
      ctx.fillRect(x,y,w,h);
      ctx.globalCompositeOperation = prev;
    }

    // Compose strings for backend (you can later drop these if you switch backend to separate fields)
    function composeBodyKey(){
      const base = selSkin.value;
      const t = selType.value;
      const s = selTone.value;
      const typeKey = (t==='neutral' ? 'male' : t);
      return base + '__' + typeKey + '__' + s; // street_a__female__tan
    }
    function composeHairKey(){
      return selHair.value + '__' + selHairColor.value; // short__blonde
    }

    function outfitURL(){ return SPRITES.outfit[selOut.value] || SPRITES.outfit.street; }
    function bodyURL(){ return SPRITES.body[selSkin.value] || SPRITES.body.default; }
    function hairURL(){ return SPRITES.hair[selHair.value] || SPRITES.hair.short; }

    async function draw(){
      // Clear + vignette
      ctx.clearRect(0,0,cvs.width,cvs.height);
      const g = ctx.createRadialGradient(80,80,10, 80,80,90);
      g.addColorStop(0, "rgba(255,255,255,0.08)");
      g.addColorStop(1, "rgba(0,0,0,0.0)");
      ctx.fillStyle = g; ctx.fillRect(0,0,cvs.width,cvs.height);

      const DW = 96, DH = 96, X = (cvs.width - DW)/2, Y = (cvs.height - DH)/2;

      // Load layers
      const [body, hair, outfit] = await Promise.all([
        loadImg(bodyURL()), loadImg(hairURL()), loadImg(outfitURL())
      ]);

      // BODY
      if (body) {
        ctx.drawImage(body, X, Y, DW, DH);
        // skin tint across the whole body layer, assuming skin pixels are mid-tones in the sprite
        // multiply keeps shadows; source-atop preserves mask
        fillTint(X, Y, DW, DH, SKIN_TINT[selTone.value] || SKIN_TINT.medium, 1, 'multiply');
      } else {
        ctx.fillStyle="#41d1a7"; ctx.fillRect(X,Y,DW,DH);
      }

      // OUTFIT on top
      if (outfit) ctx.drawImage(outfit, X, Y, DW, DH);
      else { ctx.fillStyle="#5aa6ff"; ctx.fillRect(X+2, Y+38, DW-4, DH-40); }

      // HAIR + precise tint
      if (hair) {
        ctx.drawImage(hair, X, Y, DW, DH);
        fillTint(X, Y, DW, DH, HAIR_TINT[selHairColor.value] || HAIR_TINT.brown, 1, 'source-atop');
      } else {
        ctx.fillStyle="#f2d16b"; ctx.fillRect(X+28, Y+6, 40, 22);
      }

      // Label
      preset.textContent =
        `Body: ${LABELS.body_type[selType.value]} • Skin: ${LABELS.skin_tone[selTone.value]} • ` +
        `Hair: ${LABELS.hair[selHair.value]} (${LABELS.hair_color[selHairColor.value]}) • ` +
        `Vest: ${LABELS.outfit[selOut.value]} • Sleeves: ${LABELS.sprite_skin[selSkin.value]}`;
    }

    // Mutate values before POST (keeps your backend contract)
    form.addEventListener('submit', function(ev){
      document.getElementById('sprite_skin').value = composeBodyKey();
      document.getElementById('hair').value = composeHairKey();
      const ok = confirm(
        "Save character?\n\nBase appearance will be LOCKED.\nYou can still change style via in-game shops (barber, outfitters, mods)."
      );
      if (!ok) { ev.preventDefault(); return false; }
    });

    // Live preview updates
    [selType, selTone, selSkin, selHair, selHairColor, selOut].forEach(el=>{
      el.addEventListener('change', draw);
    });

    // Initial render
    draw();
  })();
  </script>
</body>
</html>
