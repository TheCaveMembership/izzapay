<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Authenticate â€” IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    html,body{max-width:100%;overflow-x:hidden}
    :root{
      --bg:#000; --txt:#e8f1ff; --muted:#9fb0d6; --line:#1d2540;
      --piPurple1:#7a44ff; --piPurple2:#b784ff;
      --gold1:#ffcf4d; --gold2:#ffb23a;
      --glow-gold:0 0 26px rgba(255,207,77,.45), 0 0 64px rgba(255,178,58,.25);
      --glow-purple:0 0 28px rgba(183,132,255,.35), 0 0 64px rgba(122,68,255,.25);
      --ring:0 0 0 2px rgba(183,132,255,.28);
      --dim:#5f6d90;
    }
    body{
      font-family:Inter,Arial,Helvetica,sans-serif;background:#000;color:var(--txt);margin:0;
      text-align:center;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    @media (min-width:720px){ .wrap{padding:24px 24px 140px} }

    /* Top bar: centered BROWSE STORES */
    .topbar{
      display:flex;align-items:center;justify-content:center;
      padding:12px 0; position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.9); backdrop-filter:blur(10px); border-bottom:1px solid var(--line);
    }

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:14px 18px;border-radius:14px;font-weight:700;letter-spacing:.2px;cursor:pointer;text-decoration:none;
      border:1px solid transparent;transition:transform .15s ease,box-shadow .15s ease,filter .15s ease;
      font-size:clamp(14px,3.7vw,18px); white-space:nowrap;
    }
    .btn:focus-visible{outline:none;box-shadow:var(--ring)}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.purple{background:linear-gradient(180deg,var(--piPurple1),var(--piPurple2));color:#fff;box-shadow:var(--glow-purple)}
    .btn.gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1400;box-shadow:var(--glow-gold)}
    .btn.ghost{background:transparent;color:#cfe0ff;border-color:#2a3550}
    .btn.ghost:hover{border-color:#3f4e79}
    .btn.upper{text-transform:uppercase;letter-spacing:.6px}

    /* Headings and copy */
    h1{
      margin:16px 0 6px;
      font-size:clamp(26px,8.5vw,56px);
      line-height:1.05; letter-spacing:.4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    p{color:var(--muted);margin:8px 0 16px}

    .section{padding:18px 0}
    .cta-row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}

    /* Reveal */
    .reveal{opacity:0;transform:translateY(18px);transition:opacity .5s ease,transform .5s ease}
    .reveal.show{opacity:1;transform:translateY(0)}

    /* Rails */
    .rail{position:fixed;top:0;bottom:0;width:12px;z-index:0;pointer-events:none}
    .rail.left{left:0;background:linear-gradient(180deg,transparent 0%,rgba(255,207,77,.18) 20%,rgba(255,178,58,.2) 55%,transparent 100%)}
    .rail.right{right:0;background:linear-gradient(180deg,transparent 0%,rgba(183,132,255,.16) 20%,rgba(122,68,255,.22) 55%,transparent 100%)}

    /* IZZA wordmark under the title */
    .hero-logo{height:clamp(58px,12vw,110px);margin:10px auto 8px;display:block;filter:drop-shadow(0 0 10px rgba(255,255,255,.06))}

    /* Message and error */
    .err{color:#ff9aa2;white-space:pre-wrap}

    /* Keep mobile nudge consistent with home if you want it */
    @media (max-width:768px){
      #s-auth .hero-logo{
        display:block;
        margin:10px auto 8px;
      }
    }
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <!-- rails -->
  <div class="rail left"  id="railL" aria-hidden="true"></div>
  <div class="rail right" id="railR" aria-hidden="true"></div>

  <div class="wrap">
    <!-- Topbar -->
    <div class="topbar">
      <a class="btn ghost upper" href="/explore">BROWSE STORES</a>
    </div>

    <!-- Auth hero -->
    <section class="section" id="s-auth">
      <h1 class="reveal">SIGN IN WITH PI</h1>
      <img src="/static/izzapay-word.svg" alt="IZZA PAY" class="hero-logo reveal">

      <p class="reveal" id="destCopy">
        You are about to enter <strong>IZZA City</strong>. We use Pi sign in to link your progress,
        character, and inventory to your account.
      </p>

      <div class="cta-row reveal">
        <!-- keep the same button id and behavior -->
        <button id="piGameAuthBtn" class="btn purple">ðŸŽ® Authenticate with Pi</button>
        <a class="btn ghost" href="/">Back to Home</a>
      </div>

      <p id="msg" class="reveal" style="margin-top:10px;color:var(--muted)"></p>
      <div id="err" class="err"></div>

      <p class="reveal" style="margin-top:10px;font-size:13px;color:var(--muted)">
        Tip: open this in the Pi Browser so the Pi SDK can run.
      </p>
    </section>
  </div>

  <!-- Pi SDK auth logic unchanged -->
  <script>
  (function(){
    const sandbox = {{ 'true' if sandbox else 'false' }};
    const btn = document.getElementById('piGameAuthBtn');
    const msg = document.getElementById('msg');
    const err = document.getElementById('err');
    const destCopy = document.getElementById('destCopy');

    function setMsg(t){ msg.textContent = t || ''; }
    function setErr(t){ err.textContent = t || ''; }

    // params
    const url = new URL(location.href);
    const inviteFrom = url.searchParams.get('from') || '';
    const inviteCode = url.searchParams.get('code') || '';
    const inviteSrc  = url.searchParams.get('src')  || '';
    const dest       = (url.searchParams.get('dest')||'city').toLowerCase() === 'minigames' ? 'minigames' : 'city';

    // copy tweak for minigames
    try{
      if(dest==='minigames'){
        destCopy.innerHTML = `You are about to enter the <strong>Mini Game Arena</strong>. We use Pi sign in to link your progress,
        character, and inventory to your account.`;
      }
    }catch(_){}

    function initPi(){
      if (!window.Pi || !Pi.init) return false;
      try { Pi.init({ version: "2.0", sandbox: sandbox }); return true; }
      catch(e){ console.error("Pi.init failed", e); setErr("Pi.init failed: " + (e?.message || e)); return false; }
    }
    if (!initPi()) setMsg("Open in Pi Browser or refresh. Pi SDK is initializing.");

    btn?.addEventListener('click', function(){
      setErr('');
      if (!window.Pi || !Pi.authenticate) { setMsg("Pi SDK not available. Open in Pi Browser or refresh."); return; }
      setMsg("Requesting authorizationâ€¦");

      const scopes = ['username'];
      function onIncompletePaymentFound(payment){}

      Pi.authenticate(scopes, onIncompletePaymentFound)
        .then(function(auth){
          try{ localStorage.setItem('piAuthUser', JSON.stringify(auth.user||null)); }catch{}
          try{ localStorage.setItem('piAccessToken', auth.accessToken || ''); }catch{}

          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/auth/exchange';

          const payload = document.createElement('input');
          payload.type='hidden'; payload.name='payload';
          payload.value = JSON.stringify({ accessToken: auth.accessToken, user: auth.user });
          form.appendChild(payload);

          const next = document.createElement('input');
          next.type='hidden'; next.name='next';
          next.value = '/izza-game/create?dest='+encodeURIComponent(dest);
          form.appendChild(next);

          if(inviteSrc === 'invite'){
            const from = document.createElement('input');
            from.type='hidden'; from.name='inviteFrom'; from.value = inviteFrom;
            const code = document.createElement('input');
            code.type='hidden'; code.name='inviteCode'; code.value = inviteCode;
            form.appendChild(from); form.appendChild(code);
          }

          document.body.appendChild(form);
          form.submit();
        })
        .catch(function(e){
          console.error(e);
          setMsg("Authorization failed. Please try again.");
          setErr(e?.message || String(e));
        });
    });
  })();
  </script>

  <!-- Scroll reveal and rail glow to match home -->
  <script>
  (function(){
    const io=new IntersectionObserver((entries)=>{
      entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('show'); });
    },{threshold:.15});
    document.querySelectorAll('.reveal').forEach(n=>io.observe(n));

    const L=document.getElementById('railL'), R=document.getElementById('railR');
    function onScroll(){
      const doc=document.documentElement;
      const max=doc.scrollHeight-doc.clientHeight;
      const p=Math.max(0,Math.min(1,(doc.scrollTop||0)/(max||1)));
      const g=8+44*p, a=0.18+0.35*p;
      if(L) L.style.boxShadow=`0 0 ${g}px ${g/6}px rgba(255,207,77,${a})`;
      if(R) R.style.boxShadow=`0 0 ${g}px ${g/6}px rgba(183,132,255,${a})`;
    }
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
  })();
  </script>

  <!-- Reconcile credits unchanged -->
  <script>
  (async function(){
    try{
      await fetch('/api/crafting/credits/reconcile', {
        method:'POST',
        headers:{'content-type':'application/json'},
        credentials:'include'
      });
      localStorage.setItem('izzaCraftGrantSeen', '1');
    }catch(_){}
  })();
  </script>
</body>
</html>
