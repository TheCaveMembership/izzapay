<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Street Basketball — IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- DO NOT CHANGE PERSIST SETUP -->
  <script>window.IZZA_PERSIST_BASE = 'https://izzagame.onrender.com';</script>
  <script src="/static/game/js/izza-persist.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --hud:rgba(0,0,0,.55); --hudLine:rgba(255,255,255,.18);
      --ok:#72ff9d; --warn:#ffd36b; --bad:#ff6b6b; --arcade:#ffed8a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#102;color:var(--txt);font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:10px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);
         background:var(--chip-bg);padding:8px 12px;border-radius:10px;color:inherit;text-decoration:none}
    .btn:hover{filter:brightness(1.06)}
    .arena{position:relative;height:74vh;min-height:540px;border:1px solid var(--line);
           border-radius:14px;background:#79c0ff;overflow:hidden}
    .hud{position:absolute;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;gap:8px;z-index:6}
    .hud .left,.hud .right{display:flex;gap:10px;align-items:center}
    .pill{background:var(--hud);border:1px solid var(--hudLine);backdrop-filter:blur(6px);
          padding:8px 14px;border-radius:999px;font-size:14px;font-weight:700;letter-spacing:.3px;display:flex;gap:8px;align-items:center}
    .pill strong{font-size:18px}
    .pill .arc{color:var(--arcade);text-shadow:0 2px 12px rgba(0,0,0,.4)}
    .avatarBadge{width:42px;height:42px;border-radius:8px;overflow:hidden;border:1px solid var(--hudLine)}
    .avatarCanvas{width:42px;height:42px;image-rendering:pixelated;display:block}
    .aim{position:absolute;inset:0;z-index:3;touch-action:none}
    .bigmsg{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
            font-weight:900;letter-spacing:.6px;font-size:52px;opacity:.0;transition:opacity .2s, transform .2s;
            pointer-events:none;text-shadow:0 10px 34px rgba(0,0,0,.65);color:var(--arcade);z-index:7}
    .bigmsg.show{opacity:1;transform:translate(-50%,-56%) scale(1.04)}
    .scoreGlow{color:var(--ok)} .miss{color:var(--bad)}
    .finish{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .vignette:after{content:"";position:absolute;inset:0;pointer-events:none;z-index:5;
      background:radial-gradient(80% 70% at 50% 20%, rgba(0,0,0,0) 50%, rgba(0,0,0,.35) 100%);}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="top">
      <a class="btn" id="backBtn" href="/izza-game/minigames">← Back to Arena</a>
      <a class="btn" id="cityBtn" href="/izza-game/play">Enter IZZA City</a>
    </div>

    <div class="arena vignette" id="arena">
      <div class="hud">
        <div class="left">
          <div class="pill">SCORE: <strong id="score" class="arc">0</strong></div>
          <div class="pill">GOALS: <strong id="streak" class="arc">0</strong></div>
          <div class="pill">TIME: <strong id="time" class="arc">60</strong>s</div>
        </div>
        <div class="right">
          <div class="avatarBadge"><canvas id="avatarTiny" class="avatarCanvas" width="42" height="42"></canvas></div>
          <div class="pill">COINS: <strong id="coinsRun" class="arc">0</strong></div>
        </div>
      </div>

      <!-- Scene SVG (sky, fence, floor, hoop, ball) -->
      <svg id="court" class="aim" viewBox="0 0 1100 700" preserveAspectRatio="none" aria-label="Court">
        <defs>
          <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#8bd1ff"/><stop offset="100%" stop-color="#bfe6ff"/>
          </linearGradient>
          <linearGradient id="wood" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#e6b77a"/><stop offset="100%" stop-color="#c78f4a"/>
          </linearGradient>
          <pattern id="fence" width="20" height="20" patternUnits="userSpaceOnUse" patternTransform="skewX(-10)">
            <path d="M0 10 L20 10" stroke="#cfd7e0" stroke-width="2" opacity=".55"/>
            <path d="M10 0 L10 20" stroke="#cfd7e0" stroke-width="2" opacity=".55"/>
          </pattern>
          <filter id="shadow"><feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="#000" flood-opacity=".35"/></filter>
        </defs>

        <!-- sky + background -->
        <rect x="0" y="0" width="1100" height="700" fill="url(#sky)"/>
        <ellipse cx="250" cy="520" rx="320" ry="140" fill="#8ed47d" opacity=".9"/>
        <ellipse cx="880" cy="520" rx="300" ry="130" fill="#89d074" opacity=".9"/>

        <!-- shrubs -->
        <g opacity=".9">
          <rect x="210" y="420" width="18" height="90" fill="#7c5a3a"/><circle cx="220" cy="420" r="60" fill="#5bbd5a"/>
          <rect x="920" y="420" width="18" height="90" fill="#7c5a3a"/><circle cx="930" cy="420" r="60" fill="#5bbd5a"/>
        </g>

        <!-- horizon layers -->
        <g><polygon points="0,470 1100,470 1100,520 0,520" fill="#6ea0cf"/>
           <polygon points="0,520 1100,520 1100,560 0,560" fill="#547fa8"/></g>

        <!-- fence around court -->
        <rect x="0" y="260" width="1100" height="210" fill="url(#fence)" opacity=".55"/>

        <!-- hoop (closer & larger at start) -->
        <g id="hoop" transform="translate(520, 350) scale(1.1)">
          <rect x="90" y="-20" width="12" height="76" fill="#b7c7d8"/>
          <rect x="40" y="-92" width="120" height="84" rx="8" ry="8" fill="#f2f6fa" stroke="#9fb0c2" stroke-width="4" filter="url(#shadow)"/>
          <rect x="66" y="-74" width="68" height="44" fill="none" stroke="#ff7a00" stroke-width="4"/>
          <circle id="rim" cx="100" cy="-40" r="28" fill="none" stroke="#ff7a00" stroke-width="6"/>
          <path d="M124 -38 q-10 40 -24 82 q-12 -42 -24 -82" stroke="rgba(255,255,255,.9)" stroke-width="2" fill="none"/>
        </g>

        <!-- court floor + lines -->
        <g>
          <polygon points="100,560 1000,560 1100,700 0,700" fill="url(#wood)"/>
          <ellipse cx="550" cy="560" rx="190" ry="28" fill="none" stroke="rgba(255,165,0,.65)" stroke-width="6"/>
          <ellipse cx="550" cy="560" rx="120" ry="18" fill="none" stroke="rgba(255,165,0,.55)" stroke-width="6"/>
        </g>

        <!-- ball (bigger; no spin) -->
        <g id="ballGrp">
          <defs>
            <radialGradient id="ballGrad" cx="35%" cy="30%" r="70%">
              <stop offset="0%" stop-color="#ffb44d"/><stop offset="100%" stop-color="#e06724"/>
            </radialGradient>
          </defs>
          <circle id="ball" cx="550" cy="560" r="34" fill="url(#ballGrad)" stroke="#8a3b12" stroke-width="3"/>
          <path d="M528 560 h44 M550 538 v44" stroke="#8a3b12" stroke-width="2"/>
        </g>

        <!-- aim guide (points toward throw) -->
        <line id="aimLine" x1="550" y1="560" x2="650" y2="500" stroke="rgba(255,255,255,.6)" stroke-width="3" stroke-dasharray="8 8"/>
      </svg>

      <div id="bigmsg" class="bigmsg" aria-live="polite">GOAL!</div>
    </div>

    <div class="finish" id="finish" style="display:none">
      <span class="pill">Run Score: <strong id="finalScore">0</strong></span>
      <span class="pill">Coins Awarded: <strong id="finalCoins">0</strong></span>
      <span class="pill">Craft Credits: <strong id="finalCraft">0</strong></span>
      <a class="btn" href="/izza-game/minigames" id="againBtn">Play Again</a>
      <a class="btn" href="/izza-game/play" id="cityBtn2">Go to City</a>
    </div>
  </div>

  <script>
  (function(){
    /* ---------------- t param (same as Arena) ---------------- */
    const T_KEY='izzaTokenT';
    let T=new URLSearchParams(location.search).get('t')||'';
    try{
      if(T){ localStorage.setItem(T_KEY,T); }
      else{
        const s=localStorage.getItem(T_KEY)||'';
        if(s){
          const url=new URL(location.href);
          url.searchParams.set('t',s);
          history.replaceState(null,'',url.toString());
          T=s;
        }
      }
    }catch(_){}
    const withT=(href)=>{ if(!T) return href; const hasQ=href.includes('?'); return href+(hasQ?'&':'?')+'t='+encodeURIComponent(T); };
    // rewrite links
    document.getElementById('backBtn').href=withT('/izza-game/minigames');
    document.querySelectorAll('#cityBtn,#cityBtn2,#againBtn').forEach(a=>a.href=withT(a.getAttribute('href')));

    /* ---------------- helpers mirrored from Arena ---------------- */
    function bearerHeaders(base = {}) {
      const headers = Object.assign({ 'content-type':'application/json' }, base || {});
      try{
        const bearer = localStorage.getItem('izzaBearer') || '';
        if (bearer) headers['authorization'] = 'Bearer ' + bearer;
      }catch(_){}
      return headers;
    }

    async function fetchCharacterFresh(){
      try{
        const q = T ? `?t=${encodeURIComponent(T)}` : '';
        const r = await fetch('/izza-game/api/character'+q, { credentials:'include', headers: bearerHeaders() });
        if(r.ok){ const j=await r.json(); return j && typeof j==='object' ? j : null; }
      }catch(_){}
      return null;
    }

    async function ensureCharacter(){
      const lsProfile = (()=>{ try{ return JSON.parse(localStorage.getItem('izzaCharacter')||'null'); }catch(_){ return null; } })();
      const isAdminLocal = (()=> {
        try{
          const role=(localStorage.getItem('izzaRole')||'').toLowerCase();
          const user=(localStorage.getItem('izzaUser')||'').toLowerCase();
          return role==='admin'||user==='cammac';
        }catch(_){ return false; }
      })();

      const fresh = await fetchCharacterFresh();
      if (fresh && (fresh.hasCharacter || fresh.isAdmin || (fresh.user && fresh.user.isAdmin))) return fresh;

      if (isAdminLocal) {
        const fallback = lsProfile && typeof lsProfile === 'object'
          ? lsProfile
          : { hasCharacter:true, body_type:'male', skin_tone:'light', sprite_skin:'default' };
        return Object.assign({ hasCharacter:true }, fallback, { isAdmin:true });
      }

      const next = encodeURIComponent(withT('/izza-game/minigames/basketball'));
      location.replace('/izza-game/create?next='+next);
      throw new Error('redirecting');
    }

    function waitForPersistReady({timeout=3000, interval=40} = {}){
      return new Promise((res)=>{
        const t0=performance.now();
        const check=()=>{
          if(window.IZZA_PERSIST && typeof IZZA_PERSIST.load==='function') return res(true);
          if(performance.now()-t0>timeout) return res(false);
          setTimeout(check, interval);
        };
        if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', check, {once:true}); }
        else{ check(); }
      });
    }

    async function hydrateFromSnapshot(){
      try{
        await waitForPersistReady();
        if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function'){
          await IZZA_PERSIST.load(); // server → LS
        }
      }catch(_){}
      try{ writeCraftAll(readCraftAny()); }catch(_){}
    }

    /* ---- wallet helpers (identical logic) ---- */
    const CRAFT_KEYS=['izzaCrafting','craftingCredits','izzaCraftCredits'];
    function readCraftAny(){
      for(const k of CRAFT_KEYS){
        const v=parseInt(localStorage.getItem(k)||'0',10);
        if(Number.isFinite(v)&&v>0) return v|0;
      }
      return (parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10)||0)|0;
    }
    function writeCraftAll(v){
      const n=Math.max(0,v|0);
      for(const k of CRAFT_KEYS) localStorage.setItem(k,String(n));
      try{window.dispatchEvent(new Event('izza-crafting-changed'));}catch(_){}
    }

    /* ---- tiny avatar render (same ramp/tint as before) ---- */
    const tinyCtx=document.getElementById('avatarTiny').getContext('2d'); tinyCtx.imageSmoothingEnabled=false;
    function loadImg(src){ return new Promise(res=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
    const hexToRgb=h=>{ const n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; };
    const dist2=(a,b)=>{const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;};
    function paletteSwap(img, fromHex, toHex, tol=4000){
      const from=fromHex.map(hexToRgb), to=toHex.map(hexToRgb);
      const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
      const g=c.getContext('2d',{willReadFrequently:true}); g.imageSmoothingEnabled=false; g.drawImage(img,0,0);
      const d=g.getImageData(0,0,c.width,c.height); const p=d.data;
      for(let i=0;i<p.length;i+=4){ if(p[i+3]===0) continue;
        const q={r:p[i],g:p[i+1],b:p[i+2]}; let k=-1,sc=1e9;
        for(let j=0;j<from.length;j++){ const s=dist2(q,from[j]); if(s<sc){sc=s;k=j;} }
        if(sc<=tol){ const t=to[k]||to[1]||to[0]; p[i]=t.r;p[i+1]=t.g;p[i+2]=t.b; } }
      g.putImageData(d,0,0); return c;
    }
    const SPRITES={ body:{default:"/static/game/sprites/body/default.png"}, hair:{short:"/static/game/sprites/hair/short.png"}, outfit:{street:"/static/game/sprites/outfit/street.png"} };
    const SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
    const SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#6A402A","#432818"] };
    const HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"] };

    async function drawTinyAvatar(){
      let profile={};
      try{ profile=JSON.parse(localStorage.getItem('izzaCharacter')||'{}')||{}; }catch(_){}
      if(!profile || !profile.sprite_skin){
        const fresh = await fetchCharacterFresh();
        if (fresh) { profile=fresh; try{ localStorage.setItem('izzaCharacter', JSON.stringify(fresh)); }catch(_){} }
      }
      const tone=profile.skin_tone||'light', hairCol=profile.hair_color||'black';
      const body= await loadImg(SPRITES.body.default);
      const hair= await loadImg(SPRITES.hair.short);
      const outfit= await loadImg(SPRITES.outfit.street);
      tinyCtx.clearRect(0,0,42,42);
      if(body){ tinyCtx.drawImage(paletteSwap(body, SKIN_BASE, (SKIN_TO[tone]||SKIN_TO.light)), 0,0,42,42); }
      if(outfit){ tinyCtx.drawImage(outfit, 0,0,42,42); }
      if(hair){ tinyCtx.drawImage(paletteSwap(hair, ["#C8C8C8","#9C9C9C","#6E6E6E"], (HAIR_TO[hairCol]||HAIR_TO.black)), 0,0,42,42); }
    }

    /* ---------------- Game (mechanics) ---------------- */
    const svg = document.getElementById('court');
    const ball = document.getElementById('ball');
    const aimLine = document.getElementById('aimLine');
    const hoop = document.getElementById('hoop');
    const rim = document.getElementById('rim');
    const bigmsg = document.getElementById('bigmsg');
    const arenaEl = document.getElementById('arena');

    const scoreEl = document.getElementById('score');
    const streakEl = document.getElementById('streak');
    const timeEl = document.getElementById('time');
    const coinsRunEl = document.getElementById('coinsRun');

    let W = arenaEl.clientWidth, H = arenaEl.clientHeight;
    const toXY = (cx,cy) => ({x: cx/1100*W, y: cy/700*H});

    let game = {
      x:550, y:560, vx:0, vy:0, r:34,
      gravity: 1700, drag: 0.995,
      launched:false, canShoot:true,
      score:0, goals:0, timeLeft:60,
      hoopX:520, hoopY:350, distanceStep:0,
      timerId:null, ended:false
    };

    function setHoopDistance(step){
      game.distanceStep = step;
      const s = Math.max(0.6, 1.1 - step*0.08);   // scale down as it gets farther
      const y = game.hoopY - step*28;             // move up away from player
      hoop.setAttribute('transform', `translate(${game.hoopX}, ${y}) scale(${s})`);
    }
    function setBall(cx,cy){ ball.setAttribute('cx', cx); ball.setAttribute('cy', cy); }
    function showMsg(txt, cls){ bigmsg.textContent=txt; bigmsg.className='bigmsg show '+(cls||''); setTimeout(()=>bigmsg.className='bigmsg',520); }
    function startTimer(){ if(game.timerId) clearInterval(game.timerId); game.timerId=setInterval(()=>{ game.timeLeft--; timeEl.textContent=game.timeLeft; if(game.timeLeft<=0){ clearInterval(game.timerId); endRun(); } },1000); }

    function resetBall(){
      if(game.ended) return;
      game.x=550; game.y=560; game.vx=0; game.vy=0; game.launched=false; game.canShoot=true;
      setBall(game.x, game.y);
      aimLine.setAttribute('x1',game.x); aimLine.setAttribute('y1',game.y);
      aimLine.setAttribute('x2',game.x+90); aimLine.setAttribute('y2',game.y-70);
    }

    function physics(dt){
      if(!game.launched || game.ended) return;
      game.vy += game.gravity*dt;
      game.vx *= game.drag; game.vy *= game.drag;
      game.x += game.vx*dt; game.y += game.vy*dt;

      if(game.x < 110){ game.x=110; game.vx*=-0.6; }
      if(game.x > 990){ game.x=990; game.vx*=-0.6; }

      const floorY = toXY(0,560).y;
      if(game.y>floorY){
        game.y=floorY; game.vy*=-0.55; game.vx*=0.88;
        if(Math.abs(game.vy)<60){ game.vy=0; game.launched=false; setTimeout(resetBall, 320); }
      }
      setBall(game.x, game.y);
      checkHoop();
    }

    function checkHoop(){
      const rimPt = rim.getBoundingClientRect();
      const ballPt = ball.getBoundingClientRect();
      const rx = rimPt.left + rimPt.width/2;
      const ry = rimPt.top + rimPt.height/2;
      const bx = ballPt.left + ballPt.width/2;
      const by = ballPt.top + ballPt.height/2;
      const rRing = rimPt.width/2;
      const d = Math.hypot(bx-rx, by-ry);

      if(!game._scored && d < rRing-4 && game.vy>0){
        scoreShot(d < rRing*0.55);
        game._scored = true;
        setTimeout(()=>{ game._scored=false; }, 260);
      }
    }

    // +200 score & coins per goal; move hoop every 2 goals
    function scoreShot(swish){
      const add = 200;
      game.score += add;
      game.goals += 1;

      scoreEl.textContent = game.score;
      coinsRunEl.textContent = game.score;   // 1 coin per score point in this game
      streakEl.textContent = game.goals;

      showMsg('SCORE! +'+add, swish ? 'scoreGlow' : '');
      if(game.goals % 2 === 0) setHoopDistance(Math.min(8, game.distanceStep+1));
      setTimeout(resetBall, 240);
    }

    /* === Pokémon-style drag-back then flick-forward (simple) === */
    (function wireAim(){
      const samples=[];
      const MAX_WINDOW_MS=140;
      const MIN_PATH_PX=40;
      const POWER_SCALE=1.05;
      const MIN_UP_VY=-460;

      let dragging=false, startRect=null, startFirst=null;

      function setGuideTowardThrow(px,py){
        // Show guide in the throw direction (opposite of drag)
        const tx = game.x + (game.x - px);
        const ty = game.y + (game.y - py);
        aimLine.setAttribute('x1', game.x); aimLine.setAttribute('y1', game.y);
        aimLine.setAttribute('x2', tx);     aimLine.setAttribute('y2', ty);
      }

      function addSample(pt){
        const now=performance.now();
        const x=pt.clientX - startRect.left;
        const y=pt.clientY - startRect.top;
        samples.push({x,y,t:now});
        while(samples.length && now - samples[0].t > 220) samples.shift();
        setGuideTowardThrow(x,y);
      }

      const start = (e)=>{
        const pt=(e.touches?e.touches[0]:e);
        const b=ball.getBoundingClientRect();
        const inside = pt.clientX>=b.left && pt.clientX<=b.right && pt.clientY>=b.top && pt.clientY<=b.bottom;
        if(!inside || !game.canShoot || game.ended) return;
        dragging=true; samples.length=0; startRect=svg.getBoundingClientRect();
        startFirst={x: pt.clientX - startRect.left, y: pt.clientY - startRect.top, t: performance.now()};
        setGuideTowardThrow(startFirst.x, startFirst.y);
      };

      const move = (e)=>{ if(dragging) addSample(e.touches?e.touches[0]:e); };

      const end = (e)=>{
        if(!dragging) return; dragging=false;
        const now=performance.now();
        while(samples.length && now - samples[0].t > MAX_WINDOW_MS) samples.shift();
        if(samples.length<2) return;

        const firstTotal=startFirst;
        const last=samples[samples.length-1];
        const pathLen=Math.hypot(last.x-firstTotal.x,last.y-firstTotal.y);
        if(pathLen<MIN_PATH_PX) return;

        const a=samples[0], b=samples[samples.length-1];
        const dt=Math.max(1,b.t-a.t)/1000;
        // velocity of drag → throw opposite
        let vx=(a.x-b.x)/dt, vy=(a.y-b.y)/dt;
        if(vy>-MIN_UP_VY) vy=MIN_UP_VY;

        game.vx=vx*POWER_SCALE;
        game.vy=vy*POWER_SCALE;

        game.launched=true;
        game.canShoot=false;
        setTimeout(()=> game.canShoot=true, 140);
      };

      svg.addEventListener('mousedown', start, {passive:true});
      svg.addEventListener('mousemove', move, {passive:true});
      window.addEventListener('mouseup', end, {passive:true});
      svg.addEventListener('touchstart', start, {passive:true});
      svg.addEventListener('touchmove', move, {passive:true});
      svg.addEventListener('touchend', end, {passive:true});
    })();

    let lastT = performance.now();
    function loop(t){
      const dt = Math.min(0.033, (t - lastT) / 1000);
      lastT = t;
      physics(dt);
      if (!game.ended) requestAnimationFrame(loop);
    }

    /* ---------------- End-of-run + persist ---------------- */
    async function persistWalletAndSave(){
      try{
        writeCraftAll(readCraftAny());
        try{
          const h = parseInt(localStorage.getItem('izzaHearts')||'0',10);
          if (!Number.isFinite(h) || h<=0) {
            localStorage.setItem('izzaHearts','5');
            window.dispatchEvent(new Event('izza-hearts-changed'));
          }
        }catch(_){}
        if (window.IZZA_PERSIST && typeof IZZA_PERSIST.save === 'function'){
          await IZZA_PERSIST.save();
        } else if (typeof window._izzaForceSave === 'function') {
          window._izzaForceSave();
        }
      }catch(_){}
    }

    async function endRun(){
      if (game.ended) return;
      game.ended = true;

      // Coins = final score (200 per goal)
      const coinsEarn = game.score|0;

      // Crafting: +1 per 10 goals this run
      const craftEarn = Math.floor((game.goals||0)/10);

      const coinsNew  = (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0) + coinsEarn;
      const craftNew  = (readCraftAny()|0) + craftEarn;

      localStorage.setItem('izzaCoins', String(coinsNew));
      writeCraftAll(craftNew);

      try{ window.dispatchEvent(new Event('izza-coins-changed')); }catch(_){}
      try{ window.dispatchEvent(new Event('izza-wallet-changed'), { detail:{ coins:coinsNew, crafting:craftNew } }); }catch(_){}

      await persistWalletAndSave();

      document.getElementById('finalScore').textContent = game.score;
      document.getElementById('finalCoins').textContent = coinsEarn;
      document.getElementById('finalCraft').textContent = craftEarn;
      document.getElementById('finish').style.display = 'flex';
      showMsg('Time!', 'miss');
    }

    /* ---------------- wire nav like Arena (hydrate→save→go) ---------------- */
    function interceptNav(a){
      if(!a) return;
      a.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const href = withT(a.getAttribute('href') || '/izza-game/play');
        try{
          await hydrateFromSnapshot();
          await persistWalletAndSave();
        }catch(_){}
        // hard fallback so buttons always work
        setTimeout(()=>{ location.href = href; }, 60);
      }, {passive:false});
    }
    interceptNav(document.getElementById('cityBtn'));
    interceptNav(document.getElementById('cityBtn2'));
    interceptNav(document.getElementById('backBtn'));
    interceptNav(document.getElementById('againBtn'));

    /* ---------------- Boot (mirrors Arena order) ---------------- */
    function onResize(){ W=arenaEl.clientWidth; H=arenaEl.clientHeight; }
    window.addEventListener('resize', onResize, {passive:true});
    document.addEventListener('visibilitychange', () => { lastT = performance.now(); });

    (async function boot(){
      try{
        const profilePre = await ensureCharacter(); // may redirect to /create
        try{ localStorage.setItem('izzaCharacter', JSON.stringify(profilePre)); }catch(_){}
      }catch(e){ if(String(e.message)==='redirecting') return; }

      await hydrateFromSnapshot();
      await drawTinyAvatar();

      resetBall();
      setHoopDistance(0);
      startTimer();
      requestAnimationFrame(loop);
    })();
  })();
  </script>
</body>
</html>
