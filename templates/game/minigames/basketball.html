<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Street Basketball — IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Persist (same as Arena) -->
  <script>window.IZZA_PERSIST_BASE = 'https://izzagame.onrender.com';</script>

  <!-- Ensure username is known before izza-persist.js loads (same pattern as Arena) -->
  <script>
    (function(){
      try{
        const params = new URLSearchParams(location.search);
        let u = (params.get('u') || '').toString().trim();
        if (!u) u = (localStorage.getItem('izzaUserU') || '').toString().trim();
        if (!u) {
          const raw = localStorage.getItem('piAuthUser');
          if (raw) { try { u = (JSON.parse(raw)||{}).username || ''; } catch(_){} }
        }
        if (u) {
          u = u.replace(/^@+/, '').toLowerCase();
          window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
          window.izzaUserKey = { get: () => u };
          try { localStorage.setItem('izzaUserU', u); } catch(_){}
          try {
            if (!localStorage.getItem('piAuthUser')) {
              localStorage.setItem('piAuthUser', JSON.stringify({ username: u }));
            }
          } catch(_){}
        }
      }catch(_){}
    })();
  </script>

  <script src="/static/game/js/izza-persist.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --hud:rgba(0,0,0,.55); --hudLine:rgba(255,255,255,.18);
      --ok:#72ff9d; --warn:#ffd36b; --bad:#ff6b6b; --arcade:#ffed8a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#102;color:var(--txt);font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:10px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);
         background:var(--chip-bg);padding:8px 12px;border-radius:10px;color:inherit;text-decoration:none}
    .btn:hover{filter:brightness(1.06)}
    .arena{position:relative;height:74vh;min-height:540px;border:1px solid var(--line);
           border-radius:14px;background:#79c0ff;overflow:hidden}

    /* HUD */
    .hud{position:absolute;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;gap:4px;z-index:6;padding-right:8px;flex-wrap:nowrap}
    .hud .left,.hud .right{display:flex;gap:4px;align-items:center;flex-wrap:nowrap}
    .pill{background:var(--hud);border:1px solid var(--hudLine);backdrop-filter:blur(6px);
          padding:3px 7px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.2px;display:flex;gap:4px;align-items:center;white-space:nowrap}
    .pill strong{font-size:13px}
    .pill .arc{color:var(--arcade);text-shadow:0 2px 12px rgba(0,0,0,.4)}

    .aim{position:absolute;inset:0;z-index:3;touch-action:none;width:100%;height:100%}
    .bigmsg{position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);
            font-weight:900;letter-spacing:.6px;font-size:52px;opacity:.0;transition:opacity .2s, transform .2s;
            pointer-events:none;text-shadow:0 10px 34px rgba(0,0,0,.65);color:var(--arcade);z-index:7}
    .bigmsg.show{opacity:1;transform:translate(-50%, -56%) scale(1.04)}
    .scoreGlow{color:var(--ok)} .miss{color:var(--bad)}
    .finish{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .vignette:after{content:"";position:absolute;inset:0;pointer-events:none;z-index:5;
      background:radial-gradient(80% 70% at 50% 20%, rgba(0,0,0,0) 50%, rgba(0,0,0,.35) 100%);}

    /* Start overlay */
    .startOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:8;
      background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.45));}
    .startCard{background:rgba(0,0,0,.6);border:1px solid var(--hudLine);border-radius:14px;padding:16px 18px;
      display:flex;flex-direction:column;gap:10px;align-items:center}
    .startBtn{padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:var(--chip-bg);font-weight:800}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="top">
      <a class="btn" id="backBtn" href="/izza-game/minigames">← Back to Arena</a>
      <a class="btn" id="cityBtn" href="/izza-game/play">Enter IZZA City</a>
    </div>

    <div class="arena vignette" id="arena">
      <div class="hud">
        <div class="left">
          <div class="pill">SCORE: <strong id="score" class="arc">0</strong></div>
          <div class="pill">GOALS: <strong id="streak" class="arc">0</strong></div>
          <div class="pill">TIME: <strong id="time" class="arc">60</strong>s</div>
        </div>
        <div class="right">
          <div class="pill">COINS: <strong id="coinsRun" class="arc"></strong></div>
        </div>
      </div>

      <!-- START overlay -->
      <div id="startOverlay" class="startOverlay" aria-live="polite">
        <div class="startCard">
          <div class="pill">Wallet loaded: <strong id="startCoins" class="arc">…</strong></div>
          <button id="startBtn" class="startBtn">START</button>
        </div>
      </div>

      <!-- Scene SVG -->
      <svg id="court" class="aim" viewBox="0 0 1100 760" preserveAspectRatio="xMidYMid slice" aria-label="Court">
        <defs>
          <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#8bd1ff"/><stop offset="100%" stop-color="#bfe6ff"/>
          </linearGradient>
          <linearGradient id="wood" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#e6b77a"/><stop offset="100%" stop-color="#c78f4a"/>
          </linearGradient>
          <pattern id="fence" width="20" height="20" patternUnits="userSpaceOnUse" patternTransform="skewX(-10)">
            <path d="M0 10 L20 10" stroke="#cfd7e0" stroke-width="2" opacity=".55"/>
            <path d="M10 0 L10 20" stroke="#cfd7e0" stroke-width="2" opacity=".55"/>
          </pattern>
          <filter id="shadow"><feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="#000" flood-opacity=".35"/></filter>
        </defs>

        <rect x="0" y="0" width="1100" height="760" fill="url(#sky)"/>
        <ellipse cx="250" cy="520" rx="320" ry="140" fill="#8ed47d" opacity=".9"/>
        <ellipse cx="880" cy="520" rx="300" ry="130" fill="#89d074" opacity=".9"/>
        <g opacity=".9">
          <rect x="210" y="420" width="18" height="90" fill="#7c5a3a"/><circle cx="220" cy="420" r="60" fill="#5bbd5a"/>
          <rect x="920" y="420" width="18" height="90" fill="#7c5a3a"/><circle cx="930" cy="420" r="60" fill="#5bbd5a"/>
        </g>
        <g>
          <polygon points="0,470 1100,470 1100,520 0,520" fill="#6ea0cf"/>
          <polygon points="0,520 1100,520 1100,570 0,570" fill="#547fa8"/>
        </g>
        <rect x="0" y="260" width="1100" height="210" fill="url(#fence)" opacity=".55"/>

        <!-- Hoop -->
        <g id="hoop" transform="translate(390, 300) scale(1.6)">
          <rect x="90" y="-20" width="12" height="86" fill="#b7c7d8"/>
          <rect id="backboard" x="8" y="-126" width="184" height="122" rx="12" ry="12"
                fill="#f2f6fa" stroke="#9fb0c2" stroke-width="6" filter="url(#shadow)"/>
          <rect x="54" y="-86" width="92" height="60" fill="none" stroke="#ff7a00" stroke-width="6"/>
          <circle id="rim" cx="100" cy="-38" r="36" fill="none" stroke="#ff7a00" stroke-width="8"/>
          <path d="M132 -36 q-12 52 -28 104 q-14 -52 -28 -104" stroke="rgba(255,255,255,.9)" stroke-width="2.8" fill="none"/>
        </g>

        <!-- Floor -->
        <g>
          <rect x="0" y="520" width="1100" height="240" fill="url(#wood)"/>
          <polygon points="70,560 1030,560 1100,760 0,760" fill="url(#wood)"/>
          <ellipse cx="550" cy="640" rx="260" ry="36" fill="none" stroke="rgba(255,165,0,.65)" stroke-width="6"/>
          <ellipse cx="550" cy="640" rx="180" ry="26" fill="none" stroke="rgba(255,165,0,.55)" stroke-width="6"/>
        </g>

        <!-- Ball -->
        <g id="ballGrp">
          <defs>
            <radialGradient id="ballGrad" cx="35%" cy="30%" r="70%">
              <stop offset="0%" stop-color="#ffb44d"/><stop offset="100%" stop-color="#e06724"/>
            </radialGradient>
          </defs>
          <circle id="ball" cx="550" cy="700" r="76" fill="url(#ballGrad)" stroke="#8a3b12" stroke-width="4"/>
          <path d="M474 700 h152 M550 624 v152" stroke="#8a3b12" stroke-width="3"/>
        </g>
      </svg>

      <!-- avatar under ball REMOVED -->
      <!-- <div id="avatarScene" class="avatarBadge avatarScene">
        <canvas id="avatarTiny" class="avatarCanvas" width="54" height="54"></canvas>
      </div> -->

      <div id="bigmsg" class="bigmsg" aria-live="polite">GOAL!</div>
    </div>

    <div class="finish" id="finish" style="display:none">
      <span class="pill">Run Score: <strong id="finalScore">0</strong></span>
      <span class="pill">Coins Awarded: <strong id="finalCoins">0</strong></span>
      <span class="pill">Craft Credits: <strong id="finalCraft">0</strong></span>
      <a class="btn" href="/izza-game/minigames" id="againBtn">Play Again</a>
      <a class="btn" href="/izza-game/play" id="cityBtn2">Go to City</a>
    </div>
  </div>

  <script>
  (function(){
    /* ---------------- t & u params / links ---------------- */
    const T_KEY='izzaTokenT';
    const U_KEY='izzaUserU';
    const urlParams = new URLSearchParams(location.search);
    let T = urlParams.get('t') || '';
    let U = (urlParams.get('u') || '').toString().trim();

    try {
      if (U) {
        U = U.replace(/^@+/, '').toLowerCase();
        localStorage.setItem('izzaUserU', U);
      } else {
        const su = (localStorage.getItem('izzaUserU') || '').toString().trim();
        if (su) {
          const url = new URL(location.href);
          url.searchParams.set('u', su);
          history.replaceState(null, '', url.toString());
          U = su;
        }
      }
      if (U) {
        window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: U });
        window.izzaUserKey = { get: () => U };
      }
    } catch(_) {}

    try{
      if(T){ localStorage.setItem(T_KEY,T); }
      else{
        const s=localStorage.getItem(T_KEY)||'';
        if(s){
          const url=new URL(location.href);
          url.searchParams.set('t',s);
          history.replaceState(null,'',url.toString());
          T=s;
        }
      }
    }catch(_){}
    function withAuth(href){
      const url = new URL(href, location.origin);
      if (T) url.searchParams.set('t', T);
      if (U) url.searchParams.set('u', U);
      return url.pathname + (url.search ? url.search : '');
    }
    document.getElementById('backBtn').href = withAuth('/izza-game/minigames');
    document.querySelectorAll('#cityBtn,#cityBtn2,#againBtn').forEach(a=>{
      a.href = withAuth(a.getAttribute('href'));
    });

    /* ---------------- helpers ---------------- */
    function bearerHeaders(base = {}) {
      const headers = Object.assign({ 'content-type':'application/json' }, base || {});
      try{
        const bearer = localStorage.getItem('izzaBearer') || '';
        if (bearer) headers['authorization'] = 'Bearer ' + bearer;
      }catch(_){}
      return headers;
    }

    /* ---------------- Game (mechanics) ---------------- */
    const svg = document.getElementById('court');
    const ball = document.getElementById('ball');
    const hoop = document.getElementById('hoop');
    const rim = document.getElementById('rim');
    const bigmsg = document.getElementById('bigmsg');
    const arenaEl = document.getElementById('arena');

    const scoreEl = document.getElementById('score');
    const streakEl = document.getElementById('streak');
    const timeEl = document.getElementById('time');
    const coinsRunEl = document.getElementById('coinsRun');
    const startCoinsEl = document.getElementById('startCoins');

    let W = arenaEl.clientWidth, H = arenaEl.clientHeight;
    let runStartCoins = 0;

    function toXY(cx, cy){
      const vbW = 1100, vbH = 760;
      const scale = H / vbH;
      const drawnW = vbW * scale;
      const leftCrop = Math.max(0, (drawnW - W) / 2);
      return { x: cx * scale - leftCrop, y: cy * scale };
    }

    let game = {
      x:550, y:700, vx:0, vy:0, r:76,
      gravity: 2300, drag: 0.992,
      launched:false, dragging:false,
      score:0, goals:0,
      timeLeft:60,
      hoopX:390, hoopY:300, distanceStep:0,
      timerId:null, ended:false,
      creditsEarned:0,
      spin:0, spinDecay:0.985,
      noMissUntil: 0
    };

    function setHoopDistance(){ hoop.setAttribute('transform', `translate(${game.hoopX}, ${game.hoopY}) scale(1.6)`); }
    function setBall(cx,cy){ ball.setAttribute('cx', cx); ball.setAttribute('cy', cy); }
    function showMsg(txt, cls){ bigmsg.textContent=txt; bigmsg.className='bigmsg show '+(cls||''); setTimeout(()=>bigmsg.className='bigmsg',520); }
    function startTimer(){ if(game.timerId) clearInterval(game.timerId); game.timerId=setInterval(()=>{ game.timeLeft--; timeEl.textContent=game.timeLeft; if(game.timeLeft<=0){ clearInterval(game.timerId); endRun(); } },1000); }

    function resetBall(){
      if(game.ended) return;
      Object.assign(game, { x:550, y:700, vx:0, vy:0, launched:false, dragging:false, spin:0 });
      setBall(game.x, game.y);
    }

    /* ---- Drag + flick ---- */
    (function wireAim(){
      const samples=[];
      const MAX_WINDOW_MS=150;
      const POWER_SCALE=0.94;
      const MIN_UP_VY=-520;

      let startRect=null, startPos=null, lastAngle=null, spinAccum=0;

      function addSample(pt){
        const now=performance.now();
        const x=pt.clientX - startRect.left;
        const y=pt.clientY - startRect.top;
        samples.push({x,y,t:now});
        while(samples.length && now - samples[0].t > 260) samples.shift();

        if(game.dragging && !game.launched){
          const dx=x - startPos.x, dy=y - startPos.y;
          const pullMax=220; const d=Math.hypot(dx,dy);
          const k=d>pullMax ? pullMax/d : 1;
          setBall(game.x = 550 + dx*k*0.9, game.y = 700 + dy*k*0.9);

          const ang = Math.atan2(dy,dx);
          if(lastAngle!=null){
            let da = ang - lastAngle;
            if(da> Math.PI) da-=2*Math.PI;
            if(da<-Math.PI) da+=2*Math.PI;
            spinAccum += da;
          }
          lastAngle = ang;
        }
      }

      const start = (e)=>{
        if(game.ended) return;
        const pt=(e.touches?e.touches[0]:e);
        const b=ball.getBoundingClientRect();
        const inside = pt.clientX>=b.left && pt.clientX<=b.right && pt.clientY>=b.top && pt.clientY<=b.bottom;
        if(!inside) return;
        startRect=svg.getBoundingClientRect();
        startPos={x: pt.clientX - startRect.left, y: pt.clientY - startRect.top};
        samples.length=0; lastAngle=null; spinAccum=0;
        game.dragging=true; game.launched=false;
        addSample(pt);
      };

      const move = (e)=>{ if(!game.dragging) return; addSample(e.touches?e.touches[0]:e); };
      const end  = ()=>{ if(!game.dragging) return; game.dragging=false;

        const now=performance.now();
        while(samples.length && now - samples[0].t > MAX_WINDOW_MS) samples.shift();
        if(samples.length<2){ resetBall(); return; }

        const a=samples[0], b=samples[samples.length-1];
        const dt=Math.max(1,b.t-a.t)/1000;
        let vx=(b.x-a.x)/dt, vy=(b.y-a.y)/dt;

        if(vy>-MIN_UP_VY) vy=MIN_UP_VY;

        game.vx=vx*POWER_SCALE;
        game.vy=vy*POWER_SCALE;

        const SPIN_THRESHOLD = 0.60;
        game.spin = (Math.abs(spinAccum) > SPIN_THRESHOLD) ? spinAccum : 0;

        game.launched=true;
      };

      svg.addEventListener('mousedown', start, {passive:true});
      svg.addEventListener('mousemove', move, {passive:true});
      window.addEventListener('mouseup', end, {passive:true});
      svg.addEventListener('touchstart', start, {passive:true});
      svg.addEventListener('touchmove', move, {passive:true});
      svg.addEventListener('touchend', end, {passive:true});
    })();

    const TOP_OUT = -600;
    const MISS_BAND_PX = 400;

    function physics(dt){
      if(!game.launched || game.ended) return;

      game.vy += game.gravity*dt;

      if(Math.abs(game.spin) > 0.001){
        const side = Math.max(-900, Math.min(900, game.spin*260));
        game.vx += (side * dt);
        game.spin *= Math.pow(game.spinDecay, Math.max(1, dt*60));
      }

      game.vx *= game.drag; game.vy *= game.drag;
      game.x += game.vx*dt; game.y += game.vy*dt;

      if(game.x < 110){ game.x=110; game.vx*=-0.6; }
      if(game.x > 990){ game.x=990; game.vx*=-0.6; }

      if(game.y < TOP_OUT && performance.now() > game.noMissUntil){
        quickMiss(); return;
      }

      const floorY = toXY(0,720).y;
      if(game.y>floorY){
        game.y=floorY; game.vy=0; game.vx=0; game.launched=false;
        setTimeout(resetBall, 280);
      }

      setBall(game.x, game.y);
      checkHoopOrMiss();
    }

    function checkHoopOrMiss(){
      const rimPt = rim.getBoundingClientRect();
      const ballPt = ball.getBoundingClientRect();
      const rx = rimPt.left + rimPt.width/2;
      const ry = rimPt.top + rimPt.height/2;
      const bx = ballPt.left + ballPt.width/2;
      const by = ballPt.top + ballPt.height/2;
      const rRing = rimPt.width/2;
      const d = Math.hypot(bx-rx, by-ry);

      const fudge = rRing * 0.18;

      if(!game._scored && d < (rRing + fudge) && game.vy>0){
        const swish = d < rRing*0.55 && Math.abs(game.vx) < 900;
        scoreShot(swish);
        game._scored = true;
        game.noMissUntil = performance.now() + 350;
        setTimeout(()=>{ game._scored=false; }, 300);
        return;
      }

      if(game.launched && !game._scored && game.vy>0 && performance.now() > game.noMissUntil){
        if (by > (ry + MISS_BAND_PX)){
          quickMiss();
        }
      }
    }

    function quickMiss(){
      if (game._scored || performance.now() < game.noMissUntil) return;
      game.launched=false;
      showMsg('MISS!', 'miss');
      setTimeout(resetBall, 220);
    }

    /* ===== WALLET: Arena-parity (simple & identical) ===== */
    (function(){
      /* carry t & u like Arena already does */
      function withAuthLocal(path){
        const url = new URL(path, location.origin);
        try{
          const qs = new URLSearchParams(location.search);
          const t  = qs.get('t') || localStorage.getItem('izzaTokenT') || '';
          const u  = (qs.get('u') || localStorage.getItem('izzaUserU') || '').toString().trim();
          if (t) url.searchParams.set('t', t);
          if (u) url.searchParams.set('u', u);
        }catch(_){}
        return url.pathname + (url.search ? url.search : '');
      }

      function bearerHeadersLocal(base = {}) {
        const headers = Object.assign({ 'content-type':'application/json' }, base || {});
        try{
          const bearer = localStorage.getItem('izzaBearer') || '';
          if (bearer) headers['authorization'] = 'Bearer ' + bearer;
        }catch(_){}
        return headers;
      }

      const CRAFT_KEYS = ['izzaCrafting','craftingCredits','izzaCraftCredits'];
      function readCraftAny(){
        for(const k of CRAFT_KEYS){
          const v = parseInt(localStorage.getItem(k)||'0',10);
          if (Number.isFinite(v) && v>0) return v|0;
        }
        return (parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10) || 0)|0;
      }
      function writeCraftAll(v){
        const n = Math.max(0, v|0);
        for(const k of CRAFT_KEYS) localStorage.setItem(k, String(n));
        try{ window.dispatchEvent(new Event('izza-crafting-changed')); }catch(_){}
      }
      (function normalizeCraft(){ writeCraftAll(readCraftAny()); })();

      function waitForPersistReady({timeout=3000, interval=40} = {}){
        return new Promise((res)=> {
          const t0 = performance.now();
          const check = () => {
            if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function') return res(true);
            if (performance.now() - t0 > timeout) return res(false);
            setTimeout(check, interval);
          };
          if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', check, {once:true});
          else check();
        });
      }

      function parseWalletResponse(j){
        if (!j || typeof j !== 'object') return { coins:0, crafting:0 };
        if ('coins' in j || 'crafting' in j || 'credits' in j){
          return { coins: Number(j.coins)||0, crafting: Number(j.crafting ?? j.credits)||0 };
        }
        if (j.wallet)   return parseWalletResponse(j.wallet);
        if (j.balance)  return parseWalletResponse(j.balance);
        return { coins:0, crafting:0 };
      }

      function readLocalWallet(){
        const coins = Number.isFinite(Number(localStorage.getItem('izzaCoins')))
          ? Number(localStorage.getItem('izzaCoins')) : 0;
        const craft = readCraftAny();
        return { coins, crafting: craft };
      }

      const coinsRunEl   = document.getElementById('coinsRun');
      const startCoinsEl = document.getElementById('startCoins');
      let LAST_WALLET = readLocalWallet();

      function renderWallet(obj){
        if (!obj) return;
        let coins = Number(obj.coins)||0;
        let crafting = Number(obj.crafting)||0;
        if (coins === 0 && LAST_WALLET.coins > 0) coins = LAST_WALLET.coins;
        if (crafting === 0 && LAST_WALLET.crafting > 0) crafting = LAST_WALLET.crafting;

        if (coinsRunEl)   coinsRunEl.textContent   = String(coins);
        if (startCoinsEl) startCoinsEl.textContent = String(coins);

        LAST_WALLET = { coins, crafting };
      }

      async function hydrateFromSnapshot(){
        try{
          await waitForPersistReady();
          if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function'){
            await IZZA_PERSIST.load();  // server -> localStorage
          }
        }catch(_){}
        try{ writeCraftAll(readCraftAny()); }catch(_){}
        renderWallet(readLocalWallet());
      }

      async function refreshWalletFromAPI(){
        try{
          const r = await fetch(withAuthLocal('/izza-game/api/wallet'), {
            credentials:'include',
            headers: bearerHeadersLocal()
          });
          if (r.ok){
            let j={}; try{ j = await r.json(); }catch(_){}
            const parsed = parseWalletResponse(j);
            try{
              localStorage.setItem('izzaCoins', String(Number(parsed.coins)||0));
              writeCraftAll(Number(parsed.crafting)||0);
              window.dispatchEvent(new Event('izza-coins-changed'));
              window.dispatchEvent(new Event('izza-crafting-changed'));
            }catch(_){}
            renderWallet(parsed);
          } else {
            renderWallet(readLocalWallet());
          }
        }catch(_){
          renderWallet(readLocalWallet());
        }
      }

      // tiny helpers that the game uses when awarding
      window._izzaWallet = {
        addCoins: async (delta)=>{
          const cur = (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0) + (delta|0);
          localStorage.setItem('izzaCoins', String(cur));
          try{
            window.dispatchEvent(new Event('izza-coins-changed'));
            window.dispatchEvent(new CustomEvent('izza-wallet-changed', { detail:{ coins:cur, crafting:readCraftAny() } }));
          }catch(_){}
          renderWallet({ coins:cur, crafting:readCraftAny() });
          try{ if (window.IZZA_PERSIST?.save) window.IZZA_PERSIST.save(); }catch(_){}
          return cur;
        },
        addCraft: async (delta)=>{
          const v = readCraftAny() + (delta|0);
          writeCraftAll(v);
          try{
            window.dispatchEvent(new CustomEvent('izza-wallet-changed', { detail:{ coins:parseInt(localStorage.getItem('izzaCoins')||'0',10)|0, crafting:v } }));
          }catch(_){}
          try{ if (window.IZZA_PERSIST?.save) window.IZZA_PERSIST.save(); }catch(_){}
        }
      };

      (async function bootWallet(){
        try{ await hydrateFromSnapshot(); }catch(_){}
        try{ await refreshWalletFromAPI(); }catch(_){}

        // keep in sync (same as Arena)
        window.addEventListener('izza-wallet-changed', (ev)=>{
          const d = ev && ev.detail ? ev.detail : {};
          const local = readLocalWallet();
          renderWallet({ coins: d.coins ?? local.coins, crafting: d.crafting ?? d.credits ?? local.crafting });
        }, { passive:true });

        window.addEventListener('izza-coins-changed',   ()=> renderWallet(readLocalWallet()), { passive:true });
        window.addEventListener('izza-crafting-changed',()=> renderWallet(readLocalWallet()), { passive:true });

        window.addEventListener('storage', (e)=>{
          if (!e) return;
          if (e.key==='izzaCoins' || CRAFT_KEYS.includes(e.key)) renderWallet(readLocalWallet());
        }, { passive:true });

        document.addEventListener('visibilitychange', async ()=>{
          if (!document.hidden){
            try{ await hydrateFromSnapshot(); }catch(_){}
            renderWallet(readLocalWallet());
          }
        }, { passive:true });

        window.addEventListener('pageshow', ()=> renderWallet(readLocalWallet()), { passive:true });
      })();
    })();

    /* ===== scoring uses wallet helpers ===== */
    async function scoreShot(swish){
      const COINS_PER_GOAL = 200;

      game.score += COINS_PER_GOAL;
      game.goals += 1;

      await window._izzaWallet.addCoins(COINS_PER_GOAL);

      const creditsNow = Math.floor(game.goals / 10);
      if (creditsNow > game.creditsEarned){
        game.creditsEarned = creditsNow;
        await window._izzaWallet.addCraft(1);
        showMsg('+1 CRAFT CREDIT!', 'scoreGlow');
      } else {
        showMsg(swish ? 'GOAL! +200' : 'SCORE! +200', swish ? 'scoreGlow' : '');
      }

      scoreEl.textContent = game.score;
      streakEl.textContent = game.goals;

      setTimeout(resetBall, 260);
    }

    let lastT = performance.now();
    function loop(t){
      const dt = Math.min(0.033, (t - lastT) / 1000);
      lastT = t;
      physics(dt);
      if (!game.ended) requestAnimationFrame(loop);
    }

    /* ---------------- End-of-run ---------------- */
    async function endRun(){
      if (game.ended) return;
      game.ended = true;

      try{ if (game.timerId) clearInterval(game.timerId); }catch(_){}
      game.launched = false;
      game.dragging = false;

      const coinsNow = (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0);
      const coinsAwarded = Math.max(0, (coinsNow|0) - (runStartCoins|0));

      document.getElementById('finalScore').textContent = game.score;
      document.getElementById('finalCoins').textContent = coinsAwarded;
      document.getElementById('finalCraft').textContent = game.creditsEarned;
      document.getElementById('finish').style.display = 'flex';
      showMsg('Time!', 'miss');

      try{ if (window.IZZA_PERSIST?.save) await IZZA_PERSIST.save(); }catch(_){}
    }

    /* ---------------- Nav (save best-effort before leaving) ---------------- */
    function interceptNav(a){
      if(!a) return;
      a.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const href = withAuth(a.getAttribute('href') || '/izza-game/play');
        try{ if (window.IZZA_PERSIST?.save) await IZZA_PERSIST.save(); }catch(_){}
        location.href = href;
      }, {passive:false});
    }
    interceptNav(document.getElementById('cityBtn'));
    interceptNav(document.getElementById('cityBtn2'));
    interceptNav(document.getElementById('backBtn'));
    interceptNav(document.getElementById('againBtn'));

    /* ---------------- Boot ---------------- */
    function onResize(){ W=arenaEl.clientWidth; H=arenaEl.clientHeight; }
    window.addEventListener('resize', onResize, {passive:true});

    (async function boot(){
      try{
        // Place scene
        resetBall();
        setHoopDistance();

        // Start overlay button
        document.getElementById('startBtn').addEventListener('click', async ()=>{
          // snapshot current coins at the moment we start the run
          runStartCoins = parseInt(localStorage.getItem('izzaCoins')||'0',10)|0;
          document.getElementById('startOverlay').style.display='none';
          startTimer();
          requestAnimationFrame(loop);
        }, {passive:true});
      }catch(e){
        if(String(e.message)!=='redirecting'){
          console.error('Basketball init error', e);
        }
      }
    })();
  })();
  </script>
</body>
</html>
