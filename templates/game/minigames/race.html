<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Street Race — IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <script>window.IZZA_PERSIST_BASE='https://izzagame.onrender.com';</script>
  <script src="/static/game/js/izza-persist.js"></script>
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root { --bg:#0a0c12; --panel:#06080e; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#e8eef7;font-family:Arial,Helvetica,sans-serif}
    .arena{position:relative;height:100vh;max-width:520px;margin:0 auto;
      border-left:1px solid rgba(255,255,255,.08);
      border-right:1px solid rgba(255,255,255,.08);
      background:var(--panel);overflow:hidden}
    .hud{position:absolute;top:10px;left:12px;right:12px;z-index:6;
      display:flex;justify-content:space-between;font-size:13px;letter-spacing:.3px}
    .nitroBtn{position:absolute;right:12px;bottom:16px;z-index:7;border-radius:999px;
      border:1px solid rgba(255,255,255,.1);background:#182033;padding:12px 18px;
      font-weight:800;color:white}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:8;
      background:linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,.55));}
    .card{background:rgba(10,12,18,.95);border:1px solid rgba(255,255,255,.16);border-radius:14px;
      padding:16px 18px;display:flex;flex-direction:column;gap:12px;width:min(92%,460px)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .preview{height:164px;border:1px dashed rgba(255,255,255,.18);border-radius:12px;
      display:flex;align-items:center;justify-content:center;overflow:hidden}
    .startBtn{padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.08);font-weight:800;color:white;width:100%}
    .swatches{display:flex;gap:10px;flex-wrap:wrap}
    .swatch{width:26px;height:26px;border-radius:50%;border:2px solid rgba(255,255,255,.28);cursor:pointer}
    .swatch.active{box-shadow:0 0 0 3px rgba(255,255,255,.18) inset}
    canvas{display:block;width:100%;height:100%}
  </style>
</head>
<body>
  <div class="arena" id="arena">
    <div class="hud">
      <div>SPEED: <span id="speed">0</span> km/h</div>
      <div>DIST: <span id="dist">0</span> m</div>
      <div>COINS: <span id="coinsRun">0</span></div>
    </div>

    <!-- Garage -->
    <div id="startOverlay" class="overlay">
      <div class="card">
        <h3 style="margin:0">Garage</h3>
        <div class="row" style="opacity:.9;font-size:12px">
          Coins: <b id="wCoins">—</b> &nbsp; | &nbsp; Crafting: <b id="wCraft">—</b>
        </div>
        <div class="preview">
          <canvas id="garagePreview" width="512" height="256"></canvas>
        </div>
        <div>
          <div style="font-size:12px;margin:6px 0 8px">Paint (tint)</div>
          <div class="swatches" id="swatches"></div>
        </div>
        <button id="startBtn" class="startBtn">START</button>
      </div>
    </div>

    <button class="nitroBtn" id="nitroBtn">NITRO</button>
    <canvas id="scene"></canvas>
  </div>

<script>
(() => {
/* ============== Wallet ============== */
async function loadWallet(){
  let coins='—', craft='—';
  try{
    if (window.IZZA && typeof IZZA.get === 'function') {
      const w = await IZZA.get('wallet');
      if (w) { coins = w.coins ?? coins; craft = w.crafting ?? craft; }
    } else if (localStorage.getItem('izza_wallet')){
      const w = JSON.parse(localStorage.getItem('izza_wallet'));
      coins = w.coins ?? coins; craft = w.crafting ?? craft;
    }
  }catch(e){}
  document.getElementById('wCoins').textContent = coins;
  document.getElementById('wCraft').textContent = craft;
}
loadWallet();

/* ============== Setup ============== */
const arena  = document.getElementById('arena');
const canvas = document.getElementById('scene');
const ctx    = canvas.getContext('2d', { alpha:true });
ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = 'high';

const HUD = {
  speed: document.getElementById('speed'),
  dist : document.getElementById('dist'),
  coins: document.getElementById('coinsRun')
};

const SHOW_SIDELINES = false;

/* ============== Sizing / Camera ============== */
let dpr=1, W=0, H=0;
let horizonY=0, roadBottomHalf=0, roadTopHalf=0;

function resize(){
  W = arena.clientWidth;
  H = arena.clientHeight;
  dpr = Math.min(window.devicePixelRatio || 1, 2);
  canvas.width  = Math.floor(W * dpr);
  canvas.height = Math.floor(H * dpr);
  canvas.style.width  = W + 'px';
  canvas.style.height = H + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // Low camera, huge foreground
  horizonY       = H*0.26;
  roadBottomHalf = W*1.15;
  roadTopHalf    = W*0.12;

  updateCarPlacement();
}
window.addEventListener('resize', resize, {passive:true});

/* ============== Assets & Tint (offscreen) ============== */
const carImg = new Image();
carImg.src = '/static/game/sprites/tracks/coupe.png';

function makeTintedSprite(rgb){
  if (!carImg.complete || !carImg.width) return null;
  const off = document.createElement('canvas');
  off.width  = carImg.width;
  off.height = carImg.height;
  const o = off.getContext('2d');
  o.imageSmoothingEnabled = true;

  // base
  o.drawImage(carImg, 0, 0);
  // multiply tint
  o.globalCompositeOperation = 'multiply';
  o.fillStyle = `rgb(${rgb.r},${rgb.g},${rgb.b})`;
  o.fillRect(0,0,off.width,off.height);
  // mask to alpha (kills any box)
  o.globalCompositeOperation = 'destination-in';
  o.drawImage(carImg, 0, 0);
  // preserve speculars a touch
  o.globalCompositeOperation = 'overlay';
  o.fillStyle = 'rgba(255,255,255,0.08)';
  o.fillRect(0,0,off.width,off.height);
  o.globalCompositeOperation = 'source-over';
  return off;
}

/* ============== Garage Paint ============== */
const PAINTS = [
  {name:'Cherry',    r:255, g:70,  b:70 },
  {name:'Sunburst',  r:255, g:190, b:40 },
  {name:'Neo Blue',  r:90,  g:180, b:255},
  {name:'Lime',      r:120, g:230, b:90 },
  {name:'Violet',    r:170, g:120, b:255},
  {name:'Graphite',  r:185, g:195, b:205}
];
let paint = JSON.parse(localStorage.getItem('izza_paint')||'null') || PAINTS[0];
let tintedSprite = null;

const swatches = document.getElementById('swatches');
PAINTS.forEach(p=>{
  const d = document.createElement('div');
  d.className = 'swatch';
  d.style.background = `rgb(${p.r},${p.g},${p.b})`;
  if (p.name===paint.name) d.classList.add('active');
  d.title = p.name;
  d.onclick = ()=>{
    paint = p;
    localStorage.setItem('izza_paint', JSON.stringify(paint));
    [...swatches.children].forEach(x=>x.classList.remove('active'));
    d.classList.add('active');
    rebuildTintAndPreview();
  };
  swatches.appendChild(d);
});

const prev = document.getElementById('garagePreview');
const pctx = prev.getContext('2d');
const GARAGE_GLOW = true; // set to false to remove even the ellipse

function rebuildTintAndPreview(){
  tintedSprite = makeTintedSprite(paint);
  if (!tintedSprite) return;

  pctx.clearRect(0,0,prev.width,prev.height);
  const pad = 8;
  const availW = prev.width - pad*2;
  const scale  = Math.min(availW / carImg.width, (prev.height-pad*2) / carImg.height);
  const w = Math.round(carImg.width * scale);
  const h = Math.round(carImg.height * scale);
  const x = Math.round((prev.width - w)/2);
  const y = Math.round((prev.height - h)/2);

  // soft elliptical ground glow (no rectangle)
  if (GARAGE_GLOW){
    const cx = x + w/2, cy = y + h*0.92, rx = w*0.42, ry = h*0.10;
    const g = pctx.createRadialGradient(cx,cy,1,cx,cy,Math.max(rx,ry));
    g.addColorStop(0, `rgba(${paint.r},${paint.g},${paint.b},.22)`);
    g.addColorStop(1, `rgba(${paint.r},${paint.g},${paint.b},0)`);
    pctx.fillStyle = g;
    pctx.beginPath();
    pctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
    pctx.fill();
  }

  pctx.drawImage(tintedSprite, x, y, w, h);
}
carImg.onload = rebuildTintAndPreview;

/* ============== Projection ============== */
const lerp = (a,b,t)=>a+(b-a)*t;
function project(z){
  const k = 0.0105;                     // deep runway
  const t = 1 - Math.exp(-k*z);
  const y = lerp(horizonY, H, t);
  const half = lerp(roadTopHalf, roadBottomHalf, t);
  return { y, half, t };
}

/* ============== Background & Road ============== */
function drawSky(){
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, '#0c1120');
  g.addColorStop(0.35, '#0f1523');
  g.addColorStop(1, '#090d14');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
}

/* road uses same rails as LED dots and vanishes well past horizon */
function drawRoad(worldZ){
  const vanishY = horizonY - 160;     // push tip up; no visible “horizon band”
  const railOff = 1.05;

  // Build left/right edge points from near to far
  const ptsLeft=[], ptsRight=[];
  const steps = 40, stepZ = 120;
  for (let i=0;i<=steps;i++){
    const z = i*stepZ;
    const p = project(z);
    const y = (i===steps) ? vanishY : Math.max(p.y, vanishY);
    const half = (i===steps) ? 0.0001 : p.half;
    const lx = W/2 - half*railOff - 8;
    const rx = W/2 + half*railOff + 8;
    if (y >= vanishY){ ptsLeft.push([lx,y]); ptsRight.push([rx,y]); }
  }

  // Asphalt polygon
  const g = ctx.createLinearGradient(0, vanishY, 0, H);
  g.addColorStop(0, '#0f141d');
  g.addColorStop(1, '#0a0f17');
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.moveTo(W/2, vanishY);
  for (let i=ptsRight.length-1;i>=0;i--){ const [x,y]=ptsRight[i]; ctx.lineTo(x,y>H?H:y); }
  for (let i=0;i<ptsLeft.length;i++){ const [x,y]=ptsLeft[i]; ctx.lineTo(x,y); }
  ctx.closePath(); ctx.fill();

  // Lane streaks to infinity
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  ctx.lineWidth = 6; ctx.lineCap='round';
  const lanes = [-0.32, 0, 0.32];
  for (const L of lanes){
    for (let z = (worldZ%26)*-1; z<4500; z+=26){
      const p0 = project(Math.max(0,z));
      const p1 = project(Math.max(0,z+18));
      if (p1.y<vanishY) continue; if (p0.y>H && p1.y>H) break;
      const x0 = W/2 + L * p0.half*1.6;
      const x1 = W/2 + L * p1.half*1.6;
      const y0 = Math.max(p0.y, vanishY), y1 = Math.max(p1.y, vanishY);
      ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x1, y1); ctx.stroke();
    }
  }

  if (SHOW_SIDELINES){
    ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(250,255,255,.96)';
    ctx.beginPath();
    ctx.moveTo(W/2 - roadTopHalf, horizonY); ctx.lineTo(0, H);
    ctx.moveTo(W/2 + roadTopHalf, horizonY); ctx.lineTo(W, H);
    ctx.stroke();
  }

  // LED rails
  ctx.fillStyle = 'rgba(255,90,50,0.92)';
  const spacingM = 16;
  for (let z = (worldZ%spacingM)*-1; z < 2600; z += spacingM){
    const p = project(Math.max(0,z));
    const y = Math.max(p.y, vanishY); if (y>H) break;
    const r = Math.max(1, 3 * (1 - (y - vanishY)/(H-vanishY)));
    const lx = W/2 - p.half*railOff - 8;
    const rx = W/2 + p.half*railOff + 8;
    ctx.beginPath(); ctx.arc(lx, y, r, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(rx, y, r, 0, Math.PI*2); ctx.fill();
  }
}

/* ============== Car ============== */
let carW=0, carH=0, carX=0, carY=0;
function updateCarPlacement(){
  carW = Math.min(W*0.92, 540);
  const ratio = (carImg.height||512) / (carImg.width||1024);
  carH = carW * ratio;
  carX = Math.round((W - carW)/2);
  carY = Math.round(H - carH*1.02);
}

/* --- FX drawn into offscreen canvas to avoid any rect artifacts --- */
function buildCarFXCanvas(nitroBoost, t){
  const fx = document.createElement('canvas');
  fx.width = Math.max(2, Math.floor(carW));
  fx.height = Math.max(2, Math.floor(carH));
  const c = fx.getContext('2d');
  c.imageSmoothingEnabled = true;

  // Tail-lights
  const flick = 0.75 + 0.25*Math.sin(t*12);
  const lightY = carH*0.56;
  const leftX  = carW*0.23;
  const rightX = carW*0.73;

  c.globalCompositeOperation = 'lighter';
  c.shadowBlur = 24;
  c.shadowColor = `rgba(255,60,40,${0.85*flick})`;
  c.fillStyle   = `rgba(255,70,50,${0.55*flick})`;

  const lamp = (x) => {
    c.beginPath();
    c.moveTo(x-18, lightY);
    c.lineTo(x+18, lightY);
    c.lineTo(x+8,  lightY+10);
    c.lineTo(x-8,  lightY+10);
    c.closePath(); c.fill();
  };
  lamp(leftX); lamp(rightX);

  // Exhaust flames
  const flame = (nitroBoost? 1.0 : 0.35) * (0.7+0.3*Math.sin(t*20));
  c.shadowBlur  = 28;
  c.shadowColor = `rgba(${paint.r},${paint.g},${paint.b},1)`;
  c.fillStyle   = `rgba(${paint.r},${paint.g},${paint.b},${0.22+0.35*flame})`;

  const jet = (x) => {
    c.beginPath();
    c.moveTo(x, carH*0.86);
    c.quadraticCurveTo(x-12, carH*0.96, x, carH*1.08);
    c.quadraticCurveTo(x+12, carH*0.96, x, carH*0.86);
    c.closePath(); c.fill();
  };
  jet(carW*0.38);
  jet(carW*0.62);

  return fx;
}

let time = 0;
function drawCar(nitroBoost){
  const src = tintedSprite || carImg;
  ctx.drawImage(src, carX, carY, carW, carH);        // body (already alpha masked)
  const fx = buildCarFXCanvas(nitroBoost, time);     // draw FX offscreen
  ctx.globalCompositeOperation = 'lighter';
  ctx.drawImage(fx, carX, carY);                     // composite with light add
  ctx.globalCompositeOperation = 'source-over';
}

/* ============== Input ============== */
const steer = { x:0 };
canvas.addEventListener('pointerdown', e=>{
  const x = e.clientX - canvas.getBoundingClientRect().left;
  steer.x = (x < W/2) ? -1 : 1;
});
canvas.addEventListener('pointermove', e=>{
  if (e.buttons) {
    const x = e.clientX - canvas.getBoundingClientRect().left;
    steer.x = (x < W/2) ? -1 : 1;
  }
});
window.addEventListener('pointerup', ()=>{ steer.x=0; });
window.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft')  steer.x=-1;
  if(e.key==='ArrowRight') steer.x=1;
});
window.addEventListener('keyup', e=>{
  if(e.key==='ArrowLeft'||e.key==='ArrowRight') steer.x=0;
});

/* ============== Loop ============== */
let worldZ = 0, nitroLeft = 0, last = performance.now();
const state = { running:false, speed:0, dist:0 };

function frame(now){
  if(!state.running) return;
  const dt = Math.min(0.033, (now - last)/1000); last = now;
  time += dt;

  const target = 180 + (nitroLeft>0 ? 140 : 0);
  state.speed += (target - state.speed) * 0.08;
  if (nitroLeft>0) nitroLeft -= dt;

  const mps = state.speed / 3.6;
  worldZ += mps * dt;
  state.dist += mps * dt;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawSky();
  drawRoad(worldZ);
  carX += steer.x * 0.9; carX = Math.max(0, Math.min(W-carW, carX));
  drawCar(nitroLeft>0);

  HUD.speed.textContent = Math.round(state.speed);
  HUD.dist.textContent  = Math.round(state.dist);
  HUD.coins.textContent = 0;

  requestAnimationFrame(frame);
}

document.getElementById('nitroBtn').addEventListener('click', ()=>{ nitroLeft = 2.0; });

document.getElementById('startBtn').addEventListener('click',()=>{
  document.getElementById('startOverlay').style.display='none';
  resize();
  tintedSprite = makeTintedSprite(paint);
  state.running = true;
  state.speed = 90; state.dist = 0; worldZ = 0; last = performance.now();
  requestAnimationFrame(frame);
});

/* init */
resize();
rebuildTintAndPreview();
})();
</script>
</body>
</html>
