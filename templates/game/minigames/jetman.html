<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Jetman Rooftops — IZZA GAME</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>

  <script>window.IZZA_PERSIST_BASE = 'https://izzagame.onrender.com';</script>

  <script>
    (function(){
      try{
        var params = new URLSearchParams(location.search);
        var u = (params.get('u') || '').toString().trim();
        if (!u) u = (localStorage.getItem('izzaUserU') || '').toString().trim();
        if (!u) {
          var raw = localStorage.getItem('piAuthUser');
          if (raw) { try { u = (JSON.parse(raw)||{}).username || ''; } catch(_){} }
        }
        if (u) {
          u = u.replace(/^@+/, '').toLowerCase();
          window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
          window.izzaUserKey = { get: function(){ return u; } };
          try { localStorage.setItem('izzaUserU', u); } catch(_){}
          try {
            if (!localStorage.getItem('piAuthUser')) {
              localStorage.setItem('piAuthUser', JSON.stringify({ username: u }));
            }
          } catch(_){}
        }
      }catch(_){}
    })();
  </script>
  <script src="/static/game/js/izza-persist.js"></script>

  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --hud:rgba(255,255,255,.10); --hudLine:rgba(255,255,255,.34); --arcade:#aef3ff;
      /* Expose iOS safe-area to JS via computed style */
      padding-bottom: constant(safe-area-inset-bottom);
      padding-bottom: env(safe-area-inset-bottom);
    }
    html,body{height:100%;margin:0;background:#071227;color:#e8eef7;font:14px/1.2 system-ui,Arial}
    body{
      background:
        radial-gradient(140% 90% at 50% 10%, rgba(60,120,220,.42), rgba(5,8,16,1) 70%) no-repeat,
        linear-gradient(#0f2c5a,#091427);
      caret-color: transparent;
    }
    .wrap{position:relative;max-width:480px;height:100svh;margin:0 auto;
          border-left:1px solid rgba(255,255,255,.10);border-right:1px solid rgba(255,255,255,.10);overflow:hidden}
    canvas{display:block;width:100%;height:100%}
    html,body,canvas,.wrap{
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none; touch-action:none;
    }
    #gl{position:absolute;inset:0;z-index:1}
    #ui{position:absolute;inset:0;z-index:2}
    .hud{position:absolute;left:10px;right:10px;top:10px;display:flex;justify-content:space-between;gap:8px;z-index:5}
    .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pill{
      background:var(--hud);
      border:1px solid var(--hudLine);
      backdrop-filter:blur(10px);
      padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;
      box-shadow:0 0 0 1px rgba(0,0,0,.15) inset, 0 2px 6px rgba(0,0,0,.25);
    }
    .pill strong{font-size:14px;color:var(--arcade); text-shadow:0 0 8px rgba(160,245,255,.75)}
    .startOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;
      background:radial-gradient(120% 120% at 50% 70%, rgba(100,190,255,.18), rgba(0,0,0,.45)); transition:opacity .18s ease}
    .startCard{background:rgba(15,25,48,.75);border:1px solid var(--hudLine);border-radius:14px;padding:16px 18px;
      display:flex;flex-direction:column;gap:12px;align-items:center;backdrop-filter:blur(8px);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 14px;border-radius:10px;border:1px solid var(--hudLine);
         background:rgba(255,255,255,.06);color:inherit;text-decoration:none;font-weight:800}
    .finish{position:absolute;left:10px;right:10px;bottom:10px;display:none;gap:8px;flex-wrap:wrap;z-index:7}
    .finish .pill{font-size:12px}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="hud">
      <div class="row">
        <span class="pill">SCORE: <strong id="score">0</strong></span>
        <span class="pill">HIGH: <strong id="hi">0</strong></span>
      </div>
      <div class="row">
        <span class="pill">COINS: <strong id="coinsHUD">0</strong></span>
      </div>
    </div>

    <div id="startOverlay" class="startOverlay" aria-live="polite">
      <div class="startCard">
        <div style="font-weight:900;letter-spacing:.4px">JETMAN ROOFTOPS</div>
        <div style="font-size:12px;opacity:.95;text-align:center">
          Tap/hold to thrust up. <strong>Dodge neon bars</strong>. Touching a bar or the top/ground = crash.
        </div>
        <div class="row">
          <a id="backBtn" class="btn" href="/izza-game/minigames">← Back</a>
          <button id="startBtn" class="btn" type="button">START</button>
          <a id="cityBtn" class="btn" href="/izza-game/play">City</a>
        </div>
      </div>
    </div>

    <canvas id="gl"></canvas>
    <canvas id="ui"></canvas>

    <div class="finish" id="finish">
      <span class="pill">Run Score: <strong id="finalScore">0</strong></span>
      <span class="pill">Coins Awarded: <strong id="finalCoins">0</strong></span>
      <span class="pill">Craft Credits: <strong id="finalCraft">0</strong></span>
      <a class="btn" href="/izza-game/minigames" id="againBtn">Play Again</a>
      <a class="btn" href="/izza-game/play" id="cityBtn2">Go to City</a>
    </div>
  </div>

<script>
(function(){
function safeGet(obj, path){ try{
  var cur=obj; for(var i=0;i<path.length;i++){ if(!cur || typeof cur!=='object') return undefined; cur=cur[path[i]]; }
  return cur;
}catch(_){ return undefined; }}

var T_KEY='izzaTokenT', U_KEY='izzaUserU';
var urlParams = new URLSearchParams(location.search);
var T = urlParams.get('t') || '';
var U = (urlParams.get('u') || '').toString().trim();

try{
  if (T) localStorage.setItem(T_KEY, T);
  else {
    var s = localStorage.getItem(T_KEY)||'';
    if (s){
      var url=new URL(location.href); url.searchParams.set('t',s); history.replaceState(null,'',url.toString()); T=s;
    }
  }
}catch(_){}

function publishUsername(u){
  if (!u) return '';
  u = u.replace(/^@+/, '').toLowerCase();
  try{ localStorage.setItem(U_KEY, u); }catch(_){}
  window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
  window.izzaUserKey = { get: function(){ return u; } };
  try{ if (!localStorage.getItem('piAuthUser')) localStorage.setItem('piAuthUser', JSON.stringify({ username: u })); }catch(_){}
  return u;
}
try{
  if (U) publishUsername(U);
  else {
    var su = (localStorage.getItem(U_KEY)||'').toString().trim();
    if (su){
      var url2=new URL(location.href); url2.searchParams.set('u',su);
      history.replaceState(null,'',url2.toString()); U = publishUsername(su);
    }
  }
}catch(_){}

function withAuth(href){
  var url = new URL(href, location.origin);
  if (T) url.searchParams.set('t', T);
  if (U) url.searchParams.set('u', U);
  return url.pathname + (url.search ? url.search : '');
}
document.getElementById('backBtn').href  = withAuth('/izza-game/minigames');
document.getElementById('cityBtn').href   = withAuth('/izza-game/play');
document.getElementById('cityBtn2').href  = withAuth('/izza-game/play');
document.getElementById('againBtn').href  = withAuth('/izza-game/minigames');

/* Wallet helpers */
function bearerHeaders(base) {
  var headers = Object.assign({ 'content-type':'application/json' }, base || {});
  try{
    var bearer = localStorage.getItem('izzaBearer') || '';
    if (bearer) headers['authorization'] = 'Bearer ' + bearer;
  }catch(_){}
  return headers;
}
function parseWalletResponse(j){
  if (!j || typeof j !== 'object') return { coins:0, crafting:0 };
  if ('coins' in j || 'crafting' in j || 'credits' in j){
    var craft = (typeof j.crafting!=='undefined') ? j.crafting : j.credits;
    return { coins: Number(j.coins)||0, crafting: Number(craft)||0 };
  }
  if (j.wallet)   return parseWalletResponse(j.wallet);
  if (j.balance)  return parseWalletResponse(j.balance);
  return { coins:0, crafting:0 };
}
var CRAFT_KEYS=['izzaCrafting','craftingCredits','izzaCraftCredits'];
function readCraftAny(){
  for(var i=0;i<CRAFT_KEYS.length;i++){
    var v=parseInt(localStorage.getItem(CRAFT_KEYS[i])||'0',10);
    if(isFinite(v)&&v>0) return v|0;
  }
  var v0=parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10)||0;
  return v0|0;
}
function writeCraftAll(v){ var n=Math.max(0,v|0); for(var i=0;i<CRAFT_KEYS.length;i++) localStorage.setItem(CRAFT_KEYS[i],String(n));
  try{ window.dispatchEvent(new Event('izza-crafting-changed')); }catch(_){ } }
function readCoinsLS(){ return (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0); }
function writeCoinsLS(v){ localStorage.setItem('izzaCoins', String((v|0))); }
var coinsHUD = document.getElementById('coinsHUD');
function paintCoinsHUD(n){ coinsHUD.textContent = String(Math.max(0, n|0)); }

/* Handoff from Arena */
function consumeWalletHandoff(maxAgeMs){
  if(!maxAgeMs) maxAgeMs = 120000;
  try{
    var raw = sessionStorage.getItem('izzaWalletHandoff');
    if(!raw) return null;
    var s = JSON.parse(raw);
    if(!s || !s.ts || (Date.now() - s.ts) > maxAgeMs) return null;
    if (s.user){
      var u = s.user.toString().trim().replace(/^@+/, '').toLowerCase();
      window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
      window.izzaUserKey = { get: function(){ return u; } };
      try{ localStorage.setItem('izzaUserU', u); localStorage.setItem('piAuthUser', JSON.stringify({ username:u })); }catch(_){}
      U = u;
    }
    localStorage.setItem('izzaCoins', String(s.coins|0));
    localStorage.setItem('izzaCrafting', String(s.craft|0));
    return { coins:s.coins|0, craft:s.craft|0 };
  }catch(_){ return null; }
}

/* Hidden City iframe to warm session */
function primeViaCityIframe(opts){
  opts = opts || {};
  var maxWaitMs = opts.maxWaitMs || 8000;
  var pollMs = opts.pollMs || 120;
  return new Promise(function(resolve){
    var f=null, done=false, hard=null, poll=null;
    function finish(){ if(done) return; done=true;
      try{ clearTimeout(hard); clearInterval(poll); if(f) f.parentNode && f.parentNode.removeChild(f); }catch(_){}
      resolve('ok');
    }
    var src = withAuth('/izza-game/play?prime=1&silent=1');
    f=document.createElement('iframe'); f.src=src;
    var st=f.style; st.position='fixed'; st.width='0'; st.height='0'; st.opacity='0'; st.pointerEvents='none'; st.border='0';
    document.body.appendChild(f);
    f.addEventListener('load', function(){
      try{
        var w=f.contentWindow; var tick=0;
        poll=setInterval(function(){
          try{
            var canLoad = w && w.IZZA_PERSIST && typeof w.IZZA_PERSIST.load === 'function';
            if (canLoad && tick<1){ tick++; w.IZZA_PERSIST.load().then(finish).catch(finish); }
          }catch(_){}
        }, pollMs);
      }catch(_){}
    }, false);
    hard=setTimeout(finish, maxWaitMs);
  });
}

/* Persist readiness & snapshot */
function waitForPersistReady(opts){
  opts = opts || {};
  var timeout = opts.timeout || 3000, interval = opts.interval || 40;
  return new Promise(function(res){
    var t0 = performance.now();
    function check(){
      if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function') return res(true);
      if (performance.now() - t0 > timeout) return res(false);
      setTimeout(check, interval);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', check, {once:true});
    else check();
  });
}
function hydrateFromSnapshot(){
  return new Promise(function(resolve){
    (function(){
      waitForPersistReady().then(function(){
        try{
          if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function'){
            IZZA_PERSIST.load().then(function(){
              try{ writeCraftAll(readCraftAny()); }catch(_){}
              resolve(readCoinsLS());
            }).catch(function(){ resolve(readCoinsLS()); });
          } else {
            resolve(readCoinsLS());
          }
        }catch(_){ resolve(readCoinsLS()); }
      });
    })();
  });
}

/* Best-effort session ping + character */
var LAST_CHARACTER = null;
function ensureSession(){
  return fetch(withAuth('/izza-game/api/character'), { credentials:'include', headers: bearerHeaders() })
    .then(function(r){
      if(!r.ok) return;
      return r.json().catch(function(){ return {}; }).then(function(j){
        var uname = (j.user && j.user.username) || j.username || j.handle || '';
        if (uname) { publishUsername(uname); }
        LAST_CHARACTER = j || LAST_CHARACTER;
        try{ localStorage.setItem('izzaCharacter', JSON.stringify(j)); }catch(_){}
      });
    }).catch(function(){});
}

/* Avatar pipeline (unchanged) */
var SPRITES = {
  body:{ default:"/static/game/sprites/body/default.png", street_a:"/static/game/sprites/body/street_a.png", street_b:"/static/game/sprites/body/street_b.png" },
  hair:{ short:"/static/game/sprites/hair/short.png", buzz:"/static/game/sprites/hair/buzz.png", long:"/static/game/sprites/hair/long.png" },
  outfit:{ street:"/static/game/sprites/outfit/street.png", athletic:"/static/game/sprites/outfit/athletic.png", luxury:"/static/game/sprites/outfit/luxury.png" }
};
var SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
var SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#6A402A","#432818"] };
var FEMALE_DRESS_BASE=["#7AB6FF","#4E84E3","#2F5CB5"];
var FEMALE_DRESS_TO={ blue:["#7AB6FF","#4E84E3","#2F5CB5"], red:["#FF7A7A","#E24C4C","#B12F2F"], green:["#7DD68A","#4CB56B","#2F7F47"], purple:["#B796FF","#8C6BE0","#6A49B8"], yellow:["#FFE08A","#E7C45A","#B89433"], pink:["#FFA6D6","#E57CB2","#C45C96"], black:["#3A3A3D","#232326","#0E0E10"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], brown:["#A87854","#7C563A","#593D29"], orange:["#FFB46A","#E4873A","#B65E1F"] };
var HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], blue:["#7AB6FF","#4E84E3","#2F5CB5"], green:["#7DD68A","#4CB56B","#2F7F47"], pink:["#FFA6D6","#E57CB2","#C45C96"] };

function loadImg(src){ return new Promise(function(res){ var i=new Image(); i.crossOrigin='anonymous'; i.onload=function(){res(i)}; i.onerror=function(){res(null)}; i.src=src; }); }
function hexToRgb(h){ var n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
function dist2(a,b){var dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;}
function lum(r,g,b){return 0.2126*r+0.7152*g+0.0722*b;}

function extractThreeToneRamp(img){
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var d=c.getImageData(0,0,w,h).data, samples=[];
  for(var i=0;i<d.length;i+=4){ if(d[i+3]<10) continue; var r=d[i],g=d[i+1],b=d[i+2]; samples.push({r:r,g:g,b:b,L:lum(r,g,b)}); }
  if(samples.length<10) return ["#C8C8C8","#9C9C9C","#6E6E6E"];
  samples.sort(function(a,b){return a.L-b.L;});
  function pick(q){ var idx=Math.max(0,Math.min(samples.length-1,Math.floor(q*(samples.length-1)))); var s=samples[idx];
    return '#'+s.r.toString(16).padStart(2,'0')+s.g.toString(16).padStart(2,'0')+s.b.toString(16).padStart(2,'0'); }
  return [pick(0.2),pick(0.55),pick(0.85)];
}
function paletteSwap(img, fromRampHex, toRampHex, tolerance){
  if(!tolerance) tolerance=2000;
  var from=fromRampHex.map(hexToRgb), to=toRampHex.map(hexToRgb);
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data; var changed=0;
  for(var i=0;i<d.length;i+=4){
    if(d[i+3]===0) continue;
    var p={r:d[i],g:d[i+1],b:d[i+2]}; var best=-1,score=1e9;
    for(var k=0;k<from.length;k++){ var s=dist2(p,from[k]); if(s<score){score=s;best=k;} }
    if(score<=tolerance){ var t=to[best]||to[1]||to[0];
      if(d[i]!==t.r||d[i+1]!==t.g||d[i+2]!==t.b) changed++;
      d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b;
    }
  }
  c.putImageData(id,0,0);
  return {canvas:oc, changedPixels:changed};
}
function overlayTint(img, hex, strength){
  if(strength==null) strength=1.0;
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data, t=hexToRgb(hex);
  function ov(a,b){a/=255;b/=255;var o=(a<.5)?(2*a*b):(1-2*(1-a)*(1-b));return Math.round(o*255);}
  for(var i=0;i<d.length;i+=4){ if(d[i+3]===0) continue;
    var r=ov(d[i],t.r), g=ov(d[i+1],t.g), b=ov(d[i+2],t.b);
    d[i]=Math.round(d[i]*(1-strength)+r*strength);
    d[i+1]=Math.round(d[i+1]*(1-strength)+g*strength);
    d[i+2]=Math.round(d[i+2]*(1-strength)+b*strength);
  }
  c.putImageData(id,0,0);
  return oc;
}

function buildAvatarCanvas(dstCtx, size, profile){
  return new Promise(function(resolve){
    (function(){
      var DW=size,DH=size,X=0,Y=0;
      var type=profile.body_type||'male', tone=profile.skin_tone||'light', theme=profile.sprite_skin||'default';
      var outfitKey=profile.outfit||'street', hairKey=profile.hair||'short', hairCol=profile.hair_color||'black';
      var femaleOut=profile.female_outfit_color||'blue';

      var body=null;
      function afterBody(){
        Promise.all([
          loadImg(SPRITES.hair[hairKey]||SPRITES.hair.short),
          (type==='female' ? Promise.resolve(null) : loadImg(SPRITES.outfit[outfitKey]||SPRITES.outfit.street))
        ]).then(function(arr){
          var hair=arr[0], outfit=arr[1];
          var bodyCanvas;
          if(body){
            var targetSkin=SKIN_TO[tone]||SKIN_TO.light;
            var swapped=paletteSwap(body, SKIN_BASE, targetSkin, 4000);
            bodyCanvas=swapped.canvas;
            if(swapped.changedPixels<8){ bodyCanvas=overlayTint(body, targetSkin[1], 0.98); }
          }
          if(type==='female' && bodyCanvas){
            var targetDress=FEMALE_DRESS_TO[femaleOut]||FEMALE_DRESS_TO.blue;
            var reDress=paletteSwap(bodyCanvas, FEMALE_DRESS_BASE, targetDress, 4000);
            bodyCanvas=reDress.canvas;
            if(reDress.changedPixels<6){ bodyCanvas=overlayTint(bodyCanvas, targetDress[1], 0.85); }
          }
          dstCtx.clearRect(0,0,DW,DH);
          if(bodyCanvas) dstCtx.drawImage(bodyCanvas, X, Y, DW, DH);
          if(outfit) dstCtx.drawImage(outfit, X, Y, DW, DH);
          if(hair){
            var detected=extractThreeToneRamp(hair), target=HAIR_TO[hairCol]||HAIR_TO.black;
            var swap=paletteSwap(hair, detected, target, 4000);
            var hairCanvas=swap.canvas;
            if(swap.changedPixels<8){ hairCanvas=overlayTint(hairCanvas, target[1], 1.0); }
            var hairY=(type==='female' && hairKey==='buzz') ? (Y-4) : Y;
            dstCtx.drawImage(hairCanvas, X, hairY, DW, DH);
          }
          resolve();
        });
      }
      if(type==='female'){
        var femaleWide='/static/game/sprites/body/'+theme+'__female_wide.png';
        var femaleSlim='/static/game/sprites/body/'+theme+'__female.png';
        loadImg(femaleWide).then(function(img){
          if(img) body=img;
          return img ? img : loadImg(femaleSlim);
        }).then(function(img){ if(img) body=img; afterBody(); });
      } else {
        loadImg(SPRITES.body[theme]||SPRITES.body.default).then(function(img){ body=img; afterBody(); });
      }
    })();
  });
}

/* Offscreen sprite -> UI canvas */
var jetmanCanvas = document.createElement('canvas');
jetmanCanvas.width = jetmanCanvas.height = 96;
var jetCtx = jetmanCanvas.getContext('2d'); jetCtx.imageSmoothingEnabled=false;

/* GAME */
var glCvs = document.getElementById('gl');
var uiCvs = document.getElementById('ui'), uiCtx = uiCvs.getContext('2d');
uiCtx.imageSmoothingEnabled=false;

uiCvs.addEventListener('contextmenu', function(e){ e.preventDefault(); }, false);
uiCvs.addEventListener('touchstart', function(e){ e.preventDefault(); }, {passive:false});
uiCvs.addEventListener('pointerdown', function(e){ e.preventDefault(); }, false);

var W=0,H=0,dpr=1;
var scene, camera, renderer;

function hardResize(){
  var r = glCvs.getBoundingClientRect();
  var w = Math.max(1, Math.floor(r.width || window.innerWidth || 1));
  var h = Math.max(1, Math.floor(r.height || window.innerHeight || 1));
  dpr = Math.min(window.devicePixelRatio || 1, 2);
  if (w !== W || h !== H){
    W=w; H=h;
    glCvs.width=W*dpr; glCvs.height=H*dpr;
    uiCvs.width=W*dpr; uiCvs.height=H*dpr;
    uiCtx.setTransform(dpr,0,0,dpr,0,0);
    if(renderer){ renderer.setSize(W, H, false); renderer.setPixelRatio(dpr); }
    updateScale();
  }
}
function ensureSized(attempt){ attempt = attempt||0; hardResize(); if ((W<2 || H<2) && attempt<10) setTimeout(function(){ ensureSized(attempt+1); }, 60); }
ensureSized(); updateScale(); addEventListener('resize', function(){ ensureSized(); }, false);

/* Player vertical motion */
var player = { y: 0, vy:0, r:18 };
var phys = { g: 1500, thrust: 1850, maxVy: 820 };
player.y = 0;
var thrust=false; addEventListener('keydown',function(e){ if(e.code==='Space') thrust=true; }, false);
addEventListener('keyup',function(e){ if(e.code==='Space') thrust=false; }, false);
uiCvs.addEventListener('pointerdown', function(){ thrust=true; }, false);
addEventListener('pointerup', function(){ thrust=false; }, false);

/* Speed / world */
var worldZ=0, speed=110, time=0, last=performance.now();
var corridorHalf=6.5;
var corridorHeight=10;
var DEPTH=300;

/* === Physics bounds (stable; also used to draw guides) === */
var TOP_Y = 3.3;   // ceiling world Y
var BOT_Y = -3.0;  // ground world Y

/* ===== Margins + mapping ===== */
var TOP_PX_MARGIN = 0;
var BOT_PX_MARGIN = 0;
var pixelsPerWorld = 1;

function computeMargins(){
  var top = 90;     // leave room for HUD
  var bottom = 160; // leave room for iOS swipe bar / browser chrome

  try{
    var cs = getComputedStyle(document.documentElement);
    var pb = parseInt(cs.getPropertyValue('padding-bottom')) || 0;
    // Try to parse env(safe-area-inset-bottom) if available
    var envVal = cs.getPropertyValue('env(safe-area-inset-bottom)') || '0';
    var envNum = parseInt(envVal) || 0;
    bottom += Math.max(pb, envNum);
  }catch(_){}

  if (window.visualViewport && window.innerHeight){
    var hidden = Math.max(0, window.innerHeight - window.visualViewport.height);
    bottom += Math.round(hidden);
  }
  return { top: top|0, bottom: bottom|0 };
}

function updateScale(){
  var m = computeMargins();
  TOP_PX_MARGIN = m.top;
  BOT_PX_MARGIN = m.bottom;
  var usable = Math.max(1, (H - TOP_PX_MARGIN - BOT_PX_MARGIN));
  pixelsPerWorld = usable / (TOP_Y - BOT_Y);
}
function worldToPxY(y){
  var botPx = H - BOT_PX_MARGIN;
  var dy = (y - BOT_Y) * pixelsPerWorld;
  return botPx - dy;
}

/* Spawns/collision */
var SPAWN_INTERVAL = 1.8;
var COLLISION_Z_NEAR = 0.35;
var COLLISION_Z_FAR  = 0.85;
var HITBOX_HALF = 0.55;

/* Impact preview for the next bar (drawn on UI) */
var nextImpactY = null;

function init3D(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0e2141);
  scene.fog = new THREE.FogExp2(0x123061, 0.014);

  camera = new THREE.PerspectiveCamera(55, W/H, 0.1, 1000);
  camera.position.set(0, 0, 6);
  camera.rotation.order = 'YXZ';

  renderer = new THREE.WebGLRenderer({canvas: glCvs, antialias: true, alpha: true});
  renderer.setPixelRatio(dpr); renderer.setSize(W,H,false);

  var hemi = new THREE.HemisphereLight(0xcfe6ff, 0x0a1020, 1.0); scene.add(hemi);
  var amb = new THREE.AmbientLight(0xcfe7ff, 0.85); scene.add(amb);
  var dir = new THREE.DirectionalLight(0xffffff, 1.35); dir.position.set(-2,4,3); scene.add(dir);

  var floorGeo = new THREE.PlaneGeometry(corridorHalf*2.4, DEPTH, 1, 1);
  var floorMat = new THREE.MeshStandardMaterial({color:0x1b4f8f, roughness:.6, metalness:.15, emissive:0x144a94, emissiveIntensity:.45});
  var floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotateX(-Math.PI/2); floor.position.set(0,-corridorHeight*0.55, -DEPTH/2);
  scene.add(floor);

  var coneGeo = new THREE.ConeGeometry(2.6, 6.8, 18, 1, true);
  var coneMat = new THREE.MeshBasicMaterial({color:0x48e0ff, transparent:true, opacity:.35, side:THREE.DoubleSide});
  var coneL = new THREE.Mesh(coneGeo, coneMat), coneR = new THREE.Mesh(coneGeo, coneMat);
  coneL.rotation.set(Math.PI/2.1, 0.1, 0); coneR.rotation.set(Math.PI/2.1, -0.1, 0);
  coneL.position.set(-corridorHalf*1.1, -1.5, -40); coneR.position.set(corridorHalf*1.1, -1.5, -40);
  scene.add(coneL, coneR);

  var streaks = new THREE.Group();
  for(var i=0;i<60;i++){
    var g = new THREE.PlaneGeometry(0.024, 1.0);
    var m = new THREE.MeshBasicMaterial({color:0xccf6ff, transparent:true, opacity:0.36, depthWrite:false});
    var p = new THREE.Mesh(g,m);
    p.position.set((Math.random()-.5)*corridorHalf*2, (Math.random()-.5)*4, -Math.random()*60);
    p.rotation.y = (Math.random()-.5)*0.8;
    streaks.add(p);
  }
  scene.add(streaks);

  makeWalls();
}

/* Walls */
var wallPoolL=[], wallPoolR=[], wallLen=6;
function newWall(side){
  var h = THREE.MathUtils.lerp(corridorHeight*0.45, corridorHeight*0.9, Math.random());
  var geo = new THREE.BoxGeometry(1.2, h, wallLen, 1,1,1);
  var mat = new THREE.MeshStandardMaterial({ color:0x2ad4ff, roughness:.5, metalness:.22,
    emissive:0x00aaff, emissiveIntensity:1.15 });
  var m = new THREE.Mesh(geo, mat);
  m.castShadow=false; m.receiveShadow=false;
  m.userData.h = h;
  scene.add(m);
  return m;
}
function makeWalls(){
  for(var i=0;i<28;i++){ wallPoolL.push(newWall('L')); wallPoolR.push(newWall('R')); }
  layoutWalls();
}
function layoutWalls(){
  var z = -10;
  for(var i=0;i<wallPoolL.length;i++){
    var mL = wallPoolL[i], mR = wallPoolR[i];
    var hL = THREE.MathUtils.lerp(corridorHeight*0.45, corridorHeight*0.9, Math.random());
    var hR = THREE.MathUtils.lerp(corridorHeight*0.45, corridorHeight*0.9, Math.random());
    mL.scale.y = hL / mL.userData.h; mR.scale.y = hR / mR.userData.h;
    mL.position.set(-corridorHalf, -corridorHeight*0.5 + hL/2, z);
    mR.position.set( corridorHalf, -corridorHeight*0.5 + hR/2, z);
    z -= wallLen;
  }
}

/* Obstacles — neon bars */
var obstacles=[];
function spawnObstacle(){
  var w = corridorHalf*1.95;
  var t = THREE.MathUtils.lerp(0.18,0.28,Math.random());

  // Constrain h so every bar is passable given our hit band.
  var margin = 0.10;
  var maxH = TOP_Y - HITBOX_HALF - margin;
  var minH = BOT_Y + HITBOX_HALF + margin;
  var h = THREE.MathUtils.lerp(minH, maxH, Math.random());

  var geo = new THREE.BoxGeometry(w, t, 1.2);
  var mat = new THREE.MeshStandardMaterial({
    color:0x00ff66, roughness:.2, metalness:.05,
    emissive:0x00ff66, emissiveIntensity:2.0
  });
  var bar = new THREE.Mesh(geo, mat);

  var glowGeo = new THREE.PlaneGeometry(w*1.02, t*5.4);
  var glowMat = new THREE.MeshBasicMaterial({color:0x00ff66, transparent:true, opacity:0.22, depthWrite:false});
  var glow1 = new THREE.Mesh(glowGeo, glowMat); glow1.rotation.x = Math.PI/2; glow1.position.z += 0.01;
  var glow2 = glow1.clone(); glow2.position.z -= 0.02;

  var group = new THREE.Group();
  group.add(bar, glow1, glow2);
  group.position.set(0, h, -80);

  scene.add(group);
  obstacles.push({ mesh: group, type: 'bar' });
}

/* Recycle world */
function advanceWorld(dz){
  var minZ = 5, maxZ = -120;
  for(var i=0;i<wallPoolL.length;i++){
    var a=wallPoolL[i], b=wallPoolR[i];
    a.position.z += dz; b.position.z += dz;
    if(a.position.z > minZ){ a.position.z = maxZ; b.position.z = maxZ;
      var hL = THREE.MathUtils.lerp(corridorHeight*0.45, corridorHeight*0.9, Math.random());
      var hR = THREE.MathUtils.lerp(corridorHeight*0.45, corridorHeight*0.9, Math.random());
      a.scale.y = hL / a.userData.h; b.scale.y = hR / b.userData.h;
      a.position.y = -corridorHeight*0.5 + hL/2;
      b.position.y = -corridorHeight*0.5 + hR/2;
    }
  }
  for(var i=obstacles.length-1;i>=0;i--){
    var o=obstacles[i]; o.mesh.position.z += dz;
    if(o.mesh.position.z > 5){ scene.remove(o.mesh); obstacles.splice(i,1); continue; }
  }
}

/* HUD / hi */
var hi = Number(localStorage.getItem('jet_hi') || 0);
document.getElementById('hi').textContent = hi;
var COINS_PER_SCORE = 10;
var COINS_PER_CREDIT = 1000;

/* game state */
var scoreEl = document.getElementById('score');
var finishEl = document.getElementById('finish');
var finalScoreEl = document.getElementById('finalScore');
var finalCoinsEl = document.getElementById('finalCoins');
var finalCraftEl = document.getElementById('finalCraft');

var WALLET_READY=false, walletDirty=false, runStartCoins=0;
var game = { score:0, creditsMinted:0, ended:false };

/* Wallet ops (unchanged) */
function updateCoinsHUD(){ paintCoinsHUD(readCoinsLS()); }
function applyCoins(amount){
  return new Promise(function(resolve){
    var cur = (readCoinsLS()|0) + (amount|0);
    writeCoinsLS(cur); walletDirty = true;
    try{ window.dispatchEvent(new Event('izza-coins-changed')); }catch(_){}
    try{
      var saver = safeGet(window, ['IZZA_PERSIST','save']);
      if (typeof saver === 'function'){ saver().then(function(){ walletDirty=false; resolve(cur); }).catch(function(){ resolve(cur); }); }
      else resolve(cur);
    }catch(_){ resolve(cur); }
    try{ window.dispatchEvent(new CustomEvent('izza-wallet-changed', { detail:{ coins:cur, crafting:readCraftAny() } })); }catch(_){}
    WALLET_READY = true; updateCoinsHUD();
  });
}
function applyCraftDelta(delta){
  return new Promise(function(resolve){
    var val = readCraftAny() + (delta|0);
    writeCraftAll(val); walletDirty = true;
    try{
      var saver = safeGet(window, ['IZZA_PERSIST','save']);
      if (typeof saver === 'function'){ saver().then(function(){ walletDirty=false; resolve(); }).catch(function(){ resolve(); }); }
      else resolve();
    }catch(_){ resolve(); }
    try{ window.dispatchEvent(new CustomEvent('izza-wallet-changed', { detail:{ coins: readCoinsLS(), crafting:val } })); }catch(_){}
  });
}
function persistWalletAndSave(){ return Promise.resolve(); }
function awardFromProgress(deltaScore){
  var addCoins = Math.max(0, Math.floor(deltaScore * COINS_PER_SCORE));
  if (addCoins>0) applyCoins(addCoins);
  var totalCoins = readCoinsLS();
  var creditsNow = Math.floor(totalCoins / COINS_PER_CREDIT);
  if (creditsNow > game.creditsMinted){
    var delta = creditsNow - game.creditsMinted;
    game.creditsMinted = creditsNow;
    applyCraftDelta(delta);
  }
}

function gameOver(){
  if (game.ended) return;
  game.ended = true;
  hi=Math.max(hi,Math.floor(game.score)); localStorage.setItem('jet_hi',hi);
  document.getElementById('hi').textContent=hi;
  var coinsNow = readCoinsLS();
  var coinsAwarded = Math.max(0, (coinsNow|0) - (runStartCoins|0));
  finalScoreEl.textContent = Math.floor(game.score);
  finalCoinsEl.textContent = coinsAwarded;
  finalCraftEl.textContent = Math.floor(coinsNow / COINS_PER_CREDIT) - Math.floor(runStartCoins / COINS_PER_CREDIT);
  finishEl.style.display = 'flex';
}

/* ===== UI draw (guides reflect physics exactly) ===== */
function drawUI(){
  uiCtx.clearRect(0,0,W,H);

  var spriteW = 96, spriteH = 96;
  var cx = W/2;
  var py = worldToPxY(player.y);

  var topPx = worldToPxY(TOP_Y);
  var botPx = worldToPxY(BOT_Y);
  uiCtx.save();
  uiCtx.strokeStyle = 'rgba(255,60,60,0.9)';
  uiCtx.lineWidth = 2;
  uiCtx.setLineDash([6,6]);
  uiCtx.beginPath(); uiCtx.moveTo(0, topPx); uiCtx.lineTo(W, topPx); uiCtx.stroke();
  uiCtx.beginPath(); uiCtx.moveTo(0, botPx); uiCtx.lineTo(W, botPx); uiCtx.stroke();
  uiCtx.restore();

  var hitH = (HITBOX_HALF*2) * pixelsPerWorld;
  var hitW = 96;
  uiCtx.save();
  uiCtx.strokeStyle = 'rgba(255,60,60,0.9)';
  uiCtx.lineWidth = 2;
  uiCtx.setLineDash([8,6]);
  uiCtx.strokeRect(cx - hitW/2, py - hitH/2, hitW, hitH);
  uiCtx.restore();

  // Clamp sprite Y into the visible band and nudge it slightly upward so it never dips below the bottom edge
  var minY = BOT_PX_MARGIN + spriteH/2 + 2;
  var maxY = H - TOP_PX_MARGIN - spriteH/2 - 2;
  py = Math.max(minY, Math.min(maxY, py));

  var flameLen = thrust ? 22+12*Math.sin(time*40) : 10;
  uiCtx.fillStyle='rgba(255,240,140,.95)';
  uiCtx.beginPath(); uiCtx.ellipse(cx - spriteW*0.55, py+6, flameLen, 9, 0, 0, Math.PI*2); uiCtx.fill();
  uiCtx.fillStyle='rgba(120,220,255,.65)';
  uiCtx.beginPath(); uiCtx.ellipse(cx - spriteW*0.65, py+6, flameLen*0.6, 6, 0, 0, Math.PI*2); uiCtx.fill();

  // Slight upward bias (0.58) so avatar never visually overlaps the ground line
  uiCtx.drawImage(jetmanCanvas, cx - spriteW/2, py - spriteH*0.58, spriteW, spriteH);
}

/* Loop */
var spawnTimer=0;
function frame(now){
  if (game.ended) return;
  var dt=Math.min(0.033,(now-last)/1000); last=now; time+=dt;

  var ay = (thrust? -phys.thrust : phys.g);
  player.vy = Math.max(-phys.maxVy, Math.min(phys.maxVy, player.vy + ay*dt));
  var nextY = player.y + (player.vy*dt)/260;
  if(nextY <= BOT_Y || nextY >= TOP_Y){ gameOver(); return; }
  player.y = Math.max(BOT_Y, Math.min(TOP_Y, nextY));

  var mps = (speed/3.6) * (thrust?1.12:1.0);
  worldZ += mps*dt;
  advanceWorld((mps*dt));

  spawnTimer += dt;
  if (spawnTimer > SPAWN_INTERVAL){
    spawnTimer = 0;
    spawnObstacle();
  }

  camera.position.y = player.y*0.6;
  camera.rotation.z = THREE.MathUtils.lerp(camera.rotation.z, (thrust?-0.03:0.03), 0.15);

  var bandTop = player.y + HITBOX_HALF;
  var bandBot = player.y - HITBOX_HALF;
  nextImpactY = null;
  var nearestZ = Infinity;
  for (var i=0;i<obstacles.length;i++){
    var o = obstacles[i];
    var z = o.mesh.position.z;
    if (z > COLLISION_Z_NEAR && z < 4){
      if (z < nearestZ){ nearestZ = z; nextImpactY = o.mesh.position.y; }
    }
    if (z > COLLISION_Z_NEAR && z < COLLISION_Z_FAR){
      var bar = o.mesh.children[0];
      var half = bar.geometry.parameters.height/2;
      var top  = o.mesh.position.y + half;
      var bot  = o.mesh.position.y - half;
      if (!(bandTop < bot || bandBot > top)){ gameOver(); return; }
    }
  }

  var prevScore = game.score;
  game.score += mps*dt;
  scoreEl.textContent = Math.floor(game.score);
  var deltaScore = game.score - prevScore;
  if (deltaScore > 0.001) awardFromProgress(deltaScore);

  renderer.render(scene, camera);
  drawUI();

  requestAnimationFrame(frame);
}

/* listeners */
window.addEventListener('storage', function(e){
  if (e && (e.key === 'izzaCoins' || (e.key && CRAFT_KEYS.indexOf(e.key)>=0))) updateCoinsHUD();
}, false);
document.addEventListener('visibilitychange', function(){
  if (document.hidden){
    // best-effort save
  } else {
    updateCoinsHUD();
  }
}, false);

/* START */
var startBtn = document.getElementById('startBtn');
function ensureAvatarSprite(){
  try{
    var profile = LAST_CHARACTER || JSON.parse(localStorage.getItem('izzaCharacter')||'{}') || {};
    return buildAvatarCanvas(jetCtx, 96, profile);
  }catch(_){ return Promise.resolve(); }
}

function startGame(){
  try{
    var overlay = document.getElementById('startOverlay');
    overlay.style.opacity = '0.96';

    var handoff = consumeWalletHandoff(); if (handoff){ paintCoinsHUD(handoff.coins); }

    primeViaCityIframe({ maxWaitMs: 1500 });
    ensureSession();

    hydrateFromSnapshot().then(function(snapCoins){
      var shown = parseInt((coinsHUD.textContent||'0'), 10) || 0;
      paintCoinsHUD(Math.max(shown, snapCoins, readCoinsLS()||0));
    });

    (function(){
      fetch(withAuth('/izza-game/api/wallet'), { credentials:'include', headers: bearerHeaders() })
        .then(function(r){ if(!r.ok) return; return r.json().catch(function(){ return {}; }); })
        .then(function(parsed){
          if(!parsed) return;
          parsed = parseWalletResponse(parsed);
          var apiCoins = Number(parsed.coins)||0;
          var apiCraft = Number(parsed.crafting)||0;
          var shown = parseInt((coinsHUD.textContent||'0'), 10) || 0;
          var nextCoins = Math.max(shown, apiCoins);
          try{
            localStorage.setItem('izzaCoins', String(nextCoins));
            if (apiCraft>=0) writeCraftAll(apiCraft);
            window.dispatchEvent(new Event('izza-coins-changed'));
            window.dispatchEvent(new Event('izza-crafting-changed'));
          }catch(_){}
          paintCoinsHUD(nextCoins);
        }).catch(function(){});
    })();

    WALLET_READY = true;
    runStartCoins = parseInt((coinsHUD.textContent||'0'), 10) || (readCoinsLS()||0);

    ensureAvatarSprite().then(function(){
      overlay.style.display = 'none';
      ensureSized();
      init3D();
      requestAnimationFrame(frame);
    });
  }catch(e){ try{ console.error('start failed', e); }catch(_){} }
}

startBtn.addEventListener('click', startGame, false);
startBtn.addEventListener('touchstart', function(e){ e.preventDefault(); startGame(); }, false);

updateCoinsHUD();

})();
</script>
</body>
</html>
