<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Jetman Rooftops — IZZA GAME</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>

  <!-- Persist base (same as Arena/Basketball/Race) -->
  <script>window.IZZA_PERSIST_BASE = 'https://izzagame.onrender.com';</script>

  <!-- Ensure username is known before izza-persist.js loads -->
  <script>
    (function(){
      try{
        var params = new URLSearchParams(location.search);
        var u = (params.get('u') || '').toString().trim();
        if (!u) u = (localStorage.getItem('izzaUserU') || '').toString().trim();
        if (!u) {
          var raw = localStorage.getItem('piAuthUser');
          if (raw) { try { u = (JSON.parse(raw)||{}).username || ''; } catch(_){} }
        }
        if (u) {
          u = u.replace(/^@+/, '').toLowerCase();
          window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
          window.izzaUserKey = { get: function(){ return u; } };
          try { localStorage.setItem('izzaUserU', u); } catch(_){}
          try {
            if (!localStorage.getItem('piAuthUser')) {
              localStorage.setItem('piAuthUser', JSON.stringify({ username: u }));
            }
          } catch(_){}
        }
      }catch(_){}
    })();
  </script>
  <script src="/static/game/js/izza-persist.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{ --hud:rgba(0,0,0,.55); --hudLine:rgba(255,255,255,.18); --arcade:#9ef5ff; }
    html,body{height:100%;margin:0;background:#070a12;color:#e8eef7;font:14px/1.2 system-ui,Arial}
    .wrap{position:relative;max-width:480px;height:100svh;margin:0 auto;
          border-left:1px solid rgba(255,255,255,.06);border-right:1px solid rgba(255,255,255,.06);overflow:hidden}
    svg{display:block;width:100%;height:100%}
    .hud{position:absolute;left:10px;right:10px;top:10px;display:flex;justify-content:space-between;gap:8px;z-index:3}
    .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pill{background:var(--hud);border:1px solid var(--hudLine);backdrop-filter:blur(6px);
          padding:3px 8px;border-radius:999px;font-size:11px;font-weight:800}
    .pill strong{font-size:13px;color:var(--arcade)}
    .startOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:4;
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)); transition:opacity .15s ease}
    .startCard{background:rgba(0,0,0,.6);border:1px solid var(--hudLine);border-radius:14px;padding:16px 18px;
      display:flex;flex-direction:column;gap:12px;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 14px;border-radius:10px;border:1px solid var(--hudLine);
         background:var(--chip-bg);color:inherit;text-decoration:none;font-weight:800}
    .finish{position:absolute;left:10px;right:10px;bottom:10px;display:none;gap:8px;flex-wrap:wrap;z-index:5}
    .finish .pill{font-size:12px}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <!-- HUD -->
    <div class="hud">
      <div class="row">
        <span class="pill">SCORE: <strong id="score">0</strong></span>
        <span class="pill">HIGH: <strong id="hi">0</strong></span>
      </div>
      <div class="row">
        <span class="pill">COINS: <strong id="coinsHUD">0</strong></span>
      </div>
    </div>

    <!-- START overlay -->
    <div id="startOverlay" class="startOverlay" aria-live="polite">
      <div class="startCard">
        <div style="font-weight:900;letter-spacing:.4px">JETMAN ROOFTOPS</div>
        <div style="font-size:12px;opacity:.85;text-align:center">Tap/hold to thrust up. Dodge rooftop units and crossbars.</div>
        <div class="row">
          <a id="backBtn" class="btn" href="/izza-game/minigames">← Back</a>
          <button id="startBtn" class="btn" type="button">START</button>
          <a id="cityBtn" class="btn" href="/izza-game/play">City</a>
        </div>
      </div>
    </div>

    <!-- GAME (SVG scene root) -->
    <svg id="scene" viewBox="0 0 480 800" preserveAspectRatio="xMidYMid slice" aria-label="Jetman Rooftops">
      <defs>
        <!-- Sky gradient -->
        <linearGradient id="gSky" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#06080f"/>
          <stop offset="1" stop-color="#0b1020"/>
        </linearGradient>
        <!-- Neon fog -->
        <linearGradient id="gFog" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="rgba(0,255,255,.28)"/>
          <stop offset=".4" stop-color="rgba(0,200,255,.12)"/>
          <stop offset="1" stop-color="rgba(0,0,0,0)"/>
        </linearGradient>
        <!-- AC/duct face gradients -->
        <linearGradient id="gFaceA" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#b8c9e3"/><stop offset="1" stop-color="#7f92b1"/>
        </linearGradient>
        <linearGradient id="gFaceB" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#9fb2cf"/><stop offset="1" stop-color="#6a7f9e"/>
        </linearGradient>
        <!-- Glow blur -->
        <filter id="fGlow" x="-40%" y="-40%" width="180%" height="180%">
          <feGaussianBlur stdDeviation="4" result="b"/>
          <feMerge>
            <feMergeNode in="b"/><feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <!-- Thruster blur -->
        <filter id="fThruster" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3"/>
        </filter>
        <!-- Shadow -->
        <filter id="fSoft" x="-30%" y="-30%" width="160%" height="160%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity=".35"/>
        </filter>
      </defs>

      <!-- Background layers -->
      <g id="bg">
        <rect id="sky" x="0" y="0" width="100%" height="100%" fill="url(#gSky)"/>
        <!-- Parallax clouds -->
        <g id="clouds" opacity=".5" filter="url(#fGlow)"></g>
      </g>

      <!-- World -->
      <g id="world">
        <!-- Floor corridor -->
        <polygon id="floor" fill="#0b1220"></polygon>
        <rect id="fog" x="0" y="0" width="100%" height="100%" fill="url(#gFog)" style="mix-blend-mode:screen"></rect>

        <!-- Rooftop “walls” rising up the sides -->
        <g id="roofsL"></g>
        <g id="roofsR"></g>

        <!-- Obstacles -->
        <g id="obstacles"></g>
      </g>

      <!-- Player -->
      <g id="player">
        <ellipse id="thruster" rx="12" ry="5" fill="rgba(255,220,90,.9)" filter="url(#fThruster)" opacity=".9"></ellipse>
        <image id="avatar" width="96" height="96" x="-48" y="-48" href="" filter="url(#fSoft)"></image>
        <!-- light rays -->
        <g id="rays" opacity=".16"></g>
      </g>
    </svg>

    <!-- FINISH strip -->
    <div class="finish" id="finish">
      <span class="pill">Run Score: <strong id="finalScore">0</strong></span>
      <span class="pill">Coins Awarded: <strong id="finalCoins">0</strong></span>
      <span class="pill">Craft Credits: <strong id="finalCraft">0</strong></span>
      <a class="btn" href="/izza-game/minigames" id="againBtn">Play Again</a>
      <a class="btn" href="/izza-game/play" id="cityBtn2">Go to City</a>
    </div>
  </div>

<script>
(function(){
/* ============ ES5 helpers (no optional chaining / nullish) ============ */
function safeGet(obj, path){ try{
  var cur=obj; for(var i=0;i<path.length;i++){ if(!cur || typeof cur!=='object') return undefined; cur=cur[path[i]]; }
  return cur;
}catch(_){ return undefined; }}

/* =========================
   t & u propagation / links
   ========================= */
var T_KEY='izzaTokenT', U_KEY='izzaUserU';
var urlParams = new URLSearchParams(location.search);
var T = urlParams.get('t') || '';
var U = (urlParams.get('u') || '').toString().trim();

try{
  if (T) localStorage.setItem(T_KEY, T);
  else {
    var s = localStorage.getItem(T_KEY)||'';
    if (s){
      var url=new URL(location.href); url.searchParams.set('t',s); history.replaceState(null,'',url.toString()); T=s;
    }
  }
}catch(_){}

function publishUsername(u){
  if (!u) return '';
  u = u.replace(/^@+/, '').toLowerCase();
  try{ localStorage.setItem(U_KEY, u); }catch(_){}
  window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
  window.izzaUserKey = { get: function(){ return u; } };
  try{ if (!localStorage.getItem('piAuthUser')) localStorage.setItem('piAuthUser', JSON.stringify({ username: u })); }catch(_){}
  return u;
}
try{
  if (U) publishUsername(U);
  else {
    var su = (localStorage.getItem(U_KEY)||'').toString().trim();
    if (su){
      var url2=new URL(location.href); url2.searchParams.set('u',su);
      history.replaceState(null,'',url2.toString()); U = publishUsername(su);
    }
  }
}catch(_){}

function withAuth(href){
  var url = new URL(href, location.origin);
  if (T) url.searchParams.set('t', T);
  if (U) url.searchParams.set('u', U);
  return url.pathname + (url.search ? url.search : '');
}

/* === Wire links exactly like Basketball === */
document.getElementById('backBtn').href = withAuth('/izza-game/minigames');
['cityBtn','cityBtn2','againBtn'].forEach(function(id){
  var el = document.getElementById(id);
  if (el) el.href = withAuth(el.getAttribute('href'));
});

/* =========================
   Wallet helpers (shared)
   ========================= */
function bearerHeaders(base) {
  var headers = Object.assign({ 'content-type':'application/json' }, base || {});
  try{
    var bearer = localStorage.getItem('izzaBearer') || '';
    if (bearer) headers['authorization'] = 'Bearer ' + bearer;
  }catch(_){}
  return headers;
}
function parseWalletResponse(j){
  if (!j || typeof j !== 'object') return { coins:0, crafting:0 };
  if ('coins' in j || 'crafting' in j || 'credits' in j){
    var craft = (typeof j.crafting!=='undefined') ? j.crafting : j.credits;
    return { coins: Number(j.coins)||0, crafting: Number(craft)||0 };
  }
  if (j.wallet)   return parseWalletResponse(j.wallet);
  if (j.balance)  return parseWalletResponse(j.balance);
  return { coins:0, crafting:0 };
}
var CRAFT_KEYS=['izzaCrafting','craftingCredits','izzaCraftCredits'];
function readCraftAny(){
  for(var i=0;i<CRAFT_KEYS.length;i++){
    var v=parseInt(localStorage.getItem(CRAFT_KEYS[i])||'0',10);
    if(isFinite(v)&&v>0) return v|0;
  }
  var v0=parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10)||0;
  return v0|0;
}
function writeCraftAll(v){ var n=Math.max(0,v|0); for(var i=0;i<CRAFT_KEYS.length;i++) localStorage.setItem(CRAFT_KEYS[i],String(n));
  try{ window.dispatchEvent(new Event('izza-crafting-changed')); }catch(_){} }
function readCoinsLS(){ return (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0); }
function writeCoinsLS(v){ localStorage.setItem('izzaCoins', String((v|0))); }
var coinsHUD = document.getElementById('coinsHUD');
function paintCoinsHUD(n){ coinsHUD.textContent = String(Math.max(0, n|0)); }

/* Handoff from Arena (instant paint) */
function consumeWalletHandoff(maxAgeMs){
  if(!maxAgeMs) maxAgeMs = 120000;
  try{
    var raw = sessionStorage.getItem('izzaWalletHandoff');
    if(!raw) return null;
    var s = JSON.parse(raw);
    if(!s || !s.ts || (Date.now() - s.ts) > maxAgeMs) return null;

    if (s.user){
      var u = s.user.toString().trim().replace(/^@+/, '').toLowerCase();
      window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
      window.izzaUserKey = { get: function(){ return u; } };
      try{ localStorage.setItem('izzaUserU', u); localStorage.setItem('piAuthUser', JSON.stringify({ username:u })); }catch(_){}
      U = u;
    }
    localStorage.setItem('izzaCoins', String(s.coins|0));
    localStorage.setItem('izzaCrafting', String(s.craft|0));
    return { coins:s.coins|0, craft:s.craft|0 };
  }catch(_){ return null; }
}

/* Hidden City iframe to warm session (no optional chaining) */
function primeViaCityIframe(opts){
  opts = opts || {};
  var maxWaitMs = opts.maxWaitMs || 8000;
  var pollMs = opts.pollMs || 120;
  return new Promise(function(resolve){
    var f=null, done=false, hard=null, poll=null;
    function finish(){ if(done) return; done=true;
      try{ clearTimeout(hard); clearInterval(poll); if(f) f.parentNode && f.parentNode.removeChild(f); }catch(_){}
      resolve('ok');
    }
    var src = withAuth('/izza-game/play?prime=1&silent=1');
    f=document.createElement('iframe'); f.src=src;
    var st=f.style; st.position='fixed'; st.width='0'; st.height='0'; st.opacity='0'; st.pointerEvents='none'; st.border='0';
    document.body.appendChild(f);
    f.addEventListener('load', function(){
      try{
        var w=f.contentWindow; var tick=0;
        poll=setInterval(function(){
          try{
            var canLoad = w && w.IZZA_PERSIST && typeof w.IZZA_PERSIST.load === 'function';
            if (canLoad && tick<1){ tick++; w.IZZA_PERSIST.load().then(finish).catch(finish); }
          }catch(_){}
        }, pollMs);
      }catch(_){}
    }, false);
    hard=setTimeout(finish, maxWaitMs);
  });
}

/* Persist readiness & snapshot */
function waitForPersistReady(opts){
  opts = opts || {};
  var timeout = opts.timeout || 3000, interval = opts.interval || 40;
  return new Promise(function(res){
    var t0 = performance.now();
    function check(){
      if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function') return res(true);
      if (performance.now() - t0 > timeout) return res(false);
      setTimeout(check, interval);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', check, {once:true});
    else check();
  });
}
function hydrateFromSnapshot(){
  return new Promise(function(resolve){
    (function(){
      waitForPersistReady().then(function(){
        try{
          if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function'){
            IZZA_PERSIST.load().then(function(){
              try{ writeCraftAll(readCraftAny()); }catch(_){}
              resolve(readCoinsLS());
            }).catch(function(){ resolve(readCoinsLS()); });
          } else {
            resolve(readCoinsLS());
          }
        }catch(_){ resolve(readCoinsLS()); }
      });
    })();
  });
}

/* Best-effort session ping (no redirect) + capture character */
var LAST_CHARACTER = null;
function ensureSession(){
  return fetch(withAuth('/izza-game/api/character'), { credentials:'include', headers: bearerHeaders() })
    .then(function(r){
      if(!r.ok) return;
      return r.json().catch(function(){ return {}; }).then(function(j){
        var uname = (j.user && j.user.username) || j.username || j.handle || '';
        if (uname) { publishUsername(uname); }
        LAST_CHARACTER = j || LAST_CHARACTER;
        try{ localStorage.setItem('izzaCharacter', JSON.stringify(j)); }catch(_){}
      });
    }).catch(function(){});
}

/* =========================
   Avatar pipeline (same as Arena)
   ========================= */
var SPRITES = {
  body:{ default:"/static/game/sprites/body/default.png", street_a:"/static/game/sprites/body/street_a.png", street_b:"/static/game/sprites/body/street_b.png" },
  hair:{ short:"/static/game/sprites/hair/short.png", buzz:"/static/game/sprites/hair/buzz.png", long:"/static/game/sprites/hair/long.png" },
  outfit:{ street:"/static/game/sprites/outfit/street.png", athletic:"/static/game/sprites/outfit/athletic.png", luxury:"/static/game/sprites/outfit/luxury.png" }
};
var SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
var SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#6A402A","#432818"] };
var FEMALE_DRESS_BASE=["#7AB6FF","#4E84E3","#2F5CB5"];
var FEMALE_DRESS_TO={ blue:["#7AB6FF","#4E84E3","#2F5CB5"], red:["#FF7A7A","#E24C4C","#B12F2F"], green:["#7DD68A","#4CB56B","#2F7F47"], purple:["#B796FF","#8C6BE0","#6A49B8"], yellow:["#FFE08A","#E7C45A","#B89433"], pink:["#FFA6D6","#E57CB2","#C45C96"], black:["#3A3A3D","#232326","#0E0E10"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], brown:["#A87854","#7C563A","#593D29"], orange:["#FFB46A","#E4873A","#B65E1F"] };
var HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], blue:["#7AB6FF","#4E84E3","#2F5CB5"], green:["#7DD68A","#4CB56B","#2F7F47"], pink:["#FFA6D6","#E57CB2","#C45C96"] };

function loadImg(src){ return new Promise(function(res){ var i=new Image(); i.crossOrigin='anonymous'; i.onload=function(){res(i)}; i.onerror=function(){res(null)}; i.src=src; }); }
function hexToRgb(h){ var n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
function dist2(a,b){var dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;}
function lum(r,g,b){return 0.2126*r+0.7152*g+0.0722*b;}

function extractThreeToneRamp(img){
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var d=c.getImageData(0,0,w,h).data, samples=[];
  for(var i=0;i<d.length;i+=4){ if(d[i+3]<10) continue; var r=d[i],g=d[i+1],b=d[i+2]; samples.push({r:r,g:g,b:b,L:lum(r,g,b)}); }
  if(samples.length<10) return ["#C8C8C8","#9C9C9C","#6E6E6E"];
  samples.sort(function(a,b){return a.L-b.L;});
  function pick(q){ var idx=Math.max(0,Math.min(samples.length-1,Math.floor(q*(samples.length-1)))); var s=samples[idx];
    return '#'+s.r.toString(16).padStart(2,'0')+s.g.toString(16).padStart(2,'0')+s.b.toString(16).padStart(2,'0'); }
  return [pick(0.2),pick(0.55),pick(0.85)];
}

function paletteSwap(img, fromRampHex, toRampHex, tolerance){
  if(!tolerance) tolerance=2000;
  var from=fromRampHex.map(hexToRgb), to=toRampHex.map(hexToRgb);
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data; var changed=0;
  for(var i=0;i<d.length;i+=4){
    if(d[i+3]===0) continue;
    var p={r:d[i],g:d[i+1],b:d[i+2]}; var best=-1,score=1e9;
    for(var k=0;k<from.length;k++){ var s=dist2(p,from[k]); if(s<score){score=s;best=k;} }
    if(score<=tolerance){ var t=to[best]||to[1]||to[0]; if(d[i]!==t.r||d[i+1]!==t.g||d[i+2]!==t.b) changed++; d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b; }
  }
  c.putImageData(id,0,0);
  return {canvas:oc, changedPixels:changed};
}
function overlayTint(img, hex, strength){
  if(strength==null) strength=1.0;
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data, t=hexToRgb(hex);
  function ov(a,b){a/=255;b/=255;var o=(a<.5)?(2*a*b):(1-2*(1-a)*(1-b));return Math.round(o*255);}
  for(var i=0;i<d.length;i+=4){ if(d[i+3]===0) continue;
    var r=ov(d[i],t.r), g=ov(d[i+1],t.g), b=ov(d[i+2],t.b);
    d[i]=Math.round(d[i]*(1-strength)+r*strength);
    d[i+1]=Math.round(d[i+1]*(1-strength)+g*strength);
    d[i+2]=Math.round(d[i+2]*(1-strength)+b*strength);
  }
  c.putImageData(id,0,0);
  return oc;
}

function buildAvatarCanvas(dstCtx, size, profile){
  return new Promise(function(resolve){
    (function(){
      var DW=size,DH=size,X=0,Y=0;
      var type=profile.body_type||'male', tone=profile.skin_tone||'light', theme=profile.sprite_skin||'default';
      var outfitKey=profile.outfit||'street', hairKey=profile.hair||'short', hairCol=profile.hair_color||'black';
      var femaleOut=profile.female_outfit_color||'blue';

      var body=null;
      function afterBody(){
        Promise.all([
          loadImg(SPRITES.hair[hairKey]||SPRITES.hair.short),
          (type==='female' ? Promise.resolve(null) : loadImg(SPRITES.outfit[outfitKey]||SPRITES.outfit.street))
        ]).then(function(arr){
          var hair=arr[0], outfit=arr[1];
          var bodyCanvas;
          if(body){
            var targetSkin=SKIN_TO[tone]||SKIN_TO.light;
            var swapped=paletteSwap(body, SKIN_BASE, targetSkin, 4000);
            bodyCanvas=swapped.canvas;
            if(swapped.changedPixels<8){ bodyCanvas=overlayTint(body, targetSkin[1], 0.98); }
          }
          if(type==='female' && bodyCanvas){
            var targetDress=FEMALE_DRESS_TO[femaleOut]||FEMALE_DRESS_TO.blue;
            var reDress=paletteSwap(bodyCanvas, FEMALE_DRESS_BASE, targetDress, 4000);
            bodyCanvas=reDress.canvas;
            if(reDress.changedPixels<6){ bodyCanvas=overlayTint(bodyCanvas, targetDress[1], 0.85); }
          }
          dstCtx.clearRect(0,0,DW,DH);
          if(bodyCanvas) dstCtx.drawImage(bodyCanvas, X, Y, DW, DH);
          if(outfit) dstCtx.drawImage(outfit, X, Y, DW, DH);
          if(hair){
            var detected=extractThreeToneRamp(hair), target=HAIR_TO[hairCol]||HAIR_TO.black;
            var swap=paletteSwap(hair, detected, target, 4000);
            var hairCanvas=swap.canvas;
            if(swap.changedPixels<8){ hairCanvas=overlayTint(hairCanvas, target[1], 1.0); }
            var hairY=(type==='female' && hairKey==='buzz') ? (Y-4) : Y;
            dstCtx.drawImage(hairCanvas, X, hairY, DW, DH);
          }
          resolve();
        });
      }
      if(type==='female'){
        var femaleWide='/static/game/sprites/body/'+theme+'__female_wide.png';
        var femaleSlim='/static/game/sprites/body/'+theme+'__female.png';
        loadImg(femaleWide).then(function(img){
          if(img) body=img;
          return img ? img : loadImg(femaleSlim);
        }).then(function(img){ if(img) body=img; afterBody(); });
      } else {
        loadImg(SPRITES.body[theme]||SPRITES.body.default).then(function(img){ body=img; afterBody(); });
      }
    })();
  });
}

/* Prepare an offscreen canvas the game will draw each frame */
var jetmanCanvas = document.createElement('canvas');
jetmanCanvas.width = jetmanCanvas.height = 96;
var jetCtx = jetmanCanvas.getContext('2d'); jetCtx.imageSmoothingEnabled=false;
function ensureAvatarSprite(){
  try{
    var profile = LAST_CHARACTER || JSON.parse(localStorage.getItem('izzaCharacter')||'{}') || {};
    return buildAvatarCanvas(jetCtx, 96, profile).then(function(){
      try{
        var url = jetmanCanvas.toDataURL('image/png');
        document.getElementById('avatar').setAttribute('href', url);
      }catch(_){}
    });
  }catch(_){ return Promise.resolve(); }
}

/* =========================
   GAME (SVG 3D)
   ========================= */
var svg = document.getElementById('scene');
var floorPoly = document.getElementById('floor');
var fogRect = document.getElementById('fog');
var roofsL = document.getElementById('roofsL');
var roofsR = document.getElementById('roofsR');
var obsLayer = document.getElementById('obstacles');
var clouds = document.getElementById('clouds');
var rays = document.getElementById('rays');
var thruster = document.getElementById('thruster');
var avatarNode = document.getElementById('avatar');

var W=0,H=0,dpr=1;
function hardResize(){
  var r = svg.getBoundingClientRect();
  var w = Math.max(1, Math.floor(r.width || window.innerWidth || 1));
  var h = Math.max(1, Math.floor(r.height || window.innerHeight || 1));
  dpr = Math.min(window.devicePixelRatio || 1, 2);
  if (w !== W || h !== H){
    W=w; H=h;
    svg.setAttribute('viewBox','0 0 '+W+' '+H);
    layout();
  }
}
function ensureSized(attempt){
  attempt = attempt||0;
  hardResize();
  if ((W<2 || H<2) && attempt<10) setTimeout(function(){ ensureSized(attempt+1); }, 60);
}
ensureSized();
addEventListener('resize', function(){ ensureSized(); }, false);

/* camera / projection */
var VPT_X=0, VPT_Y=0, VANISH_Y=-600, roadBottomHalf=0, roadTopHalf=0;
function lerp(a,b,t){ return a+(b-a)*t; }
function project(z){ var k=0.0105, t=1-Math.exp(-k*z);
  return { y:lerp(VANISH_Y,H,t), half:lerp(roadTopHalf,roadBottomHalf,t), t:t }; }
function layout(){ roadBottomHalf=W*0.55; roadTopHalf=W*0.08; VANISH_Y=-Math.max(520,H*0.75);
  VPT_X=W*0.5; VPT_Y=H*0.62; }

/* player */
var player = { y: 0, vy:0, r:18 };
var phys = { g: 1600, thrust: 1900, maxVy: 880 };
player.y = VPT_Y;
var thrust=false; addEventListener('keydown',function(e){ if(e.code==='Space') thrust=true; }, false);
addEventListener('keyup',function(e){ if(e.code==='Space') thrust=false; }, false);
svg.addEventListener('pointerdown', function(){ thrust=true; }, false);
addEventListener('pointerup', function(){ thrust=false; }, false);

/* world */
var time=0, last=performance.now(), worldZ=0, speed=190;
var STEP_Z=120, DEPTH_Z=24000;

/* dynamic rooftops (segments) */
var sides = { LEFT:0, RIGHT:1 };
var roofs = [[],[]];
function randRoofHeight(){ return H* (0.12 + Math.random()*0.34); }
function randRoofLen(){ return 260 + Math.random()*520; }
function ensureRoofSegments(toZ){
  for(var sideKey in sides){
    var side = sides[sideKey];
    var arr = roofs[side];
    var z = arr.length ? arr[arr.length-1].endZ : 0;
    while (z < toZ + DEPTH_Z){
      var len = randRoofLen();
      arr.push({ startZ:z, endZ:z+len, h: randRoofHeight(), el:null });
      z += len;
    }
  }
}
function roofHeightAt(side, zAbs){
  var arr = roofs[side];
  for (var i=0;i<arr.length;i++){
    var s = arr[i];
    if (zAbs >= s.startZ && zAbs < s.endZ) return s.h;
  }
  return H*0.2;
}
function trimRoofSegments(zAbs){
  for(var sideKey in sides){
    var side = sides[sideKey];
    var arr = roofs[side];
    while (arr.length && arr[0].endZ < zAbs - 200){
      if(arr[0].el && arr[0].el.parentNode) arr[0].el.parentNode.removeChild(arr[0].el);
      arr.shift();
    }
  }
}

/* obstacles on roofs/bars */
var obstacles=[]; // {type, spawnZ, laneT, side, size, mountH, alive, el}
var lanes=[0.30,0.50,0.70];
function chooseSideForLane(laneT){ return laneT<0.5 ? sides.LEFT : sides.RIGHT; }
function spawnObstacle(z0){
  if(z0==null) z0 = worldZ+420;
  var lane = lanes[(Math.random()*lanes.length)|0];
  var type = (Math.random()<0.16)?'bar' : (Math.random()<0.58?'ac':'duct');

  if (type==='bar'){
    var size = 0.45 + Math.random()*0.4;
    var h = H*(0.22 + Math.random()*0.34);
    obstacles.push({type:type, spawnZ:z0, laneT:lane, side:null, size:size, mountH:h, alive:true, el:null});
    return;
  }
  var side = chooseSideForLane(lane);
  var mountH = roofHeightAt(side, z0);
  var size2 = 0.55 + Math.random()*0.5;
  obstacles.push({type:type, spawnZ:z0, laneT:lane, side:side, size:size2, mountH:mountH, alive:true, el:null});
}
var lastSpawn = performance.now();
function spawnTick(now){
  var base=210, faster= Math.max(0.50, 1 - (game.score/1400));
  var iv = base*faster;
  if(now-lastSpawn>iv){
    lastSpawn=now; spawnObstacle();
    if(Math.random()<0.45) spawnObstacle(worldZ+420);
  }
}

/* helpers */
function edgesAt(z){ var p=project(z); var y=Math.max(p.y,VANISH_Y);
  var half=(y===VANISH_Y)?0.0001:p.half; return {y:y, lx:W/2-half-14, rx:W/2+half+14, t:p.t};}
function setPoints(poly, pts){ poly.setAttribute('points', pts.map(function(p){return p[0]+','+p[1]}).join(' ')); }

/* build static clouds once (parallax) */
(function buildClouds(){
  for(var i=0;i<18;i++){
    var c=document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    c.setAttribute('rx', 20+Math.random()*28);
    c.setAttribute('ry', 10+Math.random()*16);
    c.setAttribute('fill','rgba(200,240,255,.35)');
    clouds.appendChild(c);
  }
})();

/* draw background dynamic parts */
function drawBackground(){
  // move clouds along sides
  var n=clouds.children.length, sway=Math.sin(time*0.8)*8;
  for(var i=0;i<n;i++){
    var z = (i*520 + (worldZ*1.2)%520);
    var e = edgesAt(z);
    var y = Math.min(H, Math.max(VPT_Y+8, e.y));
    var xL = e.lx - 18 + sway, xR = e.rx + 18 - sway;
    var node=clouds.children[i];
    var pickL = (i%2===0);
    node.setAttribute('cx', pickL?xL:xR);
    node.setAttribute('cy', y);
    node.setAttribute('opacity', 0.18 + 0.35*e.t);
    node.setAttribute('rx', (16 + 28*e.t)*1.4);
    node.setAttribute('ry', (16 + 28*e.t));
  }
}

/* draw floor corridor polygon */
function drawFloor(){
  var L=[], R[]; /* <— FIXED: was `var L=[],R[];` */
  for(var z=0; z<=DEPTH_Z; z+=STEP_Z){
    var e=edgesAt(z);
    if(e.y>H && L.length) break;
    L.push([e.lx,e.y]); R.push([e.rx,e.y]);
  }
  var pts=[[W/2,VANISH_Y]];
  for(var i=R.length-1;i>=0;i--) pts.push([R[i][0], Math.min(R[i][1],H)]);
  for(var j=0;j<L.length;j++)   pts.push([L[j][0], Math.min(L[j][1],H)]);
  setPoints(floorPoly, pts);
}

/* draw rooftop extrusions as vertical quads */
function ensureRoofEls(){
  function ensure(sideGroup, sideIdx){
    var arr = roofs[sideIdx];
    for(var i=0;i<arr.length;i++){
      if (!arr[i].el){
        var g=document.createElementNS('http://www.w3.org/2000/svg','polygon');
        g.setAttribute('fill', sideIdx===0 ? '#101a2e' : '#0f192c');
        g.setAttribute('opacity','1');
        g.setAttribute('filter','url(#fSoft)');
        sideGroup.appendChild(g);
        arr[i].el=g;
      }
    }
  }
  ensure(roofsL, 0);
  ensure(roofsR, 1);
}
function drawRooftops(){
  ensureRoofEls();
  for (var sideKey in sides){
    var side = sides[sideKey]|0;
    var arr = roofs[side];
    for (var i=0;i<arr.length;i++){
      var seg = arr[i];
      var e0 = edgesAt(Math.max(0, worldZ - seg.startZ));
      var e1 = edgesAt(Math.max(0, worldZ - seg.endZ));
      if (e0.y>H && e1.y>H) continue;
      var eNear = e0.t>e1.t?e0:e1, eFar = e0.t>e1.t?e1:e0;
      var lipNear = seg.h * eNear.t;
      var lipFar  = seg.h * eFar.t;
      var xN = (side===0? eNear.lx : eNear.rx);
      var xF = (side===0? eFar.lx  : eFar.rx);
      var yN = Math.max(eNear.y, VPT_Y+8), yF = Math.max(eFar.y, VPT_Y+8);
      var pts = side===0
        ? [[xN, yN - lipNear],[xN- Math.max(6,12*eNear.t), yN],[xF- Math.max(6,12*eFar.t), yF],[xF, yF - lipFar]]
        : [[xN+ Math.max(6,12*eNear.t), yN],[xN, yN - lipNear],[xF, yF - lipFar],[xF+ Math.max(6,12*eFar.t), yF]];
      setPoints(seg.el, pts);

      if(!seg.edge){
        seg.edge=document.createElementNS('http://www.w3.org/2000/svg','rect');
        seg.edge.setAttribute('width','2'); seg.edge.setAttribute('height','6');
        seg.edge.setAttribute('fill','rgba(120,200,255,1)');
        (side===0?roofsL:roofsR).appendChild(seg.edge);
      }
      seg.edge.setAttribute('x', (side===0?xN-1:xN));
      seg.edge.setAttribute('y', (yN - lipNear)-2);
      seg.edge.setAttribute('opacity', 0.12 + 0.25*eNear.t);
    }
  }
}

/* obstacle factories */
function makeBar(){
  var g=document.createElementNS('http://www.w3.org/2000/svg','g');
  var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
  rect.setAttribute('rx','3'); rect.setAttribute('ry','3');
  rect.setAttribute('fill','rgba(140,170,255,.85)');
  rect.setAttribute('stroke','rgba(40,80,140,.6)'); rect.setAttribute('stroke-width','2');
  g.appendChild(rect);
  g._rect=rect;
  return g;
}
function makeUnit(){
  var g=document.createElementNS('http://www.w3.org/2000/svg','g');
  var top=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  var front=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  top.setAttribute('fill','url(#gFaceB)');
  front.setAttribute('fill','url(#gFaceA)');
  top.setAttribute('opacity','0.9'); front.setAttribute('opacity','0.95');
  g.appendChild(top); g.appendChild(front);
  g._top=top; g._front=front;
  return g;
}

/* draw or update a single obstacle */
function drawObstacle(o){
  var zRel = Math.max(0, worldZ - o.spawnZ);
  if(zRel>DEPTH_Z){ o.alive=false; if(o.el&&o.el.parentNode) o.el.parentNode.removeChild(o.el); return; }
  var e = edgesAt(zRel);
  var x = e.lx + (e.rx-e.lx)*o.laneT;
  var floorY = Math.max(e.y, VPT_Y + H*0.02);
  var roofY = floorY;
  if (o.side!=null){
    var mountTopPx = roofHeightAt(o.side, worldZ) * e.t;
    roofY = floorY - mountTopPx;
  }

  if(!o.el){
    o.el = (o.type==='bar') ? makeBar() : makeUnit();
    o.el.setAttribute('filter','url(#fSoft)');
    obsLayer.appendChild(o.el);
  }

  if(o.type==='bar'){
    var y = floorY - (o.mountH * e.t);
    var w = (e.rx-e.lx)*0.68, h = 10 + 26*e.t*o.size;
    o.el._rect.setAttribute('x', x - w/2);
    o.el._rect.setAttribute('y', y - h/2);
    o.el._rect.setAttribute('width', w);
    o.el._rect.setAttribute('height', h);
    o.el.setAttribute('opacity','0.95');
  } else {
    var w2 = 40 + 220*e.t*o.size, h2 = 22 + 120*e.t*o.size;
    var topDepth = Math.max(6, 10*e.t);
    var pTop = [
      [x - w2/2, roofY - h2],
      [x + w2/2, roofY - h2],
      [x + w2/2 + topDepth, roofY - h2 - topDepth],
      [x - w2/2 + topDepth, roofY - h2 - topDepth]
    ];
    var pFront = [
      [x - w2/2, roofY - h2],
      [x + w2/2, roofY - h2],
      [x + w2/2, roofY],
      [x - w2/2, roofY]
    ];
    setPoints(o.el._top, pTop);
    setPoints(o.el._front, pFront);
  }

  // collision
  var px=W*0.5, py=player.y;
  var hit=false;
  if (o.type==='bar'){
    var yBar = floorY - (o.mountH * e.t);
    hit = (Math.abs(x - px) < (e.rx-e.lx)*0.32) && (Math.abs(py - yBar) < 22);
  } else {
    var yTop = roofY;
    var unitH = 40*e.t*o.size + 26;
    hit = (Math.abs(x - px) < (e.rx-e.lx)*0.18) && (py > yTop - unitH) && (py < yTop + 18);
  }
  if(hit){ gameOver(); }
}

/* HUD / hi */
var hi=Number(localStorage.getItem('jet_hi')||0);
document.getElementById('hi').textContent = hi;

/* Score/coins mapping */
var COINS_PER_SCORE = 10;
var COINS_PER_CREDIT = 1000;

/* game state */
var scoreEl = document.getElementById('score');
var finishEl = document.getElementById('finish');
var finalScoreEl = document.getElementById('finalScore');
var finalCoinsEl = document.getElementById('finalCoins');
var finalCraftEl = document.getElementById('finalCraft');

var WALLET_READY=false, walletDirty=false, runStartCoins=0;
var game = { score:0, creditsMinted:0, ended:false };

function awardFromProgress(deltaScore){
  var addCoins = Math.max(0, Math.floor(deltaScore * COINS_PER_SCORE));
  if (addCoins>0) applyCoins(addCoins);
  var totalCoins = readCoinsLS();
  var creditsNow = Math.floor(totalCoins / COINS_PER_CREDIT);
  if (creditsNow > game.creditsMinted){
    var delta = creditsNow - game.creditsMinted;
    game.creditsMinted = creditsNow;
    applyCraftDelta(delta);
  }
}

/* wallet ops */
function persistWalletAndSave(){
  return new Promise(function(resolve){ try{
    writeCraftAll(readCraftAny());
    var saver = safeGet(window, ['IZZA_PERSIST','save']);
    if (typeof saver === 'function'){ saver().then(function(){ walletDirty=false; resolve(); }).catch(function(){ resolve(); }); }
    else if (typeof window._izzaForceSave === 'function'){ window._izzaForceSave(); walletDirty=false; resolve(); }
    else resolve();
  }catch(_){ resolve(); }});
}
function updateCoinsHUD(){ paintCoinsHUD(readCoinsLS()); }
function applyCoins(amount){
  return new Promise(function(resolve){
    var cur = (readCoinsLS()|0) + (amount|0);
    writeCoinsLS(cur); walletDirty = true;
    try{ window.dispatchEvent(new Event('izza-coins-changed')); }catch(_){}
    try{
      var saver = safeGet(window, ['IZZA_PERSIST','save']);
      if (typeof saver === 'function'){ saver().then(function(){ walletDirty=false; resolve(cur); }).catch(function(){ resolve(cur); }); }
      else resolve(cur);
    }catch(_){ resolve(cur); }
    try{ window.dispatchEvent(new CustomEvent('izza-wallet-changed', { detail:{ coins:cur, crafting:readCraftAny() } })); }catch(_){}
    WALLET_READY = true; updateCoinsHUD();
  });
}
function applyCraftDelta(delta){
  return new Promise(function(resolve){
    var val = readCraftAny() + (delta|0);
    writeCraftAll(val); walletDirty = true;
    try{
      var saver = safeGet(window, ['IZZA_PERSIST','save']);
      if (typeof saver === 'function'){ saver().then(function(){ walletDirty=false; resolve(); }).catch(function(){ resolve(); }); }
      else resolve();
    }catch(_){ resolve(); }
    try{ window.dispatchEvent(new CustomEvent('izza-wallet-changed', { detail:{ coins: readCoinsLS(), crafting:val } })); }catch(_){}
  });
}

/* game over */
function gameOver(){
  if (game.ended) return;
  game.ended = true;
  hi=Math.max(hi,Math.floor(game.score)); localStorage.setItem('jet_hi',hi);
  document.getElementById('hi').textContent=hi;

  var coinsNow = readCoinsLS();
  var coinsAwarded = Math.max(0, (coinsNow|0) - (runStartCoins|0));
  finalScoreEl.textContent = Math.floor(game.score);
  finalCoinsEl.textContent = coinsAwarded;
  finalCraftEl.textContent = Math.floor(coinsNow / COINS_PER_CREDIT) - Math.floor(runStartCoins / COINS_PER_CREDIT);

  finishEl.style.display = 'flex';
}

/* build light rays once */
(function buildRays(){
  for(var i=0;i<24;i++){
    var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('stroke-width','1.5');
    ln.setAttribute('stroke','url(#gFog)');
    rays.appendChild(ln);
  }
})();

/* main loop */
function frame(now){
  if (game.ended) return;
  var dt=Math.min(0.033,(now-last)/1000); last=now; time+=dt;

  // physics
  var ay = (thrust? -phys.thrust : phys.g);
  player.vy = Math.max(-phys.maxVy, Math.min(phys.maxVy, player.vy + ay*dt));
  player.y  = Math.max(H*0.20, Math.min(H*0.86, player.y + player.vy*dt));

  // advance
  var mps = (speed/3.6) * (thrust?1.18:1.0);
  worldZ += mps*dt;

  var prevScore = game.score;
  game.score  += mps*dt;
  scoreEl.textContent = Math.floor(game.score);

  var deltaScore = game.score - prevScore;
  if (deltaScore > 0.001) awardFromProgress(deltaScore);

  ensureRoofSegments(worldZ + DEPTH_Z*0.6);
  trimRoofSegments(worldZ);
  spawnTick(now);

  // render
  drawBackground();
  drawFloor();
  drawRooftops();

  for(var i=obstacles.length-1;i>=0;i--){
    var o=obstacles[i]; if(!o.alive){ obstacles.splice(i,1); continue; } drawObstacle(o);
  }

  // player avatar & thruster & rays
  var px = W/2, py = player.y;

  // thruster
  var flame = thrust ? 16+10*Math.sin(time*40) : 8;
  thruster.setAttribute('cx', px-22);
  thruster.setAttribute('cy', py+6);
  thruster.setAttribute('rx', flame);
  thruster.setAttribute('ry', 7);

  // avatar image (centered via x/y on <image> being -48,-48)
  avatarNode.setAttribute('transform', 'translate('+px+','+py+')');

  // rays
  for(var i=0;i<rays.children.length;i++){
    var a=(-0.55 + i/(rays.children.length-1)*1.1), len=H*1.2, x2=VPT_X + Math.tan(a)*len, y2=H+60;
    var ln=rays.children[i];
    ln.setAttribute('x1', VPT_X);
    ln.setAttribute('y1', py);
    ln.setAttribute('x2', x2);
    ln.setAttribute('y2', y2);
  }

  requestAnimationFrame(frame);
}

/* listeners */
window.addEventListener('storage', function(e){
  if (e && (e.key === 'izzaCoins' || (e.key && CRAFT_KEYS.indexOf(e.key)>=0))) updateCoinsHUD();
}, false);
document.addEventListener('visibilitychange', function(){
  if (document.hidden){
    if (walletDirty) { persistWalletAndSave(); }
  } else {
    updateCoinsHUD();
  }
}, false);
window.addEventListener('pagehide', function(){
  var saver = safeGet(window, ['IZZA_PERSIST','save']);
  if (walletDirty && typeof saver === 'function'){
    try{ saver(); walletDirty = false; }catch(_){}
  }
}, false);

/* =========================
   START button — SAME FLOW AS BASKETBALL
   ========================= */
var startBtn = document.getElementById('startBtn');
startBtn.addEventListener('click', startGame, false);
startBtn.addEventListener('touchstart', function(e){ e.preventDefault(); startGame(); }, false);

/* Initial HUD values */
updateCoinsHUD();

async function startGame(){
  try{
    var overlay = document.getElementById('startOverlay');

    // 0) If Arena handed us a fresh wallet, use it instantly
    var handoff = consumeWalletHandoff();
    if (handoff){ paintCoinsHUD(handoff.coins); }

    // 1) Warm session & Persist via hidden City frame (non-blocking)
    try{ await primeViaCityIframe(); }catch(_){}

    // 2) Best-effort session check (no redirect)
    try{ await ensureSession(); }catch(_){}

    // 3) Hydrate from Persist snapshot (server → LS)
    var snapCoins = await hydrateFromSnapshot();

    // Never regress the shown value after snapshot
    (function(){
      var shown = parseInt((coinsHUD.textContent||'0'), 10) || 0;
      var safe = Math.max(shown, snapCoins, readCoinsLS()||0);
      paintCoinsHUD(safe);
    })();

    // 4) Authoritative wallet fetch; adopt without decreasing
    try{
      var r = await fetch(withAuth('/izza-game/api/wallet'), { credentials:'include', headers: bearerHeaders() });
      if (r.ok){
        var parsed = parseWalletResponse(await r.json().catch(function(){return{};}));
        var apiCoins = Number(parsed.coins)||0;
        var apiCraft = Number(parsed.crafting)||0;

        var shown2 = parseInt((coinsHUD.textContent||'0'), 10) || 0;
        var nextCoins = Math.max(shown2, apiCoins);

        try{
          localStorage.setItem('izzaCoins', String(nextCoins));
          if (apiCraft>=0) writeCraftAll(apiCraft);
          window.dispatchEvent(new Event('izza-coins-changed'));
          window.dispatchEvent(new Event('izza-crafting-changed'));
        }catch(_){}
        paintCoinsHUD(nextCoins);
      }
    }catch(_){}

    // 5) Lock run baseline & start game
    WALLET_READY = true;
    runStartCoins = parseInt((coinsHUD.textContent||'0'), 10) || (readCoinsLS()||0);

    await ensureAvatarSprite();

    overlay.style.display = 'none';
    ensureSized();
    requestAnimationFrame(frame);
  }catch(e){ try{ console.error('start failed', e); }catch(_){} }
}

})();
</script>
</body>
</html>
