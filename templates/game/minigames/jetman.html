<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Jetman Rooftops ‚Äî IZZA GAME</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>

  <script>window.IZZA_PERSIST_BASE = 'https://izzagame.onrender.com';</script>

  <!-- username bootstrap (unchanged infra) -->
  <script>
    (function(){
      try{
        var params = new URLSearchParams(location.search);
        var u = (params.get('u') || '').toString().trim();
        if (!u) u = (localStorage.getItem('izzaUserU') || '').toString().trim();
        if (!u) {
          var raw = localStorage.getItem('piAuthUser');
          if (raw) { try { u = (JSON.parse(raw)||{}).username || ''; } catch(_){} }
        }
        if (u) {
          u = u.replace(/^@+/, '').toLowerCase();
          window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
          window.izzaUserKey = { get: function(){ return u; } };
          try { localStorage.setItem('izzaUserU', u); } catch(_){}
          try {
            if (!localStorage.getItem('piAuthUser')) {
              localStorage.setItem('piAuthUser', JSON.stringify({ username: u }));
            }
          } catch(_){}
        }
      }catch(_){}
    })();
  </script>
  <script src="/static/game/js/izza-persist.js"></script>

  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --hud:rgba(255,255,255,.10); --hudLine:rgba(255,255,255,.34); --arcade:#aef3ff;
      padding-bottom: constant(safe-area-inset-bottom);
      padding-bottom: env(safe-area-inset-bottom);
    }
    html,body{height:100%;margin:0;background:#071227;color:#e8eef7;font:14px/1.2 system-ui,Arial}
    body{
      background:
        radial-gradient(140% 90% at 50% 10%, rgba(60,120,220,.42), rgba(5,8,16,1) 70%) no-repeat,
        linear-gradient(#0f2c5a,#091427);
      caret-color: transparent;
    }
    .wrap{position:relative;max-width:480px;height:100svh;margin:0 auto;
          border-left:1px solid rgba(255,255,255,.10);border-right:1px solid rgba(255,255,255,.10);overflow:hidden}
    canvas{display:block;width:100%;height:100%}
    html,body,canvas,.wrap{
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none; touch-action:none;
    }
    #gl{position:absolute;inset:0;z-index:1}
    #ui{position:absolute;inset:0;z-index:2}
    .hud{position:absolute;left:10px;right:10px;top:10px;display:flex;justify-content:space-between;gap:8px;z-index:5}
    .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pill{
      background:var(--hud);
      border:1px solid var(--hudLine);
      backdrop-filter:blur(10px);
      padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;
      box-shadow:0 0 0 1px rgba(0,0,0,.15) inset, 0 2px 6px rgba(0,0,0,.25);
    }
    .pill strong{font-size:14px;color:var(--arcade); text-shadow:0 0 8px rgba(160,245,255,.75)}
    .startOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;
      background:radial-gradient(120% 120% at 50% 70%, rgba(100,190,255,.18), rgba(0,0,0,.45)); transition:opacity .18s ease}
    .startCard{background:rgba(15,25,48,.75);border:1px solid var(--hudLine);border-radius:14px;padding:16px 18px;
      display:flex;flex-direction:column;gap:12px;align-items:center;backdrop-filter:blur(8px);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 14px;border-radius:10px;border:1px solid var(--hudLine);
         background:rgba(255,255,255,.06);color:inherit;text-decoration:none;font-weight:800; cursor:pointer}
    .finish{position:absolute;left:10px;right:10px;bottom:10px;display:none;gap:8px;flex-wrap:wrap;z-index:7}
    .finish .pill{font-size:12px}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="hud">
      <div class="row">
        <span class="pill">SCORE: <strong id="score">0</strong></span>
        <span class="pill">HIGH: <strong id="hi">0</strong></span>
      </div>
      <div class="row">
        <span class="pill">COINS: <strong id="coinsHUD">0</strong></span>
        <button id="muteBtn" class="btn" type="button" aria-pressed="false">üîà</button>
      </div>
    </div>

    <div id="startOverlay" class="startOverlay" aria-live="polite">
      <div class="startCard">
        <div style="font-weight:900;letter-spacing:.4px">JETMAN ROOFTOPS</div>
        <div style="font-size:12px;opacity:.95;text-align:center">
          Tap/hold to thrust up. <strong>Dodge neon bars</strong>. Touching a bar or the top/ground = crash.
        </div>
        <div class="row">
          <a id="backBtn" class="btn" href="/izza-game/minigames">‚Üê Back</a>
          <button id="startBtn" class="btn" type="button">START</button>
          <a id="cityBtn" class="btn" href="/izza-game/play">City</a>
        </div>
      </div>
    </div>

    <canvas id="gl"></canvas>
    <canvas id="ui"></canvas>

    <div class="finish" id="finish">
      <span class="pill">Run Score: <strong id="finalScore">0</strong></span>
      <span class="pill">Coins Awarded: <strong id="finalCoins">0</strong></span>
      <span class="pill">Craft Credits: <strong id="finalCraft">0</strong></span>
      <button class="btn" id="againBtn">Play Again</button>
      <a class="btn" href="/izza-game/minigames" id="arenaBtn">Mini-Game Arena</a>
      <a class="btn" href="/izza-game/play" id="cityBtn2">Go to City</a>
    </div>
  </div>

<script>
(function(){
/* ========= util/base/state (unchanged infra) ========= */
function safeGet(obj, path){ try{ var cur=obj; for(var i=0;i<path.length;i++){ if(!cur || typeof cur!=='object') return undefined; cur=cur[path[i]]; } return cur; }catch(_){ return undefined; }}
var T_KEY='izzaTokenT', U_KEY='izzaUserU'; var urlParams = new URLSearchParams(location.search);
var T = urlParams.get('t') || ''; var U = (urlParams.get('u') || '').toString().trim();
try{ if (T) localStorage.setItem(T_KEY, T); else { var s = localStorage.getItem(T_KEY)||''; if (s){ var url=new URL(location.href); url.searchParams.set('t',s); history.replaceState(null,'',url.toString()); T=s; } } }catch(_){}
function publishUsername(u){ if (!u) return ''; u = u.replace(/^@+/, '').toLowerCase(); try{ localStorage.setItem(U_KEY, u); }catch(_){}
  window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u });
  window.izzaUserKey = { get: function(){ return u; } };
  try{ if (!localStorage.getItem('piAuthUser')) localStorage.setItem('piAuthUser', JSON.stringify({ username: u })); }catch(_){}
  return u; }
try{ if (U) publishUsername(U); else { var su = (localStorage.getItem(U_KEY)||'').toString().trim(); if (su){ var url2=new URL(location.href); url2.searchParams.set('u',su); history.replaceState(null,'',url2.toString()); U = publishUsername(su); } } }catch(_){}
function withAuth(href){ var url = new URL(href, location.origin); if (T) url.searchParams.set('t', T); if (U) url.searchParams.set('u', U);
  return url.pathname + (url.search ? url.search : ''); }
document.getElementById('backBtn').href  = withAuth('/izza-game/minigames');
document.getElementById('cityBtn').href   = withAuth('/izza-game/play');
document.getElementById('cityBtn2').href  = withAuth('/izza-game/play');

function bearerHeaders(base) { var headers = Object.assign({ 'content-type':'application/json' }, base || {}); try{ var bearer = localStorage.getItem('izzaBearer') || ''; if (bearer) headers['authorization'] = 'Bearer ' + bearer; }catch(_){}
  return headers; }
function parseWalletResponse(j){ if (!j || typeof j !== 'object') return { coins:0, crafting:0 }; if ('coins' in j || 'crafting' in j || 'credits' in j){
  var craft = (typeof j.crafting!=='undefined') ? j.crafting : j.credits; return { coins: Number(j.coins)||0, crafting: Number(craft)||0 }; }
  if (j.wallet)   return parseWalletResponse(j.wallet); if (j.balance)  return parseWalletResponse(j.balance); return { coins:0, crafting:0 }; }
var CRAFT_KEYS=['izzaCrafting','craftingCredits','izzaCraftCredits'];
function readCraftAny(){ for(var i=0;i<CRAFT_KEYS.length;i++){ var v=parseInt(localStorage.getItem(CRAFT_KEYS[i])||'0',10); if(isFinite(v)&&v>0) return v|0; } var v0=parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10)||0; return v0|0; }
function writeCraftAll(v){ var n=Math.max(0,v|0); for(var i=0;i<CRAFT_KEYS.length;i++) localStorage.setItem(CRAFT_KEYS[i],String(n));
  try{ window.dispatchEvent(new Event('izza-crafting-changed')); }catch(_){ } }
function readCoinsLS(){ return (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0); }
function writeCoinsLS(v){ localStorage.setItem('izzaCoins', String((v|0))); }
var coinsHUD = document.getElementById('coinsHUD'); function paintCoinsHUD(n){ coinsHUD.textContent = String(Math.max(0, n|0)); }
function consumeWalletHandoff(maxAgeMs){ if(!maxAgeMs) maxAgeMs = 120000; try{ var raw = sessionStorage.getItem('izzaWalletHandoff'); if(!raw) return null;
  var s = JSON.parse(raw); if(!s || !s.ts || (Date.now() - s.ts) > maxAgeMs) return null; if (s.user){ var u = s.user.toString().trim().replace(/^@+/, '').toLowerCase();
    window.__IZZA_PROFILE__ = Object.assign({}, window.__IZZA_PROFILE__, { username: u }); window.izzaUserKey = { get: function(){ return u; } };
    try{ localStorage.setItem('izzaUserU', u); localStorage.setItem('piAuthUser', JSON.stringify({ username:u })); }catch(_){}
    U = u; } localStorage.setItem('izzaCoins', String(s.coins|0)); localStorage.setItem('izzaCrafting', String(s.craft|0)); return { coins:s.coins|0, craft:s.craft|0 }; }catch(_){ return null; } }
function primeViaCityIframe(opts){ opts = opts || {}; var maxWaitMs = opts.maxWaitMs || 8000; var pollMs = opts.pollMs || 120; return new Promise(function(resolve){
  var f=null, done=false, hard=null, poll=null; function finish(){ if(done) return; done=true; try{ clearTimeout(hard); clearInterval(poll); if(f) f.parentNode && f.parentNode.removeChild(f); }catch(_){}
    resolve('ok'); } var src = withAuth('/izza-game/play?prime=1&silent=1'); f=document.createElement('iframe'); f.src=src;
  var st=f.style; st.position='fixed'; st.width='0'; st.height='0'; st.opacity='0'; st.pointerEvents='none'; st.border='0'; document.body.appendChild(f);
  f.addEventListener('load', function(){ try{ var w=f.contentWindow; var tick=0; poll=setInterval(function(){ try{
    var canLoad = w && w.IZZA_PERSIST && typeof w.IZZA_PERSIST.load === 'function'; if (canLoad && tick<1){ tick++; w.IZZA_PERSIST.load().then(finish).catch(finish); } }catch(_){}
  }, pollMs); }catch(_){ } }, false); hard=setTimeout(finish, maxWaitMs); }); }
function waitForPersistReady(opts){ opts = opts || {}; var timeout = opts.timeout || 3000, interval = opts.interval || 40; return new Promise(function(res){
  var t0 = performance.now(); function check(){ if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function') return res(true);
    if (performance.now() - t0 > timeout) return res(false); setTimeout(check, interval); } if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', check, {once:true}); else check(); }); }
function hydrateFromSnapshot(){ return new Promise(function(resolve){ (function(){ waitForPersistReady().then(function(){ try{
  if (window.IZZA_PERSIST && typeof IZZA_PERSIST.load === 'function'){ IZZA_PERSIST.load().then(function(){ try{ writeCraftAll(readCraftAny()); }catch(_){}
    resolve(readCoinsLS()); }).catch(function(){ resolve(readCoinsLS()); }); } else { resolve(readCoinsLS()); } }catch(_){ resolve(readCoinsLS()); } }); })(); }); }
var LAST_CHARACTER = null;
function ensureSession(){ return fetch(withAuth('/izza-game/api/character'), { credentials:'include', headers: bearerHeaders() })
  .then(function(r){ if(!r.ok) return; return r.json().catch(function(){ return {}; }).then(function(j){ var uname = (j.user && j.user.username) || j.username || j.handle || '';
    if (uname) { publishUsername(uname); } LAST_CHARACTER = j || LAST_CHARACTER; try{ localStorage.setItem('izzaCharacter', JSON.stringify(j)); }catch(_){}
  }); }).catch(function(){}); }

/* ========= avatar pipeline (unchanged) ========= */
var SPRITES = {
  body:{ default:"/static/game/sprites/body/default.png", street_a:"/static/game/sprites/body/street_a.png", street_b:"/static/game/sprites/body/street_b.png" },
  hair:{ short:"/static/game/sprites/hair/short.png", buzz:"/static/game/sprites/hair/buzz.png", long:"/static/game/sprites/hair/long.png" },
  outfit:{ street:"/static/game/sprites/outfit/street.png", athletic:"/static/game/sprites/outfit/athletic.png", luxury:"/static/game/sprites/outfit/luxury.png" }
};
var SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
var SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#6A402A","#432818"] };
var FEMALE_DRESS_BASE=["#7AB6FF","#4E84E3","#2F5CB5"];
var FEMALE_DRESS_TO={ blue:["#7AB6FF","#4E84E3","#2F5CB5"], red:["#FF7A7A","#E24C4C","#B12F2F"], green:["#7DD68A","#4CB56B","#2F7F47"], purple:["#B796FF","#8C6BE0","#6A49B8"], yellow:["#FFE08A","#E7C45A","#B89433"], pink:["#FFA6D6","#E57CB2","#C45C96"], black:["#3A3AD","#232326","#0E0E10"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], brown:["#A87854","#7C563A","#593D29"], orange:["#FFB46A","#E4873A","#B65E1F"] };
var HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], blue:["#7AB6FF","#4E84E3","#2F5CB5"], green:["#7DD68A","#4CB56B","#2F7F47"], pink:["#FFA6D6","#E57CB2","#C45C96"] };
function loadImg(src){ return new Promise(function(res){ var i=new Image(); i.crossOrigin='anonymous'; i.onload=function(){res(i)}; i.onerror=function(){res(null)}; i.src=src; }); }
function hexToRgb(h){ var n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
function dist2(a,b){var dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;}
function lum(r,g,b){return 0.2126*r+0.7152*g+0.0722*b;}
function extractThreeToneRamp(img){
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var d=c.getImageData(0,0,w,h).data, samples=[];
  for(var i=0;i<d.length;i+=4){ if(d[i+3]<10) continue; var r=d[i],g=d[i+1],b=d[i+2]; samples.push({r:r,g:g,b:b,L:lum(r,g,b)}); }
  if(samples.length<10) return ["#C8C8C8","#9C9C9C","#6E6E6E"];
  samples.sort(function(a,b){return a.L-b.L;});
  function pick(q){ var idx=Math.max(0,Math.min(samples.length-1,Math.floor(q*(samples.length-1)))); var s=samples[idx];
    return '#'+s.r.toString(16).padStart(2,'0')+s.g.toString(16).padStart(2,'0')+s.b.toString(16,'0'); }
  return [pick(0.2),pick(0.55),pick(0.85)];
}
function paletteSwap(img, fromRampHex, toRampHex, tolerance){
  if(!tolerance) tolerance=2000;
  var from=fromRampHex.map(hexToRgb), to=toRampHex.map(hexToRgb);
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data; var changed=0;
  for(var i=0;i<d.length;i+=4){ if(d[i+3]===0) continue;
    var p={r:d[i],g:d[i+1],b:d[i+2]}; var best=-1,score=1e9;
    for(var k=0;k<from.length;k++){ var s=dist2(p,from[k]); if(s<score){score=s;best=k;} }
    if(score<=tolerance){ var t=to[best]||to[1]||to[0];
      if(d[i]!==t.r||d[i+1]!==t.g||d[i+2]!==t.b) changed++; d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b; }
  }
  c.putImageData(id,0,0);
  return {canvas:oc, changedPixels:changed};
}
function overlayTint(img, hex, strength){
  if(strength==null) strength=1.0;
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data, t=hexToRgb(hex);
  function ov(a,b){a/=255;b/=255;var o=(a<.5)?(2*a*b):(1-2*(1-a)*(1-b));return Math.round(o*255);}
  for(var i=0;i<d.length;i+=4){ if(d[i+3]===0) continue;
    var r=ov(d[i],t.r), g=ov(d[i+1],t.g), b=ov(d[i+2],t.b);
    d[i]=Math.round(d[i]*(1-strength)+r*strength);
    d[i+1]=Math.round(d[i+1]*(1-strength)+g*strength);
    d[i+2]=Math.round(d[i+2]*(1-strength)+b*strength);
  }
  c.putImageData(id,0,0);
  return oc;
}
function buildAvatarCanvas(dstCtx, size, profile){
  return new Promise(function(resolve){
    (function(){
      var DW=size,DH=size,X=0,Y=0;
      var type=profile.body_type||'male', tone=profile.skin_tone||'light', theme=profile.sprite_skin||'default';
      var outfitKey=profile.outfit||'street', hairKey=profile.hair||'short', hairCol=profile.hair_color||'black';
      var femaleOut=profile.female_outfit_color||'blue';
      var body=null;
      function afterBody(){
        Promise.all([
          loadImg(SPRITES.hair[hairKey]||SPRITES.hair.short),
          (type==='female' ? Promise.resolve(null) : loadImg(SPRITES.outfit[outfitKey]||SPRITES.outfit.street))
        ]).then(function(arr){
          var hair=arr[0], outfit=arr[1];
          var bodyCanvas;
          if(body){
            var targetSkin=SKIN_TO[tone]||SKIN_TO.light;
            var swapped=paletteSwap(body, SKIN_BASE, targetSkin, 4000);
            bodyCanvas=swapped.canvas;
            if(swapped.changedPixels<8){ bodyCanvas=overlayTint(body, targetSkin[1], 0.98); }
          }
          if(type==='female' && bodyCanvas){
            var targetDress=FEMALE_DRESS_TO[femaleOut]||FEMALE_DRESS_TO.blue;
            var reDress=paletteSwap(bodyCanvas, FEMALE_DRESS_BASE, targetDress, 4000);
            bodyCanvas=reDress.canvas;
            if(reDress.changedPixels<6){ bodyCanvas=overlayTint(bodyCanvas, targetDress[1], 0.85); }
          }
          dstCtx.clearRect(0,0,DW,DH);
          if(bodyCanvas) dstCtx.drawImage(bodyCanvas, X, Y, DW, DH);
          if(outfit) dstCtx.drawImage(outfit, X, Y, DW, DH);
          if(hair){
            var detected=extractThreeToneRamp(hair), target=HAIR_TO[hairCol]||HAIR_TO.black;
            var swap=paletteSwap(hair, detected, target, 4000);
            var hairCanvas=swap.canvas;
            if(swap.changedPixels<8){ hairCanvas=overlayTint(hairCanvas, target[1], 1.0); }
            var hairY=(type==='female' && hairKey==='buzz') ? (Y-4) : Y;
            dstCtx.drawImage(hairCanvas, X, hairY, DW, DH);
          }
          resolve();
        });
      }
      if(type==='female'){
        var femaleWide='/static/game/sprites/body/'+theme+'__female_wide.png';
        var femaleSlim='/static/game/sprites/body/'+theme+'__female.png';
        loadImg(femaleWide).then(function(img){ if(img) body=img; return img ? img : loadImg(femaleSlim); })
          .then(function(img){ if(img) body=img; afterBody(); });
      } else {
        loadImg(SPRITES.body[theme]||SPRITES.body.default).then(function(img){ body=img; afterBody(); });
      }
    })();
  });
}

/* ========= offscreen sprite canvas ========= */
var jetmanCanvas = document.createElement('canvas');
jetmanCanvas.width = jetmanCanvas.height = 96;
var jetCtx = jetmanCanvas.getContext('2d'); jetCtx.imageSmoothingEnabled=false;

/* ========= mapping / margins ========= */
var W=0,H=0,dpr=1; var TOP_Y = 4.8, BOT_Y = -5.3; var TOP_PX_MARGIN = 0, BOT_PX_MARGIN = 0, pixelsPerWorld = 1;
function computeMargins(){ var top = 90; var bottom = 160; try{
  var cs = getComputedStyle(document.documentElement); var pb = parseInt(cs.getPropertyValue('padding-bottom')) || 0;
  var envVal = cs.getPropertyValue('env(safe-area-inset-bottom)') || '0'; var envNum = parseInt(envVal) || 0; bottom += Math.max(pb, envNum);
}catch(_){}
  if (window.visualViewport && window.innerHeight){ var hidden = Math.max(0, window.innerHeight - window.visualViewport.height); bottom += Math.round(hidden); }
  return { top: top|0, bottom: bottom|0 }; }
function updateScale(){ var m = computeMargins(); TOP_PX_MARGIN = m.top|0; BOT_PX_MARGIN = m.bottom|0;
  var usable = Math.max(160, Math.min(H-40, H - TOP_PX_MARGIN - BOT_PX_MARGIN)); pixelsPerWorld = usable / (TOP_Y - BOT_Y); }
function worldToPxY(y){ var botPx = H - BOT_PX_MARGIN; var dy = (y - BOT_Y) * pixelsPerWorld; return botPx - dy; }

/* ========= THREE / GAME ========= */
var scene, camera, renderer;
var glCvs = document.getElementById('gl');
var uiCvs = document.getElementById('ui'), uiCtx = uiCvs.getContext('2d');
uiCtx.imageSmoothingEnabled=false;

uiCvs.addEventListener('contextmenu', function(e){ e.preventDefault(); }, false);

/* ====== AUDIO ====== */
var AudioMgr = (function(){
  let ctx, master, bgm, thrustNode=null, thrustGain=null, muted=false;
  function ensure(){
    if(ctx) return;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value = 1; master.connect(ctx.destination);
  }
  function setMuted(m){
    muted = !!m; if(!ctx) return;
    master.gain.value = muted ? 0 : 1;
  }
  function toggleMute(){ setMuted(!muted); return muted; }
  function startBGM(){
    ensure();
    if (bgm) return;
    var el = new Audio(withAuth('/static/game/audio/JETMANBGM.wav'));
    el.loop = true; el.preload = 'auto'; el.volume = 0.9;
    var src = ctx.createMediaElementSource(el); src.connect(master);
    bgm = el; el.play().catch(function(){});
  }
  function startThrust(){
    ensure(); if(thrustNode) return;
    thrustGain = ctx.createGain(); thrustGain.gain.value = 0.0; thrustGain.connect(master);
    // noise -> bandpass -> gain
    var bufferSize = 2 * ctx.sampleRate;
    var noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    var data = noiseBuffer.getChannelData(0);
    for (var i=0;i<bufferSize;i++) data[i] = Math.random()*2-1;
    var noise = ctx.createBufferSource(); noise.buffer = noiseBuffer; noise.loop = true;
    var bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 350; bp.Q.value=1.2;
    noise.connect(bp); bp.connect(thrustGain);
    noise.start(0);
    thrustNode = { noise:noise, bp:bp };
    // ramp in
    thrustGain.gain.cancelScheduledValues(ctx.currentTime);
    thrustGain.gain.linearRampToValueAtTime(0.0, ctx.currentTime);
    thrustGain.gain.linearRampToValueAtTime(0.5, ctx.currentTime+0.08);
  }
  function stopThrust(){
    if(!ctx || !thrustNode) return;
    thrustGain.gain.cancelScheduledValues(ctx.currentTime);
    thrustGain.gain.linearRampToValueAtTime(0.0, ctx.currentTime+0.06);
    setTimeout(function(){
      try{ thrustNode.noise.stop(); }catch(_){}
      thrustNode = null; thrustGain && thrustGain.disconnect();
      thrustGain = null;
    }, 120);
  }
  function crash(){
    ensure();
    var g = ctx.createGain(); g.gain.value = 0.8; g.connect(master);
    var o = ctx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(180, ctx.currentTime);
    o.connect(g);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.4);
    o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+0.4);
    o.stop(ctx.currentTime+0.42);
  }
  return { startBGM, startThrust, stopThrust, crash, toggleMute, setMuted };
})();

/* input */
let thrust=false;
function startThrust(){ thrust=true; AudioMgr.startThrust(); }
function stopThrust(){ thrust=false; AudioMgr.stopThrust(); }
uiCvs.addEventListener('pointerdown', function(e){ e.preventDefault(); startThrust(); }, false);
uiCvs.addEventListener('pointerup',   function(){ stopThrust(); }, false);
uiCvs.addEventListener('pointercancel', function(){ stopThrust(); }, false);
uiCvs.addEventListener('touchstart', function(e){ e.preventDefault(); startThrust(); }, {passive:false});
uiCvs.addEventListener('touchend',   function(){ stopThrust(); }, false);
uiCvs.addEventListener('touchcancel',function(){ stopThrust(); }, false);
addEventListener('keydown',function(e){ if(e.code==='Space') startThrust(); }, false);
addEventListener('keyup',  function(e){ if(e.code==='Space') stopThrust(); }, false);

document.getElementById('muteBtn').addEventListener('click', function(){
  var isMuted = AudioMgr.toggleMute();
  this.setAttribute('aria-pressed', String(isMuted));
  this.textContent = isMuted ? 'üîá' : 'üîà';
}, false);

function hardResize(){
  var r = glCvs.getBoundingClientRect();
  var w = Math.max(1, Math.floor(r.width || window.innerWidth || 1));
  var h = Math.max(1, Math.floor(r.height || window.innerHeight || 1));
  dpr = Math.min(window.devicePixelRatio || 1, 2);
  if (w !== W || h !== H){
    W=w; H=h; glCvs.width=W*dpr; glCvs.height=H*dpr; uiCvs.width=W*dpr; uiCvs.height=H*dpr; uiCtx.setTransform(dpr,0,0,dpr,0,0);
    if(renderer){ renderer.setSize(W, H, false); renderer.setPixelRatio(dpr); }
  } updateScale();
}
function ensureSized(attempt){ attempt = attempt||0; hardResize(); if ((W<2 || H<2) && attempt<10) setTimeout(function(){ ensureSized(attempt+1); }, 60); }
ensureSized(); addEventListener('resize', function(){ ensureSized(); }, false);

/* player + physics (unchanged) */
var player = { y: 0, vy:0, r:18 };
var phys = { g: 1500, thrust: 1850, maxVy: 820 };
var worldZ=0, speed=110, time=0, last=performance.now();
var corridorHalf=6.5, corridorHeight=10, DEPTH=300;

/* spawns/collision (base) */
var SPAWN_BASE = 1.8; var COLLISION_Z_NEAR = -0.4; var COLLISION_Z_FAR  =  1.8; var HITBOX_HALF = 0.55;
var nextImpactY = null;

/* Visual groups */
var wallLen = 6;
var buildingsL = null, buildingsR = null;
var cloudGroupTop = null, cloudGroupBot = null;
var hazeGroup = null, skylineFar = null;
var trafficGlow = null;
var trafficGroup = null;
var roofHazeGroup = null;
var neonDustGroup = null;

/* ===== init3D ===== */
function init3D(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x071629);
  scene.fog = new THREE.FogExp2(0x0b1c33, 0.020);

  camera = new THREE.PerspectiveCamera(55, W/H, 0.1, 1000);
  camera.position.set(0, 0, 6);
  camera.rotation.order = 'YXZ';

  renderer = new THREE.WebGLRenderer({canvas: glCvs, antialias: true, alpha: true});
  renderer.setPixelRatio(dpr); renderer.setSize(W,H,false);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.15;

  /* lights (unchanged) */
  var hemi = new THREE.HemisphereLight(0xbfdcff, 0x060b16, 0.9); scene.add(hemi);
  var amb = new THREE.AmbientLight(0x0e2f55, 0.9); scene.add(amb);
  var dir = new THREE.DirectionalLight(0xcfe6ff, 1.15); dir.position.set(-2,5,2); scene.add(dir);

  /* distant skyline silhouettes */
  skylineFar = new THREE.Group();
  (function(){
    var g = new THREE.BoxGeometry(1,1,1);
    for(var i=0;i<26;i++){
      var w = THREE.MathUtils.lerp(1.2,2.8,Math.random());
      var h = THREE.MathUtils.lerp(8,18,Math.random());
      var mx = (Math.random()<0.5?-1:1) * THREE.MathUtils.lerp(corridorHalf*1.4, corridorHalf*1.9, Math.random());
      var mat = new THREE.MeshBasicMaterial({color:0x0a1c33});
      var m = new THREE.Mesh(g, mat);
      m.scale.set(w,h,2.0);
      m.position.set(mx, -corridorHeight*0.5 + h/2, -THREE.MathUtils.lerp(80,110,Math.random()));
      skylineFar.add(m);
    }
    scene.add(skylineFar);
  })();

  /* asphalt street (single long plane) + center emissive (unchanged visuals) */
  (function(){
    var Wc=256,Hc=256,c=document.createElement('canvas'); c.width=Wc; c.height=Hc;
    var x=c.getContext('2d');
    x.fillStyle='#0a1426'; x.fillRect(0,0,Wc,Hc);
    for(var i=0;i<1400;i++){
      var a=Math.random()*0.06+0.06;
      x.fillStyle='rgba(255,255,255,'+a+')';
      x.fillRect((Math.random()*Wc)|0,(Math.random()*Hc)|0,1,1);
    }
    x.globalAlpha=0.15; x.fillStyle='#0a1426';
    x.fillRect(0,Hc*0.28,Wc,Hc*0.10);
    x.fillRect(0,Hc*0.62,Wc,Hc*0.10);
    x.globalAlpha=1;

    var mapTex=new THREE.CanvasTexture(c);
    mapTex.wrapS=mapTex.wrapT=THREE.RepeatWrapping;
    mapTex.repeat.set(2, 200);
    mapTex.anisotropy=4; mapTex.minFilter=THREE.LinearFilter; mapTex.generateMipmaps=false;

    var eC=document.createElement('canvas'); eC.width=4; eC.height=128;
    var ex=eC.getContext('2d'), g=ex.createLinearGradient(2,0,2,128);
    g.addColorStop(0,'rgba(255,90,40,1.0)');
    g.addColorStop(.5,'rgba(255,160,110,0.45)');
    g.addColorStop(1,'rgba(255,160,110,0.0)');
    ex.fillStyle=g; ex.fillRect(0,0,4,128);
    var emiss=new THREE.CanvasTexture(eC);
    emiss.wrapT=THREE.RepeatWrapping; emiss.repeat.y=150;
    emiss.minFilter=THREE.LinearFilter; emiss.generateMipmaps=false;

    var mat=new THREE.MeshStandardMaterial({
      map:mapTex, color:0xffffff, roughness:0.58, metalness:0.18,
      emissive:0x1a2e57, emissiveIntensity:0.95, emissiveMap:emiss
    });

    var plane = new THREE.Mesh(new THREE.PlaneGeometry(corridorHalf*1.2, DEPTH*8), mat);
    plane.rotateX(-Math.PI/2);
    plane.position.set(0, -corridorHeight*0.55 + 0.01, -DEPTH*3);
    trafficGlow = plane;
    scene.add(plane);

    var backCap = new THREE.Mesh(
      new THREE.PlaneGeometry(corridorHalf*3.0, corridorHeight*2.2),
      new THREE.MeshBasicMaterial({ color: 0x081427, fog: false })
    );
    backCap.position.set(0, -corridorHeight*0.05, -DEPTH*3.9);
    scene.add(backCap);
  })();

  /* neon dust (replaces rain) */
  neonDustGroup = new THREE.Group();
  (function(){
    function dustTex(col){
      return makeSoftCircle(128, [
        [0, 'rgba('+col.join(',')+',1.0)'],
        [0.4,'rgba('+col.join(',')+',0.45)'],
        [1,  'rgba('+col.join(',')+',0.0)']
      ]);
    }
    var paletteRGB = [
      [255,210,80],   // gold
      [0,255,245],    // neon teal
      [255,120,220]   // neon pink
    ];
    for (var i=0;i<160;i++){
      var col = paletteRGB[(Math.random()*paletteRGB.length)|0];
      var sTex = dustTex(col);
      var m = new THREE.SpriteMaterial({ map:sTex, transparent:true, depthWrite:false, blending:THREE.AdditiveBlending, opacity:THREE.MathUtils.lerp(0.4,0.85,Math.random()) });
      var p = new THREE.Sprite(m);
      var sc = THREE.MathUtils.lerp(0.10, 0.35, Math.random());
      p.scale.set(sc*4, sc*4, 1);
      p.position.set((Math.random()-.5)*corridorHalf*2.2, (Math.random()-.5)*4.2, -THREE.MathUtils.lerp(5,110,Math.random()));
      p.userData.vx = THREE.MathUtils.lerp(-0.05,0.05,Math.random());
      p.userData.vy = THREE.MathUtils.lerp(-0.08,0.08,Math.random());
      neonDustGroup.add(p);
    }
    scene.add(neonDustGroup);
  })();

  /* buildings + clouds + hazes + traffic */
  buildingsL = new THREE.Group(); buildingsR = new THREE.Group();
  scene.add(buildingsL, buildingsR); makeBuildings();

  cloudGroupTop = new THREE.Group(); cloudGroupBot = new THREE.Group();
  scene.add(cloudGroupTop, cloudGroupBot); seedCloudsSetup();
  seedClouds(cloudGroupTop,  corridorHeight*0.45);
  seedClouds(cloudGroupBot, -corridorHeight*0.62);

  hazeGroup = new THREE.Group();
  (function(){
    for (var i=0;i<12;i++){
      var hC = makeSoftCircle(256, [ [0,'rgba(120,180,220,0.10)'], [1,'rgba(120,180,220,0)'] ]);
      var mat = new THREE.SpriteMaterial({ map:hC, transparent:true, depthWrite:false, depthTest:false });
      var s = new THREE.Sprite(mat);
      var sc = THREE.MathUtils.lerp(10,18,Math.random());
      s.scale.set(sc, sc*0.6, 1);
      s.position.set(0, -corridorHeight*0.25, -THREE.MathUtils.lerp(10,110,Math.random()));
      hazeGroup.add(s);
    }
    scene.add(hazeGroup);
  })();

  /* ROOFLINE HAZE STRIP ‚Äî keeps horizon soft */
  roofHazeGroup = new THREE.Group();
  (function(){
    var tex = makeSoftCircle(512, [
      [0,'rgba(130,170,210,0.25)'],
      [0.55,'rgba(130,170,210,0.10)'],
      [1,'rgba(130,170,210,0)']
    ]);
    for (var i=0;i<6;i++){
      var s = new THREE.Sprite(new THREE.SpriteMaterial({map:tex, transparent:true, depthWrite:false}));
      var w = 28, h = 8;
      s.scale.set(w,h,1);
      s.position.set(0, -corridorHeight*0.02, -20 - i*25);
      roofHazeGroup.add(s);
    }
    scene.add(roofHazeGroup);
  })();

  trafficGroup = new THREE.Group();
  seedTraffic();
  scene.add(trafficGroup);

  setTimeout(function(){ AudioMgr.startBGM(); }, 0);
}

/* helper: soft sprite texture */
function makeSoftCircle(size, stops){
  var s=size||256, c=document.createElement('canvas'); c.width=c.height=s; var x=c.getContext('2d');
  var g=x.createRadialGradient(s/2,s/2,s*0.05, s/2,s/2,s*0.5);
  (stops||[[0,'rgba(255,255,255,.6)'],[1,'rgba(255,255,255,0)']]).forEach(function(st){ g.addColorStop(st[0], st[1]); });
  x.fillStyle=g; x.beginPath(); x.arc(s/2,s/2,s/2,0,Math.PI*2); x.fill();
  var t=new THREE.CanvasTexture(c); t.anisotropy=4; t.generateMipmaps=false; t.minFilter=THREE.LinearFilter;
  return t;
}

/* ===== window textures & brick (NEON WINDOWS) ===== */
function makeWindowTexture(opts){
  opts = opts || {};
  var W = opts.w || 128, H = opts.h || 256;
  var c = document.createElement('canvas'); c.width=W; c.height=H;
  var ctx = c.getContext('2d');
  ctx.fillStyle = opts.base || '#0a2a4f';
  ctx.fillRect(0,0,W,H);

  // subtle vertical banding
  for (var i=0;i<6;i++){
    ctx.fillStyle = 'rgba(200,230,255,'+(0.012*i)+')';
    ctx.fillRect(Math.round((i/6)*W), 0, 2, H);
  }

  var grids = [
    {gx:6, gy:16}, {gx:8, gy:20}, {gx:10, gy:24}
  ];
  var G = grids[(Math.random()*grids.length)|0];
  var gx = opts.gx || G.gx, gy = opts.gy || G.gy, padX = 6, padY = 6;
  var cellW = (W - padX*2)/gx, cellH = (H - padY*2)/gy;

  // hotter palette + magenta accents
  var palette = ['#fff6c4','#ffd46b','#ffb640','#aefbff','#86e0ff','#66ffd9','#ff77dd'];
  for (var y=0;y<gy;y++){
    for (var x=0;x<gx;x++){
      var on = Math.random() < (opts.lightProb || 0.80);
      var col = on ? palette[(Math.random()*palette.length)|0] : (opts.unlit || '#0f2e53');
      ctx.fillStyle = col;
      var rx = Math.round(padX + x*cellW + cellW*THREE.MathUtils.lerp(0.12,0.22,Math.random()));
      var ry = Math.round(padY + y*cellH + cellH*THREE.MathUtils.lerp(0.15,0.30,Math.random()));
      var rw = Math.round(cellW*THREE.MathUtils.lerp(0.45,0.80,Math.random()));
      var rh = Math.round(cellH*THREE.MathUtils.lerp(0.25,0.55,Math.random()));
      ctx.fillRect(rx, ry, rw, rh);
      if (on){
        ctx.globalCompositeOperation = 'screen';
        ctx.fillStyle = 'rgba(255,255,255,0.40)'; ctx.fillRect(rx-1, ry-1, rw+2, rh+2);
        ctx.fillStyle = 'rgba(255,255,255,0.20)'; ctx.fillRect(rx-2, ry-2, rw+4, rh+4);
        ctx.globalCompositeOperation = 'source-over';
      }
    }
  }
  var tex = new THREE.CanvasTexture(c);
  tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
  tex.anisotropy = 4; tex.generateMipmaps=false; tex.minFilter=THREE.LinearFilter;
  return tex;
}
function makeBrickTexture(){
  var W=128,H=128,c=document.createElement('canvas'); c.width=W; c.height=H;
  var x=c.getContext('2d'); x.fillStyle='#1a2540'; x.fillRect(0,0,W,H);
  x.fillStyle='#243459';
  var h=12, w=28, gap=2;
  for(var row=0,y=0;y<H;y+=h+gap,row++){
    var offset = (row%2? (w/2)|0 : 0);
    for(var cx= -offset; cx<W; cx+=w+gap){
      x.fillRect(cx, y, w, h);
      x.fillStyle='rgba(0,0,0,0.12)'; x.fillRect(cx, y+h-1, w, 1);
      x.fillStyle='#243459';
    }
  }
  var t=new THREE.CanvasTexture(c); t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(2,6);
  t.minFilter=THREE.LinearFilter; t.generateMipmaps=false;
  return t;
}
function randomFacadeMaterial(winTex, side){
  if (Math.random() < 0.25){
    var brick=makeBrickTexture();
    return new THREE.MeshStandardMaterial({
      map: brick, color:0xffffff,
      roughness: 0.7, metalness: 0.06,
    });
  }
  var hueTint = side==='L' ? 0x0e5aa6 : 0x0b4e94;
  return new THREE.MeshStandardMaterial({
    map: winTex, color:0xffffff,
    roughness: THREE.MathUtils.lerp(0.45,0.62,Math.random()),
    metalness: THREE.MathUtils.lerp(0.08,0.16,Math.random()),
    emissive: hueTint,
    emissiveMap: winTex,
    emissiveIntensity: THREE.MathUtils.lerp(1.6, 2.6, Math.random())  // MUCH brighter window glow
  });
}
function buildingMesh(w,h,mat,side){
  var g = new THREE.BoxGeometry(w, h, wallLen, 1,1,1);
  var uv = g.attributes.uv;
  for (var k=0; k<uv.count; k++){
    var u = uv.getX(k), v = uv.getY(k);
    uv.setXY(k, u*THREE.MathUtils.lerp(1.2,2.1, Math.random()), v*THREE.MathUtils.lerp(2.0,3.6, Math.random()));
  }
  var m = new THREE.Mesh(g, mat);
  var lean = THREE.MathUtils.degToRad( THREE.MathUtils.lerp(1.5,6.5, Math.random()) ) * (side==='L'?1:-1);
  m.rotation.z = lean;

  var r = Math.random();
  if (r<0.30){
    var roof = new THREE.Mesh(new THREE.BoxGeometry(w*THREE.MathUtils.lerp(.45,.85,Math.random()), w*THREE.MathUtils.lerp(.16,.28,Math.random()), wallLen*0.55),
                              new THREE.MeshBasicMaterial({color:0x0f2747}));
    roof.position.y = h/2 + roof.geometry.parameters.height/2;
    roof.position.z = THREE.MathUtils.lerp(-wallLen*0.15, wallLen*0.15, Math.random());
    m.add(roof);
  } else if (r<0.55){
    var antenna = new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,THREE.MathUtils.lerp(0.7,1.6,Math.random()),12),
                                 new THREE.MeshBasicMaterial({color:0x7aa6ff}));
    antenna.position.set(THREE.MathUtils.lerp(-w*0.2,w*0.2,Math.random()), h/2 + antenna.geometry.parameters.height/2, THREE.MathUtils.lerp(-0.2,0.2,Math.random()));
    m.add(antenna);
  } else if (r<0.75){
    var step = new THREE.Mesh(new THREE.BoxGeometry(w*0.55, w*0.20, wallLen*0.6),
                              new THREE.MeshBasicMaterial({color:0x10274a}));
    step.position.set(0, h/2 + w*0.10, 0);
    var spire = new THREE.Mesh(new THREE.ConeGeometry(0.10, 0.7, 8),
                               new THREE.MeshBasicMaterial({color:0x6ea8ff}));
    spire.position.set(0, step.position.y + 0.6, 0);
    m.add(step, spire);
  }
  return m;
}
function makeBuildings(){
  if (!buildingsL || !buildingsR) return;
  while (buildingsL.children.length) buildingsL.remove(buildingsL.children[0]);
  while (buildingsR.children.length) buildingsR.remove(buildingsR.children[0]);

  var winTexL = makeWindowTexture({ lightProb:0.92 });
  var winTexR = makeWindowTexture({ lightProb:0.88 });
  var z = -10, blocks = 40;
  for (var i=0;i<blocks;i++){
    var widthL = THREE.MathUtils.lerp(0.9, 1.8, Math.random());
    var widthR = THREE.MathUtils.lerp(0.9, 1.8, Math.random());
    var hL = THREE.MathUtils.lerp(corridorHeight*0.95, corridorHeight*2.6, Math.random());
    var hR = THREE.MathUtils.lerp(corridorHeight*0.95, corridorHeight*2.6, Math.random());

    var bL = buildingMesh(widthL, hL, randomFacadeMaterial(winTexL,'L'), 'L');
    var bR = buildingMesh(widthR, hR, randomFacadeMaterial(winTexR,'R'), 'R');

    var zOffset = THREE.MathUtils.lerp(-0.6, 0.6, Math.random());
    bL.position.set(-corridorHalf*1.02, -corridorHeight*0.5 + hL/2, z + zOffset);
    bR.position.set( corridorHalf*1.02, -corridorHeight*0.5 + hR/2, z - zOffset);

    buildingsL.add(bL); buildingsR.add(bR);
    z -= wallLen;
  }
}

/* ===== Obstacles ‚Äî yellow/green neon bars ===== */
var obstacles=[];
function spawnObstacle(){
  var w = corridorHalf*1.95;
  var t = THREE.MathUtils.lerp(0.28,0.42,Math.random());
  var margin = 0.10;
  var maxH = TOP_Y - HITBOX_HALF - margin;
  var minH = BOT_Y + HITBOX_HALF + margin*0.2;
  var h = THREE.MathUtils.lerp(minH, maxH, Math.random());
    var geo = new THREE.BoxGeometry(w, t, 1.6);
  // bright yellow‚Üígreen band
  var hue = THREE.MathUtils.lerp(0.17, 0.33, Math.random()); // ~yellow‚Üígreen
  var neon = new THREE.Color().setHSL(hue, 1.0, 0.5);

  var mat = new THREE.MeshStandardMaterial({
    color: neon, roughness: .15, metalness: .05,
    emissive: neon, emissiveIntensity: 3.0
  });
  var bar = new THREE.Mesh(geo, mat);

  // fat additive glow planes
  var glowGeo = new THREE.PlaneGeometry(w*1.10, t*8.0);
  var glowMat = new THREE.MeshBasicMaterial({
    color: neon, transparent:true, opacity:0.6, depthWrite:false,
    blending:THREE.AdditiveBlending
  });
  var glow1 = new THREE.Mesh(glowGeo, glowMat); glow1.rotation.x = Math.PI/2; glow1.position.z += 0.03;
  var glow2 = glow1.clone(); glow2.position.z -= 0.03;

  var group = new THREE.Group(); group.add(bar, glow1, glow2); group.position.set(0, h, -80);
  scene.add(group); obstacles.push({ mesh: group, type: 'bar', halfHeight: t/2 });
}

/* ===== Clouds / Neon dust motion ===== */
var _cloudTex = null;
function seedCloudsSetup(){
  if (_cloudTex) return;
  _cloudTex = makeSoftCircle(256, [
    [0,'rgba(255,255,255,0.75)'],
    [0.6,'rgba(220,240,255,0.35)'],
    [1,'rgba(255,255,255,0.0)']
  ]);
}
function seedClouds(group, y){
  var count = (group===cloudGroupTop?18:22);
  for (var i=0;i<count;i++){
    var sp = new THREE.Sprite(new THREE.SpriteMaterial({ map:_cloudTex, transparent:true, depthWrite:false, depthTest:false }));
    var sc = THREE.MathUtils.lerp(4, 10, Math.random());
    sp.scale.set(sc, sc, 1);
    sp.position.set(
      (Math.random()-.5)*corridorHalf*2.2,
      y + THREE.MathUtils.lerp(-0.5, 0.8, Math.random()),
      -THREE.MathUtils.lerp(10, 110, Math.random())
    );
    sp.material.opacity = THREE.MathUtils.lerp(0.22, 0.55, Math.random());
    group.add(sp);
  }
}
function tickClouds(dt, dz){
  var topPar = 0.5, botPar = 0.8;
  cloudGroupTop.children.forEach(function(s,i){
    s.position.z += dz*topPar; s.position.y += Math.sin(time*0.6 + i)*0.003;
    if (s.position.z > 5) s.position.z = -110;
  });
  cloudGroupBot.children.forEach(function(s,i){
    s.position.z += dz*botPar; s.position.y += Math.cos(time*0.5 + i)*0.003;
    if (s.position.z > 5) s.position.z = -110;
  });

  // shimmer windows
  if (buildingsL && buildingsL.children.length){
    var e = (time*0.14)%1;
    buildingsL.children.forEach(function(m){ if(m.material && m.material.emissiveMap){ m.material.emissiveMap.offset.y = e; m.material.emissiveMap.needsUpdate=true; }});
    buildingsR.children.forEach(function(m){ if(m.material && m.material.emissiveMap){ m.material.emissiveMap.offset.y = 1-e; m.material.emissiveMap.needsUpdate=true; }});
  }

  if (trafficGlow && trafficGlow.material && trafficGlow.material.emissiveMap){
    trafficGlow.material.emissiveMap.offset.y -= dz*0.0015;
    trafficGlow.material.emissiveMap.needsUpdate = true;
  }

  // roof haze slides with the world
  if (roofHazeGroup){
    roofHazeGroup.children.forEach(function(s){
      s.position.z += dz*0.9;
      if (s.position.z > 5) s.position.z = -120;
    });
  }

  // neon dust gentle float + parallax
  if (neonDustGroup){
    neonDustGroup.children.forEach(function(p){
      p.position.z += dz*0.7;
      p.position.x += p.userData.vx*dt*30;
      p.position.y += p.userData.vy*dt*30;
      if (p.position.z > 5){
        p.position.z = -THREE.MathUtils.lerp(60,110,Math.random());
        p.position.x = (Math.random()-.5)*corridorHalf*2.2;
        p.position.y = (Math.random()-.5)*4.2;
      }
    });
  }
}

/* ===== Traffic (two wider lanes, reversed flow, varied vehicles/colors) ===== */
const VEHICLE_COLORS = [
  0x1ec8ff, 0xff5ea1, 0xffd23c, 0x7dffb6, 0xa78bfa, 0x6ee7ff, 0xff8c3a, 0x66ffd9
];
const UNDERGLOW_COLORS = [0x40ffd7,0xffe066,0xff77dd,0xaefbff];

function makeLampSprites(){
  const head = makeSoftCircle(256, [[0,'rgba(255,255,255,1)'],[0.15,'rgba(255,255,255,0.95)'],[1,'rgba(255,255,255,0)']]);
  const tail = makeSoftCircle(256, [[0,'rgba(255,60,40,1)'],[0.2,'rgba(255,60,40,0.9)'],[1,'rgba(255,60,40,0)']]);
  return { head, tail };
}
const LAMPS = makeLampSprites();
function addLamp(group, tex, w, h, z, x, y){
  const s = new THREE.Sprite(new THREE.SpriteMaterial({map:tex, transparent:true, depthWrite:false, blending:THREE.AdditiveBlending}));
  s.scale.set(w,h,1); s.position.set(x,y,z); group.add(s);
}

/* ‚Äî base body piece helpers ‚Äî */
function addUnderglow(group, w, l, y){
  if (Math.random() < 0.55){
    const col = UNDERGLOW_COLORS[(Math.random()*UNDERGLOW_COLORS.length)|0];
    const fog = new THREE.Sprite(new THREE.SpriteMaterial({
      map: makeSoftCircle(256, [[0,'rgba('+((col>>16)&255)+','+((col>>8)&255)+','+(col&255)+',0.45)'],[1,'rgba(0,0,0,0)']]),
      transparent:true, depthWrite:false, blending:THREE.AdditiveBlending
    }));
    fog.scale.set(w*3.2, l*1.8, 1);
    fog.position.set(0, y+0.001, 0);
    fog.rotateX(-Math.PI/2);
    group.add(fog);
  }
}

/* Sedan / hatch */
function makeSedan(dir, bodyColor){
  const group = new THREE.Group();
  const L=5.4, W=1.6, H=0.75;
  const y0 = -corridorHeight*0.55 + H/2 + 0.02;
  const body = new THREE.Mesh(new THREE.BoxGeometry(W, H*0.55, L*0.78),
    new THREE.MeshStandardMaterial({color:bodyColor, roughness:0.35, metalness:0.5}));
  body.position.y = y0; group.add(body);
  const nose = new THREE.Mesh(new THREE.CapsuleGeometry(W*0.18, L*0.10, 6, 10),
    new THREE.MeshStandardMaterial({color:bodyColor, roughness:0.34, metalness:0.55}));
  nose.rotation.x=Math.PI/2; nose.position.set(0, y0, (dir>0?1:-1)*L*0.34); group.add(nose);
  const roof = new THREE.Mesh(new THREE.BoxGeometry(W*0.76, H*0.48, L*0.35),
    new THREE.MeshStandardMaterial({color:0x2d3d6a, roughness:0.25, metalness:0.5}));
  roof.position.set(0, y0+H*0.46, -L*0.06); group.add(roof);
  const fz=(dir>0)?+L*0.42:-L*0.42, rz=-fz, lampY=y0+H*0.05;
  addLamp(group,LAMPS.head,0.40,0.40,fz,-W*0.30,lampY);
  addLamp(group,LAMPS.head,0.40,0.40,fz,+W*0.30,lampY);
  addLamp(group,LAMPS.tail,0.44,0.44,rz,-W*0.30,lampY);
  addLamp(group,LAMPS.tail,0.44,0.44,rz,+W*0.30,lampY);
  addUnderglow(group,W,L,y0-0.01);
  group.userData = {speed:THREE.MathUtils.lerp(8,15,Math.random()), dir};
  return group;
}
/* Pickup */
function makePickup(dir, bodyColor){
  const group=new THREE.Group();
  const L=5.8,W=1.8,H=0.9;
  const y0=-corridorHeight*0.55+H/2+0.02;
  const cab=new THREE.Mesh(new THREE.BoxGeometry(W, H*0.55, L*0.45),
    new THREE.MeshStandardMaterial({color:bodyColor, roughness:0.38, metalness:0.5}));
  cab.position.set(0,y0,-L*0.05); group.add(cab);
  const bed=new THREE.Mesh(new THREE.BoxGeometry(W*0.96,H*0.42,L*0.35),
    new THREE.MeshStandardMaterial({color:0x152544, roughness:0.6, metalness:0.2}));
  bed.position.set(0,y0,-L*0.35); group.add(bed);
  const roof=new THREE.Mesh(new THREE.BoxGeometry(W*0.78,H*0.42,L*0.26),
    new THREE.MeshStandardMaterial({color:0x2d3d6a, roughness:0.25, metalness:0.5}));
  roof.position.set(0,y0+H*0.40,-L*0.12); group.add(roof);
  const fz=(dir>0)?+L*0.46:-L*0.46, rz=-fz, lampY=y0+H*0.02;
  addLamp(group,LAMPS.head,0.42,0.42,fz,-W*0.32,lampY);
  addLamp(group,LAMPS.head,0.42,0.42,fz,+W*0.32,lampY);
  addLamp(group,LAMPS.tail,0.46,0.46,rz,-W*0.32,lampY);
  addLamp(group,LAMPS.tail,0.46,0.46,rz,+W*0.32,lampY);
  addUnderglow(group,W,L,y0-0.01);
  group.userData={speed:THREE.MathUtils.lerp(7.5,13,Math.random()), dir};
  return group;
}
/* Van / boxy */
function makeVan(dir, bodyColor){
  const group=new THREE.Group();
  const L=6.2,W=1.9,H=1.1;
  const y0=-corridorHeight*0.55+H/2+0.02;
  const hull=new THREE.Mesh(new THREE.BoxGeometry(W,H*0.7,L*0.80),
    new THREE.MeshStandardMaterial({color:bodyColor, roughness:0.42, metalness:0.45}));
  hull.position.y=y0; group.add(hull);
  const roof=new THREE.Mesh(new THREE.BoxGeometry(W*0.9,H*0.35,L*0.45),
    new THREE.MeshStandardMaterial({color:0x2b3b68, roughness:0.28, metalness:0.45}));
  roof.position.set(0,y0+H*0.42,-L*0.1); group.add(roof);
  const fz=(dir>0)?+L*0.46:-L*0.46, rz=-fz, lampY=y0+H*0.02;
  addLamp(group,LAMPS.head,0.44,0.44,fz,-W*0.34,lampY);
  addLamp(group,LAMPS.head,0.44,0.44,fz,+W*0.34,lampY);
  addLamp(group,LAMPS.tail,0.50,0.50,rz,-W*0.34,lampY);
  addLamp(group,LAMPS.tail,0.50,0.50,rz,+W*0.34,lampY);
  addUnderglow(group,W,L,y0-0.01);
  group.userData={speed:THREE.MathUtils.lerp(7,12,Math.random()), dir};
  return group;
}
/* Semi (tractor + trailer) */
function makeSemi(dir, bodyColor){
  const group=new THREE.Group();
  const L=11.0,W=2.0,H=1.2;
  const y0=-corridorHeight*0.55+H/2+0.02;
  const trailer=new THREE.Mesh(new THREE.BoxGeometry(W*0.98,H*0.72,L*0.62),
    new THREE.MeshStandardMaterial({color:0x16243f, roughness:0.65, metalness:0.15}));
  trailer.position.set(0,y0, -L*0.10); group.add(trailer);
  const tractor=new THREE.Mesh(new THREE.BoxGeometry(W*0.90,H*0.70,L*0.22),
    new THREE.MeshStandardMaterial({color:bodyColor, roughness:0.40, metalness:0.45}));
  tractor.position.set(0,y0, (dir>0?1:-1)*L*0.34); group.add(tractor);
  const cab=new THREE.Mesh(new THREE.BoxGeometry(W*0.78,H*0.42,L*0.12),
    new THREE.MeshStandardMaterial({color:0x2b3b68, roughness:0.28, metalness:0.45}));
  cab.position.set(0,y0+H*0.36, tractor.position.z - (dir>0?L*0.02:-L*0.02)); group.add(cab);
  const fz=(dir>0)?+L*0.44:-L*0.44, rz=-fz, lampY=y0+H*0.00;
  addLamp(group,LAMPS.head,0.48,0.48,fz,-W*0.34,lampY);
  addLamp(group,LAMPS.head,0.48,0.48,fz,+W*0.34,lampY);
  addLamp(group,LAMPS.tail,0.54,0.54,rz,-W*0.36,lampY);
  addLamp(group,LAMPS.tail,0.54,0.54,rz,+W*0.36,lampY);
  addUnderglow(group,W,L,y0-0.01);
  group.userData={speed:THREE.MathUtils.lerp(6,10,Math.random()), dir};
  return group;
}

function makeAnyVehicle(dir){
  const color = VEHICLE_COLORS[(Math.random()*VEHICLE_COLORS.length)|0];
  const r = Math.random();
  if (r < 0.50)  return makeSedan(dir, color);
  if (r < 0.75)  return makePickup(dir, color);
  if (r < 0.92)  return makeVan(dir, color);
  return makeSemi(dir, color);
}

// Reversed flow from previous build, wider lanes, anti-stacking spacing
function seedTraffic(){
  trafficGroup.clear();

  const LANES = [
    { x: -0.42, dir: +1 }, // LEFT lane now comes toward camera
    { x: +0.42, dir: -1 }  // RIGHT lane goes away
  ];
  const carsPerLane = 9;          // fewer to keep spacing
  const jitterZ = 4;
  const laneDepth = DEPTH;        // spread over whole canyon
  const minGap = 9;               // soft following distance

  for (const lane of LANES){
    let lastZ = 9999;
    for (let i=0; i<carsPerLane; i++){
      const car = makeAnyVehicle(lane.dir);
      car.position.x = lane.x;

      // evenly distribute then jitter
      const baseZ = - (i * (laneDepth / carsPerLane));
      car.position.z = baseZ - THREE.MathUtils.randFloatSpread(jitterZ);

      // ensure not stacked at spawn
      if (Math.abs(lastZ - car.position.z) < minGap) car.position.z -= minGap*1.1;
      lastZ = car.position.z;

      trafficGroup.add(car);
    }
  }
}

// Lane-follow movement + simple spacing rule to avoid stacking
function tickTraffic(dt, dz){
  const laneBuckets = { left:[], right:[] };
  trafficGroup.children.forEach(function(p){
    (p.position.x < 0 ? laneBuckets.left : laneBuckets.right).push(p);
  });
  // sort by z in travel direction so we can apply a tiny slowdown if too close
  [['left', +1], ['right', -1]].forEach(function([key, dir]){
    laneBuckets[key].sort(function(a,b){ return dir>0 ? b.position.z - a.position.z : a.position.z - b.position.z; });
    for (let i=0;i<laneBuckets[key].length;i++){
      const p = laneBuckets[key][i];
      let s = p.userData.speed;
      // check car ahead
      const ahead = laneBuckets[key][i-1];
      if (ahead && ((dir>0 && (p.position.z > ahead.position.z - 8)) || (dir<0 && (p.position.z < ahead.position.z + 8)))){
        s *= 0.85; // gentle slow
      }
      p.position.z += dt * s * p.userData.dir;

      // recycle at bounds
      if (p.userData.dir > 0 && p.position.z > 5){
        p.position.z = -DEPTH - Math.random()*10;
      } else if (p.userData.dir < 0 && p.position.z < -DEPTH){
        p.position.z = 5 + Math.random()*10;
      }
    }
  });
}

/* ===== recycle world ===== */
function advanceWorld(dz){
  var minZ = 5, maxZ = -120;
  if (buildingsL && buildingsR){
    for(var i=0;i<buildingsL.children.length;i++){
      var a = buildingsL.children[i], b = buildingsR.children[i];
      a.position.z += dz; b.position.z += dz;
      if(a.position.z > minZ){ a.position.z = maxZ; b.position.z = maxZ; }
    }
  }
  for(var i=obstacles.length-1;i>=0;i--){
    var o=obstacles[i]; o.mesh.position.z += dz;
    if(o.mesh.position.z > 5){ scene.remove(o.mesh); obstacles.splice(i,1); continue; }
  }
}

/* ===== HUD / hi / wallet glue (unchanged) ===== */
var hi = Number(localStorage.getItem('jet_hi') || 0);
document.getElementById('hi').textContent = hi;

var scoreEl = document.getElementById('score');
var finishEl = document.getElementById('finish');
var finalScoreEl = document.getElementById('finalScore');
var finalCoinsEl = document.getElementById('finalCoins');
var finalCraftEl = document.getElementById('finalCraft');

var COINS_PER_CREDIT = 1000;
var runStartCoins = 0;
function paintCoinsHUDNow(){ try{ document.getElementById('coinsHUD').textContent = String(readCoinsLS()|0); }catch(_){} }
paintCoinsHUDNow();

function applyCoins(delta){
  var cur = (readCoinsLS()|0) + (delta|0);
  writeCoinsLS(cur); paintCoinsHUDNow();
  try{ window.dispatchEvent(new Event('izza-coins-changed')); }catch(_){}
  return cur;
}

/* award 1 coin per whole score point crossed */
function awardFromProgress(deltaScore, game){
  var add = (Math.floor(game.score) - Math.floor(game.score - deltaScore))|0;
  if (add>0) applyCoins(add);
}

/* ===== Game over (unchanged) ===== */
function gameOver(){
  if (game.ended) return; game.ended = true;
  AudioMgr.crash();

  hi = Math.max(hi, Math.floor(game.score)); localStorage.setItem('jet_hi', hi);
  document.getElementById('hi').textContent = hi;

  var coinsNow = readCoinsLS()|0;
  finalScoreEl.textContent = Math.floor(game.score);
  finalCoinsEl.textContent = Math.max(0, coinsNow - (runStartCoins|0));
  finalCraftEl.textContent = Math.floor(coinsNow/COINS_PER_CREDIT) - Math.floor((runStartCoins|0)/COINS_PER_CREDIT);
  finishEl.style.display = 'flex';
}

/* ===== Moon on UI canvas (unchanged) ===== */
var moonCanvasTex = (function(){
  var s=256,c=document.createElement('canvas'); c.width=c.height=s; var x=c.getContext('2d');
  x.clearRect(0,0,s,s);
  x.fillStyle='#e8efff'; x.beginPath(); x.arc(s/2,s/2, s*0.34, 0, Math.PI*2); x.fill();
  x.fillStyle='rgba(140,160,190,0.55)';
  for(var i=0;i<18;i++){
    var r=THREE.MathUtils.lerp(6,16,Math.random());
    var a=THREE.MathUtils.randFloat(0,Math.PI*2);
    var R=THREE.MathUtils.lerp(0, s*0.28, Math.random());
    var cx=s/2 + Math.cos(a)*R, cy=s/2 + Math.sin(a)*R;
    x.beginPath(); x.ellipse(cx,cy, r, r*THREE.MathUtils.lerp(0.7,1.0,Math.random()), THREE.MathUtils.randFloat(0,Math.PI), 0, Math.PI*2); x.fill();
  }
  var g=x.createRadialGradient(s/2,s/2, s*0.2, s/2,s/2, s*0.46);
  g.addColorStop(0,'rgba(255,250,220,0.95)');
  g.addColorStop(0.6,'rgba(200,220,255,0.30)');
  g.addColorStop(1,'rgba(0,0,0,0)');
  x.fillStyle=g; x.beginPath(); x.arc(s/2,s/2,s*0.46,0,Math.PI*2); x.fill();
  return c;
})();

/* ===== UI draw ===== */
function drawUI(){
  uiCtx.clearRect(0,0,W,H);

  var moonW = Math.min(W*0.36, 200);
  uiCtx.drawImage(moonCanvasTex, (W-moonW)/2, 8, moonW, moonW);

  var spriteW = 96, spriteH = 96;
  var cx = W/2;
  var py = worldToPxY(player.y);
  var flameLen = thrust ? 22 + 12 * Math.sin(time * 40) : 10;
  var flameY = py + spriteH/2;

  uiCtx.fillStyle='rgba(255,240,140,.95)';
  uiCtx.beginPath(); uiCtx.ellipse(cx, flameY, flameLen, 9, 0, 0, Math.PI*2); uiCtx.fill();
  uiCtx.fillStyle='rgba(120,220,255,.65)';
  uiCtx.beginPath(); uiCtx.ellipse(cx, flameY, flameLen*0.6, 6, 0, 0, Math.PI*2); uiCtx.fill();

  uiCtx.drawImage(jetmanCanvas, cx - spriteW/2, py - spriteH*0.52, spriteW, spriteH);

  var grd = uiCtx.createRadialGradient(W/2, H*0.45, Math.min(W,H)*0.25, W/2, H/2, Math.max(W,H)*0.75);
  grd.addColorStop(0, 'rgba(0,0,0,0)');
  grd.addColorStop(1, 'rgba(0,0,0,0.32)');
  uiCtx.fillStyle = grd; uiCtx.fillRect(0,0,W,H);
}

/* ===== game state + loop (unchanged logic) ===== */
var game = { score:0, ended:false };
var SPAWN_BASE = 1.8;

var spawnTimer=0;
function frame(now){
  if (game.ended) return;
  var dt=Math.min(0.033,(now-last)/1000); last=now; time+=dt;

  // physics
  var ay = (thrust ? +phys.thrust : -phys.g);
  player.vy = Math.max(-phys.maxVy, Math.min(phys.maxVy, player.vy + ay*dt));
  var nextY = player.y + (player.vy*dt)/260;
  if(nextY <= BOT_Y || nextY >= TOP_Y){ gameOver(); return; }
  player.y = Math.max(BOT_Y, Math.min(TOP_Y, nextY));

  // forward motion
  var mps = (speed/3.6) * (thrust?1.12:1.0);
  worldZ += mps*dt;
  var dz = (mps*dt);

  advanceWorld(dz);
  tickClouds(dt, dz);
  tickTraffic(dt, dz);

  // spawn obstacles (faster as score rises)
  var difficulty = Math.max(0.55, 1.0 - (Math.floor(game.score)/1400));
  var SPAWN_INTERVAL = SPAWN_BASE * difficulty;
  spawnTimer += dt;
  if (spawnTimer > SPAWN_INTERVAL){ spawnTimer = 0; spawnObstacle(); }

  // camera tilt
  camera.position.y = player.y*0.6;
  camera.rotation.z = THREE.MathUtils.lerp(camera.rotation.z, (thrust?-0.03:0.03), 0.15);

  // collisions
  var bandTop = player.y + HITBOX_HALF;
  var bandBot = player.y - HITBOX_HALF;
  for (var i=0;i<obstacles.length;i++){
    var o = obstacles[i];
    var z = o.mesh.position.z;
    if (z > COLLISION_Z_NEAR && z < COLLISION_Z_FAR){
      var top  = o.mesh.position.y + o.halfHeight;
      var bot  = o.mesh.position.y - o.halfHeight;
      if (!(bandTop < bot || bandBot > top)){ gameOver(); return; }
    }
  }

  // score + coins
  var prevScore = game.score;
  game.score += mps*dt;
  scoreEl.textContent = Math.floor(game.score);
  var deltaScore = game.score - prevScore;
  if (deltaScore > 0.0001) awardFromProgress(deltaScore, game);

  // draw
  renderer.render(scene, camera);
  drawUI();

  requestAnimationFrame(frame);
}

/* ===== start / restart ===== */
function ensureAvatarSprite(){
  try{
    var profile = JSON.parse(localStorage.getItem('izzaCharacter')||'{}') || {};
    return buildAvatarCanvas(jetCtx, 96, profile);
  }catch(_){ return Promise.resolve(); }
}
function startGame(){
  try{
    var overlay = document.getElementById('startOverlay');
    overlay.style.display='none';
    runStartCoins = readCoinsLS()|0;
    ensureSized();
    obstacles.length = 0; worldZ=0; time=0; player.y=0; player.vy=0; game={score:0,ended:false};
    init3D();
    ensureAvatarSprite().then(function(){ requestAnimationFrame(frame); });
    AudioMgr.startBGM();
  }catch(e){ try{ console.error('start failed', e); }catch(_){} }
}
document.getElementById('startBtn').addEventListener('click', startGame, false);
document.getElementById('startBtn').addEventListener('touchstart', function(e){ e.preventDefault(); startGame(); }, false);

document.getElementById('againBtn').addEventListener('click', function(){
  finishEl.style.display='none';
  runStartCoins = readCoinsLS()|0;
  if (scene){ while(scene.children.length) scene.remove(scene.children[0]); }
  obstacles.length=0; worldZ=0; time=0; player.y=0; player.vy=0; game={score:0,ended:false};
  init3D(); requestAnimationFrame(frame);
}, false);

/* keep HUD in sync when other tabs change coins */
window.addEventListener('storage', function(e){
  if (e && e.key === 'izzaCoins') paintCoinsHUDNow();
}, false);

/* initial HUD paint */
paintCoinsHUDNow();

/* ===== Meta ===== */
/* Last visual pass: 2025-10-02 ‚Äî neon windows, neon dust, reversed/wider lanes, varied vehicles + underglow, yellow/green bars. */
})();
</script>
</body>
</html>
