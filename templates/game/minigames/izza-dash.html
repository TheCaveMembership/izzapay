<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>IZZA DASH — Puzzle Dash</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>

  <script>window.IZZA_PERSIST_BASE='https://izzagame.onrender.com';</script>
  <!-- username bootstrap (same as Jetman) -->
  <script>
    (function(){
      try{
        var params=new URLSearchParams(location.search);
        var u=(params.get('u')||'').toString().trim();
        if(!u) u=(localStorage.getItem('izzaUserU')||'').toString().trim();
        if(!u){
          var raw=localStorage.getItem('piAuthUser');
          if(raw){ try{ u=(JSON.parse(raw)||{}).username||''; }catch(_){ } }
        }
        if(u){
          u=u.replace(/^@+/,'').toLowerCase();
          window.__IZZA_PROFILE__=Object.assign({},window.__IZZA_PROFILE__,{username:u});
          window.izzaUserKey={ get:function(){return u;} };
          try{ localStorage.setItem('izzaUserU',u); }catch(_){}
          try{ if(!localStorage.getItem('piAuthUser')) localStorage.setItem('piAuthUser',JSON.stringify({username:u})); }catch(_){}
        }
      }catch(_){}
    })();
  </script>
  <script src="/static/game/js/izza-persist.js"></script>
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --hud:rgba(255,255,255,.10); --hudLine:rgba(255,255,255,.34); --arcade:#aef3ff;
      padding-bottom: env(safe-area-inset-bottom);
    }
    html,body{height:100%;margin:0;background:#050b16;color:#e8eef7;font:14px/1.2 system-ui,Arial}
    body{
      background:
        radial-gradient(140% 90% at 50% 10%, rgba(60,120,220,.32), rgba(5,8,16,1) 70%) no-repeat,
        linear-gradient(#0d2247,#070e1e);
      caret-color: transparent;
    }
    .wrap{position:relative;max-width:480px;height:100svh;margin:0 auto;
      border-left:1px solid rgba(255,255,255,.10);border-right:1px solid rgba(255,255,255,.10);overflow:hidden}
    canvas{display:block;width:100%;height:100%}
    html,body,canvas,.wrap{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;touch-action:none}
    #gl{position:absolute;inset:0;z-index:1}
    #ui{position:absolute;inset:0;z-index:2}
    .hud{position:absolute;left:10px;right:10px;top:10px;display:flex;justify-content:space-between;gap:8px;z-index:5}
    .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      background:var(--hud); border:1px solid var(--hudLine);
      backdrop-filter:blur(10px); padding:3px 8px; border-radius:999px;
      font-size:11px;font-weight:800; white-space:nowrap; line-height:1;
      box-shadow:0 0 0 1px rgba(0,0,0,.15) inset, 0 2px 6px rgba(0,0,0,.25);
    }
    .pill strong{font-size:13px;color:var(--arcade);text-shadow:0 0 8px rgba(160,245,255,.75);font-variant-numeric:tabular-nums}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:7px 12px;border-radius:10px;border:1px solid var(--hudLine);
         background:rgba(255,255,255,.06);color:inherit;text-decoration:none;font-weight:800;cursor:pointer}
    .startOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;
      background:radial-gradient(120% 120% at 50% 70%, rgba(100,190,255,.18), rgba(0,0,0,.45)); transition:opacity .18s ease}
    .startCard{background:rgba(15,25,48,.75);border:1px solid var(--hudLine);border-radius:14px;padding:16px 18px;
      display:flex;flex-direction:column;gap:12px;align-items:center;backdrop-filter:blur(8px);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .finish{position:absolute;left:10px;right:10px;bottom:10px;display:none;gap:8px;flex-wrap:wrap;z-index:7}
    /* avatar slot */
    .avatarSlot{position:absolute;left:8px;bottom:8px;width:120px;height:120px;z-index:4;pointer-events:none}
    .avatarSlot canvas{width:100%;height:100%;image-rendering:pixelated}
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="hud">
      <div class="row">
        <span class="pill">SCORE: <strong id="score">0</strong></span>
        <span class="pill">COMBOS: <strong id="comb">0</strong></span>
        <span class="pill">TIME: <strong id="time">0</strong>s</span>
      </div>
      <div class="row">
        <span class="pill">COINS: <strong id="coinsHUD">0</strong></span>
        <a id="backBtn" class="btn" href="/izza-game/minigames">← Back</a>
        <a id="cityBtn" class="btn" href="/izza-game/play">City</a>
      </div>
    </div>

    <div id="startOverlay" class="startOverlay">
      <div class="startCard" style="gap:14px;text-align:center">
        <h1 style="margin:0;font-size:22px;font-weight:900;letter-spacing:1px;color:#aef3ff;text-shadow:0 0 10px rgba(50,150,255,.9), 0 0 20px rgba(0,255,255,.7)">
          IZZA DASH — Puzzle Dash
        </h1>
        <div style="font-size:12.5px;opacity:.98;line-height:1.35">
          Build with <b>glass blocks</b>. Crystal spheres try to smash your build.<br>
          Tap to fire a <b>metal ball</b> that shatters incoming spheres.<br>
          Complete shapes &amp; survive to score. No countdown sounds.
        </div>
        <div class="row" style="justify-content:center">
          <button id="startBtn" class="btn" type="button">START</button>
        </div>
      </div>
    </div>

    <canvas id="gl"></canvas>
    <canvas id="ui"></canvas>
    <div class="avatarSlot"><canvas id="avatar" width="96" height="96"></canvas></div>

    <div class="finish" id="finish">
      <span class="pill">Run Score: <strong id="finalScore">0</strong></span>
      <span class="pill">Coins Awarded: <strong id="finalCoins">0</strong></span>
      <span class="pill">Craft Credits: <strong id="finalCraft">0</strong></span>
      <button class="btn" id="againBtn">Play Again</button>
      <a class="btn" href="/izza-game/minigames" id="arenaBtn">Mini-Game Arena</a>
      <a class="btn" href="/izza-game/play" id="cityBtn2">Go to City</a>
    </div>
  </div>

<script>
(function(){
/* ========= shared infra (trimmed from Jetman) ========= */
function safeGet(o,p){try{let c=o;for(let i=0;i<p.length;i++){if(!c||typeof c!=='object')return; c=c[p[i]];}return c;}catch(_){ }}
var T_KEY='izzaTokenT', U_KEY='izzaUserU'; var urlParams=new URLSearchParams(location.search);
var T=urlParams.get('t')||''; var U=(urlParams.get('u')||'').toString().trim();
try{ if(T) localStorage.setItem(T_KEY,T); else { var s=localStorage.getItem(T_KEY)||''; if(s){ var u=new URL(location.href); u.searchParams.set('t',s); history.replaceState(null,'',u.toString()); T=s; } } }catch(_){}
function publishUsername(u){ if(!u) return ''; u=u.replace(/^@+/,'').toLowerCase(); try{ localStorage.setItem(U_KEY,u);}catch(_){}
  window.__IZZA_PROFILE__=Object.assign({},window.__IZZA_PROFILE__,{username:u}); window.izzaUserKey={get:function(){return u;}};
  try{ if(!localStorage.getItem('piAuthUser')) localStorage.setItem('piAuthUser',JSON.stringify({username:u})); }catch(_){}
  return u;}
try{ if(U) publishUsername(U); else { var su=(localStorage.getItem(U_KEY)||'').toString().trim(); if(su){ var k=new URL(location.href); k.searchParams.set('u',su); history.replaceState(null,'',k.toString()); U=publishUsername(su); } } }catch(_){}
function withAuth(href){ var url=new URL(href,location.origin); if(T) url.searchParams.set('t',T); if(U) url.searchParams.set('u',U); return url.pathname+(url.search?url.search:'');}

['backBtn','cityBtn','arenaBtn','cityBtn2'].forEach(function(id){
  var a=document.getElementById(id); if(!a) return;
  a.href = withAuth(a.getAttribute('href')||a.href);
  a.addEventListener('click',function(e){ e.preventDefault(); location.href=withAuth(a.getAttribute('href')); }, false);
});

function bearerHeaders(base){ var h=Object.assign({'content-type':'application/json'},base||{}); try{var b=localStorage.getItem('izzaBearer')||''; if(b) h.authorization='Bearer '+b;}catch(_){}
  return h; }

var CRAFT_KEYS=['izzaCrafting','craftingCredits','izzaCraftCredits'];
function readCraftAny(){ for(const k of CRAFT_KEYS){ const v=parseInt(localStorage.getItem(k)||'0',10); if(Number.isFinite(v)&&v>0) return v|0; } return (parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10)||0)|0; }
function writeCraftAll(v){ const n=Math.max(0,v|0); for(const k of CRAFT_KEYS) localStorage.setItem(k,String(n));
  try{ window.dispatchEvent(new Event('izza-crafting-changed')); }catch(_){}
}
function readCoinsLS(){ return (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0); }
function writeCoinsLS(v){ localStorage.setItem('izzaCoins', String((v|0))); }
function paintCoinsHUDNow(){ try{ document.getElementById('coinsHUD').textContent = String(readCoinsLS()|0); }catch(_){} }
paintCoinsHUDNow();

/* ========= avatar + equipped overlay (same boxes as Jetman) ========= */
var SPRITES={ body:{ default:"/static/game/sprites/body/default.png", street_a:"/static/game/sprites/body/street_a.png", street_b:"/static/game/sprites/body/street_b.png" },
              hair:{ short:"/static/game/sprites/hair/short.png", buzz:"/static/game/sprites/hair/buzz.png", long:"/static/game/sprites/hair/long.png" },
              outfit:{ street:"/static/game/sprites/outfit/street.png", athletic:"/static/game/sprites/outfit/athletic.png", luxury:"/static/game/sprites/outfit/luxury.png" }};
var SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
var SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#6A402A","#432818"] };
var FEMALE_DRESS_BASE=["#7AB6FF","#4E84E3","#2F5CB5"];
var FEMALE_DRESS_TO={ blue:["#7AB6FF","#4E84E3","#2F5CB5"], red:["#FF7A7A","#E24C4C","#B12F2F"], green:["#7DD68A","#4CB56B","#2F7F47"], purple:["#B796FF","#8C6BE0","#6A49B8"], yellow:["#FFE08A","#E7C45A","#B89433"], pink:["#FFA6D6","#E57CB2","#C45C96"], black:["#3A3AD3","#232326","#0E0E10"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], brown:["#A87854","#7C563A","#593D29"], orange:["#FFB46A","#E4873A","#B65E1F"] };
var HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], blue:["#7AB6FF","#4E84E3","#2F5CB5"], green:["#7DD68A","#4CB56B","#2F7F47"], pink:["#FFA6D6","#E57CB2","#C45C96"] };
function loadImg(src){ return new Promise(function(res){ var i=new Image(); i.crossOrigin='anonymous'; i.onload=function(){res(i)}; i.onerror=function(){res(null)}; i.src=src; });}
function hexToRgb(h){ var n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
function dist2(a,b){var dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;}
function lum(r,g,b){return 0.2126*r+0.7152*g+0.0722*b;}
function extractThreeToneRamp(img){
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var d=c.getImageData(0,0,w,h).data, s=[]; for(var i=0;i<d.length;i+=4){ if(d[i+3]<10) continue; var r=d[i],g=d[i+1],b=d[i+2]; s.push({r:r,g:g,b:b,L:lum(r,g,b)}); }
  if(s.length<10) return ["#C8C8C8","#9C9C9C","#6E6E6E"]; s.sort(function(a,b){return a.L-b.L;});
  function pick(q){ var idx=Math.max(0,Math.min(s.length-1,Math.floor(q*(s.length-1)))); var t=s[idx]; return '#'+t.r.toString(16).padStart(2,'0')+t.g.toString(16).padStart(2,'0')+t.b.toString(16).padStart(2,'0'); }
  return [pick(0.2),pick(0.55),pick(0.85)];
}
function paletteSwap(img, fromRampHex, toRampHex, tol){ tol=tol||2000; var from=fromRampHex.map(hexToRgb), to=toRampHex.map(hexToRgb);
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data; var changed=0;
  for(var i=0;i<d.length;i+=4){ if(d[i+3]===0) continue; var p={r:d[i],g:d[i+1],b:d[i+2]}, best=-1,score=1e9;
    for(var k=0;k<from.length;k++){ var s=dist2(p,from[k]); if(s<score){score=s;best=k;} }
    if(score<=tol){ var t=to[best]||to[1]||to[0]; if(d[i]!==t.r||d[i+1]!==t.g||d[i+2]!==t.b) changed++; d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b; }
  }
  c.putImageData(id,0,0); return {canvas:oc, changedPixels:changed};
}
function overlayTint(img, hex, strength){ if(strength==null) strength=1.0;
  var w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  var c=oc.getContext('2d'); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  var id=c.getImageData(0,0,w,h), d=id.data, t=hexToRgb(hex);
  function ov(a,b){a/=255;b/=255;var o=(a<.5)?(2*a*b):(1-2*(1-a)*(1-b));return Math.round(o*255);}
  for(var i=0;i<d.length;i+=4){ if(d[i+3]===0) continue; var r=ov(d[i],t.r), g=ov(d[i+1],t.g), b=ov(d[i+2],t.b);
    d[i]=Math.round(d[i]*(1-strength)+r*strength); d[i+1]=Math.round(d[i+1]*(1-strength)+g*strength); d[i+2]=Math.round(d[i+2]*(1-strength)+b*strength);
  }
  c.putImageData(id,0,0); return oc;
}
async function buildAvatarCanvas(dstCtx, size, profile){
  const DW=size,DH=size,X=0,Y=0;
  const type=profile.body_type||'male', tone=profile.skin_tone||'light', theme=profile.sprite_skin||'default';
  const outfitKey=profile.outfit||'street', hairKey=profile.hair||'short', hairCol=profile.hair_color||'black';
  const femaleOut=profile.female_outfit_color||'blue';

  let body=null;
  if(type==='female'){
    body = await loadImg(`/static/game/sprites/body/${theme}__female_wide.png`) || await loadImg(`/static/game/sprites/body/${theme}__female.png`);
  } else body = await loadImg(SPRITES.body[theme]||SPRITES.body.default);

  const hair = await loadImg(SPRITES.hair[hairKey]||SPRITES.hair.short);
  const outfit = (type==='female') ? null : (await loadImg(SPRITES.outfit[outfitKey]||SPRITES.outfit.street));

  let bodyCanvas;
  if(body){
    const targetSkin=SKIN_TO[tone]||SKIN_TO.light;
    const swapped=paletteSwap(body, SKIN_BASE, targetSkin, 4000);
    bodyCanvas=swapped.canvas;
    if(swapped.changedPixels<8){ bodyCanvas=overlayTint(body, targetSkin[1], 0.98); }
  }
  if(type==='female' && bodyCanvas){
    const targetDress=FEMALE_DRESS_TO[femaleOut]||FEMALE_DRESS_TO.blue;
    const reDress=paletteSwap(bodyCanvas, FEMALE_DRESS_BASE, targetDress, 4000);
    bodyCanvas=reDress.canvas;
    if(reDress.changedPixels<6){ bodyCanvas=overlayTint(bodyCanvas, targetDress[1], 0.85); }
  }
  dstCtx.clearRect(0,0,DW,DH);
  if(bodyCanvas) dstCtx.drawImage(bodyCanvas, X, Y, DW, DH);
  if(outfit)     dstCtx.drawImage(outfit,     X, Y, DW, DH);
  if(hair){
    const detected=extractThreeToneRamp(hair), target=HAIR_TO[hairCol]||HAIR_TO.black;
    const swap=paletteSwap(hair, detected, target, 4000);
    let hairCanvas=swap.canvas;
    if(swap.changedPixels<8){ hairCanvas=overlayTint(hairCanvas, target[1], 1.0); }
    const hairY=(type==='female' && hairKey==='buzz') ? (Y-4) : Y;
    dstCtx.drawImage(hairCanvas, X, hairY, DW, DH);
  }
  await drawEquippedOverlaysForAvatar(dstCtx, size); // overlays like Jetman
}

/* equipped overlays (Jetman’s BOX128 scaled) */
(function(){
  const BOX128 = {
    head:{ w:59,h:59,ox:64,oy:32,scale:1.12 },
    chest:{ w:61,h:61,ox:64,oy:75,scale:1.15 },
    arms:{ w:75,h:59,ox:64,oy:61,scale:1.15 },
    legs:{ w:72,h:61,ox:64,oy:99,scale:1.18 },
    hands:{ w:85,h:61,ox:80,oy:85,scale:1.34 }
  };
  const cache=new Map();
  function imgFromSvg(svg){ if(!svg) return null; if(cache.has(svg)) return cache.get(svg);
    const i=new Image(); i.decoding='async'; i.src='data:image/svg+xml;utf8,'+encodeURIComponent(svg); cache.set(svg,i); return i; }
  function readInv(){ try{ const iz=window.IZZA&&IZZA.api&&IZZA.api.getInventory&&IZZA.api.getInventory(); if(iz) return JSON.parse(JSON.stringify(iz)); }catch(_){}
    try{ return JSON.parse(localStorage.getItem('izzaInventory')||'{}'); }catch(_){ return {}; } }
  function isEq(it){ return !!(it && (it.equipped===true||it.equip===true||((it.equippedCount|0)>0))); }
  function eqIn(slot){ const inv=readInv(); for(const k in inv){ const it=inv[k]; if(!it) continue;
      if(String(it.slot||'').toLowerCase()!==slot) continue; if(!isEq(it)) continue;
      const svg = (it.overlaySvg&&String(it.overlaySvg).trim()) || (it.iconSvg&&String(it.iconSvg).trim()) || '';
      return {key:k,it,svg}; } return null; }
  function drawOne(ctx,svg,box,mul){ var im=imgFromSvg(svg); if(!im||!im.complete) return false;
    var w=Math.max(8,box.w|0),h=Math.max(8,box.h|0);
    ctx.save(); ctx.imageSmoothingEnabled=false; ctx.translate((box.ox|0),(box.oy|0));
    var s=(box.scale||1)*(mul||1); if(s!==1) ctx.scale(s,s);
    try{ ctx.drawImage(im, -(w/2)|0, -(h/2)|0, w, h); }catch(_){}
    ctx.restore(); return true;}
  window.drawEquippedOverlaysForAvatar = async function(ctx,size){
    const k=(size>0?(size/128):1);
    const sc=b=>({ w:Math.round(b.w*k), h:Math.round(b.h*k), ox:Math.round(b.ox*k), oy:Math.round(b.oy*k), scale:b.scale });
    const parts={ head:eqIn('head'), chest:eqIn('chest'), arms:eqIn('arms'), legs:eqIn('legs'), hands:eqIn('hands') };
    const order=[
      parts.legs && {p:parts.legs, b:sc(BOX128.legs)},
      parts.chest&& {p:parts.chest,b:sc(BOX128.chest)},
      parts.arms && {p:parts.arms, b:sc(BOX128.arms)},
      parts.head && {p:parts.head, b:sc(BOX128.head)},
      parts.hands&& {p:parts.hands,b:sc(BOX128.hands)}
    ].filter(Boolean);
    order.forEach(e=>{ drawOne(ctx,e.p.svg,e.b, (typeof e.p.it.overlayScale==='number' ? e.p.it.overlayScale : 1)); });
  };
})();

/* paint avatar immediately */
(function(){
  const av=document.getElementById('avatar'); if(!av) return;
  const ctx=av.getContext('2d',{willReadFrequently:true});
  try{ const prof=JSON.parse(localStorage.getItem('izzaCharacter')||'{}'); buildAvatarCanvas(ctx,96,prof); }catch(_){}
  window.addEventListener('izza-inventory-changed',function(){
    try{ const prof=JSON.parse(localStorage.getItem('izzaCharacter')||'{}'); buildAvatarCanvas(ctx,96,prof); }catch(_){}
  }, {passive:true});
})();

/* ========= GL setup ========= */
var scene,camera,renderer,clock=new THREE.Clock();
var glCvs=document.getElementById('gl');
var uiCvs=document.getElementById('ui'), uiCtx=uiCvs.getContext('2d'); uiCtx.imageSmoothingEnabled=false;
var W=0,H=0,dpr=1;
function hardResize(){
  var r=glCvs.getBoundingClientRect();
  var w=Math.max(1,Math.floor(r.width||window.innerWidth||1));
  var h=Math.max(1,Math.floor(r.height||window.innerHeight||1));
  dpr=Math.min(window.devicePixelRatio||1,2);
  if(w!==W||h!==H){
    W=w; H=h; glCvs.width=W*dpr; glCvs.height=H*dpr; uiCvs.width=W*dpr; uiCvs.height=H*dpr; uiCtx.setTransform(dpr,0,0,dpr,0,0);
    if(renderer){ renderer.setSize(W,H,false); renderer.setPixelRatio(dpr); }
  }
}
addEventListener('resize', hardResize, false);

function init3D(){
  scene=new THREE.Scene();
  scene.background = new THREE.Color(0x050b16);
  scene.fog = new THREE.FogExp2(0x0a1626, 0.04);

  camera=new THREE.PerspectiveCamera(55, W/H, 0.1, 1000);
  camera.position.set(0,1.0,8);

  renderer=new THREE.WebGLRenderer({canvas:glCvs, antialias:true, alpha:true});
  renderer.setPixelRatio(dpr); renderer.setSize(W,H,false);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.15;

  // Lights
  const hemi=new THREE.HemisphereLight(0xbfdcff,0x061018,0.9); scene.add(hemi);
  const dir=new THREE.DirectionalLight(0xffffff,1.1); dir.position.set(-3,6,4); scene.add(dir);
  const fill=new THREE.PointLight(0x88b6ff,0.4,20); fill.position.set(3,2,6); scene.add(fill);

  // Ground pad
  const padG=new THREE.PlaneGeometry(10,10);
  const padM=new THREE.MeshStandardMaterial({color:0x0d1a2c, roughness:0.9, metalness:0.0});
  const pad=new THREE.Mesh(padG,padM); pad.rotateX(-Math.PI/2); pad.position.y=-1; scene.add(pad);

  // Build area frame (glossy ring)
  const ring=new THREE.Mesh(
    new THREE.RingGeometry(2.4,2.6,64),
    new THREE.MeshPhysicalMaterial({ color:0x88ccff, roughness:0.2, metalness:0.2, emissive:0x0e2f55, emissiveIntensity:0.35, transparent:true, opacity:0.9 })
  );
  ring.rotateX(-Math.PI/2); ring.position.y=-0.99; scene.add(ring);
}

/* ========= Materials ========= */
function glassMaterial({tint=0x66b6ff, ior=1.5, thick=0.5, rough=0.1, env=1.0}={}){
  return new THREE.MeshPhysicalMaterial({
    color: tint,
    transmission: 1.0,
    thickness: thick,
    ior: ior,
    roughness: rough,
    metalness: 0.0,
    reflectivity: env,
    opacity: 1.0,
    transparent: true
  });
}
function crystalMaterial(){ return glassMaterial({tint:0x99ddff, ior:1.45, thick:0.6, rough:0.02, env:1.0}); }
function stainedMaterial(){
  const hues=[0xff5ea1,0xffd23c,0x7dffb6,0xa78bfa,0x6ee7ff,0xff8c3a,0x66ffd9];
  return glassMaterial({tint: hues[(Math.random()*hues.length)|0], ior:1.52, thick:0.8, rough:0.06, env:1.0});
}
function ballBearingMaterial(){
  return new THREE.MeshStandardMaterial({ color:0xd0d5db, metalness:0.95, roughness:0.18 });
}

/* ========= Game pieces ========= */
const boardGroup=new THREE.Group(); const attackers=new THREE.Group(); const projectiles=new THREE.Group(); scene&&scene.add && (scene.add(boardGroup),scene.add(attackers),scene.add(projectiles));
let score=0, combos=0, timeLeft=60, ended=false;

function spawnBoard(){
  boardGroup.clear();
  // 6x6 grid of “wet glass” blocks
  const size=0.6, gap=0.05, startX=-((size+gap)*5)/2, startZ=-((size+gap)*5)/2;
  for(let i=0;i<6;i++){
    for(let j=0;j<6;j++){
      const r=Math.random();
      let mesh;
      if(r<0.33){
        mesh=new THREE.Mesh(new THREE.BoxGeometry(size,size,size), stainedMaterial());
      }else if(r<0.66){
        mesh=new THREE.Mesh(new THREE.ConeGeometry(size*0.6,size,4), stainedMaterial()); // pyramid
      }else{
        mesh=new THREE.Mesh(new THREE.ConeGeometry(size*0.5,size*1.1,4), stainedMaterial()); // tall pyramid
      }
      mesh.position.set(startX + i*(size+gap), -0.7, startZ + j*(size+gap));
      mesh.userData.kind='block';
      boardGroup.add(mesh);
    }
  }
}

function spawnSphere(){
  const m=new THREE.Mesh(new THREE.SphereGeometry(0.35, 24, 16), crystalMaterial());
  // Spawn around a ring, fly toward center
  const a=Math.random()*Math.PI*2; const r=5.8;
  m.position.set(Math.cos(a)*r, THREE.MathUtils.lerp(-0.2,1.2,Math.random()), Math.sin(a)*r);
  m.userData.vel = new THREE.Vector3(-m.position.x, -0.6 - m.position.y, -m.position.z).normalize().multiplyScalar(1.2 + Math.random()*0.6);
  m.userData.kind='attacker';
  attackers.add(m);
}

function fireProjectile(worldPos){
  // metal ball that homes to nearest attacker
  const p=new THREE.Mesh(new THREE.SphereGeometry(0.16,16,12), ballBearingMaterial());
  p.position.set(0, -0.6, 2.4); // from player/board front
  p.userData.vel = new THREE.Vector3().subVectors(worldPos, p.position).normalize().multiplyScalar(6.0);
  p.userData.kind='proj';
  projectiles.add(p);
}

const raycaster=new THREE.Raycaster(); const ndv=new THREE.Vector2();
uiCvs.addEventListener('pointerdown', function(e){
  const rect=uiCvs.getBoundingClientRect();
  ndv.x = ((e.clientX-rect.left)/rect.width)*2 - 1;
  ndv.y = -((e.clientY-rect.top)/rect.height)*2 + 1;
  raycaster.setFromCamera(ndv, camera);
  const point = raycaster.ray.origin.clone().add(raycaster.ray.direction.clone().multiplyScalar(6.0));
  fireProjectile(point);
}, {passive:true});

/* ========= Loop ========= */
let spawnT=0, sphereT=0;
function tick(dt){
  spawnT += dt; sphereT += dt;

  if(sphereT > 1.1){ sphereT = 0; spawnSphere(); }

  // move attackers
  attackers.children.forEach((m)=>{
    m.position.addScaledVector(m.userData.vel, dt);
    // collision with board blocks → remove block, reduce score
    boardGroup.children.forEach((b)=>{
      if(!b.visible) return;
      if (m.position.distanceTo(b.position) < 0.55){
        b.visible=false; // smashed
        m.visible=false;
        score = Math.max(0, score-3);
      }
    });
  });

  // move projectiles + hit test
  projectiles.children.forEach((p)=>{
    // simple homing: nudge toward nearest attacker
    let nearest=null, best=9e9;
    attackers.children.forEach(a=>{
      if(!a.visible) return;
      const d=a.position.distanceTo(p.position);
      if(d<best){best=d; nearest=a;}
    });
    if(nearest){
      const desired = new THREE.Vector3().subVectors(nearest.position, p.position).normalize().multiplyScalar(8.5);
      p.userData.vel.lerp(desired, 0.2);
    }
    p.position.addScaledVector(p.userData.vel, dt);

    attackers.children.forEach(a=>{
      if(!a.visible) return;
      if (p.position.distanceTo(a.position) < 0.42){
        // shatter: just hide and pop score
        a.visible=false; p.visible=false;
        score += 5; combos++;
      }
    });
  });

  // cleanup
  [attackers,projectiles].forEach(g=>{
    for(let i=g.children.length-1;i>=0;i--){
      const m=g.children[i]; if(!m.visible || m.position.length()>20){ g.remove(m); }
    }
  });

  timeLeft = Math.max(0, timeLeft - dt);
  if(timeLeft===0 && !ended){ gameOver(); }
}

function drawUI(){
  uiCtx.clearRect(0,0,W,H);
  document.getElementById('score').textContent = Math.floor(score);
  document.getElementById('comb').textContent  = combos|0;
  document.getElementById('time').textContent  = Math.ceil(timeLeft);
}

function frame(){
  if(ended) return;
  const dt=Math.min(0.033, clock.getDelta());
  tick(dt);
  renderer.render(scene,camera);
  drawUI();
  requestAnimationFrame(frame);
}

/* ========= scoring / wallet / lb ========= */
var finishEl=document.getElementById('finish');
function applyCoins(delta){
  const before=readCoinsLS()|0, after=before+(delta|0);
  writeCoinsLS(after); paintCoinsHUDNow();
  // 1 craft credit per 1000 coins crossed
  const COINS_PER_CREDIT=1000;
  const beforeBlocks=Math.floor(before/COINS_PER_CREDIT);
  const afterBlocks =Math.floor(after /COINS_PER_CREDIT);
  const creditDelta=(afterBlocks-beforeBlocks)|0;
  if(creditDelta>0){ writeCraftAll((readCraftAny()|0)+creditDelta); try{ window.dispatchEvent(new Event('izza-crafting-changed')); }catch(_){} }
  try{ window.dispatchEvent(new Event('izza-coins-changed')); }catch(_){}
  return after;
}
function getUserMatch(){ try{
  return ((window.__IZZA_PROFILE__&&__IZZA_PROFILE__.username) ||
          (window.izzaUserKey&&izzaUserKey.get&&izzaUserKey.get()) ||
          (localStorage.getItem('izzaUserU')||'')).toString().trim().replace(/^@+/,'').toLowerCase();
}catch(_){return '';}}

async function submitScore(s){
  const body={ game:'puzzle', score:s|0, user:getUserMatch(), ts:Date.now() };
  const endpoints=[ withAuth('/izza-game/api/leaderboard/submit'),
                    (window.IZZA_PERSIST_BASE||'').replace(/\/+$/,'') + '/izza-game/api/leaderboard/submit',
                    (window.IZZA_PERSIST_BASE||'').replace(/\/+$/,'') + '/api/leaderboard/submit' ].filter(Boolean);
  for(let i=0;i<endpoints.length;i++){
    try{ const r=await fetch(endpoints[i],{method:'POST',credentials:'include',mode:'cors',headers:bearerHeaders(),body:JSON.stringify(body)}); if(r&&r.ok) break; }catch(_){}
  }
}

function gameOver(){
  if(ended) return; ended=true;
  // Award coins from score (1 coin per point)
  const before=readCoinsLS()|0;
  applyCoins(Math.max(0, Math.floor(score)));
  const runCoins=(readCoinsLS()|0)-before;

  document.getElementById('finalScore').textContent = Math.floor(score);
  document.getElementById('finalCoins').textContent = runCoins|0;
  document.getElementById('finalCraft').textContent = Math.floor((readCoinsLS()|0)/1000) - Math.floor(before/1000);
  finishEl.style.display='flex';
  submitScore(Math.floor(score));
}

/* ========= start / restart ========= */
function startGame(){
  ended=false; score=0; combos=0; timeLeft=60;
  hardResize(); init3D(); spawnBoard(); clock.start(); requestAnimationFrame(frame);
  document.getElementById('startOverlay').style.display='none';
}
document.getElementById('startBtn').addEventListener('click', startGame, false);
document.getElementById('againBtn').addEventListener('click', function(){
  finishEl.style.display='none'; startGame();
}, false);

/* ========= boot ========= */
(function boot(){
  hardResize();
  // draw avatar immediately if we can
  try{
    const av=document.getElementById('avatar'); const ctx=av.getContext('2d',{willReadFrequently:true});
    const prof=JSON.parse(localStorage.getItem('izzaCharacter')||'{}'); buildAvatarCanvas(ctx,96,prof);
  }catch(_){}
})();
})();
</script>
</body>
</html>
