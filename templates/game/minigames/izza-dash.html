<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>IZZA DASH ‚Äî IZZA GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">

  <!-- Persist base -->
  <script>window.IZZA_PERSIST_BASE='https://izzagame.onrender.com';</script>

  <!-- --- AUTH / USERNAME + LINK REWRITER (runs first) --- -->
  <script>
  (function(){
    const T_KEY='izzaTokenT', U_KEY='izzaUserU';
    const qs=new URLSearchParams(location.search);
    let T=qs.get('t')||'';
    let U=(qs.get('u')||'').toString().trim();

    function publishUsername(u){
      if(!u) return '';
      u=u.replace(/^@+/, '').toLowerCase();
      try{ localStorage.setItem(U_KEY,u); }catch(_){}
      window.__IZZA_PROFILE__=Object.assign({},window.__IZZA_PROFILE__,{username:u});
      window.izzaUserKey={ get:()=>u };
      try{ if(!localStorage.getItem('piAuthUser')) localStorage.setItem('piAuthUser', JSON.stringify({ username:u })); }catch(_){}
      return u;
    }

    try{
      if(!U){
        const raw=(localStorage.getItem(U_KEY)||'').toString().trim();
        if(raw) U=raw;
        if(!U){
          const pi=localStorage.getItem('piAuthUser');
          if(pi){ try{ U=(JSON.parse(pi)||{}).username||''; }catch(_){ } }
        }
      }
      if(U) publishUsername(U);

      if(T){ try{ localStorage.setItem(T_KEY,T); }catch(_){ } }
      else { const s=localStorage.getItem(T_KEY)||''; if(s) T=s; }

      // reflect in URL (helps native wrappers)
      const url=new URL(location.href);
      if(T) url.searchParams.set('t',T);
      if(U) url.searchParams.set('u',U);
      if(url.toString()!==location.href){ history.replaceState(null,'',url.toString()); }

      function withAuth(href){
        const base = (location.origin || (location.protocol+'//'+location.host));
        const u = new URL(href, base);
        if(T) u.searchParams.set('t',T);
        if(U) u.searchParams.set('u',U);
        return u.toString();
      }
      window._withAuth = withAuth;

      function wireLink(id, path){
        const a=document.getElementById(id); if(!a) return;
        const target = path || a.getAttribute('href') || '/';
        a.setAttribute('href', withAuth(target));
        // Force navigation with absolute URL on both click and touch
        const go = (e)=>{ try{ e.preventDefault(); location.href = withAuth(target); }catch(_){ location.assign(withAuth(target)); } };
        a.addEventListener('click', go, false);
        a.addEventListener('touchend', go, false);
      }
      wireLink('backBtn','/izza-game/minigames');
      wireLink('cityBtn','/izza-game/play');
      wireLink('againBtn','/izza-game/minigames');
      wireLink('cityBtn2','/izza-game/play');
    }catch(_){}
  })();
  </script>

  <!-- Persist + Three.js -->
  <script src="/static/game/js/izza-persist.js"></script>
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>

  <link rel="stylesheet" href="/static/themes.css">
  <style>
    :root{
      --hud:rgba(255,255,255,.72);
      --hudLine:rgba(0,0,0,.18);
      --ok:#25d07f; --warn:#ffcc55; --bad:#ff6b6b; --arcade:#2fd1ff;
      padding-bottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none}
    html,body{height:100%}
    body{margin:0;background:#0f1c2e;color:var(--txt);font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:10px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);
         background:var(--chip-bg);padding:10px 14px;border-radius:12px;color:inherit;text-decoration:none}

    .arena{position:relative;height:74vh;min-height:560px;border:1px solid var(--line);
           border-radius:14px;background:#0b1a2c;overflow:hidden}

    /* HUD */
    .hud{
      position:absolute;left:12px;right:12px;top:12px;
      display:flex;justify-content:space-between;gap:8px;z-index:9;
      padding-right:8px;align-items:center;flex-wrap:wrap;
    }
    .hud .left,.hud .right{display:flex;gap:6px;align-items:center;min-width:0;flex-wrap:wrap}
    .pill{
      background:var(--hud); border:1px solid var(--hudLine); backdrop-filter:blur(6px);
      padding:4px 8px; border-radius:999px; font-weight:800; letter-spacing:.2px;
      display:inline-flex; gap:6px; align-items:center; white-space:nowrap; line-height:1;
      font-size: clamp(9px, 2.5vw, 11px);
      flex:0 0 auto;
      box-shadow:0 0 0 1px rgba(0,0,0,.06) inset;
    }
    .pill strong{
      display:inline-block;
      font-variant-numeric:tabular-nums;
      font-size: clamp(10px, 2.6vw, 12px);
      min-width:3ch; text-align:right;
    }
    .pill.button{cursor:pointer; min-width:40px; justify-content:center}

    /* Start overlay */
    .startOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:11;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(0,0,0,.15)); transition:opacity .18s ease}
    .startOverlay.hidden{ opacity:0; pointer-events:none; }

    .startCard{background:rgba(255,255,255,.90);color:#0a1524;border:1px solid rgba(0,0,0,.15);
      border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:12px;align-items:center;max-width:92vw}
    .startBtn{padding:12px 18px;border-radius:10px;border:1px solid rgba(0,0,0,.2);
      background:#0f213a;color:#eaf6ff;font-weight:800;cursor:pointer}

    /* Big message */
    .bigmsg{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      font-weight:900;letter-spacing:.6px;font-size:44px;opacity:0;transition:opacity .2s,transform .2s;
      pointer-events:none;text-shadow:0 10px 34px rgba(0,0,0,.45);color:#2fd1ff;z-index:10}
    .bigmsg.show{opacity:1;transform:translate(-50%,-56%) scale(1.04)}
    .scoreGlow{color:#28df8a} .warn{color:#ffd36b} .miss{color:#ff6b6b}

    /* Avatar (Jetman sizing) */
    .playerAvatar{position:absolute;left:12px;bottom:12px;width:128px;height:128px;z-index:7;pointer-events:none}
    .playerAvatar canvas{width:128px;height:128px;image-rendering:pixelated;image-rendering:crisp-edges}

    /* Canvas */
    #gl{position:absolute;inset:0;display:block;touch-action:none}

    .overlayUi{position:absolute;left:0;right:0;bottom:0;display:flex;justify-content:center;gap:10px;padding:10px;z-index:8}
    .chip{background:rgba(255,255,255,.78);color:#0a1524;border:1px solid rgba(0,0,0,.15);padding:7px 12px;border-radius:999px;font-size:12px}

    .finish{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    @media (max-width:380px){
      .pill{ font-size:10px; padding:3px 7px; }
      .pill strong{ font-size:11px; min-width:2.8ch; }
    }
  </style>
</head>
<body class="cw-blue theme-a">
  <div class="wrap">
    <div class="top">
      <a class="btn" id="backBtn" href="/izza-game/minigames">‚Üê Back to Arena</a>
      <a class="btn" id="cityBtn" href="/izza-game/play">Enter IZZA City</a>
    </div>

    <div class="arena" id="arena">
      <div class="hud">
        <div class="left">
          <div class="pill">LEVEL: <strong id="level" class="arc">1</strong></div>
          <div class="pill">AMMO: <strong id="ammo" class="arc">0</strong></div>
          <div class="pill">TIME: <strong id="time" class="arc">60s</strong></div>
        </div>
        <div class="right">
          <button id="muteBtn" class="pill button" type="button" aria-pressed="false" title="Mute/Unmute (M)">üîä</button>
          <div class="pill">COINS: <strong id="coinsRun" class="arc">0</strong></div>
        </div>
      </div>

      <!-- Start -->
      <div id="startOverlay" class="startOverlay">
        <div class="startCard">
          <h3 style="margin:0 0 4px">IZZA DASH</h3>
          <p style="margin:0;max-width:30ch;text-align:center">
            Drag to stack the glass blocks. Tap to fire metal balls from your avatar at the incoming spheres.
          </p>
          <button id="startBtn" class="startBtn" type="button">START</button>
        </div>
      </div>

      <canvas id="gl" width="1280" height="720"></canvas>
      <div class="overlayUi"><span class="chip">Drag & Stack ‚Ä¢ Shatter the Spheres</span></div>

      <!-- Avatar -->
      <div class="playerAvatar"><canvas id="avatarCanvas" width="128" height="128"></canvas></div>

      <div id="bigmsg" class="bigmsg" aria-live="polite">GO!</div>
    </div>

    <div class="finish" id="finish" style="display:none">
      <span class="pill">Run Score: <strong id="finalScore">0</strong></span>
      <span class="pill">Coins Awarded: <strong id="finalCoins">0</strong></span>
      <span class="pill">Craft Credits: <strong id="finalCraft">0</strong></span>
      <a class="btn" href="/izza-game/minigames" id="againBtn">Play Again</a>
      <a class="btn" href="/izza-game/play" id="cityBtn2">Go to City</a>
    </div>
  </div>

  <!-- BGM -->
  <audio id="bgm" src="/static/game/audio/dash_bgm.mp3" preload="none" loop></audio>

<script>
/* =======================
   Wallet helpers
======================= */
(function(){
  const CRAFT_KEYS=['izzaCrafting','craftingCredits','izzaCraftCredits'];
  function readCraftAny(){ for(const k of CRAFT_KEYS){ const v=parseInt(localStorage.getItem(k)||'0',10); if(Number.isFinite(v)&&v>0) return v|0; } return (parseInt(localStorage.getItem(CRAFT_KEYS[0])||'0',10)||0)|0; }
  function writeCraftAll(v){ const n=Math.max(0,v|0); for(const k of CRAFT_KEYS) localStorage.setItem(k,String(n)); try{window.dispatchEvent(new Event('izza-crafting-changed'));}catch(_){ } }
  function readCoins(){ return (parseInt(localStorage.getItem('izzaCoins')||'0',10)|0); }
  function writeCoins(v){ localStorage.setItem('izzaCoins', String((v|0))); try{window.dispatchEvent(new Event('izza-coins-changed'));}catch(_){} }
  window._wallet = { readCraftAny, writeCraftAll, readCoins, writeCoins };
})();

/* =======================
   Audio
======================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx=null, master=null;
const bgmEl=document.getElementById('bgm');
function initAudio(){ if(audioCtx) return; audioCtx=new AudioCtx(); master=audioCtx.createGain(); master.gain.value=0.45; master.connect(audioCtx.destination); }
function bleep(type='match'){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.connect(g); g.connect(master);
  const now=audioCtx.currentTime;
  if(type==='match'){ o.type='triangle'; o.frequency.setValueAtTime(520,now); o.frequency.exponentialRampToValueAtTime(880,now+0.08); }
  else if(type==='explode'){ o.type='sawtooth'; o.frequency.setValueAtTime(220,now); o.frequency.exponentialRampToValueAtTime(110,now+0.18); }
  else if(type==='tick'){ o.type='square'; o.frequency.setValueAtTime(780,now); o.frequency.exponentialRampToValueAtTime(580,now+0.05); }
  g.gain.setValueAtTime(0.001,now);
  g.gain.exponentialRampToValueAtTime(0.65,now+0.02);
  g.gain.exponentialRampToValueAtTime(0.001,now+0.22);
  o.start(now); o.stop(now+0.24);
}
const muteBtn=document.getElementById('muteBtn');
function applyMuteState(m){
  try{ localStorage.setItem('izzaMute',''+(m?1:0)); }catch(_){}
  muteBtn.textContent = m ? 'üîá' : 'üîä';
  muteBtn.setAttribute('aria-pressed', m?'true':'false');
  if(bgmEl){ bgmEl.muted = !!m; if(!m) bgmEl.volume = 0.3; }
  if(master){ master.gain.value = m?0:0.45; }
}
muteBtn.addEventListener('click',()=>applyMuteState(!(muteBtn.getAttribute('aria-pressed')==='true')), false);
window.addEventListener('keydown',(e)=>{ if(e.key==='m'||e.key==='M'){ e.preventDefault(); applyMuteState(!(muteBtn.getAttribute('aria-pressed')==='true')); }}, false);
applyMuteState(localStorage.getItem('izzaMute')==='1');

/* =======================
   Session hydrate (safe; never blocks start)
======================= */
async function ensureSession(){
  try{
    if(window._withAuth){
      const r=await fetch(_withAuth('/izza-game/api/character'),{credentials:'include',headers:{'content-type':'application/json'}});
      if(r.ok){ const j=await r.json().catch(()=>({})); try{ localStorage.setItem('izzaCharacter', JSON.stringify(j)); }catch(_){}
        return j;
      }
    }
  }catch(_){}
  try{ return JSON.parse(localStorage.getItem('izzaCharacter')||'{}')||{}; }catch(_){ return {}; }
}

/* =======================
   UI refs
======================= */
const levelEl = document.getElementById('level');
const ammoEl  = document.getElementById('ammo');
const timeEl  = document.getElementById('time');
const coinsRunEl=document.getElementById('coinsRun');
const startBtn= document.getElementById('startBtn');
const startOverlay=document.getElementById('startOverlay');
const bigmsg = document.getElementById('bigmsg');
function showMsg(t, cls){ bigmsg.textContent=t; bigmsg.className='bigmsg show ' + (cls||''); setTimeout(()=>bigmsg.className='bigmsg',520); }
function paintCoinsHUD(n){ coinsRunEl.textContent=String(Math.max(0, n|0)); }

/* =======================
   Avatar pipeline (unchanged API)
======================= */
const SPRITES={ body:{ default:"/static/game/sprites/body/default.png", street_a:"/static/game/sprites/body/street_a.png", street_b:"/static/game/sprites/body/street_b.png" },
                hair:{ short:"/static/game/sprites/hair/short.png", buzz:"/static/game/sprites/hair/buzz.png", long:"/static/game/sprites/hair/long.png" },
                outfit:{ street:"/static/game/sprites/outfit/street.png", athletic:"/static/game/sprites/outfit/athletic.png", luxury:"/static/game/sprites/outfit/luxury.png" } };
const SKIN_BASE=["#F7D7C6","#E8BEA8","#D6A48E"];
const SKIN_TO={ light:["#FFE7D6","#F3C6A7","#D8A187"], medium:["#F1BD94","#D79A73","#B67955"], tan:["#E2A878","#C88756","#9F663C"], dark:["#B9825B","#9A6644","#714A31"], deep:["#8B5A3B","#6A402A","#432818"] };
const FEMALE_DRESS_BASE=["#7AB6FF","#4E84E3","#2F5CB5"];
const FEMALE_DRESS_TO={ blue:["#7AB6FF","#4E84E3","#2F5CB5"], red:["#FF7A7A","#E24C4C","#B12F2F"], green:["#7DD68A","#4CB56B","#2F7F47"], purple:["#B796FF","#8C6BE0","#6A49B8"], yellow:["#FFE08A","#E7C45A","#B89433"], pink:["#FFA6D6","#E57CB2","#C45C96"], black:["#3A3A3D","#232326","#0E0E10"], white:["#FFFFFF","#E6E6E6","#C9C9C9"] };
const HAIR_TO={ black:["#2C2C31","#17171B","#0A0A0D"], brown:["#7A5336","#5C3E28","#3E2B1B"], blonde:["#FBE58F","#E5C35A","#B89433"], red:["#E65F35","#B54426","#8E321A"], white:["#FFFFFF","#E6E6E6","#C9C9C9"], blue:["#7AB6FF","#4E84E3","#2F5CB5"], green:["#7DD68A","#4CB56B","#2F7F47"], pink:["#FFA6D6","#E57CB2","#C45C96"] };
function loadImg(src){ return new Promise(res=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
const hexToRgb=h=>{ const n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; };
const lum=(r,g,b)=>0.2126*r+0.7152*g+0.0722*b;
function extractThreeToneRamp(img){
  const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  const c=oc.getContext('2d',{willReadFrequently:true}); c.imageSmoothingEnabled=false; c.drawImage(img,0,0);
  const d=c.getImageData(0,0,w,h).data, v=[];
  for(let i=0;i<d.length;i+=4){ if(d[i+3]<10) continue; const r=d[i],g=d[i+1],b=d[i+2]; v.push({r,g,b,L:lum(r,g,b)}); }
  if(v.length<10) return ["#C8C8C8","#9C9C9C","#6E6E6E"];
  v.sort((a,b)=>a.L-b.L);
  const pick=q=>{ const idx=Math.max(0,Math.min(v.length-1,Math.floor(q*(v.length-1)))); const s=v[idx]; return '#'+s.r.toString(16).padStart(2,'0')+s.g.toString(16).padStart(2,'0')+s.b.toString(16).padStart(2,'0'); };
  return [pick(0.2),pick(0.55),pick(0.85)];
}
function paletteSwap(img, fromHex, toHex, tol=4000){
  const from=fromHex.map(h=>hexToRgb(h)), to=toHex.map(h=>hexToRgb(h));
  const w=img.width,h=img.height, oc=document.createElement('canvas'); oc.width=w; oc.height=h;
  const cx=oc.getContext('2d',{willReadFrequently:true}); cx.imageSmoothingEnabled=false; cx.drawImage(img,0,0);
  const id=cx.getImageData(0,0,w,h),d=id.data;
  function sd(a,b){const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db;}
  for(let i=0;i<d.length;i+=4){
    if(d[i+3]===0) continue; const p={r:d[i],g:d[i+1],b:d[i+2]}; let best=-1,score=1e9;
    for(let k=0;k<from.length;k++){ const s=sd(p,from[k]); if(s<score){score=s;best=k;} }
    if(score<=tol){ const t=to[best]||to[1]||to[0]; d[i]=t.r; d[i+1]=t.g; d[i+2]=t.b; }
  }
  cx.putImageData(id,0,0); return oc;
}
async function buildAvatarCanvas(dstCtx,size,profile){
  const DW=size,DH=size,X=0,Y=0;
  const type=profile.body_type||'male', tone=profile.skin_tone||'light', theme=profile.sprite_skin||'default';
  const outfitKey=profile.outfit||'street', hairKey=profile.hair||'short', hairCol=profile.hair_color||'black';
  const femaleOut=profile.female_outfit_color||'blue';
  let body=null;
  if(type==='female'){ const femaleWide=`/static/game/sprites/body/${theme}__female_wide.png`; const femaleSlim=`/static/game/sprites/body/${theme}__female.png`; body=await loadImg(femaleWide)||await loadImg(femaleSlim); }
  if(!body) body=await loadImg(SPRITES.body[theme]||SPRITES.body.default);
  const hair=await loadImg(SPRITES.hair[hairKey]||SPRITES.hair.short);
  const outfit=(type==='female')?null:(await loadImg(SPRITES.outfit[outfitKey]||SPRITES.outfit.street));
  let bodyCanvas=null;
  if(body){ const target=SKIN_TO[tone]||SKIN_TO.light; const ramp=paletteSwap(body, SKIN_BASE, target, 4000); bodyCanvas=ramp; }
  if(type==='female'&&bodyCanvas){ const target=FEMALE_DRESS_TO[femaleOut]||FEMALE_DRESS_TO.blue; bodyCanvas=paletteSwap(bodyCanvas, FEMALE_DRESS_BASE, target, 4000); }
  dstCtx.clearRect(0,0,DW,DH);
  if(bodyCanvas) dstCtx.drawImage(bodyCanvas, X, Y, DW, DH);
  if(outfit) dstCtx.drawImage(outfit, X, Y, DW, DH);
  if(hair){
    const ramp=extractThreeToneRamp(hair), target=HAIR_TO[hairCol]||HAIR_TO.black;
    const hairCanvas=paletteSwap(hair, ramp, target, 4000);
    dstCtx.drawImage(hairCanvas, X, Y, DW, DH);
  }
  try{ await drawEquippedOverlaysForAvatar(dstCtx, size); }catch(_){}
}
/* equipped overlay (Jetman sizing kept) */
(function(){
  const BOX128=Object.freeze({ head:{w:59,h:59,ox:64,oy:32,scale:1.12}, chest:{w:61,h:61,ox:64,oy:60,scale:1.15}, arms:{w:75,h:59,ox:64,oy:60,scale:1.15}, legs:{w:72,h:61,ox:64,oy:88,scale:1.18}, hands:{w:85,h:61,ox:86,oy:72,scale:1.34} });
  const cache=new Map(); const imgFromSvg=s=>{ if(!s) return null; if(cache.has(s)) return cache.get(s); const i=new Image(); i.decoding='async'; i.src='data:image/svg+xml;utf8,'+encodeURIComponent(s); cache.set(s,i); return i; };
  function readInv(){ try{ const iz=window.IZZA?.api?.getInventory?.(); if(iz) return JSON.parse(JSON.stringify(iz)); }catch(_){}
    try{ return JSON.parse(localStorage.getItem('izzaInventory')||'{}'); }catch(_){ return {}; } }
  function isEq(it){ return !!(it&&(it.equipped===true||it.equip===true||((it.equippedCount|0)>0))); }
  function equippedIn(slot){ const inv=readInv(); for(const k in inv){ const it=inv[k]; if(!it) continue; if((it.slot||'').toLowerCase()!==slot) continue; if(!isEq(it)) continue; const svg=(it.overlaySvg&&String(it.overlaySvg).trim())||(it.iconSvg&&String(it.iconSvg).trim())||''; return {key:k,it,svg}; } return null; }
  function drawOne(ctx, svg, box, mul=1){ const im=imgFromSvg(svg); if(!im||!im.complete) return false; const w=Math.max(8,box.w|0),h=Math.max(8,box.h|0); ctx.save(); ctx.imageSmoothingEnabled=false; ctx.translate(box.ox|0, box.oy|0); const s=(box.scale||1)*mul; if(s!==1) ctx.scale(s,s); try{ ctx.drawImage(im, -(w/2)|0, -(h/2)|0, w,h); }catch(_){ } ctx.restore(); return true; }
  async function drawEquippedOverlaysForAvatar(ctx, size){
    const k=(size>0?size/128:1);
    function scaled(b){ return { w:Math.round(b.w*k),h:Math.round(b.h*k),ox:Math.round(b.ox*k),oy:Math.round(b.oy*k),scale:b.scale }; }
    const legs =equippedIn('legs');  if(legs ) drawOne(ctx, legs .svg, scaled(BOX128.legs ));
    const chest=equippedIn('chest'); if(chest) drawOne(ctx, chest.svg, scaled(BOX128.chest));
    const arms =equippedIn('arms');  if(arms ) drawOne(ctx, arms .svg, scaled(BOX128.arms ));
    const head =equippedIn('head');  if(head ) drawOne(ctx, head .svg, scaled(BOX128.head ));
    const hands=equippedIn('hands'); if(hands) drawOne(ctx, hands.svg, scaled(BOX128.hands));
  }
  window.drawEquippedOverlaysForAvatar=drawEquippedOverlaysForAvatar;
})();

/* =======================
   THREE.js Stack Game
======================= */
const glCanvas = document.getElementById('gl');
let scene, camera, renderer, raycaster, pointer;
let world, floorRing, spheres=[], ammo=0, level=1, timeLeft=60, ended=false;
let blocks=[], projectilePool=[];
function hardResize(){
  if(!renderer||!camera) return;
  const r = glCanvas.getBoundingClientRect();
  const W = Math.max(1, Math.floor(r.width));
  const H = Math.max(1, Math.floor(r.height));
  const dpr = Math.min(window.devicePixelRatio||1, 2);
  renderer.setSize(W,H,false); renderer.setPixelRatio(dpr);
  camera.aspect=W/H; camera.updateProjectionMatrix();
}
window.addEventListener('resize', hardResize, false);

function glass(tint){
  return new THREE.MeshPhysicalMaterial({
    color: new THREE.Color(tint),
    emissive: new THREE.Color(tint).multiplyScalar(0.15),
    metalness: 0.15, roughness: 0.05, transmission: 1.0, thickness: 0.7, ior: 1.45, envMapIntensity: 1.4
  });
}
function metal(){
  return new THREE.MeshStandardMaterial({ color: 0xd8e2ef, metalness: 0.95, roughness: 0.25, emissive: 0x1a1f26, emissiveIntensity: 0.2 });
}
const COLORS=[0x9ad9ff,0x7bffbf,0xffb3ff,0xffe26a,0xace6ff,0xb7ffd9];

function makeCube(size=1,tint=0x9ad9ff){
  const m=new THREE.Mesh(new THREE.BoxGeometry(size,size,size), glass(tint));
  m.castShadow=true; m.receiveShadow=true; m.userData.kind='cube'; return m;
}
function makeRectPrism(w=1.6,h=1,d=1,tint=0x9ad9ff){
  const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d), glass(tint));
  m.castShadow=true; m.receiveShadow=true; m.userData.kind='rect'; return m;
}
function makeCrystal(){
  const s=new THREE.Mesh(new THREE.SphereGeometry(0.5, 28, 20), glass(0xecf7ff));
  s.castShadow=true; s.receiveShadow=true; s.userData.v=new THREE.Vector3(); return s;
}

function initThree(){
  scene=new THREE.Scene(); scene.background=new THREE.Color(0x12304c);
  camera=new THREE.PerspectiveCamera(55,1,0.1,100); camera.position.set(0,3,9); camera.lookAt(0,0,0);
  renderer=new THREE.WebGLRenderer({canvas:glCanvas,antialias:true,alpha=false,powerPreference:'high-performance'});
  renderer.shadowMap.enabled=true; renderer.toneMapping=THREE.ACESFilmicToneMapping; renderer.toneMappingExposure=1.35;

  scene.add(new THREE.AmbientLight(0xd6ebff,0.7));
  const k=new THREE.DirectionalLight(0xffffff,1.35); k.position.set(-4,7,6); k.castShadow=true; scene.add(k);

  world=new THREE.Group(); scene.add(world);

  const floor=new THREE.Mesh(new THREE.CircleGeometry(5.2,64), new THREE.MeshStandardMaterial({color:0x1b3353,metalness:.2,roughness:.6}));
  floor.rotation.x=-Math.PI/2; floor.position.y=-1; floor.receiveShadow=true; world.add(floor);
  floorRing=new THREE.Mesh(new THREE.TorusGeometry(4.2,0.06,16,100), new THREE.MeshBasicMaterial({color:0xa8e0ff,transparent:true,opacity:.9}));
  floorRing.rotation.x=Math.PI/2; floorRing.position.y=-0.96; world.add(floorRing);

  raycaster=new THREE.Raycaster(); pointer=new THREE.Vector2();
  hardResize();
}

/* --- Level layout --- */
function clearScene(){
  for(const m of blocks){ world.remove(m); }
  for(const s of spheres){ world.remove(s); }
  for(const p of projectilePool){ world.remove(p); }
  blocks.length=0; spheres.length=0; projectilePool.length=0;
}
function layoutLevel(){
  clearScene();
  const pieceCount = Math.max(2, 1 + level);
  for(let i=0;i<pieceCount;i++){
    const tint = COLORS[(Math.random()*COLORS.length)|0];
    const mesh = (level>=4 && i===pieceCount-1) ? makeRectPrism(1.6,1,1,tint) : makeCube(1,tint);
    mesh.position.set(-2 + i*1.6, -0.5, (Math.random()*0.6)-0.3);
    world.add(mesh); blocks.push(mesh);
  }
  const wave = (level===1)?2:Math.min(2+level,10);
  for(let i=0;i<wave;i++){
    const s=makeCrystal();
    const R=6.2, th=(Math.random()*Math.PI*2);
    s.position.set(Math.cos(th)*R, -0.2+Math.random()*0.4, Math.sin(th)*R*0.2);
    const center=new THREE.Vector3(0,0,0);
    s.userData.v.copy(center.clone().sub(s.position).normalize().multiplyScalar(0.6 + Math.min(0.2*level,1.8)));
    world.add(s); spheres.push(s);
  }
  ammo = Math.min(2+level, 10);
  ammoEl.textContent = ammo;
  levelEl.textContent = level;
  showMsg('LEVEL '+level,'');
}

/* --- Coins & advance --- */
function awardAndNext(){
  const coins = 100*level;
  _wallet.writeCoins(_wallet.readCoins()+coins);
  paintCoinsHUD(_wallet.readCoins());
  showMsg('+'+coins+' IZZA', 'scoreGlow');
  level++;
  setTimeout(()=>{ layoutLevel(); }, 420);
}

/* --- Pointer helpers --- */
function screenToPlane(e, planeY=0){
  const rect=glCanvas.getBoundingClientRect();
  pointer.x=((('clientX' in e?e.clientX:e.touches?.[0]?.clientX)-rect.left)/rect.width)*2-1;
  pointer.y=-((('clientY' in e?e.clientY:e.touches?.[0]?.clientY)-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(pointer,camera);
  const plane=new THREE.Plane(new THREE.Vector3(0,1,0), -planeY);
  const hit=new THREE.Vector3();
  raycaster.ray.intersectPlane(plane,hit);
  return hit;
}
function pickBlock(e){
  const rect=glCanvas.getBoundingClientRect();
  pointer.x=((('clientX' in e?e.clientX:e.touches?.[0]?.clientX)-rect.left)/rect.width)*2-1;
  pointer.y=-((('clientY' in e?e.clientY:e.touches?.[0]?.clientY)-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(pointer,camera);
  const hits=raycaster.intersectObjects(blocks,false);
  return (hits.length?hits[0].object:null);
}

/* --- Drag to stack --- */
let dragging=false, dragObj=null;
function onDown(e){ if(dragObj || ended) return; const p=pickBlock(e); if(p){ dragging=true; dragObj=p; } }
function onMove(e){
  if(!dragging||!dragObj) return;
  const h=screenToPlane(e, 0);
  dragObj.position.x = THREE.MathUtils.clamp(h.x, -4.0, 4.0);
  dragObj.position.z = THREE.MathUtils.clamp(h.z, -2.0, 2.0);
  dragObj.position.y = 0;
}
function onUp(){
  if(!dragging||!dragObj) return;
  let best=null, bestD=1e9;
  for(const b of blocks){ if(b===dragObj) continue; const d=b.position.clone().sub(dragObj.position).length(); if(d<bestD){best=b;bestD=d;} }
  if(best && bestD<0.9){
    const atopY = (best.geometry.parameters.height||1)/2 + (dragObj.geometry.parameters.height||1)/2;
    dragObj.position.x = best.position.x;
    dragObj.position.z = best.position.z;
    dragObj.position.y = best.position.y + atopY;
    try{ bleep('match'); }catch(_){}
  }
  dragging=false; dragObj=null;
  checkWin();
}
glCanvas.addEventListener('pointerdown', onDown, false);
glCanvas.addEventListener('pointermove', onMove, false);
window.addEventListener('pointerup', onUp, false);

/* --- Fire metal balls FROM avatar --- */
function avatarOriginWorld(){ return new THREE.Vector3(-4.6, -0.6, 0.8); }
function fireMetal(e){
  if(ended || ammo<=0) return;
  if(pickBlock(e)) return; // touching a block = drag, not fire
  ammo--; ammoEl.textContent=ammo;
  const origin=avatarOriginWorld();
  const tgt=screenToPlane(e, 0);
  const dir=tgt.clone().sub(origin).normalize();
  const b=new THREE.Mesh(new THREE.SphereGeometry(0.18,20,16), metal());
  b.position.copy(origin); b.userData.v=dir.multiplyScalar(4.4); b.userData.ttl=2.2;
  b.castShadow=true; world.add(b); projectilePool.push(b);
}
glCanvas.addEventListener('click', fireMetal, false);
glCanvas.addEventListener('touchend', function(e){ fireMetal(e.changedTouches?{clientX:e.changedTouches[0].clientX, clientY:e.changedTouches[0].clientY}:e); }, false);

/* --- Collisions / win / fail --- */
function checkWin(){
  const xs=blocks.map(b=>b.position.x), zs=blocks.map(b=>b.position.z);
  const xOk = Math.max(...xs)-Math.min(...xs) < 0.05;
  const zOk = Math.max(...zs)-Math.min(...zs) < 0.05;
  if(!(xOk && zOk)) return;
  const ys=blocks.map(b=>b.position.y).sort((a,b)=>a-b);
  for(let i=1;i<ys.length;i++){ if(ys[i]-ys[i-1] < 0.8) return; }
  awardAndNext();
}
function fail(){
  showMsg('SMASHED!','miss');
  setTimeout(()=>layoutLevel(),420);
}

/* --- Loop --- */
let last=performance.now();
function loop(t){
  const dt=Math.min(0.033,(t-last)/1000); last=t;
  for(let i=spheres.length-1;i>=0;i--){
    const s=spheres[i];
    s.position.addScaledVector(s.userData.v, dt);
    for(const b of blocks){ if(s.position.distanceTo(b.position) < 0.8){ fail(); return requestAnimationFrame(loop); } }
    for(let j=projectilePool.length-1;j>=0;j--){
      const p=projectilePool[j];
      if(p.position.distanceTo(s.position) < 0.56){
        world.remove(s); spheres.splice(i,1);
        try{ bleep('explode'); }catch(_){}
        break;
      }
    }
    if(s.position.length()<0.35){ fail(); return requestAnimationFrame(loop); }
  }
  for(let j=projectilePool.length-1;j>=0;j--){
    const p=projectilePool[j];
    p.position.addScaledVector(p.userData.v, dt);
    p.userData.ttl -= dt;
    if(p.userData.ttl<=0){ world.remove(p); projectilePool.splice(j,1); }
  }
  renderer.render(scene,camera);
  if(!ended) requestAnimationFrame(loop);
}

/* --- Timer + Boot --- */
function tickTimer(){
  if(ended) return;
  timeLeft--; timeEl.textContent=timeLeft+'s';
  try{ bleep('tick'); }catch(_){}
  if(timeLeft<=0){ showMsg('TIME!','miss'); layoutLevel(); timeLeft=60; }
}

let started=false;
function start(){
  if(started) return;
  started=true;

  // Hide overlay immediately so it can't steal input
  startOverlay.classList.add('hidden');

  // Audio FIRST (inside gesture)
  try{
    initAudio();
    audioCtx && audioCtx.resume && audioCtx.resume();
    bgmEl.volume = 0.3;
    bgmEl.muted  = (localStorage.getItem('izzaMute')==='1');
    bgmEl.currentTime = 0;
    bgmEl.play().catch(()=>{});
  }catch(_){}

  // Non-blocking session/persist
  try{ ensureSession(); }catch(_){}
  try{ if(window.IZZA_PERSIST?.load) IZZA_PERSIST.load(); }catch(_){}
  paintCoinsHUD(_wallet.readCoins());

  // Avatar (best effort)
  try{
    const cvs=document.getElementById('avatarCanvas');
    const ctx=cvs.getContext('2d',{willReadFrequently:true});
    ctx.imageSmoothingEnabled=false;
    const prof=JSON.parse(localStorage.getItem('izzaCharacter')||'{}')||{};
    buildAvatarCanvas(ctx, 128, prof);
  }catch(_){}

  // 3D
  initThree();
  level=1; timeLeft=60; ended=false;
  layoutLevel();
  setInterval(()=>{ if(!ended) tickTimer(); }, 1000);

  showMsg('GO!');
  requestAnimationFrame(loop);
}

/* --- Simple, reliable start button binding (like the working version) --- */
startBtn.addEventListener('click', start, {passive:true});

/* keep HUD coins synced */
window.addEventListener('storage', (e)=>{ if(e && e.key==='izzaCoins'){ paintCoinsHUD(_wallet.readCoins()); } }, false);
window.addEventListener('izza-coins-changed', ()=>paintCoinsHUD(_wallet.readCoins()), false);
window.addEventListener('pageshow', ()=>paintCoinsHUD(_wallet.readCoins()), false);
window.addEventListener('pagehide', ()=>{ try{ IZZA_PERSIST?.save?.(); }catch(_){} }, false);
</script>
</body>
</html>
