<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Explore Stores & Products — IZZA PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{ --bg:#0b0f17; --card:#0f1728; --line:#1f2a44; --txt:#e8f0ff; --muted:#bcd0ff; --brand:#6e9fff; }
    /* colorways applied per-card */
    .cw-blue   { --brand:#6e9fff; }
    .cw-mint   { --brand:#5ad49e; }
    .cw-purple { --brand:#a88cff; }
    .cw-amber  { --brand:#ffb86b; }
    .light { --bg:#f6f7fb; --card:#ffffff; --line:#e6e8f0; --txt:#0b0f17; --muted:#4b587c; }

    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1060px;margin:0 auto;padding:18px}
    .h1{font-weight:800;font-size:22px;margin:6px 0 12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* search */
    .searchbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .searchbar input[type="text"]{
      flex:1; min-width:220px; padding:10px; border-radius:10px;
      border:1px solid var(--line); background:transparent; color:var(--txt)
    }
    .btn{background:var(--brand);color:#0b0f17;border:0;border-radius:10px;padding:10px 12px;font-weight:800;text-decoration:none;display:inline-block;cursor:pointer}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;text-decoration:none;color:var(--txt)}

    .grid{display:grid;gap:12px}
    .g-stores{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .g-products{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .logo{width:40px;height:40px;border-radius:8px;border:1px solid var(--line);object-fit:cover;background:#0001}
    /* product image frame with overlay support */
.thumb-wrap {
  width: 100%;
  height: 160px;
  border-radius: 10px;
  border: 1px solid var(--line);
  overflow: hidden;
  background: #0001;
  position: relative;
}

/* normal product images (unchanged) */
.thumb-wrap img.thumb {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* crafted SVGs — transparent background, centered, scaled nicely */
.thumb-wrap.is-svg {
  background: transparent !important;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.thumb-wrap.is-svg .svg-thumb {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}

.thumb-wrap.is-svg .svg-thumb svg {
  display: block;
  max-width: 90%;
  max-height: 90%;
  width: auto;
  height: auto;
  object-fit: contain;
}
    /* Greyscale/dim when sold out */
    .is-soldout .thumb-wrap img.thumb{
      filter:grayscale(100%) brightness(.6);
    }
    /* Red “Sold Out” ribbon */
    .thumb-wrap .soldout-banner{
      position:absolute;
      top:50%;
      left:50%;
      transform: translate(-50%, -50%) rotate(-18deg);
      background: rgba(220,0,0,.9);
      color:#fff;
      padding:6px 14px;
      font-weight:900;
      font-size:18px;
      border-radius:6px;
      pointer-events:none;
      text-transform:uppercase;
      letter-spacing:1px;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    /* Disabled Buy button look/feel */
    .btn[aria-disabled="true"]{
      opacity:.55;
      pointer-events:none;
      cursor:not-allowed;
    }

    .title{font-weight:800}
    .price{font-weight:800}
    .clamp{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}

    .load-more{display:flex;justify-content:center;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Search -->
    <form class="searchbar" method="get" action="/explore">
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Search stores or products…">
      <button class="btn" type="submit">Search</button>
      {% if q %}
        <a class="pill" href="/explore">Clear</a>
        <div class="muted">Showing results for “{{ q }}”</div>
      {% endif %}
    </form>

    <!-- Stores -->
    <div class="h1">Stores</div>
    {% if merchants and merchants|length > 0 %}
      <div class="grid g-stores">
        {% for s in merchants %}
          <div class="card {{ s.colorway or 'cw-blue' }} {% if s.theme_mode=='light' %}light{% endif %}">
            <div class="row" style="justify-content:space-between">
              <div class="row" style="min-width:0">
                {% if s.logo_url %}
                  {% set u = (s.logo_url or '') | trim %}
<img class="logo"
     src="{% if u.startswith('/media/') or u.startswith('/') %}{{ u }}
          {% elif u.startswith('http://') or u.startswith('https://') %}/uimg?src={{ u|urlencode }}
          {% else %}{{ u }}{% endif %}"
     alt="{{ s.business_name }} logo">
                {% else %}
                  <div class="logo" style="display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--muted)">
                    {{ (s.business_name or 'S')[:1] }}
                  </div>
                {% endif %}
                <div class="title clamp">{{ s.business_name }}</div>
              </div>
              <a class="pill" href="/store/{{ s.slug }}">Open</a>
            </div>
            <div class="muted" style="margin-top:6px">/store/{{ s.slug }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No stores found.</p>
    {% endif %}

    <!-- Products -->
    <div class="h1" style="margin-top:18px">Products</div>
    {% if products and products|length > 0 %}
      <div class="grid g-products">
        {% for p in products %}
          {% set sold_out = (p.stock_qty <= 0 and not p.allow_backorder) %}
          <div class="card {{ p.m_colorway or 'cw-blue' }} {% if p.m_theme=='light' %}light{% endif %} {% if sold_out %}is-soldout{% endif %}">
            <div class="thumb-wrap {% if p.svg_code %}is-svg{% endif %}">
  {% if p.svg_code %}
    <div class="svg-thumb" data-no-i18n="1">
      {{ p.svg_code | safe }}
    </div>
  {% elif p.image_url %}
  {% set u = (p.image_url or '') | trim %}
  <img class="thumb"
       src="{% if u.startswith('/media/') or u.startswith('/') %}{{ u }}
            {% elif u.startswith('http://') or u.startswith('https://') %}/uimg?src={{ u|urlencode }}
            {% else %}{{ u }}{% endif %}"
       alt="{{ p.title }}">
{% endif %}
  
  {% if sold_out %}
    <div class="soldout-banner">Sold Out</div>
  {% endif %}
</div>

            <div style="margin-top:8px" class="title clamp">{{ p.title }}</div>
            <div class="muted clamp" style="margin-top:2px">{{ p.m_name }}</div>

            <div class="row" style="justify-content:space-between;margin-top:8px">
              <div class="price">{{ '%.7f'|format(p.pi_price) }} Pi</div>
              <div class="row">
                <a class="pill" href="/store/{{ p.m_slug }}">Store</a>
                {% if sold_out %}
                  <a class="btn" aria-disabled="true" tabindex="-1">Buy</a>
                {% else %}
                  <a class="btn" href="/checkout/{{ p.link_id }}">Buy</a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if has_more_products %}
        <div class="load-more">
          <a class="btn" href="/explore?page={{ (page or 1) + 1 }}{% if q %}&q={{ q | urlencode }}{% endif %}">
            Load more products
          </a>
        </div>
      {% endif %}
    {% else %}
      <p class="muted">No products found.</p>
    {% endif %}
  </div>
  <script>
(function(){
  document.querySelectorAll('.thumb-wrap.is-svg .svg-thumb svg').forEach(svg=>{
    try{
      // If the SVG has fixed width/height, they override CSS. Remove them.
      const w = svg.getAttribute('width'), h = svg.getAttribute('height');
      if (!svg.hasAttribute('viewBox')) {
        // derive a sensible viewBox if missing
        const vw = parseFloat(w)||512, vh = parseFloat(h)||512;
        svg.setAttribute('viewBox', `0 0 ${vw} ${vh}`);
      }
      svg.removeAttribute('width');
      svg.removeAttribute('height');
      // ensure it scales nicely inside the frame
      svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    }catch{}
  });
})();
</script>
</body>
</html>
