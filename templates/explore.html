<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Explore Stores & Products — IZZA PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link rel="stylesheet" href="/static/themes.css">
  <style>
    html,body{max-width:100%;overflow-x:hidden}
    :root{
      --bg:#000; --txt:#e8f1ff; --muted:#9fb0d6; --line:#1d2540;
      --piPurple1:#7a44ff; --piPurple2:#b784ff;
      --gold1:#ffcf4d; --gold2:#ffb23a;
      --glow-gold:0 0 26px rgba(255,207,77,.45), 0 0 64px rgba(255,178,58,.25);
      --glow-purple:0 0 28px rgba(183,132,255,.35), 0 0 64px rgba(122,68,255,.25);
      --ring:0 0 0 2px rgba(183,132,255,.28);
    }
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1120px;margin:0 auto;padding:16px 16px 48px}
    @media (min-width:720px){ .wrap{padding:24px 24px 64px} }

    /* Topbar */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:12px 16px; position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.9); backdrop-filter:blur(10px); border-bottom:1px solid var(--line);
    }
    .topbar .left,.topbar .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 14px;border-radius:14px;font-weight:700;letter-spacing:.2px;cursor:pointer;text-decoration:none;
      border:1px solid transparent;transition:transform .15s ease,box-shadow .15s ease,filter .15s ease;
      font-size:14px; white-space:nowrap; user-select:none;
    }
    .btn:focus-visible{outline:none;box-shadow:var(--ring)}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.purple{background:linear-gradient(180deg,var(--piPurple1),var(--piPurple2));color:#fff;box-shadow:var(--glow-purple)}
    .btn.gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1a1400;box-shadow:var(--glow-gold)}
    .btn.ghost{background:transparent;color:#cfe0ff;border:1px solid #2a3550}
    .btn.ghost:hover{border-color:#3f4e79}
    .btn.upper{text-transform:uppercase;letter-spacing:.6px}
    .btn[aria-disabled="true"]{opacity:.55;pointer-events:none;cursor:not-allowed}

    /* Text, chips, layout helpers */
    .h1{font-weight:800;font-size:clamp(20px,4.5vw,28px);margin:6px 0 12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .clamp{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;text-decoration:none;color:var(--txt);font-size:12px}

    /* Search */
    .searchbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .searchbar input[type="text"]{
      flex:1; min-width:220px; padding:12px; border-radius:12px;
      border:1px solid var(--line); background:transparent; color:var(--txt)
    }

    /* Simple featured card (IZZA GAME store first) */
    .featured-card{background:rgba(255,255,255,.02);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.25);margin:6px 0 12px}
    .featured-card .logo{width:56px;height:56px;border-radius:12px;border:1px solid var(--line);object-fit:cover;background:#0002}

    /* Carousel shell */
    .carousel{
      position:relative; border:1px solid var(--line); border-radius:16px; padding:12px; margin:8px 0 14px;
      background:rgba(255,255,255,.02);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .carousel h3{margin:0 0 10px;font-size:16px}
    .track{
      display:flex;gap:10px; overflow:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; padding-bottom:4px;
    }
    .slide{flex:0 0 auto; scroll-snap-align:start}
    .slide.store{width:220px}
    .slide.product{width:260px}
    .navBtn{
      position:absolute;top:50%;transform:translateY(-50%);
      background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.18);
      width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
    }
    .navBtn:hover{filter:brightness(1.1)}
    .navPrev{left:10px} .navNext{right:10px}
    @media (hover:none){ .navBtn{display:none} }

    /* Grid lists below carousels (unchanged behavior) */
    .grid{display:grid;gap:12px}
    .g-stores{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .g-products{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{background:rgba(255,255,255,.02);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .logo{width:40px;height:40px;border-radius:10px;border:1px solid var(--line);object-fit:cover;background:#0001}

    /* Product media with SVG support (kept) */
    .thumb-wrap{width:100%;height:170px;border-radius:12px;border:1px solid var(--line);overflow:hidden;background:#0001;position:relative}
    .thumb-wrap img.thumb{width:100%;height:100%;object-fit:cover;display:block}
    .thumb-wrap.is-svg{background:transparent !important;display:flex;align-items:center;justify-content:center;position:relative}
    .thumb-wrap.is-svg .svg-thumb{display:flex;align-items:center;justify-content:center;width:100%;height:100%}
    .thumb-wrap.is-svg .svg-thumb svg{display:block;max-width:90%;max-height:90%;width:auto;height:auto;object-fit:contain}

    /* Sold out (kept) */
    .is-soldout .thumb-wrap img.thumb{filter:grayscale(100%) brightness(.6)}
    .thumb-wrap .soldout-banner{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-18deg);
      background:rgba(220,0,0,.9);color:#fff;padding:6px 14px;font-weight:900;font-size:18px;border-radius:6px;pointer-events:none;text-transform:uppercase;letter-spacing:1px;box-shadow:0 2px 6px rgba(0,0,0,.35)
    }

    .title{font-weight:800}
    .price{font-weight:800}
    .load-more{display:flex;justify-content:center;margin-top:12px}
  </style>
</head>
<body>
  <!-- Sticky top -->
  <div class="topbar">
    <div class="left">
      <a class="btn ghost upper" href="/">Home</a>
      <a class="btn ghost upper" href="/explore">Browse Stores</a>
    </div>
    <div class="right">
      <a class="btn purple upper" href="/token/auth?next=/token/izza" aria-label="Authenticate for IZZA Token">IZZA TOKEN</a>
    </div>
  </div>

  <div class="wrap">

    <!-- Search -->
    <form class="searchbar" method="get" action="/explore">
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Search stores or products…">
      <button class="btn purple" type="submit">Search</button>
      {% if q %}
        <a class="pill" href="/explore">Clear</a>
        <div class="muted">Showing results for “{{ q }}”</div>
      {% endif %}
    </form>

    {# --------- IZZA GAME store first (logo + action). No {% break %} used. --------- #}
    {% set izza_game = (merchants or []) | selectattr('slug','equalto','izza-game-crafting') | list | first %}
    {% if izza_game %}
      {% set u = (izza_game.logo_url or '') | trim %}
      <div class="featured-card">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="min-width:0">
            {% if izza_game.logo_url %}
              <img class="logo" alt="{{ izza_game.business_name }} logo"
                   src="{% if u.startswith('/media/') or u.startswith('/static/') or u.startswith('/') 
                            or u.startswith('https://izzapay.onrender.com/media/') %}{{ u }}
                        {% elif u.startswith('http://') or u.startswith('https://') %}/uimg?src={{ u|urlencode }}
                        {% else %}{{ u }}{% endif %}">
            {% else %}
              <div class="logo" style="display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--muted)">IZ</div>
            {% endif %}
            <div class="title clamp">{{ izza_game.business_name or 'IZZA GAME Store' }}</div>
          </div>
          <div class="row">
            <a class="btn gold" href="/store/{{ izza_game.slug }}">View IZZA GAME Items</a>
          </div>
        </div>
        <div class="muted" style="margin-top:6px">/store/{{ izza_game.slug }}</div>
      </div>
    {% endif %}

    {# --------- Carousel: merchant stores with real logos --------- #}
    {% set stores_with_logos = (merchants or []) | selectattr('logo_url') | list %}
    {% if stores_with_logos and stores_with_logos|length > 0 %}
      <section class="carousel" id="carousel-stores" aria-label="Stores">
        <h3>Featured Stores</h3>
        <button class="navBtn navPrev" type="button" aria-label="Previous">&#10094;</button>
        <button class="navBtn navNext" type="button" aria-label="Next">&#10095;</button>
        <div class="track" role="list">
          {% for s in stores_with_logos %}
            <a class="slide store card" role="listitem" href="/store/{{ s.slug }}">
              <div class="row" style="justify-content:space-between">
                <div class="row" style="min-width:0">
                  {% set su = (s.logo_url or '') | trim %}
                  <img class="logo"
                       src="{% if su.startswith('/media/') or su.startswith('/static/') or su.startswith('/') 
                                or su.startswith('https://izzapay.onrender.com/media/') %}{{ su }}
                            {% elif su.startswith('http://') or su.startswith('https://') %}/uimg?src={{ su|urlencode }}
                            {% else %}{{ su }}{% endif %}"
                       alt="{{ s.business_name }} logo">
                  <div class="title clamp">{{ s.business_name }}</div>
                </div>
                <span class="pill">/store/{{ s.slug }}</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    {# --------- Carousel: recently added products (uses your existing `products`) --------- #}
    {% set recent_products = products or [] %}
    {% if recent_products and recent_products|length > 0 %}
      <section class="carousel" id="carousel-products" aria-label="Recently added products">
        <h3>New Arrivals</h3>
        <button class="navBtn navPrev" type="button" aria-label="Previous">&#10094;</button>
        <button class="navBtn navNext" type="button" aria-label="Next">&#10095;</button>
        <div class="track" role="list">
          {% for p in recent_products %}
            {% set sold_out = (p.stock_qty <= 0 and not p.allow_backorder) %}
            <a class="slide product card {% if sold_out %}is-soldout{% endif %}" role="listitem"
               href="{% if sold_out %}/store/{{ p.m_slug }}{% else %}/checkout/{{ p.link_id }}{% endif %}">
              <div class="thumb-wrap {% if p.svg_code %}is-svg{% endif %}">
                {% if p.svg_code %}
                  <div class="svg-thumb" data-no-i18n="1">
                    {{ p.svg_code | safe }}
                  </div>
                {% elif p.image_url %}
                  {% set pu = (p.image_url or '') | trim %}
                  <img class="thumb"
                       src="{% if pu.startswith('/media/') or pu.startswith('/static/') or pu.startswith('/') 
                                or pu.startswith('https://izzapay.onrender.com/media/') %}{{ pu }}
                            {% elif pu.startswith('http://') or pu.startswith('https://') %}/uimg?src={{ pu|urlencode }}
                            {% else %}{{ pu }}{% endif %}"
                       alt="{{ p.title }}">
                {% endif %}
                {% if sold_out %}<div class="soldout-banner">Sold Out</div>{% endif %}
              </div>
              <div style="margin-top:8px" class="title clamp">{{ p.title }}</div>
              <div class="muted clamp" style="margin-top:2px">{{ p.m_name }}</div>
              <div class="row" style="justify-content:space-between;margin-top:8px">
                <div class="price">{{ '%.7f'|format(p.pi_price) }} Pi</div>
                <span class="pill">{% if sold_out %}View Store{% else %}Buy Now{% endif %}</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    <!-- Stores grid (unchanged flow) -->
    <div class="h1">Stores</div>
    {% if merchants and merchants|length > 0 %}
      <div class="grid g-stores">
        {% for s in merchants %}
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div class="row" style="min-width:0">
                {% if s.logo_url %}
                  {% set u = (s.logo_url or '') | trim %}
                  <img class="logo"
                       src="{% if u.startswith('/media/') or u.startswith('/static/') or u.startswith('/') 
                                or u.startswith('https://izzapay.onrender.com/media/') %}{{ u }}
                            {% elif u.startswith('http://') or u.startswith('https://') %}/uimg?src={{ u|urlencode }}
                            {% else %}{{ u }}{% endif %}"
                       alt="{{ s.business_name }} logo">
                {% else %}
                  <div class="logo" style="display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--muted)">
                    {{ (s.business_name or 'S')[:1] }}
                  </div>
                {% endif %}
                <div class="title clamp">{{ s.business_name }}</div>
              </div>
              <a class="pill" href="/store/{{ s.slug }}">Open</a>
            </div>
            <div class="muted" style="margin-top:6px">/store/{{ s.slug }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No stores found.</p>
    {% endif %}

    <!-- Products grid (unchanged flow) -->
    <div class="h1" style="margin-top:18px">Products</div>
    {% if products and products|length > 0 %}
      <div class="grid g-products">
        {% for p in products %}
          {% set sold_out = (p.stock_qty <= 0 and not p.allow_backorder) %}
          <div class="card {% if sold_out %}is-soldout{% endif %}">
            <div class="thumb-wrap {% if p.svg_code %}is-svg{% endif %}">
              {% if p.svg_code %}
                <div class="svg-thumb" data-no-i18n="1">
                  {{ p.svg_code | safe }}
                </div>
              {% elif p.image_url %}
                {% set u = (p.image_url or '') | trim %}
                <img class="thumb"
                     src="{% if u.startswith('/media/') or u.startswith('/static/') or u.startswith('/') 
                              or u.startswith('https://izzapay.onrender.com/media/') %}{{ u }}
                          {% elif u.startswith('http://') or u.startswith('https://') %}/uimg?src={{ u|urlencode }}
                          {% else %}{{ u }}{% endif %}"
                     alt="{{ p.title }}">
              {% endif %}
              {% if sold_out %}<div class="soldout-banner">Sold Out</div>{% endif %}
            </div>

            <div style="margin-top:8px" class="title clamp">{{ p.title }}</div>
            <div class="muted clamp" style="margin-top:2px">{{ p.m_name }}</div>

            <div class="row" style="justify-content:space-between;margin-top:8px">
              <div class="price">{{ '%.7f'|format(p.pi_price) }} Pi</div>
              <div class="row">
                <a class="pill" href="/store/{{ p.m_slug }}">Store</a>
                {% if sold_out %}
                  <a class="btn gold" aria-disabled="true" tabindex="-1">Buy</a>
                {% else %}
                  <a class="btn gold" href="/checkout/{{ p.link_id }}">Buy</a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if has_more_products %}
        <div class="load-more">
          <a class="btn purple" href="/explore?page={{ (page or 1) + 1 }}{% if q %}&q={{ q | urlencode }}{% endif %}">
            Load more products
          </a>
        </div>
      {% endif %}
    {% else %}
      <p class="muted">No products found.</p>
    {% endif %}
  </div>

  <script>
  /* Keep: SVG sizing for crafted items */
  (function(){
    document.querySelectorAll('.thumb-wrap.is-svg .svg-thumb svg').forEach(svg=>{
      try{
        const w=svg.getAttribute('width'), h=svg.getAttribute('height');
        if(!svg.hasAttribute('viewBox')){
          const vw=parseFloat(w)||512, vh=parseFloat(h)||512;
          svg.setAttribute('viewBox',`0 0 ${vw} ${vh}`);
        }
        svg.removeAttribute('width'); svg.removeAttribute('height');
        svg.setAttribute('preserveAspectRatio','xMidYMid meet');
      }catch{}
    });
  })();

  /* Lightweight carousels: auto-advance 3s, pause on hover/drag */
  (function(){
    function wireCarousel(id){
      const root=document.getElementById(id); if(!root) return;
      const track=root.querySelector('.track'); if(!track) return;
      const prev=root.querySelector('.navPrev'); const next=root.querySelector('.navNext');

      let index=0;
      const slides=[...track.children];
      if(!slides.length) return;

      function itemWidth(){ return slides[0].getBoundingClientRect().width + 10; } // width+gap
      function to(i){
        index=(i+slides.length)%slides.length;
        track.scrollTo({ left: index*itemWidth(), behavior:'smooth' });
      }
      function step(dir){ to(index + dir); }

      let timer=setInterval(()=>step(1),3000);
      function pause(){ if(timer){ clearInterval(timer); timer=null; } }
      function resume(){ if(!timer) timer=setInterval(()=>step(1),3000); }

      track.addEventListener('pointerdown', pause, {passive:true});
      track.addEventListener('pointerup', resume, {passive:true});
      track.addEventListener('mouseenter', pause);
      track.addEventListener('mouseleave', resume);

      prev && prev.addEventListener('click', ()=>step(-1));
      next && next.addEventListener('click', ()=>step(1));

      window.addEventListener('load', ()=>to(0));
      window.addEventListener('resize', ()=>to(index));
    }

    wireCarousel('carousel-stores');
    wireCarousel('carousel-products');
  })();
  </script>
</body>
</html>
